<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>å®éªŒ7 åœ°å€æ˜ å°„ä¸å…±äº« | Binb&#39;s Blog</title>
<meta name="keywords" content="æ“ä½œç³»ç»Ÿ, å®éªŒ">
<meta name="description" content="1.å®éªŒç›®çš„ æ·±å…¥ç†è§£æ“ä½œç³»ç»Ÿçš„æ®µã€é¡µå¼å†…å­˜ç®¡ç†ï¼Œæ·±å…¥ç†è§£æ®µè¡¨ã€é¡µè¡¨ã€é€»è¾‘åœ°å€ã€çº¿æ€§åœ°å€ã€ç‰©ç†åœ°å€ç­‰æ¦‚å¿µï¼› å®è·µæ®µã€é¡µå¼å†…å­˜ç®¡ç†çš„åœ°å€æ˜ å°„è¿‡ç¨‹ï¼›">
<meta name="author" content="chance7bin">
<link rel="canonical" href="https://chance7bin.github.io/posts/basic/os-lab/%E5%AE%9E%E9%AA%8C7-%E5%9C%B0%E5%9D%80%E6%98%A0%E5%B0%84%E4%B8%8E%E5%85%B1%E4%BA%AB/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.be81eec981a615a87a88f121642d7eebde74d033438693944db2fd6b827284ff.css" integrity="" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.acb54fd32bbc1982428b8850317e45d076b95012730a5936667e6bc21777692a.js" integrity=""
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<link rel="icon" type="image/png" sizes="16x16" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<link rel="icon" type="image/png" sizes="32x32" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<link rel="apple-touch-icon" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<link rel="mask-icon" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="å®éªŒ7 åœ°å€æ˜ å°„ä¸å…±äº«" />
<meta property="og:description" content="1.å®éªŒç›®çš„ æ·±å…¥ç†è§£æ“ä½œç³»ç»Ÿçš„æ®µã€é¡µå¼å†…å­˜ç®¡ç†ï¼Œæ·±å…¥ç†è§£æ®µè¡¨ã€é¡µè¡¨ã€é€»è¾‘åœ°å€ã€çº¿æ€§åœ°å€ã€ç‰©ç†åœ°å€ç­‰æ¦‚å¿µï¼› å®è·µæ®µã€é¡µå¼å†…å­˜ç®¡ç†çš„åœ°å€æ˜ å°„è¿‡ç¨‹ï¼›" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://chance7bin.github.io/posts/basic/os-lab/%E5%AE%9E%E9%AA%8C7-%E5%9C%B0%E5%9D%80%E6%98%A0%E5%B0%84%E4%B8%8E%E5%85%B1%E4%BA%AB/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-25T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-05-25T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="å®éªŒ7 åœ°å€æ˜ å°„ä¸å…±äº«"/>
<meta name="twitter:description" content="1.å®éªŒç›®çš„ æ·±å…¥ç†è§£æ“ä½œç³»ç»Ÿçš„æ®µã€é¡µå¼å†…å­˜ç®¡ç†ï¼Œæ·±å…¥ç†è§£æ®µè¡¨ã€é¡µè¡¨ã€é€»è¾‘åœ°å€ã€çº¿æ€§åœ°å€ã€ç‰©ç†åœ°å€ç­‰æ¦‚å¿µï¼› å®è·µæ®µã€é¡µå¼å†…å­˜ç®¡ç†çš„åœ°å€æ˜ å°„è¿‡ç¨‹ï¼›"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "ğŸ“š æ–‡ç« ",
      "item": "https://chance7bin.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ“• è®¡ç®—æœºåŸºç¡€",
      "item": "https://chance7bin.github.io/posts/basic/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "hit-oslab",
      "item": "https://chance7bin.github.io/posts/basic/os-lab/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "å®éªŒ7 åœ°å€æ˜ å°„ä¸å…±äº«",
      "item": "https://chance7bin.github.io/posts/basic/os-lab/%E5%AE%9E%E9%AA%8C7-%E5%9C%B0%E5%9D%80%E6%98%A0%E5%B0%84%E4%B8%8E%E5%85%B1%E4%BA%AB/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "å®éªŒ7 åœ°å€æ˜ å°„ä¸å…±äº«",
  "name": "å®éªŒ7 åœ°å€æ˜ å°„ä¸å…±äº«",
  "description": "1.å®éªŒç›®çš„ æ·±å…¥ç†è§£æ“ä½œç³»ç»Ÿçš„æ®µã€é¡µå¼å†…å­˜ç®¡ç†ï¼Œæ·±å…¥ç†è§£æ®µè¡¨ã€é¡µè¡¨ã€é€»è¾‘åœ°å€ã€çº¿æ€§åœ°å€ã€ç‰©ç†åœ°å€ç­‰æ¦‚å¿µï¼› å®è·µæ®µã€é¡µå¼å†…å­˜ç®¡ç†çš„åœ°å€æ˜ å°„è¿‡ç¨‹ï¼›",
  "keywords": [
    "æ“ä½œç³»ç»Ÿ", "å®éªŒ"
  ],
  "articleBody": "1.å®éªŒç›®çš„ æ·±å…¥ç†è§£æ“ä½œç³»ç»Ÿçš„æ®µã€é¡µå¼å†…å­˜ç®¡ç†ï¼Œæ·±å…¥ç†è§£æ®µè¡¨ã€é¡µè¡¨ã€é€»è¾‘åœ°å€ã€çº¿æ€§åœ°å€ã€ç‰©ç†åœ°å€ç­‰æ¦‚å¿µï¼› å®è·µæ®µã€é¡µå¼å†…å­˜ç®¡ç†çš„åœ°å€æ˜ å°„è¿‡ç¨‹ï¼› ç¼–ç¨‹å®ç°æ®µã€é¡µå¼å†…å­˜ç®¡ç†ä¸Šçš„å†…å­˜å…±äº«ï¼Œä»è€Œæ·±å…¥ç†è§£æ“ä½œç³»ç»Ÿçš„å†…å­˜ç®¡ç†ã€‚ 2.å®éªŒå†…å®¹ æœ¬æ¬¡å®éªŒçš„åŸºæœ¬å†…å®¹æ˜¯ï¼š\nç”¨ Bochs è°ƒè¯•å·¥å…·è·Ÿè¸ª Linux 0.11 çš„åœ°å€ç¿»è¯‘ï¼ˆåœ°å€æ˜ å°„ï¼‰è¿‡ç¨‹ï¼Œäº†è§£ IA-32 å’Œ Linux 0.11 çš„å†…å­˜ç®¡ç†æœºåˆ¶ï¼› åœ¨ Ubuntu ä¸Šç¼–å†™å¤šè¿›ç¨‹çš„ç”Ÿäº§è€…â€”æ¶ˆè´¹è€…ç¨‹åºï¼Œç”¨å…±äº«å†…å­˜åšç¼“å†²åŒºï¼› åœ¨ä¿¡å·é‡å®éªŒçš„åŸºç¡€ä¸Šï¼Œä¸º Linux 0.11 å¢åŠ å…±äº«å†…å­˜åŠŸèƒ½ï¼Œå¹¶å°†ç”Ÿäº§è€…â€”æ¶ˆè´¹è€…ç¨‹åºç§»æ¤åˆ° Linux 0.11ã€‚ 2.1 è·Ÿè¸ªåœ°å€ç¿»è¯‘è¿‡ç¨‹ é¦–å…ˆä»¥æ±‡ç¼–çº§è°ƒè¯•çš„æ–¹å¼å¯åŠ¨ Bochsï¼Œå¼•å¯¼ Linux 0.11ï¼Œåœ¨ 0.11 ä¸‹ç¼–è¯‘å’Œè¿è¡Œ test.cã€‚å®ƒæ˜¯ä¸€ä¸ªæ— é™å¾ªç¯çš„ç¨‹åºï¼Œæ°¸è¿œä¸ä¼šä¸»åŠ¨é€€å‡ºã€‚ç„¶ååœ¨è°ƒè¯•å™¨ä¸­é€šè¿‡æŸ¥çœ‹å„é¡¹ç³»ç»Ÿå‚æ•°ï¼Œä»é€»è¾‘åœ°å€ã€LDT è¡¨ã€GDT è¡¨ã€çº¿æ€§åœ°å€åˆ°é¡µè¡¨ï¼Œè®¡ç®—å‡ºå˜é‡ i çš„ç‰©ç†åœ°å€ã€‚æœ€åé€šè¿‡ç›´æ¥ä¿®æ”¹ç‰©ç†å†…å­˜çš„æ–¹å¼è®© test.c é€€å‡ºè¿è¡Œã€‚\ntest.c çš„ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 #include int i = 0x12345678; int main(void) { printf(\"The logical/virtual address of i is 0x%08x\", \u0026i); fflush(stdout); while (i) ; return 0; } 2.2 åŸºäºå…±äº«å†…å­˜çš„ç”Ÿäº§è€…â€”æ¶ˆè´¹è€…ç¨‹åº æœ¬é¡¹å®éªŒåœ¨ Ubuntu ä¸‹å®Œæˆï¼Œä¸ä¿¡å·é‡å®éªŒä¸­çš„ pc.c çš„åŠŸèƒ½è¦æ±‚åŸºæœ¬ä¸€è‡´ï¼Œä»…æœ‰ä¸¤ç‚¹ä¸åŒï¼š\nä¸ç”¨æ–‡ä»¶åšç¼“å†²åŒºï¼Œè€Œæ˜¯ä½¿ç”¨å…±äº«å†…å­˜ï¼› ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…åˆ†åˆ«æ˜¯ä¸åŒçš„ç¨‹åºã€‚ç”Ÿäº§è€…æ˜¯ producer.cï¼Œæ¶ˆè´¹è€…æ˜¯ consumer.cã€‚ä¸¤ä¸ªç¨‹åºéƒ½æ˜¯å•è¿›ç¨‹çš„ï¼Œé€šè¿‡ä¿¡å·é‡å’Œç¼“å†²åŒºè¿›è¡Œé€šä¿¡ã€‚ Linux ä¸‹ï¼Œå¯ä»¥é€šè¿‡ shmget() å’Œ shmat() ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ä½¿ç”¨å…±äº«å†…å­˜ã€‚\n2.3 å…±äº«å†…å­˜çš„å®ç° è¿›ç¨‹ä¹‹é—´å¯ä»¥é€šè¿‡é¡µå…±äº«è¿›è¡Œé€šä¿¡ï¼Œè¢«å…±äº«çš„é¡µå«åšå…±äº«å†…å­˜ï¼Œç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nå›¾ 1 è¿›ç¨‹é—´å…±äº«å†…å­˜çš„ç»“æ„\næœ¬éƒ¨åˆ†å®éªŒå†…å®¹æ˜¯åœ¨ Linux 0.11 ä¸Šå®ç°ä¸Šè¿°é¡µé¢å…±äº«ï¼Œå¹¶å°†ä¸Šä¸€éƒ¨åˆ†å®ç°çš„ producer.c å’Œ consumer.c ç§»æ¤è¿‡æ¥ï¼ŒéªŒè¯é¡µé¢å…±äº«çš„æœ‰æ•ˆæ€§ã€‚\nå…·ä½“è¦æ±‚åœ¨ mm/shm.c ä¸­å®ç° shmget() å’Œ shmat() ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ã€‚å®ƒä»¬èƒ½æ”¯æŒ producer.c å’Œ consumer.c çš„è¿è¡Œå³å¯ï¼Œä¸éœ€è¦å®Œæ•´åœ°å®ç° POSIX æ‰€è§„å®šçš„åŠŸèƒ½ã€‚\nshmget() 1 int shmget(key_t key, size_t size, int shmflg); shmget() ä¼šæ–°å»º/æ‰“å¼€ä¸€é¡µå†…å­˜ï¼Œå¹¶è¿”å›è¯¥é¡µå…±äº«å†…å­˜çš„ shmidï¼ˆè¯¥å—å…±äº«å†…å­˜åœ¨æ“ä½œç³»ç»Ÿå†…éƒ¨çš„ idï¼‰ã€‚\næ‰€æœ‰ä½¿ç”¨åŒä¸€å—å…±äº«å†…å­˜çš„è¿›ç¨‹éƒ½è¦ä½¿ç”¨ç›¸åŒçš„ key å‚æ•°ã€‚\nå¦‚æœ key æ‰€å¯¹åº”çš„å…±äº«å†…å­˜å·²ç»å»ºç«‹ï¼Œåˆ™ç›´æ¥è¿”å› shmidã€‚å¦‚æœ size è¶…è¿‡ä¸€é¡µå†…å­˜çš„å¤§å°ï¼Œè¿”å› -1ï¼Œå¹¶ç½® errno ä¸º EINVALã€‚å¦‚æœç³»ç»Ÿæ— ç©ºé—²å†…å­˜ï¼Œè¿”å› -1ï¼Œå¹¶ç½® errno ä¸º ENOMEMã€‚\nshmflg å‚æ•°å¯å¿½ç•¥ã€‚\nshmat() 1 void *shmat(int shmid, const void *shmaddr, int shmflg); shmat() ä¼šå°† shmid æŒ‡å®šçš„å…±äº«é¡µé¢æ˜ å°„åˆ°å½“å‰è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ï¼Œå¹¶å°†å…¶é¦–åœ°å€è¿”å›ã€‚\nå¦‚æœ shmid éæ³•ï¼Œè¿”å› -1ï¼Œå¹¶ç½® errno ä¸º EINVALã€‚\nshmaddr å’Œ shmflg å‚æ•°å¯å¿½ç•¥ã€‚\n3.å®éªŒæŠ¥å‘Š å®Œæˆå®éªŒåï¼Œåœ¨å®éªŒæŠ¥å‘Šä¸­å›ç­”å¦‚ä¸‹é—®é¢˜ï¼š\nå¯¹äºåœ°å€æ˜ å°„å®éªŒéƒ¨åˆ†ï¼Œåˆ—å‡ºä½ è®¤ä¸ºæœ€é‡è¦çš„é‚£å‡ æ­¥ï¼ˆä¸è¶…è¿‡ 4 æ­¥ï¼‰ï¼Œå¹¶ç»™å‡ºä½ è·å¾—çš„å®éªŒæ•°æ®ã€‚ test.c é€€å‡ºåï¼Œå¦‚æœé©¬ä¸Šå†è¿è¡Œä¸€æ¬¡ï¼Œå¹¶å†è¿›è¡Œåœ°å€è·Ÿè¸ªï¼Œä½ å‘ç°æœ‰å“ªäº›å¼‚åŒï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ 4.å®éªŒæç¤º æœ¬æ¬¡éœ€è¦å®Œæˆçš„å†…å®¹ï¼š\nï¼ˆ1ï¼‰ç”¨ Bochs è°ƒè¯•å·¥å…·è·Ÿè¸ª Linux 0.11 çš„åœ°å€ç¿»è¯‘ï¼ˆåœ°å€æ˜ å°„ï¼‰è¿‡ç¨‹ï¼Œäº†è§£ IA-32 å’Œ Linux 0.11 çš„å†…å­˜ç®¡ç†æœºåˆ¶ï¼› ï¼ˆ2ï¼‰åœ¨ Ubuntu ä¸Šç¼–å†™å¤šè¿›ç¨‹çš„ç”Ÿäº§è€…â€”æ¶ˆè´¹è€…ç¨‹åºï¼Œç”¨å…±äº«å†…å­˜åšç¼“å†²åŒºï¼› ï¼ˆ3ï¼‰åœ¨ä¿¡å·é‡å®éªŒçš„åŸºç¡€ä¸Šï¼Œä¸º Linux 0.11 å¢åŠ å…±äº«å†…å­˜åŠŸèƒ½ï¼Œå¹¶å°†ç”Ÿäº§è€…â€”æ¶ˆè´¹è€…ç¨‹åºç§»æ¤åˆ° Linux 0.11ã€‚ 4.1 IA-32 çš„åœ°å€ç¿»è¯‘è¿‡ç¨‹ Linux 0.11 å®Œå…¨éµå¾ª IA-32ï¼ˆIntel Architecture 32-bitï¼‰æ¶æ„è¿›è¡Œåœ°å€ç¿»è¯‘ï¼ŒWindowsã€åç»­ç‰ˆæœ¬çš„ Linux ä»¥åŠä¸€åˆ‡åœ¨ IA-32 ä¿æŠ¤æ¨¡å¼ä¸‹è¿è¡Œçš„æ“ä½œç³»ç»Ÿéƒ½éµå¾ªæ­¤æ¶æ„ã€‚å› ä¸ºåªæœ‰è¿™æ ·æ‰èƒ½å……åˆ†å‘æŒ¥ CPU çš„ MMUï¼ˆå†…å­˜ç®¡ç†å•å…ƒï¼‰ çš„åŠŸèƒ½ã€‚\nå…³äºæ­¤åœ°å€ç¿»è¯‘è¿‡ç¨‹çš„ç»†èŠ‚ï¼Œè¯·å‚è€ƒã€Šæ³¨é‡Šã€‹ä¸€ä¹¦ä¸­çš„ 5.3.1-5.3.4 èŠ‚ã€‚\n4.2 ç”¨ Bochs æ±‡ç¼–çº§è°ƒè¯•åŠŸèƒ½è¿›è¡Œäººå·¥åœ°å€ç¿»è¯‘ æ­¤è¿‡ç¨‹æ¯”è¾ƒæœºæ¢°ï¼ŒåŸºæœ¬ä¸æ¶ˆè€—è„‘ç»†èƒï¼Œåšä¸€ä¸‹æœ‰å¾ˆå¤šå¥½å¤„ã€‚\n==Bochså‘½ä»¤==\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 [å†…å­˜æ“ä½œ] x /nuf [addr] æ˜¾ç¤ºçº¿æ€§åœ°å€çš„å†…å®¹ xp /nuf [addr] æ˜¾ç¤ºç‰©ç†åœ°å€çš„å†…å®¹ n æ˜¾ç¤ºçš„å•å…ƒæ•° u æ¯ä¸ªæ˜¾ç¤ºå•å…ƒçš„å¤§å°ï¼Œuå¯ä»¥æ˜¯ä¸‹åˆ—ä¹‹ä¸€ï¼š b BYTE h WORD w DWORD g DWORD64 æ³¨æ„: è¿™ç§å‘½åæ³•æ˜¯æŒ‰ç…§GDBä¹ æƒ¯çš„ï¼Œè€Œå¹¶ä¸æ˜¯æŒ‰ç…§interçš„è§„èŒƒã€‚ f æ˜¾ç¤ºæ ¼å¼ï¼Œfå¯ä»¥æ˜¯ä¸‹åˆ—ä¹‹ä¸€ï¼š x æŒ‰ç…§åå…­è¿›åˆ¶æ˜¾ç¤º d åè¿›åˆ¶æ˜¾ç¤º u æŒ‰ç…§æ— ç¬¦å·åè¿›åˆ¶æ˜¾ç¤º o æŒ‰ç…§å…«è¿›åˆ¶æ˜¾ç¤º t æŒ‰ç…§äºŒè¿›åˆ¶æ˜¾ç¤º c æŒ‰ç…§å­—ç¬¦æ˜¾ç¤º nã€fã€uæ˜¯å¯é€‰å‚æ•°ï¼Œå¦‚æœä¸æŒ‡å®šï¼Œåˆ™ué»˜è®¤æ˜¯wï¼Œfé»˜è®¤æ˜¯xã€‚å¦‚æœå‰é¢ä½¿ç”¨è¿‡xæˆ– è€…xpå‘½ä»¤ï¼Œä¼šæŒ‰ç…§ä¸Šä¸€æ¬¡çš„xæˆ–è€…xpå‘½ä»¤æ‰€ä½¿ç”¨çš„å€¼ã€‚né»˜è®¤ä¸º1ã€‚addr ä¹Ÿæ˜¯ä¸€ä¸ª å¯é€‰å‚æ•°ï¼Œå¦‚æœä¸æŒ‡å®šï¼Œaddræ˜¯0ï¼Œå¦‚è¿‡å‰é¢ä½¿ç”¨è¿‡xæˆ–è€…xpå‘½ä»¤ï¼ŒæŒ‡å®šäº†n=iï¼Œ åˆ™å†æ¬¡æ‰§è¡Œæ—¶né»˜è®¤ä¸ºi+1ã€‚ setpmem [addr] [size] [val] è®¾ç½®ç‰©ç†å†…å­˜æŸåœ°å€çš„å†…å®¹ã€‚ ï¼ˆ1ï¼‰å‡†å¤‡ ç¼–è¯‘å¥½ Linux 0.11 åï¼Œé¦–å…ˆé€šè¿‡è¿è¡Œ ./dbg-asm å¯åŠ¨è°ƒè¯•å™¨ï¼Œæ­¤æ—¶ Bochs çš„çª—å£å¤„äºé»‘å±çŠ¶æ€\nè€Œå‘½ä»¤è¡Œçª—å£æ˜¾ç¤ºï¼š\n1 2 3 4 5 6 7 8 9 10 ======================================================================== Bochs x86 Emulator 2.3.7 Build from CVS snapshot, on June 3, 2008 ======================================================================== 00000000000i[ ] reading configuration from ./bochs/bochsrc.bxrc 00000000000i[ ] installing x module as the Bochs GUI 00000000000i[ ] using log file ./bochsout.txt Next at t=0 (0) [0xfffffff0] f000:fff0 (unk. ctxt): jmp far f000:e05b ; ea5be000f0 _ Next at t=0 è¡¨ç¤ºä¸‹é¢çš„æŒ‡ä»¤æ˜¯ Bochs å¯åŠ¨åè¦æ‰§è¡Œçš„ç¬¬ä¸€æ¡è½¯ä»¶æŒ‡ä»¤ã€‚\nå•æ­¥è·Ÿè¸ªè¿›å»å°±èƒ½çœ‹åˆ° BIOS çš„ä»£ç ã€‚ä¸è¿‡è¿™ä¸æ˜¯æœ¬å®éªŒéœ€è¦çš„ã€‚ç›´æ¥è¾“å…¥å‘½ä»¤ cï¼Œcontinue ç¨‹åºçš„è¿è¡Œï¼ŒBochs ä¸€å¦‚æ—¢å¾€åœ°å¯åŠ¨äº† Linux 0.11ã€‚\nåœ¨ Linux 0.11 ä¸‹è¾“å…¥ï¼ˆæˆ–æ‹·å…¥ï¼‰test.cï¼ˆä»£ç åœ¨æœ¬å®éªŒçš„ç¬¬ 3 å°èŠ‚ä¸­ï¼‰ï¼Œç¼–è¯‘ä¸º testï¼Œè¿è¡Œä¹‹ï¼Œæ‰“å°å¦‚ä¸‹ä¿¡æ¯ï¼š\n1 The logical/virtual address of i is 0x00003004 åªè¦ test ä¸å˜ï¼Œ0x00003004 è¿™ä¸ªå€¼åœ¨ä»»ä½•äººçš„æœºå™¨ä¸Šéƒ½æ˜¯ä¸€æ ·çš„ã€‚å³ä½¿åœ¨åŒä¸€ä¸ªæœºå™¨ä¸Šå¤šæ¬¡è¿è¡Œ testï¼Œä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚\ntest æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œåªä¼šä¸åœå ç”¨ CPUï¼Œä¸ä¼šé€€å‡ºã€‚\nï¼ˆ2ï¼‰æš‚åœ å½“ test è¿è¡Œçš„æ—¶å€™ï¼Œåœ¨å‘½ä»¤è¡Œçª—å£æŒ‰ Ctrl+cï¼ŒBochs ä¼šæš‚åœè¿è¡Œï¼Œè¿›å…¥è°ƒè¯•çŠ¶æ€ã€‚ç»å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½ä¼šåœåœ¨ test å†…ï¼Œæ˜¾ç¤ºç±»ä¼¼å¦‚ä¸‹ä¿¡æ¯ï¼š\n1 (0) [0x00fc8031] 000f:00000031 (unk. ctxt): cmp dword ptr ds:0x3004, 0x00000000 ; 833d0430000000 å…¶ä¸­çš„ 000f å¦‚æœæ˜¯ 0008ï¼Œåˆ™è¯´æ˜ä¸­æ–­åœ¨äº†å†…æ ¸é‡Œã€‚é‚£ä¹ˆå°±è¦ cï¼Œç„¶åå† ctrl+cï¼Œç›´åˆ°å˜ä¸º 000f ä¸ºæ­¢ã€‚\nå¦‚æœæ˜¾ç¤ºçš„ä¸‹ä¸€æ¡æŒ‡ä»¤ä¸æ˜¯ cmp ...ï¼ˆè¿™é‡ŒæŒ‡è¯­å¥ä»¥ cmp å¼€å¤´ï¼‰ï¼Œå°±ç”¨ n å‘½ä»¤å•æ­¥è¿è¡Œå‡ æ­¥ï¼Œç›´åˆ°åœåœ¨ cmp ...ã€‚\nä½¿ç”¨å‘½ä»¤ u /8ï¼Œæ˜¾ç¤ºä»å½“å‰ä½ç½®å¼€å§‹ 8 æ¡æŒ‡ä»¤çš„åæ±‡ç¼–ä»£ç ï¼Œç»“æ„å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 u /8 10000063: ( ): cmp dword ptr ds:0x3004, 0x00000000 ; 833d0430000000 1000006a: ( ): jz .+0x00000004 ; 7404 1000006c: ( ): jmp .+0xfffffff5 ; ebf5 1000006e: ( ): add byte ptr ds:[eax], al ; 0000 10000070: ( ): xor eax, eax ; 31c0 10000072: ( ): jmp .+0x00000000 ; eb00 10000074: ( ): leave ; c9 10000075: ( ): ret ; c3 è¿™å°±æ˜¯ test.c ä¸­ä» while å¼€å§‹ä¸€ç›´åˆ° return çš„æ±‡ç¼–ä»£ç ã€‚å˜é‡ i ä¿å­˜åœ¨ ds:0x3004 è¿™ä¸ªåœ°å€ï¼Œå¹¶ä¸åœåœ°å’Œ 0 è¿›è¡Œæ¯”è¾ƒï¼Œç›´åˆ°å®ƒä¸º 0ï¼Œæ‰ä¼šè·³å‡ºå¾ªç¯ã€‚\nç°åœ¨ï¼Œå¼€å§‹å¯»æ‰¾ ds:0x3004 å¯¹åº”çš„ç‰©ç†åœ°å€ã€‚\n4.3 æ®µè¡¨ ds:0x3004 æ˜¯è™šæ‹Ÿåœ°å€ï¼Œds è¡¨æ˜è¿™ä¸ªåœ°å€å±äº ds æ®µã€‚é¦–å…ˆè¦æ‰¾åˆ°æ®µè¡¨ï¼Œç„¶åé€šè¿‡ ds çš„å€¼åœ¨æ®µè¡¨ä¸­æ‰¾åˆ° ds æ®µçš„å…·ä½“ä¿¡æ¯ï¼Œæ‰èƒ½ç»§ç»­è¿›è¡Œåœ°å€ç¿»è¯‘ã€‚\næ¯ä¸ªåœ¨ IA-32 ä¸Šè¿è¡Œçš„åº”ç”¨ç¨‹åºéƒ½æœ‰ä¸€ä¸ªæ®µè¡¨ï¼Œå« LDTï¼Œæ®µçš„ä¿¡æ¯å«æ®µæè¿°ç¬¦ã€‚\nLDT åœ¨å“ªé‡Œå‘¢ï¼Ÿldtr å¯„å­˜å™¨æ˜¯çº¿ç´¢çš„èµ·ç‚¹ï¼Œé€šè¿‡å®ƒå¯ä»¥åœ¨ GDTï¼ˆå…¨å±€æè¿°ç¬¦è¡¨ï¼‰ä¸­æ‰¾åˆ° LDT çš„ç‰©ç†åœ°å€ã€‚\nç”¨ sreg å‘½ä»¤ï¼ˆæ˜¯åœ¨è°ƒè¯•çª—å£è¾“å…¥ï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 sreg cs:s=0x000f, dl=0x00000002, dh=0x10c0fa00, valid=1 ds:s=0x0017, dl=0x00003fff, dh=0x10c0f300, valid=3 ss:s=0x0017, dl=0x00003fff, dh=0x10c0f300, valid=1 es:s=0x0017, dl=0x00003fff, dh=0x10c0f300, valid=1 fs:s=0x0017, dl=0x00003fff, dh=0x10c0f300, valid=1 gs:s=0x0017, dl=0x00003fff, dh=0x10c0f300, valid=1 ldtr:s=0x0068, dl=0xa2d00068, dh=0x000082fa, valid=1 tr:s=0x0060, dl=0xa2e80068, dh=0x00008bfa, valid=1 gdtr:base=0x00005cb8, limit=0x7ff idtr:base=0x000054b8, limit=0x7ff å¯ä»¥çœ‹åˆ° ldtr çš„å€¼æ˜¯ 0x0068=0000000001101000ï¼ˆäºŒè¿›åˆ¶ï¼‰ï¼Œè¡¨ç¤º LDT è¡¨å­˜æ”¾åœ¨ GDT è¡¨çš„ 1101ï¼ˆäºŒè¿›åˆ¶ï¼‰=13ï¼ˆåè¿›åˆ¶ï¼‰å·ä½ç½®ï¼ˆæ¯ä½æ•°æ®çš„æ„ä¹‰å‚è€ƒåæ–‡å™è¿°çš„æ®µé€‰æ‹©å­ï¼‰ã€‚\nè€Œ GDT çš„ä½ç½®å·²ç»ç”± gdtr æ˜ç¡®ç»™å‡ºï¼Œåœ¨ç‰©ç†åœ°å€çš„ 0x00005cb8ã€‚\nç”¨ xp /32w 0x00005cb8 æŸ¥çœ‹ä»è¯¥åœ°å€å¼€å§‹ï¼Œ32 ä¸ªå­—çš„å†…å®¹ï¼ŒåŠ GDT è¡¨çš„å‰ 16 é¡¹ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 xp /32w 0x00005cb8 [bochs]: 0x00005cb8 : 0x00000000 0x00000000 0x00000fff 0x00c09a00 0x00005cc8 : 0x00000fff 0x00c09300 0x00000000 0x00000000 0x00005cd8 : 0xa4280068 0x00008901 0xa4100068 0x00008201 0x00005ce8 : 0xf2e80068 0x000089ff 0xf2d00068 0x000082ff 0x00005cf8 : 0xd2e80068 0x000089ff 0xd2d00068 0x000082ff 0x00005d08 : 0x12e80068 0x000089fc 0x12d00068 0x000082fc 0x00005d18 : 0xa2e80068 0x00008bfa 0xa2d00068 0x000082fa 0x00005d28 : 0xc2e80068 0x000089f8 0xc2d00068 0x000082f8 GDT è¡¨ä¸­çš„æ¯ä¸€é¡¹å  64 ä½ï¼ˆ8 ä¸ªå­—èŠ‚ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æŸ¥æ‰¾çš„é¡¹çš„åœ°å€æ˜¯ 0x00005cb8+13*8ã€‚\nè¾“å…¥ xp /2w 0x00005cb8+13*8ï¼Œå¾—åˆ°ï¼š\n1 2 3 xp /2w 0x00005cb8+13*8 [bochs]: 0x00005d20 : 0xa2d00068 0x000082fa ä¸Šä¸¤æ­¥çœ‹åˆ°çš„æ•°å€¼å¯èƒ½å’Œè¿™é‡Œç»™å‡ºçš„ç¤ºä¾‹ä¸ä¸€è‡´ï¼Œè¿™æ˜¯å¾ˆæ­£å¸¸çš„ã€‚å¦‚æœæƒ³ç¡®è®¤æ˜¯å¦å‡†ç¡®ï¼Œå°±çœ‹ sreg è¾“å‡ºä¸­ï¼Œldtr æ‰€åœ¨è¡Œé‡Œï¼Œdl å’Œ dh çš„å€¼ï¼Œå®ƒä»¬æ˜¯ Bochs çš„è°ƒè¯•å™¨è‡ªåŠ¨è®¡ç®—å‡ºçš„ï¼Œä½ å¯»æ‰¾åˆ°çš„å¿…é¡»å’Œå®ƒä»¬ä¸€è‡´ã€‚\nâ€œ0xa2d00068 0x000082faâ€ å°†å…¶ä¸­çš„åŠ ç²—æ•°å­—ç»„åˆä¸ºâ€œ0x00faa2d0â€ï¼Œè¿™å°±æ˜¯ LDT è¡¨çš„ç‰©ç†åœ°å€ï¼ˆä¸ºä»€ä¹ˆè¿™ä¹ˆç»„åˆï¼Œå‚è€ƒåæ–‡ä»‹ç»çš„æ®µæè¿°ç¬¦ï¼‰ã€‚\nxp /8w 0x00faa2d0ï¼Œå¾—åˆ°ï¼š\n1 2 3 4 xp /8w 0x00faa2d0 [bochs]: 0x00faa2d0 : 0x00000000 0x00000000 0x00000002 0x10c0fa00 0x00faa2e0 : 0x00003fff 0x10c0f300 0x00000000 0x00fab000 è¿™å°±æ˜¯ LDT è¡¨çš„å‰ 4 é¡¹å†…å®¹äº†ã€‚\n4.4 æ®µæè¿°ç¬¦ åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œæ®µå¯„å­˜å™¨æœ‰å¦ä¸€ä¸ªåå­—ï¼Œå«æ®µé€‰æ‹©å­ï¼Œå› ä¸ºå®ƒä¿å­˜çš„ä¿¡æ¯ä¸»è¦æ˜¯è¯¥æ®µåœ¨æ®µè¡¨é‡Œç´¢å¼•å€¼ï¼Œç”¨è¿™ä¸ªç´¢å¼•å€¼å¯ä»¥ä»æ®µè¡¨ä¸­â€œé€‰æ‹©â€å‡ºç›¸åº”çš„æ®µæè¿°ç¬¦ã€‚\nå…ˆçœ‹çœ‹ ds é€‰æ‹©å­çš„å†…å®¹ï¼Œè¿˜æ˜¯ç”¨ sreg å‘½ä»¤ï¼š\n1 2 3 4 5 6 7 8 9 10 11 sreg cs:s=0x000f, dl=0x00000002, dh=0x10c0fa00, valid=1 ds:s=0x0017, dl=0x00003fff, dh=0x10c0f300, valid=3 ss:s=0x0017, dl=0x00003fff, dh=0x10c0f300, valid=1 es:s=0x0017, dl=0x00003fff, dh=0x10c0f300, valid=1 fs:s=0x0017, dl=0x00003fff, dh=0x10c0f300, valid=1 gs:s=0x0017, dl=0x00003fff, dh=0x10c0f300, valid=1 ldtr:s=0x0068, dl=0xa2d00068, dh=0x000082fa, valid=1 tr:s=0x0060, dl=0xa2e80068, dh=0x00008bfa, valid=1 gdtr:base=0x00005cb8, limit=0x7ff idtr:base=0x000054b8, limit=0x7ff å¯ä»¥çœ‹åˆ°ï¼Œds çš„å€¼æ˜¯ 0x0017ã€‚æ®µé€‰æ‹©å­æ˜¯ä¸€ä¸ª 16 ä½å¯„å­˜å™¨ï¼Œå®ƒå„ä½çš„å«ä¹‰å¦‚ä¸‹å›¾ï¼š\nå›¾ 2 æ®µé€‰æ‹©å­çš„ç»“æ„\nå…¶ä¸­ RPL æ˜¯è¯·æ±‚ç‰¹æƒçº§ï¼Œå½“è®¿é—®ä¸€ä¸ªæ®µæ—¶ï¼Œå¤„ç†å™¨è¦æ£€æŸ¥ RPL å’Œ CPLï¼ˆæ”¾åœ¨ cs çš„ä½ 0 å’Œä½ 1 ä¸­ï¼Œç”¨æ¥è¡¨ç¤ºå½“å‰ä»£ç çš„ç‰¹æƒçº§ï¼‰ï¼Œå³ä½¿ç¨‹åºæœ‰è¶³å¤Ÿçš„ç‰¹æƒçº§ï¼ˆCPLï¼‰æ¥è®¿é—®ä¸€ä¸ªæ®µï¼Œä½†å¦‚æœ RPLï¼ˆå¦‚æ”¾åœ¨ ds ä¸­ï¼Œè¡¨ç¤ºè¯·æ±‚æ•°æ®æ®µï¼‰çš„ç‰¹æƒçº§ä¸è¶³ï¼Œåˆ™ä»ç„¶ä¸èƒ½è®¿é—®ï¼Œå³å¦‚æœ RPL çš„æ•°å€¼å¤§äº CPLï¼ˆæ•°å€¼è¶Šå¤§ï¼Œæƒé™è¶Šå°ï¼‰ï¼Œåˆ™ç”¨ RPL çš„å€¼è¦†ç›– CPL çš„å€¼ã€‚\nè€Œæ®µé€‰æ‹©å­ä¸­çš„ TI æ˜¯è¡¨æŒ‡ç¤ºæ ‡è®°ï¼Œå¦‚æœ TI=0ï¼Œåˆ™è¡¨ç¤ºæ®µæè¿°ç¬¦ï¼ˆæ®µçš„è¯¦ç»†ä¿¡æ¯ï¼‰åœ¨ GDTï¼ˆå…¨å±€æè¿°ç¬¦è¡¨ï¼‰ä¸­ï¼Œå³å» GDT ä¸­å»æŸ¥ï¼›è€Œ TI=1ï¼Œåˆ™å» LDTï¼ˆå±€éƒ¨æè¿°ç¬¦è¡¨ï¼‰ä¸­å»æŸ¥ã€‚\nçœ‹çœ‹ä¸Šé¢çš„ dsï¼Œ0x0017=0000000000010111ï¼ˆäºŒè¿›åˆ¶ï¼‰ï¼Œæ‰€ä»¥ RPL=11ï¼Œå¯è§æ˜¯åœ¨æœ€ä½çš„ç‰¹æƒçº§ï¼ˆå› ä¸ºåœ¨åº”ç”¨ç¨‹åºä¸­æ‰§è¡Œï¼‰ï¼ŒTI=1ï¼Œè¡¨ç¤ºæŸ¥æ‰¾ LDT è¡¨ï¼Œç´¢å¼•å€¼ä¸º 10ï¼ˆäºŒè¿›åˆ¶ï¼‰= 2ï¼ˆåè¿›åˆ¶ï¼‰ï¼Œè¡¨ç¤ºæ‰¾ LDT è¡¨ä¸­çš„ç¬¬ 3 ä¸ªæ®µæè¿°ç¬¦ï¼ˆä» 0 å¼€å§‹ç¼–å·ï¼‰ã€‚\nLDT å’Œ GDT çš„ç»“æ„ä¸€æ ·ï¼Œæ¯é¡¹å  8 ä¸ªå­—èŠ‚ã€‚æ‰€ä»¥ç¬¬ 3 é¡¹ 0x00003fff 0x10c0f300ï¼ˆä¸Šä¸€æ­¥éª¤çš„æœ€åä¸€ä¸ªè¾“å‡ºç»“æœä¸­ï¼‰ å°±æ˜¯æœå¯»å¥½ä¹…çš„ ds çš„æ®µæè¿°ç¬¦äº†ã€‚\nç”¨ sreg è¾“å‡ºä¸­ ds æ‰€åœ¨è¡Œçš„ dl å’Œ dh å€¼å¯ä»¥éªŒè¯æ‰¾åˆ°çš„æè¿°ç¬¦æ˜¯å¦æ­£ç¡®ã€‚\næ¥ä¸‹æ¥çœ‹çœ‹æ®µæè¿°ç¬¦é‡Œé¢æ”¾ç½®çš„æ˜¯ä»€ä¹ˆå†…å®¹ï¼š\nå›¾ 3 æ®µæè¿°ç¬¦çš„ç»“æ„\nå¯ä»¥çœ‹åˆ°ï¼Œæ®µæè¿°ç¬¦æ˜¯ä¸€ä¸ª 64 ä½äºŒè¿›åˆ¶çš„æ•°ï¼Œå­˜æ”¾äº†æ®µåŸºå€å’Œæ®µé™é•¿ç­‰é‡è¦çš„æ•°æ®ã€‚å…¶ä¸­ä½ Pï¼ˆPresentï¼‰æ˜¯æ®µæ˜¯å¦å­˜åœ¨çš„æ ‡è®°ï¼›ä½ S ç”¨æ¥è¡¨ç¤ºæ˜¯ç³»ç»Ÿæ®µæè¿°ç¬¦ï¼ˆS=0ï¼‰è¿˜æ˜¯ä»£ç æˆ–æ•°æ®æ®µæè¿°ç¬¦ï¼ˆS=1ï¼‰ï¼›å››ä½ TYPE ç”¨æ¥è¡¨ç¤ºæ®µçš„ç±»å‹ï¼Œå¦‚æ•°æ®æ®µã€ä»£ç æ®µã€å¯è¯»ã€å¯å†™ç­‰ï¼›DPL æ˜¯æ®µçš„æƒé™ï¼Œå’Œ CPLã€RPL å¯¹åº”ä½¿ç”¨ï¼›ä½ G æ˜¯ç²’åº¦ï¼ŒG=0 è¡¨ç¤ºæ®µé™é•¿ä»¥ä½ä¸ºå•ä½ï¼ŒG=1 è¡¨ç¤ºæ®µé™é•¿ä»¥ 4KB ä¸ºå•ä½ï¼›å…¶ä»–å†…å®¹å°±ä¸è¯¦ç»†è§£é‡Šäº†ã€‚\n4.5 æ®µåŸºå€å’Œçº¿æ€§åœ°å€ è´¹äº†å¾ˆå¤§çš„åŠ²ï¼Œå®é™…ä¸Šæˆ‘ä»¬éœ€è¦çš„åªæœ‰æ®µåŸºå€ä¸€é¡¹æ•°æ®ï¼Œå³æ®µæè¿°ç¬¦ â€œ0x00003fff 0x10c0f300â€ ä¸­åŠ ç²—éƒ¨åˆ†ç»„åˆæˆçš„ â€œ0x10000000â€ã€‚è¿™å°±æ˜¯ ds æ®µåœ¨çº¿æ€§åœ°å€ç©ºé—´ä¸­çš„èµ·å§‹åœ°å€ã€‚ç”¨åŒæ ·çš„æ–¹æ³•ä¹Ÿå¯ä»¥ç®—ç®—å…¶å®ƒæ®µçš„åŸºå€ï¼Œéƒ½æ˜¯è¿™ä¸ªæ•°ã€‚\næ®µåŸºå€+æ®µå†…åç§»ï¼Œå°±æ˜¯çº¿æ€§åœ°å€äº†ã€‚æ‰€ä»¥ ds:0x3004 çš„çº¿æ€§åœ°å€å°±æ˜¯ï¼š\n1 0x10000000 + 0x3004 = 0x10003004 ç”¨ calc ds:0x3004 å‘½ä»¤å¯ä»¥éªŒè¯è¿™ä¸ªç»“æœã€‚\n4.6 é¡µè¡¨ ä»çº¿æ€§åœ°å€è®¡ç®—ç‰©ç†åœ°å€ï¼Œéœ€è¦æŸ¥æ‰¾é¡µè¡¨ã€‚çº¿æ€§åœ°å€å˜æˆç‰©ç†åœ°å€çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š\nå›¾ 4 é¡µè¡¨å·¥ä½œåŸç†\nçº¿æ€§åœ°å€å˜æˆç‰©ç†åœ°å€\né¦–å…ˆéœ€è¦ç®—å‡ºçº¿æ€§åœ°å€ä¸­çš„é¡µç›®å½•å·ã€é¡µè¡¨å·å’Œé¡µå†…åç§»ï¼Œå®ƒä»¬åˆ†åˆ«å¯¹åº”äº† 32 ä½çº¿æ€§åœ°å€çš„ 10 ä½ + 10 ä½ + 12 ä½ï¼Œæ‰€ä»¥==0x10003004 çš„é¡µç›®å½•å·æ˜¯ 64ï¼Œé¡µå· 3ï¼Œé¡µå†…åç§»æ˜¯ 4==ã€‚\nIA-32 ä¸‹ï¼Œé¡µç›®å½•è¡¨çš„ä½ç½®ç”± CR3 å¯„å­˜å™¨æŒ‡å¼•ã€‚â€œcregâ€å‘½ä»¤å¯ä»¥çœ‹åˆ°ï¼š\n1 2 3 4 5 6 CR0=0x8000001b: PG cd nw ac wp ne ET TS em MP PE CR2=page fault laddr=0x10002f68 CR3=0x00000000 PCD=page-level cache disable=0 PWT=page-level writes transparent=0 CR4=0x00000000: osxmmexcpt osfxsr pce pge mce pae pse de tsd pvi vme è¯´æ˜é¡µç›®å½•è¡¨çš„åŸºå€ä¸º 0ã€‚çœ‹çœ‹å…¶å†…å®¹ï¼Œâ€œxp /68w 0â€ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 0x00000000 : 0x00001027 0x00002007 0x00003007 0x00004027 0x00000010 : 0x00000000 0x00024764 0x00000000 0x00000000 0x00000020 : 0x00000000 0x00000000 0x00000000 0x00000000 0x00000030 : 0x00000000 0x00000000 0x00000000 0x00000000 0x00000040 : 0x00ffe027 0x00000000 0x00000000 0x00000000 0x00000050 : 0x00000000 0x00000000 0x00000000 0x00000000 0x00000060 : 0x00000000 0x00000000 0x00000000 0x00000000 0x00000070 : 0x00000000 0x00000000 0x00000000 0x00000000 0x00000080 : 0x00ff3027 0x00000000 0x00000000 0x00000000 0x00000090 : 0x00000000 0x00000000 0x00000000 0x00000000 0x000000a0 : 0x00000000 0x00000000 0x00000000 0x00000000 0x000000b0 : 0x00000000 0x00000000 0x00000000 0x00ffb027 0x000000c0 : 0x00ff6027 0x00000000 0x00000000 0x00000000 0x000000d0 : 0x00000000 0x00000000 0x00000000 0x00000000 0x000000e0 : 0x00000000 0x00000000 0x00000000 0x00000000 0x000000f0 : 0x00000000 0x00000000 0x00000000 0x00ffa027 0x00000100 : 0x00faa027 0x00000000 0x00000000 0x00000000 é¡µç›®å½•è¡¨å’Œé¡µè¡¨ä¸­çš„å†…å®¹å¾ˆç®€å•ï¼Œæ˜¯ 1024 ä¸ª 32 ä½ï¼ˆæ­£å¥½æ˜¯ 4Kï¼‰æ•°ã€‚è¿™ 32 ä½ä¸­å‰ 20 ä½æ˜¯ç‰©ç†é¡µæ¡†å·ï¼Œåé¢æ˜¯ä¸€äº›å±æ€§ä¿¡æ¯ï¼ˆå…¶ä¸­æœ€é‡è¦çš„æ˜¯æœ€åä¸€ä½ Pï¼‰ã€‚å…¶ä¸­ç¬¬ 65 ä¸ªé¡µç›®å½•é¡¹å°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„å†…å®¹ï¼Œç”¨â€œxp /w 0+64*4â€æŸ¥çœ‹ï¼š\n1 0x00000100 : 0x00faa027 å…¶ä¸­çš„ 027 æ˜¯å±æ€§ï¼Œæ˜¾ç„¶ P=1ï¼Œå…¶ä»–å±æ€§å®éªŒè€…è‡ªå·±åˆ†æå§ã€‚é¡µè¡¨æ‰€åœ¨ç‰©ç†é¡µæ¡†å·ä¸º 0x00faaï¼Œå³é¡µè¡¨åœ¨ç‰©ç†å†…å­˜çš„ 0x00faa000 ä½ç½®ã€‚ä»è¯¥ä½ç½®å¼€å§‹æŸ¥æ‰¾ 3 å·é¡µè¡¨é¡¹ï¼Œå¾—åˆ°ï¼ˆxp /w 0x00faa000+3*4ï¼‰ï¼š\n1 0x00faa00c : 0x00fa7067 å…¶ä¸­ 067 æ˜¯å±æ€§ï¼Œæ˜¾ç„¶ P=1ï¼Œåº”è¯¥æ˜¯è¿™æ ·ã€‚\n4.7 ç‰©ç†åœ°å€ æœ€ç»ˆç»“æœé©¬ä¸Šå°±è¦å‡ºç°äº†ï¼\nçº¿æ€§åœ°å€ 0x10003004 å¯¹åº”çš„ç‰©ç†é¡µæ¡†å·ä¸º 0x00fa7ï¼Œå’Œé¡µå†…åç§» 0x004 æ¥åˆ°ä¸€èµ·ï¼Œå¾—åˆ° 0x00fa7004ï¼Œè¿™å°±æ˜¯å˜é‡ i çš„ç‰©ç†åœ°å€ã€‚å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹æ³•éªŒè¯ã€‚\nç¬¬ä¸€ç§æ–¹æ³•æ˜¯ç”¨å‘½ä»¤ page 0x10003004ï¼Œå¯ä»¥å¾—åˆ°ä¿¡æ¯ï¼š\n1 linear page 0x10003000 maps to physical page 0x00fa7000 ç¬¬äºŒç§æ–¹æ³•æ˜¯ç”¨å‘½ä»¤ xp /w 0x00fa7004ï¼Œå¯ä»¥çœ‹åˆ°ï¼š\n1 0x00fa7004 : 0x12345678 è¿™ä¸ªæ•°å€¼ç¡®å®æ˜¯ test.c ä¸­ i çš„åˆå€¼ã€‚\nç°åœ¨ï¼Œé€šè¿‡ç›´æ¥ä¿®æ”¹å†…å­˜æ¥æ”¹å˜ i çš„å€¼ä¸º 0ï¼Œå‘½ä»¤æ˜¯ï¼š setpmem 0x00fa7004 4 0ï¼Œè¡¨ç¤ºä» 0x00fa7004 åœ°å€å¼€å§‹çš„ 4 ä¸ªå­—èŠ‚éƒ½è®¾ä¸º 0ã€‚ç„¶åå†ç”¨â€œcâ€å‘½ä»¤ç»§ç»­ Bochs çš„è¿è¡Œï¼Œå¯ä»¥çœ‹åˆ° test é€€å‡ºäº†ï¼Œè¯´æ˜ i çš„ä¿®æ”¹æˆåŠŸäº†ï¼Œæ­¤é¡¹å®éªŒç»“æŸã€‚\n4.8 åœ¨ Linux 0.11 ä¸­å®ç°å…±äº«å†…å­˜ ï¼ˆ1ï¼‰Linux ä¸­çš„å…±äº«å†…å­˜ Linux æ”¯æŒä¸¤ç§æ–¹å¼çš„å…±äº«å†…å­˜ã€‚ä¸€ç§æ–¹å¼æ˜¯ shm_open()ã€mmap() å’Œ shm_unlink() çš„ç»„åˆï¼›å¦ä¸€ç§æ–¹å¼æ˜¯ shmget()ã€shmat() å’Œ shmdt() çš„ç»„åˆã€‚æœ¬å®éªŒå»ºè®®ä½¿ç”¨åä¸€ç§æ–¹å¼ã€‚\nè¿™äº›ç³»ç»Ÿè°ƒç”¨çš„è¯¦æƒ…ï¼Œè¯·æŸ¥é˜… man åŠç›¸å…³èµ„æ–™ã€‚\nç‰¹åˆ«æé†’ï¼šæ²¡æœ‰çˆ¶å­å…³ç³»çš„è¿›ç¨‹ä¹‹é—´è¿›è¡Œå…±äº«å†…å­˜ï¼Œshmget() çš„ç¬¬ä¸€ä¸ªå‚æ•° key ä¸è¦ç”¨ IPC_PRIVATEï¼Œå¦åˆ™æ— æ³•å…±äº«ã€‚ç”¨ä»€ä¹ˆæ•°å­—å¯è§†å¿ƒæƒ…è€Œå®šã€‚\nï¼ˆ2ï¼‰è·å¾—ç©ºé—²ç‰©ç†é¡µé¢ å®éªŒè€…éœ€è¦è€ƒè™‘å¦‚ä½•å®ç°é¡µé¢å…±äº«ã€‚é¦–å…ˆçœ‹ä¸€ä¸‹ Linux 0.11 å¦‚ä½•æ“ä½œé¡µé¢ï¼Œå¦‚ä½•ç®¡ç†è¿›ç¨‹åœ°å€ç©ºé—´ã€‚\nåœ¨ kernel/fork.c æ–‡ä»¶ä¸­æœ‰ï¼š\n1 2 3 4 5 6 7 8 int copy_process(â€¦) { struct task_struct *p; p = (struct task_struct *) get_free_page(); if (!p) return -EAGAIN; // â€¦â€¦ } å‡½æ•° get_free_page() ç”¨æ¥è·å¾—ä¸€ä¸ªç©ºé—²ç‰©ç†é¡µé¢ï¼Œåœ¨ mm/memory.c æ–‡ä»¶ä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 unsigned long get_free_page(void) { register unsigned long __res asm(\"ax\"); __asm__(\"std ; repne ; scasb\\n\\t\" \"jne 1f\\n\\t\" \"movb $1,1(%%edi)\\n\\t\" // é¡µé¢æ•°*4KB=ç›¸å¯¹é¡µé¢èµ·å§‹åœ°å€ \"sall $12,%%ecx\\n\\t\" // åœ¨åŠ ä¸Šä½ç«¯çš„å†…å­˜åœ°å€ï¼Œå¾—åˆ°çš„æ˜¯ç‰©ç†èµ·å§‹åœ°å€ \"addl %2,%%ecx\\n\\t\" \"movl %%ecx,%%edx\\n\\t\" \"movl $1024,%%ecx\\n\\t\" \"leal 4092(%%edx),%%edi\\n\\t\" \"rep ; stosl\\n\\t\" //edxèµ‹ç»™eaxï¼Œeaxè¿”å›äº†ç‰©ç†èµ·å§‹åœ°å€ \"movl %%edx,%%eax\\n\" \"1:\" :\"=a\" (__res) :\"0\" (0),\"i\" (LOW_MEM),\"c\" (PAGING_PAGES), \"D\" (mem_map+PAGING_PAGES-1):\"di\",\"cx\",\"dx\"); return __res; } static unsigned char mem_map [ PAGING_PAGES ] = {0,}; æ˜¾ç„¶ get_free_page å‡½æ•°å°±æ˜¯åœ¨ mem_map ä½å›¾ä¸­å¯»æ‰¾å€¼ä¸º 0 çš„é¡¹ï¼ˆç©ºé—²é¡µé¢ï¼‰ï¼Œè¯¥å‡½æ•°è¿”å›çš„æ˜¯è¯¥é¡µé¢çš„èµ·å§‹ç‰©ç†åœ°å€ã€‚\nï¼ˆ3ï¼‰åœ°å€æ˜ å°„ æœ‰äº†ç©ºé—²çš„ç‰©ç†é¡µé¢ï¼Œæ¥ä¸‹æ¥éœ€è¦å®Œæˆçº¿æ€§åœ°å€å’Œç‰©ç†é¡µé¢çš„æ˜ å°„ï¼ŒLinux 0.11 ä¸­ä¹Ÿæœ‰è¿™æ ·çš„ä»£ç ï¼Œçœ‹çœ‹ mm/memory.c ä¸­çš„ do_no_page(unsigned long address)ï¼Œè¯¥å‡½æ•°ç”¨æ¥å¤„ç†çº¿æ€§åœ°å€ address å¯¹åº”çš„ç‰©ç†é¡µé¢æ— æ•ˆçš„æƒ…å†µï¼ˆå³ç¼ºé¡µä¸­æ–­ï¼‰ï¼Œdo_no_page å‡½æ•°ä¸­è°ƒç”¨ä¸€ä¸ªé‡è¦çš„å‡½æ•° get_empty_page(address)ï¼Œå…¶ä¸­æœ‰ï¼š\n1 2 3 4 5 // å‡½æ•° get_empty_page(address) unsigned long tmp=get_free_page(); // å»ºç«‹çº¿æ€§åœ°å€å’Œç‰©ç†åœ°å€çš„æ˜ å°„ put_page(tmp, address); æ˜¾ç„¶è¿™ä¸¤æ¡è¯­å¥å°±ç”¨æ¥è·å¾—ç©ºé—²ç‰©ç†é¡µé¢ï¼Œç„¶åå¡«å†™çº¿æ€§åœ°å€ address å¯¹åº”çš„é¡µç›®å½•å’Œé¡µè¡¨ã€‚\nï¼ˆ4ï¼‰å¯»æ‰¾ç©ºé—²çš„è™šæ‹Ÿåœ°å€ç©ºé—´ æœ‰äº†ç©ºé—²ç‰©ç†é¡µé¢ï¼Œä¹Ÿæœ‰äº†å»ºç«‹çº¿æ€§åœ°å€å’Œç‰©ç†é¡µé¢çš„æ˜ å°„ï¼Œä½†è¦å®Œæˆæœ¬å®éªŒè¿˜éœ€è¦èƒ½è·å¾—ä¸€æ®µç©ºé—²çš„è™šæ‹Ÿåœ°å€ç©ºé—²ã€‚\nè¦ä»æ•°æ®æ®µä¸­åˆ’å‡ºä¸€æ®µç©ºé—´ï¼Œé¦–å…ˆéœ€è¦äº†è§£è¿›ç¨‹æ•°æ®æ®µç©ºé—´çš„åˆ†å¸ƒï¼Œè€Œè¿™ä¸ªåˆ†å¸ƒæ˜¾ç„¶æ˜¯ç”± exec ç³»ç»Ÿè°ƒç”¨å†³å®šçš„ï¼Œæ‰€ä»¥è¦è¯¦ç»†çœ‹ä¸€çœ‹ exec çš„æ ¸å¿ƒä»£ç ï¼Œdo_execveï¼ˆåœ¨æ–‡ä»¶ fs/exec.c ä¸­ï¼‰ã€‚\nåœ¨å‡½æ•° do_execve() ä¸­ï¼Œä¿®æ”¹æ•°æ®æ®µï¼ˆå½“ç„¶æ˜¯ä¿®æ”¹ LDTï¼‰çš„åœ°æ–¹æ˜¯ change_ldtï¼Œå‡½æ•° change_ldt å®ç°å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 static unsigned long change_ldt(unsigned long text_size,unsigned long * page) { /*å…¶ä¸­text_sizeæ˜¯ä»£ç æ®µé•¿åº¦ï¼Œä»å¯æ‰§è¡Œæ–‡ä»¶çš„å¤´éƒ¨å–å‡ºï¼Œpageä¸ºå‚æ•°å’Œç¯å¢ƒé¡µ*/ unsigned long code_limit,data_limit,code_base,data_base; int i; code_limit = text_size+PAGE_SIZE -1; code_limit \u0026= 0xFFFFF000; //code_limitä¸ºä»£ç æ®µé™é•¿=text_sizeå¯¹åº”çš„é¡µæ•°ï¼ˆå‘ä¸Šå–æ•´ï¼‰ data_limit = 0x4000000; //æ•°æ®æ®µé™é•¿64MB code_base = get_base(current-\u003eldt[1]); data_base = code_base; // æ•°æ®æ®µåŸºå€ = ä»£ç æ®µåŸºå€ set_base(current-\u003eldt[1],code_base); set_limit(current-\u003eldt[1],code_limit); set_base(current-\u003eldt[2],data_base); set_limit(current-\u003eldt[2],data_limit); __asm__(\"pushl $0x17\\n\\tpop %%fs\":: ); // ä»æ•°æ®æ®µçš„æœ«å°¾å¼€å§‹ data_base += data_limit; // å‘å‰å¤„ç† for (i=MAX_ARG_PAGES-1 ; i\u003e=0 ; i--) { // ä¸€æ¬¡å¤„ç†ä¸€é¡µ data_base -= PAGE_SIZE; // å»ºç«‹çº¿æ€§åœ°å€åˆ°ç‰©ç†é¡µçš„æ˜ å°„ if (page[i]) put_page(page[i],data_base); } // è¿”å›æ®µç•Œé™ return data_limit; } ä»”ç»†åˆ†æè¿‡å‡½æ•° change_ldtï¼Œæƒ³å¿…å®éªŒè€…å·²ç»çŸ¥é“è¯¥å¦‚ä½•ä»æ•°æ®æ®µä¸­æ‰¾åˆ°ä¸€é¡µç©ºé—²çš„çº¿æ€§åœ°å€ã€‚ã€Šæ³¨é‡Šã€‹ä¸­çš„å›¾ 13-6 ä¹Ÿèƒ½ç»™ä½ å¾ˆå¤§å¸®åŠ©ã€‚\n4.9 åœ¨åŒä¸€ç»ˆç«¯ä¸­åŒæ—¶è¿è¡Œä¸¤ä¸ªç¨‹åº Linux çš„ shell æœ‰åå°è¿è¡Œç¨‹åºçš„åŠŸèƒ½ã€‚åªè¦åœ¨å‘½ä»¤çš„æœ€åè¾“å…¥ä¸€ä¸ª \u0026ï¼Œå‘½ä»¤å°±ä¼šè¿›å…¥åå°è¿è¡Œï¼Œå‰å°é©¬ä¸Šå›åˆ°æç¤ºç¬¦ï¼Œè¿›è€Œèƒ½è¿è¡Œä¸‹ä¸€ä¸ªå‘½ä»¤ï¼Œä¾‹å¦‚ï¼š\n1 2 $ sudo ./producer \u0026 $ sudo ./consumer å½“è¿è¡Œ ./consumer çš„æ—¶å€™ï¼Œproducer æ­£åœ¨åå°è¿è¡Œã€‚\n5.å®éªŒæ­¥éª¤ 1.åˆ›å»ºtest.c æŒ‚è½½hdcæ–‡ä»¶ç³»ç»Ÿï¼Œç„¶ååœ¨usr/rootç›®å½•å†…å¢åŠ test.cæ–‡ä»¶ç”¨äºæµ‹è¯•åœ°å€æ˜ å°„ï¼Œä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 #include int i = 0x12345678; int main(void) { printf(\"The logical/virtual address of i is 0x%08x\", \u0026i); fflush(stdout); while (i) ; return 0; } ä»£ç æ·»åŠ è¿‡ç¨‹æˆªå›¾å¦‚ä¸‹ï¼š 2.å¯»æ‰¾ç‰©ç†åœ°å€ é¦–å…ˆè¿›å…¥Linux-0.11ç›®å½•å†…makeç¼–è¯‘ç³»ç»Ÿï¼Œç„¶åå›é€€è‡³oslabç›®å½•å†…è¿è¡Œç³»ç»Ÿï¼Œå†ä½¿ç”¨ä¸‹è¿°å‘½ä»¤ç¼–è¯‘è¿è¡Œtest.cæ–‡ä»¶\n1 2 gcc -o test test.c ./test è¿è¡Œæ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š æ­¤æ—¶ä¼šè¿›å…¥åœ¨test.cå†…çš„whileæ­»å¾ªç¯ï¼Œç„¶åctrl+cæš‚åœbochsã€‚ æ­¤æ—¶éœ€è¦è®©Linux-0.11çš„testè·³å‡ºæ­»å¾ªç¯ï¼Œæ‰€ä»¥éœ€è¦æ‰¾åˆ°é€»è¾‘åœ°å€ds:0X00003004å¯¹åº”çš„ç‰©ç†åœ°å€ï¼Œå°†å®ƒçš„å†…å®¹æ›´æ”¹ä¸º0ã€‚ åœ¨ç»ˆç«¯ä¸­è¾“å…¥sregï¼Œå¾—åˆ°gdtrçš„åŸºå€å€¼ä¸º0x00005cb8ï¼Œldträ¸º0x0068å³0000 0000 0110 1000 bï¼Œå¯çŸ¥ç´¢å¼•ä¸º1101bå³13ï¼ŒTIä½ä¸º0ï¼Œå³GDTä¸­çš„ç¬¬13é¡¹ä¸ºLDTçš„æ®µæè¿°ç¬¦ã€‚ è¾“å…¥xp /2w 0x00005cb8+13*8å¾—åˆ°LDTæ®µæè¿°ç¬¦ï¼Œå¯ä»¥å¾—åˆ°LDTçš„åŸºå€ä¸º0x00f9a2d0 dsæ®µé€‰æ‹©å­ä¸º0x0017 =\u003e 0000 0000 0001 0111 bï¼Œå¯çŸ¥ç´¢å¼•ä¸º10bå³2ï¼ŒTIä½ä¸º1ï¼Œå³LDTä¸­çš„ç¬¬2é¡¹ä¸ºdsçš„æ®µæè¿°ç¬¦ï¼Œè¾“å…¥xp/2w 0x00f9a2d0+2*8å¾—åˆ°dsæ®µæè¿°ç¬¦ï¼Œå¯ä»¥çŸ¥é“dsçš„åŸºå€ä¸º0x10000000ï¼Œæ‰€ä»¥0x3004å¯¹åº”çš„çº¿æ€§åœ°å€ä¸º0x10000000+0x3004=0x10003004ã€‚è¾“å…¥xp /w 64*4è·å–é¡µç›®å½•é¡¹ï¼Œå¯çŸ¥é¡µè¡¨åŸºåœ°å€ä¸º0x00fa6000ã€‚ è¾“å…¥xp /w 0x00fa6000+3*4å¾—åˆ°ç‰©ç†åŸºå€ä¸º0xfa5000ã€‚ è¾“å…¥xp /w 0xfa5000+4å¾—åˆ°çš„å†…å®¹å³test.cä¸­çš„å˜é‡çš„å€¼ï¼Œè¾“å…¥setpmem 0xfa5004 4 0å°†å®ƒè®¾ä¸º0ã€‚ ç„¶ååœ¨ç»ˆç«¯å†…è¾“å…¥cç»§ç»­è®©ç³»ç»Ÿè¿è¡Œï¼Œå‘ç°testè€Œå·²è·³å‡ºå¾ªç¯ã€‚\n3.æ·»åŠ ç³»ç»Ÿè°ƒç”¨ åœ¨unistd.hä¸­å¢åŠ ä¸‹é¢çš„ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 #define SHM_SIZE 64 typedef struct shm_ds { unsigned int key; unsigned int size; unsigned long page; }shm_ds; int sys_shmget(unsigned int key,size_t size); void * sys_shmat(int shmid); ç„¶åå¢åŠ ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨\n1 2 #define __NR_shmget 76 #define __NR_shmat 77 4.ä¿®æ”¹sys.hæ–‡ä»¶ åœ¨æ­¤æ–‡ä»¶ä¸­å¢åŠ å‡½æ•°å£°æ˜ï¼š\n1 2 extern int sys_shmget(); extern int sys_shmat(); åœ¨system_call.sä¸­æŠŠnr_system_callsæ”¹ä¸º78\n5.å¢åŠ shm.c shm.cçš„ä½ç½®åœ¨kernelç›®å½•ä¸‹ ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 #define __LIBRARY__ #include #include #include #include #include static shm_ds shm_list[SHM_SIZE] = {{0,0,0}}; int sys_shmget(unsigned int key, size_t size) { int i; void *page; if(size \u003e PAGE_SIZE) return -EINVAL; page = get_free_page(); if(!page) return -ENOMEM; printk(\"shmget get memory's address is 0x%08x\\n\",page); for(i=0; i\u003cSHM_SIZE; i++) { if(shm_list[i].key == key) return i; } for(i=0; i\u003cSHM_SIZE; i++) { if(shm_list[i].key == 0) { shm_list[i].page = page; shm_list[i].key = key; shm_list[i].size = size; return i; } } return -1; } void * sys_shmat(int shmid) { int i; unsigned long data_base, brk; if(shmid \u003c 0 || SHM_SIZE \u003c= shmid || shm_list[shmid].page==0 || shm_list[shmid].key \u003c= 0) return (void *)-EINVAL; data_base = get_base(current-\u003eldt[2]); printk(\"current's data_base = 0x%08x,new page = 0x%08x\\n\",data_base,shm_list[shmid].page); brk = current-\u003ebrk + data_base; current-\u003ebrk += PAGE_SIZE; if(put_page(shm_list[shmid].page, brk) == 0) return (void *)-ENOMEM; return (void *)(current-\u003ebrk - PAGE_SIZE); } ç„¶åä¿®æ”¹Kernelä¸‹çš„Makefileæ–‡ä»¶\n1 2 3 4 5 ### Dependencies: sem.s sem.o: sem.c ../include/linux/sem.h ../include/linux/kernel.h \\ ../include/unistd.h shm.s shm.o:shm.c ../include/unistd.h ../include/linux/kernel.h ../include/linux/sched.h ../include/linux/mm.h ../include/errno.h ... ä¿®æ”¹æˆªå›¾å¦‚ä¸‹ï¼š 6.ç¼–å†™æ¶ˆè´¹è€…å’Œç”Ÿäº§è€…ç¨‹åº åœ¨hdcçš„rootç›®å½•ä¸‹å¢åŠ producer.cå’Œconsumer.cæ–‡ä»¶ï¼Œè¿™ä¸¤ä¸ªæ–‡ä»¶çš„ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 /*producer*/ #define __LIBRARY__ #include #include #include #include #include #include _syscall2(sem_t *,sem_open,const char *,name,int,value); _syscall1(int,sem_post,sem_t *,sem); _syscall1(int,sem_wait,sem_t *,sem); _syscall1(int, shmat, int, shmid); _syscall2(int, shmget, unsigned int, key, size_t, size); #define PRODUCE_NUM 200 #define BUFFER_SIZE 10 #define SHM_KEY 2018 int main(int argc, char* argv[]) { sem_t *Empty,*Full,*Mutex; int i, shm_id, location=0; int *p; Empty = sem_open(\"Empty\", BUFFER_SIZE); Full = sem_open(\"Full\", 0); Mutex = sem_open(\"Mutex\", 1); if((shm_id = shmget(SHM_KEY, BUFFER_SIZE*sizeof(int))) \u003c 0) printf(\"shmget failed!\"); if((p = (int * )shmat(shm_id)) \u003c 0) printf(\"shmat error!\"); for(i=0; i\u003cPRODUCE_NUM; i++) { sem_wait(Empty); sem_wait(Mutex); p[location] = i; sem_post(Mutex); sem_post(Full); location = (location+1) % BUFFER_SIZE; } return 0; } consumer.cä»£ç å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 /*consumer*/ #define __LIBRARY__ #include #include #include #include #include #include _syscall2(sem_t *,sem_open,const char *,name,int,value); _syscall1(int,sem_post,sem_t *,sem); _syscall1(int,sem_wait,sem_t *,sem); _syscall1(int,sem_unlink,const char*,name); _syscall1(int, shmat, int, shmid); _syscall2(int, shmget, unsigned int, key, size_t, size); #define PRODUCE_NUM 200 #define BUFFER_SIZE 10 #define SHM_KEY 2018 int main(int argc, char* argv[]) { sem_t *Empty,*Full,*Mutex; int used = 0, shm_id,location = 0; int *p; Empty = sem_open(\"Empty\", BUFFER_SIZE); Full = sem_open(\"Full\", 0); Mutex = sem_open(\"Mutex\", 1); if((shm_id = shmget(SHM_KEY, BUFFER_SIZE*sizeof(int))) \u003c 0) printf(\"shmget failed!\\n\"); if((p = (int * )shmat(shm_id)) \u003c 0) printf(\"link error!\\n\"); while(1) { sem_wait(Full); sem_wait(Mutex); printf(\"pid %d:\\tconsumer consumes item %d\\n\", getpid(), p[location]); fflush(stdout); sem_post(Mutex); sem_post(Empty); location = (location+1) % BUFFER_SIZE; if(++used == PRODUCE_NUM) break; } sem_unlink(\"Mutex\"); sem_unlink(\"Full\"); sem_unlink(\"Empty\"); return 0; } 7.è¿è¡ŒéªŒè¯ è¿è¡Œbochsï¼Œè¾“å…¥ï¼š\n1 2 gcc -o pro producer.c gcc -o con consumer.c ç¼–è¯‘è¿™ä¸¤ä¸ªç¨‹åºï¼Œ ç„¶åè¾“å…¥\n1 2 pro \u003e proOutput \u0026 con \u003e conOutput \u0026 æ¥åŒæ—¶è¿è¡Œè¿™ä¸¤ä¸ªç¨‹åºï¼Œå¹¶å°†ç»“æœä¿å­˜åˆ°proOutputå’ŒconOutputä¸­ã€‚ æœ€åè¾“å…¥sync,ç»“æœå¦‚ä¸‹ å…³é—­linux-0.11å›åˆ°ubuntç»ˆç«¯ï¼Œè¾“å…¥sudo less hdc/usr/root/conOutputæŸ¥çœ‹ç»“æœå¦‚ä¸‹ï¼š ",
  "wordCount" : "8122",
  "inLanguage": "zh",
  "datePublished": "2022-05-25T00:00:00Z",
  "dateModified": "2022-05-25T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "chance7bin"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://chance7bin.github.io/posts/basic/os-lab/%E5%AE%9E%E9%AA%8C7-%E5%9C%B0%E5%9D%80%E6%98%A0%E5%B0%84%E4%B8%8E%E5%85%B1%E4%BA%AB/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Binb's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://chance7bin.github.io/" accesskey="h" title="Binb&#39;s Blog (Alt + H)">
                <img src="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg" alt="" aria-label="logo"
                    height="35">Binb&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://chance7bin.github.io/search" title="ğŸ”æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ”æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="https://chance7bin.github.io/" title="ğŸ  ä¸»é¡µ">
                    <span>ğŸ  ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://chance7bin.github.io/archives/" title="â±ï¸ æ—¶é—´è½´">
                    <span>â±ï¸ æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://chance7bin.github.io/posts" title="ğŸ“š æ–‡ç« ">
                    <span>ğŸ“š æ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://chance7bin.github.io/tags" title="ğŸ”– æ ‡ç­¾">
                    <span>ğŸ”– æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://github.com/chance7bin" title="GitHub">
                    <span>GitHub</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://chance7bin.github.io/">ğŸ  ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://chance7bin.github.io/posts/">ğŸ“š æ–‡ç« </a>&nbsp;Â»&nbsp;<a href="https://chance7bin.github.io/posts/basic/">ğŸ“• è®¡ç®—æœºåŸºç¡€</a>&nbsp;Â»&nbsp;<a href="https://chance7bin.github.io/posts/basic/os-lab/">hit-oslab</a></div>
    <h1 class="post-title">
      å®éªŒ7 åœ°å€æ˜ å°„ä¸å…±äº«
    </h1>
    <div class="post-meta">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">


<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }

    .parent-post-meta {
        display: flex;
        flex-wrap: wrap;
        opacity: 0.8;
    }
</style>

<span class="parent-post-meta">
    <span id="post_meta_style_1">
        <span class="fa fa-calendar-check-o"></span>
        <span>2022-05-25
            &nbsp;&nbsp;
        </span>
    </span>
    
    
    
    
    
    
    
    <span id="post_meta_style_3">
        <span class="fa fa-file-word-o"></span>
        <span>8122å­—
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_4">
        <span class="fa fa-clock-o"></span>
        <span>17åˆ†é’Ÿ
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_5">
        <span class="fa fa-user-o"></span>
        <span>chance7bin
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_6">
        <span class="fa fa-tags" style="opacity: 0.8"></span>
        <span>
            <span class="post-tags-meta">
                <a href="https://chance7bin.github.io/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="color: var(--secondary)!important;">æ“ä½œç³»ç»Ÿ</a>
                &nbsp;<a href="https://chance7bin.github.io/tags/%E5%AE%9E%E9%AA%8C/" style="color: var(--secondary)!important;">å®éªŒ</a>
            </span>
        </span>
    </span>

    
</span>


      
      
      
      
      
      
      
          
          
          
              
              
              
              
          
      
    </div>
  </header>
   <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#1%e5%ae%9e%e9%aa%8c%e7%9b%ae%e7%9a%84" aria-label="1.å®éªŒç›®çš„">1.å®éªŒç›®çš„</a></li>
                    <li>
                        <a href="#2%e5%ae%9e%e9%aa%8c%e5%86%85%e5%ae%b9" aria-label="2.å®éªŒå†…å®¹">2.å®éªŒå†…å®¹</a><ul>
                            
                    <li>
                        <a href="#21-%e8%b7%9f%e8%b8%aa%e5%9c%b0%e5%9d%80%e7%bf%bb%e8%af%91%e8%bf%87%e7%a8%8b" aria-label="2.1 è·Ÿè¸ªåœ°å€ç¿»è¯‘è¿‡ç¨‹">2.1 è·Ÿè¸ªåœ°å€ç¿»è¯‘è¿‡ç¨‹</a></li>
                    <li>
                        <a href="#22-%e5%9f%ba%e4%ba%8e%e5%85%b1%e4%ba%ab%e5%86%85%e5%ad%98%e7%9a%84%e7%94%9f%e4%ba%a7%e8%80%85%e6%b6%88%e8%b4%b9%e8%80%85%e7%a8%8b%e5%ba%8f" aria-label="2.2 åŸºäºå…±äº«å†…å­˜çš„ç”Ÿäº§è€…â€”æ¶ˆè´¹è€…ç¨‹åº">2.2 åŸºäºå…±äº«å†…å­˜çš„ç”Ÿäº§è€…â€”æ¶ˆè´¹è€…ç¨‹åº</a></li>
                    <li>
                        <a href="#23-%e5%85%b1%e4%ba%ab%e5%86%85%e5%ad%98%e7%9a%84%e5%ae%9e%e7%8e%b0" aria-label="2.3 å…±äº«å†…å­˜çš„å®ç°">2.3 å…±äº«å†…å­˜çš„å®ç°</a></li></ul>
                    </li>
                    <li>
                        <a href="#3%e5%ae%9e%e9%aa%8c%e6%8a%a5%e5%91%8a" aria-label="3.å®éªŒæŠ¥å‘Š">3.å®éªŒæŠ¥å‘Š</a></li>
                    <li>
                        <a href="#4%e5%ae%9e%e9%aa%8c%e6%8f%90%e7%a4%ba" aria-label="4.å®éªŒæç¤º">4.å®éªŒæç¤º</a><ul>
                            
                    <li>
                        <a href="#41-ia-32-%e7%9a%84%e5%9c%b0%e5%9d%80%e7%bf%bb%e8%af%91%e8%bf%87%e7%a8%8b" aria-label="4.1 IA-32 çš„åœ°å€ç¿»è¯‘è¿‡ç¨‹">4.1 IA-32 çš„åœ°å€ç¿»è¯‘è¿‡ç¨‹</a></li>
                    <li>
                        <a href="#42-%e7%94%a8-bochs-%e6%b1%87%e7%bc%96%e7%ba%a7%e8%b0%83%e8%af%95%e5%8a%9f%e8%83%bd%e8%bf%9b%e8%a1%8c%e4%ba%ba%e5%b7%a5%e5%9c%b0%e5%9d%80%e7%bf%bb%e8%af%91" aria-label="4.2 ç”¨ Bochs æ±‡ç¼–çº§è°ƒè¯•åŠŸèƒ½è¿›è¡Œäººå·¥åœ°å€ç¿»è¯‘">4.2 ç”¨ Bochs æ±‡ç¼–çº§è°ƒè¯•åŠŸèƒ½è¿›è¡Œäººå·¥åœ°å€ç¿»è¯‘</a></li>
                    <li>
                        <a href="#1%e5%87%86%e5%a4%87" aria-label="ï¼ˆ1ï¼‰å‡†å¤‡">ï¼ˆ1ï¼‰å‡†å¤‡</a></li>
                    <li>
                        <a href="#2%e6%9a%82%e5%81%9c" aria-label="ï¼ˆ2ï¼‰æš‚åœ">ï¼ˆ2ï¼‰æš‚åœ</a></li>
                    <li>
                        <a href="#43-%e6%ae%b5%e8%a1%a8" aria-label="4.3 æ®µè¡¨">4.3 æ®µè¡¨</a></li>
                    <li>
                        <a href="#44-%e6%ae%b5%e6%8f%8f%e8%bf%b0%e7%ac%a6" aria-label="4.4 æ®µæè¿°ç¬¦">4.4 æ®µæè¿°ç¬¦</a></li>
                    <li>
                        <a href="#45-%e6%ae%b5%e5%9f%ba%e5%9d%80%e5%92%8c%e7%ba%bf%e6%80%a7%e5%9c%b0%e5%9d%80" aria-label="4.5 æ®µåŸºå€å’Œçº¿æ€§åœ°å€">4.5 æ®µåŸºå€å’Œçº¿æ€§åœ°å€</a></li>
                    <li>
                        <a href="#46-%e9%a1%b5%e8%a1%a8" aria-label="4.6 é¡µè¡¨">4.6 é¡µè¡¨</a></li>
                    <li>
                        <a href="#47-%e7%89%a9%e7%90%86%e5%9c%b0%e5%9d%80" aria-label="4.7 ç‰©ç†åœ°å€">4.7 ç‰©ç†åœ°å€</a></li>
                    <li>
                        <a href="#48-%e5%9c%a8-linux-011-%e4%b8%ad%e5%ae%9e%e7%8e%b0%e5%85%b1%e4%ba%ab%e5%86%85%e5%ad%98" aria-label="4.8 åœ¨ Linux 0.11 ä¸­å®ç°å…±äº«å†…å­˜">4.8 åœ¨ Linux 0.11 ä¸­å®ç°å…±äº«å†…å­˜</a><ul>
                            
                    <li>
                        <a href="#1linux-%e4%b8%ad%e7%9a%84%e5%85%b1%e4%ba%ab%e5%86%85%e5%ad%98" aria-label="ï¼ˆ1ï¼‰Linux ä¸­çš„å…±äº«å†…å­˜">ï¼ˆ1ï¼‰Linux ä¸­çš„å…±äº«å†…å­˜</a></li>
                    <li>
                        <a href="#2%e8%8e%b7%e5%be%97%e7%a9%ba%e9%97%b2%e7%89%a9%e7%90%86%e9%a1%b5%e9%9d%a2" aria-label="ï¼ˆ2ï¼‰è·å¾—ç©ºé—²ç‰©ç†é¡µé¢">ï¼ˆ2ï¼‰è·å¾—ç©ºé—²ç‰©ç†é¡µé¢</a></li>
                    <li>
                        <a href="#3%e5%9c%b0%e5%9d%80%e6%98%a0%e5%b0%84" aria-label="ï¼ˆ3ï¼‰åœ°å€æ˜ å°„">ï¼ˆ3ï¼‰åœ°å€æ˜ å°„</a></li>
                    <li>
                        <a href="#4%e5%af%bb%e6%89%be%e7%a9%ba%e9%97%b2%e7%9a%84%e8%99%9a%e6%8b%9f%e5%9c%b0%e5%9d%80%e7%a9%ba%e9%97%b4" aria-label="ï¼ˆ4ï¼‰å¯»æ‰¾ç©ºé—²çš„è™šæ‹Ÿåœ°å€ç©ºé—´">ï¼ˆ4ï¼‰å¯»æ‰¾ç©ºé—²çš„è™šæ‹Ÿåœ°å€ç©ºé—´</a></li></ul>
                    </li>
                    <li>
                        <a href="#49-%e5%9c%a8%e5%90%8c%e4%b8%80%e7%bb%88%e7%ab%af%e4%b8%ad%e5%90%8c%e6%97%b6%e8%bf%90%e8%a1%8c%e4%b8%a4%e4%b8%aa%e7%a8%8b%e5%ba%8f" aria-label="4.9 åœ¨åŒä¸€ç»ˆç«¯ä¸­åŒæ—¶è¿è¡Œä¸¤ä¸ªç¨‹åº">4.9 åœ¨åŒä¸€ç»ˆç«¯ä¸­åŒæ—¶è¿è¡Œä¸¤ä¸ªç¨‹åº</a></li></ul>
                    </li>
                    <li>
                        <a href="#5%e5%ae%9e%e9%aa%8c%e6%ad%a5%e9%aa%a4" aria-label="5.å®éªŒæ­¥éª¤">5.å®éªŒæ­¥éª¤</a><ul>
                            
                    <li>
                        <a href="#1%e5%88%9b%e5%bb%batestc" aria-label="1.åˆ›å»ºtest.c">1.åˆ›å»ºtest.c</a></li>
                    <li>
                        <a href="#2%e5%af%bb%e6%89%be%e7%89%a9%e7%90%86%e5%9c%b0%e5%9d%80" aria-label="2.å¯»æ‰¾ç‰©ç†åœ°å€">2.å¯»æ‰¾ç‰©ç†åœ°å€</a></li>
                    <li>
                        <a href="#3%e6%b7%bb%e5%8a%a0%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8" aria-label="3.æ·»åŠ ç³»ç»Ÿè°ƒç”¨">3.æ·»åŠ ç³»ç»Ÿè°ƒç”¨</a></li>
                    <li>
                        <a href="#4%e4%bf%ae%e6%94%b9sysh%e6%96%87%e4%bb%b6" aria-label="4.ä¿®æ”¹sys.hæ–‡ä»¶">4.ä¿®æ”¹sys.hæ–‡ä»¶</a></li>
                    <li>
                        <a href="#5%e5%a2%9e%e5%8a%a0shmc" aria-label="5.å¢åŠ shm.c">5.å¢åŠ shm.c</a></li>
                    <li>
                        <a href="#6%e7%bc%96%e5%86%99%e6%b6%88%e8%b4%b9%e8%80%85%e5%92%8c%e7%94%9f%e4%ba%a7%e8%80%85%e7%a8%8b%e5%ba%8f" aria-label="6.ç¼–å†™æ¶ˆè´¹è€…å’Œç”Ÿäº§è€…ç¨‹åº">6.ç¼–å†™æ¶ˆè´¹è€…å’Œç”Ÿäº§è€…ç¨‹åº</a></li>
                    <li>
                        <a href="#7%e8%bf%90%e8%a1%8c%e9%aa%8c%e8%af%81" aria-label="7.è¿è¡ŒéªŒè¯">7.è¿è¡ŒéªŒè¯</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>
  <div class="post-content"><h2 id="1å®éªŒç›®çš„">1.å®éªŒç›®çš„<a hidden class="anchor" aria-hidden="true" href="#1å®éªŒç›®çš„">#</a></h2>
<ul>
<li>æ·±å…¥ç†è§£æ“ä½œç³»ç»Ÿçš„æ®µã€é¡µå¼å†…å­˜ç®¡ç†ï¼Œæ·±å…¥ç†è§£æ®µè¡¨ã€é¡µè¡¨ã€é€»è¾‘åœ°å€ã€çº¿æ€§åœ°å€ã€ç‰©ç†åœ°å€ç­‰æ¦‚å¿µï¼›</li>
<li>å®è·µæ®µã€é¡µå¼å†…å­˜ç®¡ç†çš„åœ°å€æ˜ å°„è¿‡ç¨‹ï¼›</li>
<li>ç¼–ç¨‹å®ç°æ®µã€é¡µå¼å†…å­˜ç®¡ç†ä¸Šçš„å†…å­˜å…±äº«ï¼Œä»è€Œæ·±å…¥ç†è§£æ“ä½œç³»ç»Ÿçš„å†…å­˜ç®¡ç†ã€‚</li>
</ul>
<h2 id="2å®éªŒå†…å®¹">2.å®éªŒå†…å®¹<a hidden class="anchor" aria-hidden="true" href="#2å®éªŒå†…å®¹">#</a></h2>
<p>æœ¬æ¬¡å®éªŒçš„åŸºæœ¬å†…å®¹æ˜¯ï¼š</p>
<ul>
<li>ç”¨ Bochs è°ƒè¯•å·¥å…·è·Ÿè¸ª Linux 0.11 çš„åœ°å€ç¿»è¯‘ï¼ˆåœ°å€æ˜ å°„ï¼‰è¿‡ç¨‹ï¼Œäº†è§£ IA-32 å’Œ Linux 0.11 çš„å†…å­˜ç®¡ç†æœºåˆ¶ï¼›</li>
<li>åœ¨ Ubuntu ä¸Šç¼–å†™å¤šè¿›ç¨‹çš„ç”Ÿäº§è€…â€”æ¶ˆè´¹è€…ç¨‹åºï¼Œç”¨å…±äº«å†…å­˜åšç¼“å†²åŒºï¼›</li>
<li>åœ¨ä¿¡å·é‡å®éªŒçš„åŸºç¡€ä¸Šï¼Œä¸º Linux 0.11 å¢åŠ å…±äº«å†…å­˜åŠŸèƒ½ï¼Œå¹¶å°†ç”Ÿäº§è€…â€”æ¶ˆè´¹è€…ç¨‹åºç§»æ¤åˆ° Linux 0.11ã€‚</li>
</ul>
<h3 id="21-è·Ÿè¸ªåœ°å€ç¿»è¯‘è¿‡ç¨‹">2.1 è·Ÿè¸ªåœ°å€ç¿»è¯‘è¿‡ç¨‹<a hidden class="anchor" aria-hidden="true" href="#21-è·Ÿè¸ªåœ°å€ç¿»è¯‘è¿‡ç¨‹">#</a></h3>
<p>é¦–å…ˆä»¥æ±‡ç¼–çº§è°ƒè¯•çš„æ–¹å¼å¯åŠ¨ Bochsï¼Œå¼•å¯¼ Linux 0.11ï¼Œåœ¨ 0.11 ä¸‹ç¼–è¯‘å’Œè¿è¡Œ test.cã€‚å®ƒæ˜¯ä¸€ä¸ªæ— é™å¾ªç¯çš„ç¨‹åºï¼Œæ°¸è¿œä¸ä¼šä¸»åŠ¨é€€å‡ºã€‚ç„¶ååœ¨è°ƒè¯•å™¨ä¸­é€šè¿‡æŸ¥çœ‹å„é¡¹ç³»ç»Ÿå‚æ•°ï¼Œä»é€»è¾‘åœ°å€ã€LDT è¡¨ã€GDT è¡¨ã€çº¿æ€§åœ°å€åˆ°é¡µè¡¨ï¼Œè®¡ç®—å‡ºå˜é‡ <code>i</code> çš„ç‰©ç†åœ°å€ã€‚æœ€åé€šè¿‡ç›´æ¥ä¿®æ”¹ç‰©ç†å†…å­˜çš„æ–¹å¼è®© test.c é€€å‡ºè¿è¡Œã€‚</p>
<p>test.c çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mh">0x12345678</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;The logical/virtual address of i is 0x%08x&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="22-åŸºäºå…±äº«å†…å­˜çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…ç¨‹åº">2.2 åŸºäºå…±äº«å†…å­˜çš„ç”Ÿäº§è€…â€”æ¶ˆè´¹è€…ç¨‹åº<a hidden class="anchor" aria-hidden="true" href="#22-åŸºäºå…±äº«å†…å­˜çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…ç¨‹åº">#</a></h3>
<p>æœ¬é¡¹å®éªŒåœ¨ Ubuntu ä¸‹å®Œæˆï¼Œä¸ä¿¡å·é‡å®éªŒä¸­çš„ <code>pc.c</code> çš„åŠŸèƒ½è¦æ±‚åŸºæœ¬ä¸€è‡´ï¼Œä»…æœ‰ä¸¤ç‚¹ä¸åŒï¼š</p>
<ul>
<li>ä¸ç”¨æ–‡ä»¶åšç¼“å†²åŒºï¼Œè€Œæ˜¯ä½¿ç”¨å…±äº«å†…å­˜ï¼›</li>
<li>ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…åˆ†åˆ«æ˜¯ä¸åŒçš„ç¨‹åºã€‚ç”Ÿäº§è€…æ˜¯ producer.cï¼Œæ¶ˆè´¹è€…æ˜¯ consumer.cã€‚ä¸¤ä¸ªç¨‹åºéƒ½æ˜¯å•è¿›ç¨‹çš„ï¼Œé€šè¿‡ä¿¡å·é‡å’Œç¼“å†²åŒºè¿›è¡Œé€šä¿¡ã€‚</li>
</ul>
<p>Linux ä¸‹ï¼Œå¯ä»¥é€šè¿‡ <code>shmget()</code> å’Œ <code>shmat()</code> ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ä½¿ç”¨å…±äº«å†…å­˜ã€‚</p>
<h3 id="23-å…±äº«å†…å­˜çš„å®ç°">2.3 å…±äº«å†…å­˜çš„å®ç°<a hidden class="anchor" aria-hidden="true" href="#23-å…±äº«å†…å­˜çš„å®ç°">#</a></h3>
<p>è¿›ç¨‹ä¹‹é—´å¯ä»¥é€šè¿‡é¡µå…±äº«è¿›è¡Œé€šä¿¡ï¼Œè¢«å…±äº«çš„é¡µå«åšå…±äº«å†…å­˜ï¼Œç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012340284.bmp" alt="å›¾ç‰‡æè¿°ä¿¡æ¯"  />
</p>
<p>å›¾ 1 è¿›ç¨‹é—´å…±äº«å†…å­˜çš„ç»“æ„</p>
<p>æœ¬éƒ¨åˆ†å®éªŒå†…å®¹æ˜¯åœ¨ Linux 0.11 ä¸Šå®ç°ä¸Šè¿°é¡µé¢å…±äº«ï¼Œå¹¶å°†ä¸Šä¸€éƒ¨åˆ†å®ç°çš„ producer.c å’Œ consumer.c ç§»æ¤è¿‡æ¥ï¼ŒéªŒè¯é¡µé¢å…±äº«çš„æœ‰æ•ˆæ€§ã€‚</p>
<p>å…·ä½“è¦æ±‚åœ¨ <code>mm/shm.c</code> ä¸­å®ç° <code>shmget()</code> å’Œ <code>shmat()</code> ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ã€‚å®ƒä»¬èƒ½æ”¯æŒ <code>producer.c</code> å’Œ <code>consumer.c</code> çš„è¿è¡Œå³å¯ï¼Œä¸éœ€è¦å®Œæ•´åœ°å®ç° POSIX æ‰€è§„å®šçš„åŠŸèƒ½ã€‚</p>
<ul>
<li>shmget()</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">shmget</span><span class="p">(</span><span class="kt">key_t</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">shmflg</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>shmget()</code> ä¼šæ–°å»º/æ‰“å¼€ä¸€é¡µå†…å­˜ï¼Œå¹¶è¿”å›è¯¥é¡µå…±äº«å†…å­˜çš„ shmidï¼ˆè¯¥å—å…±äº«å†…å­˜åœ¨æ“ä½œç³»ç»Ÿå†…éƒ¨çš„ idï¼‰ã€‚</p>
<p>æ‰€æœ‰ä½¿ç”¨åŒä¸€å—å…±äº«å†…å­˜çš„è¿›ç¨‹éƒ½è¦ä½¿ç”¨ç›¸åŒçš„ key å‚æ•°ã€‚</p>
<p>å¦‚æœ key æ‰€å¯¹åº”çš„å…±äº«å†…å­˜å·²ç»å»ºç«‹ï¼Œåˆ™ç›´æ¥è¿”å› <code>shmid</code>ã€‚å¦‚æœ size è¶…è¿‡ä¸€é¡µå†…å­˜çš„å¤§å°ï¼Œè¿”å› <code>-1</code>ï¼Œå¹¶ç½® <code>errno</code> ä¸º <code>EINVAL</code>ã€‚å¦‚æœç³»ç»Ÿæ— ç©ºé—²å†…å­˜ï¼Œè¿”å› -1ï¼Œå¹¶ç½® <code>errno</code> ä¸º <code>ENOMEM</code>ã€‚</p>
<p><code>shmflg</code> å‚æ•°å¯å¿½ç•¥ã€‚</p>
<ul>
<li>shmat()</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="o">*</span><span class="nf">shmat</span><span class="p">(</span><span class="kt">int</span> <span class="n">shmid</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">shmaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">shmflg</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>shmat()</code> ä¼šå°† <code>shmid</code> æŒ‡å®šçš„å…±äº«é¡µé¢æ˜ å°„åˆ°å½“å‰è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ï¼Œå¹¶å°†å…¶é¦–åœ°å€è¿”å›ã€‚</p>
<p>å¦‚æœ <code>shmid</code> éæ³•ï¼Œè¿”å› <code>-1</code>ï¼Œå¹¶ç½® <code>errno</code> ä¸º <code>EINVAL</code>ã€‚</p>
<p><code>shmaddr</code> å’Œ <code>shmflg</code> å‚æ•°å¯å¿½ç•¥ã€‚</p>
<h2 id="3å®éªŒæŠ¥å‘Š">3.å®éªŒæŠ¥å‘Š<a hidden class="anchor" aria-hidden="true" href="#3å®éªŒæŠ¥å‘Š">#</a></h2>
<p>å®Œæˆå®éªŒåï¼Œåœ¨å®éªŒæŠ¥å‘Šä¸­å›ç­”å¦‚ä¸‹é—®é¢˜ï¼š</p>
<ul>
<li>å¯¹äºåœ°å€æ˜ å°„å®éªŒéƒ¨åˆ†ï¼Œåˆ—å‡ºä½ è®¤ä¸ºæœ€é‡è¦çš„é‚£å‡ æ­¥ï¼ˆä¸è¶…è¿‡ 4 æ­¥ï¼‰ï¼Œå¹¶ç»™å‡ºä½ è·å¾—çš„å®éªŒæ•°æ®ã€‚</li>
<li>test.c é€€å‡ºåï¼Œå¦‚æœé©¬ä¸Šå†è¿è¡Œä¸€æ¬¡ï¼Œå¹¶å†è¿›è¡Œåœ°å€è·Ÿè¸ªï¼Œä½ å‘ç°æœ‰å“ªäº›å¼‚åŒï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ</li>
</ul>
<h2 id="4å®éªŒæç¤º">4.å®éªŒæç¤º<a hidden class="anchor" aria-hidden="true" href="#4å®éªŒæç¤º">#</a></h2>
<p>æœ¬æ¬¡éœ€è¦å®Œæˆçš„å†…å®¹ï¼š</p>
<ul>
<li>ï¼ˆ1ï¼‰ç”¨ Bochs è°ƒè¯•å·¥å…·è·Ÿè¸ª Linux 0.11 çš„åœ°å€ç¿»è¯‘ï¼ˆåœ°å€æ˜ å°„ï¼‰è¿‡ç¨‹ï¼Œäº†è§£ IA-32 å’Œ Linux 0.11 çš„å†…å­˜ç®¡ç†æœºåˆ¶ï¼›</li>
<li>ï¼ˆ2ï¼‰åœ¨ Ubuntu ä¸Šç¼–å†™å¤šè¿›ç¨‹çš„ç”Ÿäº§è€…â€”æ¶ˆè´¹è€…ç¨‹åºï¼Œç”¨å…±äº«å†…å­˜åšç¼“å†²åŒºï¼›</li>
<li>ï¼ˆ3ï¼‰åœ¨ä¿¡å·é‡å®éªŒçš„åŸºç¡€ä¸Šï¼Œä¸º Linux 0.11 å¢åŠ å…±äº«å†…å­˜åŠŸèƒ½ï¼Œå¹¶å°†ç”Ÿäº§è€…â€”æ¶ˆè´¹è€…ç¨‹åºç§»æ¤åˆ° Linux 0.11ã€‚</li>
</ul>
<h3 id="41-ia-32-çš„åœ°å€ç¿»è¯‘è¿‡ç¨‹">4.1 IA-32 çš„åœ°å€ç¿»è¯‘è¿‡ç¨‹<a hidden class="anchor" aria-hidden="true" href="#41-ia-32-çš„åœ°å€ç¿»è¯‘è¿‡ç¨‹">#</a></h3>
<p>Linux 0.11 å®Œå…¨éµå¾ª IA-32ï¼ˆIntel Architecture 32-bitï¼‰æ¶æ„è¿›è¡Œåœ°å€ç¿»è¯‘ï¼ŒWindowsã€åç»­ç‰ˆæœ¬çš„ Linux ä»¥åŠä¸€åˆ‡åœ¨ IA-32 ä¿æŠ¤æ¨¡å¼ä¸‹è¿è¡Œçš„æ“ä½œç³»ç»Ÿéƒ½éµå¾ªæ­¤æ¶æ„ã€‚å› ä¸ºåªæœ‰è¿™æ ·æ‰èƒ½å……åˆ†å‘æŒ¥ CPU çš„ <code>MMU</code>ï¼ˆå†…å­˜ç®¡ç†å•å…ƒï¼‰ çš„åŠŸèƒ½ã€‚</p>
<p>å…³äºæ­¤åœ°å€ç¿»è¯‘è¿‡ç¨‹çš„ç»†èŠ‚ï¼Œè¯·å‚è€ƒã€Šæ³¨é‡Šã€‹ä¸€ä¹¦ä¸­çš„ 5.3.1-5.3.4 èŠ‚ã€‚</p>
<h3 id="42-ç”¨-bochs-æ±‡ç¼–çº§è°ƒè¯•åŠŸèƒ½è¿›è¡Œäººå·¥åœ°å€ç¿»è¯‘">4.2 ç”¨ Bochs æ±‡ç¼–çº§è°ƒè¯•åŠŸèƒ½è¿›è¡Œäººå·¥åœ°å€ç¿»è¯‘<a hidden class="anchor" aria-hidden="true" href="#42-ç”¨-bochs-æ±‡ç¼–çº§è°ƒè¯•åŠŸèƒ½è¿›è¡Œäººå·¥åœ°å€ç¿»è¯‘">#</a></h3>
<p>æ­¤è¿‡ç¨‹æ¯”è¾ƒæœºæ¢°ï¼ŒåŸºæœ¬ä¸æ¶ˆè€—è„‘ç»†èƒï¼Œåšä¸€ä¸‹æœ‰å¾ˆå¤šå¥½å¤„ã€‚</p>
<p>==Bochså‘½ä»¤==</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[å†…å­˜æ“ä½œ]
</span></span><span class="line"><span class="cl">x  /nuf [addr]  æ˜¾ç¤ºçº¿æ€§åœ°å€çš„å†…å®¹
</span></span><span class="line"><span class="cl">xp /nuf [addr]  æ˜¾ç¤ºç‰©ç†åœ°å€çš„å†…å®¹
</span></span><span class="line"><span class="cl">    n           æ˜¾ç¤ºçš„å•å…ƒæ•°
</span></span><span class="line"><span class="cl">    u           æ¯ä¸ªæ˜¾ç¤ºå•å…ƒçš„å¤§å°ï¼Œuå¯ä»¥æ˜¯ä¸‹åˆ—ä¹‹ä¸€ï¼š
</span></span><span class="line"><span class="cl">                    b BYTE
</span></span><span class="line"><span class="cl">                    h WORD
</span></span><span class="line"><span class="cl">                    w DWORD
</span></span><span class="line"><span class="cl">                    g DWORD64
</span></span><span class="line"><span class="cl">                    æ³¨æ„: è¿™ç§å‘½åæ³•æ˜¯æŒ‰ç…§GDBä¹ æƒ¯çš„ï¼Œè€Œå¹¶ä¸æ˜¯æŒ‰ç…§interçš„è§„èŒƒã€‚
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    f           æ˜¾ç¤ºæ ¼å¼ï¼Œfå¯ä»¥æ˜¯ä¸‹åˆ—ä¹‹ä¸€ï¼š
</span></span><span class="line"><span class="cl">                    x æŒ‰ç…§åå…­è¿›åˆ¶æ˜¾ç¤º
</span></span><span class="line"><span class="cl">                    d åè¿›åˆ¶æ˜¾ç¤º
</span></span><span class="line"><span class="cl">                    u æŒ‰ç…§æ— ç¬¦å·åè¿›åˆ¶æ˜¾ç¤º
</span></span><span class="line"><span class="cl">                    o æŒ‰ç…§å…«è¿›åˆ¶æ˜¾ç¤º
</span></span><span class="line"><span class="cl">                    t æŒ‰ç…§äºŒè¿›åˆ¶æ˜¾ç¤º
</span></span><span class="line"><span class="cl">                    c æŒ‰ç…§å­—ç¬¦æ˜¾ç¤º
</span></span><span class="line"><span class="cl">    nã€fã€uæ˜¯å¯é€‰å‚æ•°ï¼Œå¦‚æœä¸æŒ‡å®šï¼Œåˆ™ué»˜è®¤æ˜¯wï¼Œfé»˜è®¤æ˜¯xã€‚å¦‚æœå‰é¢ä½¿ç”¨è¿‡xæˆ–
</span></span><span class="line"><span class="cl">    è€…xpå‘½ä»¤ï¼Œä¼šæŒ‰ç…§ä¸Šä¸€æ¬¡çš„xæˆ–è€…xpå‘½ä»¤æ‰€ä½¿ç”¨çš„å€¼ã€‚né»˜è®¤ä¸º1ã€‚addr ä¹Ÿæ˜¯ä¸€ä¸ª
</span></span><span class="line"><span class="cl">    å¯é€‰å‚æ•°ï¼Œå¦‚æœä¸æŒ‡å®šï¼Œaddræ˜¯0ï¼Œå¦‚è¿‡å‰é¢ä½¿ç”¨è¿‡xæˆ–è€…xpå‘½ä»¤ï¼ŒæŒ‡å®šäº†n=iï¼Œ
</span></span><span class="line"><span class="cl">    åˆ™å†æ¬¡æ‰§è¡Œæ—¶né»˜è®¤ä¸ºi+1ã€‚
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">setpmem [addr] [size] [val]    è®¾ç½®ç‰©ç†å†…å­˜æŸåœ°å€çš„å†…å®¹ã€‚
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="1å‡†å¤‡">ï¼ˆ1ï¼‰å‡†å¤‡<a hidden class="anchor" aria-hidden="true" href="#1å‡†å¤‡">#</a></h3>
<p>ç¼–è¯‘å¥½ Linux 0.11 åï¼Œé¦–å…ˆé€šè¿‡è¿è¡Œ <code>./dbg-asm</code> å¯åŠ¨è°ƒè¯•å™¨ï¼Œæ­¤æ—¶ Bochs çš„çª—å£å¤„äºé»‘å±çŠ¶æ€</p>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012340288.png" alt="å›¾ç‰‡æè¿°"  />
</p>
<p>è€Œå‘½ä»¤è¡Œçª—å£æ˜¾ç¤ºï¼š</p>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012340294.png" alt="å›¾ç‰‡æè¿°"  />
</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">========================================================================
</span></span><span class="line"><span class="cl">                       Bochs x86 Emulator 2.3.7
</span></span><span class="line"><span class="cl">               Build from CVS snapshot, on June 3, 2008
</span></span><span class="line"><span class="cl">========================================================================
</span></span><span class="line"><span class="cl">00000000000i[     ] reading configuration from ./bochs/bochsrc.bxrc
</span></span><span class="line"><span class="cl">00000000000i[     ] installing x module as the Bochs GUI
</span></span><span class="line"><span class="cl">00000000000i[     ] using log file ./bochsout.txt
</span></span><span class="line"><span class="cl">Next at t=0
</span></span><span class="line"><span class="cl">(0) [0xfffffff0] f000:fff0 (unk. ctxt): jmp far f000:e05b         ; ea5be000f0
</span></span><span class="line"><span class="cl">&lt;bochs:1&gt;_
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>Next at t=0</code> è¡¨ç¤ºä¸‹é¢çš„æŒ‡ä»¤æ˜¯ Bochs å¯åŠ¨åè¦æ‰§è¡Œçš„ç¬¬ä¸€æ¡è½¯ä»¶æŒ‡ä»¤ã€‚</p>
<p>å•æ­¥è·Ÿè¸ªè¿›å»å°±èƒ½çœ‹åˆ° BIOS çš„ä»£ç ã€‚ä¸è¿‡è¿™ä¸æ˜¯æœ¬å®éªŒéœ€è¦çš„ã€‚ç›´æ¥è¾“å…¥å‘½ä»¤ <code>c</code>ï¼Œcontinue ç¨‹åºçš„è¿è¡Œï¼ŒBochs ä¸€å¦‚æ—¢å¾€åœ°å¯åŠ¨äº† Linux 0.11ã€‚</p>
<p>åœ¨ Linux 0.11 ä¸‹è¾“å…¥ï¼ˆæˆ–æ‹·å…¥ï¼‰test.cï¼ˆä»£ç åœ¨æœ¬å®éªŒçš„ç¬¬ 3 å°èŠ‚ä¸­ï¼‰ï¼Œç¼–è¯‘ä¸º testï¼Œè¿è¡Œä¹‹ï¼Œæ‰“å°å¦‚ä¸‹ä¿¡æ¯ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">The logical/virtual address of i is 0x00003004
</span></span></code></pre></td></tr></table>
</div>
</div><p>åªè¦ test ä¸å˜ï¼Œ<code>0x00003004</code> è¿™ä¸ªå€¼åœ¨ä»»ä½•äººçš„æœºå™¨ä¸Šéƒ½æ˜¯ä¸€æ ·çš„ã€‚å³ä½¿åœ¨åŒä¸€ä¸ªæœºå™¨ä¸Šå¤šæ¬¡è¿è¡Œ testï¼Œä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚</p>
<p>test æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œåªä¼šä¸åœå ç”¨ CPUï¼Œä¸ä¼šé€€å‡ºã€‚</p>
<h3 id="2æš‚åœ">ï¼ˆ2ï¼‰æš‚åœ<a hidden class="anchor" aria-hidden="true" href="#2æš‚åœ">#</a></h3>
<p>å½“ test è¿è¡Œçš„æ—¶å€™ï¼Œåœ¨å‘½ä»¤è¡Œçª—å£æŒ‰ <code>Ctrl+c</code>ï¼ŒBochs ä¼šæš‚åœè¿è¡Œï¼Œè¿›å…¥è°ƒè¯•çŠ¶æ€ã€‚ç»å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½ä¼šåœåœ¨ test å†…ï¼Œæ˜¾ç¤ºç±»ä¼¼å¦‚ä¸‹ä¿¡æ¯ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">(0) [0x00fc8031] 000f:00000031 (unk. ctxt): cmp dword ptr ds:0x3004, 0x00000000 ; 833d0430000000
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…¶ä¸­çš„ <code>000f</code> å¦‚æœæ˜¯ <code>0008</code>ï¼Œåˆ™è¯´æ˜ä¸­æ–­åœ¨äº†å†…æ ¸é‡Œã€‚é‚£ä¹ˆå°±è¦ <code>c</code>ï¼Œç„¶åå† <code>ctrl+c</code>ï¼Œç›´åˆ°å˜ä¸º <code>000f</code> ä¸ºæ­¢ã€‚</p>
<p>å¦‚æœæ˜¾ç¤ºçš„ä¸‹ä¸€æ¡æŒ‡ä»¤ä¸æ˜¯ <code>cmp ...</code>ï¼ˆè¿™é‡ŒæŒ‡è¯­å¥ä»¥ <code>cmp</code> å¼€å¤´ï¼‰ï¼Œå°±ç”¨ <code>n</code> å‘½ä»¤å•æ­¥è¿è¡Œå‡ æ­¥ï¼Œç›´åˆ°åœåœ¨ <code>cmp ...</code>ã€‚</p>
<p>ä½¿ç”¨å‘½ä»¤ <code>u /8</code>ï¼Œæ˜¾ç¤ºä»å½“å‰ä½ç½®å¼€å§‹ 8 æ¡æŒ‡ä»¤çš„åæ±‡ç¼–ä»£ç ï¼Œç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012340299.png" alt="å›¾ç‰‡æè¿°"  />
</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">&lt;bochs:3&gt; u /8
</span></span><span class="line"><span class="cl">10000063: (                    ): cmp dword ptr ds:0x3004, 0x00000000 ; 833d0430000000
</span></span><span class="line"><span class="cl">1000006a: (                    ): jz .+0x00000004           ; 7404
</span></span><span class="line"><span class="cl">1000006c: (                    ): jmp .+0xfffffff5          ; ebf5
</span></span><span class="line"><span class="cl">1000006e: (                    ): add byte ptr ds:[eax], al ; 0000
</span></span><span class="line"><span class="cl">10000070: (                    ): xor eax, eax              ; 31c0
</span></span><span class="line"><span class="cl">10000072: (                    ): jmp .+0x00000000          ; eb00
</span></span><span class="line"><span class="cl">10000074: (                    ): leave                     ; c9
</span></span><span class="line"><span class="cl">10000075: (                    ): ret                       ; c3
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™å°±æ˜¯ test.c ä¸­ä» while å¼€å§‹ä¸€ç›´åˆ° return çš„æ±‡ç¼–ä»£ç ã€‚å˜é‡ i ä¿å­˜åœ¨ <code>ds:0x3004</code> è¿™ä¸ªåœ°å€ï¼Œå¹¶ä¸åœåœ°å’Œ 0 è¿›è¡Œæ¯”è¾ƒï¼Œç›´åˆ°å®ƒä¸º 0ï¼Œæ‰ä¼šè·³å‡ºå¾ªç¯ã€‚</p>
<p>ç°åœ¨ï¼Œå¼€å§‹å¯»æ‰¾ <code>ds:0x3004</code> å¯¹åº”çš„ç‰©ç†åœ°å€ã€‚</p>
<h3 id="43-æ®µè¡¨">4.3 æ®µè¡¨<a hidden class="anchor" aria-hidden="true" href="#43-æ®µè¡¨">#</a></h3>
<p><code>ds:0x3004</code> æ˜¯è™šæ‹Ÿåœ°å€ï¼Œds è¡¨æ˜è¿™ä¸ªåœ°å€å±äº ds æ®µã€‚é¦–å…ˆè¦æ‰¾åˆ°æ®µè¡¨ï¼Œç„¶åé€šè¿‡ ds çš„å€¼åœ¨æ®µè¡¨ä¸­æ‰¾åˆ° ds æ®µçš„å…·ä½“ä¿¡æ¯ï¼Œæ‰èƒ½ç»§ç»­è¿›è¡Œåœ°å€ç¿»è¯‘ã€‚</p>
<p>æ¯ä¸ªåœ¨ IA-32 ä¸Šè¿è¡Œçš„åº”ç”¨ç¨‹åºéƒ½æœ‰ä¸€ä¸ªæ®µè¡¨ï¼Œå« LDTï¼Œæ®µçš„ä¿¡æ¯å«æ®µæè¿°ç¬¦ã€‚</p>
<p>LDT åœ¨å“ªé‡Œå‘¢ï¼Ÿldtr å¯„å­˜å™¨æ˜¯çº¿ç´¢çš„èµ·ç‚¹ï¼Œé€šè¿‡å®ƒå¯ä»¥åœ¨ GDTï¼ˆå…¨å±€æè¿°ç¬¦è¡¨ï¼‰ä¸­æ‰¾åˆ° LDT çš„ç‰©ç†åœ°å€ã€‚</p>
<p>ç”¨ <code>sreg</code> å‘½ä»¤ï¼ˆæ˜¯åœ¨è°ƒè¯•çª—å£è¾“å…¥ï¼‰ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">&lt;bochs:4&gt; sreg
</span></span><span class="line"><span class="cl">cs:s=0x000f, dl=0x00000002, dh=0x10c0fa00, valid=1
</span></span><span class="line"><span class="cl">ds:s=0x0017, dl=0x00003fff, dh=0x10c0f300, valid=3
</span></span><span class="line"><span class="cl">ss:s=0x0017, dl=0x00003fff, dh=0x10c0f300, valid=1
</span></span><span class="line"><span class="cl">es:s=0x0017, dl=0x00003fff, dh=0x10c0f300, valid=1
</span></span><span class="line"><span class="cl">fs:s=0x0017, dl=0x00003fff, dh=0x10c0f300, valid=1
</span></span><span class="line"><span class="cl">gs:s=0x0017, dl=0x00003fff, dh=0x10c0f300, valid=1
</span></span><span class="line"><span class="cl">ldtr:s=0x0068, dl=0xa2d00068, dh=0x000082fa, valid=1
</span></span><span class="line"><span class="cl">tr:s=0x0060, dl=0xa2e80068, dh=0x00008bfa, valid=1
</span></span><span class="line"><span class="cl">gdtr:base=0x00005cb8, limit=0x7ff
</span></span><span class="line"><span class="cl">idtr:base=0x000054b8, limit=0x7ff
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹åˆ° ldtr çš„å€¼æ˜¯ <code>0x0068=0000000001101000</code>ï¼ˆäºŒè¿›åˆ¶ï¼‰ï¼Œè¡¨ç¤º LDT è¡¨å­˜æ”¾åœ¨ GDT è¡¨çš„ 1101ï¼ˆäºŒè¿›åˆ¶ï¼‰=13ï¼ˆåè¿›åˆ¶ï¼‰å·ä½ç½®ï¼ˆæ¯ä½æ•°æ®çš„æ„ä¹‰å‚è€ƒåæ–‡å™è¿°çš„æ®µé€‰æ‹©å­ï¼‰ã€‚</p>
<p>è€Œ GDT çš„ä½ç½®å·²ç»ç”± gdtr æ˜ç¡®ç»™å‡ºï¼Œåœ¨ç‰©ç†åœ°å€çš„ <code>0x00005cb8</code>ã€‚</p>
<p>ç”¨ <code>xp /32w 0x00005cb8</code> æŸ¥çœ‹ä»è¯¥åœ°å€å¼€å§‹ï¼Œ32 ä¸ªå­—çš„å†…å®¹ï¼ŒåŠ GDT è¡¨çš„å‰ 16 é¡¹ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">&lt;bochs:5&gt; xp /32w 0x00005cb8
</span></span><span class="line"><span class="cl">[bochs]:
</span></span><span class="line"><span class="cl">0x00005cb8 &lt;bogus+       0&gt;:    0x00000000    0x00000000    0x00000fff    0x00c09a00
</span></span><span class="line"><span class="cl">0x00005cc8 &lt;bogus+      16&gt;:    0x00000fff    0x00c09300    0x00000000    0x00000000
</span></span><span class="line"><span class="cl">0x00005cd8 &lt;bogus+      32&gt;:    0xa4280068    0x00008901    0xa4100068    0x00008201
</span></span><span class="line"><span class="cl">0x00005ce8 &lt;bogus+      48&gt;:    0xf2e80068    0x000089ff    0xf2d00068    0x000082ff
</span></span><span class="line"><span class="cl">0x00005cf8 &lt;bogus+      64&gt;:    0xd2e80068    0x000089ff    0xd2d00068    0x000082ff
</span></span><span class="line"><span class="cl">0x00005d08 &lt;bogus+      80&gt;:    0x12e80068    0x000089fc    0x12d00068    0x000082fc
</span></span><span class="line"><span class="cl">0x00005d18 &lt;bogus+      96&gt;:    0xa2e80068    0x00008bfa    0xa2d00068    0x000082fa
</span></span><span class="line"><span class="cl">0x00005d28 &lt;bogus+     112&gt;:    0xc2e80068    0x000089f8    0xc2d00068    0x000082f8
</span></span></code></pre></td></tr></table>
</div>
</div><p>GDT è¡¨ä¸­çš„æ¯ä¸€é¡¹å  64 ä½ï¼ˆ8 ä¸ªå­—èŠ‚ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æŸ¥æ‰¾çš„é¡¹çš„åœ°å€æ˜¯ <code>0x00005cb8+13*8</code>ã€‚</p>
<p>è¾“å…¥ <code>xp /2w 0x00005cb8+13*8</code>ï¼Œå¾—åˆ°ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">&lt;bochs:6&gt; xp /2w 0x00005cb8+13*8
</span></span><span class="line"><span class="cl">[bochs]:
</span></span><span class="line"><span class="cl">0x00005d20 &lt;bogus+       0&gt;:    0xa2d00068    0x000082fa
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šä¸¤æ­¥çœ‹åˆ°çš„æ•°å€¼å¯èƒ½å’Œè¿™é‡Œç»™å‡ºçš„ç¤ºä¾‹ä¸ä¸€è‡´ï¼Œè¿™æ˜¯å¾ˆæ­£å¸¸çš„ã€‚å¦‚æœæƒ³ç¡®è®¤æ˜¯å¦å‡†ç¡®ï¼Œå°±çœ‹ <code>sreg</code> è¾“å‡ºä¸­ï¼Œldtr æ‰€åœ¨è¡Œé‡Œï¼Œ<code>dl</code> å’Œ <code>dh</code> çš„å€¼ï¼Œå®ƒä»¬æ˜¯ Bochs çš„è°ƒè¯•å™¨è‡ªåŠ¨è®¡ç®—å‡ºçš„ï¼Œä½ å¯»æ‰¾åˆ°çš„å¿…é¡»å’Œå®ƒä»¬ä¸€è‡´ã€‚</p>
<p>â€œ0x<strong>a2d0</strong>0068 0x<strong>00</strong>0082<strong>fa</strong>â€ å°†å…¶ä¸­çš„åŠ ç²—æ•°å­—ç»„åˆä¸ºâ€œ0x00faa2d0â€ï¼Œè¿™å°±æ˜¯ LDT è¡¨çš„ç‰©ç†åœ°å€ï¼ˆä¸ºä»€ä¹ˆè¿™ä¹ˆç»„åˆï¼Œå‚è€ƒåæ–‡ä»‹ç»çš„æ®µæè¿°ç¬¦ï¼‰ã€‚</p>
<p><code>xp /8w 0x00faa2d0</code>ï¼Œå¾—åˆ°ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">&lt;bochs:7&gt; xp /8w 0x00faa2d0
</span></span><span class="line"><span class="cl">[bochs]:
</span></span><span class="line"><span class="cl">0x00faa2d0 &lt;bogus+       0&gt;:    0x00000000    0x00000000    0x00000002    0x10c0fa00
</span></span><span class="line"><span class="cl">0x00faa2e0 &lt;bogus+      16&gt;:    0x00003fff    0x10c0f300    0x00000000    0x00fab000
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™å°±æ˜¯ LDT è¡¨çš„å‰ 4 é¡¹å†…å®¹äº†ã€‚</p>
<h3 id="44-æ®µæè¿°ç¬¦">4.4 æ®µæè¿°ç¬¦<a hidden class="anchor" aria-hidden="true" href="#44-æ®µæè¿°ç¬¦">#</a></h3>
<p>åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œ<code>æ®µå¯„å­˜å™¨</code>æœ‰å¦ä¸€ä¸ªåå­—ï¼Œå«<code>æ®µé€‰æ‹©å­</code>ï¼Œå› ä¸ºå®ƒ<code>ä¿å­˜çš„ä¿¡æ¯</code>ä¸»è¦æ˜¯<code>è¯¥æ®µåœ¨æ®µè¡¨é‡Œç´¢å¼•å€¼</code>ï¼Œç”¨è¿™ä¸ªç´¢å¼•å€¼å¯ä»¥ä»æ®µè¡¨ä¸­â€œé€‰æ‹©â€å‡ºç›¸åº”çš„<code>æ®µæè¿°ç¬¦</code>ã€‚</p>
<p>å…ˆçœ‹çœ‹ ds é€‰æ‹©å­çš„å†…å®¹ï¼Œè¿˜æ˜¯ç”¨ <code>sreg</code> å‘½ä»¤ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">&lt;bochs:8&gt; sreg
</span></span><span class="line"><span class="cl">cs:s=0x000f, dl=0x00000002, dh=0x10c0fa00, valid=1
</span></span><span class="line"><span class="cl">ds:s=0x0017, dl=0x00003fff, dh=0x10c0f300, valid=3
</span></span><span class="line"><span class="cl">ss:s=0x0017, dl=0x00003fff, dh=0x10c0f300, valid=1
</span></span><span class="line"><span class="cl">es:s=0x0017, dl=0x00003fff, dh=0x10c0f300, valid=1
</span></span><span class="line"><span class="cl">fs:s=0x0017, dl=0x00003fff, dh=0x10c0f300, valid=1
</span></span><span class="line"><span class="cl">gs:s=0x0017, dl=0x00003fff, dh=0x10c0f300, valid=1
</span></span><span class="line"><span class="cl">ldtr:s=0x0068, dl=0xa2d00068, dh=0x000082fa, valid=1
</span></span><span class="line"><span class="cl">tr:s=0x0060, dl=0xa2e80068, dh=0x00008bfa, valid=1
</span></span><span class="line"><span class="cl">gdtr:base=0x00005cb8, limit=0x7ff
</span></span><span class="line"><span class="cl">idtr:base=0x000054b8, limit=0x7ff
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹åˆ°ï¼Œds çš„å€¼æ˜¯ <code>0x0017</code>ã€‚æ®µé€‰æ‹©å­æ˜¯ä¸€ä¸ª 16 ä½å¯„å­˜å™¨ï¼Œå®ƒå„ä½çš„å«ä¹‰å¦‚ä¸‹å›¾ï¼š</p>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012340307.bmp" alt="å›¾ç‰‡æè¿°ä¿¡æ¯"  />
</p>
<p>å›¾ 2 æ®µé€‰æ‹©å­çš„ç»“æ„</p>
<p>å…¶ä¸­ RPL æ˜¯è¯·æ±‚ç‰¹æƒçº§ï¼Œå½“è®¿é—®ä¸€ä¸ªæ®µæ—¶ï¼Œå¤„ç†å™¨è¦æ£€æŸ¥ RPL å’Œ CPLï¼ˆæ”¾åœ¨ cs çš„ä½ 0 å’Œä½ 1 ä¸­ï¼Œç”¨æ¥è¡¨ç¤ºå½“å‰ä»£ç çš„ç‰¹æƒçº§ï¼‰ï¼Œå³ä½¿ç¨‹åºæœ‰è¶³å¤Ÿçš„ç‰¹æƒçº§ï¼ˆCPLï¼‰æ¥è®¿é—®ä¸€ä¸ªæ®µï¼Œä½†å¦‚æœ RPLï¼ˆå¦‚æ”¾åœ¨ ds ä¸­ï¼Œè¡¨ç¤ºè¯·æ±‚æ•°æ®æ®µï¼‰çš„ç‰¹æƒçº§ä¸è¶³ï¼Œåˆ™ä»ç„¶ä¸èƒ½è®¿é—®ï¼Œå³å¦‚æœ RPL çš„æ•°å€¼å¤§äº CPLï¼ˆæ•°å€¼è¶Šå¤§ï¼Œæƒé™è¶Šå°ï¼‰ï¼Œåˆ™ç”¨ RPL çš„å€¼è¦†ç›– CPL çš„å€¼ã€‚</p>
<p>è€Œæ®µé€‰æ‹©å­ä¸­çš„ TI æ˜¯è¡¨æŒ‡ç¤ºæ ‡è®°ï¼Œå¦‚æœ TI=0ï¼Œåˆ™è¡¨ç¤ºæ®µæè¿°ç¬¦ï¼ˆæ®µçš„è¯¦ç»†ä¿¡æ¯ï¼‰åœ¨ GDTï¼ˆå…¨å±€æè¿°ç¬¦è¡¨ï¼‰ä¸­ï¼Œå³å» GDT ä¸­å»æŸ¥ï¼›è€Œ TI=1ï¼Œåˆ™å» LDTï¼ˆå±€éƒ¨æè¿°ç¬¦è¡¨ï¼‰ä¸­å»æŸ¥ã€‚</p>
<p>çœ‹çœ‹ä¸Šé¢çš„ dsï¼Œ<code>0x0017=0000000000010111</code>ï¼ˆäºŒè¿›åˆ¶ï¼‰ï¼Œæ‰€ä»¥ RPL=11ï¼Œå¯è§æ˜¯åœ¨æœ€ä½çš„ç‰¹æƒçº§ï¼ˆå› ä¸ºåœ¨åº”ç”¨ç¨‹åºä¸­æ‰§è¡Œï¼‰ï¼ŒTI=1ï¼Œè¡¨ç¤ºæŸ¥æ‰¾ LDT è¡¨ï¼Œç´¢å¼•å€¼ä¸º 10ï¼ˆäºŒè¿›åˆ¶ï¼‰= 2ï¼ˆåè¿›åˆ¶ï¼‰ï¼Œè¡¨ç¤ºæ‰¾ LDT è¡¨ä¸­çš„ç¬¬ 3 ä¸ªæ®µæè¿°ç¬¦ï¼ˆä» 0 å¼€å§‹ç¼–å·ï¼‰ã€‚</p>
<p>LDT å’Œ GDT çš„ç»“æ„ä¸€æ ·ï¼Œæ¯é¡¹å  8 ä¸ªå­—èŠ‚ã€‚æ‰€ä»¥ç¬¬ 3 é¡¹ <code>0x00003fff 0x10c0f300</code>ï¼ˆä¸Šä¸€æ­¥éª¤çš„æœ€åä¸€ä¸ªè¾“å‡ºç»“æœä¸­ï¼‰ å°±æ˜¯æœå¯»å¥½ä¹…çš„ ds çš„æ®µæè¿°ç¬¦äº†ã€‚</p>
<p>ç”¨ <code>sreg</code> è¾“å‡ºä¸­ ds æ‰€åœ¨è¡Œçš„ dl å’Œ dh å€¼å¯ä»¥éªŒè¯æ‰¾åˆ°çš„æè¿°ç¬¦æ˜¯å¦æ­£ç¡®ã€‚</p>
<p>æ¥ä¸‹æ¥çœ‹çœ‹æ®µæè¿°ç¬¦é‡Œé¢æ”¾ç½®çš„æ˜¯ä»€ä¹ˆå†…å®¹ï¼š</p>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012340309.bmp" alt="å›¾ç‰‡æè¿°ä¿¡æ¯"  />
</p>
<p>å›¾ 3 æ®µæè¿°ç¬¦çš„ç»“æ„</p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæ®µæè¿°ç¬¦æ˜¯ä¸€ä¸ª 64 ä½äºŒè¿›åˆ¶çš„æ•°ï¼Œå­˜æ”¾äº†æ®µåŸºå€å’Œæ®µé™é•¿ç­‰é‡è¦çš„æ•°æ®ã€‚å…¶ä¸­ä½ Pï¼ˆPresentï¼‰æ˜¯æ®µæ˜¯å¦å­˜åœ¨çš„æ ‡è®°ï¼›ä½ S ç”¨æ¥è¡¨ç¤ºæ˜¯ç³»ç»Ÿæ®µæè¿°ç¬¦ï¼ˆS=0ï¼‰è¿˜æ˜¯ä»£ç æˆ–æ•°æ®æ®µæè¿°ç¬¦ï¼ˆS=1ï¼‰ï¼›å››ä½ TYPE ç”¨æ¥è¡¨ç¤ºæ®µçš„ç±»å‹ï¼Œå¦‚æ•°æ®æ®µã€ä»£ç æ®µã€å¯è¯»ã€å¯å†™ç­‰ï¼›DPL æ˜¯æ®µçš„æƒé™ï¼Œå’Œ CPLã€RPL å¯¹åº”ä½¿ç”¨ï¼›ä½ G æ˜¯ç²’åº¦ï¼ŒG=0 è¡¨ç¤ºæ®µé™é•¿ä»¥ä½ä¸ºå•ä½ï¼ŒG=1 è¡¨ç¤ºæ®µé™é•¿ä»¥ 4KB ä¸ºå•ä½ï¼›å…¶ä»–å†…å®¹å°±ä¸è¯¦ç»†è§£é‡Šäº†ã€‚</p>
<h3 id="45-æ®µåŸºå€å’Œçº¿æ€§åœ°å€">4.5 æ®µåŸºå€å’Œçº¿æ€§åœ°å€<a hidden class="anchor" aria-hidden="true" href="#45-æ®µåŸºå€å’Œçº¿æ€§åœ°å€">#</a></h3>
<p>è´¹äº†å¾ˆå¤§çš„åŠ²ï¼Œå®é™…ä¸Šæˆ‘ä»¬éœ€è¦çš„åªæœ‰æ®µåŸºå€ä¸€é¡¹æ•°æ®ï¼Œå³æ®µæè¿°ç¬¦ â€œ0x<strong>0000</strong>3fff 0x<strong>10</strong>c0f3<strong>00</strong>â€ ä¸­åŠ ç²—éƒ¨åˆ†ç»„åˆæˆçš„ â€œ0x10000000â€ã€‚è¿™å°±æ˜¯ ds æ®µåœ¨çº¿æ€§åœ°å€ç©ºé—´ä¸­çš„èµ·å§‹åœ°å€ã€‚ç”¨åŒæ ·çš„æ–¹æ³•ä¹Ÿå¯ä»¥ç®—ç®—å…¶å®ƒæ®µçš„åŸºå€ï¼Œéƒ½æ˜¯è¿™ä¸ªæ•°ã€‚</p>
<p>æ®µåŸºå€+æ®µå†…åç§»ï¼Œå°±æ˜¯çº¿æ€§åœ°å€äº†ã€‚æ‰€ä»¥ ds:0x3004 çš„çº¿æ€§åœ°å€å°±æ˜¯ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">0x10000000 + 0x3004 = 0x10003004
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç”¨ <code>calc ds:0x3004</code> å‘½ä»¤å¯ä»¥éªŒè¯è¿™ä¸ªç»“æœã€‚</p>
<h3 id="46-é¡µè¡¨">4.6 é¡µè¡¨<a hidden class="anchor" aria-hidden="true" href="#46-é¡µè¡¨">#</a></h3>
<p>ä»çº¿æ€§åœ°å€è®¡ç®—ç‰©ç†åœ°å€ï¼Œéœ€è¦æŸ¥æ‰¾é¡µè¡¨ã€‚çº¿æ€§åœ°å€å˜æˆç‰©ç†åœ°å€çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<img src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012340562.bmp" alt="å›¾ç‰‡æè¿°ä¿¡æ¯"  /> 
<p>å›¾ 4 é¡µè¡¨å·¥ä½œåŸç†</p>
<p>çº¿æ€§åœ°å€å˜æˆç‰©ç†åœ°å€</p>
<p>é¦–å…ˆéœ€è¦ç®—å‡ºçº¿æ€§åœ°å€ä¸­çš„é¡µç›®å½•å·ã€é¡µè¡¨å·å’Œé¡µå†…åç§»ï¼Œå®ƒä»¬åˆ†åˆ«å¯¹åº”äº† 32 ä½çº¿æ€§åœ°å€çš„ 10 ä½ + 10 ä½ + 12 ä½ï¼Œæ‰€ä»¥==0x10003004 çš„é¡µç›®å½•å·æ˜¯ 64ï¼Œé¡µå· 3ï¼Œé¡µå†…åç§»æ˜¯ 4==ã€‚</p>
<p>IA-32 ä¸‹ï¼Œé¡µç›®å½•è¡¨çš„ä½ç½®ç”± CR3 å¯„å­˜å™¨æŒ‡å¼•ã€‚â€œcregâ€å‘½ä»¤å¯ä»¥çœ‹åˆ°ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">CR0=0x8000001b: PG cd nw ac wp ne ET TS em MP PE
</span></span><span class="line"><span class="cl">CR2=page fault laddr=0x10002f68
</span></span><span class="line"><span class="cl">CR3=0x00000000
</span></span><span class="line"><span class="cl">    PCD=page-level cache disable=0
</span></span><span class="line"><span class="cl">    PWT=page-level writes transparent=0
</span></span><span class="line"><span class="cl">CR4=0x00000000: osxmmexcpt osfxsr pce pge mce pae pse de tsd pvi vme
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¯´æ˜é¡µç›®å½•è¡¨çš„åŸºå€ä¸º 0ã€‚çœ‹çœ‹å…¶å†…å®¹ï¼Œâ€œxp /68w 0â€ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">0x00000000 :    0x00001027    0x00002007    0x00003007    0x00004027
</span></span><span class="line"><span class="cl">0x00000010 :    0x00000000    0x00024764    0x00000000    0x00000000
</span></span><span class="line"><span class="cl">0x00000020 :    0x00000000    0x00000000    0x00000000    0x00000000
</span></span><span class="line"><span class="cl">0x00000030 :    0x00000000    0x00000000    0x00000000    0x00000000
</span></span><span class="line"><span class="cl">0x00000040 :    0x00ffe027    0x00000000    0x00000000    0x00000000
</span></span><span class="line"><span class="cl">0x00000050 :    0x00000000    0x00000000    0x00000000    0x00000000
</span></span><span class="line"><span class="cl">0x00000060 :    0x00000000    0x00000000    0x00000000    0x00000000
</span></span><span class="line"><span class="cl">0x00000070 :    0x00000000    0x00000000    0x00000000    0x00000000
</span></span><span class="line"><span class="cl">0x00000080 :    0x00ff3027    0x00000000    0x00000000    0x00000000
</span></span><span class="line"><span class="cl">0x00000090 :    0x00000000    0x00000000    0x00000000    0x00000000
</span></span><span class="line"><span class="cl">0x000000a0 :    0x00000000    0x00000000    0x00000000    0x00000000
</span></span><span class="line"><span class="cl">0x000000b0 :    0x00000000    0x00000000    0x00000000    0x00ffb027
</span></span><span class="line"><span class="cl">0x000000c0 :    0x00ff6027    0x00000000    0x00000000    0x00000000
</span></span><span class="line"><span class="cl">0x000000d0 :    0x00000000    0x00000000    0x00000000    0x00000000
</span></span><span class="line"><span class="cl">0x000000e0 :    0x00000000    0x00000000    0x00000000    0x00000000
</span></span><span class="line"><span class="cl">0x000000f0 :    0x00000000    0x00000000    0x00000000    0x00ffa027
</span></span><span class="line"><span class="cl">0x00000100 :    0x00faa027    0x00000000    0x00000000    0x00000000
</span></span></code></pre></td></tr></table>
</div>
</div><p>é¡µç›®å½•è¡¨å’Œé¡µè¡¨ä¸­çš„å†…å®¹å¾ˆç®€å•ï¼Œæ˜¯ 1024 ä¸ª 32 ä½ï¼ˆæ­£å¥½æ˜¯ 4Kï¼‰æ•°ã€‚è¿™ 32 ä½ä¸­å‰ 20 ä½æ˜¯ç‰©ç†é¡µæ¡†å·ï¼Œåé¢æ˜¯ä¸€äº›å±æ€§ä¿¡æ¯ï¼ˆå…¶ä¸­æœ€é‡è¦çš„æ˜¯æœ€åä¸€ä½ Pï¼‰ã€‚å…¶ä¸­ç¬¬ 65 ä¸ªé¡µç›®å½•é¡¹å°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„å†…å®¹ï¼Œç”¨â€œxp /w 0+64*4â€æŸ¥çœ‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">0x00000100 :    0x00faa027
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…¶ä¸­çš„ 027 æ˜¯å±æ€§ï¼Œæ˜¾ç„¶ P=1ï¼Œå…¶ä»–å±æ€§å®éªŒè€…è‡ªå·±åˆ†æå§ã€‚é¡µè¡¨æ‰€åœ¨ç‰©ç†é¡µæ¡†å·ä¸º 0x00faaï¼Œå³é¡µè¡¨åœ¨ç‰©ç†å†…å­˜çš„ 0x00faa000 ä½ç½®ã€‚ä»è¯¥ä½ç½®å¼€å§‹æŸ¥æ‰¾ 3 å·é¡µè¡¨é¡¹ï¼Œå¾—åˆ°ï¼ˆxp /w 0x00faa000+3*4ï¼‰ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">0x00faa00c :    0x00fa7067
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…¶ä¸­ 067 æ˜¯å±æ€§ï¼Œæ˜¾ç„¶ P=1ï¼Œåº”è¯¥æ˜¯è¿™æ ·ã€‚</p>
<h3 id="47-ç‰©ç†åœ°å€">4.7 ç‰©ç†åœ°å€<a hidden class="anchor" aria-hidden="true" href="#47-ç‰©ç†åœ°å€">#</a></h3>
<p>æœ€ç»ˆç»“æœé©¬ä¸Šå°±è¦å‡ºç°äº†ï¼</p>
<p>çº¿æ€§åœ°å€ 0x10003004 å¯¹åº”çš„ç‰©ç†é¡µæ¡†å·ä¸º 0x00fa7ï¼Œå’Œé¡µå†…åç§» 0x004 æ¥åˆ°ä¸€èµ·ï¼Œå¾—åˆ° 0x00fa7004ï¼Œè¿™å°±æ˜¯å˜é‡ i çš„ç‰©ç†åœ°å€ã€‚å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹æ³•éªŒè¯ã€‚</p>
<p>ç¬¬ä¸€ç§æ–¹æ³•æ˜¯ç”¨å‘½ä»¤ <code>page 0x10003004</code>ï¼Œå¯ä»¥å¾—åˆ°ä¿¡æ¯ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">linear page 0x10003000 maps to physical page 0x00fa7000
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¬¬äºŒç§æ–¹æ³•æ˜¯ç”¨å‘½ä»¤ <code>xp /w 0x00fa7004</code>ï¼Œå¯ä»¥çœ‹åˆ°ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">0x00fa7004 :    0x12345678
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ä¸ªæ•°å€¼ç¡®å®æ˜¯ test.c ä¸­ i çš„åˆå€¼ã€‚</p>
<p>ç°åœ¨ï¼Œé€šè¿‡ç›´æ¥ä¿®æ”¹å†…å­˜æ¥æ”¹å˜ i çš„å€¼ä¸º 0ï¼Œå‘½ä»¤æ˜¯ï¼š setpmem 0x00fa7004 4 0ï¼Œè¡¨ç¤ºä» 0x00fa7004 åœ°å€å¼€å§‹çš„ 4 ä¸ªå­—èŠ‚éƒ½è®¾ä¸º 0ã€‚ç„¶åå†ç”¨â€œcâ€å‘½ä»¤ç»§ç»­ Bochs çš„è¿è¡Œï¼Œå¯ä»¥çœ‹åˆ° test é€€å‡ºäº†ï¼Œè¯´æ˜ i çš„ä¿®æ”¹æˆåŠŸäº†ï¼Œæ­¤é¡¹å®éªŒç»“æŸã€‚</p>
<h3 id="48-åœ¨-linux-011-ä¸­å®ç°å…±äº«å†…å­˜">4.8 åœ¨ Linux 0.11 ä¸­å®ç°å…±äº«å†…å­˜<a hidden class="anchor" aria-hidden="true" href="#48-åœ¨-linux-011-ä¸­å®ç°å…±äº«å†…å­˜">#</a></h3>
<h4 id="1linux-ä¸­çš„å…±äº«å†…å­˜">ï¼ˆ1ï¼‰Linux ä¸­çš„å…±äº«å†…å­˜<a hidden class="anchor" aria-hidden="true" href="#1linux-ä¸­çš„å…±äº«å†…å­˜">#</a></h4>
<p>Linux æ”¯æŒä¸¤ç§æ–¹å¼çš„å…±äº«å†…å­˜ã€‚ä¸€ç§æ–¹å¼æ˜¯ <code>shm_open()</code>ã€<code>mmap()</code> å’Œ <code>shm_unlink()</code> çš„ç»„åˆï¼›å¦ä¸€ç§æ–¹å¼æ˜¯ <code>shmget()</code>ã€<code>shmat()</code> å’Œ <code>shmdt()</code> çš„ç»„åˆã€‚æœ¬å®éªŒå»ºè®®ä½¿ç”¨åä¸€ç§æ–¹å¼ã€‚</p>
<p>è¿™äº›ç³»ç»Ÿè°ƒç”¨çš„è¯¦æƒ…ï¼Œè¯·æŸ¥é˜… man åŠç›¸å…³èµ„æ–™ã€‚</p>
<p>ç‰¹åˆ«æé†’ï¼šæ²¡æœ‰çˆ¶å­å…³ç³»çš„è¿›ç¨‹ä¹‹é—´è¿›è¡Œå…±äº«å†…å­˜ï¼Œ<code>shmget()</code> çš„ç¬¬ä¸€ä¸ªå‚æ•° key ä¸è¦ç”¨ <code>IPC_PRIVATE</code>ï¼Œå¦åˆ™æ— æ³•å…±äº«ã€‚ç”¨ä»€ä¹ˆæ•°å­—å¯è§†å¿ƒæƒ…è€Œå®šã€‚</p>
<h4 id="2è·å¾—ç©ºé—²ç‰©ç†é¡µé¢">ï¼ˆ2ï¼‰è·å¾—ç©ºé—²ç‰©ç†é¡µé¢<a hidden class="anchor" aria-hidden="true" href="#2è·å¾—ç©ºé—²ç‰©ç†é¡µé¢">#</a></h4>
<p>å®éªŒè€…éœ€è¦è€ƒè™‘å¦‚ä½•å®ç°é¡µé¢å…±äº«ã€‚é¦–å…ˆçœ‹ä¸€ä¸‹ Linux 0.11 å¦‚ä½•æ“ä½œé¡µé¢ï¼Œå¦‚ä½•ç®¡ç†è¿›ç¨‹åœ°å€ç©ºé—´ã€‚</p>
<p>åœ¨ <code>kernel/fork.c</code> æ–‡ä»¶ä¸­æœ‰ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">copy_process</span><span class="p">(</span><span class="err">â€¦</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="p">)</span> <span class="nf">get_free_page</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">//    â€¦â€¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å‡½æ•° <code>get_free_page()</code> ç”¨æ¥è·å¾—ä¸€ä¸ªç©ºé—²ç‰©ç†é¡µé¢ï¼Œåœ¨ <code>mm/memory.c</code> æ–‡ä»¶ä¸­ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">get_free_page</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__res</span> <span class="k">asm</span><span class="p">(</span><span class="s">&#34;ax&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__asm__</span><span class="p">(</span><span class="s">&#34;std ; repne ; scasb</span><span class="se">\n\t</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;jne 1f</span><span class="se">\n\t</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;movb $1,1(%%edi)</span><span class="se">\n\t</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// é¡µé¢æ•°*4KB=ç›¸å¯¹é¡µé¢èµ·å§‹åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="s">&#34;sall $12,%%ecx</span><span class="se">\n\t</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// åœ¨åŠ ä¸Šä½ç«¯çš„å†…å­˜åœ°å€ï¼Œå¾—åˆ°çš„æ˜¯ç‰©ç†èµ·å§‹åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="s">&#34;addl %2,%%ecx</span><span class="se">\n\t</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;movl %%ecx,%%edx</span><span class="se">\n\t</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;movl $1024,%%ecx</span><span class="se">\n\t</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;leal 4092(%%edx),%%edi</span><span class="se">\n\t</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;rep ; stosl</span><span class="se">\n\t</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//edxèµ‹ç»™eaxï¼Œeaxè¿”å›äº†ç‰©ç†èµ·å§‹åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="s">&#34;movl %%edx,%%eax</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;1:&#34;</span> <span class="o">:</span><span class="s">&#34;=a&#34;</span> <span class="p">(</span><span class="n">__res</span><span class="p">)</span> <span class="o">:</span><span class="s">&#34;0&#34;</span> <span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="s">&#34;i&#34;</span> <span class="p">(</span><span class="n">LOW_MEM</span><span class="p">),</span><span class="s">&#34;c&#34;</span> <span class="p">(</span><span class="n">PAGING_PAGES</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;D&#34;</span> <span class="p">(</span><span class="n">mem_map</span><span class="o">+</span><span class="n">PAGING_PAGES</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">:</span><span class="s">&#34;di&#34;</span><span class="p">,</span><span class="s">&#34;cx&#34;</span><span class="p">,</span><span class="s">&#34;dx&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">__res</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mem_map</span> <span class="p">[</span> <span class="n">PAGING_PAGES</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ˜¾ç„¶ <code>get_free_page</code> å‡½æ•°å°±æ˜¯åœ¨ <code>mem_map</code> ä½å›¾ä¸­å¯»æ‰¾å€¼ä¸º 0 çš„é¡¹ï¼ˆç©ºé—²é¡µé¢ï¼‰ï¼Œè¯¥å‡½æ•°è¿”å›çš„æ˜¯è¯¥é¡µé¢çš„èµ·å§‹ç‰©ç†åœ°å€ã€‚</p>
<h4 id="3åœ°å€æ˜ å°„">ï¼ˆ3ï¼‰åœ°å€æ˜ å°„<a hidden class="anchor" aria-hidden="true" href="#3åœ°å€æ˜ å°„">#</a></h4>
<p>æœ‰äº†ç©ºé—²çš„ç‰©ç†é¡µé¢ï¼Œæ¥ä¸‹æ¥éœ€è¦å®Œæˆçº¿æ€§åœ°å€å’Œç‰©ç†é¡µé¢çš„æ˜ å°„ï¼ŒLinux 0.11 ä¸­ä¹Ÿæœ‰è¿™æ ·çš„ä»£ç ï¼Œçœ‹çœ‹ <code>mm/memory.c</code> ä¸­çš„ <code>do_no_page(unsigned long address)</code>ï¼Œè¯¥å‡½æ•°ç”¨æ¥å¤„ç†çº¿æ€§åœ°å€ address å¯¹åº”çš„ç‰©ç†é¡µé¢æ— æ•ˆçš„æƒ…å†µï¼ˆå³ç¼ºé¡µä¸­æ–­ï¼‰ï¼Œ<code>do_no_page</code> å‡½æ•°ä¸­è°ƒç”¨ä¸€ä¸ªé‡è¦çš„å‡½æ•° <code>get_empty_page(address)</code>ï¼Œå…¶ä¸­æœ‰ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// å‡½æ•° get_empty_page(address)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="o">=</span><span class="nf">get_free_page</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">// å»ºç«‹çº¿æ€§åœ°å€å’Œç‰©ç†åœ°å€çš„æ˜ å°„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">put_page</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ˜¾ç„¶è¿™ä¸¤æ¡è¯­å¥å°±ç”¨æ¥è·å¾—ç©ºé—²ç‰©ç†é¡µé¢ï¼Œç„¶åå¡«å†™çº¿æ€§åœ°å€ address å¯¹åº”çš„é¡µç›®å½•å’Œé¡µè¡¨ã€‚</p>
<h4 id="4å¯»æ‰¾ç©ºé—²çš„è™šæ‹Ÿåœ°å€ç©ºé—´">ï¼ˆ4ï¼‰å¯»æ‰¾ç©ºé—²çš„è™šæ‹Ÿåœ°å€ç©ºé—´<a hidden class="anchor" aria-hidden="true" href="#4å¯»æ‰¾ç©ºé—²çš„è™šæ‹Ÿåœ°å€ç©ºé—´">#</a></h4>
<p>æœ‰äº†ç©ºé—²ç‰©ç†é¡µé¢ï¼Œä¹Ÿæœ‰äº†å»ºç«‹çº¿æ€§åœ°å€å’Œç‰©ç†é¡µé¢çš„æ˜ å°„ï¼Œä½†è¦å®Œæˆæœ¬å®éªŒè¿˜éœ€è¦èƒ½è·å¾—ä¸€æ®µç©ºé—²çš„è™šæ‹Ÿåœ°å€ç©ºé—²ã€‚</p>
<p>è¦ä»æ•°æ®æ®µä¸­åˆ’å‡ºä¸€æ®µç©ºé—´ï¼Œé¦–å…ˆéœ€è¦äº†è§£è¿›ç¨‹æ•°æ®æ®µç©ºé—´çš„åˆ†å¸ƒï¼Œè€Œè¿™ä¸ªåˆ†å¸ƒæ˜¾ç„¶æ˜¯ç”± exec ç³»ç»Ÿè°ƒç”¨å†³å®šçš„ï¼Œæ‰€ä»¥è¦è¯¦ç»†çœ‹ä¸€çœ‹ exec çš„æ ¸å¿ƒä»£ç ï¼Œ<code>do_execve</code>ï¼ˆåœ¨æ–‡ä»¶ <code>fs/exec.c</code> ä¸­ï¼‰ã€‚</p>
<p>åœ¨å‡½æ•° <code>do_execve()</code> ä¸­ï¼Œä¿®æ”¹æ•°æ®æ®µï¼ˆå½“ç„¶æ˜¯ä¿®æ”¹ LDTï¼‰çš„åœ°æ–¹æ˜¯ <code>change_ldt</code>ï¼Œå‡½æ•° change_ldt å®ç°å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">change_ldt</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">text_size</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span> <span class="n">page</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/*å…¶ä¸­text_sizeæ˜¯ä»£ç æ®µé•¿åº¦ï¼Œä»å¯æ‰§è¡Œæ–‡ä»¶çš„å¤´éƒ¨å–å‡ºï¼Œpageä¸ºå‚æ•°å’Œç¯å¢ƒé¡µ*/</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">code_limit</span><span class="p">,</span><span class="n">data_limit</span><span class="p">,</span><span class="n">code_base</span><span class="p">,</span><span class="n">data_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">code_limit</span> <span class="o">=</span> <span class="n">text_size</span><span class="o">+</span><span class="n">PAGE_SIZE</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">code_limit</span> <span class="o">&amp;=</span> <span class="mh">0xFFFFF000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//code_limitä¸ºä»£ç æ®µé™é•¿=text_sizeå¯¹åº”çš„é¡µæ•°ï¼ˆå‘ä¸Šå–æ•´ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">data_limit</span> <span class="o">=</span> <span class="mh">0x4000000</span><span class="p">;</span> <span class="c1">//æ•°æ®æ®µé™é•¿64MB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">code_base</span> <span class="o">=</span> <span class="nf">get_base</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">ldt</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="n">data_base</span> <span class="o">=</span> <span class="n">code_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æ•°æ®æ®µåŸºå€ = ä»£ç æ®µåŸºå€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">set_base</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">ldt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">code_base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">set_limit</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">ldt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">code_limit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">set_base</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">ldt</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">data_base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">set_limit</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">ldt</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">data_limit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__asm__</span><span class="p">(</span><span class="s">&#34;pushl $0x17</span><span class="se">\n\t</span><span class="s">pop %%fs&#34;</span><span class="o">::</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ä»æ•°æ®æ®µçš„æœ«å°¾å¼€å§‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">data_base</span> <span class="o">+=</span> <span class="n">data_limit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å‘å‰å¤„ç†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">MAX_ARG_PAGES</span><span class="o">-</span><span class="mi">1</span> <span class="p">;</span> <span class="n">i</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ä¸€æ¬¡å¤„ç†ä¸€é¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">data_base</span> <span class="o">-=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å»ºç«‹çº¿æ€§åœ°å€åˆ°ç‰©ç†é¡µçš„æ˜ å°„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="nf">put_page</span><span class="p">(</span><span class="n">page</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">data_base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è¿”å›æ®µç•Œé™
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">data_limit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»”ç»†åˆ†æè¿‡å‡½æ•° <code>change_ldt</code>ï¼Œæƒ³å¿…å®éªŒè€…å·²ç»çŸ¥é“è¯¥å¦‚ä½•ä»æ•°æ®æ®µä¸­æ‰¾åˆ°ä¸€é¡µç©ºé—²çš„çº¿æ€§åœ°å€ã€‚ã€Šæ³¨é‡Šã€‹ä¸­çš„å›¾ 13-6 ä¹Ÿèƒ½ç»™ä½ å¾ˆå¤§å¸®åŠ©ã€‚</p>
<h3 id="49-åœ¨åŒä¸€ç»ˆç«¯ä¸­åŒæ—¶è¿è¡Œä¸¤ä¸ªç¨‹åº">4.9 åœ¨åŒä¸€ç»ˆç«¯ä¸­åŒæ—¶è¿è¡Œä¸¤ä¸ªç¨‹åº<a hidden class="anchor" aria-hidden="true" href="#49-åœ¨åŒä¸€ç»ˆç«¯ä¸­åŒæ—¶è¿è¡Œä¸¤ä¸ªç¨‹åº">#</a></h3>
<p>Linux çš„ shell æœ‰åå°è¿è¡Œç¨‹åºçš„åŠŸèƒ½ã€‚åªè¦åœ¨å‘½ä»¤çš„æœ€åè¾“å…¥ä¸€ä¸ª <code>&amp;</code>ï¼Œå‘½ä»¤å°±ä¼šè¿›å…¥åå°è¿è¡Œï¼Œå‰å°é©¬ä¸Šå›åˆ°æç¤ºç¬¦ï¼Œè¿›è€Œèƒ½è¿è¡Œä¸‹ä¸€ä¸ªå‘½ä»¤ï¼Œä¾‹å¦‚ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo ./producer <span class="p">&amp;</span>
</span></span><span class="line"><span class="cl">$ sudo ./consumer
</span></span></code></pre></td></tr></table>
</div>
</div><p>å½“è¿è¡Œ <code>./consumer</code> çš„æ—¶å€™ï¼Œproducer æ­£åœ¨åå°è¿è¡Œã€‚</p>
<h2 id="5å®éªŒæ­¥éª¤">5.å®éªŒæ­¥éª¤<a hidden class="anchor" aria-hidden="true" href="#5å®éªŒæ­¥éª¤">#</a></h2>
<h3 id="1åˆ›å»ºtestc">1.åˆ›å»ºtest.c<a hidden class="anchor" aria-hidden="true" href="#1åˆ›å»ºtestc">#</a></h3>
<p>æŒ‚è½½hdcæ–‡ä»¶ç³»ç»Ÿï¼Œç„¶ååœ¨usr/rootç›®å½•å†…å¢åŠ test.cæ–‡ä»¶ç”¨äºæµ‹è¯•åœ°å€æ˜ å°„ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mh">0x12345678</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;The logical/virtual address of i is 0x%08x&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»£ç æ·»åŠ è¿‡ç¨‹æˆªå›¾å¦‚ä¸‹ï¼š
<img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012340579.png" alt="img"  />
</p>
<h3 id="2å¯»æ‰¾ç‰©ç†åœ°å€">2.å¯»æ‰¾ç‰©ç†åœ°å€<a hidden class="anchor" aria-hidden="true" href="#2å¯»æ‰¾ç‰©ç†åœ°å€">#</a></h3>
<p>é¦–å…ˆè¿›å…¥Linux-0.11ç›®å½•å†…makeç¼–è¯‘ç³»ç»Ÿï¼Œç„¶åå›é€€è‡³oslabç›®å½•å†…è¿è¡Œç³»ç»Ÿï¼Œå†ä½¿ç”¨ä¸‹è¿°å‘½ä»¤ç¼–è¯‘è¿è¡Œtest.cæ–‡ä»¶</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gcc -o test test.c
</span></span><span class="line"><span class="cl">./test
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œæ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
<img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012340608.png" alt="img"  />
</p>
<p>æ­¤æ—¶ä¼šè¿›å…¥åœ¨test.cå†…çš„whileæ­»å¾ªç¯ï¼Œç„¶åctrl+cæš‚åœbochsã€‚
æ­¤æ—¶éœ€è¦è®©Linux-0.11çš„testè·³å‡ºæ­»å¾ªç¯ï¼Œæ‰€ä»¥éœ€è¦æ‰¾åˆ°é€»è¾‘åœ°å€ds:0X00003004å¯¹åº”çš„ç‰©ç†åœ°å€ï¼Œå°†å®ƒçš„å†…å®¹æ›´æ”¹ä¸º0ã€‚
åœ¨ç»ˆç«¯ä¸­è¾“å…¥sregï¼Œå¾—åˆ°gdtrçš„åŸºå€å€¼ä¸º0x00005cb8ï¼Œldträ¸º0x0068å³0000 0000 0110 1000 bï¼Œå¯çŸ¥ç´¢å¼•ä¸º1101bå³13ï¼ŒTIä½ä¸º0ï¼Œå³GDTä¸­çš„ç¬¬13é¡¹ä¸ºLDTçš„æ®µæè¿°ç¬¦ã€‚
<img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012340626.png" alt="img"  />
</p>
<p>è¾“å…¥<code>xp /2w 0x00005cb8+13*8</code>å¾—åˆ°LDTæ®µæè¿°ç¬¦ï¼Œå¯ä»¥å¾—åˆ°LDTçš„åŸºå€ä¸º<code>0x00f9a2d0</code>
dsæ®µé€‰æ‹©å­ä¸º<code>0x0017 =&gt; 0000 0000 0001 0111 b</code>ï¼Œå¯çŸ¥ç´¢å¼•ä¸º10bå³2ï¼ŒTIä½ä¸º1ï¼Œå³LDTä¸­çš„ç¬¬2é¡¹ä¸ºdsçš„æ®µæè¿°ç¬¦ï¼Œè¾“å…¥<code>xp/2w 0x00f9a2d0+2*8</code>å¾—åˆ°dsæ®µæè¿°ç¬¦ï¼Œå¯ä»¥çŸ¥é“dsçš„åŸºå€ä¸º<code>0x10000000</code>ï¼Œæ‰€ä»¥0x3004å¯¹åº”çš„çº¿æ€§åœ°å€ä¸º<code>0x10000000+0x3004=0x10003004</code>ã€‚è¾“å…¥<code>xp /w 64*4</code>è·å–é¡µç›®å½•é¡¹ï¼Œå¯çŸ¥é¡µè¡¨åŸºåœ°å€ä¸º<code>0x00fa6000</code>ã€‚
è¾“å…¥<code>xp /w 0x00fa6000+3*4</code>å¾—åˆ°ç‰©ç†åŸºå€ä¸º<code>0xfa5000</code>ã€‚
è¾“å…¥<code>xp /w 0xfa5000+4</code>å¾—åˆ°çš„å†…å®¹å³test.cä¸­çš„å˜é‡çš„å€¼ï¼Œè¾“å…¥<code>setpmem 0xfa5004 4 0</code>å°†å®ƒè®¾ä¸º0ã€‚
<img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012340871.png" alt="img"  />
</p>
<p>ç„¶ååœ¨ç»ˆç«¯å†…è¾“å…¥cç»§ç»­è®©ç³»ç»Ÿè¿è¡Œï¼Œå‘ç°testè€Œå·²è·³å‡ºå¾ªç¯ã€‚</p>
<h3 id="3æ·»åŠ ç³»ç»Ÿè°ƒç”¨">3.æ·»åŠ ç³»ç»Ÿè°ƒç”¨<a hidden class="anchor" aria-hidden="true" href="#3æ·»åŠ ç³»ç»Ÿè°ƒç”¨">#</a></h3>
<p>åœ¨unistd.hä¸­å¢åŠ ä¸‹é¢çš„ä»£ç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define SHM_SIZE 64
</span></span></span><span class="line"><span class="cl"><span class="cp"></span> 
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">shm_ds</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">page</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="n">shm_ds</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">sys_shmget</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">key</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="o">*</span> <span class="nf">sys_shmat</span><span class="p">(</span><span class="kt">int</span> <span class="n">shmid</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012340076.png" alt="img"  />
</p>
<p>ç„¶åå¢åŠ ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#define __NR_shmget 76
</span></span></span><span class="line"><span class="cl"><span class="cp">#define __NR_shmat 77
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012340101.png" alt="img"  />
</p>
<h3 id="4ä¿®æ”¹syshæ–‡ä»¶">4.ä¿®æ”¹sys.hæ–‡ä»¶<a hidden class="anchor" aria-hidden="true" href="#4ä¿®æ”¹syshæ–‡ä»¶">#</a></h3>
<p>åœ¨æ­¤æ–‡ä»¶ä¸­å¢åŠ å‡½æ•°å£°æ˜ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">int</span> <span class="n">sys_shmget</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">int</span> <span class="n">sys_shmat</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012340536.png" alt="img"  />
</p>
<p>åœ¨system_call.sä¸­æŠŠnr_system_callsæ”¹ä¸º78</p>
<h3 id="5å¢åŠ shmc">5.å¢åŠ shm.c<a hidden class="anchor" aria-hidden="true" href="#5å¢åŠ shmc">#</a></h3>
<p>shm.cçš„ä½ç½®åœ¨kernelç›®å½•ä¸‹
ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define __LIBRARY__
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/kernel.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/sched.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/mm.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">shm_ds</span> <span class="n">shm_list</span><span class="p">[</span><span class="n">SHM_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">}};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">sys_shmget</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">page</span> <span class="o">=</span> <span class="nf">get_free_page</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printk</span><span class="p">(</span><span class="s">&#34;shmget get memory&#39;s address is 0x%08x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">page</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">SHM_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">shm_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">key</span> <span class="o">==</span> <span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">SHM_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">shm_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">key</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="n">shm_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">shm_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">shm_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="o">*</span> <span class="nf">sys_shmat</span><span class="p">(</span><span class="kt">int</span> <span class="n">shmid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data_base</span><span class="p">,</span> <span class="n">brk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">shmid</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">SHM_SIZE</span> <span class="o">&lt;=</span> <span class="n">shmid</span> <span class="o">||</span> <span class="n">shm_list</span><span class="p">[</span><span class="n">shmid</span><span class="p">].</span><span class="n">page</span><span class="o">==</span><span class="mi">0</span> <span class="o">||</span> <span class="n">shm_list</span><span class="p">[</span><span class="n">shmid</span><span class="p">].</span><span class="n">key</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">data_base</span> <span class="o">=</span> <span class="nf">get_base</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">ldt</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printk</span><span class="p">(</span><span class="s">&#34;current&#39;s data_base = 0x%08x,new page = 0x%08x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">data_base</span><span class="p">,</span><span class="n">shm_list</span><span class="p">[</span><span class="n">shmid</span><span class="p">].</span><span class="n">page</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">brk</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">brk</span> <span class="o">+</span> <span class="n">data_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">current</span><span class="o">-&gt;</span><span class="n">brk</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nf">put_page</span><span class="p">(</span><span class="n">shm_list</span><span class="p">[</span><span class="n">shmid</span><span class="p">].</span><span class="n">page</span><span class="p">,</span> <span class="n">brk</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">brk</span> <span class="o">-</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åä¿®æ”¹Kernelä¸‹çš„Makefileæ–‡ä»¶</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">### Dependencies:</span>
</span></span><span class="line"><span class="cl">sem.s sem.o: sem.c ../include/linux/sem.h ../include/linux/kernel.h <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>../include/unistd.h
</span></span><span class="line"><span class="cl">shm.s shm.o:shm.c ../include/unistd.h ../include/linux/kernel.h ../include/linux/sched.h ../include/linux/mm.h ../include/errno.h
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¿®æ”¹æˆªå›¾å¦‚ä¸‹ï¼š
<img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012340559.png" alt="img"  />
</p>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012340591.png" alt="img"  />
</p>
<h3 id="6ç¼–å†™æ¶ˆè´¹è€…å’Œç”Ÿäº§è€…ç¨‹åº">6.ç¼–å†™æ¶ˆè´¹è€…å’Œç”Ÿäº§è€…ç¨‹åº<a hidden class="anchor" aria-hidden="true" href="#6ç¼–å†™æ¶ˆè´¹è€…å’Œç”Ÿäº§è€…ç¨‹åº">#</a></h3>
<p>åœ¨hdcçš„rootç›®å½•ä¸‹å¢åŠ producer.cå’Œconsumer.cæ–‡ä»¶ï¼Œè¿™ä¸¤ä¸ªæ–‡ä»¶çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/*producer*/</span> 
</span></span><span class="line"><span class="cl"><span class="cp">#define __LIBRARY__
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/kernel.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/sem.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="nf">_syscall2</span><span class="p">(</span><span class="kt">sem_t</span> <span class="o">*</span><span class="p">,</span><span class="n">sem_open</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="kt">int</span><span class="p">,</span><span class="n">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">_syscall1</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="n">sem_post</span><span class="p">,</span><span class="kt">sem_t</span> <span class="o">*</span><span class="p">,</span><span class="n">sem</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">_syscall1</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="n">sem_wait</span><span class="p">,</span><span class="kt">sem_t</span> <span class="o">*</span><span class="p">,</span><span class="n">sem</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">_syscall1</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">shmat</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">shmid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">_syscall2</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">shmget</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define PRODUCE_NUM 200
</span></span></span><span class="line"><span class="cl"><span class="cp">#define BUFFER_SIZE 10
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHM_KEY 2018
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">sem_t</span> <span class="o">*</span><span class="n">Empty</span><span class="p">,</span><span class="o">*</span><span class="n">Full</span><span class="p">,</span><span class="o">*</span><span class="n">Mutex</span><span class="p">;</span>    
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">shm_id</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Empty</span> <span class="o">=</span> <span class="nf">sem_open</span><span class="p">(</span><span class="s">&#34;Empty&#34;</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Full</span> <span class="o">=</span> <span class="nf">sem_open</span><span class="p">(</span><span class="s">&#34;Full&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Mutex</span> <span class="o">=</span> <span class="nf">sem_open</span><span class="p">(</span><span class="s">&#34;Mutex&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">((</span><span class="n">shm_id</span> <span class="o">=</span> <span class="nf">shmget</span><span class="p">(</span><span class="n">SHM_KEY</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;shmget failed!&#34;</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span> <span class="p">)</span><span class="nf">shmat</span><span class="p">(</span><span class="n">shm_id</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;shmat error!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">PRODUCE_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sem_wait</span><span class="p">(</span><span class="n">Empty</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sem_wait</span><span class="p">(</span><span class="n">Mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">p</span><span class="p">[</span><span class="n">location</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">sem_post</span><span class="p">(</span><span class="n">Mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sem_post</span><span class="p">(</span><span class="n">Full</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">location</span>  <span class="o">=</span> <span class="p">(</span><span class="n">location</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">BUFFER_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>    
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>consumer.cä»£ç å¦‚ä¸‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/*consumer*/</span> 
</span></span><span class="line"><span class="cl"><span class="cp">#define __LIBRARY__
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/kernel.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/sem.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="nf">_syscall2</span><span class="p">(</span><span class="kt">sem_t</span> <span class="o">*</span><span class="p">,</span><span class="n">sem_open</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="kt">int</span><span class="p">,</span><span class="n">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">_syscall1</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="n">sem_post</span><span class="p">,</span><span class="kt">sem_t</span> <span class="o">*</span><span class="p">,</span><span class="n">sem</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">_syscall1</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="n">sem_wait</span><span class="p">,</span><span class="kt">sem_t</span> <span class="o">*</span><span class="p">,</span><span class="n">sem</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">_syscall1</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="n">sem_unlink</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">,</span><span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">_syscall1</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">shmat</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">shmid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">_syscall2</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">shmget</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define PRODUCE_NUM 200
</span></span></span><span class="line"><span class="cl"><span class="cp">#define BUFFER_SIZE 10
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SHM_KEY 2018
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">sem_t</span> <span class="o">*</span><span class="n">Empty</span><span class="p">,</span><span class="o">*</span><span class="n">Full</span><span class="p">,</span><span class="o">*</span><span class="n">Mutex</span><span class="p">;</span>    
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">shm_id</span><span class="p">,</span><span class="n">location</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Empty</span> <span class="o">=</span> <span class="nf">sem_open</span><span class="p">(</span><span class="s">&#34;Empty&#34;</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Full</span> <span class="o">=</span> <span class="nf">sem_open</span><span class="p">(</span><span class="s">&#34;Full&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Mutex</span> <span class="o">=</span> <span class="nf">sem_open</span><span class="p">(</span><span class="s">&#34;Mutex&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">((</span><span class="n">shm_id</span> <span class="o">=</span> <span class="nf">shmget</span><span class="p">(</span><span class="n">SHM_KEY</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;shmget failed!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span> <span class="p">)</span><span class="nf">shmat</span><span class="p">(</span><span class="n">shm_id</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;link error!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sem_wait</span><span class="p">(</span><span class="n">Full</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sem_wait</span><span class="p">(</span><span class="n">Mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;pid %d:</span><span class="se">\t</span><span class="s">consumer consumes item %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">getpid</span><span class="p">(),</span> <span class="n">p</span><span class="p">[</span><span class="n">location</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">sem_post</span><span class="p">(</span><span class="n">Mutex</span><span class="p">);</span>     
</span></span><span class="line"><span class="cl">        <span class="nf">sem_post</span><span class="p">(</span><span class="n">Empty</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">location</span>  <span class="o">=</span> <span class="p">(</span><span class="n">location</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">BUFFER_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="o">++</span><span class="n">used</span> <span class="o">==</span> <span class="n">PRODUCE_NUM</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">sem_unlink</span><span class="p">(</span><span class="s">&#34;Mutex&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">sem_unlink</span><span class="p">(</span><span class="s">&#34;Full&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">sem_unlink</span><span class="p">(</span><span class="s">&#34;Empty&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>    
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="7è¿è¡ŒéªŒè¯">7.è¿è¡ŒéªŒè¯<a hidden class="anchor" aria-hidden="true" href="#7è¿è¡ŒéªŒè¯">#</a></h3>
<p>è¿è¡Œbochsï¼Œè¾“å…¥ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gcc -o pro producer.c
</span></span><span class="line"><span class="cl">gcc -o con consumer.c
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¼–è¯‘è¿™ä¸¤ä¸ªç¨‹åºï¼Œ
ç„¶åè¾“å…¥</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pro &gt; proOutput &amp;
</span></span><span class="line"><span class="cl">con &gt; conOutput &amp;
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ¥åŒæ—¶è¿è¡Œè¿™ä¸¤ä¸ªç¨‹åºï¼Œå¹¶å°†ç»“æœä¿å­˜åˆ°proOutputå’ŒconOutputä¸­ã€‚
æœ€åè¾“å…¥sync,ç»“æœå¦‚ä¸‹
<img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012340620.jpg" alt="img"  />
</p>
<p>å…³é—­linux-0.11å›åˆ°ubuntç»ˆç«¯ï¼Œè¾“å…¥sudo less hdc/usr/root/conOutputæŸ¥çœ‹ç»“æœå¦‚ä¸‹ï¼š
<img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012340699.png" alt="image-20230801234052652"  />
</p>


  </div>

  <footer class="post-footer">
    
<nav class="paginav">
  <a class="prev" href="https://chance7bin.github.io/posts/basic/asm/%E7%AC%AC5%E7%AB%A0-bx%E5%92%8Cloop%E6%8C%87%E4%BB%A4/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>ç¬¬5ç«  [BX]å’ŒloopæŒ‡ä»¤</span>
  </a>
  <a class="next" href="https://chance7bin.github.io/posts/basic/asm/%E7%AC%AC6%E7%AB%A0-%E5%8C%85%E5%90%AB%E5%A4%9A%E4%B8%AA%E6%AE%B5%E7%9A%84%E7%A8%8B%E5%BA%8F/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>ç¬¬6ç«  åŒ…å«å¤šä¸ªæ®µçš„ç¨‹åº</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://chance7bin.github.io/">Binb&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerHTML = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
