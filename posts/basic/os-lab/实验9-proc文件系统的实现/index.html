<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>å®éªŒ9 procæ–‡ä»¶ç³»ç»Ÿçš„å®ç° | Binb&#39;s Blog</title>
<meta name="keywords" content="æ“ä½œç³»ç»Ÿ, å®éªŒ">
<meta name="description" content="1.å®éªŒç›®çš„ æŒæ¡è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿçš„å®ç°åŸç†ï¼› å®è·µæ–‡ä»¶ã€ç›®å½•ã€æ–‡ä»¶ç³»ç»Ÿç­‰æ¦‚å¿µã€‚ 2.å®éªŒå†…å®¹ /procæ–‡ä»¶ç³»ç»Ÿæ˜¯äº†è§£ç³»ç»Ÿä¿¡æ¯çš„ä¸€ä¸ªçª—å£ï¼Œå®ƒä¸æ˜¯æ™®é€šæ„">
<meta name="author" content="chance7bin">
<link rel="canonical" href="https://chance7bin.github.io/posts/basic/os-lab/%E5%AE%9E%E9%AA%8C9-proc%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%AE%9E%E7%8E%B0/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.be81eec981a615a87a88f121642d7eebde74d033438693944db2fd6b827284ff.css" integrity="" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.acb54fd32bbc1982428b8850317e45d076b95012730a5936667e6bc21777692a.js" integrity=""
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<link rel="icon" type="image/png" sizes="16x16" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<link rel="icon" type="image/png" sizes="32x32" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<link rel="apple-touch-icon" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<link rel="mask-icon" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="å®éªŒ9 procæ–‡ä»¶ç³»ç»Ÿçš„å®ç°" />
<meta property="og:description" content="1.å®éªŒç›®çš„ æŒæ¡è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿçš„å®ç°åŸç†ï¼› å®è·µæ–‡ä»¶ã€ç›®å½•ã€æ–‡ä»¶ç³»ç»Ÿç­‰æ¦‚å¿µã€‚ 2.å®éªŒå†…å®¹ /procæ–‡ä»¶ç³»ç»Ÿæ˜¯äº†è§£ç³»ç»Ÿä¿¡æ¯çš„ä¸€ä¸ªçª—å£ï¼Œå®ƒä¸æ˜¯æ™®é€šæ„" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://chance7bin.github.io/posts/basic/os-lab/%E5%AE%9E%E9%AA%8C9-proc%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%AE%9E%E7%8E%B0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-26T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-05-26T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="å®éªŒ9 procæ–‡ä»¶ç³»ç»Ÿçš„å®ç°"/>
<meta name="twitter:description" content="1.å®éªŒç›®çš„ æŒæ¡è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿçš„å®ç°åŸç†ï¼› å®è·µæ–‡ä»¶ã€ç›®å½•ã€æ–‡ä»¶ç³»ç»Ÿç­‰æ¦‚å¿µã€‚ 2.å®éªŒå†…å®¹ /procæ–‡ä»¶ç³»ç»Ÿæ˜¯äº†è§£ç³»ç»Ÿä¿¡æ¯çš„ä¸€ä¸ªçª—å£ï¼Œå®ƒä¸æ˜¯æ™®é€šæ„"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "ğŸ“š æ–‡ç« ",
      "item": "https://chance7bin.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ“• è®¡ç®—æœºåŸºç¡€",
      "item": "https://chance7bin.github.io/posts/basic/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "hit-oslab",
      "item": "https://chance7bin.github.io/posts/basic/os-lab/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "å®éªŒ9 procæ–‡ä»¶ç³»ç»Ÿçš„å®ç°",
      "item": "https://chance7bin.github.io/posts/basic/os-lab/%E5%AE%9E%E9%AA%8C9-proc%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%AE%9E%E7%8E%B0/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "å®éªŒ9 procæ–‡ä»¶ç³»ç»Ÿçš„å®ç°",
  "name": "å®éªŒ9 procæ–‡ä»¶ç³»ç»Ÿçš„å®ç°",
  "description": "1.å®éªŒç›®çš„ æŒæ¡è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿçš„å®ç°åŸç†ï¼› å®è·µæ–‡ä»¶ã€ç›®å½•ã€æ–‡ä»¶ç³»ç»Ÿç­‰æ¦‚å¿µã€‚ 2.å®éªŒå†…å®¹ /procæ–‡ä»¶ç³»ç»Ÿæ˜¯äº†è§£ç³»ç»Ÿä¿¡æ¯çš„ä¸€ä¸ªçª—å£ï¼Œå®ƒä¸æ˜¯æ™®é€šæ„",
  "keywords": [
    "æ“ä½œç³»ç»Ÿ", "å®éªŒ"
  ],
  "articleBody": "1.å®éªŒç›®çš„ æŒæ¡è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿçš„å®ç°åŸç†ï¼› å®è·µæ–‡ä»¶ã€ç›®å½•ã€æ–‡ä»¶ç³»ç»Ÿç­‰æ¦‚å¿µã€‚ 2.å®éªŒå†…å®¹ /procæ–‡ä»¶ç³»ç»Ÿæ˜¯äº†è§£ç³»ç»Ÿä¿¡æ¯çš„ä¸€ä¸ªçª—å£ï¼Œå®ƒä¸æ˜¯æ™®é€šæ„ä¹‰ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒæ˜¯ä¸€ä¸ªåˆ°è¿è¡Œä¸­è¿›ç¨‹åœ°å€ç©ºé—´çš„è®¿é—®æ¥å£ã€‚é€šè¿‡/procï¼Œå¯ä»¥ç”¨æ ‡å‡†Unixç³»ç»Ÿè°ƒç”¨(æ¯”å¦‚open()ã€read()ã€write()ç­‰ç­‰)è®¿é—®ï¼Œå°±è±¡è®¿é—®ä¸€ä¸ªæ™®é€šæ–‡ä»¶ä¸€æ ·ã€‚äº‹å®ä¸Šï¼Œè®¸å¤šæ“ä½œç³»ç»Ÿä¸­çš„pså‘½ä»¤æ­£æ˜¯åˆ©ç”¨/procæ¥è·å–è¿›ç¨‹çŠ¶æ€çš„ã€‚å› æ­¤/procæ–‡ä»¶ç³»ç»Ÿæ˜¯è™šæ‹Ÿçš„æ–‡ä»¶ç³»ç»Ÿï¼Œçœ‹ä¼¼å­˜åœ¨çš„æ–‡ä»¶å®é™…å¹¶æ²¡æœ‰åœ¨ç¡¬ç›˜ä¸Šã€‚å…¶å®ï¼Œ/procæ˜¯ä½ äº†è§£è‡ªå·±ç³»ç»Ÿçš„ä¸€ä¸ªçª—å£ï¼Œå®ƒå®é™…å­˜åœ¨äºå†…å­˜ã€‚\nåœ¨ Linux 0.11 ä¸Šå®ç° procfsï¼ˆproc æ–‡ä»¶ç³»ç»Ÿï¼‰å†…çš„ psinfo ç»“ç‚¹ã€‚å½“è¯»å–æ­¤ç»“ç‚¹çš„å†…å®¹æ—¶ï¼Œå¯å¾—åˆ°ç³»ç»Ÿå½“å‰æ‰€æœ‰è¿›ç¨‹çš„çŠ¶æ€ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œç”¨ cat å‘½ä»¤æ˜¾ç¤º /proc/psinfo çš„å†…å®¹ï¼Œå¯å¾—åˆ°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 $ cat /proc/psinfo pid state father counter start_time 0 1 -1 0 0 1 1 0 28 1 4 1 1 1 73 3 1 1 27 63 6 0 4 12 817 $ cat /proc/hdinfo total_blocks: 62000; free_blocks: 39037; used_blocks: 22963; ... procfs åŠå…¶ç»“ç‚¹è¦åœ¨å†…æ ¸å¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»ºã€‚\nç›¸å…³åŠŸèƒ½å®ç°åœ¨ fs/proc.c æ–‡ä»¶å†…ã€‚\n3.å®éªŒæŠ¥å‘Š å®Œæˆå®éªŒåï¼Œåœ¨å®éªŒæŠ¥å‘Šä¸­å›ç­”å¦‚ä¸‹é—®é¢˜ï¼š\nå¦‚æœè¦æ±‚ä½ åœ¨ psinfo ä¹‹å¤–å†å®ç°å¦ä¸€ä¸ªç»“ç‚¹ï¼Œå…·ä½“å†…å®¹è‡ªé€‰ï¼Œé‚£ä¹ˆä½ ä¼šå®ç°ä¸€ä¸ªç»™å‡ºä»€ä¹ˆä¿¡æ¯çš„ç»“ç‚¹ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ ä¸€æ¬¡ read() æœªå¿…èƒ½è¯»å‡ºæ‰€æœ‰çš„æ•°æ®ï¼Œéœ€è¦ç»§ç»­ read()ï¼Œç›´åˆ°æŠŠæ•°æ®è¯»ç©ºä¸ºæ­¢ã€‚è€Œæ•°æ¬¡ read() ä¹‹é—´ï¼Œè¿›ç¨‹çš„çŠ¶æ€å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚ä½ è®¤ä¸ºåå‡ æ¬¡ read() ä¼ ç»™ç”¨æˆ·çš„æ•°æ®ï¼Œåº”è¯¥æ˜¯å˜åŒ–åçš„ï¼Œè¿˜æ˜¯å˜åŒ–å‰çš„ï¼Ÿ å¦‚æœæ˜¯å˜åŒ–åçš„ï¼Œé‚£ä¹ˆç”¨æˆ·å¾—åˆ°çš„æ•°æ®è¡”æ¥éƒ¨åˆ†æ˜¯å¦ä¼šæœ‰æ··ä¹±ï¼Ÿå¦‚ä½•é˜²æ­¢æ··ä¹±ï¼Ÿ å¦‚æœæ˜¯å˜åŒ–å‰çš„ï¼Œé‚£ä¹ˆè¯¥åœ¨ä»€ä¹ˆæ ·çš„æƒ…å†µä¸‹æ›´æ–° psinfo çš„å†…å®¹ï¼Ÿ 4.å®éªŒæç¤º æœ¬å®éªŒæ–‡æ¡£åœ¨ Linux 0.11 ä¸Šå®ç° procfsï¼ˆproc æ–‡ä»¶ç³»ç»Ÿï¼‰å†…çš„ psinfo ç»“ç‚¹ã€‚å½“è¯»å– psinfo ç»“ç‚¹çš„å†…å®¹æ—¶ï¼Œå¯å¾—åˆ°ç³»ç»Ÿå½“å‰æ‰€æœ‰è¿›ç¨‹çš„çŠ¶æ€ä¿¡æ¯ã€‚\næœ€åè¿˜ç»™å‡ºæ¥ hdinfo ç»“ç‚¹å®ç°çš„æç¤ºã€‚\n4.1 procfs ç®€ä»‹ æ­£å¼çš„ Linux å†…æ ¸å®ç°äº† procfsï¼Œå®ƒæ˜¯ä¸€ä¸ªè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œé€šå¸¸è¢« mountï¼ˆæŒ‚è½½ï¼‰ åˆ° /proc ç›®å½•ä¸Šï¼Œé€šè¿‡è™šæ‹Ÿæ–‡ä»¶å’Œè™šæ‹Ÿç›®å½•çš„æ–¹å¼æä¾›è®¿é—®ç³»ç»Ÿå‚æ•°çš„æœºä¼šï¼Œæ‰€ä»¥æœ‰äººç§°å®ƒä¸º â€œäº†è§£ç³»ç»Ÿä¿¡æ¯çš„ä¸€ä¸ªçª—å£â€ã€‚\nè¿™äº›è™šæ‹Ÿçš„æ–‡ä»¶å’Œç›®å½•å¹¶æ²¡æœ‰çœŸå®åœ°å­˜åœ¨åœ¨ç£ç›˜ä¸Šï¼Œè€Œæ˜¯å†…æ ¸ä¸­å„ç§æ•°æ®çš„ä¸€ç§ç›´è§‚è¡¨ç¤ºã€‚è™½ç„¶æ˜¯è™šæ‹Ÿçš„ï¼Œä½†å®ƒä»¬éƒ½å¯ä»¥é€šè¿‡æ ‡å‡†çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆopen()ã€read() ç­‰ï¼‰è®¿é—®ã€‚\nä¾‹å¦‚ï¼Œ/proc/meminfo ä¸­åŒ…å«å†…å­˜ä½¿ç”¨çš„ä¿¡æ¯ï¼Œå¯ä»¥ç”¨ cat å‘½ä»¤æ˜¾ç¤ºå…¶å†…å®¹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 $ cat /proc/meminfo MemTotal: 384780 kB MemFree: 13636 kB Buffers: 13928 kB Cached: 101680 kB SwapCached: 132 kB Active: 207764 kB Inactive: 45720 kB SwapTotal: 329324 kB SwapFree: 329192 kB Dirty: 0 kB Writeback: 0 kB â€¦â€¦ å…¶å®ï¼ŒLinux çš„å¾ˆå¤šç³»ç»Ÿå‘½ä»¤å°±æ˜¯é€šè¿‡è¯»å– /proc å®ç°çš„ã€‚ä¾‹å¦‚ uname -a çš„éƒ¨åˆ†ä¿¡æ¯å°±æ¥è‡ª /proc/versionï¼Œè€Œ uptime çš„éƒ¨åˆ†ä¿¡æ¯æ¥è‡ª /proc/uptime å’Œ /proc/loadavgã€‚\nå…³äº procfs æ›´å¤šçš„ä¿¡æ¯è¯·è®¿é—®ï¼šhttp://en.wikipedia.org/wiki/Procfs\n4.2 åŸºæœ¬æ€è·¯ Linux æ˜¯é€šè¿‡æ–‡ä»¶ç³»ç»Ÿæ¥å£å®ç° procfsï¼Œå¹¶åœ¨å¯åŠ¨æ—¶è‡ªåŠ¨å°†å…¶ mount åˆ° /proc ç›®å½•ä¸Šã€‚\næ­¤ç›®å½•ä¸‹çš„æ‰€æœ‰å†…å®¹éƒ½æ˜¯éšç€ç³»ç»Ÿçš„è¿è¡Œè‡ªåŠ¨å»ºç«‹ã€åˆ é™¤å’Œæ›´æ–°çš„ï¼Œè€Œä¸”å®ƒä»¬å®Œå…¨å­˜åœ¨äºå†…å­˜ä¸­ï¼Œä¸å ç”¨ä»»ä½•å¤–å­˜ç©ºé—´ã€‚\nLinux 0.11 è¿˜æ²¡æœ‰å®ç°è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œä¹Ÿå°±æ˜¯ï¼Œè¿˜æ²¡æœ‰æä¾›å¢åŠ æ–°æ–‡ä»¶ç³»ç»Ÿæ”¯æŒçš„æ¥å£ã€‚æ‰€ä»¥æœ¬å®éªŒåªèƒ½åœ¨ç°æœ‰æ–‡ä»¶ç³»ç»Ÿçš„åŸºç¡€ä¸Šï¼Œé€šè¿‡æ‰“è¡¥ä¸çš„æ–¹å¼æ¨¡æ‹Ÿä¸€ä¸ª procfsã€‚\nLinux 0.11 ä½¿ç”¨çš„æ˜¯ Minix çš„æ–‡ä»¶ç³»ç»Ÿï¼Œè¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„åŸºäº inode çš„æ–‡ä»¶ç³»ç»Ÿï¼Œã€Šæ³¨é‡Šã€‹ä¸€ä¹¦å¯¹å®ƒæœ‰è¯¦ç»†æè¿°ã€‚å®ƒçš„æ¯ä¸ªæ–‡ä»¶éƒ½è¦å¯¹åº”è‡³å°‘ä¸€ä¸ª inodeï¼Œè€Œ inode ä¸­è®°å½•ç€æ–‡ä»¶çš„å„ç§å±æ€§ï¼ŒåŒ…æ‹¬æ–‡ä»¶ç±»å‹ã€‚æ–‡ä»¶ç±»å‹æœ‰æ™®é€šæ–‡ä»¶ã€ç›®å½•ã€å­—ç¬¦è®¾å¤‡æ–‡ä»¶å’Œå—è®¾å¤‡æ–‡ä»¶ç­‰ã€‚åœ¨å†…æ ¸ä¸­ï¼Œæ¯ç§ç±»å‹çš„æ–‡ä»¶éƒ½æœ‰ä¸åŒçš„å¤„ç†å‡½æ•°ä¸ä¹‹å¯¹åº”ã€‚æˆ‘ä»¬å¯ä»¥å¢åŠ ä¸€ç§æ–°çš„æ–‡ä»¶ç±»å‹â€”â€”proc æ–‡ä»¶ï¼Œå¹¶åœ¨ç›¸åº”çš„å¤„ç†å‡½æ•°å†…å®ç° procfs è¦å®ç°çš„åŠŸèƒ½ã€‚\n4.3 å¢åŠ æ–°æ–‡ä»¶ç±»å‹ åœ¨ include/sys/stat.h æ–‡ä»¶ä¸­å®šä¹‰äº†å‡ ç§æ–‡ä»¶ç±»å‹å’Œç›¸åº”çš„æµ‹è¯•å®ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 #define S_IFMT 00170000 // æ™®é€šæ–‡ä»¶ #define S_IFREG 0100000 // å—è®¾å¤‡ #define S_IFBLK 0060000 // ç›®å½• #define S_IFDIR 0040000 // å­—ç¬¦è®¾å¤‡ #define S_IFCHR 0020000 #define S_IFIFO 0010000 //â€¦â€¦ // æµ‹è¯• m æ˜¯å¦æ˜¯æ™®é€šæ–‡ä»¶ #define S_ISREG(m) (((m) \u0026 S_IFMT) == S_IFREG) // æµ‹è¯• m æ˜¯å¦æ˜¯ç›®å½• #define S_ISDIR(m) (((m) \u0026 S_IFMT) == S_IFDIR) // æµ‹è¯• m æ˜¯å¦æ˜¯å­—ç¬¦è®¾å¤‡ #define S_ISCHR(m) (((m) \u0026 S_IFMT) == S_IFCHR) // æµ‹è¯• m æ˜¯å¦æ˜¯å—è®¾å¤‡ #define S_ISBLK(m) (((m) \u0026 S_IFMT) == S_IFBLK) #define S_ISFIFO(m) (((m) \u0026 S_IFMT) == S_IFIFO) å¢åŠ æ–°çš„ç±»å‹çš„æ–¹æ³•åˆ†ä¸¤æ­¥ï¼š\nï¼ˆ1ï¼‰å®šä¹‰ä¸€ä¸ªç±»å‹å® S_IFPROCï¼Œå…¶å€¼åº”åœ¨ 0010000 åˆ° 0100000 ä¹‹é—´ï¼Œä½†åå››ä½å…«è¿›åˆ¶æ•°å¿…é¡»æ˜¯ 0ï¼ˆè¿™æ˜¯ S_IFMT çš„é™åˆ¶ï¼Œåˆ†ææµ‹è¯•å®å¯çŸ¥åŸå› ï¼‰ï¼Œè€Œä¸”ä¸èƒ½å’Œå·²æœ‰çš„ä»»æ„ä¸€ä¸ª S_IFXXX ç›¸åŒï¼› ï¼ˆ2ï¼‰å®šä¹‰ä¸€ä¸ªæµ‹è¯•å® S_ISPROC(m)ï¼Œå½¢å¼ä»¿ç…§å…¶å®ƒçš„ S_ISXXX(m) æ³¨æ„ï¼ŒC è¯­è¨€ä¸­ä»¥ â€œ0â€ ç›´æ¥æ¥æ•°å­—çš„å¸¸æ•°æ˜¯å…«è¿›åˆ¶æ•°ã€‚\n4.4 è®© mknod() æ”¯æŒæ–°çš„æ–‡ä»¶ç±»å‹ psinfo ç»“ç‚¹è¦é€šè¿‡ mknod() ç³»ç»Ÿè°ƒç”¨å»ºç«‹ï¼Œæ‰€ä»¥è¦è®©å®ƒæ”¯æŒæ–°çš„æ–‡ä»¶ç±»å‹ã€‚\nç›´æ¥ä¿®æ”¹ fs/namei.c æ–‡ä»¶ä¸­çš„ sys_mknod() å‡½æ•°ä¸­çš„ä¸€è¡Œä»£ç ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 if (S_ISBLK(mode) || S_ISCHR(mode) || S_ISPROC(mode)) inode-\u003ei_zone[0] = dev; // æ–‡ä»¶ç³»ç»Ÿåˆå§‹åŒ– å†…æ ¸åˆå§‹åŒ–çš„å…¨éƒ¨å·¥ä½œæ˜¯åœ¨ main() ä¸­å®Œæˆï¼Œè€Œ main() åœ¨æœ€åä»å†…æ ¸æ€åˆ‡æ¢åˆ°ç”¨æˆ·æ€ï¼Œå¹¶è°ƒç”¨ init()ã€‚\ninit() åšçš„ç¬¬ä¸€ä»¶äº‹æƒ…å°±æ˜¯æŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿï¼š\n1 2 3 4 5 6 void init(void) { // â€¦â€¦ setup((void *) \u0026drive_info); // â€¦â€¦ } procfs çš„åˆå§‹åŒ–å·¥ä½œåº”è¯¥åœ¨æ ¹æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ä¹‹åå¼€å§‹ã€‚å®ƒåŒ…æ‹¬ä¸¤ä¸ªæ­¥éª¤ï¼š\nï¼ˆ1ï¼‰å»ºç«‹ /proc ç›®å½•ï¼›å»ºç«‹ /proc ç›®å½•ä¸‹çš„å„ä¸ªç»“ç‚¹ã€‚æœ¬å®éªŒåªå»ºç«‹ /proc/psinfoã€‚ ï¼ˆ2ï¼‰å»ºç«‹ç›®å½•å’Œç»“ç‚¹åˆ†åˆ«éœ€è¦è°ƒç”¨ mkdir() å’Œ mknod() ç³»ç»Ÿè°ƒç”¨ã€‚å› ä¸ºåˆå§‹åŒ–æ—¶å·²ç»åœ¨ç”¨æˆ·æ€ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥è°ƒç”¨ sys_mkdir() å’Œ sys_mknod()ã€‚å¿…é¡»åœ¨åˆå§‹åŒ–ä»£ç æ‰€åœ¨æ–‡ä»¶ä¸­å®ç°è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨çš„ç”¨æˆ·æ€æ¥å£ï¼Œå³ APIï¼š 1 2 3 4 5 6 #ifndef __LIBRARY__ #define __LIBRARY__ #endif _syscall2(int,mkdir,const char*,name,mode_t,mode) _syscall3(int,mknod,const char*,filename,mode_t,mode,dev_t,dev) mkdir() æ—¶ mode å‚æ•°çš„å€¼å¯ä»¥æ˜¯ â€œ0755â€ï¼ˆå¯¹åº” rwxr-xr-xï¼‰ï¼Œè¡¨ç¤ºåªå…è®¸ root ç”¨æˆ·æ”¹å†™æ­¤ç›®å½•ï¼Œå…¶å®ƒäººåªèƒ½è¿›å…¥å’Œè¯»å–æ­¤ç›®å½•ã€‚\nprocfs æ˜¯ä¸€ä¸ªåªè¯»æ–‡ä»¶ç³»ç»Ÿï¼Œæ‰€ä»¥ç”¨ mknod() å»ºç«‹ psinfo ç»“ç‚¹æ—¶ï¼Œå¿…é¡»é€šè¿‡ mode å‚æ•°å°†å…¶è®¾ä¸ºåªè¯»ã€‚å»ºè®®ä½¿ç”¨ S_IFPROC|0444 åšä¸º mode å€¼ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª proc æ–‡ä»¶ï¼Œæƒé™ä¸º 0444ï¼ˆrâ€“râ€“râ€“ï¼‰ï¼Œå¯¹æ‰€æœ‰ç”¨æˆ·åªè¯»ã€‚\nmknod() çš„ç¬¬ä¸‰ä¸ªå‚æ•° dev ç”¨æ¥è¯´æ˜ç»“ç‚¹æ‰€ä»£è¡¨çš„è®¾å¤‡ç¼–å·ã€‚å¯¹äº procfs æ¥è¯´ï¼Œæ­¤ç¼–å·å¯ä»¥å®Œå…¨è‡ªå®šä¹‰ã€‚proc æ–‡ä»¶çš„å¤„ç†å‡½æ•°å°†é€šè¿‡è¿™ä¸ªç¼–å·å†³å®šå¯¹åº”æ–‡ä»¶åŒ…å«çš„ä¿¡æ¯æ˜¯ä»€ä¹ˆã€‚ä¾‹å¦‚ï¼Œå¯ä»¥æŠŠ 0 å¯¹åº” psinfoï¼Œ1 å¯¹åº” meminfoï¼Œ2 å¯¹åº” cpuinfoã€‚\nå¦‚æ­¤é¡¹å·¥ä½œå®Œæˆå¾—æ²¡æœ‰é—®é¢˜ï¼Œé‚£ä¹ˆç¼–è¯‘ã€è¿è¡Œ 0.11 å†…æ ¸åï¼Œç”¨ ll /proc å¯ä»¥çœ‹åˆ°ï¼š\n1 2 3 # ll /proc total 0 ?r--r--r-- 1 root root 0 ??? ?? ???? psinfo æ­¤æ—¶å¯ä»¥è¯•ç€è¯»ä¸€ä¸‹æ­¤æ–‡ä»¶ï¼š\n1 2 3 # cat /proc/psinfo (Read)inode-\u003ei_mode=XXX444 cat: /proc/psinfo: EINVAL inode-\u003ei_mode å°±æ˜¯é€šè¿‡ mknod() è®¾ç½®çš„ modeã€‚ä¿¡æ¯ä¸­çš„ XXX å’Œä½ è®¾ç½®çš„ S_IFPROC æœ‰å…³ã€‚é€šè¿‡æ­¤å€¼å¯ä»¥äº†è§£ mknod() å·¥ä½œæ˜¯å¦æ­£å¸¸ã€‚è¿™äº›ä¿¡æ¯è¯´æ˜å†…æ ¸åœ¨å¯¹ psinfo è¿›è¡Œè¯»æ“ä½œæ—¶ä¸èƒ½æ­£ç¡®å¤„ç†ï¼Œå‘ cat è¿”å›äº† EINVAL é”™è¯¯ã€‚å› ä¸ºè¿˜æ²¡æœ‰å®ç°å¤„ç†å‡½æ•°ï¼Œæ‰€ä»¥è¿™æ˜¯å¾ˆæ­£å¸¸çš„ã€‚\nè¿™äº›ä¿¡æ¯è‡³å°‘è¯´æ˜ï¼Œpsinfo è¢«æ­£ç¡® open() äº†ã€‚æ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦å¯¹ sys_open() åŠ¨ä»»ä½•æ‰‹è„šï¼Œå”¯ä¸€è¦æ‰“è¡¥ä¸çš„ï¼Œæ˜¯ sys_read()ã€‚\n4.5 è®© proc æ–‡ä»¶å¯è¯» open() æ²¡æœ‰å˜åŒ–ï¼Œé‚£ä¹ˆéœ€è¦ä¿®æ”¹çš„å°±æ˜¯ sys_read() äº†ã€‚\né¦–å…ˆåˆ†æ sys_readï¼ˆåœ¨æ–‡ä»¶ fs/read_write.c ä¸­ï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 int sys_read(unsigned int fd,char * buf,int count) { struct file * file; struct m_inode * inode; // â€¦â€¦ inode = file-\u003ef_inode; if (inode-\u003ei_pipe) return (file-\u003ef_mode\u00261)?read_pipe(inode,buf,count):-EIO; if (S_ISCHR(inode-\u003ei_mode)) return rw_char(READ,inode-\u003ei_zone[0],buf,count,\u0026file-\u003ef_pos); if (S_ISBLK(inode-\u003ei_mode)) return block_read(inode-\u003ei_zone[0],\u0026file-\u003ef_pos,buf,count); if (S_ISDIR(inode-\u003ei_mode) || S_ISREG(inode-\u003ei_mode)) { if (count+file-\u003ef_pos \u003e inode-\u003ei_size) count = inode-\u003ei_size - file-\u003ef_pos; if (count\u003c=0) return 0; return file_read(inode,file,buf,count); } printk(\"(Read)inode-\u003ei_mode=%06o\\n\\r\",inode-\u003ei_mode); //è¿™æ¡ä¿¡æ¯å¾ˆé¢å–„å§ï¼Ÿ return -EINVAL; } æ˜¾ç„¶ï¼Œè¦åœ¨è¿™é‡Œä¸€ç¾¤ if çš„æ’æ¯”ä¸­ï¼ŒåŠ ä¸Š S_IFPROC() çš„åˆ†æ”¯ï¼Œè¿›å…¥å¯¹ proc æ–‡ä»¶çš„å¤„ç†å‡½æ•°ã€‚éœ€è¦ä¼ ç»™å¤„ç†å‡½æ•°çš„å‚æ•°åŒ…æ‹¬ï¼š\ninode-\u003ei_zone[0]ï¼Œè¿™å°±æ˜¯ mknod() æ—¶æŒ‡å®šçš„ dev â€”â€”è®¾å¤‡ç¼–å· bufï¼ŒæŒ‡å‘ç”¨æˆ·ç©ºé—´ï¼Œå°±æ˜¯ read() çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œç”¨æ¥æ¥æ”¶æ•°æ® countï¼Œå°±æ˜¯ read() çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œè¯´æ˜ buf æŒ‡å‘çš„ç¼“å†²åŒºå¤§å° \u0026file-\u003ef_posï¼Œf_pos æ˜¯ä¸Šä¸€æ¬¡è¯»æ–‡ä»¶ç»“æŸæ—¶â€œæ–‡ä»¶ä½ç½®æŒ‡é’ˆâ€çš„æŒ‡å‘ã€‚è¿™é‡Œå¿…é¡»ä¼ æŒ‡é’ˆï¼Œå› ä¸ºå¤„ç†å‡½æ•°éœ€è¦æ ¹æ®ä¼ ç»™ buf çš„æ•°æ®é‡ä¿®æ”¹ f_pos çš„å€¼ã€‚ 4.6 proc æ–‡ä»¶çš„å¤„ç†å‡½æ•° proc æ–‡ä»¶çš„å¤„ç†å‡½æ•°çš„åŠŸèƒ½æ˜¯æ ¹æ®è®¾å¤‡ç¼–å·ï¼ŒæŠŠä¸åŒçš„å†…å®¹å†™å…¥åˆ°ç”¨æˆ·ç©ºé—´çš„ bufã€‚å†™å…¥çš„æ•°æ®è¦ä» f_pos æŒ‡å‘çš„ä½ç½®å¼€å§‹ï¼Œæ¯æ¬¡æœ€å¤šå†™ count ä¸ªå­—èŠ‚ï¼Œå¹¶æ ¹æ®å®é™…å†™å…¥çš„å­—èŠ‚æ•°è°ƒæ•´ f_pos çš„å€¼ï¼Œæœ€åè¿”å›å®é™…å†™å…¥çš„å­—èŠ‚æ•°ã€‚å½“è®¾å¤‡ç¼–å·è¡¨æ˜è¦è¯»çš„æ˜¯ psinfo çš„å†…å®¹æ—¶ï¼Œå°±è¦æŒ‰ç…§ psinfo çš„å½¢å¼ç»„ç»‡æ•°æ®ã€‚\nå®ç°æ­¤å‡½æ•°å¯èƒ½è¦ç”¨åˆ°å¦‚ä¸‹å‡ ä¸ªå‡½æ•°ï¼š\nmalloc() å‡½æ•° free() å‡½æ•° åŒ…å« linux/kernel.h å¤´æ–‡ä»¶åï¼Œå°±å¯ä»¥ä½¿ç”¨ malloc() å’Œ free() å‡½æ•°ã€‚å®ƒä»¬æ˜¯å¯ä»¥è¢«æ ¸å¿ƒæ€ä»£ç è°ƒç”¨çš„ï¼Œå”¯ä¸€çš„é™åˆ¶æ˜¯ä¸€æ¬¡ç”³è¯·çš„å†…å­˜å¤§å°ä¸èƒ½è¶…è¿‡ä¸€ä¸ªé¡µé¢ã€‚\n4.7 å®ç° sprintf() å‡½æ•° Linux 0.11 æ²¡æœ‰ sprintf()ï¼Œå¯ä»¥å‚è€ƒ printf() è‡ªå·±å®ç°ä¸€ä¸ªã€‚\nå¯ä»¥å€Ÿé‰´å¦‚ä¸‹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 #include //â€¦â€¦ int sprintf(char *buf, const char *fmt, ...) { va_list args; int i; va_start(args, fmt); i=vsprintf(buf, fmt, args); va_end(args); return i; } 4.8 cat å‘½ä»¤çš„å®ç° cat æ˜¯ Linux ä¸‹çš„ä¸€ä¸ªå¸¸ç”¨å‘½ä»¤ï¼ŒåŠŸèƒ½æ˜¯å°†æ–‡ä»¶çš„å†…å®¹æ‰“å°åˆ°æ ‡å‡†è¾“å‡ºã€‚\nå®ƒæ ¸å¿ƒå®ç°å¤§ä½“å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 #include #include int main(int argc, char* argv[]) { char buf[513] = {'\\0'}; int nread; int fd = open(argv[1], O_RDONLY, 0); while(nread = read(fd, buf, 512)) { buf[nread] = '\\0'; puts(buf); } return 0; } 4.9 psinfo çš„å†…å®¹ è¿›ç¨‹çš„ä¿¡æ¯å°±æ¥æºäºå†…æ ¸å…¨å±€ç»“æ„æ•°ç»„ struct task_struct * task[NR_TASKS] ä¸­ï¼Œå…·ä½“è¯»å–ç»†èŠ‚å¯å‚ç…§ sched.c ä¸­çš„å‡½æ•° schedule()ã€‚\nå¯ä»¥å€Ÿé‰´ä¸€ä¸‹ä»£ç ï¼š\n1 2 3 4 for(p = \u0026LAST_TASK ; p \u003e \u0026FIRST_TASK ; --p) if (*p) (*p)-\u003ecounter = ((*p)-\u003ecounter \u003e\u003e 1)+...; 4.10 hdinfo çš„å†…å®¹ ç¡¬ç›˜æ€»å…±æœ‰å¤šå°‘å—ï¼Œå¤šå°‘å—ç©ºé—²ï¼Œæœ‰å¤šå°‘ inode ç­‰ä¿¡æ¯éƒ½æ”¾åœ¨ super å—ä¸­ï¼Œsuper å—å¯ä»¥é€šè¿‡ get_super() å‡½æ•°è·å¾—ã€‚\nå…¶ä¸­çš„ä¿¡æ¯å¯ä»¥å€Ÿé‰´å¦‚ä¸‹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 struct super_block * sb; sb = get_super(inode-\u003ei_dev); struct buffer_head * bh; total_blocks = sb-\u003es_nzones; for(i=0; is_zmap_blocks; i++) { bh = sb-\u003es_zmap[i]; p=(char *)bh-\u003eb_data; } 5.å®éªŒæ­¥éª¤ 1.ä¿®æ”¹include/sys/stat.hæ–‡ä»¶ å¢åŠ æ–°æ–‡ä»¶ç±»å‹ï¼Œåœ¨æ­¤æ–‡ä»¶å†…æ–°å¢procæ–‡ä»¶çš„å®å®šä¹‰ä»¥åŠæµ‹è¯•å®ã€‚\n1 2 3 4 5 6 7 8 9 //å·²æœ‰çš„å®å®šä¹‰ #define S_IFMT 00170000 //æ–‡ä»¶ç±»å‹(éƒ½æ˜¯8è¿›åˆ¶è¡¨ç¤º) #define S_IFREG 0100000\t//æ™®é€šæ–‡ä»¶ #define S_IFCHAR 0020000 //å­—ç¬¦è®¾å¤‡æ–‡ä»¶ #define S_ISREG(m) (((m) \u0026 S_IFMT) == S_IFREG) //æµ‹è¯•mæ˜¯å¦æ˜¯æ™®é€šæ–‡ä»¶ #define S_ISCHAR(m) (((m) \u0026 S_IFMT) == S_IFCHAR) //æµ‹è¯•mæ˜¯å¦æ˜¯å­—ç¬¦è®¾å¤‡æ–‡ä»¶ //procæ–‡ä»¶çš„å®å®šä¹‰/å®å‡½æ•° #define S_IFPROC 0030000 #define S_ISPROC(m) (((m) \u0026 S_IFMT) == S_IFPROC) //æµ‹è¯•mæ˜¯å¦æ˜¯procæ–‡ä»¶ æˆªå›¾å¦‚ä¸‹ï¼š 2.ä¿®æ”¹namei.cæ–‡ä»¶ æ–‡ä»¶/proc/psinfoä»¥åŠ/proc/hdinfoç´¢å¼•èŠ‚ç‚¹éœ€è¦é€šè¿‡mknod()ç³»ç»Ÿè°ƒç”¨å»ºç«‹ï¼Œè¿™é‡Œéœ€è¦è®©å®ƒæ”¯æŒæ–°çš„æ–‡ä»¶ç±»å‹ã€‚å¯ç›´æ¥ä¿®æ”¹fs/namei.cæ–‡ä»¶ä¸­çš„sys_mknod()å‡½æ•°çš„ä¸€è¡Œä»£ç ï¼Œåœ¨å…¶ä¸­å¢åŠ å…³äºprocæ–‡ä»¶ç³»ç»Ÿçš„åˆ¤æ–­:\n1 2 3 4 5 6 if (S_ISBLK(mode) || S_ISCHR(mode) || S_ISPROC(mode)) inode-\u003ei_zone[0] = dev; // æ–‡ä»¶ç³»ç»Ÿåˆå§‹åŒ– inode-\u003ei_mtime = inode-\u003ei_atime = CURRENT_TIME; inode-\u003ei_dirt = 1; bh = add_entry(dir,basename,namelen,\u0026de); æˆªå›¾å¦‚ä¸‹ï¼š 3.ä¿®æ”¹init/main.cæ–‡ä»¶ main()å‡½æ•°åœ¨initåç›´æ¥æŒ‚è½½äº†æ ¹æ–‡ä»¶ç³»ç»Ÿï¼ŒæŒ‚è½½ä¹‹åå°±å¯ä»¥åˆ›å»ºprocæ–‡ä»¶äº†ï¼Œé¦–å…ˆåˆ›å»º/procæ–‡ä»¶ç›®å½•ï¼Œç„¶åå†å»ºç«‹è¯¥ç›®å½•ä¸‹çš„å„ä¸ªprocæ–‡ä»¶èŠ‚ç‚¹ã€‚åœ¨å»ºç«‹è¿™äº›èŠ‚ç‚¹å’Œç›®å½•æ—¶éœ€è¦è°ƒç”¨ç³»ç»Ÿè°ƒç”¨mkdirå’Œmknodï¼Œå› ä¸ºåˆå§‹åŒ–æ—¶åœ¨ç”¨æˆ·æ€äº†ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥è°ƒç”¨ï¼Œå¿…é¡»åœ¨åˆå§‹åŒ–ä»£ç æ‰€åœ¨çš„æ–‡ä»¶ä¸­å®ç°è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨çš„ç”¨æˆ·æ€æ¥å£ã€‚ä¿®æ”¹init/main.cï¼Œæ–°å¢ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ç”¨æˆ·æ¥å£å¹¶æ¥ç€ä¿®æ”¹initå‡½æ•°å®ç°å¯¹å…¶çš„è°ƒç”¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 static inline _syscall0(int,fork) static inline _syscall0(int,pause) static inline _syscall1(int,setup,void *,BIOS) static inline _syscall0(int,sync) /*æ–°å¢mkdirå’Œmknodeç³»ç»Ÿè°ƒç”¨*/ _syscall2(int,mkdir,const char*,name,mode_t,mode) _syscall3(int,mknod,const char *,filename,mode_t,mode,dev_t,dev) //....... setup((void *) \u0026drive_info); (void) open(\"/dev/tty0\",O_RDWR,0); (void) dup(0); (void) dup(0); mkdir(\"/proc\",0755); mknod(\"/proc/psinfo\",S_IFPROC|0444,0); mknod(\"/proc/hdinfo\",S_IFPROC|0444,1); mknod(\"/proc/inodeinfo\",S_IFPROC|0444,2); æˆªå›¾å¦‚ä¸‹ï¼š mkdir()æ—¶modeå‚æ•°çš„å€¼å¯ä»¥æ˜¯â€œ0755â€ï¼ˆrwxr-xr-xï¼‰ï¼Œè¡¨ç¤ºåªå…è®¸rootç”¨æˆ·æ”¹å†™æ­¤ç›®å½•ï¼Œå…¶å®ƒäººåªèƒ½è¿›å…¥å’Œè¯»å–æ­¤ç›®å½•ã€‚\nprocfsæ˜¯ä¸€ä¸ªåªè¯»æ–‡ä»¶ç³»ç»Ÿï¼Œæ‰€ä»¥ç”¨mknod()å»ºç«‹psinfoç»“ç‚¹æ—¶ï¼Œå¿…é¡»é€šè¿‡modeå‚æ•°å°†å…¶è®¾ä¸ºåªè¯»ã€‚å»ºè®®ä½¿ç”¨S_IFPROC|0444åšä¸ºmodeå€¼ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªprocæ–‡ä»¶ï¼Œæƒé™ä¸º0444ï¼ˆrâ€“râ€“râ€“ï¼‰ï¼Œå¯¹æ‰€æœ‰ç”¨æˆ·åªè¯»ã€‚\nmknod()çš„ç¬¬ä¸‰ä¸ªå‚æ•°devç”¨æ¥è¯´æ˜ç»“ç‚¹æ‰€ä»£è¡¨çš„è®¾å¤‡ç¼–å·ã€‚å¯¹äºprocfsæ¥è¯´ï¼Œæ­¤ç¼–å·å¯ä»¥å®Œå…¨è‡ªå®šä¹‰ã€‚procæ–‡ä»¶çš„å¤„ç†å‡½æ•°å°†é€šè¿‡è¿™ä¸ªç¼–å·å†³å®šå¯¹åº”æ–‡ä»¶åŒ…å«çš„ä¿¡æ¯æ˜¯ä»€ä¹ˆã€‚ä¾‹å¦‚ï¼Œå¯ä»¥æŠŠ0å¯¹åº”psinfoï¼Œ1å¯¹åº”hdinfoï¼Œ2å¯¹åº”inodeinfoã€‚ ç°åœ¨å¯ä»¥é‡æ–°ç¼–è¯‘è¿è¡Œç³»ç»Ÿï¼Œä½¿ç”¨ll /procå¯è§‚å¯Ÿåˆ°ä¸‹é¢çš„ç»“æœï¼š\nè¿™äº›ä¿¡æ¯è¯´æ˜å†…æ ¸åœ¨å¯¹ psinfo è¿›è¡Œè¯»æ“ä½œæ—¶ä¸èƒ½æ­£ç¡®å¤„ç†ï¼Œå‘ cat è¿”å›äº† EINVAL é”™è¯¯ã€‚å› ä¸ºè¿˜æ²¡æœ‰å®ç°å¤„ç†å‡½æ•°ï¼Œæ‰€ä»¥è¿™æ˜¯å¾ˆæ­£å¸¸çš„ã€‚è¿™äº›ä¿¡æ¯è‡³å°‘è¯´æ˜ï¼Œpsinfoè¢«æ­£ç¡®open()äº†ã€‚æ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦å¯¹sys_open()åŠ¨ä»»ä½•æ‰‹è„šï¼Œå”¯ä¸€è¦æ‰“è¡¥ä¸çš„ï¼Œæ˜¯sys_read()ã€‚\n4.ä¿®æ”¹fs/read_write.cæ–‡ä»¶ ä¸ºäº†è®©procæ–‡ä»¶å¯è¯»ï¼Œä¿®æ”¹fs/read_write.cæ·»åŠ externï¼Œè¡¨ç¤ºproc_readå‡½æ•°æ˜¯ä»å¤–éƒ¨è°ƒç”¨çš„ã€‚\n1 2 /*æ–°å¢proc_readå‡½æ•°å¤–éƒ¨è°ƒç”¨*/ extern int proc_read(int dev,unsigned long *pos,char* buf,int count); æˆªå›¾å¦‚ä¸‹ï¼š ç„¶ååœ¨sys_readå‡½æ•°ä¸­ä»¿ç…§å…¶ä»–ifè¯­å¥ï¼ŒåŠ ä¸Š S_IFPROC() çš„åˆ†æ”¯ï¼Œæ·»åŠ procæ–‡ä»¶çš„proc_read()è°ƒç”¨ï¼š\n1 2 3 4 5 6 7 if (inode-\u003ei_pipe) return (file-\u003ef_mode\u00261)?read_pipe(inode,buf,count):-EIO; /*æ–°å¢proc_readè°ƒç”¨*/ if (S_ISPROC(inode-\u003ei_mode)) return proc_read(inode-\u003ei_zone[0],\u0026file-\u003ef_pos,buf,count); if (S_ISCHR(inode-\u003ei_mode)) return rw_char(READ,inode-\u003ei_zone[0],buf,count,\u0026file-\u003ef_pos); æˆªå›¾å¦‚ä¸‹ï¼š éœ€è¦ä¼ ç»™å¤„ç†å‡½æ•°çš„å‚æ•°åŒ…æ‹¬ï¼š\ninode-\u003ei_zone[0]ï¼Œè¿™å°±æ˜¯ mknod() æ—¶æŒ‡å®šçš„ dev â€”â€”è®¾å¤‡ç¼–å·\n\u0026file-\u003ef_posï¼Œf_pos æ˜¯ä¸Šä¸€æ¬¡è¯»æ–‡ä»¶ç»“æŸæ—¶â€œæ–‡ä»¶ä½ç½®æŒ‡é’ˆâ€çš„æŒ‡å‘ã€‚è¿™é‡Œå¿…é¡»ä¼ æŒ‡é’ˆï¼Œå› ä¸ºå¤„ç†å‡½æ•°éœ€è¦æ ¹æ®ä¼ ç»™ buf çš„æ•°æ®é‡ä¿®æ”¹ f_pos çš„å€¼ã€‚\nbufï¼ŒæŒ‡å‘ç”¨æˆ·ç©ºé—´ï¼Œç”¨æ¥æ¥æ”¶æ•°æ®\ncountï¼Œè¯´æ˜ buf æŒ‡å‘çš„ç¼“å†²åŒºå¤§å°\n5.æ–°å¢/fs/proc.cæ–‡ä»¶ procæ–‡ä»¶çš„å¤„ç†å‡½æ•°çš„åŠŸèƒ½æ˜¯æ ¹æ®è®¾å¤‡ç¼–å·ï¼ŒæŠŠä¸åŒçš„å†…å®¹å†™å…¥åˆ°ç”¨æˆ·ç©ºé—´çš„bufã€‚å†™å…¥çš„æ•°æ®è¦ä» f_pos æŒ‡å‘çš„ä½ç½®å¼€å§‹ï¼Œæ¯æ¬¡æœ€å¤šå†™countä¸ªå­—èŠ‚ï¼Œå¹¶æ ¹æ®å®é™…å†™å…¥çš„å­—èŠ‚æ•°è°ƒæ•´ f_pos çš„å€¼ï¼Œæœ€åè¿”å›å®é™…å†™å…¥çš„å­—èŠ‚æ•°ã€‚å½“è®¾å¤‡ç¼–å·è¡¨æ˜è¦è¯»çš„æ˜¯psinfoçš„å†…å®¹æ—¶ï¼Œå°±è¦æŒ‰ç…§ psinfo çš„å½¢å¼ç»„ç»‡æ•°æ®ã€‚åœ¨fsç›®å½•ä¸‹æ–°å¢proc.cæ–‡ä»¶ï¼Œæ–‡ä»¶ä¿¡æ¯å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 #include #include #include #include #include #include #define set_bit(bitnr,addr) ({ \\ register int __res ; \\ __asm__(\"bt %2,%3;setb %%al\":\"=a\" (__res):\"a\" (0),\"r\" (bitnr),\"m\" (*(addr))); \\ __res; }) char proc_buf[4096] ={'\\0'}; extern int vsprintf(char * buf, const char * fmt, va_list args); //Linux0.11æ²¡æœ‰sprintf()ï¼Œè¯¥å‡½æ•°æ˜¯ç”¨äºè¾“å‡ºç»“æœåˆ°å­—ç¬¦ä¸²ä¸­çš„ï¼Œæ‰€ä»¥å°±å®ç°ä¸€ä¸ªï¼Œè¿™é‡Œæ˜¯é€šè¿‡vsprintf()å®ç°çš„ã€‚ int sprintf(char *buf, const char *fmt, ...) { va_list args; int i; va_start(args, fmt); i=vsprintf(buf, fmt, args); va_end(args); return i; } int get_psinfo() { int read = 0; read += sprintf(proc_buf+read,\"%s\",\"pid\\tstate\\tfather\\tcounter\\tstart_time\\n\"); struct task_struct **p; for(p = \u0026FIRST_TASK ; p \u003c= \u0026LAST_TASK ; ++p) if (*p != NULL) { read += sprintf(proc_buf+read,\"%d\\t\",(*p)-\u003epid); read += sprintf(proc_buf+read,\"%d\\t\",(*p)-\u003estate); read += sprintf(proc_buf+read,\"%d\\t\",(*p)-\u003efather); read += sprintf(proc_buf+read,\"%d\\t\",(*p)-\u003ecounter); read += sprintf(proc_buf+read,\"%d\\n\",(*p)-\u003estart_time); } return read; } /* * å‚è€ƒfs/super.c mount_root()å‡½æ•° */ int get_hdinfo() { int read = 0; int i,used; struct super_block * sb; sb=get_super(0x301); /*ç£ç›˜è®¾å¤‡å· 3*256+1*/ /*Blocksä¿¡æ¯*/ read += sprintf(proc_buf+read,\"Total blocks:%d\\n\",sb-\u003es_nzones); used = 0; i=sb-\u003es_nzones; while(--i \u003e= 0) { if(set_bit(i\u00268191,sb-\u003es_zmap[i\u003e\u003e13]-\u003eb_data)) used++; } read += sprintf(proc_buf+read,\"Used blocks:%d\\n\",used); read += sprintf(proc_buf+read,\"Free blocks:%d\\n\",sb-\u003es_nzones-used); /*Inodes ä¿¡æ¯*/ read += sprintf(proc_buf+read,\"Total inodes:%d\\n\",sb-\u003es_ninodes); used = 0; i=sb-\u003es_ninodes+1; while(--i \u003e= 0) { if(set_bit(i\u00268191,sb-\u003es_imap[i\u003e\u003e13]-\u003eb_data)) used++; } read += sprintf(proc_buf+read,\"Used inodes:%d\\n\",used); read += sprintf(proc_buf+read,\"Free inodes:%d\\n\",sb-\u003es_ninodes-used); return read; } int get_inodeinfo() { int read = 0; int i; struct super_block * sb; struct m_inode *mi; sb=get_super(0x301); /*ç£ç›˜è®¾å¤‡å· 3*256+1*/ i=sb-\u003es_ninodes+1; i=0; while(++i \u003c sb-\u003es_ninodes+1) { if(set_bit(i\u00268191,sb-\u003es_imap[i\u003e\u003e13]-\u003eb_data)) { mi = iget(0x301,i); read += sprintf(proc_buf+read,\"inr:%d;zone[0]:%d\\n\",mi-\u003ei_num,mi-\u003ei_zone[0]); iput(mi); } if(read \u003e= 4000) { break; } } return read; } int proc_read(int dev, unsigned long * pos, char * buf, int count) { int i; if(*pos % 1024 == 0) { if(dev == 0) get_psinfo(); if(dev == 1) get_hdinfo(); if(dev == 2) get_inodeinfo(); } for(i=0;i\u003ccount;i++) { if(proc_buf[i+ *pos ] == '\\0') break; put_fs_byte(proc_buf[i+ *pos],buf + i+ *pos); } *pos += i; return i; } æ–°å¢è¿‡ç¨‹æˆªå›¾å¦‚ä¸‹ï¼š 6.ä¿®æ”¹fs/Makefileæ–‡ä»¶ 1 2 3 4 5 6 7 8 OBJS=\topen.o read_write.o inode.o file_table.o buffer.o super.o \\ block_dev.o char_dev.o file_dev.o stat.o exec.o pipe.o namei.o \\ bitmap.o fcntl.o ioctl.o truncate.o proc.o //...... ### Dependencies: proc.o : proc.c ../include/linux/kernel.h ../include/linux/sched.h \\ ../include/linux/head.h ../include/linux/fs.h ../include/sys/types.h \\ ../include/linux/mm.h ../include/signal.h ../include/asm/segment.h æˆªå›¾å¦‚ä¸‹ï¼š 7.è¿è¡ŒéªŒè¯ é‡æ–°ç¼–è¯‘è¿è¡Œlinux-0.11 æŸ¥çœ‹psinfo(å½“å‰ç³»ç»Ÿè¿›ç¨‹çŠ¶æ€ä¿¡æ¯)å’Œhdinfo(ç¡¬ç›˜ä¿¡æ¯)çš„ä¿¡æ¯ï¼Œå‘ç°ç¬¦åˆé¢„æœŸã€‚\nå›ç­”é—®é¢˜ meminfoï¼Œå¯ä»¥è·å¾—å†…å­˜ç›¸å…³ä¿¡æ¯ï¼Œçœ‹é‚£äº›ç¨‹åºå ç”¨å†…å­˜è¾ƒå¤šï¼Œæ–¹ä¾¿ç®¡ç†ã€‚ æ˜¯å˜åŒ–å‰çš„ï¼Œ==åœ¨è¯»å–ä½ç½®f_posä¸º0æ—¶æ‰æ›´æ–°psinfoå†…å®¹==ã€‚ è¯¥inodeå¯¹åº”çš„i_zone[0]ä¾ç„¶å­˜åœ¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåªæ˜¯ä»inodeæ˜ å°„ä¸­å–æ¶ˆæ˜ å°„è¯¥inodeï¼Œä½†æ˜¯å®é™…ä¸Šç¡¬ç›˜ä¸Šçš„æ•°æ®è¿˜åœ¨ã€‚ ",
  "wordCount" : "6043",
  "inLanguage": "zh",
  "datePublished": "2022-05-26T00:00:00Z",
  "dateModified": "2022-05-26T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "chance7bin"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://chance7bin.github.io/posts/basic/os-lab/%E5%AE%9E%E9%AA%8C9-proc%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%AE%9E%E7%8E%B0/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Binb's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://chance7bin.github.io/" accesskey="h" title="Binb&#39;s Blog (Alt + H)">
                <img src="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg" alt="" aria-label="logo"
                    height="35">Binb&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://chance7bin.github.io/search" title="ğŸ”æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ”æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="https://chance7bin.github.io/" title="ğŸ  ä¸»é¡µ">
                    <span>ğŸ  ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://chance7bin.github.io/archives/" title="â±ï¸ æ—¶é—´è½´">
                    <span>â±ï¸ æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://chance7bin.github.io/posts" title="ğŸ“š æ–‡ç« ">
                    <span>ğŸ“š æ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://chance7bin.github.io/tags" title="ğŸ”– æ ‡ç­¾">
                    <span>ğŸ”– æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://github.com/chance7bin" title="GitHub">
                    <span>GitHub</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://chance7bin.github.io/">ğŸ  ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://chance7bin.github.io/posts/">ğŸ“š æ–‡ç« </a>&nbsp;Â»&nbsp;<a href="https://chance7bin.github.io/posts/basic/">ğŸ“• è®¡ç®—æœºåŸºç¡€</a>&nbsp;Â»&nbsp;<a href="https://chance7bin.github.io/posts/basic/os-lab/">hit-oslab</a></div>
    <h1 class="post-title">
      å®éªŒ9 procæ–‡ä»¶ç³»ç»Ÿçš„å®ç°
    </h1>
    <div class="post-meta">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">


<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }

    .parent-post-meta {
        display: flex;
        flex-wrap: wrap;
        opacity: 0.8;
    }
</style>

<span class="parent-post-meta">
    <span id="post_meta_style_1">
        <span class="fa fa-calendar-check-o"></span>
        <span>2022-05-26
            &nbsp;&nbsp;
        </span>
    </span>
    
    
    
    
    
    
    
    <span id="post_meta_style_3">
        <span class="fa fa-file-word-o"></span>
        <span>6043å­—
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_4">
        <span class="fa fa-clock-o"></span>
        <span>13åˆ†é’Ÿ
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_5">
        <span class="fa fa-user-o"></span>
        <span>chance7bin
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_6">
        <span class="fa fa-tags" style="opacity: 0.8"></span>
        <span>
            <span class="post-tags-meta">
                <a href="https://chance7bin.github.io/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="color: var(--secondary)!important;">æ“ä½œç³»ç»Ÿ</a>
                &nbsp;<a href="https://chance7bin.github.io/tags/%E5%AE%9E%E9%AA%8C/" style="color: var(--secondary)!important;">å®éªŒ</a>
            </span>
        </span>
    </span>

    
</span>


      
      
      
      
      
      
      
          
          
          
              
              
              
              
          
      
    </div>
  </header>
   <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#1%e5%ae%9e%e9%aa%8c%e7%9b%ae%e7%9a%84" aria-label="1.å®éªŒç›®çš„">1.å®éªŒç›®çš„</a></li>
                    <li>
                        <a href="#2%e5%ae%9e%e9%aa%8c%e5%86%85%e5%ae%b9" aria-label="2.å®éªŒå†…å®¹">2.å®éªŒå†…å®¹</a></li>
                    <li>
                        <a href="#3%e5%ae%9e%e9%aa%8c%e6%8a%a5%e5%91%8a" aria-label="3.å®éªŒæŠ¥å‘Š">3.å®éªŒæŠ¥å‘Š</a></li>
                    <li>
                        <a href="#4%e5%ae%9e%e9%aa%8c%e6%8f%90%e7%a4%ba" aria-label="4.å®éªŒæç¤º">4.å®éªŒæç¤º</a><ul>
                            
                    <li>
                        <a href="#41-procfs-%e7%ae%80%e4%bb%8b" aria-label="4.1 procfs ç®€ä»‹">4.1 procfs ç®€ä»‹</a></li>
                    <li>
                        <a href="#42-%e5%9f%ba%e6%9c%ac%e6%80%9d%e8%b7%af" aria-label="4.2 åŸºæœ¬æ€è·¯">4.2 åŸºæœ¬æ€è·¯</a></li>
                    <li>
                        <a href="#43-%e5%a2%9e%e5%8a%a0%e6%96%b0%e6%96%87%e4%bb%b6%e7%b1%bb%e5%9e%8b" aria-label="4.3 å¢åŠ æ–°æ–‡ä»¶ç±»å‹">4.3 å¢åŠ æ–°æ–‡ä»¶ç±»å‹</a></li>
                    <li>
                        <a href="#44-%e8%ae%a9-mknod-%e6%94%af%e6%8c%81%e6%96%b0%e7%9a%84%e6%96%87%e4%bb%b6%e7%b1%bb%e5%9e%8b" aria-label="4.4 è®© mknod() æ”¯æŒæ–°çš„æ–‡ä»¶ç±»å‹">4.4 è®© mknod() æ”¯æŒæ–°çš„æ–‡ä»¶ç±»å‹</a></li>
                    <li>
                        <a href="#45-%e8%ae%a9-proc-%e6%96%87%e4%bb%b6%e5%8f%af%e8%af%bb" aria-label="4.5 è®© proc æ–‡ä»¶å¯è¯»">4.5 è®© proc æ–‡ä»¶å¯è¯»</a></li>
                    <li>
                        <a href="#46-proc-%e6%96%87%e4%bb%b6%e7%9a%84%e5%a4%84%e7%90%86%e5%87%bd%e6%95%b0" aria-label="4.6 proc æ–‡ä»¶çš„å¤„ç†å‡½æ•°">4.6 proc æ–‡ä»¶çš„å¤„ç†å‡½æ•°</a></li>
                    <li>
                        <a href="#47-%e5%ae%9e%e7%8e%b0-sprintf-%e5%87%bd%e6%95%b0" aria-label="4.7 å®ç° sprintf() å‡½æ•°">4.7 å®ç° sprintf() å‡½æ•°</a></li>
                    <li>
                        <a href="#48-cat-%e5%91%bd%e4%bb%a4%e7%9a%84%e5%ae%9e%e7%8e%b0" aria-label="4.8 cat å‘½ä»¤çš„å®ç°">4.8 cat å‘½ä»¤çš„å®ç°</a></li>
                    <li>
                        <a href="#49-psinfo-%e7%9a%84%e5%86%85%e5%ae%b9" aria-label="4.9 psinfo çš„å†…å®¹">4.9 psinfo çš„å†…å®¹</a></li>
                    <li>
                        <a href="#410-hdinfo-%e7%9a%84%e5%86%85%e5%ae%b9" aria-label="4.10 hdinfo çš„å†…å®¹">4.10 hdinfo çš„å†…å®¹</a></li></ul>
                    </li>
                    <li>
                        <a href="#5%e5%ae%9e%e9%aa%8c%e6%ad%a5%e9%aa%a4" aria-label="5.å®éªŒæ­¥éª¤">5.å®éªŒæ­¥éª¤</a><ul>
                            
                    <li>
                        <a href="#1%e4%bf%ae%e6%94%b9includesysstath%e6%96%87%e4%bb%b6" aria-label="1.ä¿®æ”¹include/sys/stat.hæ–‡ä»¶">1.ä¿®æ”¹include/sys/stat.hæ–‡ä»¶</a></li>
                    <li>
                        <a href="#2%e4%bf%ae%e6%94%b9nameic%e6%96%87%e4%bb%b6" aria-label="2.ä¿®æ”¹namei.cæ–‡ä»¶">2.ä¿®æ”¹namei.cæ–‡ä»¶</a></li>
                    <li>
                        <a href="#3%e4%bf%ae%e6%94%b9initmainc%e6%96%87%e4%bb%b6" aria-label="3.ä¿®æ”¹init/main.cæ–‡ä»¶">3.ä¿®æ”¹init/main.cæ–‡ä»¶</a></li>
                    <li>
                        <a href="#4%e4%bf%ae%e6%94%b9fsread_writec%e6%96%87%e4%bb%b6" aria-label="4.ä¿®æ”¹fs/read_write.cæ–‡ä»¶">4.ä¿®æ”¹fs/read_write.cæ–‡ä»¶</a></li>
                    <li>
                        <a href="#5%e6%96%b0%e5%a2%9efsprocc%e6%96%87%e4%bb%b6" aria-label="5.æ–°å¢/fs/proc.cæ–‡ä»¶">5.æ–°å¢/fs/proc.cæ–‡ä»¶</a></li>
                    <li>
                        <a href="#6%e4%bf%ae%e6%94%b9fsmakefile%e6%96%87%e4%bb%b6" aria-label="6.ä¿®æ”¹fs/Makefileæ–‡ä»¶">6.ä¿®æ”¹fs/Makefileæ–‡ä»¶</a></li>
                    <li>
                        <a href="#7%e8%bf%90%e8%a1%8c%e9%aa%8c%e8%af%81" aria-label="7.è¿è¡ŒéªŒè¯">7.è¿è¡ŒéªŒè¯</a></li>
                    <li>
                        <a href="#%e5%9b%9e%e7%ad%94%e9%97%ae%e9%a2%98" aria-label="å›ç­”é—®é¢˜">å›ç­”é—®é¢˜</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>
  <div class="post-content"><h2 id="1å®éªŒç›®çš„">1.å®éªŒç›®çš„<a hidden class="anchor" aria-hidden="true" href="#1å®éªŒç›®çš„">#</a></h2>
<ul>
<li>æŒæ¡è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿçš„å®ç°åŸç†ï¼›</li>
<li>å®è·µæ–‡ä»¶ã€ç›®å½•ã€æ–‡ä»¶ç³»ç»Ÿç­‰æ¦‚å¿µã€‚</li>
</ul>
<h2 id="2å®éªŒå†…å®¹">2.å®éªŒå†…å®¹<a hidden class="anchor" aria-hidden="true" href="#2å®éªŒå†…å®¹">#</a></h2>
<p>/procæ–‡ä»¶ç³»ç»Ÿæ˜¯äº†è§£ç³»ç»Ÿä¿¡æ¯çš„ä¸€ä¸ªçª—å£ï¼Œå®ƒä¸æ˜¯æ™®é€šæ„ä¹‰ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒæ˜¯ä¸€ä¸ªåˆ°è¿è¡Œä¸­è¿›ç¨‹åœ°å€ç©ºé—´çš„è®¿é—®æ¥å£ã€‚é€šè¿‡/procï¼Œå¯ä»¥ç”¨æ ‡å‡†Unixç³»ç»Ÿè°ƒç”¨(æ¯”å¦‚open()ã€read()ã€write()ç­‰ç­‰)è®¿é—®ï¼Œå°±è±¡è®¿é—®ä¸€ä¸ªæ™®é€šæ–‡ä»¶ä¸€æ ·ã€‚äº‹å®ä¸Šï¼Œè®¸å¤šæ“ä½œç³»ç»Ÿä¸­çš„pså‘½ä»¤æ­£æ˜¯åˆ©ç”¨/procæ¥è·å–è¿›ç¨‹çŠ¶æ€çš„ã€‚å› æ­¤/procæ–‡ä»¶ç³»ç»Ÿæ˜¯è™šæ‹Ÿçš„æ–‡ä»¶ç³»ç»Ÿï¼Œçœ‹ä¼¼å­˜åœ¨çš„æ–‡ä»¶å®é™…å¹¶æ²¡æœ‰åœ¨ç¡¬ç›˜ä¸Šã€‚å…¶å®ï¼Œ/procæ˜¯ä½ äº†è§£è‡ªå·±ç³»ç»Ÿçš„ä¸€ä¸ªçª—å£ï¼Œå®ƒå®é™…å­˜åœ¨äºå†…å­˜ã€‚</p>
<p>åœ¨ Linux 0.11 ä¸Šå®ç° procfsï¼ˆproc æ–‡ä»¶ç³»ç»Ÿï¼‰å†…çš„ psinfo ç»“ç‚¹ã€‚å½“è¯»å–æ­¤ç»“ç‚¹çš„å†…å®¹æ—¶ï¼Œå¯å¾—åˆ°ç³»ç»Ÿå½“å‰æ‰€æœ‰è¿›ç¨‹çš„çŠ¶æ€ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œç”¨ cat å‘½ä»¤æ˜¾ç¤º <code>/proc/psinfo</code> çš„å†…å®¹ï¼Œå¯å¾—åˆ°ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ cat /proc/psinfo
</span></span><span class="line"><span class="cl">pid    state    father    counter    start_time
</span></span><span class="line"><span class="cl"><span class="m">0</span>    <span class="m">1</span>    -1    <span class="m">0</span>    <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="m">1</span>    <span class="m">1</span>    <span class="m">0</span>    <span class="m">28</span>    <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="m">4</span>    <span class="m">1</span>    <span class="m">1</span>    <span class="m">1</span>    <span class="m">73</span>
</span></span><span class="line"><span class="cl"><span class="m">3</span>    <span class="m">1</span>    <span class="m">1</span>    <span class="m">27</span>    <span class="m">63</span>
</span></span><span class="line"><span class="cl"><span class="m">6</span>    <span class="m">0</span>    <span class="m">4</span>    <span class="m">12</span>    <span class="m">817</span>
</span></span><span class="line"><span class="cl">$ cat /proc/hdinfo
</span></span><span class="line"><span class="cl">total_blocks:    62000<span class="p">;</span>
</span></span><span class="line"><span class="cl">free_blocks:    39037<span class="p">;</span>
</span></span><span class="line"><span class="cl">used_blocks:    22963<span class="p">;</span>
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>procfs</code> åŠå…¶ç»“ç‚¹è¦åœ¨å†…æ ¸å¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»ºã€‚</p>
<p>ç›¸å…³åŠŸèƒ½å®ç°åœ¨ <code>fs/proc.c</code> æ–‡ä»¶å†…ã€‚</p>
<h2 id="3å®éªŒæŠ¥å‘Š">3.å®éªŒæŠ¥å‘Š<a hidden class="anchor" aria-hidden="true" href="#3å®éªŒæŠ¥å‘Š">#</a></h2>
<p>å®Œæˆå®éªŒåï¼Œåœ¨å®éªŒæŠ¥å‘Šä¸­å›ç­”å¦‚ä¸‹é—®é¢˜ï¼š</p>
<ul>
<li>å¦‚æœè¦æ±‚ä½ åœ¨ <code>psinfo</code> ä¹‹å¤–å†å®ç°å¦ä¸€ä¸ªç»“ç‚¹ï¼Œå…·ä½“å†…å®¹è‡ªé€‰ï¼Œé‚£ä¹ˆä½ ä¼šå®ç°ä¸€ä¸ªç»™å‡ºä»€ä¹ˆä¿¡æ¯çš„ç»“ç‚¹ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ</li>
<li>ä¸€æ¬¡ <code>read()</code> æœªå¿…èƒ½è¯»å‡ºæ‰€æœ‰çš„æ•°æ®ï¼Œéœ€è¦ç»§ç»­ <code>read()</code>ï¼Œç›´åˆ°æŠŠæ•°æ®è¯»ç©ºä¸ºæ­¢ã€‚è€Œæ•°æ¬¡ <code>read()</code> ä¹‹é—´ï¼Œè¿›ç¨‹çš„çŠ¶æ€å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚ä½ è®¤ä¸ºåå‡ æ¬¡ <code>read()</code> ä¼ ç»™ç”¨æˆ·çš„æ•°æ®ï¼Œåº”è¯¥æ˜¯å˜åŒ–åçš„ï¼Œè¿˜æ˜¯å˜åŒ–å‰çš„ï¼Ÿ
<ul>
<li>å¦‚æœæ˜¯å˜åŒ–åçš„ï¼Œé‚£ä¹ˆç”¨æˆ·å¾—åˆ°çš„æ•°æ®è¡”æ¥éƒ¨åˆ†æ˜¯å¦ä¼šæœ‰æ··ä¹±ï¼Ÿå¦‚ä½•é˜²æ­¢æ··ä¹±ï¼Ÿ</li>
<li>å¦‚æœæ˜¯å˜åŒ–å‰çš„ï¼Œé‚£ä¹ˆè¯¥åœ¨ä»€ä¹ˆæ ·çš„æƒ…å†µä¸‹æ›´æ–° <code>psinfo</code> çš„å†…å®¹ï¼Ÿ</li>
</ul>
</li>
</ul>
<h2 id="4å®éªŒæç¤º">4.å®éªŒæç¤º<a hidden class="anchor" aria-hidden="true" href="#4å®éªŒæç¤º">#</a></h2>
<p>æœ¬å®éªŒæ–‡æ¡£åœ¨ Linux 0.11 ä¸Šå®ç° <code>procfs</code>ï¼ˆproc æ–‡ä»¶ç³»ç»Ÿï¼‰å†…çš„ <code>psinfo</code> ç»“ç‚¹ã€‚å½“è¯»å– <code>psinfo</code> ç»“ç‚¹çš„å†…å®¹æ—¶ï¼Œå¯å¾—åˆ°ç³»ç»Ÿå½“å‰æ‰€æœ‰è¿›ç¨‹çš„çŠ¶æ€ä¿¡æ¯ã€‚</p>
<p>æœ€åè¿˜ç»™å‡ºæ¥ <code>hdinfo</code> ç»“ç‚¹å®ç°çš„æç¤ºã€‚</p>
<h3 id="41-procfs-ç®€ä»‹">4.1 procfs ç®€ä»‹<a hidden class="anchor" aria-hidden="true" href="#41-procfs-ç®€ä»‹">#</a></h3>
<p>æ­£å¼çš„ Linux å†…æ ¸å®ç°äº† <code>procfs</code>ï¼Œå®ƒæ˜¯ä¸€ä¸ªè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œé€šå¸¸è¢« mountï¼ˆæŒ‚è½½ï¼‰ åˆ° <code>/proc</code> ç›®å½•ä¸Šï¼Œé€šè¿‡è™šæ‹Ÿæ–‡ä»¶å’Œè™šæ‹Ÿç›®å½•çš„æ–¹å¼æä¾›è®¿é—®ç³»ç»Ÿå‚æ•°çš„æœºä¼šï¼Œæ‰€ä»¥æœ‰äººç§°å®ƒä¸º â€œäº†è§£ç³»ç»Ÿä¿¡æ¯çš„ä¸€ä¸ªçª—å£â€ã€‚</p>
<p>è¿™äº›è™šæ‹Ÿçš„æ–‡ä»¶å’Œç›®å½•å¹¶æ²¡æœ‰çœŸå®åœ°å­˜åœ¨åœ¨ç£ç›˜ä¸Šï¼Œè€Œæ˜¯å†…æ ¸ä¸­å„ç§æ•°æ®çš„ä¸€ç§ç›´è§‚è¡¨ç¤ºã€‚è™½ç„¶æ˜¯è™šæ‹Ÿçš„ï¼Œä½†å®ƒä»¬éƒ½å¯ä»¥é€šè¿‡æ ‡å‡†çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆ<code>open()</code>ã€<code>read()</code> ç­‰ï¼‰è®¿é—®ã€‚</p>
<p>ä¾‹å¦‚ï¼Œ<code>/proc/meminfo</code> ä¸­åŒ…å«å†…å­˜ä½¿ç”¨çš„ä¿¡æ¯ï¼Œå¯ä»¥ç”¨ cat å‘½ä»¤æ˜¾ç¤ºå…¶å†…å®¹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ cat /proc/meminfo
</span></span><span class="line"><span class="cl">MemTotal:       <span class="m">384780</span> kB
</span></span><span class="line"><span class="cl">MemFree:         <span class="m">13636</span> kB
</span></span><span class="line"><span class="cl">Buffers:         <span class="m">13928</span> kB
</span></span><span class="line"><span class="cl">Cached:         <span class="m">101680</span> kB
</span></span><span class="line"><span class="cl">SwapCached:        <span class="m">132</span> kB
</span></span><span class="line"><span class="cl">Active:         <span class="m">207764</span> kB
</span></span><span class="line"><span class="cl">Inactive:        <span class="m">45720</span> kB
</span></span><span class="line"><span class="cl">SwapTotal:      <span class="m">329324</span> kB
</span></span><span class="line"><span class="cl">SwapFree:       <span class="m">329192</span> kB
</span></span><span class="line"><span class="cl">Dirty:               <span class="m">0</span> kB
</span></span><span class="line"><span class="cl">Writeback:           <span class="m">0</span> kB
</span></span><span class="line"><span class="cl">â€¦â€¦
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…¶å®ï¼ŒLinux çš„å¾ˆå¤šç³»ç»Ÿå‘½ä»¤å°±æ˜¯é€šè¿‡è¯»å– <code>/proc</code> å®ç°çš„ã€‚ä¾‹å¦‚ <code>uname -a</code> çš„éƒ¨åˆ†ä¿¡æ¯å°±æ¥è‡ª <code>/proc/version</code>ï¼Œè€Œ <code>uptime</code> çš„éƒ¨åˆ†ä¿¡æ¯æ¥è‡ª <code>/proc/uptime</code> å’Œ <code>/proc/loadavg</code>ã€‚</p>
<p>å…³äº procfs æ›´å¤šçš„ä¿¡æ¯è¯·è®¿é—®ï¼šhttp://en.wikipedia.org/wiki/Procfs</p>
<h3 id="42-åŸºæœ¬æ€è·¯">4.2 åŸºæœ¬æ€è·¯<a hidden class="anchor" aria-hidden="true" href="#42-åŸºæœ¬æ€è·¯">#</a></h3>
<p>Linux æ˜¯é€šè¿‡æ–‡ä»¶ç³»ç»Ÿæ¥å£å®ç° <code>procfs</code>ï¼Œå¹¶åœ¨å¯åŠ¨æ—¶è‡ªåŠ¨å°†å…¶ mount åˆ° <code>/proc</code> ç›®å½•ä¸Šã€‚</p>
<p>æ­¤ç›®å½•ä¸‹çš„æ‰€æœ‰å†…å®¹éƒ½æ˜¯éšç€ç³»ç»Ÿçš„è¿è¡Œè‡ªåŠ¨å»ºç«‹ã€åˆ é™¤å’Œæ›´æ–°çš„ï¼Œè€Œä¸”å®ƒä»¬å®Œå…¨å­˜åœ¨äºå†…å­˜ä¸­ï¼Œä¸å ç”¨ä»»ä½•å¤–å­˜ç©ºé—´ã€‚</p>
<p>Linux 0.11 è¿˜æ²¡æœ‰å®ç°è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œä¹Ÿå°±æ˜¯ï¼Œè¿˜æ²¡æœ‰æä¾›å¢åŠ æ–°æ–‡ä»¶ç³»ç»Ÿæ”¯æŒçš„æ¥å£ã€‚æ‰€ä»¥æœ¬å®éªŒåªèƒ½åœ¨ç°æœ‰æ–‡ä»¶ç³»ç»Ÿçš„åŸºç¡€ä¸Šï¼Œé€šè¿‡æ‰“è¡¥ä¸çš„æ–¹å¼æ¨¡æ‹Ÿä¸€ä¸ª <code>procfs</code>ã€‚</p>
<p>Linux 0.11 ä½¿ç”¨çš„æ˜¯ Minix çš„æ–‡ä»¶ç³»ç»Ÿï¼Œè¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„åŸºäº <code>inode</code> çš„æ–‡ä»¶ç³»ç»Ÿï¼Œã€Šæ³¨é‡Šã€‹ä¸€ä¹¦å¯¹å®ƒæœ‰è¯¦ç»†æè¿°ã€‚å®ƒçš„æ¯ä¸ªæ–‡ä»¶éƒ½è¦å¯¹åº”è‡³å°‘ä¸€ä¸ª inodeï¼Œè€Œ inode ä¸­è®°å½•ç€æ–‡ä»¶çš„å„ç§å±æ€§ï¼ŒåŒ…æ‹¬æ–‡ä»¶ç±»å‹ã€‚æ–‡ä»¶ç±»å‹æœ‰æ™®é€šæ–‡ä»¶ã€ç›®å½•ã€å­—ç¬¦è®¾å¤‡æ–‡ä»¶å’Œå—è®¾å¤‡æ–‡ä»¶ç­‰ã€‚åœ¨å†…æ ¸ä¸­ï¼Œæ¯ç§ç±»å‹çš„æ–‡ä»¶éƒ½æœ‰ä¸åŒçš„å¤„ç†å‡½æ•°ä¸ä¹‹å¯¹åº”ã€‚æˆ‘ä»¬å¯ä»¥å¢åŠ ä¸€ç§æ–°çš„æ–‡ä»¶ç±»å‹â€”â€”proc æ–‡ä»¶ï¼Œå¹¶åœ¨ç›¸åº”çš„å¤„ç†å‡½æ•°å†…å®ç° procfs è¦å®ç°çš„åŠŸèƒ½ã€‚</p>
<h3 id="43-å¢åŠ æ–°æ–‡ä»¶ç±»å‹">4.3 å¢åŠ æ–°æ–‡ä»¶ç±»å‹<a hidden class="anchor" aria-hidden="true" href="#43-å¢åŠ æ–°æ–‡ä»¶ç±»å‹">#</a></h3>
<p>åœ¨ <code>include/sys/stat.h</code> æ–‡ä»¶ä¸­å®šä¹‰äº†å‡ ç§æ–‡ä»¶ç±»å‹å’Œç›¸åº”çš„æµ‹è¯•å®ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define S_IFMT  00170000
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// æ™®é€šæ–‡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define S_IFREG  0100000
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// å—è®¾å¤‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define S_IFBLK  0060000
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// ç›®å½•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define S_IFDIR  0040000
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// å­—ç¬¦è®¾å¤‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define S_IFCHR  0020000
</span></span></span><span class="line"><span class="cl"><span class="cp">#define S_IFIFO  0010000
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">//â€¦â€¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// æµ‹è¯• m æ˜¯å¦æ˜¯æ™®é€šæ–‡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define S_ISREG(m)      (((m) &amp; S_IFMT) == S_IFREG)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// æµ‹è¯• m æ˜¯å¦æ˜¯ç›®å½•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define S_ISDIR(m)      (((m) &amp; S_IFMT) == S_IFDIR)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// æµ‹è¯• m æ˜¯å¦æ˜¯å­—ç¬¦è®¾å¤‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define S_ISCHR(m)      (((m) &amp; S_IFMT) == S_IFCHR)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// æµ‹è¯• m æ˜¯å¦æ˜¯å—è®¾å¤‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define S_ISBLK(m)      (((m) &amp; S_IFMT) == S_IFBLK)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define S_ISFIFO(m)     (((m) &amp; S_IFMT) == S_IFIFO)
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>å¢åŠ æ–°çš„ç±»å‹çš„æ–¹æ³•åˆ†ä¸¤æ­¥ï¼š</p>
<ul>
<li>ï¼ˆ1ï¼‰å®šä¹‰ä¸€ä¸ªç±»å‹å® <code>S_IFPROC</code>ï¼Œå…¶å€¼åº”åœ¨ <code>0010000</code> åˆ° <code>0100000</code> ä¹‹é—´ï¼Œä½†åå››ä½å…«è¿›åˆ¶æ•°å¿…é¡»æ˜¯ 0ï¼ˆè¿™æ˜¯ <code>S_IFMT</code> çš„é™åˆ¶ï¼Œåˆ†ææµ‹è¯•å®å¯çŸ¥åŸå› ï¼‰ï¼Œè€Œä¸”ä¸èƒ½å’Œå·²æœ‰çš„ä»»æ„ä¸€ä¸ª <code>S_IFXXX</code> ç›¸åŒï¼›</li>
<li>ï¼ˆ2ï¼‰å®šä¹‰ä¸€ä¸ªæµ‹è¯•å® <code>S_ISPROC(m)</code>ï¼Œå½¢å¼ä»¿ç…§å…¶å®ƒçš„ <code>S_ISXXX(m)</code></li>
</ul>
<p>æ³¨æ„ï¼ŒC è¯­è¨€ä¸­ä»¥ â€œ0â€ ç›´æ¥æ¥æ•°å­—çš„å¸¸æ•°æ˜¯å…«è¿›åˆ¶æ•°ã€‚</p>
<h3 id="44-è®©-mknod-æ”¯æŒæ–°çš„æ–‡ä»¶ç±»å‹">4.4 è®© mknod() æ”¯æŒæ–°çš„æ–‡ä»¶ç±»å‹<a hidden class="anchor" aria-hidden="true" href="#44-è®©-mknod-æ”¯æŒæ–°çš„æ–‡ä»¶ç±»å‹">#</a></h3>
<p>psinfo ç»“ç‚¹è¦é€šè¿‡ <code>mknod()</code> ç³»ç»Ÿè°ƒç”¨å»ºç«‹ï¼Œæ‰€ä»¥è¦è®©å®ƒæ”¯æŒæ–°çš„æ–‡ä»¶ç±»å‹ã€‚</p>
<p>ç›´æ¥ä¿®æ”¹ <code>fs/namei.c</code> æ–‡ä»¶ä¸­çš„ <code>sys_mknod()</code> å‡½æ•°ä¸­çš„ä¸€è¡Œä»£ç ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nf">S_ISBLK</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="o">||</span> <span class="nf">S_ISCHR</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="o">||</span> <span class="nf">S_ISPROC</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">     <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_zone</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// æ–‡ä»¶ç³»ç»Ÿåˆå§‹åŒ–
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>å†…æ ¸åˆå§‹åŒ–çš„å…¨éƒ¨å·¥ä½œæ˜¯åœ¨ <code>main()</code> ä¸­å®Œæˆï¼Œè€Œ <code>main()</code> åœ¨æœ€åä»å†…æ ¸æ€åˆ‡æ¢åˆ°ç”¨æˆ·æ€ï¼Œå¹¶è°ƒç”¨ <code>init()</code>ã€‚</p>
<p><code>init()</code> åšçš„ç¬¬ä¸€ä»¶äº‹æƒ…å°±æ˜¯æŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">//    â€¦â€¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">setup</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">drive_info</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//    â€¦â€¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>procfs</code> çš„åˆå§‹åŒ–å·¥ä½œåº”è¯¥åœ¨æ ¹æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ä¹‹åå¼€å§‹ã€‚å®ƒåŒ…æ‹¬ä¸¤ä¸ªæ­¥éª¤ï¼š</p>
<ul>
<li>ï¼ˆ1ï¼‰å»ºç«‹ <code>/proc</code> ç›®å½•ï¼›å»ºç«‹ <code>/proc</code> ç›®å½•ä¸‹çš„å„ä¸ªç»“ç‚¹ã€‚æœ¬å®éªŒåªå»ºç«‹ <code>/proc/psinfo</code>ã€‚</li>
<li>ï¼ˆ2ï¼‰å»ºç«‹ç›®å½•å’Œç»“ç‚¹åˆ†åˆ«éœ€è¦è°ƒç”¨ <code>mkdir()</code> å’Œ <code>mknod()</code> ç³»ç»Ÿè°ƒç”¨ã€‚å› ä¸ºåˆå§‹åŒ–æ—¶å·²ç»åœ¨ç”¨æˆ·æ€ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥è°ƒç”¨ <code>sys_mkdir()</code> å’Œ <code>sys_mknod()</code>ã€‚å¿…é¡»åœ¨åˆå§‹åŒ–ä»£ç æ‰€åœ¨æ–‡ä»¶ä¸­å®ç°è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨çš„ç”¨æˆ·æ€æ¥å£ï¼Œå³ APIï¼š</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#ifndef __LIBRARY__
</span></span></span><span class="line"><span class="cl"><span class="cp">#define __LIBRARY__
</span></span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="nf">_syscall2</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="n">mkdir</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="kt">mode_t</span><span class="p">,</span><span class="n">mode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">_syscall3</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="n">mknod</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="kt">mode_t</span><span class="p">,</span><span class="n">mode</span><span class="p">,</span><span class="kt">dev_t</span><span class="p">,</span><span class="n">dev</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>mkdir()</code> æ—¶ mode å‚æ•°çš„å€¼å¯ä»¥æ˜¯ â€œ0755â€ï¼ˆå¯¹åº” <code>rwxr-xr-x</code>ï¼‰ï¼Œè¡¨ç¤ºåªå…è®¸ root ç”¨æˆ·æ”¹å†™æ­¤ç›®å½•ï¼Œå…¶å®ƒäººåªèƒ½è¿›å…¥å’Œè¯»å–æ­¤ç›®å½•ã€‚</p>
<p>procfs æ˜¯ä¸€ä¸ªåªè¯»æ–‡ä»¶ç³»ç»Ÿï¼Œæ‰€ä»¥ç”¨ <code>mknod()</code> å»ºç«‹ psinfo ç»“ç‚¹æ—¶ï¼Œå¿…é¡»é€šè¿‡ mode å‚æ•°å°†å…¶è®¾ä¸ºåªè¯»ã€‚å»ºè®®ä½¿ç”¨ <code>S_IFPROC|0444</code> åšä¸º mode å€¼ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª proc æ–‡ä»¶ï¼Œæƒé™ä¸º 0444ï¼ˆr&ndash;r&ndash;r&ndash;ï¼‰ï¼Œå¯¹æ‰€æœ‰ç”¨æˆ·åªè¯»ã€‚</p>
<p><code>mknod()</code> çš„ç¬¬ä¸‰ä¸ªå‚æ•° dev ç”¨æ¥è¯´æ˜ç»“ç‚¹æ‰€ä»£è¡¨çš„è®¾å¤‡ç¼–å·ã€‚å¯¹äº procfs æ¥è¯´ï¼Œæ­¤ç¼–å·å¯ä»¥å®Œå…¨è‡ªå®šä¹‰ã€‚proc æ–‡ä»¶çš„å¤„ç†å‡½æ•°å°†é€šè¿‡è¿™ä¸ªç¼–å·å†³å®šå¯¹åº”æ–‡ä»¶åŒ…å«çš„ä¿¡æ¯æ˜¯ä»€ä¹ˆã€‚ä¾‹å¦‚ï¼Œå¯ä»¥æŠŠ 0 å¯¹åº” psinfoï¼Œ1 å¯¹åº” meminfoï¼Œ2 å¯¹åº” cpuinfoã€‚</p>
<p>å¦‚æ­¤é¡¹å·¥ä½œå®Œæˆå¾—æ²¡æœ‰é—®é¢˜ï¼Œé‚£ä¹ˆç¼–è¯‘ã€è¿è¡Œ 0.11 å†…æ ¸åï¼Œç”¨ <code>ll /proc</code> å¯ä»¥çœ‹åˆ°ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># ll /proc</span>
</span></span><span class="line"><span class="cl">total <span class="m">0</span>
</span></span><span class="line"><span class="cl">?r--r--r--   <span class="m">1</span> root     root              <span class="m">0</span> ??? ??  ???? psinfo
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ­¤æ—¶å¯ä»¥è¯•ç€è¯»ä¸€ä¸‹æ­¤æ–‡ä»¶ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># cat /proc/psinfo</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>Read<span class="o">)</span>inode-&gt;i_mode<span class="o">=</span>XXX444
</span></span><span class="line"><span class="cl">cat: /proc/psinfo: EINVAL
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>inode-&gt;i_mode</code> å°±æ˜¯é€šè¿‡ <code>mknod()</code> è®¾ç½®çš„ modeã€‚ä¿¡æ¯ä¸­çš„ XXX å’Œä½ è®¾ç½®çš„ <code>S_IFPROC</code> æœ‰å…³ã€‚é€šè¿‡æ­¤å€¼å¯ä»¥äº†è§£ <code>mknod()</code> å·¥ä½œæ˜¯å¦æ­£å¸¸ã€‚è¿™äº›ä¿¡æ¯è¯´æ˜å†…æ ¸åœ¨å¯¹ <code>psinfo</code> è¿›è¡Œè¯»æ“ä½œæ—¶ä¸èƒ½æ­£ç¡®å¤„ç†ï¼Œå‘ cat è¿”å›äº† EINVAL é”™è¯¯ã€‚å› ä¸ºè¿˜æ²¡æœ‰å®ç°å¤„ç†å‡½æ•°ï¼Œæ‰€ä»¥è¿™æ˜¯å¾ˆæ­£å¸¸çš„ã€‚</p>
<p>è¿™äº›ä¿¡æ¯è‡³å°‘è¯´æ˜ï¼Œpsinfo è¢«æ­£ç¡® <code>open()</code> äº†ã€‚æ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦å¯¹ <code>sys_open()</code> åŠ¨ä»»ä½•æ‰‹è„šï¼Œå”¯ä¸€è¦æ‰“è¡¥ä¸çš„ï¼Œæ˜¯ <code>sys_read()</code>ã€‚</p>
<h3 id="45-è®©-proc-æ–‡ä»¶å¯è¯»">4.5 è®© proc æ–‡ä»¶å¯è¯»<a hidden class="anchor" aria-hidden="true" href="#45-è®©-proc-æ–‡ä»¶å¯è¯»">#</a></h3>
<p><code>open()</code> æ²¡æœ‰å˜åŒ–ï¼Œé‚£ä¹ˆéœ€è¦ä¿®æ”¹çš„å°±æ˜¯ <code>sys_read()</code> äº†ã€‚</p>
<p>é¦–å…ˆåˆ†æ <code>sys_read</code>ï¼ˆåœ¨æ–‡ä»¶ <code>fs/read_write.c</code> ä¸­ï¼‰ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">sys_read</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span><span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">file</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">m_inode</span> <span class="o">*</span> <span class="n">inode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">//    â€¦â€¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">inode</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_inode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_pipe</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span><span class="o">?</span><span class="nf">read_pipe</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">count</span><span class="p">)</span><span class="o">:-</span><span class="n">EIO</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">S_ISCHR</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">rw_char</span><span class="p">(</span><span class="n">READ</span><span class="p">,</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_zone</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">buf</span><span class="p">,</span><span class="n">count</span><span class="p">,</span><span class="o">&amp;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">S_ISBLK</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">block_read</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_zone</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">S_ISDIR</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">)</span> <span class="o">||</span> <span class="nf">S_ISREG</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="o">+</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">&gt;</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">count</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span> <span class="o">-</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">file_read</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span><span class="n">file</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printk</span><span class="p">(</span><span class="s">&#34;(Read)inode-&gt;i_mode=%06o</span><span class="se">\n\r</span><span class="s">&#34;</span><span class="p">,</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">);</span>    <span class="c1">//è¿™æ¡ä¿¡æ¯å¾ˆé¢å–„å§ï¼Ÿ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ˜¾ç„¶ï¼Œè¦åœ¨è¿™é‡Œä¸€ç¾¤ if çš„æ’æ¯”ä¸­ï¼ŒåŠ ä¸Š <code>S_IFPROC()</code> çš„åˆ†æ”¯ï¼Œè¿›å…¥å¯¹ proc æ–‡ä»¶çš„å¤„ç†å‡½æ•°ã€‚éœ€è¦ä¼ ç»™å¤„ç†å‡½æ•°çš„å‚æ•°åŒ…æ‹¬ï¼š</p>
<ul>
<li><code>inode-&gt;i_zone[0]</code>ï¼Œè¿™å°±æ˜¯ <code>mknod()</code> æ—¶æŒ‡å®šçš„ <code>dev</code> â€”â€”è®¾å¤‡ç¼–å·</li>
<li><code>buf</code>ï¼ŒæŒ‡å‘ç”¨æˆ·ç©ºé—´ï¼Œå°±æ˜¯ <code>read()</code> çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œç”¨æ¥æ¥æ”¶æ•°æ®</li>
<li><code>count</code>ï¼Œå°±æ˜¯ <code>read()</code> çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œè¯´æ˜ <code>buf</code> æŒ‡å‘çš„ç¼“å†²åŒºå¤§å°</li>
<li><code>&amp;file-&gt;f_pos</code>ï¼Œ<code>f_pos</code> æ˜¯ä¸Šä¸€æ¬¡è¯»æ–‡ä»¶ç»“æŸæ—¶â€œæ–‡ä»¶ä½ç½®æŒ‡é’ˆâ€çš„æŒ‡å‘ã€‚è¿™é‡Œå¿…é¡»ä¼ æŒ‡é’ˆï¼Œå› ä¸ºå¤„ç†å‡½æ•°éœ€è¦æ ¹æ®ä¼ ç»™ <code>buf</code> çš„æ•°æ®é‡ä¿®æ”¹ <code>f_pos</code> çš„å€¼ã€‚</li>
</ul>
<h3 id="46-proc-æ–‡ä»¶çš„å¤„ç†å‡½æ•°">4.6 proc æ–‡ä»¶çš„å¤„ç†å‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#46-proc-æ–‡ä»¶çš„å¤„ç†å‡½æ•°">#</a></h3>
<p>proc æ–‡ä»¶çš„å¤„ç†å‡½æ•°çš„åŠŸèƒ½æ˜¯æ ¹æ®è®¾å¤‡ç¼–å·ï¼ŒæŠŠä¸åŒçš„å†…å®¹å†™å…¥åˆ°ç”¨æˆ·ç©ºé—´çš„ bufã€‚å†™å…¥çš„æ•°æ®è¦ä» <code>f_pos</code> æŒ‡å‘çš„ä½ç½®å¼€å§‹ï¼Œæ¯æ¬¡æœ€å¤šå†™ count ä¸ªå­—èŠ‚ï¼Œå¹¶æ ¹æ®å®é™…å†™å…¥çš„å­—èŠ‚æ•°è°ƒæ•´ <code>f_pos</code> çš„å€¼ï¼Œæœ€åè¿”å›å®é™…å†™å…¥çš„å­—èŠ‚æ•°ã€‚å½“è®¾å¤‡ç¼–å·è¡¨æ˜è¦è¯»çš„æ˜¯ psinfo çš„å†…å®¹æ—¶ï¼Œå°±è¦æŒ‰ç…§ psinfo çš„å½¢å¼ç»„ç»‡æ•°æ®ã€‚</p>
<p>å®ç°æ­¤å‡½æ•°å¯èƒ½è¦ç”¨åˆ°å¦‚ä¸‹å‡ ä¸ªå‡½æ•°ï¼š</p>
<ul>
<li>malloc() å‡½æ•°</li>
<li>free() å‡½æ•°</li>
</ul>
<p>åŒ…å« <code>linux/kernel.h</code> å¤´æ–‡ä»¶åï¼Œå°±å¯ä»¥ä½¿ç”¨ <code>malloc()</code> å’Œ <code>free()</code> å‡½æ•°ã€‚å®ƒä»¬æ˜¯å¯ä»¥è¢«æ ¸å¿ƒæ€ä»£ç è°ƒç”¨çš„ï¼Œå”¯ä¸€çš„é™åˆ¶æ˜¯ä¸€æ¬¡ç”³è¯·çš„å†…å­˜å¤§å°ä¸èƒ½è¶…è¿‡ä¸€ä¸ªé¡µé¢ã€‚</p>
<h3 id="47-å®ç°-sprintf-å‡½æ•°">4.7 å®ç° sprintf() å‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#47-å®ç°-sprintf-å‡½æ•°">#</a></h3>
<p>Linux 0.11 æ²¡æœ‰ <code>sprintf()</code>ï¼Œå¯ä»¥å‚è€ƒ <code>printf()</code> è‡ªå·±å®ç°ä¸€ä¸ªã€‚</p>
<p>å¯ä»¥å€Ÿé‰´å¦‚ä¸‹ä»£ç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdarg.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">//â€¦â€¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">sprintf</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">va_list</span> <span class="n">args</span><span class="p">;</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span><span class="o">=</span><span class="nf">vsprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="48-cat-å‘½ä»¤çš„å®ç°">4.8 cat å‘½ä»¤çš„å®ç°<a hidden class="anchor" aria-hidden="true" href="#48-cat-å‘½ä»¤çš„å®ç°">#</a></h3>
<p>cat æ˜¯ Linux ä¸‹çš„ä¸€ä¸ªå¸¸ç”¨å‘½ä»¤ï¼ŒåŠŸèƒ½æ˜¯å°†æ–‡ä»¶çš„å†…å®¹æ‰“å°åˆ°æ ‡å‡†è¾“å‡ºã€‚</p>
<p>å®ƒæ ¸å¿ƒå®ç°å¤§ä½“å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">513</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sc">&#39;\0&#39;</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">nread</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">O_RDONLY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span><span class="n">nread</span> <span class="o">=</span> <span class="nf">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">512</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">buf</span><span class="p">[</span><span class="n">nread</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="49-psinfo-çš„å†…å®¹">4.9 psinfo çš„å†…å®¹<a hidden class="anchor" aria-hidden="true" href="#49-psinfo-çš„å†…å®¹">#</a></h3>
<p>è¿›ç¨‹çš„ä¿¡æ¯å°±æ¥æºäºå†…æ ¸å…¨å±€ç»“æ„æ•°ç»„ <code>struct task_struct * task[NR_TASKS]</code> ä¸­ï¼Œå…·ä½“è¯»å–ç»†èŠ‚å¯å‚ç…§ <code>sched.c</code> ä¸­çš„å‡½æ•° <code>schedule()</code>ã€‚</p>
<p>å¯ä»¥å€Ÿé‰´ä¸€ä¸‹ä»£ç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">for</span><span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">LAST_TASK</span> <span class="p">;</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">FIRST_TASK</span> <span class="p">;</span> <span class="o">--</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">counter</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">counter</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="p">...;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="410-hdinfo-çš„å†…å®¹">4.10 hdinfo çš„å†…å®¹<a hidden class="anchor" aria-hidden="true" href="#410-hdinfo-çš„å†…å®¹">#</a></h3>
<p>ç¡¬ç›˜æ€»å…±æœ‰å¤šå°‘å—ï¼Œå¤šå°‘å—ç©ºé—²ï¼Œæœ‰å¤šå°‘ inode ç­‰ä¿¡æ¯éƒ½æ”¾åœ¨ super å—ä¸­ï¼Œsuper å—å¯ä»¥é€šè¿‡ <code>get_super()</code> å‡½æ•°è·å¾—ã€‚</p>
<p>å…¶ä¸­çš„ä¿¡æ¯å¯ä»¥å€Ÿé‰´å¦‚ä¸‹ä»£ç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span> <span class="n">sb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">sb</span> <span class="o">=</span> <span class="nf">get_super</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_dev</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span> <span class="n">bh</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">total_blocks</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_nzones</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">is_zmap_blocks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">bh</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_zmap</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span><span class="o">=</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="5å®éªŒæ­¥éª¤">5.å®éªŒæ­¥éª¤<a hidden class="anchor" aria-hidden="true" href="#5å®éªŒæ­¥éª¤">#</a></h2>
<h3 id="1ä¿®æ”¹includesysstathæ–‡ä»¶">1.ä¿®æ”¹include/sys/stat.hæ–‡ä»¶<a hidden class="anchor" aria-hidden="true" href="#1ä¿®æ”¹includesysstathæ–‡ä»¶">#</a></h3>
<p>å¢åŠ æ–°æ–‡ä»¶ç±»å‹ï¼Œåœ¨æ­¤æ–‡ä»¶å†…æ–°å¢<em>proc</em>æ–‡ä»¶çš„å®å®šä¹‰ä»¥åŠæµ‹è¯•å®ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//å·²æœ‰çš„å®å®šä¹‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define S_IFMT 00170000 </span><span class="c1">//æ–‡ä»¶ç±»å‹(éƒ½æ˜¯8è¿›åˆ¶è¡¨ç¤º)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define S_IFREG 0100000	</span><span class="c1">//æ™®é€šæ–‡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define S_IFCHAR 0020000 </span><span class="c1">//å­—ç¬¦è®¾å¤‡æ–‡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define S_ISREG(m)  (((m) &amp; S_IFMT) == S_IFREG) </span><span class="c1">//æµ‹è¯•mæ˜¯å¦æ˜¯æ™®é€šæ–‡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define S_ISCHAR(m) (((m) &amp; S_IFMT) == S_IFCHAR) </span><span class="c1">//æµ‹è¯•mæ˜¯å¦æ˜¯å­—ç¬¦è®¾å¤‡æ–‡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1">//procæ–‡ä»¶çš„å®å®šä¹‰/å®å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define S_IFPROC 0030000
</span></span></span><span class="line"><span class="cl"><span class="cp">#define S_ISPROC(m) (((m) &amp; S_IFMT) ==  S_IFPROC) </span><span class="c1">//æµ‹è¯•mæ˜¯å¦æ˜¯procæ–‡ä»¶
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>æˆªå›¾å¦‚ä¸‹ï¼š
<img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012342719.png" alt="img"  />
</p>
<h3 id="2ä¿®æ”¹nameicæ–‡ä»¶">2.ä¿®æ”¹namei.cæ–‡ä»¶<a hidden class="anchor" aria-hidden="true" href="#2ä¿®æ”¹nameicæ–‡ä»¶">#</a></h3>
<p>æ–‡ä»¶/proc/psinfoä»¥åŠ/proc/hdinfoç´¢å¼•èŠ‚ç‚¹éœ€è¦é€šè¿‡mknod()ç³»ç»Ÿè°ƒç”¨å»ºç«‹ï¼Œè¿™é‡Œéœ€è¦è®©å®ƒæ”¯æŒæ–°çš„æ–‡ä»¶ç±»å‹ã€‚å¯ç›´æ¥ä¿®æ”¹fs/namei.cæ–‡ä»¶ä¸­çš„sys_mknod()å‡½æ•°çš„ä¸€è¡Œä»£ç ï¼Œåœ¨å…¶ä¸­å¢åŠ å…³äºprocæ–‡ä»¶ç³»ç»Ÿçš„åˆ¤æ–­:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nf">S_ISBLK</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="o">||</span> <span class="nf">S_ISCHR</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="o">||</span> <span class="nf">S_ISPROC</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">     <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_zone</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// æ–‡ä»¶ç³»ç»Ÿåˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mtime</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_atime</span> <span class="o">=</span> <span class="n">CURRENT_TIME</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_dirt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">bh</span> <span class="o">=</span> <span class="nf">add_entry</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span><span class="n">basename</span><span class="p">,</span><span class="n">namelen</span><span class="p">,</span><span class="o">&amp;</span><span class="n">de</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆªå›¾å¦‚ä¸‹ï¼š
<img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012342729.png" alt="img"  />
</p>
<h3 id="3ä¿®æ”¹initmaincæ–‡ä»¶">3.ä¿®æ”¹init/main.cæ–‡ä»¶<a hidden class="anchor" aria-hidden="true" href="#3ä¿®æ”¹initmaincæ–‡ä»¶">#</a></h3>
<p>main()å‡½æ•°åœ¨initåç›´æ¥æŒ‚è½½äº†æ ¹æ–‡ä»¶ç³»ç»Ÿï¼ŒæŒ‚è½½ä¹‹åå°±å¯ä»¥åˆ›å»ºprocæ–‡ä»¶äº†ï¼Œé¦–å…ˆåˆ›å»º/procæ–‡ä»¶ç›®å½•ï¼Œç„¶åå†å»ºç«‹è¯¥ç›®å½•ä¸‹çš„å„ä¸ªprocæ–‡ä»¶èŠ‚ç‚¹ã€‚åœ¨å»ºç«‹è¿™äº›èŠ‚ç‚¹å’Œç›®å½•æ—¶éœ€è¦è°ƒç”¨ç³»ç»Ÿè°ƒç”¨mkdirå’Œmknodï¼Œå› ä¸ºåˆå§‹åŒ–æ—¶åœ¨ç”¨æˆ·æ€äº†ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥è°ƒç”¨ï¼Œå¿…é¡»åœ¨åˆå§‹åŒ–ä»£ç æ‰€åœ¨çš„æ–‡ä»¶ä¸­å®ç°è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨çš„ç”¨æˆ·æ€æ¥å£ã€‚ä¿®æ”¹init/main.cï¼Œæ–°å¢ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ç”¨æˆ·æ¥å£å¹¶æ¥ç€ä¿®æ”¹initå‡½æ•°å®ç°å¯¹å…¶çš„è°ƒç”¨ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="nf">_syscall0</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="n">fork</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="nf">_syscall0</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="n">pause</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="nf">_syscall1</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="n">setup</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span><span class="n">BIOS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="nf">_syscall0</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="n">sync</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*æ–°å¢mkdirå’Œmknodeç³»ç»Ÿè°ƒç”¨*/</span>
</span></span><span class="line"><span class="cl"><span class="nf">_syscall2</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="n">mkdir</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="kt">mode_t</span><span class="p">,</span><span class="n">mode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">_syscall3</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="n">mknod</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="kt">mode_t</span><span class="p">,</span><span class="n">mode</span><span class="p">,</span><span class="kt">dev_t</span><span class="p">,</span><span class="n">dev</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="c1">//.......   
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">	<span class="nf">setup</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">drive_info</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/dev/tty0&#34;</span><span class="p">,</span><span class="n">O_RDWR</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">dup</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">dup</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">mkdir</span><span class="p">(</span><span class="s">&#34;/proc&#34;</span><span class="p">,</span><span class="mo">0755</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">mknod</span><span class="p">(</span><span class="s">&#34;/proc/psinfo&#34;</span><span class="p">,</span><span class="n">S_IFPROC</span><span class="o">|</span><span class="mo">0444</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">mknod</span><span class="p">(</span><span class="s">&#34;/proc/hdinfo&#34;</span><span class="p">,</span><span class="n">S_IFPROC</span><span class="o">|</span><span class="mo">0444</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">mknod</span><span class="p">(</span><span class="s">&#34;/proc/inodeinfo&#34;</span><span class="p">,</span><span class="n">S_IFPROC</span><span class="o">|</span><span class="mo">0444</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆªå›¾å¦‚ä¸‹ï¼š
<img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012342755.png" alt="img"  />

<img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012342745.png" alt="img"  />
</p>
<p>mkdir()æ—¶modeå‚æ•°çš„å€¼å¯ä»¥æ˜¯â€œ0755â€ï¼ˆrwxr-xr-xï¼‰ï¼Œè¡¨ç¤ºåªå…è®¸rootç”¨æˆ·æ”¹å†™æ­¤ç›®å½•ï¼Œå…¶å®ƒäººåªèƒ½è¿›å…¥å’Œè¯»å–æ­¤ç›®å½•ã€‚</p>
<p>procfsæ˜¯ä¸€ä¸ªåªè¯»æ–‡ä»¶ç³»ç»Ÿï¼Œæ‰€ä»¥ç”¨mknod()å»ºç«‹psinfoç»“ç‚¹æ—¶ï¼Œå¿…é¡»é€šè¿‡modeå‚æ•°å°†å…¶è®¾ä¸ºåªè¯»ã€‚å»ºè®®ä½¿ç”¨S_IFPROC|0444åšä¸ºmodeå€¼ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªprocæ–‡ä»¶ï¼Œæƒé™ä¸º0444ï¼ˆr&ndash;r&ndash;r&ndash;ï¼‰ï¼Œå¯¹æ‰€æœ‰ç”¨æˆ·åªè¯»ã€‚</p>
<p>mknod()çš„ç¬¬ä¸‰ä¸ªå‚æ•°devç”¨æ¥è¯´æ˜ç»“ç‚¹æ‰€ä»£è¡¨çš„è®¾å¤‡ç¼–å·ã€‚å¯¹äºprocfsæ¥è¯´ï¼Œæ­¤ç¼–å·å¯ä»¥å®Œå…¨è‡ªå®šä¹‰ã€‚procæ–‡ä»¶çš„å¤„ç†å‡½æ•°å°†é€šè¿‡è¿™ä¸ªç¼–å·å†³å®šå¯¹åº”æ–‡ä»¶åŒ…å«çš„ä¿¡æ¯æ˜¯ä»€ä¹ˆã€‚ä¾‹å¦‚ï¼Œå¯ä»¥æŠŠ0å¯¹åº”psinfoï¼Œ1å¯¹åº”hdinfoï¼Œ2å¯¹åº”inodeinfoã€‚
ç°åœ¨å¯ä»¥é‡æ–°ç¼–è¯‘è¿è¡Œç³»ç»Ÿï¼Œä½¿ç”¨<code>ll /proc</code>å¯è§‚å¯Ÿåˆ°ä¸‹é¢çš„ç»“æœï¼š</p>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012342740.png" alt="img"  />
</p>
<p>è¿™äº›ä¿¡æ¯è¯´æ˜å†…æ ¸åœ¨å¯¹ psinfo è¿›è¡Œè¯»æ“ä½œæ—¶ä¸èƒ½æ­£ç¡®å¤„ç†ï¼Œå‘ cat è¿”å›äº† EINVAL é”™è¯¯ã€‚å› ä¸ºè¿˜æ²¡æœ‰å®ç°å¤„ç†å‡½æ•°ï¼Œæ‰€ä»¥è¿™æ˜¯å¾ˆæ­£å¸¸çš„ã€‚è¿™äº›ä¿¡æ¯è‡³å°‘è¯´æ˜ï¼Œpsinfoè¢«æ­£ç¡®open()äº†ã€‚æ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦å¯¹sys_open()åŠ¨ä»»ä½•æ‰‹è„šï¼Œå”¯ä¸€è¦æ‰“è¡¥ä¸çš„ï¼Œæ˜¯sys_read()ã€‚</p>
<h3 id="4ä¿®æ”¹fsread_writecæ–‡ä»¶">4.ä¿®æ”¹fs/read_write.cæ–‡ä»¶<a hidden class="anchor" aria-hidden="true" href="#4ä¿®æ”¹fsread_writecæ–‡ä»¶">#</a></h3>
<p>ä¸ºäº†è®©procæ–‡ä»¶å¯è¯»ï¼Œä¿®æ”¹fs/read_write.cæ·»åŠ externï¼Œè¡¨ç¤ºproc_readå‡½æ•°æ˜¯ä»å¤–éƒ¨è°ƒç”¨çš„ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/*æ–°å¢proc_readå‡½æ•°å¤–éƒ¨è°ƒç”¨*/</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">int</span> <span class="nf">proc_read</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span><span class="kt">char</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span><span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆªå›¾å¦‚ä¸‹ï¼š
<img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012342768.png" alt="image-20220413145744144"  />
</p>
<p>ç„¶ååœ¨sys_readå‡½æ•°ä¸­ä»¿ç…§å…¶ä»–ifè¯­å¥ï¼ŒåŠ ä¸Š S_IFPROC() çš„åˆ†æ”¯ï¼Œæ·»åŠ procæ–‡ä»¶çš„proc_read()è°ƒç”¨ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_pipe</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span><span class="o">?</span><span class="nf">read_pipe</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">count</span><span class="p">)</span><span class="o">:-</span><span class="n">EIO</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/*æ–°å¢proc_readè°ƒç”¨*/</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">S_ISPROC</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nf">proc_read</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_zone</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">S_ISCHR</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nf">rw_char</span><span class="p">(</span><span class="n">READ</span><span class="p">,</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_zone</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">buf</span><span class="p">,</span><span class="n">count</span><span class="p">,</span><span class="o">&amp;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆªå›¾å¦‚ä¸‹ï¼š
<img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012342570.png" alt="img"  />
</p>
<p>éœ€è¦ä¼ ç»™å¤„ç†å‡½æ•°çš„å‚æ•°åŒ…æ‹¬ï¼š</p>
<ul>
<li>
<p>inode-&gt;i_zone[0]ï¼Œè¿™å°±æ˜¯ mknod() æ—¶æŒ‡å®šçš„ dev â€”â€”è®¾å¤‡ç¼–å·</p>
</li>
<li>
<p>&amp;file-&gt;f_posï¼Œf_pos æ˜¯ä¸Šä¸€æ¬¡è¯»æ–‡ä»¶ç»“æŸæ—¶â€œæ–‡ä»¶ä½ç½®æŒ‡é’ˆâ€çš„æŒ‡å‘ã€‚è¿™é‡Œå¿…é¡»ä¼ æŒ‡é’ˆï¼Œå› ä¸ºå¤„ç†å‡½æ•°éœ€è¦æ ¹æ®ä¼ ç»™ buf çš„æ•°æ®é‡ä¿®æ”¹ f_pos çš„å€¼ã€‚</p>
</li>
<li>
<p>bufï¼ŒæŒ‡å‘ç”¨æˆ·ç©ºé—´ï¼Œç”¨æ¥æ¥æ”¶æ•°æ®</p>
</li>
<li>
<p>countï¼Œè¯´æ˜ buf æŒ‡å‘çš„ç¼“å†²åŒºå¤§å°</p>
</li>
</ul>
<h3 id="5æ–°å¢fsproccæ–‡ä»¶">5.æ–°å¢/fs/proc.cæ–‡ä»¶<a hidden class="anchor" aria-hidden="true" href="#5æ–°å¢fsproccæ–‡ä»¶">#</a></h3>
<p>procæ–‡ä»¶çš„å¤„ç†å‡½æ•°çš„åŠŸèƒ½æ˜¯æ ¹æ®è®¾å¤‡ç¼–å·ï¼ŒæŠŠä¸åŒçš„å†…å®¹å†™å…¥åˆ°ç”¨æˆ·ç©ºé—´çš„bufã€‚å†™å…¥çš„æ•°æ®è¦ä» f_pos æŒ‡å‘çš„ä½ç½®å¼€å§‹ï¼Œæ¯æ¬¡æœ€å¤šå†™countä¸ªå­—èŠ‚ï¼Œå¹¶æ ¹æ®å®é™…å†™å…¥çš„å­—èŠ‚æ•°è°ƒæ•´ f_pos çš„å€¼ï¼Œæœ€åè¿”å›å®é™…å†™å…¥çš„å­—èŠ‚æ•°ã€‚å½“è®¾å¤‡ç¼–å·è¡¨æ˜è¦è¯»çš„æ˜¯psinfoçš„å†…å®¹æ—¶ï¼Œå°±è¦æŒ‰ç…§ psinfo çš„å½¢å¼ç»„ç»‡æ•°æ®ã€‚åœ¨fsç›®å½•ä¸‹æ–°å¢proc.cæ–‡ä»¶ï¼Œæ–‡ä»¶ä¿¡æ¯å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/kernel.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/sched.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;asm/segment.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/fs.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdarg.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define set_bit(bitnr,addr) ({ \
</span></span></span><span class="line"><span class="cl"><span class="cp">register int __res ; \
</span></span></span><span class="line"><span class="cl"><span class="cp">__asm__(&#34;bt %2,%3;setb %%al&#34;:&#34;=a&#34; (__res):&#34;a&#34; (0),&#34;r&#34; (bitnr),&#34;m&#34; (*(addr))); \
</span></span></span><span class="line"><span class="cl"><span class="cp">__res; })
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="n">proc_buf</span><span class="p">[</span><span class="mi">4096</span><span class="p">]</span> <span class="o">=</span><span class="p">{</span><span class="sc">&#39;\0&#39;</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">int</span> <span class="nf">vsprintf</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">va_list</span> <span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//Linux0.11æ²¡æœ‰sprintf()ï¼Œè¯¥å‡½æ•°æ˜¯ç”¨äºè¾“å‡ºç»“æœåˆ°å­—ç¬¦ä¸²ä¸­çš„ï¼Œæ‰€ä»¥å°±å®ç°ä¸€ä¸ªï¼Œè¿™é‡Œæ˜¯é€šè¿‡vsprintf()å®ç°çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">sprintf</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">va_list</span> <span class="n">args</span><span class="p">;</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span><span class="o">=</span><span class="nf">vsprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">get_psinfo</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">read</span> <span class="o">+=</span> <span class="nf">sprintf</span><span class="p">(</span><span class="n">proc_buf</span><span class="o">+</span><span class="n">read</span><span class="p">,</span><span class="s">&#34;%s&#34;</span><span class="p">,</span><span class="s">&#34;pid</span><span class="se">\t</span><span class="s">state</span><span class="se">\t</span><span class="s">father</span><span class="se">\t</span><span class="s">counter</span><span class="se">\t</span><span class="s">start_time</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">**</span><span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">FIRST_TASK</span> <span class="p">;</span> <span class="n">p</span> <span class="o">&lt;=</span> <span class="o">&amp;</span><span class="n">LAST_TASK</span> <span class="p">;</span> <span class="o">++</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="p">{</span>
</span></span><span class="line"><span class="cl"> 		<span class="n">read</span> <span class="o">+=</span> <span class="nf">sprintf</span><span class="p">(</span><span class="n">proc_buf</span><span class="o">+</span><span class="n">read</span><span class="p">,</span><span class="s">&#34;%d</span><span class="se">\t</span><span class="s">&#34;</span><span class="p">,(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 		<span class="n">read</span> <span class="o">+=</span> <span class="nf">sprintf</span><span class="p">(</span><span class="n">proc_buf</span><span class="o">+</span><span class="n">read</span><span class="p">,</span><span class="s">&#34;%d</span><span class="se">\t</span><span class="s">&#34;</span><span class="p">,(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 		<span class="n">read</span> <span class="o">+=</span> <span class="nf">sprintf</span><span class="p">(</span><span class="n">proc_buf</span><span class="o">+</span><span class="n">read</span><span class="p">,</span><span class="s">&#34;%d</span><span class="se">\t</span><span class="s">&#34;</span><span class="p">,(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">father</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 		<span class="n">read</span> <span class="o">+=</span> <span class="nf">sprintf</span><span class="p">(</span><span class="n">proc_buf</span><span class="o">+</span><span class="n">read</span><span class="p">,</span><span class="s">&#34;%d</span><span class="se">\t</span><span class="s">&#34;</span><span class="p">,(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">counter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 		<span class="n">read</span> <span class="o">+=</span> <span class="nf">sprintf</span><span class="p">(</span><span class="n">proc_buf</span><span class="o">+</span><span class="n">read</span><span class="p">,</span><span class="s">&#34;%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">start_time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 	<span class="p">}</span>
</span></span><span class="line"><span class="cl"> 	<span class="k">return</span> <span class="n">read</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">*  å‚è€ƒfs/super.c mount_root()å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">get_hdinfo</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">used</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span> <span class="n">sb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">sb</span><span class="o">=</span><span class="nf">get_super</span><span class="p">(</span><span class="mh">0x301</span><span class="p">);</span>  <span class="cm">/*ç£ç›˜è®¾å¤‡å· 3*256+1*/</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/*Blocksä¿¡æ¯*/</span>
</span></span><span class="line"><span class="cl">	<span class="n">read</span> <span class="o">+=</span> <span class="nf">sprintf</span><span class="p">(</span><span class="n">proc_buf</span><span class="o">+</span><span class="n">read</span><span class="p">,</span><span class="s">&#34;Total blocks:%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_nzones</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span><span class="o">=</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_nzones</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">while</span><span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="nf">set_bit</span><span class="p">(</span><span class="n">i</span><span class="o">&amp;</span><span class="mi">8191</span><span class="p">,</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_zmap</span><span class="p">[</span><span class="n">i</span><span class="o">&gt;&gt;</span><span class="mi">13</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="n">used</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">read</span> <span class="o">+=</span> <span class="nf">sprintf</span><span class="p">(</span><span class="n">proc_buf</span><span class="o">+</span><span class="n">read</span><span class="p">,</span><span class="s">&#34;Used blocks:%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">used</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">read</span> <span class="o">+=</span> <span class="nf">sprintf</span><span class="p">(</span><span class="n">proc_buf</span><span class="o">+</span><span class="n">read</span><span class="p">,</span><span class="s">&#34;Free blocks:%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_nzones</span><span class="o">-</span><span class="n">used</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/*Inodes ä¿¡æ¯*/</span>
</span></span><span class="line"><span class="cl">	<span class="n">read</span> <span class="o">+=</span> <span class="nf">sprintf</span><span class="p">(</span><span class="n">proc_buf</span><span class="o">+</span><span class="n">read</span><span class="p">,</span><span class="s">&#34;Total inodes:%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_ninodes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span><span class="o">=</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_ninodes</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">while</span><span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="nf">set_bit</span><span class="p">(</span><span class="n">i</span><span class="o">&amp;</span><span class="mi">8191</span><span class="p">,</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_imap</span><span class="p">[</span><span class="n">i</span><span class="o">&gt;&gt;</span><span class="mi">13</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="n">used</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">read</span> <span class="o">+=</span> <span class="nf">sprintf</span><span class="p">(</span><span class="n">proc_buf</span><span class="o">+</span><span class="n">read</span><span class="p">,</span><span class="s">&#34;Used inodes:%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">used</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">read</span> <span class="o">+=</span> <span class="nf">sprintf</span><span class="p">(</span><span class="n">proc_buf</span><span class="o">+</span><span class="n">read</span><span class="p">,</span><span class="s">&#34;Free inodes:%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_ninodes</span><span class="o">-</span><span class="n">used</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 	<span class="k">return</span> <span class="n">read</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">get_inodeinfo</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span> <span class="n">sb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">m_inode</span> <span class="o">*</span><span class="n">mi</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">sb</span><span class="o">=</span><span class="nf">get_super</span><span class="p">(</span><span class="mh">0x301</span><span class="p">);</span>  <span class="cm">/*ç£ç›˜è®¾å¤‡å· 3*256+1*/</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span><span class="o">=</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_ninodes</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">while</span><span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_ninodes</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="nf">set_bit</span><span class="p">(</span><span class="n">i</span><span class="o">&amp;</span><span class="mi">8191</span><span class="p">,</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_imap</span><span class="p">[</span><span class="n">i</span><span class="o">&gt;&gt;</span><span class="mi">13</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">mi</span> <span class="o">=</span> <span class="nf">iget</span><span class="p">(</span><span class="mh">0x301</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">read</span> <span class="o">+=</span> <span class="nf">sprintf</span><span class="p">(</span><span class="n">proc_buf</span><span class="o">+</span><span class="n">read</span><span class="p">,</span><span class="s">&#34;inr:%d;zone[0]:%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">mi</span><span class="o">-&gt;</span><span class="n">i_num</span><span class="p">,</span><span class="n">mi</span><span class="o">-&gt;</span><span class="n">i_zone</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">			<span class="nf">iput</span><span class="p">(</span><span class="n">mi</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">read</span> <span class="o">&gt;=</span> <span class="mi">4000</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"> 	<span class="k">return</span> <span class="n">read</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">proc_read</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl"> 	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="n">pos</span> <span class="o">%</span> <span class="mi">1024</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nf">get_psinfo</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nf">get_hdinfo</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nf">get_inodeinfo</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"> 	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">count</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="p">{</span>
</span></span><span class="line"><span class="cl"> 		<span class="k">if</span><span class="p">(</span><span class="n">proc_buf</span><span class="p">[</span><span class="n">i</span><span class="o">+</span> <span class="o">*</span><span class="n">pos</span> <span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">          <span class="k">break</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl"> 		<span class="nf">put_fs_byte</span><span class="p">(</span><span class="n">proc_buf</span><span class="p">[</span><span class="n">i</span><span class="o">+</span> <span class="o">*</span><span class="n">pos</span><span class="p">],</span><span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="o">+</span> <span class="o">*</span><span class="n">pos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 	<span class="p">}</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">*</span><span class="n">pos</span> <span class="o">+=</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ–°å¢è¿‡ç¨‹æˆªå›¾å¦‚ä¸‹ï¼š
<img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012342594.png" alt="img"  />
</p>
<h3 id="6ä¿®æ”¹fsmakefileæ–‡ä»¶">6.ä¿®æ”¹fs/Makefileæ–‡ä»¶<a hidden class="anchor" aria-hidden="true" href="#6ä¿®æ”¹fsmakefileæ–‡ä»¶">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">OBJS</span><span class="o">=</span>	open.o read_write.o inode.o file_table.o buffer.o super.o <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	block_dev.o char_dev.o file_dev.o stat.o exec.o pipe.o namei.o <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	bitmap.o fcntl.o ioctl.o truncate.o proc.o
</span></span><span class="line"><span class="cl">//......
</span></span><span class="line"><span class="cl"><span class="c1">### Dependencies:</span>
</span></span><span class="line"><span class="cl">proc.o : proc.c ../include/linux/kernel.h ../include/linux/sched.h <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  ../include/linux/head.h ../include/linux/fs.h ../include/sys/types.h <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  ../include/linux/mm.h ../include/signal.h ../include/asm/segment.h
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆªå›¾å¦‚ä¸‹ï¼š
<img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012342623.png" alt="img"  />
</p>
<h3 id="7è¿è¡ŒéªŒè¯">7.è¿è¡ŒéªŒè¯<a hidden class="anchor" aria-hidden="true" href="#7è¿è¡ŒéªŒè¯">#</a></h3>
<p>é‡æ–°ç¼–è¯‘è¿è¡Œlinux-0.11
<img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012342649.png" alt="img"  />
</p>
<p>æŸ¥çœ‹psinfo(å½“å‰ç³»ç»Ÿè¿›ç¨‹çŠ¶æ€ä¿¡æ¯)å’Œhdinfo(ç¡¬ç›˜ä¿¡æ¯)çš„ä¿¡æ¯ï¼Œå‘ç°ç¬¦åˆé¢„æœŸã€‚</p>
<h3 id="å›ç­”é—®é¢˜">å›ç­”é—®é¢˜<a hidden class="anchor" aria-hidden="true" href="#å›ç­”é—®é¢˜">#</a></h3>
<ol>
<li>meminfoï¼Œå¯ä»¥è·å¾—å†…å­˜ç›¸å…³ä¿¡æ¯ï¼Œçœ‹é‚£äº›ç¨‹åºå ç”¨å†…å­˜è¾ƒå¤šï¼Œæ–¹ä¾¿ç®¡ç†ã€‚</li>
<li>æ˜¯å˜åŒ–å‰çš„ï¼Œ==åœ¨è¯»å–ä½ç½®f_posä¸º0æ—¶æ‰æ›´æ–°psinfoå†…å®¹==ã€‚
è¯¥inodeå¯¹åº”çš„i_zone[0]ä¾ç„¶å­˜åœ¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåªæ˜¯ä»inodeæ˜ å°„ä¸­å–æ¶ˆæ˜ å°„è¯¥inodeï¼Œä½†æ˜¯å®é™…ä¸Šç¡¬ç›˜ä¸Šçš„æ•°æ®è¿˜åœ¨ã€‚</li>
</ol>


  </div>

  <footer class="post-footer">
    
<nav class="paginav">
  <a class="prev" href="https://chance7bin.github.io/posts/basic/asm/%E7%AC%AC7%E7%AB%A0-%E6%9B%B4%E7%81%B5%E6%B4%BB%E7%9A%84%E5%AE%9A%E4%BD%8D%E5%86%85%E5%AD%98%E5%9C%B0%E5%9D%80%E7%9A%84%E6%96%B9%E6%B3%95/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>ç¬¬7ç«  æ›´çµæ´»çš„å®šä½å†…å­˜åœ°å€çš„æ–¹æ³•</span>
  </a>
  <a class="next" href="https://chance7bin.github.io/posts/basic/asm/%E7%AC%AC8%E7%AB%A0-%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E7%9A%84%E4%B8%A4%E4%B8%AA%E5%9F%BA%E6%9C%AC%E9%97%AE%E9%A2%98/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>ç¬¬8ç«  æ•°æ®å¤„ç†çš„ä¸¤ä¸ªåŸºæœ¬é—®é¢˜</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://chance7bin.github.io/">Binb&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerHTML = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
