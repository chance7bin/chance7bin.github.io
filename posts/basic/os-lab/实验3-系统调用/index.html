<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>å®éªŒ3 ç³»ç»Ÿè°ƒç”¨ | Binb&#39;s Blog</title>
<meta name="keywords" content="æ“ä½œç³»ç»Ÿ, å®éªŒ">
<meta name="description" content="1. å®éªŒç›®çš„ å»ºç«‹å¯¹ç³»ç»Ÿè°ƒç”¨æ¥å£çš„æ·±å…¥è®¤è¯†ï¼› æŒæ¡ç³»ç»Ÿè°ƒç”¨çš„åŸºæœ¬è¿‡ç¨‹ï¼› èƒ½å®Œæˆç³»ç»Ÿè°ƒç”¨çš„å…¨é¢æ§åˆ¶ï¼› ä¸ºåç»­å®éªŒåšå‡†å¤‡ã€‚ 2. å®éªŒå†…å®¹ æ­¤æ¬¡å®éªŒçš„åŸºæœ¬å†…å®¹æ˜¯ï¼š">
<meta name="author" content="chance7bin">
<link rel="canonical" href="https://chance7bin.github.io/posts/basic/os-lab/%E5%AE%9E%E9%AA%8C3-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.be81eec981a615a87a88f121642d7eebde74d033438693944db2fd6b827284ff.css" integrity="" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.acb54fd32bbc1982428b8850317e45d076b95012730a5936667e6bc21777692a.js" integrity=""
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<link rel="icon" type="image/png" sizes="16x16" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<link rel="icon" type="image/png" sizes="32x32" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<link rel="apple-touch-icon" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<link rel="mask-icon" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="å®éªŒ3 ç³»ç»Ÿè°ƒç”¨" />
<meta property="og:description" content="1. å®éªŒç›®çš„ å»ºç«‹å¯¹ç³»ç»Ÿè°ƒç”¨æ¥å£çš„æ·±å…¥è®¤è¯†ï¼› æŒæ¡ç³»ç»Ÿè°ƒç”¨çš„åŸºæœ¬è¿‡ç¨‹ï¼› èƒ½å®Œæˆç³»ç»Ÿè°ƒç”¨çš„å…¨é¢æ§åˆ¶ï¼› ä¸ºåç»­å®éªŒåšå‡†å¤‡ã€‚ 2. å®éªŒå†…å®¹ æ­¤æ¬¡å®éªŒçš„åŸºæœ¬å†…å®¹æ˜¯ï¼š" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://chance7bin.github.io/posts/basic/os-lab/%E5%AE%9E%E9%AA%8C3-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-18T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-05-18T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="å®éªŒ3 ç³»ç»Ÿè°ƒç”¨"/>
<meta name="twitter:description" content="1. å®éªŒç›®çš„ å»ºç«‹å¯¹ç³»ç»Ÿè°ƒç”¨æ¥å£çš„æ·±å…¥è®¤è¯†ï¼› æŒæ¡ç³»ç»Ÿè°ƒç”¨çš„åŸºæœ¬è¿‡ç¨‹ï¼› èƒ½å®Œæˆç³»ç»Ÿè°ƒç”¨çš„å…¨é¢æ§åˆ¶ï¼› ä¸ºåç»­å®éªŒåšå‡†å¤‡ã€‚ 2. å®éªŒå†…å®¹ æ­¤æ¬¡å®éªŒçš„åŸºæœ¬å†…å®¹æ˜¯ï¼š"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "ğŸ“š æ–‡ç« ",
      "item": "https://chance7bin.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ“• è®¡ç®—æœºåŸºç¡€",
      "item": "https://chance7bin.github.io/posts/basic/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "hit-oslab",
      "item": "https://chance7bin.github.io/posts/basic/os-lab/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "å®éªŒ3 ç³»ç»Ÿè°ƒç”¨",
      "item": "https://chance7bin.github.io/posts/basic/os-lab/%E5%AE%9E%E9%AA%8C3-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "å®éªŒ3 ç³»ç»Ÿè°ƒç”¨",
  "name": "å®éªŒ3 ç³»ç»Ÿè°ƒç”¨",
  "description": "1. å®éªŒç›®çš„ å»ºç«‹å¯¹ç³»ç»Ÿè°ƒç”¨æ¥å£çš„æ·±å…¥è®¤è¯†ï¼› æŒæ¡ç³»ç»Ÿè°ƒç”¨çš„åŸºæœ¬è¿‡ç¨‹ï¼› èƒ½å®Œæˆç³»ç»Ÿè°ƒç”¨çš„å…¨é¢æ§åˆ¶ï¼› ä¸ºåç»­å®éªŒåšå‡†å¤‡ã€‚ 2. å®éªŒå†…å®¹ æ­¤æ¬¡å®éªŒçš„åŸºæœ¬å†…å®¹æ˜¯ï¼š",
  "keywords": [
    "æ“ä½œç³»ç»Ÿ", "å®éªŒ"
  ],
  "articleBody": "1. å®éªŒç›®çš„ å»ºç«‹å¯¹ç³»ç»Ÿè°ƒç”¨æ¥å£çš„æ·±å…¥è®¤è¯†ï¼› æŒæ¡ç³»ç»Ÿè°ƒç”¨çš„åŸºæœ¬è¿‡ç¨‹ï¼› èƒ½å®Œæˆç³»ç»Ÿè°ƒç”¨çš„å…¨é¢æ§åˆ¶ï¼› ä¸ºåç»­å®éªŒåšå‡†å¤‡ã€‚ 2. å®éªŒå†…å®¹ æ­¤æ¬¡å®éªŒçš„åŸºæœ¬å†…å®¹æ˜¯ï¼šåœ¨ Linux 0.11 ä¸Šæ·»åŠ ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œå¹¶ç¼–å†™ä¸¤ä¸ªç®€å•çš„åº”ç”¨ç¨‹åºæµ‹è¯•å®ƒä»¬ã€‚\nï¼ˆ1ï¼‰iam() ç¬¬ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨æ˜¯ iam()ï¼Œå…¶åŸå‹ä¸ºï¼š\n1 int iam(const char * name); å®Œæˆçš„åŠŸèƒ½æ˜¯å°†å­—ç¬¦ä¸²å‚æ•° name çš„å†…å®¹æ‹·è´åˆ°å†…æ ¸ä¸­ä¿å­˜ä¸‹æ¥ã€‚è¦æ±‚ name çš„é•¿åº¦ä¸èƒ½è¶…è¿‡ 23 ä¸ªå­—ç¬¦ã€‚è¿”å›å€¼æ˜¯æ‹·è´çš„å­—ç¬¦æ•°ã€‚å¦‚æœ name çš„å­—ç¬¦ä¸ªæ•°è¶…è¿‡äº† 23ï¼Œåˆ™è¿”å› â€œ-1â€ï¼Œå¹¶ç½® errno ä¸º EINVALã€‚\nåœ¨ kernal/who.c ä¸­å®ç°æ­¤ç³»ç»Ÿè°ƒç”¨ã€‚\nï¼ˆ2ï¼‰whoami() ç¬¬äºŒä¸ªç³»ç»Ÿè°ƒç”¨æ˜¯ whoami()ï¼Œå…¶åŸå‹ä¸ºï¼š\n1 int whoami(char* name, unsigned int size); å®ƒå°†å†…æ ¸ä¸­ç”± iam() ä¿å­˜çš„åå­—æ‹·è´åˆ° name æŒ‡å‘çš„ç”¨æˆ·åœ°å€ç©ºé—´ä¸­ï¼ŒåŒæ—¶ç¡®ä¿ä¸ä¼šå¯¹ name è¶Šç•Œè®¿å­˜ï¼ˆname çš„å¤§å°ç”± size è¯´æ˜ï¼‰ã€‚è¿”å›å€¼æ˜¯æ‹·è´çš„å­—ç¬¦æ•°ã€‚å¦‚æœ size å°äºéœ€è¦çš„ç©ºé—´ï¼Œåˆ™è¿”å›â€œ-1â€ï¼Œå¹¶ç½® errno ä¸º EINVALã€‚\nä¹Ÿæ˜¯åœ¨ kernal/who.c ä¸­å®ç°ã€‚\nï¼ˆ3ï¼‰æµ‹è¯•ç¨‹åº è¿è¡Œæ·»åŠ è¿‡æ–°ç³»ç»Ÿè°ƒç”¨çš„ Linux 0.11ï¼Œåœ¨å…¶ç¯å¢ƒä¸‹ç¼–å†™ä¸¤ä¸ªæµ‹è¯•ç¨‹åº iam.c å’Œ whoami.cã€‚æœ€ç»ˆçš„è¿è¡Œç»“æœæ˜¯ï¼š\n1 2 3 4 5 $ ./iam lizhijun $ ./whoami lizhijun 3. å®éªŒæŠ¥å‘Š åœ¨å®éªŒæŠ¥å‘Šä¸­å›ç­”å¦‚ä¸‹é—®é¢˜ï¼š\nä» Linux 0.11 ç°åœ¨çš„æœºåˆ¶çœ‹ï¼Œå®ƒçš„ç³»ç»Ÿè°ƒç”¨æœ€å¤šèƒ½ä¼ é€’å‡ ä¸ªå‚æ•°ï¼Ÿä½ èƒ½æƒ³å‡ºåŠæ³•æ¥æ‰©å¤§è¿™ä¸ªé™åˆ¶å—ï¼Ÿ ç”¨æ–‡å­—ç®€è¦æè¿°å‘ Linux 0.11 æ·»åŠ ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ foo() çš„æ­¥éª¤ã€‚ 4. å®éªŒæç¤º é¦–å…ˆï¼Œè¯·å°† Linux 0.11 çš„æºä»£ç æ¢å¤åˆ°åŸå§‹çŠ¶æ€ã€‚\n1 2 3 4 5 6 # åˆ é™¤åŸæ¥çš„æ–‡ä»¶ $ cd ~/oslab $ sudo rm -rf ./* # é‡æ–°æ‹·è´ $ cp -r /home/teacher/oslab/* ./ æ“ä½œç³»ç»Ÿå®ç°ç³»ç»Ÿè°ƒç”¨çš„åŸºæœ¬è¿‡ç¨‹ï¼ˆåœ¨ MOOC è¯¾ç¨‹ä¸­å·²ç»ç»™å‡ºäº†è¯¦ç»†çš„è®²è§£ï¼‰æ˜¯ï¼š\nåº”ç”¨ç¨‹åºè°ƒç”¨åº“å‡½æ•°ï¼ˆAPIï¼‰ï¼› API å°†ç³»ç»Ÿè°ƒç”¨å·å­˜å…¥ EAXï¼Œç„¶åé€šè¿‡ä¸­æ–­è°ƒç”¨ä½¿ç³»ç»Ÿè¿›å…¥å†…æ ¸æ€ï¼› å†…æ ¸ä¸­çš„ä¸­æ–­å¤„ç†å‡½æ•°æ ¹æ®ç³»ç»Ÿè°ƒç”¨å·ï¼Œè°ƒç”¨å¯¹åº”çš„å†…æ ¸å‡½æ•°ï¼ˆç³»ç»Ÿè°ƒç”¨ï¼‰ï¼› ç³»ç»Ÿè°ƒç”¨å®Œæˆç›¸åº”åŠŸèƒ½ï¼Œå°†è¿”å›å€¼å­˜å…¥ EAXï¼Œè¿”å›åˆ°ä¸­æ–­å¤„ç†å‡½æ•°ï¼› ä¸­æ–­å¤„ç†å‡½æ•°è¿”å›åˆ° API ä¸­ï¼› API å°† EAX è¿”å›ç»™åº”ç”¨ç¨‹åºã€‚ 4.1 åº”ç”¨ç¨‹åºå¦‚ä½•è°ƒç”¨ç³»ç»Ÿè°ƒç”¨ åœ¨é€šå¸¸æƒ…å†µä¸‹ï¼Œè°ƒç”¨ç³»ç»Ÿè°ƒç”¨å’Œè°ƒç”¨ä¸€ä¸ªæ™®é€šçš„è‡ªå®šä¹‰å‡½æ•°åœ¨ä»£ç ä¸Šå¹¶æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œä½†è°ƒç”¨åå‘ç”Ÿçš„äº‹æƒ…æœ‰å¾ˆå¤§ä¸åŒã€‚\nè°ƒç”¨è‡ªå®šä¹‰å‡½æ•°æ˜¯é€šè¿‡ call æŒ‡ä»¤ç›´æ¥è·³è½¬åˆ°è¯¥å‡½æ•°çš„åœ°å€ï¼Œç»§ç»­è¿è¡Œã€‚\nè€Œè°ƒç”¨ç³»ç»Ÿè°ƒç”¨ï¼Œæ˜¯è°ƒç”¨ç³»ç»Ÿåº“ä¸­ä¸ºè¯¥ç³»ç»Ÿè°ƒç”¨ç¼–å†™çš„ä¸€ä¸ªæ¥å£å‡½æ•°ï¼Œå« APIï¼ˆApplication Programming Interfaceï¼‰ã€‚API å¹¶ä¸èƒ½å®Œæˆç³»ç»Ÿè°ƒç”¨çš„çœŸæ­£åŠŸèƒ½ï¼Œå®ƒè¦åšçš„æ˜¯å»è°ƒç”¨çœŸæ­£çš„ç³»ç»Ÿè°ƒç”¨ï¼Œè¿‡ç¨‹æ˜¯ï¼š\næŠŠç³»ç»Ÿè°ƒç”¨çš„ç¼–å·å­˜å…¥ EAXï¼› æŠŠå‡½æ•°å‚æ•°å­˜å…¥å…¶å®ƒé€šç”¨å¯„å­˜å™¨ï¼› è§¦å‘ 0x80 å·ä¸­æ–­ï¼ˆint 0x80ï¼‰ã€‚ linux-0.11 çš„ lib ç›®å½•ä¸‹æœ‰ä¸€äº›å·²ç»å®ç°çš„ APIã€‚Linus ç¼–å†™å®ƒä»¬çš„åŸå› æ˜¯åœ¨å†…æ ¸åŠ è½½å®Œæ¯•åï¼Œä¼šåˆ‡æ¢åˆ°ç”¨æˆ·æ¨¡å¼ä¸‹ï¼Œåšä¸€äº›åˆå§‹åŒ–å·¥ä½œï¼Œç„¶åå¯åŠ¨ shellã€‚è€Œç”¨æˆ·æ¨¡å¼ä¸‹çš„å¾ˆå¤šå·¥ä½œéœ€è¦ä¾èµ–ä¸€äº›ç³»ç»Ÿè°ƒç”¨æ‰èƒ½å®Œæˆï¼Œå› æ­¤åœ¨å†…æ ¸ä¸­å®ç°äº†è¿™äº›ç³»ç»Ÿè°ƒç”¨çš„ APIã€‚\nåé¢çš„ç›®å½•å¦‚æœæ²¡æœ‰ç‰¹æ®Šè¯´æ˜ï¼Œéƒ½æ˜¯æŒ‡åœ¨ /home/shiyanlou/oslab/linux-0.11 ä¸­ã€‚æ¯”å¦‚ä¸‹é¢çš„ lib/close.cï¼Œæ˜¯æŒ‡ /home/shiyanlou/oslab/linux-0.11/lib/close.cã€‚\næˆ‘ä»¬ä¸å¦¨çœ‹çœ‹ lib/close.cï¼Œç ”ç©¶ä¸€ä¸‹ close() çš„ APIï¼š\n1 2 3 4 #define __LIBRARY__ #include _syscall1(int, close, int, fd) å…¶ä¸­ _syscall1 æ˜¯ä¸€ä¸ªå®ï¼Œåœ¨ include/unistd.h ä¸­å®šä¹‰ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 #define _syscall1(type,name,atype,a) \\ type name(atype a) \\ { \\ long __res; \\ __asm__ volatile (\"int $0x80\" \\ : \"=a\" (__res) \\ : \"0\" (__NR_##name),\"b\" ((long)(a))); \\ if (__res \u003e= 0) \\ return (type) __res; \\ errno = -__res; \\ return -1; \\ } å°† _syscall1(int,close,int,fd) è¿›è¡Œå®å±•å¼€ï¼Œå¯ä»¥å¾—åˆ°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 int close(int fd) { long __res; __asm__ volatile (\"int $0x80\" : \"=a\" (__res) : \"0\" (__NR_close),\"b\" ((long)(fd))); if (__res \u003e= 0) return (int) __res; errno = -__res; return -1; } è¿™å°±æ˜¯ API çš„å®šä¹‰ã€‚å®ƒå…ˆå°†å® __NR_close å­˜å…¥ EAXï¼Œå°†å‚æ•° fd å­˜å…¥ EBXï¼Œç„¶åè¿›è¡Œ 0x80 ä¸­æ–­è°ƒç”¨ã€‚è°ƒç”¨è¿”å›åï¼Œä» EAX å–å‡ºè¿”å›å€¼ï¼Œå­˜å…¥ __resï¼Œå†é€šè¿‡å¯¹ __res çš„åˆ¤æ–­å†³å®šä¼ ç»™ API çš„è°ƒç”¨è€…ä»€ä¹ˆæ ·çš„è¿”å›å€¼ã€‚\nå…¶ä¸­ __NR_close å°±æ˜¯ç³»ç»Ÿè°ƒç”¨çš„ç¼–å·ï¼Œåœ¨ include/unistd.h ä¸­å®šä¹‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 #define __NR_close 6 /* æ‰€ä»¥æ·»åŠ ç³»ç»Ÿè°ƒç”¨æ—¶éœ€è¦ä¿®æ”¹include/unistd.hæ–‡ä»¶ï¼Œ ä½¿å…¶åŒ…å«__NR_whoamiå’Œ__NR_iamã€‚ */ /* è€Œåœ¨åº”ç”¨ç¨‹åºä¸­ï¼Œè¦æœ‰ï¼š */ /* æœ‰å®ƒï¼Œ_syscall1 ç­‰æ‰æœ‰æ•ˆã€‚è¯¦è§unistd.h */ #define __LIBRARY__ /* æœ‰å®ƒï¼Œç¼–è¯‘å™¨æ‰èƒ½è·çŸ¥è‡ªå®šä¹‰çš„ç³»ç»Ÿè°ƒç”¨çš„ç¼–å· */ #include \"unistd.h\" /* iam()åœ¨ç”¨æˆ·ç©ºé—´çš„æ¥å£å‡½æ•° */ _syscall1(int, iam, const char*, name); /* whoami()åœ¨ç”¨æˆ·ç©ºé—´çš„æ¥å£å‡½æ•° */ _syscall2(int, whoami,char*,name,unsigned int,size); åœ¨ 0.11 ç¯å¢ƒä¸‹ç¼–è¯‘ C ç¨‹åºï¼ŒåŒ…å«çš„å¤´æ–‡ä»¶éƒ½åœ¨ /usr/include ç›®å½•ä¸‹ã€‚\nè¯¥ç›®å½•ä¸‹çš„ unistd.h æ˜¯æ ‡å‡†å¤´æ–‡ä»¶ï¼ˆå®ƒå’Œ 0.11 æºç æ ‘ä¸­çš„ unistd.h å¹¶ä¸æ˜¯åŒä¸€ä¸ªæ–‡ä»¶ï¼Œè™½ç„¶å†…å®¹å¯èƒ½ç›¸åŒï¼‰ï¼Œæ²¡æœ‰ __NR_whoami å’Œ __NR_iam ä¸¤ä¸ªå®ï¼Œéœ€è¦æ‰‹å·¥åŠ ä¸Šå®ƒä»¬ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä»ä¿®æ”¹è¿‡çš„ 0.11 æºç æ ‘ä¸­æ‹·è´æ–°çš„ unistd.h è¿‡æ¥ã€‚\n4.2 ä»â€œint 0x80â€è¿›å…¥å†…æ ¸å‡½æ•° int 0x80 è§¦å‘åï¼Œæ¥ä¸‹æ¥å°±æ˜¯å†…æ ¸çš„ä¸­æ–­å¤„ç†äº†ã€‚å…ˆäº†è§£ä¸€ä¸‹ 0.11 å¤„ç† 0x80 å·ä¸­æ–­çš„è¿‡ç¨‹ã€‚\nåœ¨å†…æ ¸åˆå§‹åŒ–æ—¶ï¼Œä¸»å‡½æ•°ï¼ˆåœ¨ init/main.c ä¸­ï¼ŒLinux å®éªŒç¯å¢ƒä¸‹æ˜¯ main()ï¼ŒWindows ä¸‹å› ç¼–è¯‘å™¨å…¼å®¹æ€§é—®é¢˜è¢«æ¢åä¸º start()ï¼‰è°ƒç”¨äº† sched_init() åˆå§‹åŒ–å‡½æ•°ï¼š\n1 2 3 4 5 6 7 8 void main(void) { // â€¦â€¦ time_init(); sched_init(); buffer_init(buffer_memory_end); // â€¦â€¦ } sched_init() åœ¨ kernel/sched.c ä¸­å®šä¹‰ä¸ºï¼š\n1 2 3 4 5 void sched_init(void) { // â€¦â€¦ set_system_gate(0x80,\u0026system_call); } set_system_gate æ˜¯ä¸ªå®ï¼Œåœ¨ include/asm/system.h ä¸­å®šä¹‰ä¸ºï¼š\n1 2 #define set_system_gate(n,addr) \\ _set_gate(\u0026idt[n],15,3,addr) _set_gate çš„å®šä¹‰æ˜¯ï¼š\n1 2 3 4 5 6 7 8 9 10 #define _set_gate(gate_addr,type,dpl,addr) \\ __asm__ (\"movw %%dx,%%ax\\n\\t\" \\ \"movw %0,%%dx\\n\\t\" \\ \"movl %%eax,%1\\n\\t\" \\ \"movl %%edx,%2\" \\ : \\ : \"i\" ((short) (0x8000+(dpl\u003c\u003c13)+(type\u003c\u003c8))), \\ \"o\" (*((char *) (gate_addr))), \\ \"o\" (*(4+(char *) (gate_addr))), \\ \"d\" ((char *) (addr)),\"a\" (0x00080000)) è™½ç„¶çœ‹èµ·æ¥æŒºéº»çƒ¦ï¼Œä½†å®é™…ä¸Šå¾ˆç®€å•ï¼Œå°±æ˜¯å¡«å†™ IDTï¼ˆä¸­æ–­æè¿°ç¬¦è¡¨ï¼‰ï¼Œå°† system_call å‡½æ•°åœ°å€å†™åˆ° 0x80 å¯¹åº”çš„ä¸­æ–­æè¿°ç¬¦ä¸­ï¼Œä¹Ÿå°±æ˜¯åœ¨ä¸­æ–­ 0x80 å‘ç”Ÿåï¼Œè‡ªåŠ¨è°ƒç”¨å‡½æ•° system_callã€‚å…·ä½“ç»†èŠ‚è¯·å‚è€ƒã€Šæ³¨é‡Šã€‹çš„ç¬¬ 4 ç« ã€‚\næ¥ä¸‹æ¥çœ‹ system_callã€‚è¯¥å‡½æ•°çº¯æ±‡ç¼–æ‰“é€ ï¼Œå®šä¹‰åœ¨ kernel/system_call.s ä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 !â€¦â€¦ ! # è¿™æ˜¯ç³»ç»Ÿè°ƒç”¨æ€»æ•°ã€‚å¦‚æœå¢åˆ äº†ç³»ç»Ÿè°ƒç”¨ï¼Œå¿…é¡»åšç›¸åº”ä¿®æ”¹ nr_system_calls = 72 !â€¦â€¦ .globl system_call .align 2 system_call: ! # æ£€æŸ¥ç³»ç»Ÿè°ƒç”¨ç¼–å·æ˜¯å¦åœ¨åˆæ³•èŒƒå›´å†… cmpl \\$nr_system_calls-1,%eax ja bad_sys_call push %ds push %es push %fs pushl %edx pushl %ecx ! # push %ebx,%ecx,%edxï¼Œæ˜¯ä¼ é€’ç»™ç³»ç»Ÿè°ƒç”¨çš„å‚æ•° pushl %ebx ! # è®©ds, esæŒ‡å‘GDTï¼Œå†…æ ¸åœ°å€ç©ºé—´ movl $0x10,%edx mov %dx,%ds mov %dx,%es movl $0x17,%edx ! # è®©fsæŒ‡å‘LDTï¼Œç”¨æˆ·åœ°å€ç©ºé—´ mov %dx,%fs call sys_call_table(,%eax,4) pushl %eax movl current,%eax cmpl $0,state(%eax) jne reschedule cmpl $0,counter(%eax) je reschedule system_call ç”¨ .globl ä¿®é¥°ä¸ºå…¶ä»–å‡½æ•°å¯è§ã€‚\nWindows å®éªŒç¯å¢ƒä¸‹ä¼šçœ‹åˆ°å®ƒæœ‰ä¸€ä¸ªä¸‹åˆ’çº¿å‰ç¼€ï¼Œè¿™æ˜¯ä¸åŒç‰ˆæœ¬ç¼–è¯‘å™¨çš„ç‰¹è´¨å†³å®šçš„ï¼Œæ²¡æœ‰å®è´¨åŒºåˆ«ã€‚\ncall sys_call_table(,%eax,4) ä¹‹å‰æ˜¯ä¸€äº›å‹æ ˆä¿æŠ¤ï¼Œä¿®æ”¹æ®µé€‰æ‹©å­ä¸ºå†…æ ¸æ®µï¼Œcall sys_call_table(,%eax,4) ä¹‹åæ˜¯çœ‹çœ‹æ˜¯å¦éœ€è¦é‡æ–°è°ƒåº¦ï¼Œè¿™äº›éƒ½ä¸æœ¬å®éªŒæ²¡æœ‰ç›´æ¥å…³ç³»ï¼Œæ­¤å¤„åªå…³å¿ƒ call sys_call_table(,%eax,4) è¿™ä¸€å¥ã€‚\næ ¹æ®æ±‡ç¼–å¯»å€æ–¹æ³•å®ƒå®é™…ä¸Šæ˜¯ï¼šcall sys_call_table + 4 * %eaxï¼Œå…¶ä¸­ eax ä¸­æ”¾çš„æ˜¯ç³»ç»Ÿè°ƒç”¨å·ï¼Œå³ __NR_xxxxxxã€‚\næ˜¾ç„¶ï¼Œsys_call_table ä¸€å®šæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆæ•°ç»„çš„èµ·å§‹åœ°å€ï¼Œå®ƒå®šä¹‰åœ¨ include/linux/sys.h ä¸­ï¼š\n1 fn_ptr sys_call_table[] = { sys_setup, sys_exit, sys_fork, sys_read,... å¢åŠ å®éªŒè¦æ±‚çš„ç³»ç»Ÿè°ƒç”¨ï¼Œéœ€è¦åœ¨è¿™ä¸ªå‡½æ•°è¡¨ä¸­å¢åŠ ä¸¤ä¸ªå‡½æ•°å¼•ç”¨ â€”â€”sys_iam å’Œ sys_whoamiã€‚å½“ç„¶è¯¥å‡½æ•°åœ¨ sys_call_table æ•°ç»„ä¸­çš„ä½ç½®å¿…é¡»å’Œ __NR_xxxxxx çš„å€¼å¯¹åº”ä¸Šã€‚\nåŒæ—¶è¿˜è¦ä»¿ç…§æ­¤æ–‡ä»¶ä¸­å‰é¢å„ä¸ªç³»ç»Ÿè°ƒç”¨çš„å†™æ³•ï¼ŒåŠ ä¸Šï¼š\n1 2 extern int sys_whoami(); extern int sys_iam(); ä¸ç„¶ï¼Œç¼–è¯‘ä¼šå‡ºé”™çš„ã€‚\n4.3 å®ç° sys_iam() å’Œ sys_whoami() æ·»åŠ ç³»ç»Ÿè°ƒç”¨çš„æœ€åä¸€æ­¥ï¼Œæ˜¯åœ¨å†…æ ¸ä¸­å®ç°å‡½æ•° sys_iam() å’Œ sys_whoami()ã€‚\næ¯ä¸ªç³»ç»Ÿè°ƒç”¨éƒ½æœ‰ä¸€ä¸ª sys_xxxxxx() ä¸ä¹‹å¯¹åº”ï¼Œå®ƒä»¬éƒ½æ˜¯æˆ‘ä»¬å­¦ä¹ å’Œæ¨¡ä»¿çš„å¥½å¯¹è±¡ã€‚\næ¯”å¦‚åœ¨ fs/open.c ä¸­çš„ sys_close(int fd)ï¼š\n1 2 3 4 5 int sys_close(unsigned int fd) { // â€¦â€¦ return (0); } å®ƒæ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œéƒ½æ˜¯å®å®åœ¨åœ¨åœ°åš close() è¯¥åšçš„äº‹æƒ…ã€‚\næ‰€ä»¥åªè¦è‡ªå·±åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼škernel/who.cï¼Œç„¶åå®ç°ä¸¤ä¸ªå‡½æ•°å°±ä¸‡äº‹å¤§å‰äº†ã€‚\nå¦‚æœå®Œå…¨æ²¡æœ‰å®ç°çš„æ€è·¯ï¼Œä¸å¿…æ‹…å¿ƒï¼Œæœ¬å®éªŒçš„ â€œ6.7 åœ¨ç”¨æˆ·æ€å’Œæ ¸å¿ƒæ€ä¹‹é—´ä¼ é€’æ•°æ®â€ è¿˜ä¼šæœ‰æç¤ºã€‚\n4.4 ä¿®æ”¹ Makefile è¦æƒ³è®©æˆ‘ä»¬æ·»åŠ çš„ kernel/who.c å¯ä»¥å’Œå…¶å®ƒ Linux ä»£ç ç¼–è¯‘é“¾æ¥åˆ°ä¸€èµ·ï¼Œå¿…é¡»è¦ä¿®æ”¹ Makefile æ–‡ä»¶ã€‚\nMakefile é‡Œè®°å½•çš„æ˜¯æ‰€æœ‰æºç¨‹åºæ–‡ä»¶çš„ç¼–è¯‘ã€é“¾æ¥è§„åˆ™ï¼Œã€Šæ³¨é‡Šã€‹3.6 èŠ‚æœ‰ç®€ç•¥ä»‹ç»ã€‚æˆ‘ä»¬ä¹‹æ‰€ä»¥ç®€å•åœ°è¿è¡Œ make å°±å¯ä»¥ç¼–è¯‘æ•´ä¸ªä»£ç æ ‘ï¼Œæ˜¯å› ä¸º make å®Œå…¨æŒ‰ç…§ Makefile é‡Œçš„æŒ‡ç¤ºå·¥ä½œã€‚\nå¦‚æœæƒ³è¦æ·±å…¥å­¦ä¹  Makefileï¼Œå¯ä»¥é€‰æ‹©å®éªŒæ¥¼çš„è¯¾ç¨‹ï¼š ã€ŠMakefile åŸºç¡€æ•™ç¨‹ã€‹ã€ã€Šè·Ÿæˆ‘ä¸€èµ·æ¥ç©è½¬ Makefileã€‹ã€‚\nMakefile åœ¨ä»£ç æ ‘ä¸­æœ‰å¾ˆå¤šï¼Œåˆ†åˆ«è´Ÿè´£ä¸åŒæ¨¡å—çš„ç¼–è¯‘å·¥ä½œã€‚æˆ‘ä»¬è¦ä¿®æ”¹çš„æ˜¯ kernel/Makefileã€‚éœ€è¦ä¿®æ”¹ä¸¤å¤„ã€‚\nï¼ˆ1ï¼‰ç¬¬ä¸€å¤„ 1 2 3 OBJS = sched.o system_call.o traps.o asm.o fork.o \\ panic.o printk.o vsprintf.o sys.o exit.o \\ signal.o mktime.o æ”¹ä¸ºï¼š\n1 2 3 OBJS = sched.o system_call.o traps.o asm.o fork.o \\ panic.o printk.o vsprintf.o sys.o exit.o \\ signal.o mktime.o who.o æ·»åŠ äº† who.oã€‚\nï¼ˆ2ï¼‰ç¬¬äºŒå¤„ 1 2 3 4 5 6 ### Dependencies: exit.s exit.o: exit.c ../include/errno.h ../include/signal.h \\ ../include/sys/types.h ../include/sys/wait.h ../include/linux/sched.h \\ ../include/linux/head.h ../include/linux/fs.h ../include/linux/mm.h \\ ../include/linux/kernel.h ../include/linux/tty.h ../include/termios.h \\ ../include/asm/segment.h æ”¹ä¸ºï¼š\n1 2 3 4 5 6 7 ### Dependencies: who.s who.o: who.c ../include/linux/kernel.h ../include/unistd.h exit.s exit.o: exit.c ../include/errno.h ../include/signal.h \\ ../include/sys/types.h ../include/sys/wait.h ../include/linux/sched.h \\ ../include/linux/head.h ../include/linux/fs.h ../include/linux/mm.h \\ ../include/linux/kernel.h ../include/linux/tty.h ../include/termios.h \\ ../include/asm/segment.h æ·»åŠ äº† who.s who.o: who.c ../include/linux/kernel.h ../include/unistd.hã€‚\nMakefile ä¿®æ”¹åï¼Œå’Œå¾€å¸¸ä¸€æ · make all å°±èƒ½è‡ªåŠ¨æŠŠ who.c åŠ å…¥åˆ°å†…æ ¸ä¸­äº†ã€‚\nå¦‚æœç¼–è¯‘æ—¶æç¤º who.c æœ‰é”™è¯¯ï¼Œå°±è¯´æ˜ä¿®æ”¹ç”Ÿæ•ˆäº†ã€‚æ‰€ä»¥ï¼Œæœ‰æ„æˆ–æ— æ„åœ°åˆ¶é€ ä¸€ä¸¤ä¸ªé”™è¯¯ä¹Ÿä¸å®Œå…¨æ˜¯åäº‹ï¼Œè‡³å°‘èƒ½è¯æ˜ Makefile æ˜¯å¯¹çš„ã€‚\n4.5 ç”¨ printk() è°ƒè¯•å†…æ ¸ oslab å®éªŒç¯å¢ƒæä¾›äº†åŸºäº C è¯­è¨€å’Œæ±‡ç¼–è¯­è¨€çš„ä¸¤ç§è°ƒè¯•æ‰‹æ®µã€‚é™¤æ­¤ä¹‹å¤–ï¼Œé€‚å½“åœ°å‘å±å¹•è¾“å‡ºä¸€äº›ç¨‹åºè¿è¡ŒçŠ¶æ€çš„ä¿¡æ¯ï¼Œä¹Ÿæ˜¯ä¸€ç§å¾ˆé«˜æ•ˆã€ä¾¿æ·çš„è°ƒè¯•æ–¹æ³•ï¼Œæœ‰æ—¶ç”šè‡³æ˜¯å”¯ä¸€çš„æ–¹æ³•ï¼Œè¢«ç§°ä¸ºâ€œprintf æ³•â€ã€‚\nè¦çŸ¥é“åˆ°ï¼Œprintf() æ˜¯ä¸€ä¸ªåªèƒ½åœ¨ç”¨æˆ·æ¨¡å¼ä¸‹æ‰§è¡Œçš„å‡½æ•°ï¼Œè€Œç³»ç»Ÿè°ƒç”¨æ˜¯åœ¨å†…æ ¸æ¨¡å¼ä¸­è¿è¡Œï¼Œæ‰€ä»¥ printf() ä¸å¯ç”¨ï¼Œè¦ç”¨ printk()ã€‚\nprintk() å’Œ printf() çš„æ¥å£å’ŒåŠŸèƒ½åŸºæœ¬ç›¸åŒï¼Œåªæ˜¯ä»£ç ä¸Šæœ‰ä¸€ç‚¹ç‚¹ä¸åŒã€‚printk() éœ€è¦ç‰¹åˆ«å¤„ç†ä¸€ä¸‹ fs å¯„å­˜å™¨ï¼Œå®ƒæ˜¯ä¸“ç”¨äºç”¨æˆ·æ¨¡å¼çš„æ®µå¯„å­˜å™¨ã€‚\nçœ‹ä¸€çœ‹ printk çš„ä»£ç ï¼ˆåœ¨ kernel/printk.c ä¸­ï¼‰å°±çŸ¥é“äº†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 int printk(const char *fmt, ...) { // â€¦â€¦ __asm__(\"push %%fs\\n\\t\" \"push %%ds\\n\\t\" \"pop %%fs\\n\\t\" \"pushl %0\\n\\t\" \"pushl $buf\\n\\t\" \"pushl $0\\n\\t\" \"call tty_write\\n\\t\" \"addl $8,%%esp\\n\\t\" \"popl %0\\n\\t\" \"pop %%fs\" ::\"r\" (i):\"ax\",\"cx\",\"dx\"); // â€¦â€¦ } æ˜¾ç„¶ï¼Œprintk() é¦–å…ˆ push %fs ä¿å­˜è¿™ä¸ªæŒ‡å‘ç”¨æˆ·æ®µçš„å¯„å­˜å™¨ï¼Œåœ¨æœ€å pop %fs å°†å…¶æ¢å¤ï¼Œprintk() çš„æ ¸å¿ƒä»ç„¶æ˜¯è°ƒç”¨ tty_write()ã€‚æŸ¥çœ‹ printf() å¯ä»¥çœ‹åˆ°ï¼Œå®ƒæœ€ç»ˆä¹Ÿè¦è½å®åˆ°è¿™ä¸ªå‡½æ•°ä¸Šã€‚\n4.6 ç¼–å†™æµ‹è¯•ç¨‹åº æ¿€åŠ¨åœ°è¿è¡Œä¸€ä¸‹ç”±ä½ äº²æ‰‹ä¿®æ”¹è¿‡çš„ â€œLinux 0.11 pro++â€ï¼ç„¶åç¼–å†™ä¸€ä¸ªç®€å•çš„åº”ç”¨ç¨‹åºè¿›è¡Œæµ‹è¯•ã€‚\næ¯”å¦‚åœ¨ sys_iam() ä¸­å‘ç»ˆç«¯ printk() ä¸€äº›ä¿¡æ¯ï¼Œè®©åº”ç”¨ç¨‹åºè°ƒç”¨ iam()ï¼Œä»ç»“æœå¯ä»¥çœ‹å‡ºç³»ç»Ÿè°ƒç”¨æ˜¯å¦è¢«çœŸçš„è°ƒç”¨åˆ°äº†ã€‚\nå¯ä»¥ç›´æ¥åœ¨ Linux 0.11 ç¯å¢ƒä¸‹ç”¨ vi ç¼–å†™ï¼ˆåˆ«å¿˜äº†ç»å¸¸æ‰§è¡Œâ€œsyncâ€ä»¥ç¡®ä¿å†…å­˜ç¼“å†²åŒºçš„æ•°æ®å†™å…¥ç£ç›˜ï¼‰ï¼Œä¹Ÿå¯ä»¥åœ¨ Ubuntu æˆ– Windows ä¸‹ç¼–å®Œåå†ä¼ åˆ° Linux 0.11 ä¸‹ã€‚æ— è®ºå¦‚ä½•ï¼Œæœ€ç»ˆéƒ½å¿…é¡»åœ¨ Linux 0.11 ä¸‹ç¼–è¯‘ã€‚ç¼–è¯‘å‘½ä»¤æ˜¯ï¼š\n1 $ gcc -o iam iam.c -Wall gcc çš„ â€œ-Wallâ€ å‚æ•°æ˜¯ç»™å‡ºæ‰€æœ‰çš„ç¼–è¯‘è­¦å‘Šä¿¡æ¯ï¼Œâ€œ-oâ€ å‚æ•°æŒ‡å®šç”Ÿæˆçš„æ‰§è¡Œæ–‡ä»¶åæ˜¯ iamï¼Œç”¨ä¸‹é¢å‘½ä»¤è¿è¡Œå®ƒï¼š\n1 $ ./iam å¦‚æœå¦‚æ„¿è¾“å‡ºäº†ä½ çš„ä¿¡æ¯ï¼Œå°±è¯´æ˜ä½ æ·»åŠ çš„ç³»ç»Ÿè°ƒç”¨ç”Ÿæ•ˆäº†ã€‚å¦åˆ™ï¼Œå°±è¿˜è¦ç»§ç»­è°ƒè¯•ï¼Œç¥ä½ å¥½è¿ï¼\n4.7 åœ¨ç”¨æˆ·æ€å’Œæ ¸å¿ƒæ€ä¹‹é—´ä¼ é€’æ•°æ® æŒ‡é’ˆå‚æ•°ä¼ é€’çš„æ˜¯åº”ç”¨ç¨‹åºæ‰€åœ¨åœ°å€ç©ºé—´çš„é€»è¾‘åœ°å€ï¼Œåœ¨å†…æ ¸ä¸­å¦‚æœç›´æ¥è®¿é—®è¿™ä¸ªåœ°å€ï¼Œè®¿é—®åˆ°çš„æ˜¯å†…æ ¸ç©ºé—´ä¸­çš„æ•°æ®ï¼Œä¸ä¼šæ˜¯ç”¨æˆ·ç©ºé—´çš„ã€‚æ‰€ä»¥è¿™é‡Œè¿˜éœ€è¦ä¸€ç‚¹å„¿ç‰¹æ®Šå·¥ä½œï¼Œæ‰èƒ½åœ¨å†…æ ¸ä¸­ä»ç”¨æˆ·ç©ºé—´å¾—åˆ°æ•°æ®ã€‚\nè¦å®ç°çš„ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨å‚æ•°ä¸­éƒ½æœ‰å­—ç¬¦ä¸²æŒ‡é’ˆï¼Œéå¸¸åƒ open(char *filename, â€¦â€¦)ï¼Œæ‰€ä»¥æˆ‘ä»¬çœ‹ä¸€ä¸‹ open() ç³»ç»Ÿè°ƒç”¨æ˜¯å¦‚ä½•å¤„ç†çš„ã€‚\n1 2 3 4 5 6 7 8 9 int open(const char * filename, int flag, ...) { // â€¦â€¦ __asm__(\"int $0x80\" :\"=a\" (res) :\"0\" (__NR_open),\"b\" (filename),\"c\" (flag), \"d\" (va_arg(arg,int))); // â€¦â€¦ } å¯ä»¥çœ‹å‡ºï¼Œç³»ç»Ÿè°ƒç”¨æ˜¯ç”¨ eaxã€ebxã€ecxã€edx å¯„å­˜å™¨æ¥ä¼ é€’å‚æ•°çš„ã€‚\nå…¶ä¸­ eax ä¼ é€’äº†ç³»ç»Ÿè°ƒç”¨å·ï¼Œè€Œ ebxã€ecxã€edx æ˜¯ç”¨æ¥ä¼ é€’å‡½æ•°çš„å‚æ•°çš„ ebx å¯¹åº”ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œecx å¯¹åº”ç¬¬äºŒä¸ªå‚æ•°ï¼Œä¾æ­¤ç±»æ¨ã€‚ å¦‚ open æ‰€ä¼ é€’çš„æ–‡ä»¶åæŒ‡é’ˆæ˜¯ç”± ebx ä¼ é€’çš„ï¼Œä¹Ÿå³è¿›å…¥å†…æ ¸åï¼Œé€šè¿‡ ebx å–å‡ºæ–‡ä»¶åå­—ç¬¦ä¸²ã€‚open çš„ ebx æŒ‡å‘çš„æ•°æ®åœ¨ç”¨æˆ·ç©ºé—´ï¼Œè€Œå½“å‰æ‰§è¡Œçš„æ˜¯å†…æ ¸ç©ºé—´çš„ä»£ç ï¼Œå¦‚ä½•åœ¨ç”¨æˆ·æ€å’Œæ ¸å¿ƒæ€ä¹‹é—´ä¼ é€’æ•°æ®ï¼Ÿ\næ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­çœ‹çœ‹ open çš„å¤„ç†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 system_call: //æ‰€æœ‰çš„ç³»ç»Ÿè°ƒç”¨éƒ½ä»system_callå¼€å§‹ ! â€¦â€¦ pushl %edx pushl %ecx pushl %ebx # push %ebx,%ecx,%edxï¼Œè¿™æ˜¯ä¼ é€’ç»™ç³»ç»Ÿè°ƒç”¨çš„å‚æ•° movl $0x10,%edx # è®©ds,esæŒ‡å‘GDTï¼ŒæŒ‡å‘æ ¸å¿ƒåœ°å€ç©ºé—´ mov %dx,%ds mov %dx,%es movl $0x17,%edx # è®©fsæŒ‡å‘çš„æ˜¯LDTï¼ŒæŒ‡å‘ç”¨æˆ·åœ°å€ç©ºé—´ mov %dx,%fs call sys_call_table(,%eax,4) # å³call sys_open ç”±ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œè·å–ç”¨æˆ·åœ°å€ç©ºé—´ï¼ˆç”¨æˆ·æ•°æ®æ®µï¼‰ä¸­çš„æ•°æ®ä¾é çš„å°±æ˜¯æ®µå¯„å­˜å™¨ fsï¼Œä¸‹é¢è¯¥è½¬åˆ° sys_open æ‰§è¡Œäº†ï¼Œåœ¨ fs/open.c æ–‡ä»¶ä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 int sys_open(const char * filename,int flag,int mode) //filenameè¿™äº›å‚æ•°ä»å“ªé‡Œæ¥ï¼Ÿ /*æ˜¯å¦è®°å¾—ä¸Šé¢çš„pushl %edx, pushl %ecx, pushl %ebxï¼Ÿ å®é™…ä¸Šä¸€ä¸ªCè¯­è¨€å‡½æ•°è°ƒç”¨å¦ä¸€ä¸ªCè¯­è¨€å‡½æ•°æ—¶ï¼Œç¼–è¯‘æ—¶å°±æ˜¯å°†è¦ ä¼ é€’çš„å‚æ•°å‹å…¥æ ˆä¸­ï¼ˆç¬¬ä¸€ä¸ªå‚æ•°æœ€åå‹ï¼Œâ€¦ï¼‰ï¼Œç„¶åcall â€¦ï¼Œ æ‰€ä»¥æ±‡ç¼–ç¨‹åºè°ƒç”¨Cå‡½æ•°æ—¶ï¼Œéœ€è¦è‡ªå·±ç¼–å†™è¿™äº›å‚æ•°å‹æ ˆçš„ä»£ç â€¦*/ { â€¦â€¦ if ((i=open_namei(filename,flag,mode,\u0026inode))\u003c0) { â€¦â€¦ } â€¦â€¦ } å®ƒå°†å‚æ•°ä¼ ç»™äº† open_namei()ã€‚\nå†æ²¿ç€ open_namei() ç»§ç»­æŸ¥æ‰¾ï¼Œæ–‡ä»¶åå…ˆååˆè¢«ä¼ ç»™dir_namei()ã€get_dir()ã€‚\nåœ¨ get_dir() ä¸­å¯ä»¥çœ‹åˆ°ï¼š\n1 2 3 4 5 6 7 8 static struct m_inode * get_dir(const char * pathname) { â€¦â€¦ if ((c=get_fs_byte(pathname))=='/') { â€¦â€¦ } â€¦â€¦ } å¤„ç†æ–¹æ³•å°±å¾ˆæ˜¾ç„¶äº†ï¼šç”¨ get_fs_byte() è·å¾—ä¸€ä¸ªå­—èŠ‚çš„ç”¨æˆ·ç©ºé—´ä¸­çš„æ•°æ®ã€‚\næ‰€ä»¥ï¼Œåœ¨å®ç° iam() æ—¶ï¼Œè°ƒç”¨ get_fs_byte() å³å¯ã€‚\nä½†å¦‚ä½•å®ç° whoami() å‘¢ï¼Ÿå³å¦‚ä½•å®ç°ä»æ ¸å¿ƒæ€æ‹·è´æ•°æ®åˆ°ç”¨å¿ƒæ€å†…å­˜ç©ºé—´ä¸­å‘¢ï¼Ÿ\nçŒœä¸€çŒœï¼Œæ˜¯å¦æœ‰ put_fs_byte()ï¼Ÿæœ‰ï¼çœ‹ä¸€çœ‹ include/asm/segment.h ï¼š\n1 2 3 4 5 6 7 8 9 10 extern inline unsigned char get_fs_byte(const char * addr) { unsigned register char _v; __asm__ (\"movb %%fs:%1,%0\":\"=r\" (_v):\"m\" (*addr)); return _v; } extern inline void put_fs_byte(char val,char *addr) { __asm__ (\"movb %0,%%fs:%1\"::\"r\" (val),\"m\" (*addr)); } ä»–ä¿©ä»¥åŠæ‰€æœ‰ put_fs_xxx() å’Œ get_fs_xxx() éƒ½æ˜¯ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ä¹‹é—´çš„æ¡¥æ¢ï¼Œåœ¨åé¢çš„å®éªŒä¸­è¿˜è¦ç»å¸¸ç”¨åˆ°ã€‚\n4.8 è¿è¡Œè„šæœ¬ç¨‹åº Linux çš„ä¸€å¤§ç‰¹è‰²æ˜¯å¯ä»¥ç¼–å†™åŠŸèƒ½å¼ºå¤§çš„ shell è„šæœ¬ï¼Œæé«˜å·¥ä½œæ•ˆç‡ã€‚æœ¬å®éªŒçš„éƒ¨åˆ†è¯„åˆ†å·¥ä½œç”±è„šæœ¬ testlab2.sh å®Œæˆã€‚å®ƒçš„åŠŸèƒ½æ˜¯æµ‹è¯• iam.c å’Œ whoami.cã€‚\né¦–å…ˆå°† iam.c å’Œ whoami.c åˆ†åˆ«ç¼–è¯‘æˆ iam å’Œ whoamiï¼Œç„¶åå°† testlab2.shï¼ˆåœ¨ /home/teacher ç›®å½•ä¸‹ï¼‰ æ‹·è´åˆ°åŒä¸€ç›®å½•ä¸‹ã€‚\nç”¨ä¸‹é¢å‘½ä»¤ä¸ºæ­¤è„šæœ¬å¢åŠ æ‰§è¡Œæƒé™ï¼š\n1 $ chmod +x testlab2.sh ç„¶åè¿è¡Œä¹‹ï¼š\n1 $ ./testlab2.sh æ ¹æ®è¾“å‡ºï¼Œå¯çŸ¥ iam.c å’Œ whoami.c çš„å¾—åˆ†ã€‚\nerrno errno æ˜¯ä¸€ç§ä¼ ç»Ÿçš„é”™è¯¯ä»£ç è¿”å›æœºåˆ¶ã€‚\nå½“ä¸€ä¸ªå‡½æ•°è°ƒç”¨å‡ºé”™æ—¶ï¼Œé€šå¸¸ä¼šè¿”å› -1 ç»™è°ƒç”¨è€…ã€‚ä½† -1 åªèƒ½è¯´æ˜å‡ºé”™ï¼Œä¸èƒ½è¯´æ˜é”™æ˜¯ä»€ä¹ˆã€‚ä¸ºè§£å†³æ­¤é—®é¢˜ï¼Œå…¨å±€å˜é‡ errno ç™»åœºäº†ã€‚é”™è¯¯å€¼è¢«å­˜æ”¾åˆ° errno ä¸­ï¼Œäºæ˜¯è°ƒç”¨è€…å°±å¯ä»¥é€šè¿‡åˆ¤æ–­ errno æ¥å†³å®šå¦‚ä½•åº”å¯¹é”™è¯¯äº†ã€‚\nå„ç§ç³»ç»Ÿå¯¹ errno çš„å€¼çš„å«ä¹‰éƒ½æœ‰æ ‡å‡†å®šä¹‰ã€‚Linux ä¸‹ç”¨â€œman errnoâ€å¯ä»¥çœ‹åˆ°è¿™äº›å®šä¹‰ã€‚\n5. å®éªŒæ­¥éª¤ 1.æ·»åŠ å®å®šä¹‰ é¦–å…ˆæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿï¼Œç„¶ååœ¨æ­¤æ–‡ä»¶ç³»ç»Ÿå†…è¿›è¡Œç¼–è¾‘ æŒ‚è½½å‘½ä»¤ï¼šsudo ./mount-hdc é¦–å…ˆæ‰¾åˆ°unistd.hå¤´æ–‡ä»¶ï¼Œæ­¤æ–‡ä»¶åœ¨includeå­ç›®å½•å†…\næ‰“å¼€å®ƒå¹¶åœ¨å®å®šä¹‰å‡ºè¿½åŠ  __NR_whoami å’Œ __NR_iamä¸¤ä¸ªå®ï¼Œè¿½åŠ åçš„æ•ˆæœå¦‚ä¸‹\n2.æ·»åŠ ç”¨æˆ·ç©ºé—´æ¥å£å‡½æ•° åœ¨æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿå†…ï¼ˆåœ¨${OSLAB}/hdc/usr/root/ç›®å½•ä¸‹åˆ›å»ºï¼‰ä»»æ„ä½ç½®æ–°å¢ä»¥ä¸‹ä¸¤ä¸ªæ–‡ä»¶\niam()å‡½æ•°æ–‡ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 #define __LIBRARY__ #include #include #include #include _syscall1(int,iam,const char*,name) int main(int argc,char* argv[]) { if(argc\u003c=1) { printf(\"NO Input!(\u003e_\u003c)(\u003e_\u003c)(\u003e_\u003c)\\n\"); return -1; } else { if(iam(argv[1])\u003c0) { printf(\".........Sys Call Exception!(\u003e_\u003c)\\n\"); return -1; } } return 0; } whoami()å‡½æ•°æ–‡ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 #define __LIBRARY__ #include #include #include #include #define N 256 _syscall2(int,whoami,char*,name,unsigned int,size) int main() { int num; char temp[N]= {0}; num=whoami(temp,N); if(num \u003e= 0) { printf(\"%s\\n\",temp); } else { printf(\"num \u003c0 System Call Exception!(\u003e_\u003c)\"); return -1; } return 0; } æ–°å¢å®Œæˆåæ‰§è¡Œsudo umount hdcè§£é™¤æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½\n3.ä¿®æ”¹system_call.sæ–‡ä»¶ åœ¨è·¯å¾„/oslab/linux-0.11/kernelä¸‹\nä¿®æ”¹ç³»ç»Ÿè°ƒç”¨æ€»æ•°\n4.ä¿®æ”¹sys.hæ–‡ä»¶ è·¯å¾„ï¼š/oslab/linux-0.11/include/linux\nåœ¨å‡½æ•°è¡¨å†…å¢åŠ ä¸¤ä¸ªå¼•ç”¨ï¼Œä½ç½®éœ€è¦ä¸€ä¸€å¯¹åº”ã€‚\n1 2 extern int sys_whoami(); extern int sys_iam(); æ•ˆæœå¦‚ä¸‹\nsys_call_tableæ•°ç»„å†…åŠ å…¥sys_whoamiå’Œsys_iamï¼Œæ³¨æ„é¡ºåºä¸€è‡´\n5.åˆ›å»ºwho.cæ–‡ä»¶ æ¯ä¸ªç³»ç»Ÿè°ƒç”¨éƒ½æœ‰ä¸€ä¸ª sys_xxxxxx() ä¸ä¹‹å¯¹åº”ï¼Œæ‰€ä»¥å¢åŠ çš„ä¸¤ä¸ªå‡½æ•°è°ƒç”¨ä¹Ÿéœ€è¦æœ‰è¿™ç§å‡½æ•°ä¸å…¶å¯¹åº”\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 #define __LIBRARY__ #include #include #include char mem[80]= {0}; int sys_iam(const char* name) { int i=0; int j=0; while(get_fs_byte(name+i)!='\\0') { i++; } if(i\u003e=24) { return -EINVAL; } // else // { // printk(\"strlen(%s) = %d\\n\",mem,i); // } while((mem[j]=get_fs_byte(name+j))!='\\0') { j++; } printk(\"strlen(%s) = %d\\n\",mem,i); return j; } int sys_whoami(char* name,unsigned int size) { int i=0; int j=0; while (mem[i]!='\\0') { i++; } if (i\u003esize) { return -1; } while(mem[j]!='\\0') { put_fs_byte(mem[j],(name+j)); j++; } return j; } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 #include #include #include char _myname[24]; int sys_iam(const char *name) { char str[25]; int i = 0; do { str[i] = get_fs_byte(name + i); } while (i \u003c= 25 \u0026\u0026 str[i++] != '\\0'); if (i \u003e 24) { errno = EINVAL; i = -1; } else { strcpy(_myname, str); } return i; } int sys_whoami(char *name, unsigned int size) { int length = strlen(_myname); printk(\"%s\\n\", _myname); if (size \u003c length) { errno = EINVAL; length = -1; } else { int i = 0; for (i = 0; i \u003c length; i++) { put_fs_byte(_myname[i], name + i); } } return length; } å°†è¿™ä¸ªæ–‡ä»¶ä¿å­˜åœ¨kernelæ–‡ä»¶å¤¹ä¸‹\n6.ä¿®æ”¹Makefileæ–‡ä»¶ kernel/Makefile\næ‰¾åˆ°å¦‚ä¸‹å†…å®¹\n1 2 3 OBJS = sched.o system_call.o traps.o asm.o fork.o \\ panic.o printk.o vsprintf.o sys.o exit.o \\ signal.o mktime.o å¹¶æ›´æ”¹ä¸º\n1 2 3 OBJS = sched.o system_call.o traps.o asm.o fork.o \\ panic.o printk.o vsprintf.o sys.o exit.o \\ signal.o mktime.o who.o æ‰¾åˆ°å¦‚ä¸‹å†…å®¹\n1 2 3 4 5 6 ### Dependencies: exit.s exit.o: exit.c ../include/errno.h ../include/signal.h \\ ../include/sys/types.h ../include/sys/wait.h ../include/linux/sched.h \\ ../include/linux/head.h ../include/linux/fs.h ../include/linux/mm.h \\ ../include/linux/kernel.h ../include/linux/tty.h ../include/termios.h \\ ../include/asm/segment.h å¹¶æ›´æ”¹ä¸º\n1 2 3 4 5 6 7 ### Dependencies: who.s who.o: who.c ../include/linux/kernel.h ../include/unistd.h exit.s exit.o: exit.c ../include/errno.h ../include/signal.h \\ ../include/sys/types.h ../include/sys/wait.h ../include/linux/sched.h \\ ../include/linux/head.h ../include/linux/fs.h ../include/linux/mm.h \\ ../include/linux/kernel.h ../include/linux/tty.h ../include/termios.h \\ ../include/asm/segment.h ä¿®æ”¹å®Œæˆåæ‰§è¡Œmakeå‘½ä»¤å³å¯ã€‚\n7.è¿è¡Œæ›´æ”¹åçš„ç³»ç»Ÿ åœ¨oslabæ ¹ç›®å½•å†…è¾“å…¥**./run**å‘½ä»¤è¿›è¡Œè°ƒè¯• ç„¶åè¿›å…¥iam.cå’Œwhoami.cçš„ç›®å½•æ‰§è¡Œä¸‹åˆ—å‘½ä»¤\n1 2 gcc iam.c -o iam gcc whoami.c -o whoami é‡åˆ°çš„é—®é¢˜ ç¼–è¯‘å‡ºé”™ï¼š\né—®é¢˜å‡ºåœ¨å¤´æ–‡ä»¶ä¸Šé¢ï¼ï¼ï¼\n==åœ¨ 0.11 ç¯å¢ƒä¸‹ç¼–è¯‘ C ç¨‹åºï¼ŒåŒ…å«çš„å¤´æ–‡ä»¶éƒ½åœ¨ /usr/include ç›®å½•ä¸‹ã€‚==\nè¯¥ç›®å½•ä¸‹çš„ unistd.h æ˜¯æ ‡å‡†å¤´æ–‡ä»¶ï¼ˆå®ƒå’Œ 0.11 æºç æ ‘ä¸­çš„ unistd.h==å¹¶ä¸æ˜¯åŒä¸€ä¸ªæ–‡ä»¶==ï¼Œè™½ç„¶å†…å®¹å¯èƒ½ç›¸åŒï¼‰ï¼Œæ²¡æœ‰ __NR_whoami å’Œ __NR_iam ä¸¤ä¸ªå®ï¼Œéœ€è¦æ‰‹å·¥åŠ ä¸Šå®ƒä»¬ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä»ä¿®æ”¹è¿‡çš„ 0.11 æºç æ ‘ä¸­æ‹·è´æ–°çš„ unistd.h è¿‡æ¥ã€‚\nåœ¨å†…æ ¸ä¸­çš„ä»£ç åŒ…å«çš„å¤´æ–‡ä»¶æ˜¯åœ¨/usr/include ä¸‹æ‰¾çš„ï¼Œä½†æ˜¯æˆ‘æ²¡æœ‰åœ¨è¯¥ç›®å½•ä¸‹çš„unistd.hä¿®æ”¹ï¼Œæ‰€ä»¥ä¸€ç›´æç¤ºæ‰¾ä¸åˆ°å¤´æ–‡ä»¶ä¸­å®šä¹‰çš„å‡½æ•°\næŠŠlinux-0.11/include/unistd.hæ‹·è´åˆ°hdc/usr/includeä¸‹\nå†æ¬¡ç¼–è¯‘ï¼Œå°±æ²¡æŠ¥é”™äº†ï¼ˆç¼–è¯‘å®Œåè¦syncï¼‰ ä¸ç„¶ç¼–è¯‘åçš„æ–‡ä»¶å…³æ‰åå†æ‰“å¼€å°±ä¸è§äº†\n1 2 3 4 gcc iam.c -o iam gcc whoami.c -o whoami sync ç»“æœï¼š\næœ€åæ‰§è¡Œå¯æ‰§è¡Œæ–‡ä»¶iamå’Œwhoamiè¿›è¡Œæµ‹è¯• iamæµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š\nwhoamiæµ‹è¯•ç»“æœå¦‚ä¸‹:\n6. å®éªŒæŠ¥å‘Š é—®é¢˜ä¸€ Linux-0.11çš„ç³»ç»Ÿè°ƒç”¨é€šè¿‡å¯„å­˜å™¨ebxã€ecxã€edxä¼ é€’å‚æ•°ï¼Œæœ€å¤šèƒ½ä¼ é€’3ä¸ªå‚æ•°ã€‚ æ‰©å¤§ä¼ é€’å‚æ•°çš„æ•°é‡çš„æ–¹æ³•ï¼š\nå¢åŠ ä¼ å‚æ‰€ç”¨çš„å¯„å­˜å™¨ï¼› åˆ©ç”¨è‡ªå®šä¹‰çš„ç»“æ„ä½“è¾…åŠ©å‚æ•°çš„ä¼ é€’ï¼ˆcè¯­è¨€ç»“æ„ä½“ï¼‰ï¼› å°†å¯„å­˜å™¨æ‹†åˆ†ä¸ºé«˜ä½å’Œä½ä½ä¼ é€’ä¸€ç›´æ¯”è¾ƒå°çš„å‚æ•°ï¼› åˆ©ç”¨å †æ ˆä¼ é€’å‚æ•°ã€‚ é—®é¢˜äºŒ 1.åœ¨include/unistd.hä¸­å®šä¹‰å®__NR_fooï¼Œå¹¶æ·»åŠ ä¾›ç”¨æˆ·è°ƒç”¨çš„å‡½æ•°å£°æ˜void foo()ï¼›\n2.ä¿®æ”¹kernel/system_call.sä¸­çš„nr_system_callsï¼Œå¢åŠ æ–°çš„ç³»ç»Ÿè°ƒç”¨ï¼›\n3.åœ¨include/linux/sys.hä¸­æ·»åŠ å‡½æ•°å£°æ˜extern void sys_foo()ï¼Œåœ¨ç³»ç»Ÿè°ƒç”¨å…¥å£è¡¨fn_ptræœ«ç«¯æ·»åŠ å…ƒç´ sys_fooï¼›\n4.æ·»åŠ kernel/foo.cæ–‡ä»¶ï¼Œå®ç°sys_foo()å‡½æ•°ï¼›\n5.ä¿®æ”¹kernel/Makefileï¼Œåœ¨OBJSä¸­åŠ å…¥foo.oï¼Œå¹¶æ·»åŠ ç”Ÿæˆfoo.sã€foo.oçš„ä¾èµ–è§„åˆ™ï¼›\n6.é‡æ–°æ‰§è¡Œmakeå‘½ä»¤ï¼Œå¹¶è¿›å…¥æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿå†…è¿›è¡Œç¼–è¯‘æµ‹è¯•ã€‚\n",
  "wordCount" : "7258",
  "inLanguage": "zh",
  "datePublished": "2022-05-18T00:00:00Z",
  "dateModified": "2022-05-18T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "chance7bin"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://chance7bin.github.io/posts/basic/os-lab/%E5%AE%9E%E9%AA%8C3-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Binb's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://chance7bin.github.io/" accesskey="h" title="Binb&#39;s Blog (Alt + H)">
                <img src="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg" alt="" aria-label="logo"
                    height="35">Binb&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://chance7bin.github.io/search" title="ğŸ”æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ”æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="https://chance7bin.github.io/" title="ğŸ  ä¸»é¡µ">
                    <span>ğŸ  ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://chance7bin.github.io/archives/" title="â±ï¸ æ—¶é—´è½´">
                    <span>â±ï¸ æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://chance7bin.github.io/posts" title="ğŸ“š æ–‡ç« ">
                    <span>ğŸ“š æ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://chance7bin.github.io/tags" title="ğŸ”– æ ‡ç­¾">
                    <span>ğŸ”– æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://github.com/chance7bin" title="GitHub">
                    <span>GitHub</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://chance7bin.github.io/">ğŸ  ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://chance7bin.github.io/posts/">ğŸ“š æ–‡ç« </a>&nbsp;Â»&nbsp;<a href="https://chance7bin.github.io/posts/basic/">ğŸ“• è®¡ç®—æœºåŸºç¡€</a>&nbsp;Â»&nbsp;<a href="https://chance7bin.github.io/posts/basic/os-lab/">hit-oslab</a></div>
    <h1 class="post-title">
      å®éªŒ3 ç³»ç»Ÿè°ƒç”¨
    </h1>
    <div class="post-meta">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">


<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }

    .parent-post-meta {
        display: flex;
        flex-wrap: wrap;
        opacity: 0.8;
    }
</style>

<span class="parent-post-meta">
    <span id="post_meta_style_1">
        <span class="fa fa-calendar-check-o"></span>
        <span>2022-05-18
            &nbsp;&nbsp;
        </span>
    </span>
    
    
    
    
    
    
    
    <span id="post_meta_style_3">
        <span class="fa fa-file-word-o"></span>
        <span>7258å­—
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_4">
        <span class="fa fa-clock-o"></span>
        <span>15åˆ†é’Ÿ
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_5">
        <span class="fa fa-user-o"></span>
        <span>chance7bin
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_6">
        <span class="fa fa-tags" style="opacity: 0.8"></span>
        <span>
            <span class="post-tags-meta">
                <a href="https://chance7bin.github.io/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="color: var(--secondary)!important;">æ“ä½œç³»ç»Ÿ</a>
                &nbsp;<a href="https://chance7bin.github.io/tags/%E5%AE%9E%E9%AA%8C/" style="color: var(--secondary)!important;">å®éªŒ</a>
            </span>
        </span>
    </span>

    
</span>


      
      
      
      
      
      
      
          
          
          
              
              
              
              
          
      
    </div>
  </header>
   <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#1-%e5%ae%9e%e9%aa%8c%e7%9b%ae%e7%9a%84" aria-label="1. å®éªŒç›®çš„">1. å®éªŒç›®çš„</a></li>
                    <li>
                        <a href="#2-%e5%ae%9e%e9%aa%8c%e5%86%85%e5%ae%b9" aria-label="2. å®éªŒå†…å®¹">2. å®éªŒå†…å®¹</a><ul>
                            
                    <li>
                        <a href="#1iam" aria-label="ï¼ˆ1ï¼‰iam()">ï¼ˆ1ï¼‰<code>iam()</code></a></li>
                    <li>
                        <a href="#2whoami" aria-label="ï¼ˆ2ï¼‰whoami()">ï¼ˆ2ï¼‰<code>whoami()</code></a></li>
                    <li>
                        <a href="#3%e6%b5%8b%e8%af%95%e7%a8%8b%e5%ba%8f" aria-label="ï¼ˆ3ï¼‰æµ‹è¯•ç¨‹åº">ï¼ˆ3ï¼‰æµ‹è¯•ç¨‹åº</a></li></ul>
                    </li>
                    <li>
                        <a href="#3-%e5%ae%9e%e9%aa%8c%e6%8a%a5%e5%91%8a" aria-label="3. å®éªŒæŠ¥å‘Š">3. å®éªŒæŠ¥å‘Š</a></li>
                    <li>
                        <a href="#4-%e5%ae%9e%e9%aa%8c%e6%8f%90%e7%a4%ba" aria-label="4. å®éªŒæç¤º">4. å®éªŒæç¤º</a><ul>
                            
                    <li>
                        <a href="#41-%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f%e5%a6%82%e4%bd%95%e8%b0%83%e7%94%a8%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8" aria-label="4.1 åº”ç”¨ç¨‹åºå¦‚ä½•è°ƒç”¨ç³»ç»Ÿè°ƒç”¨">4.1 åº”ç”¨ç¨‹åºå¦‚ä½•è°ƒç”¨ç³»ç»Ÿè°ƒç”¨</a></li>
                    <li>
                        <a href="#42-%e4%bb%8eint-0x80%e8%bf%9b%e5%85%a5%e5%86%85%e6%a0%b8%e5%87%bd%e6%95%b0" aria-label="4.2 ä»â€œint 0x80â€è¿›å…¥å†…æ ¸å‡½æ•°">4.2 ä»â€œint 0x80â€è¿›å…¥å†…æ ¸å‡½æ•°</a></li>
                    <li>
                        <a href="#43-%e5%ae%9e%e7%8e%b0-sys_iam-%e5%92%8c-sys_whoami" aria-label="4.3 å®ç° sys_iam() å’Œ sys_whoami()">4.3 å®ç° sys_iam() å’Œ sys_whoami()</a></li>
                    <li>
                        <a href="#44-%e4%bf%ae%e6%94%b9-makefile" aria-label="4.4 ä¿®æ”¹ Makefile">4.4 ä¿®æ”¹ Makefile</a><ul>
                            
                    <li>
                        <a href="#1%e7%ac%ac%e4%b8%80%e5%a4%84" aria-label="ï¼ˆ1ï¼‰ç¬¬ä¸€å¤„">ï¼ˆ1ï¼‰ç¬¬ä¸€å¤„</a></li>
                    <li>
                        <a href="#2%e7%ac%ac%e4%ba%8c%e5%a4%84" aria-label="ï¼ˆ2ï¼‰ç¬¬äºŒå¤„">ï¼ˆ2ï¼‰ç¬¬äºŒå¤„</a></li></ul>
                    </li>
                    <li>
                        <a href="#45-%e7%94%a8-printk-%e8%b0%83%e8%af%95%e5%86%85%e6%a0%b8" aria-label="4.5 ç”¨ printk() è°ƒè¯•å†…æ ¸">4.5 ç”¨ printk() è°ƒè¯•å†…æ ¸</a></li>
                    <li>
                        <a href="#46-%e7%bc%96%e5%86%99%e6%b5%8b%e8%af%95%e7%a8%8b%e5%ba%8f" aria-label="4.6 ç¼–å†™æµ‹è¯•ç¨‹åº">4.6 ç¼–å†™æµ‹è¯•ç¨‹åº</a></li>
                    <li>
                        <a href="#47-%e5%9c%a8%e7%94%a8%e6%88%b7%e6%80%81%e5%92%8c%e6%a0%b8%e5%bf%83%e6%80%81%e4%b9%8b%e9%97%b4%e4%bc%a0%e9%80%92%e6%95%b0%e6%8d%ae" aria-label="4.7 åœ¨ç”¨æˆ·æ€å’Œæ ¸å¿ƒæ€ä¹‹é—´ä¼ é€’æ•°æ®">4.7 åœ¨ç”¨æˆ·æ€å’Œæ ¸å¿ƒæ€ä¹‹é—´ä¼ é€’æ•°æ®</a></li>
                    <li>
                        <a href="#48-%e8%bf%90%e8%a1%8c%e8%84%9a%e6%9c%ac%e7%a8%8b%e5%ba%8f" aria-label="4.8 è¿è¡Œè„šæœ¬ç¨‹åº">4.8 è¿è¡Œè„šæœ¬ç¨‹åº</a><ul>
                            
                    <li>
                        <a href="#errno" aria-label="errno">errno</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#5-%e5%ae%9e%e9%aa%8c%e6%ad%a5%e9%aa%a4" aria-label="5. å®éªŒæ­¥éª¤">5. å®éªŒæ­¥éª¤</a><ul>
                            
                    <li>
                        <a href="#1%e6%b7%bb%e5%8a%a0%e5%ae%8f%e5%ae%9a%e4%b9%89" aria-label="1.æ·»åŠ å®å®šä¹‰">1.æ·»åŠ å®å®šä¹‰</a></li>
                    <li>
                        <a href="#2%e6%b7%bb%e5%8a%a0%e7%94%a8%e6%88%b7%e7%a9%ba%e9%97%b4%e6%8e%a5%e5%8f%a3%e5%87%bd%e6%95%b0" aria-label="2.æ·»åŠ ç”¨æˆ·ç©ºé—´æ¥å£å‡½æ•°">2.æ·»åŠ ç”¨æˆ·ç©ºé—´æ¥å£å‡½æ•°</a></li>
                    <li>
                        <a href="#3%e4%bf%ae%e6%94%b9system_calls%e6%96%87%e4%bb%b6" aria-label="3.ä¿®æ”¹system_call.sæ–‡ä»¶">3.ä¿®æ”¹system_call.sæ–‡ä»¶</a></li>
                    <li>
                        <a href="#4%e4%bf%ae%e6%94%b9sysh%e6%96%87%e4%bb%b6" aria-label="4.ä¿®æ”¹sys.hæ–‡ä»¶">4.ä¿®æ”¹sys.hæ–‡ä»¶</a></li>
                    <li>
                        <a href="#5%e5%88%9b%e5%bb%bawhoc%e6%96%87%e4%bb%b6" aria-label="5.åˆ›å»ºwho.cæ–‡ä»¶">5.åˆ›å»ºwho.cæ–‡ä»¶</a></li>
                    <li>
                        <a href="#6%e4%bf%ae%e6%94%b9makefile%e6%96%87%e4%bb%b6" aria-label="6.ä¿®æ”¹Makefileæ–‡ä»¶">6.ä¿®æ”¹Makefileæ–‡ä»¶</a></li>
                    <li>
                        <a href="#7%e8%bf%90%e8%a1%8c%e6%9b%b4%e6%94%b9%e5%90%8e%e7%9a%84%e7%b3%bb%e7%bb%9f" aria-label="7.è¿è¡Œæ›´æ”¹åçš„ç³»ç»Ÿ">7.è¿è¡Œæ›´æ”¹åçš„ç³»ç»Ÿ</a><ul>
                            
                    <li>
                        <a href="#%e9%81%87%e5%88%b0%e7%9a%84%e9%97%ae%e9%a2%98" aria-label="é‡åˆ°çš„é—®é¢˜"><code>é‡åˆ°çš„é—®é¢˜</code></a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#6-%e5%ae%9e%e9%aa%8c%e6%8a%a5%e5%91%8a" aria-label="6. å®éªŒæŠ¥å‘Š">6. å®éªŒæŠ¥å‘Š</a><ul>
                            
                    <li>
                        <a href="#%e9%97%ae%e9%a2%98%e4%b8%80" aria-label="é—®é¢˜ä¸€">é—®é¢˜ä¸€</a></li>
                    <li>
                        <a href="#%e9%97%ae%e9%a2%98%e4%ba%8c" aria-label="é—®é¢˜äºŒ">é—®é¢˜äºŒ</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>
  <div class="post-content"><h2 id="1-å®éªŒç›®çš„">1. å®éªŒç›®çš„<a hidden class="anchor" aria-hidden="true" href="#1-å®éªŒç›®çš„">#</a></h2>
<ul>
<li>å»ºç«‹å¯¹ç³»ç»Ÿè°ƒç”¨æ¥å£çš„æ·±å…¥è®¤è¯†ï¼›</li>
<li>æŒæ¡ç³»ç»Ÿè°ƒç”¨çš„åŸºæœ¬è¿‡ç¨‹ï¼›</li>
<li>èƒ½å®Œæˆç³»ç»Ÿè°ƒç”¨çš„å…¨é¢æ§åˆ¶ï¼›</li>
<li>ä¸ºåç»­å®éªŒåšå‡†å¤‡ã€‚</li>
</ul>
<h2 id="2-å®éªŒå†…å®¹">2. å®éªŒå†…å®¹<a hidden class="anchor" aria-hidden="true" href="#2-å®éªŒå†…å®¹">#</a></h2>
<p>æ­¤æ¬¡å®éªŒçš„åŸºæœ¬å†…å®¹æ˜¯ï¼šåœ¨ Linux 0.11 ä¸Šæ·»åŠ ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œå¹¶ç¼–å†™ä¸¤ä¸ªç®€å•çš„åº”ç”¨ç¨‹åºæµ‹è¯•å®ƒä»¬ã€‚</p>
<h3 id="1iam">ï¼ˆ1ï¼‰<code>iam()</code><a hidden class="anchor" aria-hidden="true" href="#1iam">#</a></h3>
<p>ç¬¬ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨æ˜¯ iam()ï¼Œå…¶åŸå‹ä¸ºï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">iam</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">name</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®Œæˆçš„åŠŸèƒ½æ˜¯å°†å­—ç¬¦ä¸²å‚æ•° <code>name</code> çš„å†…å®¹æ‹·è´åˆ°å†…æ ¸ä¸­ä¿å­˜ä¸‹æ¥ã€‚è¦æ±‚ <code>name</code> çš„é•¿åº¦ä¸èƒ½è¶…è¿‡ 23 ä¸ªå­—ç¬¦ã€‚è¿”å›å€¼æ˜¯æ‹·è´çš„å­—ç¬¦æ•°ã€‚å¦‚æœ <code>name</code> çš„å­—ç¬¦ä¸ªæ•°è¶…è¿‡äº† 23ï¼Œåˆ™è¿”å› â€œ-1â€ï¼Œå¹¶ç½® errno ä¸º EINVALã€‚</p>
<p>åœ¨ <code>kernal/who.c</code> ä¸­å®ç°æ­¤ç³»ç»Ÿè°ƒç”¨ã€‚</p>
<h3 id="2whoami">ï¼ˆ2ï¼‰<code>whoami()</code><a hidden class="anchor" aria-hidden="true" href="#2whoami">#</a></h3>
<p>ç¬¬äºŒä¸ªç³»ç»Ÿè°ƒç”¨æ˜¯ whoami()ï¼Œå…¶åŸå‹ä¸ºï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">whoami</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®ƒå°†å†…æ ¸ä¸­ç”± <code>iam()</code> ä¿å­˜çš„åå­—æ‹·è´åˆ° name æŒ‡å‘çš„ç”¨æˆ·åœ°å€ç©ºé—´ä¸­ï¼ŒåŒæ—¶ç¡®ä¿ä¸ä¼šå¯¹ <code>name</code> è¶Šç•Œè®¿å­˜ï¼ˆ<code>name</code> çš„å¤§å°ç”± <code>size</code> è¯´æ˜ï¼‰ã€‚è¿”å›å€¼æ˜¯æ‹·è´çš„å­—ç¬¦æ•°ã€‚å¦‚æœ <code>size</code> å°äºéœ€è¦çš„ç©ºé—´ï¼Œåˆ™è¿”å›â€œ-1â€ï¼Œå¹¶ç½® errno ä¸º EINVALã€‚</p>
<p>ä¹Ÿæ˜¯åœ¨ <code>kernal/who.c</code> ä¸­å®ç°ã€‚</p>
<h3 id="3æµ‹è¯•ç¨‹åº">ï¼ˆ3ï¼‰æµ‹è¯•ç¨‹åº<a hidden class="anchor" aria-hidden="true" href="#3æµ‹è¯•ç¨‹åº">#</a></h3>
<p>è¿è¡Œæ·»åŠ è¿‡æ–°ç³»ç»Ÿè°ƒç”¨çš„ Linux 0.11ï¼Œåœ¨å…¶ç¯å¢ƒä¸‹ç¼–å†™ä¸¤ä¸ªæµ‹è¯•ç¨‹åº iam.c å’Œ whoami.cã€‚æœ€ç»ˆçš„è¿è¡Œç»“æœæ˜¯ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ./iam lizhijun
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ ./whoami
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">lizhijun
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="3-å®éªŒæŠ¥å‘Š">3. å®éªŒæŠ¥å‘Š<a hidden class="anchor" aria-hidden="true" href="#3-å®éªŒæŠ¥å‘Š">#</a></h2>
<p>åœ¨å®éªŒæŠ¥å‘Šä¸­å›ç­”å¦‚ä¸‹é—®é¢˜ï¼š</p>
<ul>
<li>ä» Linux 0.11 ç°åœ¨çš„æœºåˆ¶çœ‹ï¼Œå®ƒçš„ç³»ç»Ÿè°ƒç”¨æœ€å¤šèƒ½ä¼ é€’å‡ ä¸ªå‚æ•°ï¼Ÿä½ èƒ½æƒ³å‡ºåŠæ³•æ¥æ‰©å¤§è¿™ä¸ªé™åˆ¶å—ï¼Ÿ</li>
<li>ç”¨æ–‡å­—ç®€è¦æè¿°å‘ Linux 0.11 æ·»åŠ ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ foo() çš„æ­¥éª¤ã€‚</li>
</ul>
<h2 id="4-å®éªŒæç¤º">4. å®éªŒæç¤º<a hidden class="anchor" aria-hidden="true" href="#4-å®éªŒæç¤º">#</a></h2>
<p>é¦–å…ˆï¼Œè¯·å°† Linux 0.11 çš„æºä»£ç æ¢å¤åˆ°åŸå§‹çŠ¶æ€ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># åˆ é™¤åŸæ¥çš„æ–‡ä»¶</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> ~/oslab
</span></span><span class="line"><span class="cl">$ sudo rm -rf ./*
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># é‡æ–°æ‹·è´</span>
</span></span><span class="line"><span class="cl">$ cp -r /home/teacher/oslab/* ./
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ“ä½œç³»ç»Ÿå®ç°ç³»ç»Ÿè°ƒç”¨çš„åŸºæœ¬è¿‡ç¨‹ï¼ˆåœ¨ MOOC è¯¾ç¨‹ä¸­å·²ç»ç»™å‡ºäº†è¯¦ç»†çš„è®²è§£ï¼‰æ˜¯ï¼š</p>
<ul>
<li>åº”ç”¨ç¨‹åºè°ƒç”¨åº“å‡½æ•°ï¼ˆAPIï¼‰ï¼›</li>
<li>API å°†ç³»ç»Ÿè°ƒç”¨å·å­˜å…¥ EAXï¼Œç„¶åé€šè¿‡ä¸­æ–­è°ƒç”¨ä½¿ç³»ç»Ÿè¿›å…¥å†…æ ¸æ€ï¼›</li>
<li>å†…æ ¸ä¸­çš„ä¸­æ–­å¤„ç†å‡½æ•°æ ¹æ®ç³»ç»Ÿè°ƒç”¨å·ï¼Œè°ƒç”¨å¯¹åº”çš„å†…æ ¸å‡½æ•°ï¼ˆç³»ç»Ÿè°ƒç”¨ï¼‰ï¼›</li>
<li>ç³»ç»Ÿè°ƒç”¨å®Œæˆç›¸åº”åŠŸèƒ½ï¼Œå°†è¿”å›å€¼å­˜å…¥ EAXï¼Œè¿”å›åˆ°ä¸­æ–­å¤„ç†å‡½æ•°ï¼›</li>
<li>ä¸­æ–­å¤„ç†å‡½æ•°è¿”å›åˆ° API ä¸­ï¼›</li>
<li>API å°† EAX è¿”å›ç»™åº”ç”¨ç¨‹åºã€‚</li>
</ul>
<h3 id="41-åº”ç”¨ç¨‹åºå¦‚ä½•è°ƒç”¨ç³»ç»Ÿè°ƒç”¨">4.1 åº”ç”¨ç¨‹åºå¦‚ä½•è°ƒç”¨ç³»ç»Ÿè°ƒç”¨<a hidden class="anchor" aria-hidden="true" href="#41-åº”ç”¨ç¨‹åºå¦‚ä½•è°ƒç”¨ç³»ç»Ÿè°ƒç”¨">#</a></h3>
<p>åœ¨é€šå¸¸æƒ…å†µä¸‹ï¼Œè°ƒç”¨ç³»ç»Ÿè°ƒç”¨å’Œè°ƒç”¨ä¸€ä¸ªæ™®é€šçš„è‡ªå®šä¹‰å‡½æ•°åœ¨ä»£ç ä¸Šå¹¶æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œä½†è°ƒç”¨åå‘ç”Ÿçš„äº‹æƒ…æœ‰å¾ˆå¤§ä¸åŒã€‚</p>
<p>è°ƒç”¨è‡ªå®šä¹‰å‡½æ•°æ˜¯é€šè¿‡ call æŒ‡ä»¤ç›´æ¥è·³è½¬åˆ°è¯¥å‡½æ•°çš„åœ°å€ï¼Œç»§ç»­è¿è¡Œã€‚</p>
<p>è€Œè°ƒç”¨ç³»ç»Ÿè°ƒç”¨ï¼Œæ˜¯è°ƒç”¨ç³»ç»Ÿåº“ä¸­ä¸ºè¯¥ç³»ç»Ÿè°ƒç”¨ç¼–å†™çš„ä¸€ä¸ªæ¥å£å‡½æ•°ï¼Œå« APIï¼ˆApplication Programming Interfaceï¼‰ã€‚API å¹¶ä¸èƒ½å®Œæˆç³»ç»Ÿè°ƒç”¨çš„çœŸæ­£åŠŸèƒ½ï¼Œå®ƒè¦åšçš„æ˜¯å»è°ƒç”¨çœŸæ­£çš„ç³»ç»Ÿè°ƒç”¨ï¼Œè¿‡ç¨‹æ˜¯ï¼š</p>
<ul>
<li>æŠŠç³»ç»Ÿè°ƒç”¨çš„ç¼–å·å­˜å…¥ EAXï¼›</li>
<li>æŠŠå‡½æ•°å‚æ•°å­˜å…¥å…¶å®ƒé€šç”¨å¯„å­˜å™¨ï¼›</li>
<li>è§¦å‘ 0x80 å·ä¸­æ–­ï¼ˆint 0x80ï¼‰ã€‚</li>
</ul>
<p>linux-0.11 çš„ lib ç›®å½•ä¸‹æœ‰ä¸€äº›å·²ç»å®ç°çš„ APIã€‚Linus ç¼–å†™å®ƒä»¬çš„åŸå› æ˜¯åœ¨å†…æ ¸åŠ è½½å®Œæ¯•åï¼Œä¼šåˆ‡æ¢åˆ°ç”¨æˆ·æ¨¡å¼ä¸‹ï¼Œåšä¸€äº›åˆå§‹åŒ–å·¥ä½œï¼Œç„¶åå¯åŠ¨ shellã€‚è€Œç”¨æˆ·æ¨¡å¼ä¸‹çš„å¾ˆå¤šå·¥ä½œéœ€è¦ä¾èµ–ä¸€äº›ç³»ç»Ÿè°ƒç”¨æ‰èƒ½å®Œæˆï¼Œå› æ­¤åœ¨å†…æ ¸ä¸­å®ç°äº†è¿™äº›ç³»ç»Ÿè°ƒç”¨çš„ APIã€‚</p>
<blockquote>
<p>åé¢çš„ç›®å½•å¦‚æœæ²¡æœ‰ç‰¹æ®Šè¯´æ˜ï¼Œéƒ½æ˜¯æŒ‡åœ¨ <code>/home/shiyanlou/oslab/linux-0.11</code> ä¸­ã€‚æ¯”å¦‚ä¸‹é¢çš„ <code>lib/close.c</code>ï¼Œæ˜¯æŒ‡ <code>/home/shiyanlou/oslab/linux-0.11/lib/close.c</code>ã€‚</p>
</blockquote>
<p>æˆ‘ä»¬ä¸å¦¨çœ‹çœ‹ lib/close.cï¼Œç ”ç©¶ä¸€ä¸‹ <code>close()</code> çš„ APIï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define __LIBRARY__
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="nf">_syscall1</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">close</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">fd</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…¶ä¸­ <code>_syscall1</code> æ˜¯ä¸€ä¸ªå®ï¼Œåœ¨ <code>include/unistd.h</code> ä¸­å®šä¹‰ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define _syscall1(type,name,atype,a) \
</span></span></span><span class="line"><span class="cl"><span class="cp">type name(atype a) \
</span></span></span><span class="line"><span class="cl"><span class="cp">{ \
</span></span></span><span class="line"><span class="cl"><span class="cp">long __res; \
</span></span></span><span class="line"><span class="cl"><span class="cp">__asm__ volatile (&#34;int $0x80&#34; \
</span></span></span><span class="line"><span class="cl"><span class="cp">    : &#34;=a&#34; (__res) \
</span></span></span><span class="line"><span class="cl"><span class="cp">    : &#34;0&#34; (__NR_##name),&#34;b&#34; ((long)(a))); \
</span></span></span><span class="line"><span class="cl"><span class="cp">if (__res &gt;= 0) \
</span></span></span><span class="line"><span class="cl"><span class="cp">    return (type) __res; \
</span></span></span><span class="line"><span class="cl"><span class="cp">errno = -__res; \
</span></span></span><span class="line"><span class="cl"><span class="cp">return -1; \
</span></span></span><span class="line"><span class="cl"><span class="cp">}
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>å°† <code>_syscall1(int,close,int,fd)</code> è¿›è¡Œå®å±•å¼€ï¼Œå¯ä»¥å¾—åˆ°ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">close</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">__res</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">__asm__</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">&#34;int $0x80&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="o">:</span> <span class="s">&#34;=a&#34;</span> <span class="p">(</span><span class="n">__res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">:</span> <span class="s">&#34;0&#34;</span> <span class="p">(</span><span class="n">__NR_close</span><span class="p">),</span><span class="s">&#34;b&#34;</span> <span class="p">((</span><span class="kt">long</span><span class="p">)(</span><span class="n">fd</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">__res</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">__res</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">errno</span> <span class="o">=</span> <span class="o">-</span><span class="n">__res</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™å°±æ˜¯ API çš„å®šä¹‰ã€‚å®ƒå…ˆå°†å® <code>__NR_close</code> å­˜å…¥ EAXï¼Œå°†å‚æ•° fd å­˜å…¥ EBXï¼Œç„¶åè¿›è¡Œ 0x80 ä¸­æ–­è°ƒç”¨ã€‚è°ƒç”¨è¿”å›åï¼Œä» EAX å–å‡ºè¿”å›å€¼ï¼Œå­˜å…¥ <code>__res</code>ï¼Œå†é€šè¿‡å¯¹ <code>__res</code> çš„åˆ¤æ–­å†³å®šä¼ ç»™ API çš„è°ƒç”¨è€…ä»€ä¹ˆæ ·çš„è¿”å›å€¼ã€‚</p>
<p>å…¶ä¸­ <code>__NR_close</code> å°±æ˜¯ç³»ç»Ÿè°ƒç”¨çš„ç¼–å·ï¼Œåœ¨ <code>include/unistd.h</code> ä¸­å®šä¹‰ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define __NR_close    6
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">æ‰€ä»¥æ·»åŠ ç³»ç»Ÿè°ƒç”¨æ—¶éœ€è¦ä¿®æ”¹include/unistd.hæ–‡ä»¶ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">ä½¿å…¶åŒ…å«__NR_whoamiå’Œ__NR_iamã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">è€Œåœ¨åº”ç”¨ç¨‹åºä¸­ï¼Œè¦æœ‰ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* æœ‰å®ƒï¼Œ_syscall1 ç­‰æ‰æœ‰æ•ˆã€‚è¯¦è§unistd.h */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define __LIBRARY__
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/* æœ‰å®ƒï¼Œç¼–è¯‘å™¨æ‰èƒ½è·çŸ¥è‡ªå®šä¹‰çš„ç³»ç»Ÿè°ƒç”¨çš„ç¼–å· */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;unistd.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/* iam()åœ¨ç”¨æˆ·ç©ºé—´çš„æ¥å£å‡½æ•° */</span>
</span></span><span class="line"><span class="cl"><span class="nf">_syscall1</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">iam</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* whoami()åœ¨ç”¨æˆ·ç©ºé—´çš„æ¥å£å‡½æ•° */</span>
</span></span><span class="line"><span class="cl"><span class="nf">_syscall2</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">whoami</span><span class="p">,</span><span class="kt">char</span><span class="o">*</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨ 0.11 ç¯å¢ƒä¸‹ç¼–è¯‘ C ç¨‹åºï¼ŒåŒ…å«çš„å¤´æ–‡ä»¶éƒ½åœ¨ <code>/usr/include</code> ç›®å½•ä¸‹ã€‚</p>
<p>è¯¥ç›®å½•ä¸‹çš„ <code>unistd.h</code> æ˜¯æ ‡å‡†å¤´æ–‡ä»¶ï¼ˆå®ƒå’Œ 0.11 æºç æ ‘ä¸­çš„ <code>unistd.h</code> å¹¶ä¸æ˜¯åŒä¸€ä¸ªæ–‡ä»¶ï¼Œè™½ç„¶å†…å®¹å¯èƒ½ç›¸åŒï¼‰ï¼Œæ²¡æœ‰ <code>__NR_whoami</code> å’Œ <code>__NR_iam</code> ä¸¤ä¸ªå®ï¼Œéœ€è¦æ‰‹å·¥åŠ ä¸Šå®ƒä»¬ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä»ä¿®æ”¹è¿‡çš„ 0.11 æºç æ ‘ä¸­æ‹·è´æ–°çš„ unistd.h è¿‡æ¥ã€‚</p>
<h3 id="42-ä»int-0x80è¿›å…¥å†…æ ¸å‡½æ•°">4.2 ä»â€œint 0x80â€è¿›å…¥å†…æ ¸å‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#42-ä»int-0x80è¿›å…¥å†…æ ¸å‡½æ•°">#</a></h3>
<p><code>int 0x80</code> è§¦å‘åï¼Œæ¥ä¸‹æ¥å°±æ˜¯å†…æ ¸çš„ä¸­æ–­å¤„ç†äº†ã€‚å…ˆäº†è§£ä¸€ä¸‹ 0.11 å¤„ç† 0x80 å·ä¸­æ–­çš„è¿‡ç¨‹ã€‚</p>
<p>åœ¨å†…æ ¸åˆå§‹åŒ–æ—¶ï¼Œä¸»å‡½æ•°ï¼ˆåœ¨ <code>init/main.c</code> ä¸­ï¼ŒLinux å®éªŒç¯å¢ƒä¸‹æ˜¯ <code>main()</code>ï¼ŒWindows ä¸‹å› ç¼–è¯‘å™¨å…¼å®¹æ€§é—®é¢˜è¢«æ¢åä¸º <code>start()</code>ï¼‰è°ƒç”¨äº† <code>sched_init()</code> åˆå§‹åŒ–å‡½æ•°ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">//    â€¦â€¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">time_init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">sched_init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">buffer_init</span><span class="p">(</span><span class="n">buffer_memory_end</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//    â€¦â€¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>sched_init()</code> åœ¨ <code>kernel/sched.c</code> ä¸­å®šä¹‰ä¸ºï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">sched_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">//    â€¦â€¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">set_system_gate</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="o">&amp;</span><span class="n">system_call</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>set_system_gate</code> æ˜¯ä¸ªå®ï¼Œåœ¨ <code>include/asm/system.h</code> ä¸­å®šä¹‰ä¸ºï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define set_system_gate(n,addr) \
</span></span></span><span class="line"><span class="cl"><span class="cp">    _set_gate(&amp;idt[n],15,3,addr)
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>_set_gate</code> çš„å®šä¹‰æ˜¯ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define _set_gate(gate_addr,type,dpl,addr) \
</span></span></span><span class="line"><span class="cl"><span class="cp">__asm__ (&#34;movw %%dx,%%ax\n\t&#34; \
</span></span></span><span class="line"><span class="cl"><span class="cp">    &#34;movw %0,%%dx\n\t&#34; \
</span></span></span><span class="line"><span class="cl"><span class="cp">    &#34;movl %%eax,%1\n\t&#34; \
</span></span></span><span class="line"><span class="cl"><span class="cp">    &#34;movl %%edx,%2&#34; \
</span></span></span><span class="line"><span class="cl"><span class="cp">    : \
</span></span></span><span class="line"><span class="cl"><span class="cp">    : &#34;i&#34; ((short) (0x8000+(dpl&lt;&lt;13)+(type&lt;&lt;8))), \
</span></span></span><span class="line"><span class="cl"><span class="cp">    &#34;o&#34; (*((char *) (gate_addr))), \
</span></span></span><span class="line"><span class="cl"><span class="cp">    &#34;o&#34; (*(4+(char *) (gate_addr))), \
</span></span></span><span class="line"><span class="cl"><span class="cp">    &#34;d&#34; ((char *) (addr)),&#34;a&#34; (0x00080000))
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>è™½ç„¶çœ‹èµ·æ¥æŒºéº»çƒ¦ï¼Œä½†å®é™…ä¸Šå¾ˆç®€å•ï¼Œå°±æ˜¯å¡«å†™ IDTï¼ˆä¸­æ–­æè¿°ç¬¦è¡¨ï¼‰ï¼Œå°† <code>system_call</code> å‡½æ•°åœ°å€å†™åˆ° <code>0x80</code> å¯¹åº”çš„ä¸­æ–­æè¿°ç¬¦ä¸­ï¼Œä¹Ÿå°±æ˜¯åœ¨ä¸­æ–­ <code>0x80</code> å‘ç”Ÿåï¼Œè‡ªåŠ¨è°ƒç”¨å‡½æ•° <code>system_call</code>ã€‚å…·ä½“ç»†èŠ‚è¯·å‚è€ƒã€Šæ³¨é‡Šã€‹çš„ç¬¬ 4 ç« ã€‚</p>
<p>æ¥ä¸‹æ¥çœ‹ <code>system_call</code>ã€‚è¯¥å‡½æ•°çº¯æ±‡ç¼–æ‰“é€ ï¼Œå®šä¹‰åœ¨ <code>kernel/system_call.s</code> ä¸­ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">!â€¦â€¦
</span></span><span class="line"><span class="cl">! # è¿™æ˜¯ç³»ç»Ÿè°ƒç”¨æ€»æ•°ã€‚å¦‚æœå¢åˆ äº†ç³»ç»Ÿè°ƒç”¨ï¼Œå¿…é¡»åšç›¸åº”ä¿®æ”¹
</span></span><span class="line"><span class="cl">nr_system_calls = 72
</span></span><span class="line"><span class="cl">!â€¦â€¦
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">.globl system_call
</span></span><span class="line"><span class="cl">.align 2
</span></span><span class="line"><span class="cl">system_call:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">! # æ£€æŸ¥ç³»ç»Ÿè°ƒç”¨ç¼–å·æ˜¯å¦åœ¨åˆæ³•èŒƒå›´å†…
</span></span><span class="line"><span class="cl">    cmpl \$nr_system_calls-1,%eax
</span></span><span class="line"><span class="cl">    ja bad_sys_call
</span></span><span class="line"><span class="cl">    push %ds
</span></span><span class="line"><span class="cl">    push %es
</span></span><span class="line"><span class="cl">    push %fs
</span></span><span class="line"><span class="cl">    pushl %edx
</span></span><span class="line"><span class="cl">    pushl %ecx
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">! # push %ebx,%ecx,%edxï¼Œæ˜¯ä¼ é€’ç»™ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°
</span></span><span class="line"><span class="cl">    pushl %ebx
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">! # è®©ds, esæŒ‡å‘GDTï¼Œå†…æ ¸åœ°å€ç©ºé—´
</span></span><span class="line"><span class="cl">    movl $0x10,%edx
</span></span><span class="line"><span class="cl">    mov %dx,%ds
</span></span><span class="line"><span class="cl">    mov %dx,%es
</span></span><span class="line"><span class="cl">    movl $0x17,%edx
</span></span><span class="line"><span class="cl">! # è®©fsæŒ‡å‘LDTï¼Œç”¨æˆ·åœ°å€ç©ºé—´
</span></span><span class="line"><span class="cl">    mov %dx,%fs
</span></span><span class="line"><span class="cl">    call sys_call_table(,%eax,4)
</span></span><span class="line"><span class="cl">    pushl %eax
</span></span><span class="line"><span class="cl">    movl current,%eax
</span></span><span class="line"><span class="cl">    cmpl $0,state(%eax)
</span></span><span class="line"><span class="cl">    jne reschedule
</span></span><span class="line"><span class="cl">    cmpl $0,counter(%eax)
</span></span><span class="line"><span class="cl">    je reschedule
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>system_call</code> ç”¨ <code>.globl</code> ä¿®é¥°ä¸ºå…¶ä»–å‡½æ•°å¯è§ã€‚</p>
<p>Windows å®éªŒç¯å¢ƒä¸‹ä¼šçœ‹åˆ°å®ƒæœ‰ä¸€ä¸ªä¸‹åˆ’çº¿å‰ç¼€ï¼Œè¿™æ˜¯ä¸åŒç‰ˆæœ¬ç¼–è¯‘å™¨çš„ç‰¹è´¨å†³å®šçš„ï¼Œæ²¡æœ‰å®è´¨åŒºåˆ«ã€‚</p>
<p><code>call sys_call_table(,%eax,4)</code> ä¹‹å‰æ˜¯ä¸€äº›å‹æ ˆä¿æŠ¤ï¼Œä¿®æ”¹æ®µé€‰æ‹©å­ä¸ºå†…æ ¸æ®µï¼Œ<code>call sys_call_table(,%eax,4)</code> ä¹‹åæ˜¯çœ‹çœ‹æ˜¯å¦éœ€è¦é‡æ–°è°ƒåº¦ï¼Œè¿™äº›éƒ½ä¸æœ¬å®éªŒæ²¡æœ‰ç›´æ¥å…³ç³»ï¼Œæ­¤å¤„åªå…³å¿ƒ <code>call sys_call_table(,%eax,4)</code> è¿™ä¸€å¥ã€‚</p>
<p>æ ¹æ®æ±‡ç¼–å¯»å€æ–¹æ³•å®ƒå®é™…ä¸Šæ˜¯ï¼š<code>call sys_call_table + 4 * %eax</code>ï¼Œå…¶ä¸­ eax ä¸­æ”¾çš„æ˜¯ç³»ç»Ÿè°ƒç”¨å·ï¼Œå³ <code>__NR_xxxxxx</code>ã€‚</p>
<p>æ˜¾ç„¶ï¼Œ<code>sys_call_table</code> ä¸€å®šæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆæ•°ç»„çš„èµ·å§‹åœ°å€ï¼Œå®ƒå®šä¹‰åœ¨ <code>include/linux/sys.h</code> ä¸­ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">fn_ptr sys_call_table[] = { sys_setup, sys_exit, sys_fork, sys_read,...
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¢åŠ å®éªŒè¦æ±‚çš„ç³»ç»Ÿè°ƒç”¨ï¼Œéœ€è¦åœ¨è¿™ä¸ªå‡½æ•°è¡¨ä¸­å¢åŠ ä¸¤ä¸ªå‡½æ•°å¼•ç”¨ â€”â€”<code>sys_iam</code> å’Œ <code>sys_whoami</code>ã€‚å½“ç„¶è¯¥å‡½æ•°åœ¨ <code>sys_call_table</code> æ•°ç»„ä¸­çš„ä½ç½®å¿…é¡»å’Œ <code>__NR_xxxxxx</code> çš„å€¼å¯¹åº”ä¸Šã€‚</p>
<p>åŒæ—¶è¿˜è¦ä»¿ç…§æ­¤æ–‡ä»¶ä¸­å‰é¢å„ä¸ªç³»ç»Ÿè°ƒç”¨çš„å†™æ³•ï¼ŒåŠ ä¸Šï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">int</span> <span class="nf">sys_whoami</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">int</span> <span class="nf">sys_iam</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸ç„¶ï¼Œç¼–è¯‘ä¼šå‡ºé”™çš„ã€‚</p>
<h3 id="43-å®ç°-sys_iam-å’Œ-sys_whoami">4.3 å®ç° sys_iam() å’Œ sys_whoami()<a hidden class="anchor" aria-hidden="true" href="#43-å®ç°-sys_iam-å’Œ-sys_whoami">#</a></h3>
<p>æ·»åŠ ç³»ç»Ÿè°ƒç”¨çš„æœ€åä¸€æ­¥ï¼Œæ˜¯åœ¨å†…æ ¸ä¸­å®ç°å‡½æ•° <code>sys_iam()</code> å’Œ <code>sys_whoami()</code>ã€‚</p>
<p>æ¯ä¸ªç³»ç»Ÿè°ƒç”¨éƒ½æœ‰ä¸€ä¸ª <code>sys_xxxxxx()</code> ä¸ä¹‹å¯¹åº”ï¼Œå®ƒä»¬éƒ½æ˜¯æˆ‘ä»¬å­¦ä¹ å’Œæ¨¡ä»¿çš„å¥½å¯¹è±¡ã€‚</p>
<p>æ¯”å¦‚åœ¨ <code>fs/open.c</code> ä¸­çš„ <code>sys_close(int fd)</code>ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">sys_close</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">//    â€¦â€¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®ƒæ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œéƒ½æ˜¯å®å®åœ¨åœ¨åœ°åš <code>close()</code> è¯¥åšçš„äº‹æƒ…ã€‚</p>
<p>æ‰€ä»¥åªè¦è‡ªå·±åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼š<code>kernel/who.c</code>ï¼Œç„¶åå®ç°ä¸¤ä¸ªå‡½æ•°å°±ä¸‡äº‹å¤§å‰äº†ã€‚</p>
<blockquote>
<p>å¦‚æœå®Œå…¨æ²¡æœ‰å®ç°çš„æ€è·¯ï¼Œä¸å¿…æ‹…å¿ƒï¼Œæœ¬å®éªŒçš„ â€œ6.7 åœ¨ç”¨æˆ·æ€å’Œæ ¸å¿ƒæ€ä¹‹é—´ä¼ é€’æ•°æ®â€ è¿˜ä¼šæœ‰æç¤ºã€‚</p>
</blockquote>
<h3 id="44-ä¿®æ”¹-makefile">4.4 ä¿®æ”¹ Makefile<a hidden class="anchor" aria-hidden="true" href="#44-ä¿®æ”¹-makefile">#</a></h3>
<p>è¦æƒ³è®©æˆ‘ä»¬æ·»åŠ çš„ <code>kernel/who.c</code> å¯ä»¥å’Œå…¶å®ƒ Linux ä»£ç ç¼–è¯‘é“¾æ¥åˆ°ä¸€èµ·ï¼Œå¿…é¡»è¦ä¿®æ”¹ Makefile æ–‡ä»¶ã€‚</p>
<p>Makefile é‡Œè®°å½•çš„æ˜¯æ‰€æœ‰æºç¨‹åºæ–‡ä»¶çš„ç¼–è¯‘ã€é“¾æ¥è§„åˆ™ï¼Œã€Šæ³¨é‡Šã€‹3.6 èŠ‚æœ‰ç®€ç•¥ä»‹ç»ã€‚æˆ‘ä»¬ä¹‹æ‰€ä»¥ç®€å•åœ°è¿è¡Œ make å°±å¯ä»¥ç¼–è¯‘æ•´ä¸ªä»£ç æ ‘ï¼Œæ˜¯å› ä¸º make å®Œå…¨æŒ‰ç…§ Makefile é‡Œçš„æŒ‡ç¤ºå·¥ä½œã€‚</p>
<blockquote>
<p>å¦‚æœæƒ³è¦æ·±å…¥å­¦ä¹  Makefileï¼Œå¯ä»¥é€‰æ‹©å®éªŒæ¥¼çš„è¯¾ç¨‹ï¼š <a href="https://www.lanqiao.cn/courses/849">ã€ŠMakefile åŸºç¡€æ•™ç¨‹ã€‹</a>ã€<a href="https://www.lanqiao.cn/courses/115/learning/%5D/courses/713">ã€Šè·Ÿæˆ‘ä¸€èµ·æ¥ç©è½¬ Makefileã€‹</a>ã€‚</p>
</blockquote>
<p>Makefile åœ¨ä»£ç æ ‘ä¸­æœ‰å¾ˆå¤šï¼Œåˆ†åˆ«è´Ÿè´£ä¸åŒæ¨¡å—çš„ç¼–è¯‘å·¥ä½œã€‚æˆ‘ä»¬è¦ä¿®æ”¹çš„æ˜¯ <code>kernel/Makefile</code>ã€‚éœ€è¦ä¿®æ”¹ä¸¤å¤„ã€‚</p>
<h4 id="1ç¬¬ä¸€å¤„">ï¼ˆ1ï¼‰ç¬¬ä¸€å¤„<a hidden class="anchor" aria-hidden="true" href="#1ç¬¬ä¸€å¤„">#</a></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="line"><span class="cl"><span class="nv">OBJS</span>  <span class="o">=</span> sched.o system_call.o traps.o asm.o fork.o <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        panic.o printk.o vsprintf.o sys.o exit.o <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        signal.o mktime.o
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ”¹ä¸ºï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="line"><span class="cl"><span class="nv">OBJS</span>  <span class="o">=</span> sched.o system_call.o traps.o asm.o fork.o <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        panic.o printk.o vsprintf.o sys.o exit.o <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        signal.o mktime.o who.o
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ·»åŠ äº† <code>who.o</code>ã€‚</p>
<h4 id="2ç¬¬äºŒå¤„">ï¼ˆ2ï¼‰ç¬¬äºŒå¤„<a hidden class="anchor" aria-hidden="true" href="#2ç¬¬äºŒå¤„">#</a></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="line"><span class="cl"><span class="c">### Dependencies:
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nf">exit.s exit.o</span><span class="o">:</span> <span class="n">exit</span>.<span class="n">c</span> ../<span class="n">include</span>/<span class="n">errno</span>.<span class="n">h</span> ../<span class="n">include</span>/<span class="n">signal</span>.<span class="n">h</span> \
</span></span><span class="line"><span class="cl">  ../<span class="n">include</span>/<span class="n">sys</span>/<span class="n">types</span>.<span class="n">h</span> ../<span class="n">include</span>/<span class="n">sys</span>/<span class="n">wait</span>.<span class="n">h</span> ../<span class="n">include</span>/<span class="n">linux</span>/<span class="n">sched</span>.<span class="n">h</span> \
</span></span><span class="line"><span class="cl">  ../<span class="n">include</span>/<span class="n">linux</span>/<span class="n">head</span>.<span class="n">h</span> ../<span class="n">include</span>/<span class="n">linux</span>/<span class="n">fs</span>.<span class="n">h</span> ../<span class="n">include</span>/<span class="n">linux</span>/<span class="n">mm</span>.<span class="n">h</span> \
</span></span><span class="line"><span class="cl">  ../<span class="n">include</span>/<span class="n">linux</span>/<span class="n">kernel</span>.<span class="n">h</span> ../<span class="n">include</span>/<span class="n">linux</span>/<span class="n">tty</span>.<span class="n">h</span> ../<span class="n">include</span>/<span class="n">termios</span>.<span class="n">h</span> \
</span></span><span class="line"><span class="cl">  ../<span class="n">include</span>/<span class="n">asm</span>/<span class="n">segment</span>.<span class="n">h</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ”¹ä¸ºï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="line"><span class="cl"><span class="c">### Dependencies:
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nf">who.s who.o</span><span class="o">:</span> <span class="n">who</span>.<span class="n">c</span> ../<span class="n">include</span>/<span class="n">linux</span>/<span class="n">kernel</span>.<span class="n">h</span> ../<span class="n">include</span>/<span class="n">unistd</span>.<span class="n">h</span>
</span></span><span class="line"><span class="cl"><span class="nf">exit.s exit.o</span><span class="o">:</span> <span class="n">exit</span>.<span class="n">c</span> ../<span class="n">include</span>/<span class="n">errno</span>.<span class="n">h</span> ../<span class="n">include</span>/<span class="n">signal</span>.<span class="n">h</span> \
</span></span><span class="line"><span class="cl">  ../<span class="n">include</span>/<span class="n">sys</span>/<span class="n">types</span>.<span class="n">h</span> ../<span class="n">include</span>/<span class="n">sys</span>/<span class="n">wait</span>.<span class="n">h</span> ../<span class="n">include</span>/<span class="n">linux</span>/<span class="n">sched</span>.<span class="n">h</span> \
</span></span><span class="line"><span class="cl">  ../<span class="n">include</span>/<span class="n">linux</span>/<span class="n">head</span>.<span class="n">h</span> ../<span class="n">include</span>/<span class="n">linux</span>/<span class="n">fs</span>.<span class="n">h</span> ../<span class="n">include</span>/<span class="n">linux</span>/<span class="n">mm</span>.<span class="n">h</span> \
</span></span><span class="line"><span class="cl">  ../<span class="n">include</span>/<span class="n">linux</span>/<span class="n">kernel</span>.<span class="n">h</span> ../<span class="n">include</span>/<span class="n">linux</span>/<span class="n">tty</span>.<span class="n">h</span> ../<span class="n">include</span>/<span class="n">termios</span>.<span class="n">h</span> \
</span></span><span class="line"><span class="cl">  ../<span class="n">include</span>/<span class="n">asm</span>/<span class="n">segment</span>.<span class="n">h</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ·»åŠ äº† <code>who.s who.o: who.c ../include/linux/kernel.h ../include/unistd.h</code>ã€‚</p>
<p>Makefile ä¿®æ”¹åï¼Œå’Œå¾€å¸¸ä¸€æ · <code>make all</code> å°±èƒ½è‡ªåŠ¨æŠŠ <code>who.c</code> åŠ å…¥åˆ°å†…æ ¸ä¸­äº†ã€‚</p>
<p>å¦‚æœç¼–è¯‘æ—¶æç¤º <code>who.c</code> æœ‰é”™è¯¯ï¼Œå°±è¯´æ˜ä¿®æ”¹ç”Ÿæ•ˆäº†ã€‚æ‰€ä»¥ï¼Œæœ‰æ„æˆ–æ— æ„åœ°åˆ¶é€ ä¸€ä¸¤ä¸ªé”™è¯¯ä¹Ÿä¸å®Œå…¨æ˜¯åäº‹ï¼Œè‡³å°‘èƒ½è¯æ˜ Makefile æ˜¯å¯¹çš„ã€‚</p>
<h3 id="45-ç”¨-printk-è°ƒè¯•å†…æ ¸">4.5 ç”¨ printk() è°ƒè¯•å†…æ ¸<a hidden class="anchor" aria-hidden="true" href="#45-ç”¨-printk-è°ƒè¯•å†…æ ¸">#</a></h3>
<p>oslab å®éªŒç¯å¢ƒæä¾›äº†åŸºäº C è¯­è¨€å’Œæ±‡ç¼–è¯­è¨€çš„ä¸¤ç§è°ƒè¯•æ‰‹æ®µã€‚é™¤æ­¤ä¹‹å¤–ï¼Œé€‚å½“åœ°å‘å±å¹•è¾“å‡ºä¸€äº›ç¨‹åºè¿è¡ŒçŠ¶æ€çš„ä¿¡æ¯ï¼Œä¹Ÿæ˜¯ä¸€ç§å¾ˆé«˜æ•ˆã€ä¾¿æ·çš„è°ƒè¯•æ–¹æ³•ï¼Œæœ‰æ—¶ç”šè‡³æ˜¯å”¯ä¸€çš„æ–¹æ³•ï¼Œè¢«ç§°ä¸ºâ€œprintf æ³•â€ã€‚</p>
<p>è¦çŸ¥é“åˆ°ï¼Œprintf() æ˜¯ä¸€ä¸ªåªèƒ½åœ¨ç”¨æˆ·æ¨¡å¼ä¸‹æ‰§è¡Œçš„å‡½æ•°ï¼Œè€Œç³»ç»Ÿè°ƒç”¨æ˜¯åœ¨å†…æ ¸æ¨¡å¼ä¸­è¿è¡Œï¼Œæ‰€ä»¥ printf() ä¸å¯ç”¨ï¼Œè¦ç”¨ printk()ã€‚</p>
<p><code>printk()</code> å’Œ <code>printf()</code> çš„æ¥å£å’ŒåŠŸèƒ½åŸºæœ¬ç›¸åŒï¼Œåªæ˜¯ä»£ç ä¸Šæœ‰ä¸€ç‚¹ç‚¹ä¸åŒã€‚printk() éœ€è¦ç‰¹åˆ«å¤„ç†ä¸€ä¸‹ <code>fs</code> å¯„å­˜å™¨ï¼Œå®ƒæ˜¯ä¸“ç”¨äºç”¨æˆ·æ¨¡å¼çš„æ®µå¯„å­˜å™¨ã€‚</p>
<p>çœ‹ä¸€çœ‹ printk çš„ä»£ç ï¼ˆåœ¨ <code>kernel/printk.c</code> ä¸­ï¼‰å°±çŸ¥é“äº†ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">printk</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">//    â€¦â€¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">__asm__</span><span class="p">(</span><span class="s">&#34;push %%fs</span><span class="se">\n\t</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;push %%ds</span><span class="se">\n\t</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;pop %%fs</span><span class="se">\n\t</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;pushl %0</span><span class="se">\n\t</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;pushl $buf</span><span class="se">\n\t</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;pushl $0</span><span class="se">\n\t</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;call tty_write</span><span class="se">\n\t</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;addl $8,%%esp</span><span class="se">\n\t</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;popl %0</span><span class="se">\n\t</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;pop %%fs&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="o">::</span><span class="s">&#34;r&#34;</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">:</span><span class="s">&#34;ax&#34;</span><span class="p">,</span><span class="s">&#34;cx&#34;</span><span class="p">,</span><span class="s">&#34;dx&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//    â€¦â€¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ˜¾ç„¶ï¼Œ<code>printk()</code> é¦–å…ˆ <code>push %fs</code> ä¿å­˜è¿™ä¸ªæŒ‡å‘ç”¨æˆ·æ®µçš„å¯„å­˜å™¨ï¼Œåœ¨æœ€å <code>pop %fs</code> å°†å…¶æ¢å¤ï¼Œprintk() çš„æ ¸å¿ƒä»ç„¶æ˜¯è°ƒç”¨ <code>tty_write()</code>ã€‚æŸ¥çœ‹ printf() å¯ä»¥çœ‹åˆ°ï¼Œå®ƒæœ€ç»ˆä¹Ÿè¦è½å®åˆ°è¿™ä¸ªå‡½æ•°ä¸Šã€‚</p>
<h3 id="46-ç¼–å†™æµ‹è¯•ç¨‹åº">4.6 ç¼–å†™æµ‹è¯•ç¨‹åº<a hidden class="anchor" aria-hidden="true" href="#46-ç¼–å†™æµ‹è¯•ç¨‹åº">#</a></h3>
<p>æ¿€åŠ¨åœ°è¿è¡Œä¸€ä¸‹ç”±ä½ äº²æ‰‹ä¿®æ”¹è¿‡çš„ â€œLinux 0.11 pro++â€ï¼ç„¶åç¼–å†™ä¸€ä¸ªç®€å•çš„åº”ç”¨ç¨‹åºè¿›è¡Œæµ‹è¯•ã€‚</p>
<p>æ¯”å¦‚åœ¨ <code>sys_iam()</code> ä¸­å‘ç»ˆç«¯ <code>printk()</code> ä¸€äº›ä¿¡æ¯ï¼Œè®©åº”ç”¨ç¨‹åºè°ƒç”¨ <code>iam()</code>ï¼Œä»ç»“æœå¯ä»¥çœ‹å‡ºç³»ç»Ÿè°ƒç”¨æ˜¯å¦è¢«çœŸçš„è°ƒç”¨åˆ°äº†ã€‚</p>
<p>å¯ä»¥ç›´æ¥åœ¨ Linux 0.11 ç¯å¢ƒä¸‹ç”¨ vi ç¼–å†™ï¼ˆåˆ«å¿˜äº†ç»å¸¸æ‰§è¡Œâ€œsyncâ€ä»¥ç¡®ä¿å†…å­˜ç¼“å†²åŒºçš„æ•°æ®å†™å…¥ç£ç›˜ï¼‰ï¼Œä¹Ÿå¯ä»¥åœ¨ Ubuntu æˆ– Windows ä¸‹ç¼–å®Œåå†ä¼ åˆ° Linux 0.11 ä¸‹ã€‚æ— è®ºå¦‚ä½•ï¼Œæœ€ç»ˆéƒ½å¿…é¡»åœ¨ Linux 0.11 ä¸‹ç¼–è¯‘ã€‚ç¼–è¯‘å‘½ä»¤æ˜¯ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ gcc -o iam iam.c -Wall
</span></span></code></pre></td></tr></table>
</div>
</div><p>gcc çš„ â€œ-Wallâ€ å‚æ•°æ˜¯ç»™å‡ºæ‰€æœ‰çš„ç¼–è¯‘è­¦å‘Šä¿¡æ¯ï¼Œâ€œ-oâ€ å‚æ•°æŒ‡å®šç”Ÿæˆçš„æ‰§è¡Œæ–‡ä»¶åæ˜¯ iamï¼Œç”¨ä¸‹é¢å‘½ä»¤è¿è¡Œå®ƒï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ./iam
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æœå¦‚æ„¿è¾“å‡ºäº†ä½ çš„ä¿¡æ¯ï¼Œå°±è¯´æ˜ä½ æ·»åŠ çš„ç³»ç»Ÿè°ƒç”¨ç”Ÿæ•ˆäº†ã€‚å¦åˆ™ï¼Œå°±è¿˜è¦ç»§ç»­è°ƒè¯•ï¼Œç¥ä½ å¥½è¿ï¼</p>
<h3 id="47-åœ¨ç”¨æˆ·æ€å’Œæ ¸å¿ƒæ€ä¹‹é—´ä¼ é€’æ•°æ®">4.7 åœ¨ç”¨æˆ·æ€å’Œæ ¸å¿ƒæ€ä¹‹é—´ä¼ é€’æ•°æ®<a hidden class="anchor" aria-hidden="true" href="#47-åœ¨ç”¨æˆ·æ€å’Œæ ¸å¿ƒæ€ä¹‹é—´ä¼ é€’æ•°æ®">#</a></h3>
<p>æŒ‡é’ˆå‚æ•°ä¼ é€’çš„æ˜¯åº”ç”¨ç¨‹åºæ‰€åœ¨åœ°å€ç©ºé—´çš„é€»è¾‘åœ°å€ï¼Œåœ¨å†…æ ¸ä¸­å¦‚æœç›´æ¥è®¿é—®è¿™ä¸ªåœ°å€ï¼Œè®¿é—®åˆ°çš„æ˜¯å†…æ ¸ç©ºé—´ä¸­çš„æ•°æ®ï¼Œä¸ä¼šæ˜¯ç”¨æˆ·ç©ºé—´çš„ã€‚æ‰€ä»¥è¿™é‡Œè¿˜éœ€è¦ä¸€ç‚¹å„¿ç‰¹æ®Šå·¥ä½œï¼Œæ‰èƒ½åœ¨å†…æ ¸ä¸­ä»ç”¨æˆ·ç©ºé—´å¾—åˆ°æ•°æ®ã€‚</p>
<p>è¦å®ç°çš„ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨å‚æ•°ä¸­éƒ½æœ‰å­—ç¬¦ä¸²æŒ‡é’ˆï¼Œéå¸¸åƒ <code>open(char *filename, â€¦â€¦)</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬çœ‹ä¸€ä¸‹ <code>open()</code> ç³»ç»Ÿè°ƒç”¨æ˜¯å¦‚ä½•å¤„ç†çš„ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">open</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">filename</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">,</span> <span class="p">...)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">//    â€¦â€¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">__asm__</span><span class="p">(</span><span class="s">&#34;int $0x80&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="o">:</span><span class="s">&#34;=a&#34;</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">:</span><span class="s">&#34;0&#34;</span> <span class="p">(</span><span class="n">__NR_open</span><span class="p">),</span><span class="s">&#34;b&#34;</span> <span class="p">(</span><span class="n">filename</span><span class="p">),</span><span class="s">&#34;c&#34;</span> <span class="p">(</span><span class="n">flag</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;d&#34;</span> <span class="p">(</span><span class="nf">va_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="kt">int</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl"><span class="c1">//    â€¦â€¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹å‡ºï¼Œç³»ç»Ÿè°ƒç”¨æ˜¯ç”¨ <code>eaxã€ebxã€ecxã€edx</code> å¯„å­˜å™¨æ¥ä¼ é€’å‚æ•°çš„ã€‚</p>
<ul>
<li>å…¶ä¸­ eax ä¼ é€’äº†ç³»ç»Ÿè°ƒç”¨å·ï¼Œè€Œ ebxã€ecxã€edx æ˜¯ç”¨æ¥ä¼ é€’å‡½æ•°çš„å‚æ•°çš„</li>
<li>ebx å¯¹åº”ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œecx å¯¹åº”ç¬¬äºŒä¸ªå‚æ•°ï¼Œä¾æ­¤ç±»æ¨ã€‚</li>
</ul>
<p>å¦‚ open æ‰€ä¼ é€’çš„æ–‡ä»¶åæŒ‡é’ˆæ˜¯ç”± ebx ä¼ é€’çš„ï¼Œä¹Ÿå³è¿›å…¥å†…æ ¸åï¼Œé€šè¿‡ ebx å–å‡ºæ–‡ä»¶åå­—ç¬¦ä¸²ã€‚open çš„ ebx æŒ‡å‘çš„æ•°æ®åœ¨ç”¨æˆ·ç©ºé—´ï¼Œè€Œå½“å‰æ‰§è¡Œçš„æ˜¯å†…æ ¸ç©ºé—´çš„ä»£ç ï¼Œå¦‚ä½•åœ¨ç”¨æˆ·æ€å’Œæ ¸å¿ƒæ€ä¹‹é—´ä¼ é€’æ•°æ®ï¼Ÿ</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­çœ‹çœ‹ open çš„å¤„ç†ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">system_call: //æ‰€æœ‰çš„ç³»ç»Ÿè°ƒç”¨éƒ½ä»system_callå¼€å§‹
</span></span><span class="line"><span class="cl">!    â€¦â€¦
</span></span><span class="line"><span class="cl">    pushl %edx
</span></span><span class="line"><span class="cl">    pushl %ecx
</span></span><span class="line"><span class="cl">    pushl %ebx                # push %ebx,%ecx,%edxï¼Œè¿™æ˜¯ä¼ é€’ç»™ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°
</span></span><span class="line"><span class="cl">    movl $0x10,%edx            # è®©ds,esæŒ‡å‘GDTï¼ŒæŒ‡å‘æ ¸å¿ƒåœ°å€ç©ºé—´
</span></span><span class="line"><span class="cl">    mov %dx,%ds
</span></span><span class="line"><span class="cl">    mov %dx,%es
</span></span><span class="line"><span class="cl">    movl $0x17,%edx            # è®©fsæŒ‡å‘çš„æ˜¯LDTï¼ŒæŒ‡å‘ç”¨æˆ·åœ°å€ç©ºé—´
</span></span><span class="line"><span class="cl">    mov %dx,%fs
</span></span><span class="line"><span class="cl">    call sys_call_table(,%eax,4)    # å³call sys_open
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç”±ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œè·å–ç”¨æˆ·åœ°å€ç©ºé—´ï¼ˆç”¨æˆ·æ•°æ®æ®µï¼‰ä¸­çš„æ•°æ®ä¾é çš„å°±æ˜¯æ®µå¯„å­˜å™¨ fsï¼Œä¸‹é¢è¯¥è½¬åˆ° <code>sys_open</code> æ‰§è¡Œäº†ï¼Œåœ¨ <code>fs/open.c</code> æ–‡ä»¶ä¸­ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">sys_open</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">filename</span><span class="p">,</span><span class="kt">int</span> <span class="n">flag</span><span class="p">,</span><span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>  <span class="c1">//filenameè¿™äº›å‚æ•°ä»å“ªé‡Œæ¥ï¼Ÿ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cm">/*æ˜¯å¦è®°å¾—ä¸Šé¢çš„pushl %edx,    pushl %ecx,    pushl %ebxï¼Ÿ
</span></span></span><span class="line"><span class="cl"><span class="cm">  å®é™…ä¸Šä¸€ä¸ªCè¯­è¨€å‡½æ•°è°ƒç”¨å¦ä¸€ä¸ªCè¯­è¨€å‡½æ•°æ—¶ï¼Œç¼–è¯‘æ—¶å°±æ˜¯å°†è¦
</span></span></span><span class="line"><span class="cl"><span class="cm">  ä¼ é€’çš„å‚æ•°å‹å…¥æ ˆä¸­ï¼ˆç¬¬ä¸€ä¸ªå‚æ•°æœ€åå‹ï¼Œâ€¦ï¼‰ï¼Œç„¶åcall â€¦ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">  æ‰€ä»¥æ±‡ç¼–ç¨‹åºè°ƒç”¨Cå‡½æ•°æ—¶ï¼Œéœ€è¦è‡ªå·±ç¼–å†™è¿™äº›å‚æ•°å‹æ ˆçš„ä»£ç â€¦*/</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="err">â€¦â€¦</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">((</span><span class="n">i</span><span class="o">=</span><span class="nf">open_namei</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">flag</span><span class="p">,</span><span class="n">mode</span><span class="p">,</span><span class="o">&amp;</span><span class="n">inode</span><span class="p">))</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="err">â€¦â€¦</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="err">â€¦â€¦</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®ƒå°†å‚æ•°ä¼ ç»™äº† <code>open_namei()</code>ã€‚</p>
<p>å†æ²¿ç€ <code>open_namei()</code> ç»§ç»­æŸ¥æ‰¾ï¼Œæ–‡ä»¶åå…ˆååˆè¢«ä¼ ç»™<code>dir_namei()</code>ã€<code>get_dir()</code>ã€‚</p>
<p>åœ¨ <code>get_dir()</code> ä¸­å¯ä»¥çœ‹åˆ°ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="k">struct</span> <span class="n">m_inode</span> <span class="o">*</span> <span class="nf">get_dir</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">pathname</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="err">â€¦â€¦</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">=</span><span class="nf">get_fs_byte</span><span class="p">(</span><span class="n">pathname</span><span class="p">))</span><span class="o">==</span><span class="sc">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="err">â€¦â€¦</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="err">â€¦â€¦</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¤„ç†æ–¹æ³•å°±å¾ˆæ˜¾ç„¶äº†ï¼šç”¨ <code>get_fs_byte()</code> è·å¾—ä¸€ä¸ªå­—èŠ‚çš„ç”¨æˆ·ç©ºé—´ä¸­çš„æ•°æ®ã€‚</p>
<p>æ‰€ä»¥ï¼Œåœ¨å®ç° <code>iam()</code> æ—¶ï¼Œè°ƒç”¨ <code>get_fs_byte()</code> å³å¯ã€‚</p>
<p>ä½†å¦‚ä½•å®ç° <code>whoami()</code> å‘¢ï¼Ÿå³å¦‚ä½•å®ç°ä»æ ¸å¿ƒæ€æ‹·è´æ•°æ®åˆ°ç”¨å¿ƒæ€å†…å­˜ç©ºé—´ä¸­å‘¢ï¼Ÿ</p>
<p>çŒœä¸€çŒœï¼Œæ˜¯å¦æœ‰ <code>put_fs_byte()</code>ï¼Ÿæœ‰ï¼çœ‹ä¸€çœ‹ <code>include/asm/segment.h</code> ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">extern</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">get_fs_byte</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="k">register</span> <span class="kt">char</span> <span class="n">_v</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__asm__</span> <span class="p">(</span><span class="s">&#34;movb %%fs:%1,%0&#34;</span><span class="o">:</span><span class="s">&#34;=r&#34;</span> <span class="p">(</span><span class="n">_v</span><span class="p">)</span><span class="o">:</span><span class="s">&#34;m&#34;</span> <span class="p">(</span><span class="o">*</span><span class="n">addr</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">_v</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">put_fs_byte</span><span class="p">(</span><span class="kt">char</span> <span class="n">val</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__asm__</span> <span class="p">(</span><span class="s">&#34;movb %0,%%fs:%1&#34;</span><span class="o">::</span><span class="s">&#34;r&#34;</span> <span class="p">(</span><span class="n">val</span><span class="p">),</span><span class="s">&#34;m&#34;</span> <span class="p">(</span><span class="o">*</span><span class="n">addr</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»–ä¿©ä»¥åŠæ‰€æœ‰ <code>put_fs_xxx()</code> å’Œ <code>get_fs_xxx()</code> éƒ½æ˜¯ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ä¹‹é—´çš„æ¡¥æ¢ï¼Œåœ¨åé¢çš„å®éªŒä¸­è¿˜è¦ç»å¸¸ç”¨åˆ°ã€‚</p>
<h3 id="48-è¿è¡Œè„šæœ¬ç¨‹åº">4.8 è¿è¡Œè„šæœ¬ç¨‹åº<a hidden class="anchor" aria-hidden="true" href="#48-è¿è¡Œè„šæœ¬ç¨‹åº">#</a></h3>
<p>Linux çš„ä¸€å¤§ç‰¹è‰²æ˜¯å¯ä»¥ç¼–å†™åŠŸèƒ½å¼ºå¤§çš„ shell è„šæœ¬ï¼Œæé«˜å·¥ä½œæ•ˆç‡ã€‚æœ¬å®éªŒçš„éƒ¨åˆ†è¯„åˆ†å·¥ä½œç”±è„šæœ¬ testlab2.sh å®Œæˆã€‚å®ƒçš„åŠŸèƒ½æ˜¯æµ‹è¯• <code>iam.c</code> å’Œ <code>whoami.c</code>ã€‚</p>
<p>é¦–å…ˆå°† <code>iam.c</code> å’Œ <code>whoami.c</code> åˆ†åˆ«ç¼–è¯‘æˆ <code>iam</code> å’Œ <code>whoami</code>ï¼Œç„¶åå°† <code>testlab2.sh</code>ï¼ˆåœ¨ <code>/home/teacher</code> ç›®å½•ä¸‹ï¼‰ æ‹·è´åˆ°åŒä¸€ç›®å½•ä¸‹ã€‚</p>
<p>ç”¨ä¸‹é¢å‘½ä»¤ä¸ºæ­¤è„šæœ¬å¢åŠ æ‰§è¡Œæƒé™ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ chmod +x testlab2.sh
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åè¿è¡Œä¹‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ./testlab2.sh
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ ¹æ®è¾“å‡ºï¼Œå¯çŸ¥ <code>iam.c</code> å’Œ <code>whoami.c</code> çš„å¾—åˆ†ã€‚</p>
<h4 id="errno">errno<a hidden class="anchor" aria-hidden="true" href="#errno">#</a></h4>
<p>errno æ˜¯ä¸€ç§ä¼ ç»Ÿçš„é”™è¯¯ä»£ç è¿”å›æœºåˆ¶ã€‚</p>
<p>å½“ä¸€ä¸ªå‡½æ•°è°ƒç”¨å‡ºé”™æ—¶ï¼Œé€šå¸¸ä¼šè¿”å› -1 ç»™è°ƒç”¨è€…ã€‚ä½† -1 åªèƒ½è¯´æ˜å‡ºé”™ï¼Œä¸èƒ½è¯´æ˜é”™æ˜¯ä»€ä¹ˆã€‚ä¸ºè§£å†³æ­¤é—®é¢˜ï¼Œå…¨å±€å˜é‡ errno ç™»åœºäº†ã€‚é”™è¯¯å€¼è¢«å­˜æ”¾åˆ° errno ä¸­ï¼Œäºæ˜¯è°ƒç”¨è€…å°±å¯ä»¥é€šè¿‡åˆ¤æ–­ errno æ¥å†³å®šå¦‚ä½•åº”å¯¹é”™è¯¯äº†ã€‚</p>
<p>å„ç§ç³»ç»Ÿå¯¹ errno çš„å€¼çš„å«ä¹‰éƒ½æœ‰æ ‡å‡†å®šä¹‰ã€‚Linux ä¸‹ç”¨â€œman errnoâ€å¯ä»¥çœ‹åˆ°è¿™äº›å®šä¹‰ã€‚</p>
<h2 id="5-å®éªŒæ­¥éª¤">5. å®éªŒæ­¥éª¤<a hidden class="anchor" aria-hidden="true" href="#5-å®éªŒæ­¥éª¤">#</a></h2>
<h3 id="1æ·»åŠ å®å®šä¹‰">1.æ·»åŠ å®å®šä¹‰<a hidden class="anchor" aria-hidden="true" href="#1æ·»åŠ å®å®šä¹‰">#</a></h3>
<p><strong>é¦–å…ˆæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿï¼Œç„¶ååœ¨æ­¤æ–‡ä»¶ç³»ç»Ÿå†…è¿›è¡Œç¼–è¾‘</strong>
æŒ‚è½½å‘½ä»¤ï¼š<code>sudo ./mount-hdc</code>
é¦–å…ˆæ‰¾åˆ°unistd.hå¤´æ–‡ä»¶ï¼Œæ­¤æ–‡ä»¶åœ¨includeå­ç›®å½•å†…</p>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012339231.png" alt="image-20220320161007564"  />
</p>
<p>æ‰“å¼€å®ƒå¹¶åœ¨å®å®šä¹‰å‡ºè¿½åŠ  <code>__NR_whoami </code>å’Œ <code>__NR_iam</code>ä¸¤ä¸ªå®ï¼Œè¿½åŠ åçš„æ•ˆæœå¦‚ä¸‹</p>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012339226.png" alt="image-20220320161019030"  />
</p>
<h3 id="2æ·»åŠ ç”¨æˆ·ç©ºé—´æ¥å£å‡½æ•°">2.æ·»åŠ ç”¨æˆ·ç©ºé—´æ¥å£å‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#2æ·»åŠ ç”¨æˆ·ç©ºé—´æ¥å£å‡½æ•°">#</a></h3>
<p>åœ¨æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿå†…ï¼ˆåœ¨<code>${OSLAB}/hdc/usr/root/</code>ç›®å½•ä¸‹åˆ›å»ºï¼‰ä»»æ„ä½ç½®æ–°å¢ä»¥ä¸‹ä¸¤ä¸ªæ–‡ä»¶</p>
<blockquote>
<p>iam()å‡½æ•°æ–‡ä»¶</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define __LIBRARY__
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="nf">_syscall1</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="n">iam</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span><span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">argc</span><span class="o">&lt;=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;NO Input!(&gt;_&lt;)(&gt;_&lt;)(&gt;_&lt;)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="nf">iam</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;.........Sys Call Exception!(&gt;_&lt;)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>whoami()å‡½æ•°æ–‡ä»¶</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define __LIBRARY__
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define N 256
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nf">_syscall2</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="n">whoami</span><span class="p">,</span><span class="kt">char</span><span class="o">*</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span><span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">num</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">temp</span><span class="p">[</span><span class="n">N</span><span class="p">]</span><span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">num</span><span class="o">=</span><span class="nf">whoami</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span><span class="n">N</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">num</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">temp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;num &lt;0 System Call Exception!(&gt;_&lt;)&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ–°å¢å®Œæˆåæ‰§è¡Œ<code>sudo umount hdc</code>è§£é™¤æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½</p>
<h3 id="3ä¿®æ”¹system_callsæ–‡ä»¶">3.ä¿®æ”¹system_call.sæ–‡ä»¶<a hidden class="anchor" aria-hidden="true" href="#3ä¿®æ”¹system_callsæ–‡ä»¶">#</a></h3>
<p>åœ¨è·¯å¾„<code>/oslab/linux-0.11/kernel</code>ä¸‹</p>
<p>ä¿®æ”¹ç³»ç»Ÿè°ƒç”¨æ€»æ•°</p>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012339243.png" alt="image-20220320161028591"  />
</p>
<h3 id="4ä¿®æ”¹syshæ–‡ä»¶">4.ä¿®æ”¹sys.hæ–‡ä»¶<a hidden class="anchor" aria-hidden="true" href="#4ä¿®æ”¹syshæ–‡ä»¶">#</a></h3>
<p>è·¯å¾„ï¼š<code>/oslab/linux-0.11/include/linux</code></p>
<p>åœ¨å‡½æ•°è¡¨å†…å¢åŠ ä¸¤ä¸ªå¼•ç”¨ï¼Œä½ç½®éœ€è¦ä¸€ä¸€å¯¹åº”ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">int</span> <span class="nf">sys_whoami</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">int</span> <span class="nf">sys_iam</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ•ˆæœå¦‚ä¸‹</p>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012339276.png" alt="image-20220320161036960"  />
</p>
<p><strong>sys_call_tableæ•°ç»„å†…åŠ å…¥sys_whoamiå’Œsys_iamï¼Œæ³¨æ„é¡ºåºä¸€è‡´</strong></p>
<h3 id="5åˆ›å»ºwhocæ–‡ä»¶">5.åˆ›å»ºwho.cæ–‡ä»¶<a hidden class="anchor" aria-hidden="true" href="#5åˆ›å»ºwhocæ–‡ä»¶">#</a></h3>
<p>æ¯ä¸ªç³»ç»Ÿè°ƒç”¨éƒ½æœ‰ä¸€ä¸ª sys_xxxxxx() ä¸ä¹‹å¯¹åº”ï¼Œæ‰€ä»¥å¢åŠ çš„ä¸¤ä¸ªå‡½æ•°è°ƒç”¨ä¹Ÿéœ€è¦æœ‰è¿™ç§å‡½æ•°ä¸å…¶å¯¹åº”</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define __LIBRARY__
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;asm/segment.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="n">mem</span><span class="p">[</span><span class="mi">80</span><span class="p">]</span><span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">sys_iam</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span><span class="nf">get_fs_byte</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="n">i</span><span class="p">)</span><span class="o">!=</span><span class="sc">&#39;\0&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">&gt;=</span><span class="mi">24</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//    else
</span></span></span><span class="line"><span class="cl"><span class="c1">//    {
</span></span></span><span class="line"><span class="cl"><span class="c1">//        printk(&#34;strlen(%s) = %d\n&#34;,mem,i);
</span></span></span><span class="line"><span class="cl"><span class="c1">//    }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">((</span><span class="n">mem</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="nf">get_fs_byte</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="n">j</span><span class="p">))</span><span class="o">!=</span><span class="sc">&#39;\0&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">j</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nf">printk</span><span class="p">(</span><span class="s">&#34;strlen(%s) = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">mem</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">j</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">sys_whoami</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">mem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="sc">&#39;\0&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">&gt;</span><span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span><span class="n">mem</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">!=</span><span class="sc">&#39;\0&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">put_fs_byte</span><span class="p">(</span><span class="n">mem</span><span class="p">[</span><span class="n">j</span><span class="p">],(</span><span class="n">name</span><span class="o">+</span><span class="n">j</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">j</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">j</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;asm/segment.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="n">_myname</span><span class="p">[</span><span class="mi">24</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">sys_iam</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">str</span><span class="p">[</span><span class="mi">25</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">str</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">get_fs_byte</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">25</span> <span class="o">&amp;&amp;</span> <span class="n">str</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">24</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">errno</span> <span class="o">=</span> <span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">strcpy</span><span class="p">(</span><span class="n">_myname</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">sys_whoami</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">_myname</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printk</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">_myname</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">errno</span> <span class="o">=</span> <span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">length</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="nf">put_fs_byte</span><span class="p">(</span><span class="n">_myname</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">name</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å°†è¿™ä¸ªæ–‡ä»¶ä¿å­˜åœ¨kernelæ–‡ä»¶å¤¹ä¸‹</p>
<h3 id="6ä¿®æ”¹makefileæ–‡ä»¶">6.ä¿®æ”¹Makefileæ–‡ä»¶<a hidden class="anchor" aria-hidden="true" href="#6ä¿®æ”¹makefileæ–‡ä»¶">#</a></h3>
<p><code>kernel/Makefile</code></p>
<p>æ‰¾åˆ°å¦‚ä¸‹å†…å®¹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">OBJS  = sched.o system_call.o traps.o asm.o fork.o \
</span></span><span class="line"><span class="cl">        panic.o printk.o vsprintf.o sys.o exit.o \
</span></span><span class="line"><span class="cl">        signal.o mktime.o
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¹¶æ›´æ”¹ä¸º</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">OBJS  = sched.o system_call.o traps.o asm.o fork.o \
</span></span><span class="line"><span class="cl">        panic.o printk.o vsprintf.o sys.o exit.o \
</span></span><span class="line"><span class="cl">        signal.o mktime.o who.o
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ‰¾åˆ°å¦‚ä¸‹å†…å®¹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">### Dependencies:</span>
</span></span><span class="line"><span class="cl">exit.s exit.o: exit.c ../include/errno.h ../include/signal.h <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  ../include/sys/types.h ../include/sys/wait.h ../include/linux/sched.h <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  ../include/linux/head.h ../include/linux/fs.h ../include/linux/mm.h <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  ../include/linux/kernel.h ../include/linux/tty.h ../include/termios.h <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  ../include/asm/segment.h
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¹¶æ›´æ”¹ä¸º</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">### Dependencies:</span>
</span></span><span class="line"><span class="cl">who.s who.o: who.c ../include/linux/kernel.h ../include/unistd.h
</span></span><span class="line"><span class="cl">exit.s exit.o: exit.c ../include/errno.h ../include/signal.h <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  ../include/sys/types.h ../include/sys/wait.h ../include/linux/sched.h <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  ../include/linux/head.h ../include/linux/fs.h ../include/linux/mm.h <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  ../include/linux/kernel.h ../include/linux/tty.h ../include/termios.h <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  ../include/asm/segment.h
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¿®æ”¹å®Œæˆåæ‰§è¡Œmakeå‘½ä»¤å³å¯ã€‚</p>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012339264.png" alt="image-20220320161047028"  />
</p>
<h3 id="7è¿è¡Œæ›´æ”¹åçš„ç³»ç»Ÿ">7.è¿è¡Œæ›´æ”¹åçš„ç³»ç»Ÿ<a hidden class="anchor" aria-hidden="true" href="#7è¿è¡Œæ›´æ”¹åçš„ç³»ç»Ÿ">#</a></h3>
<p>åœ¨oslabæ ¹ç›®å½•å†…è¾“å…¥**./run**å‘½ä»¤è¿›è¡Œè°ƒè¯•
ç„¶åè¿›å…¥iam.cå’Œwhoami.cçš„ç›®å½•æ‰§è¡Œä¸‹åˆ—å‘½ä»¤</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">gcc iam.c -o iam
</span></span><span class="line"><span class="cl">gcc whoami.c -o whoami
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="é‡åˆ°çš„é—®é¢˜"><code>é‡åˆ°çš„é—®é¢˜</code><a hidden class="anchor" aria-hidden="true" href="#é‡åˆ°çš„é—®é¢˜">#</a></h4>
<p>ç¼–è¯‘å‡ºé”™ï¼š</p>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012339291.png" alt="image-20220319223324641"  />
</p>
<p><strong>é—®é¢˜å‡ºåœ¨å¤´æ–‡ä»¶ä¸Šé¢ï¼ï¼ï¼</strong></p>
<p>==åœ¨ 0.11 ç¯å¢ƒä¸‹ç¼–è¯‘ C ç¨‹åºï¼ŒåŒ…å«çš„å¤´æ–‡ä»¶éƒ½åœ¨ <code>/usr/include</code> ç›®å½•ä¸‹ã€‚==</p>
<blockquote>
<p>è¯¥ç›®å½•ä¸‹çš„ <code>unistd.h</code> æ˜¯æ ‡å‡†å¤´æ–‡ä»¶ï¼ˆå®ƒå’Œ 0.11 æºç æ ‘ä¸­çš„ <code>unistd.h</code>==å¹¶ä¸æ˜¯åŒä¸€ä¸ªæ–‡ä»¶==ï¼Œè™½ç„¶å†…å®¹å¯èƒ½ç›¸åŒï¼‰ï¼Œæ²¡æœ‰ <code>__NR_whoami</code> å’Œ <code>__NR_iam</code> ä¸¤ä¸ªå®ï¼Œéœ€è¦æ‰‹å·¥åŠ ä¸Šå®ƒä»¬ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä»ä¿®æ”¹è¿‡çš„ 0.11 æºç æ ‘ä¸­æ‹·è´æ–°çš„ unistd.h è¿‡æ¥ã€‚</p>
</blockquote>
<p>åœ¨å†…æ ¸ä¸­çš„ä»£ç åŒ…å«çš„å¤´æ–‡ä»¶æ˜¯åœ¨<code>/usr/include</code> ä¸‹æ‰¾çš„ï¼Œä½†æ˜¯æˆ‘æ²¡æœ‰åœ¨è¯¥ç›®å½•ä¸‹çš„<code>unistd.h</code>ä¿®æ”¹ï¼Œæ‰€ä»¥ä¸€ç›´æç¤ºæ‰¾ä¸åˆ°å¤´æ–‡ä»¶ä¸­å®šä¹‰çš„å‡½æ•°</p>
<p>æŠŠ<code>linux-0.11/include/unistd.h</code>æ‹·è´åˆ°<code>hdc/usr/include</code>ä¸‹</p>
<p>å†æ¬¡ç¼–è¯‘ï¼Œå°±æ²¡æŠ¥é”™äº†ï¼ˆç¼–è¯‘å®Œåè¦<code>sync</code>ï¼‰ ä¸ç„¶ç¼–è¯‘åçš„æ–‡ä»¶å…³æ‰åå†æ‰“å¼€å°±ä¸è§äº†</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">gcc iam.c -o iam
</span></span><span class="line"><span class="cl">gcc whoami.c -o whoami
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sync
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012339724.png" alt="image-20220328184347614"  />
</p>
<p><strong>ç»“æœï¼š</strong></p>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012339743.png" alt="image-20220328190335212"  />
</p>
<p>æœ€åæ‰§è¡Œå¯æ‰§è¡Œæ–‡ä»¶iamå’Œwhoamiè¿›è¡Œæµ‹è¯•
iamæµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š</p>
<img src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012339759.png" alt="image-20220320161100835" style="zoom:80%;" />
<p>whoamiæµ‹è¯•ç»“æœå¦‚ä¸‹:</p>
<img src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012339782.png" alt="image-20220320161111272" style="zoom:80%;" />
<h2 id="6-å®éªŒæŠ¥å‘Š">6. å®éªŒæŠ¥å‘Š<a hidden class="anchor" aria-hidden="true" href="#6-å®éªŒæŠ¥å‘Š">#</a></h2>
<h3 id="é—®é¢˜ä¸€">é—®é¢˜ä¸€<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜ä¸€">#</a></h3>
<p>Linux-0.11çš„ç³»ç»Ÿè°ƒç”¨é€šè¿‡å¯„å­˜å™¨ebxã€ecxã€edxä¼ é€’å‚æ•°ï¼Œæœ€å¤šèƒ½ä¼ é€’3ä¸ªå‚æ•°ã€‚
æ‰©å¤§ä¼ é€’å‚æ•°çš„æ•°é‡çš„æ–¹æ³•ï¼š</p>
<ul>
<li>å¢åŠ ä¼ å‚æ‰€ç”¨çš„å¯„å­˜å™¨ï¼›</li>
<li>åˆ©ç”¨è‡ªå®šä¹‰çš„ç»“æ„ä½“è¾…åŠ©å‚æ•°çš„ä¼ é€’ï¼ˆcè¯­è¨€ç»“æ„ä½“ï¼‰ï¼›</li>
<li>å°†å¯„å­˜å™¨æ‹†åˆ†ä¸ºé«˜ä½å’Œä½ä½ä¼ é€’ä¸€ç›´æ¯”è¾ƒå°çš„å‚æ•°ï¼›</li>
<li>åˆ©ç”¨å †æ ˆä¼ é€’å‚æ•°ã€‚</li>
</ul>
<h3 id="é—®é¢˜äºŒ">é—®é¢˜äºŒ<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜äºŒ">#</a></h3>
<p>1.åœ¨include/unistd.hä¸­å®šä¹‰å®__NR_fooï¼Œå¹¶æ·»åŠ ä¾›ç”¨æˆ·è°ƒç”¨çš„å‡½æ•°å£°æ˜void foo()ï¼›</p>
<p>2.ä¿®æ”¹kernel/system_call.sä¸­çš„nr_system_callsï¼Œå¢åŠ æ–°çš„ç³»ç»Ÿè°ƒç”¨ï¼›</p>
<p>3.åœ¨include/linux/sys.hä¸­æ·»åŠ å‡½æ•°å£°æ˜extern void sys_foo()ï¼Œåœ¨ç³»ç»Ÿè°ƒç”¨å…¥å£è¡¨fn_ptræœ«ç«¯æ·»åŠ å…ƒç´ sys_fooï¼›</p>
<p>4.æ·»åŠ kernel/foo.cæ–‡ä»¶ï¼Œå®ç°sys_foo()å‡½æ•°ï¼›</p>
<p>5.ä¿®æ”¹kernel/Makefileï¼Œåœ¨OBJSä¸­åŠ å…¥foo.oï¼Œå¹¶æ·»åŠ ç”Ÿæˆfoo.sã€foo.oçš„ä¾èµ–è§„åˆ™ï¼›</p>
<p>6.é‡æ–°æ‰§è¡Œmakeå‘½ä»¤ï¼Œå¹¶è¿›å…¥æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿå†…è¿›è¡Œç¼–è¯‘æµ‹è¯•ã€‚</p>


  </div>

  <footer class="post-footer">
    
<nav class="paginav">
  <a class="prev" href="https://chance7bin.github.io/posts/basic/pattern/%E5%88%9B%E5%BB%BA%E5%9E%8B%E6%A8%A1%E5%BC%8F/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>åˆ›å»ºå‹æ¨¡å¼</span>
  </a>
  <a class="next" href="https://chance7bin.github.io/posts/basic/os/%E4%B8%89%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>ä¸‰ã€å†…å­˜ç®¡ç†</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://chance7bin.github.io/">Binb&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerHTML = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
