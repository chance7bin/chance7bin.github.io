<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>ä¸€ã€å†…æ ¸å¯åŠ¨ | Binb&#39;s Blog</title>
<meta name="keywords" content="æ“ä½œç³»ç»Ÿ">
<meta name="description" content="å¼•å¯¼å¯åŠ¨ç¨‹åº&mdash;bootsect 1.ç®€ä»‹ å†¯Â·è¯ºä¾æ›¼å­˜å‚¨ç¨‹åºæ€æƒ³ å­˜å‚¨ç¨‹åºçš„ä¸»è¦æ€æƒ³ï¼šå°†ç¨‹åºå’Œæ•°æ®å­˜æ”¾åˆ°è®¡ç®—æœºå†…éƒ¨çš„å­˜å‚¨å™¨ä¸­ï¼Œè®¡ç®—æœºåœ¨">
<meta name="author" content="chance7bin">
<link rel="canonical" href="https://chance7bin.github.io/posts/basic/os/%E4%B8%80%E5%86%85%E6%A0%B8%E5%90%AF%E5%8A%A8/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.be81eec981a615a87a88f121642d7eebde74d033438693944db2fd6b827284ff.css" integrity="" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.acb54fd32bbc1982428b8850317e45d076b95012730a5936667e6bc21777692a.js" integrity=""
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<link rel="icon" type="image/png" sizes="16x16" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<link rel="icon" type="image/png" sizes="32x32" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<link rel="apple-touch-icon" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<link rel="mask-icon" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="ä¸€ã€å†…æ ¸å¯åŠ¨" />
<meta property="og:description" content="å¼•å¯¼å¯åŠ¨ç¨‹åº&mdash;bootsect 1.ç®€ä»‹ å†¯Â·è¯ºä¾æ›¼å­˜å‚¨ç¨‹åºæ€æƒ³ å­˜å‚¨ç¨‹åºçš„ä¸»è¦æ€æƒ³ï¼šå°†ç¨‹åºå’Œæ•°æ®å­˜æ”¾åˆ°è®¡ç®—æœºå†…éƒ¨çš„å­˜å‚¨å™¨ä¸­ï¼Œè®¡ç®—æœºåœ¨" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://chance7bin.github.io/posts/basic/os/%E4%B8%80%E5%86%85%E6%A0%B8%E5%90%AF%E5%8A%A8/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-14T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-05-14T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ä¸€ã€å†…æ ¸å¯åŠ¨"/>
<meta name="twitter:description" content="å¼•å¯¼å¯åŠ¨ç¨‹åº&mdash;bootsect 1.ç®€ä»‹ å†¯Â·è¯ºä¾æ›¼å­˜å‚¨ç¨‹åºæ€æƒ³ å­˜å‚¨ç¨‹åºçš„ä¸»è¦æ€æƒ³ï¼šå°†ç¨‹åºå’Œæ•°æ®å­˜æ”¾åˆ°è®¡ç®—æœºå†…éƒ¨çš„å­˜å‚¨å™¨ä¸­ï¼Œè®¡ç®—æœºåœ¨"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "ğŸ“š æ–‡ç« ",
      "item": "https://chance7bin.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ“• è®¡ç®—æœºåŸºç¡€",
      "item": "https://chance7bin.github.io/posts/basic/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "æ“ä½œç³»ç»Ÿ",
      "item": "https://chance7bin.github.io/posts/basic/os/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "ä¸€ã€å†…æ ¸å¯åŠ¨",
      "item": "https://chance7bin.github.io/posts/basic/os/%E4%B8%80%E5%86%85%E6%A0%B8%E5%90%AF%E5%8A%A8/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "ä¸€ã€å†…æ ¸å¯åŠ¨",
  "name": "ä¸€ã€å†…æ ¸å¯åŠ¨",
  "description": "å¼•å¯¼å¯åŠ¨ç¨‹åº\u0026mdash;bootsect 1.ç®€ä»‹ å†¯Â·è¯ºä¾æ›¼å­˜å‚¨ç¨‹åºæ€æƒ³ å­˜å‚¨ç¨‹åºçš„ä¸»è¦æ€æƒ³ï¼šå°†ç¨‹åºå’Œæ•°æ®å­˜æ”¾åˆ°è®¡ç®—æœºå†…éƒ¨çš„å­˜å‚¨å™¨ä¸­ï¼Œè®¡ç®—æœºåœ¨",
  "keywords": [
    "æ“ä½œç³»ç»Ÿ"
  ],
  "articleBody": "å¼•å¯¼å¯åŠ¨ç¨‹åºâ€”bootsect 1.ç®€ä»‹ å†¯Â·è¯ºä¾æ›¼å­˜å‚¨ç¨‹åºæ€æƒ³\nå­˜å‚¨ç¨‹åºçš„ä¸»è¦æ€æƒ³ï¼šå°†ç¨‹åºå’Œæ•°æ®å­˜æ”¾åˆ°è®¡ç®—æœºå†…éƒ¨çš„å­˜å‚¨å™¨ä¸­ï¼Œè®¡ç®—æœºåœ¨ç¨‹åºçš„æ§åˆ¶ä¸‹ä¸€æ­¥ä¸€æ­¥è¿›è¡Œå¤„ç†\nè®¡ç®—æœºç”±äº”å¤§éƒ¨ä»¶ç»„æˆï¼šè¾“å…¥è®¾å¤‡ã€è¾“å‡ºè®¾å¤‡ã€å­˜å‚¨å™¨ã€è¿ç®—å™¨ã€æ§åˆ¶å™¨\n==å–æŒ‡æ‰§è¡Œï¼ˆå–æŒ‡ã€{é—´æŒ‡}ã€æ‰§è¡Œã€{ä¸­æ–­} å¤§æ‹¬å·å¯é€‰ ï¼‰==\næ‰“å¼€ç”µæºï¼Œè®¡ç®—æœºæ‰§è¡Œçš„ç¬¬ä¸€å¥æŒ‡ä»¤ä»€ä¹ˆ? æŒ‡é’ˆIPåŠå…¶æŒ‡å‘çš„å†…å®¹\nå¯¹äºX86PCæœºè€Œè¨€ï¼š (1)x86 PCåˆšå¼€æœºæ—¶CPUå¤„äºå®æ¨¡å¼ (2)å¼€æœºæ—¶ï¼ŒCS=0xFFFF; IP=0x0000 (3)å¯»å€0xFFFF0(ROM BIOSæ˜ å°„åŒº) (4)æ£€æŸ¥RAMï¼Œé”®ç›˜ï¼Œæ˜¾ç¤ºå™¨ï¼Œè½¯ç¡¬ç£ç›˜ (5)å°†ç£ç›˜0ç£é“0æ‰‡åŒºè¯»å…¥0x7c00å¤„ (6)è®¾ç½®cs=0x07c0ï¼Œip=0x0000\næ³¨ï¼šå®æ¨¡å¼å’Œä¿æŠ¤æ¨¡å¼å¯¹åº”ï¼Œå®æ¨¡å¼çš„å¯»å€CS:IP(CSå·¦ç§»4ä½+IP)ï¼Œ å’Œä¿æŠ¤æ¨¡å¼(32ä½æ±‡ç¼–æ¨¡å¼ä¸‹)ä¸ä¸€\n0x7c00å¤„å­˜æ”¾çš„ä»£ç ï¼šä»ç£ç›˜å¼•å¯¼æ‰‡åŒºè¯»å…¥çš„512ä¸ªå­—èŠ‚\n1.å¼•å¯¼æ‰‡åŒºå°±æ˜¯==å¯åŠ¨è®¾å¤‡çš„ç¬¬ä¸€ä¸ªæ‰‡åŒº==ï¼ˆå¼€æœºæ—¶æŒ‰ä½delé”®å¯è¿›å…¥å¯åŠ¨è®¾å¤‡è®¾ç½®ç•Œé¢ï¼Œå¯ ä»¥è®¾ç½®ä¸ºå…‰ç›˜å¯åŠ¨!ï¼‰\n2.å¯åŠ¨è®¾å¤‡ä¿¡æ¯è¢«è®¾ç½®åœ¨CMOSä¸­ï¼ˆCMOS: (64B-128B)ã€‚ç”¨æ¥å­˜å‚¨å®æ—¶é’Ÿå’Œç¡¬ä»¶é…ç½®ä¿¡æ¯ã€‚ï¼‰\nå› æ­¤ï¼Œç¡¬ç›˜çš„ç¬¬ä¸€ä¸ªæ‰‡åŒºä¸Šå­˜æ”¾ç€å¼€æœºåæ‰§è¡Œçš„ç¬¬ä¸€æ®µæˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„ç¨‹åº\n==æ“ä½œç³»ç»Ÿçš„æ•…äº‹ä»è¿™é‡Œå¼€å§‹â€¦==\n2.æ“ä½œç³»ç»Ÿå¯åŠ¨æµç¨‹ bootsect.så’Œsetup.sæ˜¯å®æ—¶æ¨¡å¼ä¸‹è¿è¡Œçš„16ä½ä»£ç ç¨‹åºï¼Œé‡‡ç”¨è¿‘ä¼¼Intelè¯­æ³•ï¼Œè€Œhead.sä½¿ç”¨GUNæ±‡ç¼–æ ¼å¼(AT\u0026T),å¹¶ä¸”è¿è¡Œåˆ°ä¿æŠ¤æ¨¡å¼ä¸‹ã€‚\nå½“PCçš„ç”µæºæ‰“å¼€åï¼ŒCPUè‡ªåŠ¨è¿›å…¥å®æ¨¡å¼ï¼Œå¹¶ä»åœ°å€0XFFFF0å¼€å§‹æ‰§è¡Œç¨‹åºä»£ç ï¼Œè¿™ä¸ªåœ°å€é€šå¸¸æ˜¯ROM-BIOSä¸­çš„åœ°å€ï¼ŒPCæœºçš„BIOSå°†æ‰§è¡ŒæŸäº›ç³»ç»Ÿæ£€æµ‹ï¼Œå¹¶åœ¨ç‰©ç†åœ°å€0å¤„å¼€å§‹åˆå§‹åŒ–ä¸­æ–­å‘é‡ã€‚ç„¶åï¼Œå®ƒå°†å¯ä»¥å¯åŠ¨è®¾å¤‡çš„ç¬¬ä¸€ä¸ªæ‰‡åŒº(ç£ç›˜å¼•å¯¼æ‰‡åŒºï¼Œ512byte)è¯»å…¥å†…å­˜ç»å¯¹åœ°å€0x7C00å¤„ï¼Œå¹¶è·³è½¬åˆ°è¿™ä¸ªåœ°æ–¹ï¼Œå¯åŠ¨è®¾å¤‡é€šå¸¸æ˜¯è½¯é©±æˆ–è€…ç¡¬ç›˜ã€‚\nLinuxæœ€å‰é¢éƒ¨åˆ†(boot/bootsect.s)ï¼Œå®ƒå°†ç”±BIOSè¯»å…¥å†…å­˜ç»å¯¹åœ°å€0x7C00å¤„ï¼Œå½“å®ƒè¢«æ‰§è¡Œæ—¶å°±ä¼šæŠŠè‡ªå·±ç§»åŠ¨åˆ°å†…å­˜ç»å¯¹åœ°å€0X90000å¤„ï¼Œå¹¶æŠŠå¯åŠ¨è®¾å¤‡ä¸­å2kbå­—èŠ‚ä»£ç (boot/setup.s)è¯»å…¥åˆ°å†…å­˜0x90200å¤„ï¼Œè€Œå†…æ ¸çš„å…¶ä»–éƒ¨åˆ†(systemæ¨¡å—ï¼‰åˆ™è¢«è¯»å…¥åˆ°å†…å­˜åœ°å€0x10000å¼€å§‹å¤„\nsetup.så°†ä¼šæŠŠsystemæ¨¡å—ç§»åŠ¨åˆ°ç‰©ç†å†…å­˜èµ·å§‹ä½ç½®å¤„ï¼Œè¿™æ ·systemæ¨¡å—ä¸­ä»£ç çš„åœ°å€å°±ç­‰äºå®é™…çš„ç‰©ç†åœ°å€ï¼Œä¾¿äºå¯¹å†…æ ¸ä»£ç å’Œæ•°æ®æ“ä½œã€‚\nä»æœºå™¨åŠ ç”µå¼€å§‹æ‰§è¡Œé¡ºåº å¯åŠ¨å¼•å¯¼æ—¶å†…æ ¸åœ¨å†…å­˜ä¸­çš„ä½ç½®å’Œç§»åŠ¨ï¼š æ•´ä¸ªç³»ç»Ÿä»åœ°å€0x10000ç§»è‡³0x0000å¤„ï¼Œè¿›å…¥ä¿æŠ¤æ¨¡å¼å¹¶è·³è½¬è‡³ç³»ç»Ÿçš„ä½™ä¸‹éƒ¨åˆ†(åœ¨0x0000chu)ã€‚æ­¤æ—¶æ‰€æœ‰çš„32ä½è¿è¡Œæ–¹å¼çš„è®¾ç½®å¯åŠ¨è¢«å®Œæˆï¼šIDT,GDTå’ŒLDTè¢«åŠ è½½ï¼Œå¤„ç†å™¨å’Œåå¤„ç†å™¨ä¹Ÿç¡®è®¤ï¼Œåˆ†é¡µå·¥ä½œä¹Ÿè®¾ç½®å®Œæˆã€‚\næœ€ç»ˆè°ƒç”¨init/main.cä¸­main()ç¨‹åº\n3.å¼•å¯¼æ‰‡åŒºä»£ç : bootsect.s bootsect.sä»£ç æ˜¯ç£ç›˜å¼•å¯¼å—ç¨‹åºï¼Œé©»ç•™åœ¨ç£ç›˜çš„ç¬¬ä¸€ä¸ªæ‰‡åŒºä¸­ï¼ˆå¼•å¯¼æ‰‡åŒºï¼Œ0ç£é“ï¼ˆæŸ±é¢ï¼‰ï¼Œ0ç£å¤´ï¼Œç¬¬ä¸€ä¸ªæ‰‡åŒºï¼‰\nåœ¨PCæœºåŠ ç”µROM BIOSè‡ªæ£€åï¼ŒROM BIOSä¼šæŠŠå¼•å¯¼æ‰‡åŒºä»£ç bootsectåŠ è½½åˆ°å†…å­˜åœ°å€0x7C00å¼€å§‹å¤„å¹¶æ‰§è¡Œä¹‹ã€‚åœ¨bootsectä»£ç æ‰§è¡ŒæœŸé—´ï¼Œå®ƒä¼šå°†è‡ªå·±ç§»åŠ¨åˆ°å†…å­˜ç»å¯¹åœ°å€0x90000å¼€å§‹å¤„å¹¶ç»§ç»­æ‰§è¡Œã€‚\nè¯¥ç¨‹åºçš„ä¸»è¦ä½œç”¨æ˜¯é¦–å…ˆæŠŠä»ç£ç›˜ç¬¬2ä¸ªæ‰‡åŒºå¼€å§‹çš„4ä¸ªæ‰‡åŒºçš„setupæ¨¡å—(ç”± setup.sç¼–è¯‘è€Œæˆ)åŠ è½½åˆ°å†…å­˜ç´§æ¥ç€bootsectåé¢ä½ç½®å¤„(0x90200),ç„¶ååˆ©ç”¨BIOSä¸­æ–­ 0x13 ï¼Œå–ç£ç›˜å‚æ•°è¡¨ä¸­å½“å‰å¯åŠ¨å¼•å¯¼ç›˜çš„å‚æ•°ï¼Œæ¥ç€åœ¨å±å¹•ä¸Šæ˜¾ç¤ºâ€œLoading system.â€å­—ç¬¦ä¸²ã€‚\nå†æŠŠç£ç›˜ä¸Šsetupæ¨¡å—åé¢çš„systemæ¨¡å—åŠ è½½åˆ°å†…å­˜0x10000å¼€å§‹çš„åœ°æ–¹ã€‚éšåç¡®å®šæ ¹æ–‡ä»¶ç³»ç»Ÿçš„è®¾å¤‡å·ï¼Œè‹¥æ²¡æœ‰æŒ‡å®šï¼Œåˆ™æ ¹æ®æ‰€ä¿å­˜çš„å¼•å¯¼ç›˜çš„æ¯ç£é“æ‰‡åŒºæ•°åˆ¤åˆ«å‡ºç›˜çš„ç±»å‹å’Œç§ç±»å¹¶ä¿å­˜å…¶è®¾å¤‡å·äº root_dev( å¼•å¯¼å—çš„508åœ°å€å¤„)ï¼Œæœ€åé•¿è·³è½¬åˆ°setupç¨‹åºçš„å¼€å§‹å¤„(0x00200)æ‰§è¡Œsetupç¨‹åºã€‚\nå„æºæ–‡ä»¶ä½ç½® 1.ç”±BIOSè¯»å…¥å†…å­˜ç»å¯¹åœ°å€0x7C00å¤„ï¼Œå½“å®ƒè¢«æ‰§è¡Œæ—¶å°±ä¼šæŠŠè‡ªå·±ç§»åŠ¨åˆ°å†…å­˜ç»å¯¹åœ°å€0X90000å¤„\nds:si\nes:di\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 ; bootsectå¯åŠ¨ç¨‹åºå°†å®ƒè‡ªèº«ä»å†…å®¹0x07c00(BOOTSEG)å¤„å¤åˆ¶è‡³å†…å­˜0x9000(INITSEG)å¤„ entry start ;å…³é”®å­—entryå‘Šè¯‰é“¾æ¥å™¨\"ç¨‹åºå…¥å£\" start: mov\tax,#BOOTSEG ;BOOTSEG = 0x07c0 èµ‹å€¼ç»™axï¼Œ mov\tds,ax ;æºåœ°å€ mov\tax,#INITSEG ;INITSEG = 0x9000 èµ‹å€¼ç»™bx mov\tes,ax\t;ç›®æ ‡åœ°å€ mov\tcx,#256 ;å¾ªç¯æ¬¡æ•°ï¼Œæ¯æ¬¡å¾ªç¯å®Œæ¬¡æ•°å‡ä¸€ sub\tsi,si ;æ¸…é›¶ sub\tdi,di ;æ¸…é›¶ rep\t;repæ˜¯repeatï¼Œrepé…åˆ movw(movsb) å°±æ˜¯å¤šæ¬¡å¤åˆ¶ç›´åˆ°cx=0ä¸ºæ­¢ å¤åˆ¶çš„æ¬¡æ•°æ”¾åœ¨cxä¸­ movw ;ç”¨äºæŠŠå†…å®¹ä»ds:si å¤åˆ¶es:di ä»¥å­—ä½å•ä½ jmpi\tgo,INITSEG ;é—´æ¥è·³è½¬ å³ç¨‹åºè·³åˆ°9000:0 å»ç»§ç»­æ‰§è¡Œ CS=INITSEGï¼ŒIP=go(åç§»åœ°å€) ; ä»è¿™é‡Œå¼€å§‹cpuå·²ç»è·³åˆ°å†…å­˜0x90000å»æ‰§è¡Œï¼Œ ; BIOSæŠŠå¼•å¯¼æ‰‡åŒºåŠ è½½åˆ°0x7c00å¤„å¹¶æŠŠæ‰§è¡Œæƒäº¤ç»™å¼•å¯¼ç¨‹åºï¼Œ(ss=0x00,sp=0xfffe) ; å°†ds,es,ss,éƒ½è®¾ç½®æˆç§»åŠ¨åä»£ç æ‰€åœ¨æ®µ(0x9000) go:\tmov\tax,cs ;ax = cs = INITSEG = 0x9000 mov\tds,ax ;æ•°æ®æ®µåœ°å€ mov\tes,ax ;é™„åŠ æ®µåœ°å€ ! put stack at 0x9ff00. ;å°†å †æ ˆæŒ‡é’ˆspæŒ‡å‘0x9fff00(0x9000:0xff00) mov\tss,ax ;æ ˆæ®µåœ°å€ ; ä¿è¯æ ˆæŒ‡é’ˆspåªè¦æŒ‡å‘è¿œå¤§äº512byteå­—èŠ‚åç§»(å³åœ°å€0x90200) ; å› ä¸ºåœ¨0x90200åè¦å­˜æ”¾setupç¨‹åºï¼Œå¤§çº¦ä¸º4ä¸ªæ‰‡åŒº spæŒ‡å‘å¤§äº(0x200+0x200*4+å †æ ˆå¤§å°) mov\tsp,#0xFF00\t! arbitrary value \u003e\u003e512 ! load the setup-sectors directly after the bootblock. ; åœ¨bootsectç¨‹åºç´§è·Ÿç€åŠ è½½setupç¨‹åº ! Note that 'es' is already set up. ; esåœ¨ç§»åŠ¨ä»£ç æ—¶è®¾ç½®å¥½äº†æŒ‡å‘ç›®çš„åœ°å€0x9000 2.åˆ©ç”¨BIOSä¸­æ–­ INT 0x13 å°†setupæ¨¡å—ä»ç£ç›˜ç¬¬2ä¸ªæ‰‡åŒºå¼€å§‹è¯»åˆ°0x90200,ç„¶åå–ç£ç›˜å‚æ•°è¡¨ä¸­å½“å‰å¯åŠ¨å¼•å¯¼ç›˜çš„å‚æ•°ï¼Œæ¥ç€åœ¨å±å¹•ä¸Šæ˜¾ç¤ºâ€œLoading system.â€å­—ç¬¦ä¸²\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 ; è¿™ä¸€æ®µä¸»è¦æ˜¯åˆ©ç”¨BIOSä¸­æ–­ INT 0x13 å°†setupæ¨¡å—ä»ç£ç›˜ç¬¬2ä¸ªæ‰‡åŒºå¼€å§‹è¯»åˆ°0x90200, ; ä¸€ä¸ªå››ä¸ªæ‰‡åŒºï¼Œå¦‚æœè¯»é”™ï¼Œåˆ™å¤ä½é©±åŠ¨å™¨ï¼Œå¹¶é‡è¯• ; INT 0x13 ä½¿ç”¨æ–¹æ³•ï¼š ; è¯»æ‰‡åŒºï¼š ; ah = 0x02 --è¯»ç£ç›˜æ‰‡åŒºåˆ°å†…å­˜ ; al = éœ€è¦è¯»å‡ºçš„æ‰‡åŒºæ•°é‡ ; ch = ç£é“(æŸ±é¢)å·ä½8ä½ ; cl = å¼€å§‹æ‰‡åŒº(ä½0-5)ï¼Œç£é“å·é«˜ä¸¤ä½(ä½6-7) ; dh = ç£å¤´å· ; dl = é©±åŠ¨å™¨å·(å¦‚æœæ˜¯ç¡¬ç›˜åˆ™ä½7è¦ç½®ä½) ; es:bx--\u003eæŒ‡å‘æ•°æ®ç¼“å­˜åŒº ï¼Œå¦‚æœå‡ºé”™åˆ™CFæ ‡å¿—ç½®ä½ï¼Œahä¸­æ˜¯å‡ºé”™ç  load_setup: mov\tdx,#0x0000\t! drive 0, head 0 mov\tcx,#0x0002\t! sector 2, track 0 mov\tbx,#0x0200\t! address = 512, in INITSEG mov\tax,#0x0200+SETUPLEN\t! service 2, nr of sectors int\t0x13\t! read it ; JNC:Jump Not Carry æ²¡è¿›ä½æ—¶è·³è½¬ æ­£ç¡®è¯»å–æ—¶CF=0 jnc\tok_load_setup\t! ok - continue ; è¯»å–å‡ºé”™ï¼Œå¯¹é©±åŠ¨å™¨0è¿›è¡Œè¯»æ“ä½œ å¹¶é‡æ–°è¯»å–åŠ è½½setupç¨‹åº mov\tdx,#0x0000 mov\tax,#0x0000\t! reset the diskette int\t0x13 j\tload_setup ! jmpæŒ‡ä»¤ è¿”å›åˆ°é‡æ–°åŠ è½½setupå¤„ ok_load_setup: ! Get disk drive parameters, specifically nr of sectors/track ; å–ç£ç›˜é©±åŠ¨å™¨çš„å‚æ•°ï¼Œç‰¹åˆ«æ˜¯æ¯é“çš„æ‰‡åŒºæ•°é‡ ; å–ç£ç›˜é©±åŠ¨å™¨çš„å‚æ•° INT 0x13è°ƒç”¨æ ¼å¼å’Œè¿”å›ä¿¡æ¯ï¼š ; è°ƒç”¨æ ¼å¼: ; ah = 0x08 dl = é©±åŠ¨å™¨å·(å¦‚æœæ˜¯ç¡¬ç›˜åˆ™ä½7è¦ç½®ä½) ; è¿”å›ä¿¡æ¯ï¼š ; å¦‚æœå‡ºé”™ï¼Œåˆ™CFå€¼ä½ï¼Œå¹¶ä¸”ah = çŠ¶æ€ç  ; ah = 0, al = 0 bl = é©±åŠ¨å™¨ç±»å‹(AT/PS2) ; ch = ç£é“(æŸ±é¢)å·ä½8ä½ ; cl = å¼€å§‹æ‰‡åŒº(ä½0-5)ï¼Œç£é“å·é«˜ä¸¤ä½(ä½6-7)\t; dh = æœ€å¤§ç£å¤´æ•° ï¼Œ dl = é©±åŠ¨å™¨æ•°é‡ ; es:di---\u003eè½¯é©±ç£ç›˜å‚æ•°è¡¨ mov\tdl,#0x00 mov\tax,#0x0800\t! AH=8 is get drive parameters int\t0x13 mov\tch,#0x00 ; è¿™æ¡æŒ‡ä»¤è¡¨ç¤ºä¸‹ä¸€æ¡æŒ‡ä»¤çš„æ“ä½œæ•°åœ¨csæ®µå¯„å­˜å™¨æ‰€æŒ‡çš„æ®µä¸­ seg cs ; ä¿æŒæ¯ç£é“æ‰‡åŒºæ•° (cx = æ¯ç£é“æ‰‡åŒºæ•°) mov\tsectors,cx mov\tax,#INITSEG ; ç”±äºä¸Šé¢å–ç£é“å‚æ•°ä¸­æ–­æ”¹æ‰äº†esçš„å€¼ï¼Œè¿™é‡Œé‡æ–°å¤åˆ¶ï¼Œ mov\tes,ax ! Print some inane message ; æ˜¾ç¤ºä¿¡æ¯ï¼š\"'Loading system ...'å›è½¦æ¢è¡Œ\" åŒ…æ‹¬å›è½¦æ¢è¡Œä¸€å…±24ä¸ªå­—ç¬¦ ; BIOSä¸­æ–­0x10åŠŸèƒ½å· ah= 0x03,è¯»å…‰æ ‡çš„ä½ç½® ; è¾“å…¥:bh = é¡µå· ; è¿”å›ï¼šch = æ‰«æå¼€å§‹çº¿ï¼Œcl = ç»“æŸå¼€å§‹çº¿,dh = è¡Œå·(0x00é¡¶ç«¯)ï¼Œdl=åˆ—å·(0x00æœ€å·¦è¾¹) ï¼ ; BIOSä¸­æ–­0x10åŠŸèƒ½å· ah= 0x13,æ˜¾ç¤ºå­—ç¬¦ä¸² ; è¾“å…¥ï¼šal=æ”¾ç½®å…‰æ ‡çš„æ–¹å¼åŠè§„å®šå±æ€§ï¼Œ0x01--è¡¨ç¤ºä½¿ç”¨blä¸­çš„å±æ€§ï¼Œå…‰æ ‡åœåœ¨å­—ç¬¦ä¸²ç»“å°¾å¤„ ; es:bp æ­¤å¯„å­˜å™¨æŒ‡å‘è¦æ˜¾ç¤ºå­—ç¬¦ä¸²èµ·å§‹ä½ç½®å¤„ ; cx = æ˜¾ç¤ºçš„å­—ç¬¦ä¸²å­—ç¬¦æ•° ; bh = æ˜¾ç¤ºé¡µé¢å· bl = å­—ç¬¦å±æ€§ dh = è¡Œå·ï¼Œdl=åˆ—å· mov\tah,#0x03\t! read cursor pos xor\tbh,bh ! é¦–å…ˆè¯»å…‰æ ‡çš„ä½ç½®ï¼Œè¿”å›å…‰æ ‡ä½ç½®å€¼åœ¨dx int\t0x10 ï¼dh = è¡Œ(0-23) dl = åˆ—(0-79) æ˜¾ç¤ºå­—ç¬¦ä¸²ä½¿ç”¨ mov\tcx,#24 ! æ˜¾ç¤º24ä¸ªå­—ç¬¦ mov\tbx,#0x0007\t! page 0, attribute 7 (normal) mov\tbp,#msg1\t! es:bp å¯„å­˜å™¨æŒ‡å‘è¦æ˜¾ç¤ºå­—ç¬¦ä¸²èµ·å§‹ä½ç½®å¤„ mov\tax,#0x1301\t! write string, move cursor int\t0x10 ! ok, we've written the message, now ! we want to load the system (at 0x10000) ; å°†systemåŠ è½½åˆ°0x10000 mov\tax,#SYSSEG mov\tes,ax\t! segment of 0x010000 call\tread_it ; è¯»ç£ç›˜ä¸Šsystemæ¨¡å—ï¼Œesä¸ºè¾“å…¥å‚æ•° call\tkill_motor ; å…³é—­é©±åŠ¨å™¨é©¬è¾¾ï¼Œè¿™æ ·å°±å¯ä»¥çŸ¥é“é©±åŠ¨å™¨çš„çŠ¶æ€ 3.æ£€æµ‹ä½¿ç”¨çš„æ ¹æ–‡ä»¶ç³»ç»Ÿ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 ; æ£€æµ‹ä½¿ç”¨çš„æ ¹æ–‡ä»¶ç³»ç»Ÿ ; å¦‚æœå·²ç»æŒ‡å®šäº†è®¾å¤‡å¹¶ä¸”ä¸ç­‰äº0ï¼Œå°±ç›´æ¥ä½¿ç”¨ç»™å®šçš„è®¾å¤‡ï¼Œå¦åˆ™å°±éœ€è¦æŠ¥é“çš„æ¯ç£é“æ‰‡åŒºæ•°æ¥ ; ç¡®å®šæ˜¯ä½¿ç”¨/dev/PS0(2,28) è¿˜æ˜¯/dev/at0(2,8) ; åœ¨Linuxä¸­è½¯é©±çš„ä¸»è®¾å¤‡æ˜¯2ï¼Œæ¬¡è®¾å¤‡ = type*4 + nr ; typeæ˜¯è½¯é©±çš„ç±»å‹(2--\u003e1.2MB,7--\u003e1,44MB) ; nr(0-3)å¯¹åº”è½¯é©±A,B,C,D ; /dev/PS0(2,28)---\u003e1.44mb Aé©±åŠ¨å™¨ï¼Œè®¾å¤‡å·0x21c 7*4+0 =28 ; /dev/at0(2,8)---\u003e1.2MB Aé©±åŠ¨å™¨ï¼Œè®¾å¤‡å·0x0208 seg cs mov\tax,root_dev ï¼å–508ï¼Œ509 byteå¤„çš„æ ¹è®¾å¤‡å·,root_devå®šä¹‰åœ¨è¿™é‡Œ cmp\tax,#0 jne\troot_defined ï¼åˆ¤æ–­æ˜¯å¦è¢«å®šä¹‰ï¼Œæ¯å®šä¹‰è·³åˆ°å®šä¹‰å¤„ seg cs mov\tbx,sectors mov\tax,#0x0208\t! /dev/ps0 - 1.2Mb cmp\tbx,#15\t! åˆ¤æ–­æ¯ç£é“æ‰‡åŒºæ•°æ˜¯å¦ç­‰äº15 ï¼Œsectorsç­‰äº15åˆ™æ˜¯1.2Mbé©±åŠ¨å™¨ je\troot_defined mov\tax,#0x021c\t! /dev/PS0 - 1.44Mb cmp\tbx,#18 ! sectorsç­‰äº18åˆ™æ˜¯1.44Mbé©±åŠ¨å™¨ je\troot_defined ; å¦‚æœéƒ½ä¸ä¸€æ ·ï¼Œåˆ™æ­»å¾ªç¯(æ­»æœº) undef_root: jmp undef_root root_defined: seg cs mov\troot_dev,ax ï¼å°†æ£€æµ‹åˆ°çš„è®¾å¤‡å·ä¿å­˜åˆ°root_dev ! after that (everyting loaded), we jump to ! the setup-routine loaded directly after ! the bootblock: ; åˆ°è¿™é‡Œï¼Œæ‰€æœ‰çš„ç¨‹åºéƒ½åŠ è½½å®Œæ¯•ï¼Œç„¶åè·³è½¬åˆ°åŠ è½½åˆ°bootsectåé¢çš„setupç¨‹åº jmpi\t0,SETUPSEG ï¼ï¼ï¼ï¼ï¼ï¼æœ¬ç¨‹åºç»“æŸ 4.å‰©ä½™çš„ç¨‹åºä¸¤ä¸ªå­ç¨‹åºï¼Œ(read_it)ç”¨äºè¯»å–systemæ¨¡å—ï¼Œ(kill_moter)ç”¨äºå…³é—­è½¯ä»¶çš„é©¬è¾¾ï¼Œå°±ä¸ä¸€ä¸€ä»‹ç»äº†ã€‚\n4.å®Œæ•´çš„bootsect.sæºç ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 ! ! SYS_SIZE is the number of clicks (16 bytes) to be loaded. ! 0x3000 is 0x30000 bytes = 196kB, more than enough for current ! versions of linux SYSSIZE = 0x3000 ;SYS_SIZEæ˜¯è¦åŠ è½½çš„ç³»ç»Ÿæ¨¡å—é•¿åº¦ï¼Œå•ä½æ˜¯èŠ‚ï¼Œ16 bytesä¸º1èŠ‚ ;0x3000å­—èŠ‚ = 196kB ! ;æ“ä½œç³»ç»Ÿå¯åŠ¨æµç¨‹ !\tbootsect.s\t(C) 1991 Linus Torvalds ! ! bootsect.s is loaded at 0x7c00 by the bios-startup routines, and moves ! iself out of the way to address 0x90000, and jumps there. ! ! It then loads 'setup' directly after itself (0x90200), and the system ! at 0x10000, using BIOS interrupts. ! ! NOTE! currently system is at most 8*65536 bytes long. This should be no ! problem, even in the future. I want to keep it simple. This 512 kB ! kernel size should be enough, especially as this doesn't contain the ! buffer cache as in minix ! ! The loader has been made as simple as possible, and continuos ! read errors will result in a unbreakable loop. Reboot by hand. It ! loads pretty fast by getting whole sectors at a time whenever possible. ;ä¼ªæŒ‡ä»¤ï¼Œ .globlç”¨äºå®šä¹‰éšåçš„æ ‡è¯†ç¬¦æ˜¯å¤–éƒ¨æˆ–è€…å…¨å±€çš„ .globl begtext, begdata, begbss, endtext, enddata, endbss !å…¨å±€æ ‡è¯†ç¬¦ï¼Œä¾›ld86é“¾ä½¿ç”¨ .text ï¼æ­£æ–‡æ®µ begtext: ï¼æ ‡å· ä»£è¡¨å…¶æ‰€åœ¨çš„ä½ç½®ï¼Œé€šå¸¸æŒ‡æ˜ä¸€ä¸ªè·³è½¬å‘½ä»¤çš„ç›®æ ‡åœ°å€ .data ï¼æ•°æ®æ®µ begdata: .bss ï¼æœªåˆå§‹åŒ–æ•°æ®æ®µ begbss: .text ï¼æ­£æ–‡æ®µ SETUPLEN = 4\t! nr of setup-sectors ï¼setupç¨‹åºçš„æ‰‡åŒºæ•°å€¼ BOOTSEG = 0x07c0\t! original address of boot-sector ï¼BIOSåŠ è½½bootsectä»£ç çš„åŸå§‹æ®µåœ°å€ INITSEG = 0x9000\t! we move boot here - out of the way ï¼å°†bootsectç§»åŠ¨åˆ°è¿™é‡Œ SETUPSEG = 0x9020\t! setup starts here ï¼setupç¨‹åºä»è¿™é‡Œå¼€å§‹ SYSSEG = 0x1000\t! system loaded at 0x10000 (65536). ï¼systemæ¨¡å—åŠ è½½åˆ°0x010000(64kb). ENDSEG = SYSSEG + SYSSIZE\t! where to stop loading ! åœæ­¢åŠ è½½çš„æ®µåœ°å€ ! ROOT_DEV:\t0x000 - same type of floppy as boot. ; æ ¹æ–‡ä»¶ç³»ç»Ÿè®¾å¤‡ä½¿ç”¨ä¸å¼•å¯¼æ—¶ç›¸åŒçš„è½¯é©±è®¾å¤‡ !\t0x301 - first partition on first drive etc ; æ ¹æ–‡ä»¶ç³»ç»Ÿè®¾å¤‡åœ¨ç¬¬ä¸€ä¸ªç¡¬ç›˜çš„ç¬¬ä¸€ä¸ªåˆ†åŒºä¸Š ROOT_DEV = 0x306 ; è®¾å¤‡å·0x36æŒ‡å®šæ ¹æ–‡ä»¶ç³»ç»Ÿæ—¶ç¬¬2ä¸ªç¡¬ç›˜çš„ç¬¬ä¸€ä¸ªåˆ†åŒº ; è®¾å¤‡å·å‘½åæ–¹å¼ï¼š ; è®¾å¤‡å· = ä¸»è®¾å¤‡å·*256 + æ¬¡è®¾å¤‡å· (dev_no = (major\u003c\u003c8)+minor) ; ä¸»è®¾å¤‡å·ï¼š1-å†…å­˜ï¼Œ2-ç£ç›˜ï¼Œ3-ç¡¬ç›˜ï¼Œ4-ttyx,5-tty,6-å¹¶è¡Œå£ï¼Œ7-éå‘½åç®¡é“ ; 0x300 - /dev/hd0 --ä»£è¡¨æ•´ä¸ªç¬¬ä¸€ä¸ªç¡¬ç›˜ ; 0x30(1-4) - /dev/hd(1-4) --ä»£è¡¨ç¬¬ä¸€ä¸ªç›˜çš„1-4ä¸ªåˆ†åŒº ; 0x305 - /dev/hd5 --ä»£è¡¨æ•´ä¸ªç¬¬äºŒä¸ªç¡¬ç›˜ ; 0x30(6-9) - /dev/hd(6-9) --ä»£è¡¨ç¬¬äºŒä¸ªç›˜çš„1-4ä¸ªåˆ†åŒº ; bootsectå¯åŠ¨ç¨‹åºå°†å®ƒè‡ªèº«ä»å†…å®¹0x07c00(BOOTSEG)å¤„å¤åˆ¶è‡³å†…å­˜0x9000(INITSEG)å¤„ entry start ;å…³é”®å­—entryå‘Šè¯‰é“¾æ¥å™¨\"ç¨‹åºå…¥å£\" start: mov\tax,#BOOTSEG ;BOOTSEG = 0x07c0 èµ‹å€¼ç»™axï¼Œ mov\tds,ax ;æºåœ°å€ mov\tax,#INITSEG ;INITSEG = 0x9000 èµ‹å€¼ç»™bx mov\tes,ax\t;ç›®æ ‡åœ°å€ mov\tcx,#256 ;å¾ªç¯æ¬¡æ•°ï¼Œæ¯æ¬¡å¾ªç¯å®Œæ¬¡æ•°å‡ä¸€ sub\tsi,si ;æ¸…é›¶ sub\tdi,di ;æ¸…é›¶ rep\t;repæ˜¯repeatï¼Œrepé…åˆ movw(movsb) å°±æ˜¯å¤šæ¬¡å¤åˆ¶ç›´åˆ°cx=0ä¸ºæ­¢ å¤åˆ¶çš„æ¬¡æ•°æ”¾åœ¨cxä¸­ movw ;ç”¨äºæŠŠå†…å®¹ä»ds:si å¤åˆ¶es:di ä»¥å­—ä½å•ä½ jmpi\tgo,INITSEG ;é—´æ¥è·³è½¬ å³ç¨‹åºè·³åˆ°9000:0 å»ç»§ç»­æ‰§è¡Œ CS=INITSEGï¼ŒIP=go(åç§»åœ°å€) ; ä»è¿™é‡Œå¼€å§‹cpuå·²ç»è·³åˆ°å†…å­˜0x90000å»æ‰§è¡Œï¼Œ ; BIOSæŠŠå¼•å¯¼æ‰‡åŒºåŠ è½½åˆ°0x7c00å¤„å¹¶æŠŠæ‰§è¡Œæƒäº¤ç»™å¼•å¯¼ç¨‹åºï¼Œ(ss=0x00,sp=0xfffe) ; å°†ds,es,ss,éƒ½è®¾ç½®æˆç§»åŠ¨åä»£ç æ‰€åœ¨æ®µ(0x9000) go:\tmov\tax,cs ;ax = cs = INITSEG = 0x9000 mov\tds,ax ;æ•°æ®æ®µåœ°å€ mov\tes,ax ;é™„åŠ æ®µåœ°å€ ! put stack at 0x9ff00. ;å°†å †æ ˆæŒ‡é’ˆspæŒ‡å‘0x9fff00(0x9000:0xff00) mov\tss,ax ;æ ˆæ®µåœ°å€ ; ä¿è¯æ ˆæŒ‡é’ˆspåªè¦æŒ‡å‘è¿œå¤§äº512byteå­—èŠ‚åç§»(å³åœ°å€0x90200) ; å› ä¸ºåœ¨0x90200åè¦å­˜æ”¾setupç¨‹åºï¼Œå¤§çº¦ä¸º4ä¸ªæ‰‡åŒº spæŒ‡å‘å¤§äº(0x200+0x200*4+å †æ ˆå¤§å°) mov\tsp,#0xFF00\t! arbitrary value \u003e\u003e512 ! load the setup-sectors directly after the bootblock. ; åœ¨bootsectç¨‹åºç´§è·Ÿç€åŠ è½½setupç¨‹åº ! Note that 'es' is already set up. ; esåœ¨ç§»åŠ¨ä»£ç æ—¶è®¾ç½®å¥½äº†æŒ‡å‘ç›®çš„åœ°å€0x9000 ; è¿™ä¸€æ®µä¸»è¦æ˜¯åˆ©ç”¨BIOSä¸­æ–­ INT 0x13 å°†setupæ¨¡å—ä»ç£ç›˜ç¬¬2ä¸ªæ‰‡åŒºå¼€å§‹è¯»åˆ°0x90200, ; ä¸€ä¸ªå››ä¸ªæ‰‡åŒºï¼Œå¦‚æœè¯»é”™ï¼Œåˆ™å¤ä½é©±åŠ¨å™¨ï¼Œå¹¶é‡è¯• ; INT 0x13 ä½¿ç”¨æ–¹æ³•ï¼š ; è¯»æ‰‡åŒºï¼š ; ah = 0x02 --è¯»ç£ç›˜æ‰‡åŒºåˆ°å†…å­˜ ; al = éœ€è¦è¯»å‡ºçš„æ‰‡åŒºæ•°é‡ ; ch = ç£é“(æŸ±é¢)å·ä½8ä½ ; cl = å¼€å§‹æ‰‡åŒº(ä½0-5)ï¼Œç£é“å·é«˜ä¸¤ä½(ä½6-7) ; dh = ç£å¤´å· ; dl = é©±åŠ¨å™¨å·(å¦‚æœæ˜¯ç¡¬ç›˜åˆ™ä½7è¦ç½®ä½) ; es:bx--\u003eæŒ‡å‘æ•°æ®ç¼“å­˜åŒº ï¼Œå¦‚æœå‡ºé”™åˆ™CFæ ‡å¿—ç½®ä½ï¼Œahä¸­æ˜¯å‡ºé”™ç  load_setup: mov\tdx,#0x0000\t! drive 0, head 0 mov\tcx,#0x0002\t! sector 2, track 0 mov\tbx,#0x0200\t! address = 512, in INITSEG mov\tax,#0x0200+SETUPLEN\t! service 2, nr of sectors int\t0x13\t! read it ; JNC:Jump Not Carry æ²¡è¿›ä½æ—¶è·³è½¬ æ­£ç¡®è¯»å–æ—¶CF=0 jnc\tok_load_setup\t! ok - continue ; è¯»å–å‡ºé”™ï¼Œå¯¹é©±åŠ¨å™¨0è¿›è¡Œè¯»æ“ä½œ å¹¶é‡æ–°è¯»å–åŠ è½½setupç¨‹åº mov\tdx,#0x0000 mov\tax,#0x0000\t! reset the diskette int\t0x13 j\tload_setup ! jmpæŒ‡ä»¤ è¿”å›åˆ°é‡æ–°åŠ è½½setupå¤„ ok_load_setup: ! Get disk drive parameters, specifically nr of sectors/track ; å–ç£ç›˜é©±åŠ¨å™¨çš„å‚æ•°ï¼Œç‰¹åˆ«æ˜¯æ¯é“çš„æ‰‡åŒºæ•°é‡ ; å–ç£ç›˜é©±åŠ¨å™¨çš„å‚æ•° INT 0x13è°ƒç”¨æ ¼å¼å’Œè¿”å›ä¿¡æ¯ï¼š ; è°ƒç”¨æ ¼å¼: ; ah = 0x08 dl = é©±åŠ¨å™¨å·(å¦‚æœæ˜¯ç¡¬ç›˜åˆ™ä½7è¦ç½®ä½) ; è¿”å›ä¿¡æ¯ï¼š ; å¦‚æœå‡ºé”™ï¼Œåˆ™CFå€¼ä½ï¼Œå¹¶ä¸”ah = çŠ¶æ€ç  ; ah = 0, al = 0 bl = é©±åŠ¨å™¨ç±»å‹(AT/PS2) ; ch = ç£é“(æŸ±é¢)å·ä½8ä½ ; cl = å¼€å§‹æ‰‡åŒº(ä½0-5)ï¼Œç£é“å·é«˜ä¸¤ä½(ä½6-7)\t; dh = æœ€å¤§ç£å¤´æ•° ï¼Œ dl = é©±åŠ¨å™¨æ•°é‡ ; es:di---\u003eè½¯é©±ç£ç›˜å‚æ•°è¡¨ mov\tdl,#0x00 mov\tax,#0x0800\t! AH=8 is get drive parameters int\t0x13 mov\tch,#0x00 ; è¿™æ¡æŒ‡ä»¤è¡¨ç¤ºä¸‹ä¸€æ¡æŒ‡ä»¤çš„æ“ä½œæ•°åœ¨csæ®µå¯„å­˜å™¨æ‰€æŒ‡çš„æ®µä¸­ seg cs ; ä¿æŒæ¯ç£é“æ‰‡åŒºæ•° (cx = æ¯ç£é“æ‰‡åŒºæ•°) mov\tsectors,cx mov\tax,#INITSEG ; ç”±äºä¸Šé¢å–ç£é“å‚æ•°ä¸­æ–­æ”¹æ‰äº†esçš„å€¼ï¼Œè¿™é‡Œé‡æ–°å¤åˆ¶ï¼Œ mov\tes,ax ! Print some inane message ; æ˜¾ç¤ºä¿¡æ¯ï¼š\"'Loading system ...'å›è½¦æ¢è¡Œ\" åŒ…æ‹¬å›è½¦æ¢è¡Œä¸€å…±24ä¸ªå­—ç¬¦ ; BIOSä¸­æ–­0x10åŠŸèƒ½å· ah= 0x03,è¯»å…‰æ ‡çš„ä½ç½® ; è¾“å…¥:bh = é¡µå· ; è¿”å›ï¼šch = æ‰«æå¼€å§‹çº¿ï¼Œcl = ç»“æŸå¼€å§‹çº¿,dh = è¡Œå·(0x00é¡¶ç«¯)ï¼Œdl=åˆ—å·(0x00æœ€å·¦è¾¹) ï¼ ; BIOSä¸­æ–­0x10åŠŸèƒ½å· ah= 0x13,æ˜¾ç¤ºå­—ç¬¦ä¸² ; è¾“å…¥ï¼šal=æ”¾ç½®å…‰æ ‡çš„æ–¹å¼åŠè§„å®šå±æ€§ï¼Œ0x01--è¡¨ç¤ºä½¿ç”¨blä¸­çš„å±æ€§ï¼Œå…‰æ ‡åœåœ¨å­—ç¬¦ä¸²ç»“å°¾å¤„ ; es:bp æ­¤å¯„å­˜å™¨æŒ‡å‘è¦æ˜¾ç¤ºå­—ç¬¦ä¸²èµ·å§‹ä½ç½®å¤„ ; cx = æ˜¾ç¤ºçš„å­—ç¬¦ä¸²å­—ç¬¦æ•° ; bh = æ˜¾ç¤ºé¡µé¢å· bl = å­—ç¬¦å±æ€§ dh = è¡Œå·ï¼Œdl=åˆ—å· mov\tah,#0x03\t! read cursor pos xor\tbh,bh ! é¦–å…ˆè¯»å…‰æ ‡çš„ä½ç½®ï¼Œè¿”å›å…‰æ ‡ä½ç½®å€¼åœ¨dx int\t0x10 ï¼dh = è¡Œ(0-23) dl = åˆ—(0-79) æ˜¾ç¤ºå­—ç¬¦ä¸²ä½¿ç”¨ mov\tcx,#24 ! æ˜¾ç¤º24ä¸ªå­—ç¬¦ mov\tbx,#0x0007\t! page 0, attribute 7 (normal) mov\tbp,#msg1\t! es:bp å¯„å­˜å™¨æŒ‡å‘è¦æ˜¾ç¤ºå­—ç¬¦ä¸²èµ·å§‹ä½ç½®å¤„ mov\tax,#0x1301\t! write string, move cursor int\t0x10 ! ok, we've written the message, now ! we want to load the system (at 0x10000) ; å°†systemåŠ è½½åˆ°0x10000 mov\tax,#SYSSEG mov\tes,ax\t! segment of 0x010000 call\tread_it ; è¯»ç£ç›˜ä¸Šsystemæ¨¡å—ï¼Œesä¸ºè¾“å…¥å‚æ•° call\tkill_motor ; å…³é—­é©±åŠ¨å™¨é©¬è¾¾ï¼Œè¿™æ ·å°±å¯ä»¥çŸ¥é“é©±åŠ¨å™¨çš„çŠ¶æ€ ! After that we check which root-device to use. If the device is ! defined (!= 0), nothing is done and the given device is used. ! Otherwise, either /dev/PS0 (2,28) or /dev/at0 (2,8), depending ! on the number of sectors that the BIOS reports currently. ; æ£€æµ‹ä½¿ç”¨çš„æ ¹æ–‡ä»¶ç³»ç»Ÿ ; å¦‚æœå·²ç»æŒ‡å®šäº†è®¾å¤‡å¹¶ä¸”ä¸ç­‰äº0ï¼Œå°±ç›´æ¥ä½¿ç”¨ç»™å®šçš„è®¾å¤‡ï¼Œå¦åˆ™å°±éœ€è¦æŠ¥é“çš„æ¯ç£é“æ‰‡åŒºæ•°æ¥ ; ç¡®å®šæ˜¯ä½¿ç”¨/dev/PS0(2,28) è¿˜æ˜¯/dev/at0(2,8) ; åœ¨Linuxä¸­è½¯é©±çš„ä¸»è®¾å¤‡æ˜¯2ï¼Œæ¬¡è®¾å¤‡ = type*4 + nr ; typeæ˜¯è½¯é©±çš„ç±»å‹(2--\u003e1.2MB,7--\u003e1,44MB) ; nr(0-3)å¯¹åº”è½¯é©±A,B,C,D ; /dev/PS0(2,28)---\u003e1.44mb Aé©±åŠ¨å™¨ï¼Œè®¾å¤‡å·0x21c 7*4+0 =28 ; /dev/at0(2,8)---\u003e1.2MB Aé©±åŠ¨å™¨ï¼Œè®¾å¤‡å·0x0208 seg cs mov\tax,root_dev ï¼å–508ï¼Œ509 byteå¤„çš„æ ¹è®¾å¤‡å·,root_devå®šä¹‰åœ¨è¿™é‡Œ cmp\tax,#0 jne\troot_defined ï¼åˆ¤æ–­æ˜¯å¦è¢«å®šä¹‰ï¼Œæ¯å®šä¹‰è·³åˆ°å®šä¹‰å¤„ seg cs mov\tbx,sectors mov\tax,#0x0208\t! /dev/ps0 - 1.2Mb cmp\tbx,#15\t! åˆ¤æ–­æ¯ç£é“æ‰‡åŒºæ•°æ˜¯å¦ç­‰äº15 ï¼Œsectorsç­‰äº15åˆ™æ˜¯1.2Mbé©±åŠ¨å™¨ je\troot_defined mov\tax,#0x021c\t! /dev/PS0 - 1.44Mb cmp\tbx,#18 ! sectorsç­‰äº18åˆ™æ˜¯1.44Mbé©±åŠ¨å™¨ je\troot_defined ; å¦‚æœéƒ½ä¸ä¸€æ ·ï¼Œåˆ™æ­»å¾ªç¯(æ­»æœº) undef_root: jmp undef_root root_defined: seg cs mov\troot_dev,ax ï¼å°†æ£€æµ‹åˆ°çš„è®¾å¤‡å·ä¿å­˜åˆ°root_dev ! after that (everyting loaded), we jump to ! the setup-routine loaded directly after ! the bootblock: ; åˆ°è¿™é‡Œï¼Œæ‰€æœ‰çš„ç¨‹åºéƒ½åŠ è½½å®Œæ¯•ï¼Œç„¶åè·³è½¬åˆ°åŠ è½½åˆ°bootsectåé¢çš„setupç¨‹åº jmpi\t0,SETUPSEG ï¼ï¼ï¼ï¼ï¼ï¼æœ¬ç¨‹åºç»“æŸ ; ä¸‹é¢æ˜¯ä¸¤ä¸ªå­ç¨‹åºï¼Œ(read_it)ç”¨äºè¯»å–systemæ¨¡å—ï¼Œ(kill_moter)ç”¨äºå…³é—­è½¯ä»¶çš„é©¬è¾¾ ! This routine loads the system at address 0x10000, making sure ! no 64kB boundaries are crossed. We try to load it as fast as ! possible, loading whole tracks whenever we can. ! ! in:\tes - starting address segment (normally 0x1000) ! ; è¯¥å­ç¨‹åºå°†ç³»ç»Ÿæ¨¡å—åŠ è½½åˆ°å†…å­˜åœ°å€0x10000å¤„ï¼Œå¹¶ç¡®å®šæ²¡æœ‰è·¨è¶Š64kbå†…å­˜è¾¹ç•Œ ; å°½å¿«å¯èƒ½çš„åŠ è½½ï¼Œæ¯æ¬¡åŠ è½½æ•´æ¡ç£é“çš„æ•°æ® ; è¾“å…¥ï¼šeså¼€å§‹å†…å­˜åœ°å€æ®µå€¼(ä¸€èˆ¬0x1000) ; .wordå®šä¹‰ä¸€ä¸ªå­—å†…å­˜ ; (1+SETUPLEN)è¡¨ç¤ºå¼€å§‹å·²ç»è¯»è¿›ä¸€ä¸ªå¼•å¯¼æ‰‡åŒºå’Œsetupç¨‹åºæ‰€å çš„æ‰‡åŒºæ•°SETUPLEN sread:\t.word 1+SETUPLEN\t! sectors read of current track å½“å‰ç£é“ä¸­å·²è¯»æ‰‡åŒºæ•° head:\t.word 0\t! current head å½“å‰ç£å¤´å· track:\t.word 0\t! current track å½“å‰ç£é“å· read_it: mov ax,es test ax,#0x0fff die:\tjne die\t! es must be at 64kB boundary xor bx,bx\t! bx is starting address within segment rp_read: mov ax,es cmp ax,#ENDSEG\t! have we loaded all yet? jb ok1_read ret ok1_read: seg cs mov ax,sectors sub ax,sread mov cx,ax shl cx,#9 add cx,bx jnc ok2_read je ok2_read xor ax,ax sub ax,bx shr ax,#9 ok2_read: call read_track mov cx,ax add ax,sread seg cs cmp ax,sectors jne ok3_read mov ax,#1 sub ax,head jne ok4_read inc track ok4_read: mov head,ax xor ax,ax ok3_read: mov sread,ax shl cx,#9 add bx,cx jnc rp_read mov ax,es add ax,#0x1000 mov es,ax xor bx,bx jmp rp_read read_track: push ax push bx push cx push dx mov dx,track mov cx,sread inc cx mov ch,dl mov dx,head mov dh,dl mov dl,#0 and dx,#0x0100 mov ah,#2 int 0x13 jc bad_rt pop dx pop cx pop bx pop ax ret bad_rt:\tmov ax,#0 mov dx,#0 int 0x13 pop dx pop cx pop bx pop ax jmp read_track /* * This procedure turns off the floppy drive motor, so * that we enter the kernel in a known state, and * don't have to worry about it later. */ ; è¿™ä¸ªç¨‹åºç”¨äºå…³é—­è½¯ä»¶é©¬è¾¾ï¼Œè¿™æ ·è¿›å…¥å†…æ ¸å°±å¯ä»¥çŸ¥é“å®ƒæ‰€å¤„çš„çŠ¶æ€ kill_motor: push dx mov dx,#0x3f2 !è½¯ä»¶æ§åˆ¶å¡çš„æ•°å­—è¾“å‡ºå¯„å­˜å™¨(DOR)ç«¯å£ï¼Œåªå†™ mov al,#0 outb pop dx ret sectors: .word 0 msg1: ! è°ƒç”¨BIOSä¸­æ–­æ˜¾ç¤ºä¿¡æ¯ .byte 13,10 ! å›è½¦æ¢è¡Œçš„asciiç  .ascii \"Loading system ...\" ï¼ æ˜¾ç¤ºå­—ç¬¦ä¸² .byte 13,10,13,10 ï¼ä¸€ä¸ª24ä¸ªå­—ç¬¦ ; è¡¨ç¤ºä¸‹é¢è¯­å¥ä»åœ°å€508(0x1fc)å¼€å§‹ï¼Œæ‰€ä»¥root_devåœ¨å¯åŠ¨æ‰‡åŒºçš„ç¬¬508å¼€å§‹çš„2ä¸ªå­—èŠ‚ä¸­ .org 508 root_dev: .word ROOT_DEV ï¼å­˜æ”¾æ ¹æ–‡ä»¶ç³»ç»Ÿæ‰€åœ¨è®¾å¤‡å·(init/main.cä¸­ä¼šç”¨) ; ä¸‹é¢æ˜¯å¯åŠ¨ç›˜å…·æœ‰æœ‰æ•ˆå¼•å¯¼æ‰‡åŒºçš„æ ‡å¿—ï¼Œåœ¨BIOSç¨‹åºåŠ è½½å¼•å¯¼æ‰‡åŒºæ—¶è¯†åˆ«ä½¿ç”¨ï¼Œ ; å®ƒå¿…é¡»ä½äºå¼•å¯¼æ‰‡åŒºçš„æœ€åä¸¤ä¸ªå­—èŠ‚ä¸­ boot_flag: .word 0xAA55 .text endtext: .data enddata: .bss endbss: æ“ä½œç³»ç»ŸåŠ è½½â€”setup 1.ç®€ä»‹ ä½œç”¨ï¼šsetup.sæ˜¯æ“ä½œç³»ç»ŸåŠ è½½ç¨‹åºï¼Œå®ƒçš„ä½œç”¨æ˜¯åˆ©ç”¨ROM BIOSä¸­æ–­è¯»å–ç³»ç»Ÿæ•°æ®ï¼Œå¹¶å°†è¿™äº›æ•°æ®ä¿å­˜åˆ°0x90000å¼€å§‹çš„ä½ç½®å¤„(è¦†ç›–äº†åŸæ¥bootsectç¨‹åºæ‰€åœ¨çš„åœ°æ–¹)\nè¯»å–åˆ°æ•°æ®ä¿å­˜çš„ä½ç½®: å°†è¯»å–åˆ°çš„æ•°æ®ä¿å­˜åï¼Œ==setupå°†systemæ¨¡å—ä»0x10000-0x8ffffæ•´å—ç§»åŠ¨åˆ°å†…å­˜ç»å¯¹åœ°å€0x00000å¤„==ã€‚ ç„¶ååŠ è½½ä¸­æ–­æè¿°ç¬¦è¡¨å¯„å­˜å™¨(idir)å’Œå…¨å±€æè¿°ç¬¦è¡¨å¯„å­˜å™¨(gdtr)ï¼Œå¼€å¯A20åœ°å€çº¿ï¼Œé‡æ–°è®¾ç½®ä¸¤ä¸ªä¸­æ–­æ§åˆ¶èŠ¯ç‰‡8259Aï¼Œå°†ç¡¬ä»¶ä¸­æ–­å·é‡æ–°è®¾ç½®ä¸º0x20-0x2fã€‚å†è®¾ç½®cpuçš„æ§åˆ¶å¯„å­˜å™¨CR0(æœºå™¨çŠ¶æ€å­—)ï¼Œä»è€Œè¿›å…¥32ä½ä¿æŠ¤æ¨¡å¼ï¼Œå¹¶è·³åˆ°systemæ¨¡å—æœ€å‰é¢éƒ¨åˆ†çš„head.sç¨‹åºç»§ç»­è¿è¡Œã€‚\nä¸ºäº†èƒ½è®©head.såœ¨32ä½ä¿æŠ¤æ¨¡å¼ä¸‹è¿è¡Œï¼Œåœ¨ç¨‹åºä¸­ä¸´æ—¶è®¾ç½®ä¸­æ–­æè¿°ç¬¦(IDT)å’Œå…¨å±€æè¿°ç¬¦è¡¨(GDT)ï¼Œå¹¶åœ¨GDTä¸­è®¾ç½®å½“å‰å†…æ ¸ä»£ç æ®µçš„æè¿°ç¬¦å’Œæ•°æ®æ®µçš„æè¿°ç¬¦ã€‚\nGDT æ®µæè¿°ç¬¦å­˜æ”¾åœ¨æè¿°ç¬¦è¡¨ä¸­ã€‚æè¿°ç¬¦è¡¨å…¶å®å°±æ˜¯å†…å­˜ä¸­æè¿°ç¬¦é¡¹çš„ä¸€ä¸ªé˜µåˆ—ã€‚\næè¿°ç¬¦è¡¨æœ‰ä¸¤ç±»ï¼šå…¨å±€æè¿°ç¬¦è¡¨(Global descriptor table-GDT)å’Œå±€éƒ¨æè¿°ç¬¦è¡¨(Local descriptor tableâˆ’LDT)ã€‚\nå¤„ç†å™¨æ˜¯é€šè¿‡ä½¿ç”¨GDTRå’ŒLDTRå¯„å­˜å™¨æ¥å®šä½GDTè¡¨å’Œå½“å‰çš„LDTè¡¨ã€‚\nè¿™ä¸¤ä¸ªå¯„å­˜å™¨ä»¥çº¿æ€§åœ°å€çš„æ–¹å¼ä¿å­˜äº†æè¿°ç¬¦è¡¨çš„åŸºåœ°å€å’Œè¡¨çš„é•¿åº¦ã€‚\næŒ‡ä»¤Igdå’Œsgdç”¨äºè®¿é—®GDTRå¯„å­˜å™¨ï¼› æŒ‡ä»¤Hdtå’Œslutç”¨äºè®¿é—®LDTRå¯„å­˜å™¨ã€‚ lgdä½¿ç”¨å†…å­˜ä¸­ä¸€ä¸ª6å­—èŠ‚æ“ä½œæ•°æ¥åŠ è½½GDTRå¯„å­˜å™¨ã€‚å¤´ä¸¤ä¸ªå­—èŠ‚ä»£è¡¨æè¿°ç¬¦è¡¨çš„é•¿åº¦ï¼Œå4ä¸ªå­—èŠ‚æ˜¯æè¿°ç¬¦è¡¨çš„åŸºåœ°å€ã€‚ä½†ï¼Œè®¿é—®LDTRå¯„å­˜å™¨çš„æŒ‡ä»¤lutæ‰€ä½¿ç”¨çš„æ“ä½œæ•°å´æ˜¯ä¸€ä¸ª2å­—èŠ‚çš„æ“ä½œæ•°ï¼Œè¡¨ç¤ºå…¨å±€æè¿°ç¬¦è¡¨GDTä¸­ä¸€ä¸ªæè¿°ç¬¦é¡¹çš„é€‰æ‹©ç¬¦ã€‚è¯¥é€‰æ‹©ç¬¦æ‰€å¯¹åº”çš„GDTè¡¨ä¸­çš„æè¿°ç¬¦é¡¹åº”è¯¥å¯¹åº”ä¸€ä¸ªå±€éƒ¨æè¿°ç¬¦è¡¨ã€‚\nsetupè®¾ç½®çš„GDTæè¿°ç¬¦é¡¹ï¼Œä»£ç æ®µæè¿°ç¬¦çš„å€¼æ˜¯0x00C09A0000007FF,\nè¡¨ç¤ºä»£ç æ®µçš„é™é•¿æ˜¯ 8MB(=(0x7F+1)âˆ—4KB, è¿™é‡ŒåŠ 1æ˜¯å› ä¸ºé™é•¿å€¼æ˜¯ä»0å¼€å§‹ç®—èµ·çš„ï¼Œæ®µåœ¨çº¿æ€§åœ°å€ç©ºé—´ä¸­çš„åŸºå€æ˜¯0ï¼Œæ®µç±»å‹å€¼009Aè¡¨ç¤ºè¯¥æ®µå­˜åœ¨äºå†…å­˜ä¸­ã€æ®µçš„ç‰¹æƒçº§åˆ«ä¸º0ã€æ®µç±»å‹æ˜¯å¯è¯»å¯æ‰§è¡Œçš„ä»£ç æ®µï¼Œæ®µä»£ç æ˜¯32ä½çš„å¹¶ä¸”æ®µçš„é¢—ç²’åº¦æ˜¯4KBã€‚\næ•°æ®æ®µæè¿°ç¬¦çš„å€¼æ˜¯0x00C0920000007FFï¼Œè¡¨ç¤ºæ•°æ®æ®µçš„é™é•¿æ˜¯8MBâ€¦æ®µåœ¨çº¿æ€§åœ°å€ç©ºé—´ä¸­çš„åŸºå€æ˜¯0ã€‚æ®µç±»å‹å€¼0x92è¡¨ç¤ºè¯¥æ®µå­˜åœ¨äºå†…å­˜ä¸­ã€æ®µçš„ç‰¹æƒçº§åˆ«ä¸º0ã€æ®µç±»å‹æ˜¯å¯è¯»å¯å†™çš„æ•°æ®æ®µã€æ®µä»£ç æ˜¯32ä½çš„å¹¶ä¸”æ®µçš„é¢—ç²’åº¦æ˜¯4KBã€‚\né€»è¾‘åœ°å€çš„é€‰æ‹©ç¬¦éƒ¨åˆ†ç”¨äºæŒ‡å®šä¸€æè¿°ç¬¦ï¼Œå®ƒæ˜¯é€šè¿‡æŒ‡å®šä¸€æè¿°ç¬¦è¡¨å¹¶ä¸”ç´¢å¼•å…¶ä¸­çš„ä¸€ä¸ªæè¿°ç¬¦é¡¹å®Œæˆçš„ã€‚\næ®µé€‰æ‹©ç¬¦æ ¼å¼ï¼š\nå…¶ä¸­ç´¢å¼•å€¼ç”¨äºæŒ‡å®šæè¿°ç¬¦è¡¨ä¸­8192(2**13)ä¸ªæè¿°ç¬¦ä¸­çš„ä¸€ä¸ªã€‚\nå¤„ç†å™¨å°†è¯¥ç´¢å¼•å€¼ä¹˜ä¸Š8ï¼Œå¹¶åŠ ä¸Šæè¿°ç¬¦è¡¨çš„åŸºåœ°å€å³å¯è®¿é—®è¡¨ä¸­æŒ‡å®šçš„æ®µæè¿°ç¬¦ã€‚\nè¡¨æŒ‡ç¤ºå™¨(Table Indicator - TD)ç”¨äºæŒ‡å®šé€‰æ‹©ç¬¦æ‰€å¼•ç”¨çš„æè¿°ç¬¦è¡¨ã€‚å€¼ä¸º0è¡¨ç¤ºæŒ‡å®šGDTè¡¨ï¼Œå€¼ä¸º1è¡¨ç¤ºæŒ‡å®šå½“å‰çš„LDTè¡¨ã€‚è¯·æ±‚è€…ç‰¹æƒçº§ï¼ˆR capaestorâ€™sPrivalege Level-RPL)ç”¨äºä¿æŠ¤æœºåˆ¶ã€‚\nç”±äºGDTè¡¨çš„ç¬¬ä¸€é¡¹(ç´¢å¼•å€¼ä¸º0)æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œå› æ­¤ä¸€ä¸ªå…·æœ‰ç´¢å¼•å€¼0å’Œè¡¨æŒ‡ç¤ºå™¨å€¼ä¹Ÿä¸º0çš„é€‰æ‹©ç¬¦(ä¹Ÿå³æŒ‡å‘GDTçš„ç¬¬ä¸€é¡¹çš„é€‰æ‹©ç¬¦)å¯ä»¥ç”¨ä½œä¸ºä¸€ä¸ªç©º(null)é€‰æ‹©ç¬¦ã€‚å½“ä¸€ä¸ªæ®µå¯„å­˜å™¨(ä¸èƒ½æ˜¯ CSæˆ–SS)åŠ è½½äº†ä¸€ä¸ªç©ºé€‰æ‹©ç¬¦æ—¶ï¼Œå¤„ç†å™¨å¹¶ä¸ä¼šäº§ç”Ÿä¸€ä¸ªå¼‚å¸¸ã€‚ä½†æ˜¯è‹¥ä½¿ç”¨è¿™ä¸ªæ®µå¯„å­˜å™¨è®¿é—®å†…å­˜æ—¶å°±ä¼šäº§ç”Ÿä¸€ä¸ªå¼‚å¸¸ã€‚å¯¹äºåˆå§‹åŒ–è¿˜æœªä½¿ç”¨çš„æ®µå¯„å­˜å™¨ä»¥é™·å…¥æ„å¤–çš„å¼•ç”¨æ¥è¯´ï¼Œè¿™ä¸ªç‰¹æ€§æ˜¯å¾ˆæœ‰ç”¨çš„ã€‚\nåœ¨è¿›å…¥ä¿æŠ¤æ¨¡å¼ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»é¦–å…ˆè®¾ç½®å¥½å°†è¦ç”¨åˆ°çš„æ®µæè¿°ç¬¦è¡¨ï¼Œä¾‹å¦‚å…¨å±€æè¿°ç¬¦è¡¨GDTã€‚ç„¶åä½¿ç”¨æŒ‡ä»¤lgdtæŠŠæè¿°ç¬¦è¡¨çš„åŸºåœ°å€å‘ŠçŸ¥CPU(GDTè¡¨çš„åŸºåœ°å€å­˜å…¥gçŸ¥å¯„å­˜å™¨)ã€‚å†å°†æœºå™¨çŠ¶æ€å­—çš„ä¿æŠ¤æ¨¡å¼æ ‡å¿—ç½®ä½å³å¯è¿›å…¥32ä½ä¿æŠ¤è¿è¡Œæ¨¡å¼ã€‚\nLinux 0.11ç¡¬ç›˜è®¾å¤‡å·\nåœ¨Linuxä¸­ï¼Œç¡¬ç›˜çš„ä¸»åŒºå·æ˜¯3ï¼Œå…¶ä»–è®¾å¤‡çš„ä¸»è®¾å¤‡å·åˆ†åˆ«ä¸ºï¼š\n1â€“å†…å­˜ 2â€“ç£ç›˜ 3â€“ç¡¬ç›˜ 4â€“ttyx 5â€“tty 6â€“å¹¶è¡Œå£ 7â€“éå‘½åç®¡é“\nä¸€ä¸ªç¡¬ç›˜å¯ä»¥æœ‰1-4ä¸ªåˆ†åŒºï¼Œå¯ä»¥ä¾æ®åˆ†åŒºçš„ä¸åŒç”¨æ¬¡è®¾å¤‡å·è¿›è¡ŒæŒ‡å®šåˆ†åŒºï¼Œæ‰€ä»¥ï¼šè®¾å¤‡å·=ä¸»è®¾å¤‡å·*256+æ¬¡è®¾å¤‡å·\nç£ç›˜\nä¸€ä¸ªç£ç›˜ç”±å¤šä¸ªç›˜ç‰‡ï¼ˆå¦‚ä¸‹å›¾ä¸­çš„ 0 å·ç›˜ç‰‡ï¼‰å åŠ è€Œæˆã€‚ç›˜ç‰‡çš„è¡¨é¢æ¶‚æœ‰ç£æ€§ç‰©è´¨ï¼Œè¿™äº›ç£æ€§ç‰©è´¨ç”¨æ¥è®°å½•äºŒè¿›åˆ¶æ•°æ®ã€‚å› ä¸ºæ­£åä¸¤é¢éƒ½å¯æ¶‚ä¸Šç£æ€§ç‰©è´¨ï¼Œæ•…ä¸€ä¸ªç›˜ç‰‡å¯èƒ½ä¼šæœ‰ä¸¤ä¸ªç›˜é¢\næ¯ä¸ªç›˜ç‰‡è¢«åˆ’åˆ†ä¸ºä¸€ä¸ªä¸ªç£é“ï¼Œæ¯ä¸ªç£é“åˆåˆ’åˆ†ä¸ºä¸€ä¸ªä¸ªæ‰‡åŒº\næŸ±é¢\næ¯ä¸ªç›˜é¢å¯¹åº”ä¸€ä¸ªç£å¤´ã€‚æ‰€æœ‰çš„ç£å¤´éƒ½æ˜¯è¿åœ¨åŒä¸€ä¸ªç£è‡‚ä¸Šçš„ï¼Œå› æ­¤æ‰€æœ‰ç£å¤´åªèƒ½â€œå…±è¿›é€€â€ã€‚æ‰€æœ‰ç›˜é¢ä¸­ç›¸å¯¹ä½ç½®ç›¸åŒçš„ç£é“ç»„æˆæŸ±é¢\nç£ç›˜çš„ç‰©ç†åœ°å€\nå¯ç”¨ï¼ˆæŸ±é¢å·ï¼Œç›˜é¢å·ï¼Œæ‰‡åŒºå·ï¼‰æ¥å®šä½ä»»æ„ä¸€ä¸ªâ€œç£ç›˜å—â€\nå¯æ ¹æ®è¯¥åœ°å€è¯»å–ä¸€ä¸ªâ€œå—â€ï¼Œæ“ä½œå¦‚ä¸‹ï¼š\nâ‘  æ ¹æ®â€œæŸ±é¢å·â€ç§»åŠ¨ç£è‡‚ï¼Œè®©ç£å¤´æŒ‡å‘æŒ‡å®šæŸ±é¢ï¼›\nâ‘¡ æ¿€æ´»æŒ‡å®šç›˜é¢å¯¹åº”çš„ç£å¤´ï¼›\nâ‘¢ ç£ç›˜æ—‹è½¬çš„è¿‡ç¨‹ä¸­ï¼ŒæŒ‡å®šçš„æ‰‡åŒºä¼šä»ç£å¤´ä¸‹é¢åˆ’è¿‡ï¼Œè¿™æ ·å°±å®Œæˆäº†å¯¹æŒ‡å®šæ‰‡åŒºçš„è¯»/å†™\n2.æºç åˆ†æ 1.setupå®ŒæˆOSå‰çš„åˆå§‹åŒ–å’Œè®¾ç½®\n1)ä¿å­˜å…‰æ ‡çš„ä½ç½® 2)å¾—åˆ°æ‰©å±•å†…å­˜çš„å¤§å° 3)å¾—åˆ°æ˜¾ç¤ºå¡å½“å‰çš„æ˜¾ç¤ºæ¨¡å¼ 4)æ£€æµ‹æ˜¾ç¤ºæ–¹å¼ 5)è¯»å–ç¡¬ç›˜å‚æ•°è¡¨ä¿¡æ¯\nç¡¬ç›˜åŸºæœ¬å‚æ•°è¡¨(INT 0x41)\nåœ¨ä¸­æ–­å‘é‡è¡¨ä¸­ï¼Œint 0x41çš„ä¸­æ–­å‘é‡ä½ç½®ï¼ˆ4*0x41=0x0000:0x0140ï¼‰å­˜æ”¾çš„ä¸æ˜¯ä¸­æ–­ç¨‹åºçš„åœ°å€å…¥å£ï¼Œè€Œæ˜¯ç¬¬ä¸€ä¸ªç¡¬ç›˜å‚æ•°è¡¨çš„ä¿¡æ¯ï¼Œ0x46å­˜æ”¾ç¬¬äºŒä¸ªç¡¬ç›˜å‚æ•°è¡¨\nç¡¬ç›˜å‚æ•°è¡¨ä¿¡æ¯ï¼š\n2.å°†æ•´ä¸ªsystemæ¨¡å—ç§»åŠ¨åˆ°0x00000å¤„\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 ; bootsectå¼•å¯¼ç¨‹åºå°†systemæ¨¡å—ç§»åŠ¨åˆ°(0x10000)å¤„ï¼Œ ; å¹¶æŠŠè‡ªå·±ç§»åŠ¨åˆ°(0x90000)å¤„ï¼ŒæŠŠsetupåŠ è½½åœ¨å®ƒåé¢ ; ä¸‹é¢è¿™æ®µç¨‹åºå°†æ•´ä¸ªsystemæ¨¡å—ç§»åŠ¨åˆ°0x00000å¤„ï¼Œ ; å³æŠŠä»0x10000åˆ°0x8ffffçš„å†…å­˜æ•°æ®å—æ•´å—çš„å‘å†…å­˜åœ°å€ä½ç«¯ç§»åŠ¨äº†0x10000çš„ä½ç½® mov\tax,#0x0000 cld\t! 'direction'=0, movs moves forward do_move: mov\tes,ax\t! destination segment add\tax,#0x1000 cmp\tax,#0x9000 ! åˆ¤æ–­ä»£ç æ˜¯å¦ç§»åŠ¨å®Œæˆ jz\tend_move ! ç§»åŠ¨å®Œæˆåˆ™è·³è½¬ mov\tds,ax\t! source segment sub\tdi,di sub\tsi,si mov cx,#0x8000 ! å¾ªç¯ç§»åŠ¨ï¼Œå¾ªç¯æ¬¡æ•°ï¼Œæ¯æ¬¡å¾ªç¯å®Œæ¬¡æ•°å‡ ç§»åŠ¨0x8000å­— rep\t! ç”¨äºæŠŠå†…å®¹ä»ds:si å¤åˆ¶es:di ä»¥å­—èŠ‚å•ä½ movsw ! repæ˜¯repeatï¼Œrepé…åˆ movw(movsb) å°±æ˜¯å¤šæ¬¡å¤åˆ¶ç›´åˆ°cx=0ä¸ºæ­¢ å¤åˆ¶çš„æ¬¡æ•°æ”¾åœ¨cxä¸­ jmp\tdo_move ç§»åŠ¨åå†…å­˜å­˜æ”¾æ•°æ®ï¼š\n3.è·³è½¬åˆ°ç»å¯¹åœ°å€0x00000å¤„\nåœ¨è·³è½¬ä¹‹å‰è¿˜è¦è¿›è¡Œç›¸åº”çš„è®¾ç½®\n1)åŠ è½½æ®µæè¿°ç¬¦ï¼Œè®¾ç½®å…¨å±€æè¿°ç¬¦è¡¨å’Œä¸­æ–­æè¿°è¡¨ 2)å¼€å¯A20åœ°å€çº¿ï¼Œä¸ºäº†èƒ½å¤Ÿè®¿é—®å’Œä½¿ç”¨1MBä»¥ä¸Šçš„ç‰©ç†å†…å­˜ 3)é‡æ–°å¯¹ä¸­æ–­è¿›è¡Œç¼–ç¨‹\nè¿›å…¥ä¿æŠ¤æ¨¡å¼ï¼šjmpi 0,8\n1 2 3 4 5 6 7 ;è¿›å…¥ä¿æŠ¤æ¨¡å¼ï¼Œåªæ˜¯è·³è½¬åˆ°ç»å¯¹åœ°å€0x00000å¤„ ; åŠ è½½æœºå™¨çŠ¶æ€å­—(æ§åˆ¶å¯„å­˜å™¨CR0)ï¼Œå°†0ä½ç½®1ï¼ŒCPUåˆ‡æ¢åˆ°ä¿æŠ¤æ¨¡å¼ mov\tax,#0x0001\t! protected mode (PE) bit ä¿æŠ¤æ¨¡å¼æ¯”ç‰¹ä½(PE) lmsw\tax\t! This is it! åŠ è½½çŠ¶æ€å¯„å­˜å™¨ ;æ®µé€‰æ‹©ç¬¦8è¡¨ç¤ºè¯·æ±‚ç‰¹æƒ0çº§ï¼Œä½¿ç”¨GDTç¬¬äºŒä¸ªæ®µæè¿°ç¬¦ jmpi\t0,8\t! jmp offset 0 of segment 8 (cs) è·³è½¬è‡³csæ®µåç§»åœ°å€ä½0å¤„(systemå·²ç»ç§»åŠ¨åˆ°0x00000å¤„) setupç¨‹åºå®Œæ•´ä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 ! !\tsetup.s\t(C) 1991 Linus Torvalds ! ! setup.s is responsible for getting the system data from the BIOS, ! and putting them into the appropriate places in system memory. ! both setup.s and system has been loaded by the bootblock. ! ! This code asks the bios for memory/disk/other parameters, and ! puts them in a \"safe\" place: 0x90000-0x901FF, ie where the ! boot-block used to be. It is then up to the protected mode ! system to read them from there before the area is overwritten ! for buffer-blocks. ! ; setupä»BIOSä¸­è·å–æ•°æ®ï¼Œå¹¶å°†è¿™äº›æ•°æ®ä¿å­˜åˆ°0x90000å¼€å§‹çš„ä½ç½®å¤„(0x90000-0x901FFè¦†ç›–äº†åŸæ¥bootsectç¨‹åºæ‰€åœ¨çš„åœ°æ–¹) ; æ­¤æ—¶setupå’Œsystemå·²ç»ç”±bootsectå¼•å¯¼å—åŠ è½½åˆ°å†…å­˜ä¸­ ; ! NOTE! These had better be the same as in bootsect.s! INITSEG = 0x9000\t! we move boot here - out of the way åŸæ¥bootsectæ‰€åœ¨æ®µ SYSSEG = 0x1000\t! system loaded at 0x10000 (65536). systemæ‰€åœ¨0x10000å¤„ SETUPSEG = 0x9020\t! this is the current segment æœ¬ç¨‹åºæ‰€åœ¨æ®µåœ°å€ .globl begtext, begdata, begbss, endtext, enddata, endbss .text begtext: .data begdata: .bss begbss: .text entry start start: ! ok, the read went well so we get current cursor position and save it for ! posterity. ; ä¿å­˜å…‰æ ‡çš„ä½ç½® ; ä½¿ç”¨BIOSä¸­æ–­å–å±å¹•å½“å‰å…‰æ ‡çš„ä½ç½®(åˆ—ï¼Œè¡Œ)ï¼Œä¿å­˜åˆ°å†…å­˜(0x90000)å¤„,2ä¸ªbyte ; æ§åˆ¶å°åˆå§‹åŒ–ç¨‹åºä¼šåˆ°æ­¤å¤„è¯»å–è¯¥å€¼ ; BISO ä¸­æ–­0x10 åŠŸèƒ½å· ah = 0x30 ï¼Œè¯»å…‰æ ‡çš„ä½ç½® ; è¾“å…¥ï¼šbh=é¡µå· ; è¿”å›ï¼šè¿”å›ï¼šch = æ‰«æå¼€å§‹çº¿ï¼Œcl = ç»“æŸå¼€å§‹çº¿,dh = è¡Œå·(0x00é¡¶ç«¯)ï¼Œdl=åˆ—å·(0x00æœ€å·¦è¾¹) mov\tax,#INITSEG ! this is done in bootsect already, but... mov\tds,ax mov\tah,#0x03\t! read cursor pos åŠŸèƒ½å· ah = 0x30 ï¼Œè¯»å…‰æ ‡çš„ä½ç½® xor\tbh,bh int\t0x10\t! save it in known place, con_init fetches mov\t[0],dx\t! it from 0x90000. å°†dsè®¾ç½®æˆ0x90000(INITSEG) ! Get memory size (extended mem, kB) ; å¾—åˆ°æ‰©å±•å†…å­˜çš„å¤§å° ; åˆ©ç”¨BIOSä¸­æ–­0x15 åŠŸèƒ½å· ah= 0x88å–ç³»ç»Ÿæ‰€å«æ‰©å±•å†…å­˜å¤§å°å¹¶ä¿å­˜åˆ°0x90002å¤„ ; è¿”å›ï¼š ax= 0x10000(1M)å¤„å¼€å§‹çš„æ‰©å±•å†…å­˜å¤§å°ï¼Œè‹¥å‡ºé”™CFç½®ä½ï¼Œax=å‡ºé”™ç  mov\tah,#0x88 int\t0x15 mov\t[2],ax !æ‰©å±•å†…å­˜çš„å¤§å°ä¿å­˜åˆ°0x90002å¤„ ! Get video-card data: ; å¾—åˆ°æ˜¾ç¤ºå¡å½“å‰çš„æ˜¾ç¤ºæ¨¡å¼ ; è°ƒç”¨BIOSä¸­æ–­0x10ï¼ŒåŠŸèƒ½å· ah = 0x0f ; è¿”å›ï¼šah=å­—ç¬¦åˆ—æ•°ï¼Œal=æ˜¾ç¤ºæ¨¡å¼ï¼Œbh=æ˜¾ç¤ºå½“å‰é¡µæ•° mov\tah,#0x0f int\t0x10 mov\t[4],bx\t! bh = display page mov\t[6],ax\t! al = video mode, ah = window width ! check for EGA/VGA and some config parameters ; æ£€æµ‹æ˜¾ç¤ºæ–¹å¼ ; è°ƒç”¨BIOSä¸­æ–­0x10, åŠŸèƒ½å· ah=0x12,bl=0x10 mov\tah,#0x12 mov\tbl,#0x10 int\t0x10 mov\t[8],ax ! 0x90008 =ax mov\t[10],bx ! 0x9000A = å®‰è£…çš„æ˜¾ç¤ºå†…å­˜ï¼Œ0x9000B = æ˜¾ç¤ºçŠ¶æ€ mov\t[12],cx\tï¼0X9000C = æ˜¾å¡ç‰¹æ€§å‚æ•° ! Get hd0 data ; å–ç¬¬ä¸€ä¸ªç¡¬ç›˜ä¿¡æ¯ ; ç¬¬ä¸€ä¸ªç¡¬ç›˜å‚æ•°è¡¨çš„é¦–åœ°å€æ˜¯ä¸­æ–­å‘é‡0x41çš„å‘é‡å€¼ ; ç¬¬äºŒä¸ªç´§è·Ÿç€å¯¹åº”ç€ä¸­æ–­å‘é‡0x46 ; ä¸‹é¢ä¸¤ä¸ªç¨‹åºåˆ†åˆ«å¤åˆ¶BIOSæœ‰å…³ç¡¬ç›˜å‚æ•°è¡¨ï¼Œ ; ç¬¬ä¸€ä¸ªç¡¬ç›˜å­˜æ”¾åœ¨0x90080,ç¬¬äºŒä¸ªç¡¬ç›˜å­˜æ”¾åœ¨0x90090 mov\tax,#0x0000 mov\tds,ax lds\tsi,[4*0x41] !å–ä¸­æ–­å‘é‡0x41å¯¹åº”çš„åœ°å€ ï¼Œhd0å‚æ•°è¡¨çš„åœ°å€--\u003e ds:si mov\tax,#INITSEG mov\tes,ax mov\tdi,#0x0080 ï¼ä¼ è¾“çš„ç›®çš„åœ°å€(0x9000:0x0080) --\u003ees:di mov\tcx,#0x10 ! å¾ªç¯æ¬¡æ•°ï¼Œæ¯æ¬¡å¾ªç¯å®Œæ¬¡æ•°å‡ä¸€ï¼Œå…±ä¼ è¾“16ä¸ªå­—èŠ‚ rep\t! repæ˜¯repeatï¼Œrepé…åˆ movw(movsb) å°±æ˜¯å¤šæ¬¡å¤åˆ¶ç›´åˆ°cx=0ä¸ºæ­¢ å¤åˆ¶çš„æ¬¡æ•°æ”¾åœ¨cxä¸­ movsb ! ç”¨äºæŠŠå†…å®¹ä»ds:si å¤åˆ¶es:di ä»¥å­—èŠ‚å•ä½ ! Get hd1 data mov\tax,#0x0000 mov\tds,ax lds\tsi,[4*0x46] !å–ä¸­æ–­å‘é‡0x41å¯¹åº”çš„åœ°å€ ï¼Œhd0å‚æ•°è¡¨çš„åœ°å€--\u003e ds:si mov\tax,#INITSEG mov\tes,ax mov\tdi,#0x0090 mov\tcx,#0x10 rep movsb ! Check that there IS a hd1 :-) ; æ£€æµ‹æ˜¯å¦æœ‰ç¬¬äºŒä¸ªç¡¬ç›˜ï¼Œå¦‚æœæ²¡æœ‰åˆ™æŠŠç¬¬2ä¸ªæ¸…é›¶ ; åˆ©ç”¨BIOSä¸­æ–­è°ƒç”¨0x13çš„å–ç›˜çš„ç±»å‹ï¼ŒåŠŸèƒ½å· ah =0x15 mov\tax,#0x01500 mov\tdl,#0x81 ! dl = é©±åŠ¨å™¨å·(0x8Xæ˜¯ç¡¬ç›˜ï¼Œ0x81æ˜¯ç¬¬ä¸€ä¸ªç¡¬ç›˜ï¼Œ0x82æ˜¯ç¬¬äºŒä¸ªç¡¬ç›˜) int\t0x13 jc\tno_disk1 ! ç¬¬äºŒä¸ªä¸å­˜åœ¨ cmp\tah,#3\t! ah =ç±»å‹ç  æŒ‡ç¡¬ç›˜ je\tis_disk1 ! å­˜åœ¨ ; ç¬¬äºŒä¸ªç¡¬ç›˜ä¸å­˜åœ¨ï¼Œå¯¹ç¬¬äºŒä¸ªç¡¬ç›˜è¡¨æ¸…é›¶ no_disk1: mov\tax,#INITSEG mov\tes,ax mov\tdi,#0x0090 mov\tcx,#0x10 mov\tax,#0x00 rep stosb ; ç¬¬äºŒä¸ªç¡¬ç›˜å­˜åœ¨ï¼Œè¿›å…¥ä¿æŠ¤æ¨¡å¼ï¼Œä»æ­¤å¼€å§‹ä¸å…è®¸ä¸­æ®µ is_disk1: ! now we want to move to protected mode ... cli\t! no interrupts allowed ! ! first we move the system to it's rightful place ; bootsectå¼•å¯¼ç¨‹åºå°†systemæ¨¡å—ç§»åŠ¨åˆ°(0x10000)å¤„ï¼Œ ; å¹¶æŠŠè‡ªå·±ç§»åŠ¨åˆ°(0x90000)å¤„ï¼ŒæŠŠsetupåŠ è½½åœ¨å®ƒåé¢ ; ä¸‹é¢è¿™æ®µç¨‹åºå°†æ•´ä¸ªsystemæ¨¡å—ç§»åŠ¨åˆ°0x00000å¤„ï¼Œ ; å³æŠŠä»0x10000åˆ°0x8ffffçš„å†…å­˜æ•°æ®å—æ•´å—çš„å‘å†…å­˜åœ°å€ä½ç«¯ç§»åŠ¨äº†0x10000çš„ä½ç½® mov\tax,#0x0000 cld\t! 'direction'=0, movs moves forward do_move: mov\tes,ax\t! destination segment add\tax,#0x1000 cmp\tax,#0x9000 ! åˆ¤æ–­ä»£ç æ˜¯å¦ç§»åŠ¨å®Œæˆ jz\tend_move ! ç§»åŠ¨å®Œæˆåˆ™è·³è½¬ mov\tds,ax\t! source segment sub\tdi,di sub\tsi,si mov cx,#0x8000 ! å¾ªç¯ç§»åŠ¨ï¼Œå¾ªç¯æ¬¡æ•°ï¼Œæ¯æ¬¡å¾ªç¯å®Œæ¬¡æ•°å‡ ç§»åŠ¨0x8000å­— rep\t! ç”¨äºæŠŠå†…å®¹ä»ds:si å¤åˆ¶es:di ä»¥å­—èŠ‚å•ä½ movsw ! repæ˜¯repeatï¼Œrepé…åˆ movw(movsb) å°±æ˜¯å¤šæ¬¡å¤åˆ¶ç›´åˆ°cx=0ä¸ºæ­¢ å¤åˆ¶çš„æ¬¡æ•°æ”¾åœ¨cxä¸­ jmp\tdo_move ! then we load the segment descriptors ; åŠ è½½æ®µæè¿°ç¬¦ï¼Œè®¾ç½®å…¨å±€æè¿°ç¬¦è¡¨å’Œä¸­æ–­æè¿°è¡¨ end_move: mov\tax,#SETUPSEG\t! right, forgot this at first. didn't work :-) mov\tds,ax ; lidtæŒ‡ä»¤ç”¨äºåŠ è½½ä¸­æ–­æè¿°ç¬¦è¡¨(IDT)å¯„å­˜å™¨ ; ä¸­æ–­æè¿°ç¬¦è¡¨ä¸­æ¯ä¸€ä¸ª8ä¸ªå­—èŠ‚å¯¹åº”æ¯ä¸ªä¸­æ–­å‘ç”Ÿæ—¶æ‰€éœ€è¦çš„ä¸­æ–­ç¨‹åºåœ°å€å…¥å£ lidt\tidt_48\t! load idt with 0,0 ; lgdtæŒ‡ä»¤ç”¨äºåŠ è½½å…¨å±€æè¿°ç¬¦è¡¨(GDT)å¯„å­˜å™¨ ; å…¨å±€æè¿°ç¬¦è¡¨ä¸­æ¯ä¸ªæè¿°ç¬¦é¡¹(8å­—èŠ‚)æè¿°äº†ä¿æŠ¤æ¨¡å¼ä¸‹æ•°æ®æ®µå’Œä»£ç æ®µçš„ä¿¡æ¯ lgdt\tgdt_48\t! load gdt with whatever appropriate ! that was painless, now we enable A20 ; å¼€å¯A20åœ°å€çº¿ï¼Œä¸ºäº†èƒ½å¤Ÿè®¿é—®å’Œä½¿ç”¨1MBä»¥ä¸Šçš„ç‰©ç†å†…å­˜ call\tempty_8042 ! æµ‹è¯•8042çŠ¶æ€å¯„å­˜å™¨ï¼Œç­‰å¾…è¾“å…¥ç¼“å†²å™¨ç©ºï¼Œ mov\tal,#0xD1\t! command write 0xD1å‘½ä»¤ç è¡¨ç¤ºå†™æ•°æ®åˆ°8042çš„P2ç«¯å£ out\t#0x64,al call\tempty_8042 ï¼ç­‰å¾…è¾“å…¥ç¼“å†²å™¨ç©ºï¼Œçœ‹å‘½ä»¤æ˜¯å¦è¢«æ¥å— mov\tal,#0xDF\t! A20 on out\t#0x60,al call\tempty_8042 ï¼è‹¥æ­¤æ—¶è¾“å…¥ç¼“å†²å™¨ä¸ºç©ºï¼Œåˆ™è¡¨ç¤ºA20çº¿ä¹Ÿé€‰é€š ! well, that went ok, I hope. Now we have to reprogram the interrupts :-( ! we put them right after the intel-reserved hardware interrupts, at ! int 0x20-0x2F. There they won't mess up anything. Sadly IBM really ! messed this up with the original PC, and they haven't been able to ! rectify it afterwards. Thus the bios puts interrupts at 0x08-0x0f, ! which is used for the internal hardware interrupts as well. We just ! have to reprogram the 8259's, and it isn't fun. ; é‡æ–°å¯¹ä¸­æ–­è¿›è¡Œç¼–ç¨‹ mov\tal,#0x11\t! initialization sequence out\t#0x20,al\t! send it to 8259A-1 å‘é€åˆ°8259Aä¸»èŠ¯ç‰‡ ; 0x00ebç›´æ¥ä½¿ç”¨æœºå™¨ç è¡¨ç¤ºä¸¤æ¡ç›¸å¯¹è·³è½¬æŒ‡ä»¤ï¼Œèµ·å»¶æ—¶ä½œç”¨ .word\t0x00eb,0x00eb\t! jmp $+2, jmp $+2 out\t#0xA0,al\t! and to 8259A-2 å†å‘é€åˆ°8259Aä»èŠ¯ç‰‡ .word\t0x00eb,0x00eb ; ç³»ç»Ÿç¡¬ä»¶ä¸­æ–­å·è¢«è®¾ç½®æˆ0x20å¼€å§‹ mov\tal,#0x20\t! start of hardware int's (0x20) out\t#0x21,al\tï¼é€ä¸»èŠ¯ç‰‡ICW2å‘½ä»¤å­—ï¼Œè®¾ç½®èµ·å§‹ä¸­æ–­ï¼Œè¦é€å¥‡ç«¯å£ .word\t0x00eb,0x00eb mov\tal,#0x28\t! start of hardware int's 2 (0x28) out\t#0xA1,al ï¼é€ä¸»èŠ¯ç‰‡ICW2å‘½ä»¤å­—ï¼Œä»èŠ¯ç‰‡çš„èµ·å§‹ä¸­æ–­å· .word\t0x00eb,0x00eb mov\tal,#0x04\t! 8259-1 is master out\t#0x21,al !ICW3 .word\t0x00eb,0x00eb mov\tal,#0x02\t! 8259-2 is slave out\t#0xA1,al .word\t0x00eb,0x00eb mov\tal,#0x01\t! 8086 mode for both out\t#0x21,al .word\t0x00eb,0x00eb out\t#0xA1,al .word\t0x00eb,0x00eb mov\tal,#0xFF\t! mask off all interrupts for now out\t#0x21,al .word\t0x00eb,0x00eb out\t#0xA1,al ! well, that certainly wasn't fun :-(. Hopefully it works, and we don't ! need no steenking BIOS anyway (except for the initial loading :-). ! The BIOS-routine wants lots of unnecessary data, and it's less ! \"interesting\" anyway. This is how REAL programmers do it. ! ! Well, now's the time to actually move into protected mode. To make ! things as simple as possible, we do no register set-up or anything, ! we let the gnu-compiled 32-bit programs do that. We just jump to ! absolute address 0x00000, in 32-bit protected mode. ; è¿›å…¥ä¿æŠ¤æ¨¡å¼ï¼Œåªæ˜¯è·³è½¬åˆ°ç»å¯¹åœ°å€0x00000å¤„ ; åŠ è½½æœºå™¨çŠ¶æ€å­—(æ§åˆ¶å¯„å­˜å™¨CR0)ï¼Œå°†0ä½ç½®1ï¼ŒCPUåˆ‡æ¢åˆ°ä¿æŠ¤æ¨¡å¼ mov\tax,#0x0001\t! protected mode (PE) bit ä¿æŠ¤æ¨¡å¼æ¯”ç‰¹ä½(PE) lmsw\tax\t! This is it! åŠ è½½çŠ¶æ€å¯„å­˜å™¨ ;æ®µé€‰æ‹©ç¬¦8è¡¨ç¤ºè¯·æ±‚ç‰¹æƒ0çº§ï¼Œä½¿ç”¨GDTç¬¬äºŒä¸ªæ®µæè¿°ç¬¦ jmpi\t0,8\t! jmp offset 0 of segment 8 (cs) è·³è½¬è‡³csæ®µåç§»åœ°å€ä½0å¤„(systemå·²ç»ç§»åŠ¨åˆ°0x00000å¤„) ! This routine checks that the keyboard command queue is empty ! No timeout is used - if this hangs there is something wrong with ! the machine, and we probably couldn't proceed anyway. ; æ£€å·®é”®ç›˜å‘½ä»¤é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º ; åªæœ‰å½“è¾“å…¥ç¼“å†²å™¨ä¸ºç©º(é”®ç›˜æ§åˆ¶å™¨çŠ¶æ€å¯„å­˜å™¨ä½1 = 0)æ‰å¯ä»¥è¿›è¡Œå†™å‘½ä»¤ empty_8042: .word\t0x00eb,0x00eb ï¼å»¶æ—¶ä½œç”¨ in\tal,#0x64\t! 8042 status port test\tal,#2\t! is input buffer full? jnz\tempty_8042\t! yes - loop ret ; GDTå…¨å±€æè¿°ç¬¦è¡¨å¼€å§‹å¤„ï¼Œæè¿°ç¬¦è¡¨ç”±å¤šä¸ª8å­—èŠ‚é•¿çš„æè¿°ç¬¦é¡¹ç»„æˆ, ; 3ä¸ªæè¿°ç¬¦é¡¹ ; ç¬¬ä¸€é¡¹æ²¡æœ‰ä½œç”¨ï¼Œä½†æ˜¯å¿…é¡»å­˜åœ¨ ; ç¬¬äºŒé¡¹æ˜¯ç³»ç»Ÿä»£ç æ®µæè¿°ç¬¦ ; ç¬¬ä¸‰é¡¹æ˜¯ç³»ç»Ÿæ•°æ®æ®µæè¿°ç¬¦ gdt: .word\t0,0,0,0\t! dummy ç¬¬ä¸€ä¸ªæè¿°ç¬¦ ä¸ç”¨ ; åœ¨GDTè¡¨è¿™é‡Œçš„åç§»é‡æ˜¯0x80,å®ƒæ˜¯å†…æ ¸ä»£ç æ®µé€‰æ‹©ç¬¦çš„å€¼ .word\t0x07FF\t! 8Mb - limit=2047 (2048*4096=8Mb) .word\t0x0000\t! base address=0 .word\t0x9A00\t! code read/exec .word\t0x00C0\t! granularity=4096, 386 ; åœ¨GDTè¡¨è¿™é‡Œçš„åç§»é‡æ˜¯0x10,å®ƒæ˜¯å†…æ ¸æ•°æ®æ®µé€‰æ‹©ç¬¦çš„å€¼ .word\t0x07FF\t! 8Mb - limit=2047 (2048*4096=8Mb) .word\t0x0000\t! base address=0 .word\t0x9200\t! data read/write .word\t0x00C0\t! granularity=4096, 386 ; åŠ è½½ä¸­æ–­æè¿°ç¬¦è¡¨å¯„å­˜å™¨(idtr) ; è¿™é‡Œè®¾ç½®ä¸€ä¸ªé•¿åº¦ä¸º0çš„ç©ºè¡¨ idt_48: .word\t0\t! idt limit=0 .word\t0,0\t! idt base=0L ; åŠ è½½å…¨å±€æè¿°ç¬¦è¡¨å¯„å­˜å™¨(gdtr) ; GDTè¡¨é•¿åº¦ä¸º2kb gdt_48: .word\t0x800\t! gdt limit=2048, 256 GDT entries .word\t512+gdt,0x9\t! gdt base = 0X9xxxx .text endtext: .data enddata: .bss endbss: å†…æ ¸å¼•å¯¼ç¨‹åºâ€”head 1.ç®€ä»‹ head.s ç¨‹åºåœ¨è¢«ç¼–è¯‘ç”Ÿæˆç›®æ ‡æ–‡ä»¶åä¼šä¸å†…æ ¸å…¶ä»–ç¨‹åºä¸€èµ·è¢«é“¾æ¥æˆ system æ¨¡å—ï¼Œå®ƒä½äº system æ¨¡å—çš„æœ€å¼€å§‹éƒ¨åˆ†ã€‚systemæ¨¡å—å°†è¢«æ”¾ç½®åœ¨ç£ç›˜ä¸Šsetupæ¨¡å—ä¹‹åçš„æ‰‡åŒºï¼Œä»ç£ç›˜ä¸Šç¬¬6ä¸ªæ‰‡åŒºå¼€å§‹æ”¾ç½®ã€‚\næ³¨ï¼šè¿™æ®µç¨‹åºå¤„äºç»å¯¹åœ°å€0x00000å¤„ã€‚\nç¨‹åºè¿›å…¥ä¿æŠ¤æ¨¡å¼ï¼Œç¨‹åºé‡‡ç”¨AT\u0026Tè¯­æ³•æ ¼å¼ã€‚\nLinux AT\u0026Tæ±‡ç¼–è¯­æ³•ç®€ä»‹ï¼š\næ·»åŠ é“¾æ¥æè¿°\nä½œç”¨ï¼šhead.sç¨‹åºï¼šè®¾ç½®ä¸­æ–­æè¿°ç¬¦è¡¨é¡¹ï¼ˆå“‘ä¸­æ–­ï¼‰ï¼›æ£€æŸ¥A20ï¼›æµ‹è¯•æ˜¯å¦æœ‰åå¤„ç†å™¨ï¼›åˆå§‹åŒ–å†…å­˜é¡µç›®å½•è¡¨ï¼›è·³è½¬åˆ°main.cæ‰§è¡Œå†…æ ¸åˆå§‹åŒ–\nheadå®Œæˆåå®Œæˆäº†å†…å­˜é¡µç›®å½•å’Œé¡µè¡¨çš„è®¾ç½®ï¼Œå¹¶é‡æ–°è®¾ç½®äº†å†…æ ¸å®é™…ä½¿ç”¨çš„ä¸­æ–­æè¿°ç¬¦è¡¨idtå’Œå…¨å±€æè¿°ç¬¦è¡¨GDT,è¿˜ä¸ºè½¯ç›˜é©±åŠ¨ç¨‹åºå¼€è¾Ÿäº†1KBå­—èŠ‚çš„ç¼“å†²åŒºã€‚\n32ä½ä¸‹å¯»å€\nå°†å®æ¨¡å¼ä¸‹çš„æ®µå¯„å­˜å™¨å½“ä½œä¿æŠ¤æ¨¡å¼ä¸‹çš„æ®µæè¿°ç¬¦çš„æŒ‡é’ˆä½¿ç”¨ï¼Œæ­¤æ—¶æ®µå¯„å­˜å™¨ä¸­å­˜æ”¾çš„æ˜¯ä¸€ä¸ªæè¿°ç¬¦åœ¨æè¿°ç¬¦è¡¨ä¸­çš„åç§»åœ°å€å¯„å­˜å™¨ï¼Œè€Œå½“å‰æè¿°ç¬¦è¡¨çš„åŸºåœ°å€åˆ™ä¿å­˜åœ¨æè¿°ç¬¦è¡¨å¯„å­˜å™¨ä¸­ã€‚\nheadç¨‹åºç»“æŸåå†…å­˜æ˜ åƒ\n.align\n1 2 3 4 5 .align 2 å®Œæ•´æ ¼å¼ ï¼š.align val1,val2,val3 val1 æ˜¯éœ€è¦å¯¹é½çš„å€¼ val2 å¡«å……å­—èŠ‚æŒ‡å®šçš„å€¼ val3 æŒ‡æ˜æœ€å¤§ç”¨äºå¡«å……æˆ–è·³è¿‡çš„ç›´æ¥æ•° .alignæ˜¯æ±‡ç¼–è¯­è¨€æŒ‡ç¤ºç¬¦ã€‚å…¶å«ä¹‰æ˜¯è¾¹ç•Œå¯¹é½è°ƒæ•´ã€‚â€2â€è¡¨ç¤ºæŠŠéšåçš„ä»£ç æˆ–æ•°æ®çš„åç§»ä½ç½®è°ƒæ•´åˆ°åœ°å€å€¼æœ€å 2 æ¯”ç‰¹ä½ä¸ºé›¶çš„ä½ç½®ï¼Œå³æŒ‰ 4ï¼ˆ=2^2ï¼‰å­—èŠ‚æ–¹å¼å¯¹é½å†…å­˜åœ°å€ã€‚ä¸è¿‡ç°åœ¨ GNU as ç›´æ¥å†™å‡ºå¯¹é½çš„å€¼è€Œé 2 çš„å¹‚æ¬¡ã€‚ä½¿ç”¨è¯¥æŒ‡ç¤ºç¬¦çš„ç›®çš„æ˜¯ä¸ºäº†æé«˜ 32 ä½ CPU è®¿é—®å†…å­˜ä¸­ä»£ç æˆ–æ•°æ®çš„æ•ˆç‡ã€‚\n.ORG\nORGä¼ªæŒ‡ä»¤ç”¨æ¥è¡¨ç¤ºèµ·å§‹çš„åç§»åœ°å€ï¼Œç´§æ¥ç€ORGçš„æ•°å€¼å°±æ˜¯åç§»åœ°å€çš„èµ·å§‹å€¼ã€‚ORGä¼ªæ“ä½œå¸¸ç”¨æ¥æŒ‡å®šæ•°æ®çš„å­˜å‚¨åœ°å€ï¼Œæœ‰æ—¶ä¹Ÿç”¨æ¥æŒ‡å®šä»£ç æ®µçš„èµ·å§‹åœ°å€\nfill\nfillä¼ªæŒ‡ä»¤çš„æ ¼å¼æ˜¯ .fill repeat,size,value\nè¡¨ç¤ºäº§ç”Ÿ repeat ä¸ªå¤§å°ä¸º size å­—èŠ‚çš„é‡å¤æ‹·è´ã€‚size æœ€å¤§æ˜¯ 8ï¼Œsize å­—èŠ‚çš„å€¼æ˜¯ value.\næŒ‰ä½å¼‚æˆ– xor\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 1. ä½¿æŸäº›ç‰¹å®šçš„ä½ç¿»è½¬ ä¾‹å¦‚è¦ä½¿ EAX çš„ b1 ä½å’Œ b2 ä½ç¿»è½¬ï¼š EAX = EAX ^ 00000110 2.ä¸ä½¿ç”¨ä¸´æ—¶å˜é‡å°±å¯ä»¥å®ç°ä¸¤ä¸ªå€¼çš„äº¤æ¢ ä¾‹å¦‚ a=11110000ï¼Œb=00001111ï¼Œè¦äº¤æ¢aã€bçš„å€¼ a = a^bï¼› //a=11111111 b = b^aï¼› //b=11110000 a = a^bï¼› //a=00001111 3.åœ¨æ±‡ç¼–è¯­è¨€ä¸­ç»å¸¸ç”¨äºå°†å˜é‡ç½®é›¶ xor eaxï¼Œeax 4.å¿«é€Ÿåˆ¤æ–­ä¸¤ä¸ªå€¼æ˜¯å¦ç›¸ç­‰ ä¾‹å¦‚åˆ¤æ–­ä¸¤ä¸ªæ•´æ•°aã€bæ˜¯å¦ç›¸ç­‰ï¼Œå¯é€šè¿‡ä¸‹åˆ—è¯­å¥å®ç°ï¼š return ((a ^ b) == 0)ï¼› LSSæŒ‡ä»¤\n1 2 3 æ ¼å¼ï¼šLSS r32,m16:32 #ç”¨å†…å­˜ä¸­çš„é•¿æŒ‡é’ˆåŠ è½½ SS:r32 m16:32è¡¨ç¤ºä¸€ä¸ªå†…å­˜æ“ä½œæ•°ï¼Œè¿™ä¸ªæ“ä½œæ•°æ˜¯ä¸€ä¸ªé•¿æŒ‡é’ˆï¼Œç”±2éƒ¨åˆ†ç»„æˆï¼š16ä½çš„æ®µé€‰æ‹© å­å’Œ32ä½çš„åç§»ã€‚ 2.æºç åˆ†æ 1.å¯åŠ¨32ä½ç¨‹åº\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 startup_32: movl $0x10,%eax ;0x10 GDTä¸­çš„åç§»å€¼(ä¸€ä¸ªæè¿°ç¬¦è¡¨é¡¹çš„é€‰æ‹©ç¬¦) ;è¯·æ±‚ç‰¹çº§æƒ0(ä½0-1 =0)ï¼ŒGDT(ä½2=0)ï¼Œé€‰æ‹©è¡¨ä¸­ç¬¬2é¡¹(ä½3-15=2) ; æ­£å¥½æŒ‡å‘æ•°æ®æ®µæè¿°ç¬¦é¡¹ mov %ax,%ds ; è®¾ç½®ds,es,fs,gsä¸ºsetupä¸­æ„é€ çš„æ•°æ®æ®µçš„é€‰æ‹©ç¬¦ =0x10 mov %ax,%es\t;å¹¶å°†å †æ ˆæ”¾ç½®åœ¨stack_start(æŒ‡é’ˆ)æŒ‡å‘çš„user_stackæ•°ç»„åŒº mov %ax,%fs mov %ax,%gs lss _stack_start,%esp ;_stack_start--\u003ess:esp,è®¾ç½®ç³»ç»Ÿå †æ ˆ ;ç§»åŠ¨åˆ°ä»»åŠ¡0æ‰§è¡Œ(init/main.c)ï¼Œè¯¥æ ˆå°±è¢«ç”¨åšä»»åŠ¡0å’Œä»»åŠ¡1å…±åŒä½¿ç”¨çš„ç”¨æˆ·æ ˆ call setup_idt ; è°ƒç”¨è®¾ç½®ä¸­æ–­æè¿°ç¬¦è¡¨å­ç¨‹åº call setup_gdt ; è°ƒç”¨è®¾ç½®å…¨å±€æè¿°ç¬¦è¡¨å­ç¨‹åº movl $0x10,%eax\t# reload all the segment registers mov %ax,%ds\t# after changing gdt. CS was already mov %ax,%es\t# reloaded in 'setup_gdt' mov %ax,%fs\t# å› ä¸ºä¿®æ”¹äº†gdt,æ‰€ä»¥é‡æ–°åŠ è½½è¿™äº›å¯„å­˜å™¨ mov %ax,%gs 2.åŠ è½½å„ä¸ªæ®µå¯„å­˜å™¨ï¼Œé‡æ–°è®¾ç½®ä¸­æ–­æè¿°ç¬¦è¡¨ï¼Œå…±256é¡¹ï¼Œå¹¶ä½¿å„ä¸ªè¡¨é¡¹å‡æŒ‡å‘ä¸€ä¸ªåªæŠ¥é”™è¯¯çš„å“‘ä¸­æ–­ç¨‹åºï¼Œé‡æ–°è®¾ç½®å…¨å±€æè¿°ç¬¦è¡¨\n1)IDT:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 ;è®¾ç½®ä¸­æ–­æè¿°ç¬¦è¡¨(IDT)å­—ç¨‹åºsetup_idt ; å°†ä¸­æ–­æè¿°ç¬¦è¡¨è®¾ç½®å…·æœ‰256ä¸ªé¡¹ï¼Œå¹¶éƒ½æŒ‡å‘ignore_intä¸­æ–­é—¨ï¼Œç„¶ååŠ è½½ä¸­æ–­æè¿°ç¬¦è¡¨å¯„å­˜å™¨ ; ä¸­æ–­æè¿°ç¬¦è¡¨ä¸­çš„é¡¹ä¸º8ä¸ªå­—èŠ‚ï¼Œç§°ä¸ºé—¨æè¿°ç¬¦ setup_idt: lea ignore_int,%edx # å°†ignore_intæœ‰æ•ˆåœ°å€å€¼èµ‹å€¼ç»™edx movl $0x00080000,%eax # å°†é€‰æ‹©ç¬¦0x0008èµ‹å€¼ç»™eaxçš„é«˜16ä½ movw %dx,%ax\t/* selector = 0x0008 = cs */ movw $0x8E00,%dx\t/* interrupt gate - dpl=0, present */ lea _idt,%edi # _idt æ˜¯ä¸­æ–­æè¿°ç¬¦è¡¨çš„åœ°å€ mov $256,%ecx rp_sidt: movl %eax,(%edi)\t# eax -\u003e [edi] å°†å“‘ä¸­æ–­é—¨æè¿°ç¬¦å­˜å…¥è¡¨ä¸­ movl %edx,4(%edi) # edx -\u003e [edi+4] addl $8,%edi\t# edi + 8 -\u003e edi dec %ecx jne rp_sidt lidt idt_descr #åŠ è½½ä¸­æ–­æè¿°ç¬¦è¡¨å¯„å­˜å™¨ ret 2)GDT\n1 2 3 4 # è®¾ç½®å…¨å±€æè¿°ç¬¦è¡¨é¡¹ setup_gdt: lgdt gdt_descr # åŠ è½½å…¨å±€æè¿°ç¬¦å¯„å­˜å™¨ ret 3.å¯¹æ¯”ç‰©ç†åœ°å€0ä¸1Må¼€å§‹å¤„çš„å†…å®¹æ˜¯å¦ç›¸åŒï¼Œå¦‚æœç›¸åŒé‚£ä¹ˆæ²¡æœ‰å¼€å¯A20åœ°å€çº¿ï¼Œè¿›å…¥æ­»å¾ªç¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 ;æµ‹è¯•A20åœ°å€çº¿æ˜¯å¦å¼€å¯ ;æ–¹æ³•ï¼šå‘å†…å­˜åœ°å€0å¤„å†™å…¥ä»»æ„ä¸€ä¸ªæ•°å€¼ï¼Œçœ‹å†…å­˜åœ°å€æ˜¯å¦æ˜¯è¿™ä¸ªæ•°å€¼ ;å¦‚æœæ˜¯å°±ä¸€ç›´æ¯”è¾ƒä¸‹å»ï¼Œäº§ç”Ÿæ­»å¾ªç¯ï¼Œ ;è¡¨ç¤ºA20çº¿æ²¡æœ‰é€‰é€šï¼Œå†…æ ¸å°±ä¸èƒ½ä½¿ç”¨1MBä»¥åçš„å†…å­˜ç©ºé—´ xorl %eax,%eax 1:\tincl %eax\t# check that A20 really IS enabled # 1--\u003eæ ‡å·ï¼Œè¡¨ç¤ºæ´»åŠ¨ä½ç½®è®¡æ•°çš„å½“å‰å€¼ï¼Œå¹¶å¯ä»¥ä½œä¸ºæŒ‡ä»¤çš„æ“ä½œæ•° movl %eax,0x000000\t# loop forever if it isn't cmpl %eax,0x100000 je 1b # Nb:å¼•ç”¨å…ˆå‰æœ€è¿‘çš„æ ‡å· 'b':backwards å‘å # Nf:å¼•ç”¨ä¸‹ä¸€ä¸ªæ ‡å· 'f':forwards å‘å‰ # è¿™é‡Œâ€˜1bâ€™è¡¨ç¤ºï¼šå‘åè·³è½¬åˆ°æ ‡å·1å» # å¦‚æœæ˜¯5f,åˆ™æ˜¯å‘å‰è·³è½¬åˆ°æ ‡å·5å» 4.æµ‹è¯•PCæœºæ˜¯å¦å«æœ‰æ•°æ®åå¤„ç†å™¨èŠ¯ç‰‡ï¼Œå¹¶åœ¨æ§åˆ¶å¯„å­˜å™¨CR0ä¸­è®¾ç½®ç›¸åº”çš„æ ‡å¿—ä½\n1 2 3 4 5 6 7 8 9 10 ; æ£€æµ‹486æ•°å­¦åå¤„ç†å™¨èŠ¯ç‰‡æ˜¯å¦å­˜åœ¨ ; æ–¹æ³•ï¼šä¿®æ”¹æ§åˆ¶å¯„å­˜å™¨CR0ï¼Œç„¶åæ‰§è¡Œä¸€æ¡åå¤„ç†å™¨æŒ‡ä»¤ï¼Œè‹¥å‡ºé”™ï¼Œåˆ™ä¸å­˜å’‹ ; éœ€è¦è®¾ç½®åå¤„ç†å™¨ä»¿çœŸä½(EM)ä½2,å¹¶å¤ä½åå¤„ç†å™¨å­˜åœ¨æ ‡å¿—(MP)ä½2 movl %cr0,%eax\t# check math chip andl $0x80000011,%eax\t# Save PG,PE,ET /* \"orl $0x10020,%eax\" here for 486 might be good */ orl $2,%eax\t# set MP å¹¶å¤ä½åå¤„ç†å™¨å­˜åœ¨æ ‡å¿—(MP) movl %eax,%cr0 call check_x87 jmp after_page_tables 5.è®¾ç½®ç®¡ç†å†…å­˜çš„åˆ†é¡µå¤„ç†æœºåˆ¶ï¼Œå°†é¡µç›®å½•è¡¨æ”¾åœ¨ç»å¯¹ç‰©ç†åœ°å€0å¼€å§‹å¤„ç´§éšå…¶åæ”¾ç½®å…±å¯å¯»å€16MBå†…å­˜çš„4ä¸ªé¡µè¡¨ï¼Œå¹¶åˆ†åˆ«è®¾ç½®å®ƒä»¬çš„è¡¨é¡¹\n6.æœ€ååˆ©ç”¨è¿”å›æŒ‡ä»¤å°†é¢„å…ˆæ”¾ç½®åœ¨å †æ ˆä¸­çš„/init/main.cç¨‹åºçš„å…¥å£åœ°å€å¼¹å‡ºï¼Œè¿è¡Œmain()ç¨‹åº\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 # ä¸‹é¢å‡ ä¸ªå…¥æ ˆæ“ä½œä¸ºäº†è·³è½¬åˆ°init/main.cä¸­main()å‡½æ•°åšå‡†å¤‡ # å‰é¢ä¸‰ä¸ªå…¥æ ˆ0å€¼åˆ†åˆ«è¡¨ç¤ºenvp,argvæŒ‡é’ˆå’Œargcçš„å€¼ after_page_tables: pushl $0\t# These are the parameters to main :-) mainå‡½æ•°å‚æ•° envp pushl $0\t# argvæŒ‡é’ˆ pushl $0\t# argc pushl $L6\t# return address for main, if it decides to. æ¨¡æ‹Ÿè°ƒç”¨mainæ—¶é¦–å…ˆå°†è¿”å›åœ°å€å…¥æ ˆçš„æ“ä½œ pushl $_main # _main---\u003emain jmp setup_paging # mainå‡½æ•°åˆ°ä¸äº†è¿™é‡Œ ï¼Œåˆ°æ ‡å·L6è¿™é‡Œï¼Œæ˜¯ä¸€ä¸ªæ­»å¾ªç¯ L6: jmp L6\t# main should never return here, but # just in case, we know what happens. 3.headå®Œæ•´æºç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 /* * linux/boot/head.s * * (C) 1991 Linus Torvalds */ /* * head.s contains the 32-bit startup code. * * NOTE!!! Startup happens at absolute address 0x00000000, which is also where * the page directory will exist. The startup code will be overwritten by * the page directory. */ ; headç¨‹åºå«æœ‰32å¯åŠ¨ç¨‹åºä»£ç  ; 32å¯åŠ¨ç¨‹åºä»£ç æ˜¯ä»ç»å¯¹åœ°å€0x00000å¤„å¼€å§‹ ; é¡µç›®å½•ä¹Ÿåœ¨è¯¥å†…å­˜ï¼Œä»¥åå¯åŠ¨ä»£ç å°†ä¼šè¢«è¦†ç›– .text .globl _idt,_gdt,_pg_dir,_tmp_floppy_area _pg_dir: ; é¡µç›®å½•å°†ä¼šæ”¾åœ¨åœ¨è¿™é‡Œ startup_32: movl $0x10,%eax ;0x10 GDTä¸­çš„åç§»å€¼(ä¸€ä¸ªæè¿°ç¬¦è¡¨é¡¹çš„é€‰æ‹©ç¬¦) ;è¯·æ±‚ç‰¹çº§æƒ0(ä½0-1 =0)ï¼ŒGDT(ä½2=0)ï¼Œé€‰æ‹©è¡¨ä¸­ç¬¬2é¡¹(ä½3-15=2) ; æ­£å¥½æŒ‡å‘æ•°æ®æ®µæè¿°ç¬¦é¡¹ mov %ax,%ds ; è®¾ç½®ds,es,fs,gsä¸ºsetupä¸­æ„é€ çš„æ•°æ®æ®µçš„é€‰æ‹©ç¬¦ =0x10 mov %ax,%es\t;å¹¶å°†å †æ ˆæ”¾ç½®åœ¨stack_start(æŒ‡é’ˆ)æŒ‡å‘çš„user_stackæ•°ç»„åŒº mov %ax,%fs mov %ax,%gs lss _stack_start,%esp ;_stack_start--\u003ess:esp,è®¾ç½®ç³»ç»Ÿå †æ ˆ ;ç§»åŠ¨åˆ°ä»»åŠ¡0æ‰§è¡Œ(init/main.c)ï¼Œè¯¥æ ˆå°±è¢«ç”¨åšä»»åŠ¡0å’Œä»»åŠ¡1å…±åŒä½¿ç”¨çš„ç”¨æˆ·æ ˆ call setup_idt ; è°ƒç”¨è®¾ç½®ä¸­æ–­æè¿°ç¬¦è¡¨å­ç¨‹åº call setup_gdt ; è°ƒç”¨è®¾ç½®å…¨å±€æè¿°ç¬¦è¡¨å­ç¨‹åº movl $0x10,%eax\t# reload all the segment registers mov %ax,%ds\t# after changing gdt. CS was already mov %ax,%es\t# reloaded in 'setup_gdt' mov %ax,%fs\t# å› ä¸ºä¿®æ”¹äº†gdt,æ‰€ä»¥é‡æ–°åŠ è½½è¿™äº›å¯„å­˜å™¨ mov %ax,%gs lss _stack_start,%esp ;æµ‹è¯•A20åœ°å€çº¿æ˜¯å¦å¼€å¯ ;æ–¹æ³•ï¼šå‘å†…å­˜åœ°å€0å¤„å†™å…¥ä»»æ„ä¸€ä¸ªæ•°å€¼ï¼Œçœ‹å†…å­˜åœ°å€æ˜¯å¦æ˜¯è¿™ä¸ªæ•°å€¼ ;å¦‚æœæ˜¯å°±ä¸€ç›´æ¯”è¾ƒä¸‹å»ï¼Œäº§ç”Ÿæ­»å¾ªç¯ï¼Œ ;è¡¨ç¤ºA20çº¿æ²¡æœ‰é€‰é€šï¼Œå†…æ ¸å°±ä¸èƒ½ä½¿ç”¨1MBä»¥åçš„å†…å­˜ç©ºé—´ xorl %eax,%eax 1:\tincl %eax\t# check that A20 really IS enabled # 1--\u003eæ ‡å·ï¼Œè¡¨ç¤ºæ´»åŠ¨ä½ç½®è®¡æ•°çš„å½“å‰å€¼ï¼Œå¹¶å¯ä»¥ä½œä¸ºæŒ‡ä»¤çš„æ“ä½œæ•° movl %eax,0x000000\t# loop forever if it isn't cmpl %eax,0x100000 je 1b # Nb:å¼•ç”¨å…ˆå‰æœ€è¿‘çš„æ ‡å· 'b':backwards å‘å # Nf:å¼•ç”¨ä¸‹ä¸€ä¸ªæ ‡å· 'f':forwards å‘å‰ # è¿™é‡Œâ€˜1bâ€™è¡¨ç¤ºï¼šå‘åè·³è½¬åˆ°æ ‡å·1å» # å¦‚æœæ˜¯5f,åˆ™æ˜¯å‘å‰è·³è½¬åˆ°æ ‡å·5å» /* * NOTE! 486 should set bit 16, to check for write-protect in supervisor * mode. Then it would be unnecessary with the \"verify_area()\"-calls. * 486 users probably want to set the NE (#5) bit also, so as to use * int 16 for math errors. */ ; æ£€æµ‹486æ•°å­¦åå¤„ç†å™¨èŠ¯ç‰‡æ˜¯å¦å­˜åœ¨ ; æ–¹æ³•ï¼šä¿®æ”¹æ§åˆ¶å¯„å­˜å™¨CR0ï¼Œç„¶åæ‰§è¡Œä¸€æ¡åå¤„ç†å™¨æŒ‡ä»¤ï¼Œè‹¥å‡ºé”™ï¼Œåˆ™ä¸å­˜å’‹ ; éœ€è¦è®¾ç½®åå¤„ç†å™¨ä»¿çœŸä½(EM)ä½2,å¹¶å¤ä½åå¤„ç†å™¨å­˜åœ¨æ ‡å¿—(MP)ä½2 movl %cr0,%eax\t# check math chip andl $0x80000011,%eax\t# Save PG,PE,ET /* \"orl $0x10020,%eax\" here for 486 might be good */ orl $2,%eax\t# set MP å¹¶å¤ä½åå¤„ç†å™¨å­˜åœ¨æ ‡å¿—(MP) movl %eax,%cr0 call check_x87 jmp after_page_tables /* * We depend on ET to be correct. This checks for 287/387. */ ; fninitå’Œfstswæ˜¯åå¤„ç†å™¨çš„æŒ‡ä»¤ check_x87: fninit # å‘åå¤„ç†å™¨å‘å‡ºåˆå§‹åŒ–æŒ‡ä»¤ fstsw %ax # å°†åå¤„ç†å™¨çŠ¶æ€å­—å¤åˆ¶ç»™ax cmpb $0,%al\t# åˆå§‹åŒ–åçŠ¶æ€å­—åº”è¯¥ä½0ï¼Œå¦åˆ™åå¤„ç†å™¨ä¸å­˜åœ¨ je 1f\t/* no coprocessor: have to set bits */ #è·³è½¬åˆ°æ ‡å·ä½1å¤„(å‰é¢) movl %cr0,%eax # å¦‚æœå­˜åœ¨åˆ™è·³åˆ°æ ‡å·ä½1å¤„ï¼Œå¦åˆ™æ”¹å†™cr0 xorl $6,%eax\t/* reset MP, set EM */ ;è®¾ç½®åå¤„ç†å™¨ä»¿çœŸä½(EM) movl %eax,%cr0 ret # .align æ˜¯æ±‡ç¼–è¯­è¨€æŒ‡ç¤ºç¬¦ï¼Œç”¨äºå­˜å‚¨è¾¹ç•Œå¯¹é½è°ƒæ•´ # 2è¡¨ç¤ºæŠŠéšåçš„ä»£ç å’Œæ•°æ®çš„åç§»ä½ç½®è°ƒæ•´åˆ°åœ°å€å€¼æœ€å2æ¯”ç‰¹ä½ä¸º0çš„ä½ç½®(2*2) # å³æŒ‰å››å­—èŠ‚æ–¹å¼å¯¹é½å†…å­˜åœ°å€ # ä½¿ç”¨è¯¥æŒ‡ç¤ºç¬¦ç›®çš„æ˜¯ä¸ºäº†æé«˜32ä½cpuè®¿é—®å†…å­˜ä¸­ä»£ç æˆ–æ•°æ®çš„é€Ÿåº¦å’Œæ•ˆç‡ .align 2 # 287åå¤„ç†ç ï¼Œå°†80287è®¾ç½®ä¸ºä¿æŠ¤æ¨¡å¼ 1:\t.byte 0xDB,0xE4\t/* fsetpm for 287, ignored by 387 */ ret /* * setup_idt * * sets up a idt with 256 entries pointing to * ignore_int, interrupt gates. It then loads * idt. Everything that wants to install itself * in the idt-table may do so themselves. Interrupts * are enabled elsewhere, when we can be relatively * sure everything is ok. This routine will be over- * written by the page tables. */ ;è®¾ç½®ä¸­æ–­æè¿°ç¬¦è¡¨(IDT)å­—ç¨‹åºsetup_idt ; å°†ä¸­æ–­æè¿°ç¬¦è¡¨è®¾ç½®å…·æœ‰256ä¸ªé¡¹ï¼Œå¹¶éƒ½æŒ‡å‘ignore_intä¸­æ–­é—¨ï¼Œç„¶ååŠ è½½ä¸­æ–­æè¿°ç¬¦è¡¨å¯„å­˜å™¨ ; ä¸­æ–­æè¿°ç¬¦è¡¨ä¸­çš„é¡¹ä¸º8ä¸ªå­—èŠ‚ï¼Œç§°ä¸ºé—¨æè¿°ç¬¦ setup_idt: lea ignore_int,%edx # å°†ignore_intæœ‰æ•ˆåœ°å€å€¼èµ‹å€¼ç»™edx movl $0x00080000,%eax # å°†é€‰æ‹©ç¬¦0x0008èµ‹å€¼ç»™eaxçš„é«˜16ä½ movw %dx,%ax\t/* selector = 0x0008 = cs */ movw $0x8E00,%dx\t/* interrupt gate - dpl=0, present */ lea _idt,%edi # _idt æ˜¯ä¸­æ–­æè¿°ç¬¦è¡¨çš„åœ°å€ mov $256,%ecx rp_sidt: movl %eax,(%edi)\t# eax -\u003e [edi] å°†å“‘ä¸­æ–­é—¨æè¿°ç¬¦å­˜å…¥è¡¨ä¸­ movl %edx,4(%edi) # edx -\u003e [edi+4] addl $8,%edi\t# edi + 8 -\u003e edi dec %ecx jne rp_sidt lidt idt_descr #åŠ è½½ä¸­æ–­æè¿°ç¬¦è¡¨å¯„å­˜å™¨ ret /* * setup_gdt * * This routines sets up a new gdt and loads it. * Only two entries are currently built, the same * ones that were built in init.s. The routine * is VERY complicated at two whole lines, so this * rather long comment is certainly needed :-). * This routine will beoverwritten by the page tables. */ # è®¾ç½®å…¨å±€æè¿°ç¬¦è¡¨é¡¹ setup_gdt: lgdt gdt_descr # åŠ è½½å…¨å±€æè¿°ç¬¦å¯„å­˜å™¨ ret /* * I put the kernel page tables right after the page directory, * using 4 of them to span 16 Mb of physical memory. People with * more than 16MB will have to expand this. */ # å°†å†…æ ¸çš„å†…å­˜é¡µè¡¨ç›´æ¥æ”¾åœ¨é¡µç›®å½•åï¼Œä½¿ç”¨4ä¸ªè¡¨æ¥å¯»å€16MBçš„ç‰©ç†åœ°å€ .org 0x1000 # ä»åç§»åœ°å€0x1000å¤„å¼€å§‹æ˜¯ç¬¬ä¸€ä¸ªé¡µè¡¨(åç§»0å¼€å§‹å°†å­˜æ”¾é¡µè¡¨ç›®å½•) pg0: .org 0x2000 pg1: .org 0x3000 pg2: .org 0x4000 pg3: .org 0x5000 # å®šä¹‰ä¸‹é¢çš„å†…å­˜æ•°æ®ä»åç§»åœ°å€0x5000å¼€å§‹ /* * tmp_floppy_area is used by the floppy-driver when DMA cannot * reach to a buffer-block. It needs to be aligned, so that it isn't * on a 64kB border. */ # å½“DMA(ç›´æ¥å­˜å‚¨å™¨è®¿é—®)ä¸èƒ½è®¿é—®ç¼“å†²å—æ—¶ï¼Œåˆ™_tmp_floppy_areaå†…å­˜å—å°±å¯ä»¥ä¾›è½¯ç›˜é©±åŠ¨ç¨‹åºä½¿ç”¨ # éœ€è¦ä¿è¯åœ°å€å¯¹é½ _tmp_floppy_area: .fill 1024,1,0 # ä¿ç•™1024é¡¹ï¼Œæ¯ä¸€é¡¹ä¸€ä¸ªå­—èŠ‚ï¼Œå¡«å……æ•°å€¼ä¸º0 # ä¸‹é¢å‡ ä¸ªå…¥æ ˆæ“ä½œä¸ºäº†è·³è½¬åˆ°init/main.cä¸­main()å‡½æ•°åšå‡†å¤‡ # å‰é¢ä¸‰ä¸ªå…¥æ ˆ0å€¼åˆ†åˆ«è¡¨ç¤ºenvp,argvæŒ‡é’ˆå’Œargcçš„å€¼ after_page_tables: pushl $0\t# These are the parameters to main :-) mainå‡½æ•°å‚æ•° envp pushl $0\t# argvæŒ‡é’ˆ pushl $0\t# argc pushl $L6\t# return address for main, if it decides to. æ¨¡æ‹Ÿè°ƒç”¨mainæ—¶é¦–å…ˆå°†è¿”å›åœ°å€å…¥æ ˆçš„æ“ä½œ pushl $_main # _main---\u003emain jmp setup_paging # mainå‡½æ•°åˆ°ä¸äº†è¿™é‡Œ ï¼Œåˆ°æ ‡å·L6è¿™é‡Œï¼Œæ˜¯ä¸€ä¸ªæ­»å¾ªç¯ L6: jmp L6\t# main should never return here, but # just in case, we know what happens. /* This is the default interrupt \"handler\" :-) */ # ä¸‹é¢æ˜¯é»˜è®¤çš„ä¸­æ–­'å‘é‡å¥æŸ„'' int_msg: .asciz \"Unknown interruptnr\" # å®šä¹‰â€˜æœªçŸ¥çš„æŒ‡å®šâ€™ .align 2 # æŒ‰4å­—èŠ‚æ–¹å¼å¯¹é½å†…å­˜åœ°å€ # ä¸­æ–­å¤„ç†è¿‡ç¨‹ ignore_int: pushl %eax pushl %ecx pushl %edx push %ds # è¿™é‡Œè¯·æ³¨æ„dsï¼Œesï¼Œfsï¼Œgsç­‰è™½ç„¶æ˜¯16ä½çš„å¯„å­˜å™¨ push %es # ä½†ä»ç„¶ä¼šä»¥32ä½çš„å½¢å¼å…¥æ ˆï¼Œå³éœ€è¦å ç”¨4ä¸ªå­—èŠ‚çš„æ ˆç©ºé—´ push %fs # ä»¥ä¸Šç”¨äºä¿å­˜å¯„å­˜å™¨ movl $0x10,%eax mov %ax,%ds mov %ax,%es mov %ax,%fs pushl $int_msg call _printk # è¯¥å‡½æ•°åœ¨ kernel/printk.c ä¸­ popl %eax # æ¸…ç†å‚æ•° pop %fs pop %es pop %ds popl %edx popl %ecx popl %eax iret # ä¸­æ–­è¿”å›(æŠŠä¸­æ–­è°ƒç”¨æ˜¯å‹å…¥æ ˆçš„CPUæ ‡å¿—å¯„å­˜å™¨å€¼ä¹Ÿå¼¹å‡º) /* * Setup_paging * * This routine sets up paging by setting the page bit * in cr0. The page tables are set up, identity-mapping * the first 16MB. The pager assumes that no illegal * addresses are produced (ie \u003e4Mb on a 4Mb machine). * * NOTE! Although all physical memory should be identity * mapped by this routine, only the kernel page functions * use the \u003e1Mb addresses directly. All \"normal\" functions * use just the lower 1Mb, or the local data space, which * will be mapped to some other place - mm keeps track of * that. * * For those with more memory than 16 Mb - tough luck. I've * not got it, why should you :-) The source is here. Change * it. (Seriously - it shouldn't be too difficult. Mostly * change some constants etc. I left it at 16Mb, as my machine * even cannot be extended past that (ok, but it was cheap :-) * I've tried to show which constants to change by having * some kind of marker at them (search for \"16Mb\"), but I * won't guarantee that's all :-( ) */ # ä¸‹é¢è¿™æ®µå­ç¨‹åºé€šè¿‡æ§åˆ¶CR0çš„æ ‡å¿—ä½(PGä½31)æ¥å¯åŠ¨å¯¹å†…å­˜çš„åˆ†é¡µå¤„ç†åŠŸèƒ½ï¼Œå¹¶è®¾ç½®å„ä¸ªè¡¨é¡¹çš„å†…å®¹\t.align 2 # æŒ‰4å­—èŠ‚æ–¹å¼å¯¹é½å†…å­˜åœ°å€è¾¹ç•Œ setup_paging: movl $1024*5,%ecx\t/* 5 pages - pg_dir+4 page tables */#å¯¹(1é¡µç›®å½•+4é¡µé¡µè¡¨)æ¸…é›¶ xorl %eax,%eax xorl %edi,%edi\t/* pg_dir is at 0x000 */ #ç›®å½•é¡µä»0x00å¼€å§‹ cld;rep;stosl # è®¾ç½®é¡µç›®å½•è¡¨ä¸­çš„é¡¹ï¼Œå†…æ ¸ä¸­æœ‰4ä¸ªé¡µè¡¨éœ€è¦è®¾ç½®4é¡¹ movl $pg0+7,_pg_dir\t/* set present bit/user r/w */# pg0+7ï¼š0x000010007,é¡µç›®å½•è¡¨ä¸­çš„ç¬¬ä¸€é¡¹ movl $pg1+7,_pg_dir+4\t/* --------- \" \" --------- */ movl $pg2+7,_pg_dir+8\t/* --------- \" \" --------- */ movl $pg3+7,_pg_dir+12\t/* --------- \" \" --------- */ # å¡«å†™4ä¸ªé¡µè¡¨ä¸­æ‰€æœ‰å†…å®¹ï¼š4(é¡µè¡¨)*1024(é¡¹)=4096(é¡¹) movl $pg3+4092,%edi movl $0xfff007,%eax\t/* 16Mb - 4096 + 7 (r/w user,p) */ std 1:\tstosl\t/* fill pages backwards - more efficient :-) */ subl $0x1000,%eax jge 1b # è®¾ç½®é¡µç›®å½•è¡¨åŸºå€å¯„å­˜å™¨CR3çš„å€¼(ä¿å­˜çš„é¡µç›®å½•è¡¨çš„ç‰©ç†åœ°å€)ï¼ŒæŒ‡å‘é¡µç›®å½•è¡¨ï¼Œ xorl %eax,%eax\t/* pg_dir is at 0x0000 */ movl %eax,%cr3\t/* cr3 - page directory start */ movl %cr0,%eax # è®¾ç½®å¯ç”¨åˆ†é¡µå¤„ç†ï¼Œ(cr0çš„æ ‡å¿—PG,ä½31) orl $0x80000000,%eax movl %eax,%cr0\t/* set paging (PG) bit */ ret\t/* this also flushes prefetch-queue */ # åœ¨æ”¹å˜åˆ†é¡µå¤„ç†æ ‡å¿—åè¦æ±‚ä½¿ç”¨è½¬ç§»æŒ‡ä»¤åˆ·æ–°é¢„å–æŒ‡ä»¤é˜Ÿåˆ—ï¼Œè¿™é‡Œç”¨çš„æ˜¯è¿”å›æŒ‡ä»¤ret # è¿”å›æŒ‡ä»¤çš„ä½œç”¨å°†mainç¨‹åºå‹å…¥æ ˆä¸­çš„åœ°å€å¼¹å‡ºï¼Œå¹¶è½¬åˆ°init/main.cå»è¿è¡Œ .align 2 .word 0 # åŠ è½½ä¸­æ–­æè¿°ç¬¦è¡¨å¯„å­˜å™¨idtrçš„lidtæŒ‡ä»¤ idt_descr: .word 256*8-1\t# idt contains 256 entries .long _idt .align 2 .word 0 # åŠ è½½å…¨å±€æè¿°ç¬¦è¡¨å¯„å­˜å™¨gdtrçš„lgdtæŒ‡ä»¤ gdt_descr: .word 256*8-1\t# so does gdt (not that that's any .long _gdt\t# magic number, but it works for me :^) .align 3 _idt:\t.fill 256,8,0\t# idt is uninitialized # å…¨å±€è¡¨ï¼Œå‰4é¡¹æ˜¯ç©ºé¡¹ï¼Œä»£ç æ®µæè¿°ç¬¦ï¼Œæ•°æ®æ®µæè¿°ç¬¦ï¼Œç³»ç»Ÿè°ƒç”¨æ®µæè¿°ç¬¦ _gdt:\t.quad 0x0000000000000000\t/* NULL descriptor */ .quad 0x00c09a0000000fff\t/* 16Mb */ .quad 0x00c0920000000fff\t/* 16Mb */ .quad 0x0000000000000000\t/* TEMPORARY - don't use */ .fill 252,8,0\t/* space for LDT's and TSS's etc */ åˆå§‹åŒ–ç¨‹åºâ€”main(1) (1)å°ç»“ 1.bootsect.sç¨‹åºçš„ä¸»è¦åŠŸèƒ½ï¼šå°†setup.så’Œsystemæ¨¡å—åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¹¶ä¸”å°†è‡ªèº«ç§»åŠ¨åˆ°0x90000å¤„ï¼Œç„¶åæ§åˆ¶æƒäº¤ç»™setup.sç¨‹åº\n2.setupç¨‹åºï¼šåˆ©ç”¨BIOSè·å–ç¡¬ä»¶å‚æ•°å¹¶ä¿å­˜ï¼ˆmain.cä¼šç”¨åˆ°çš„ï¼‰ï¼›å°†systemç§»åŠ¨åˆ°0x00000ï¼›æè¿°ç¬¦è¡¨å¯„å­˜å™¨è®¾ç½®ï¼›ç¡¬ä»¶ä¸­æ–­è®¾ç½®ï¼›è®¾ç½®CR0è¿›å…¥32ä½ä¿æŠ¤æ¨¡å¼ï¼Œæ§åˆ¶æƒäº¤ç»™head.s\n3.head.sç¨‹åºï¼šåˆæ­¥åˆå§‹åŒ–ä¸­æ–­æè¿°ç¬¦è¡¨é¡¹ï¼ˆå“‘ä¸­æ–­ï¼‰ï¼›æ£€æŸ¥A20ï¼›æµ‹è¯•æ˜¯å¦æœ‰åå¤„ç†å™¨ï¼›åˆå§‹åŒ–å†…å­˜é¡µç›®å½•è¡¨ï¼›è·³è½¬åˆ°main.cæ‰§è¡Œå†…æ ¸åˆå§‹åŒ–\n(2)åŠŸèƒ½æè¿° ç³»ç»Ÿæ‰§è¡Œå®Œboot/head.sç¨‹åºå°±ä¼šå°†æ‰§è¡Œæƒäº¤ç»™main.c\nmain.cé¦–å…ˆåˆ©ç”¨setup.så–å¾—çš„ç³»ç»Ÿå‚æ•°è®¾ç½®ç³»ç»Ÿçš„æ ¹æ–‡ä»¶è®¾å¤‡å·ä»¥åŠä¸€äº›å†…å­˜å…¨å±€å˜é‡ï¼Œè¿™äº›å˜é‡æŒ‡æ˜äº†ä¸»å†…å­˜çš„å¼€å§‹åœ°å€ï¼Œç³»ç»Ÿæ‰€æ‹¥æœ‰çš„å†…å­˜å®¹é‡å’Œä½œä¸ºé«˜é€Ÿç¼“å­˜åŒºçš„æœ«ç«¯åœ°å€ã€‚è‹¥å®šä¹‰äº†è™šæ‹Ÿç›˜ï¼Œåˆ™ä¸»å†…å­˜å°†é€‚å½“å‡å°‘\nå¦‚åŒç³»ç»ŸåŠŸèƒ½\né«˜é€Ÿç¼“å†²åŒºè¿˜è¦æ‰£é™¤è¢«æ˜¾å­˜å’ŒROM BIOSå ç”¨çš„éƒ¨åˆ†ã€‚\né«˜é€Ÿç¼“å­˜åŒºæ˜¯ç”¨äºç£ç›˜ç­‰å—è®¾å¤‡ä¸´æ—¶å­˜æ”¾æ•°æ®çš„åœ°æ–¹ï¼Œä»¥1kå­—èŠ‚ä¸ºæ•°æ®å—å•ä½ã€‚\nä¸»å†…å­˜åŒºçš„å†…å­˜ç”±å†…å­˜ç®¡ç†æ¨¡å—mmé€šè¿‡åˆ†é¡µæœºåˆ¶è¿›è¡Œç®¡ç†åˆ†é…ï¼Œä»¥4kå­—èŠ‚ä¸ºä¸€ä¸ªå†…å­˜é¡µå•ä½\nå†…æ ¸ç¨‹åºå¯ä»¥è‡ªç”±è®¿é—®é«˜é€Ÿç¼“å†²åŒºçš„æ•°æ®ï¼Œä½†éœ€è¦é€šè¿‡mmæ‰èƒ½ä½¿ç”¨åˆ†é…åˆ°çš„å†…å­˜é¡µé¢\nå†…æ ¸è¿›è¡Œæ‰€æœ‰çš„æ–¹é¢çš„ç¡¬ä»¶åˆå§‹åŒ–å·¥ä½œã€‚åŒ…æ‹¬é™·é˜±é—¨ï¼Œå—è®¾å¤‡ï¼Œå­—ç¬¦è®¾å¤‡ï¼Œttyï¼Œè¿˜åŒ…æ‹¬äººå·¥è®¾ç½®çš„ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼ˆtask 0).\næ‰€æœ‰çš„åˆå§‹åŒ–å·¥ä½œå®Œæˆåç¨‹åºå°±è®¾ç½®ä¸­æ–­å…è®¸æ ‡å¿—ä»¥å¼€å¯ä¸­æ–­ï¼Œå¹¶åˆ‡æ¢åˆ°ä»»åŠ¡0ä¸­å…è®¸ã€‚\nåœ¨æ•´ä¸ªå†…æ ¸åˆå§‹åŒ–å®Œæˆåï¼Œå†…æ ¸å°†æ‰§è¡Œæƒåˆ‡æ¢åˆ°ç”¨æˆ·æ¨¡å¼ï¼ˆä»»åŠ¡0ï¼‰ï¼Œ\nCPUä»0ç‰¹æƒçº§åˆ‡æ¢åˆ°äº†ç¬¬3ä¸ªç‰¹æƒçº§ï¼Œç„¶åæ­¤æ—¶mainå‡½æ•°å·¥ä½œå°±åœ¨ä»»åŠ¡0ä¸­ï¼Œæœ€åç³»ç»Ÿç¬¬ä¸€æ¬¡è°ƒç”¨è¿›ç¨‹åˆ›å»ºå‡½æ•°fork()ï¼Œåˆ›å»ºå‡ºä¸€ä¸ªç”¨äºè¿è¡Œinit() çš„å­è¿›ç¨‹ï¼ˆinitè¿›ç¨‹ï¼‰\nå†…æ ¸åˆå§‹åŒ–æµç¨‹\n1.main.cç¨‹åºé¦–å…ˆç¡®å®šå¦‚ä½•åˆ†é…ä½¿ç”¨ç³»ç»Ÿç‰©ç†å†…å­˜ï¼Œç„¶åè°ƒç”¨å†…æ ¸å„éƒ¨åˆ†çš„åˆå§‹åŒ–å‡½æ•°åˆ†åˆ«å¯¹å†…å­˜ç®¡ç†ã€ä¸­æ–­å¤„ç†ã€å—è®¾å¤‡å’Œå­—ç¬¦è®¾å¤‡ã€è¿›ç¨‹ç®¡ç†ä»¥åŠç¡¬ç›˜å’Œè½¯ç›˜ç¡¬ä»¶è¿›è¡Œåˆå§‹åŒ–å¤„ç†ã€‚åœ¨å®Œæˆäº†è¿™äº›æ“ä½œä¹‹åï¼Œç³»ç»Ÿå„éƒ¨åˆ†å·²ç»å¤„äºå¯è¿è¡ŒçŠ¶æ€ã€‚æ­¤åç¨‹åºæŠŠè‡ªå·±â€œæ‰‹å·¥â€ç§»åŠ¨åˆ°ä»»åŠ¡0ï¼ˆè¿›ç¨‹0ï¼‰ä¸­è¿è¡Œï¼Œå¹¶ä½¿ç”¨fork/è°ƒç”¨é¦–æ¬¡åˆ›å»ºå‡ºè¿›ç¨‹1ï¼ˆintiè¿›ç¨‹ï¼‰ï¼Œå¹¶åœ¨å…¶ä¸­è°ƒç”¨min()å‡½æ•°ã€‚åœ¨è¯¥å‡½æ•°ä¸­ç¨‹åºå°†ç»§ç»­è¿›è¡Œåº”ç”¨ç¯å¢ƒçš„åˆå§‹åŒ–å¹¶æ‰§è¡Œshellç™»å½•ç¨‹åºã€‚è€ŒåŸè¿›ç¨‹0åˆ™ä¼šåœ¨ç³»ç»Ÿç©ºé—²æ—¶è¢«è°ƒåº¦æ‰§è¡Œï¼Œå› æ­¤è¿›ç¨‹0é€šå¸¸ä¹Ÿè¢«ç§°ä¸ºidleè¿›ç¨‹ã€‚æ­¤æ—¶è¿›ç¨‹0ä»…æ‰§è¡Œpause()ç³»ç»Ÿè°ƒç”¨ï¼Œå¹¶åˆä¼šè°ƒç”¨è°ƒåº¦å‡½æ•°ã€‚\n2.init å‡½æ•°çš„åŠŸèƒ½å¯åˆ†ä¸º4ä¸ªéƒ¨åˆ†ï¼š\nâ‘ å®‰è£…æ ¹æ–‡ä»¶ç³»ç»Ÿï¼›\nâ‘¡æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯ï¼›\nâ‘¢è¿è¡Œç³»ç»Ÿåˆå§‹èµ„æºé…ç½®æ–‡ä»¶reä¸­çš„å‘½ä»¤ï¼›\nâ‘£æ‰§è¡Œç”¨æˆ·ç™»å½•shellç¨‹åºã€‚\n3.ä»£ç é¦–å…ˆè°ƒç”¨ç³»ç»Ÿè°ƒç”¨setup()ï¼Œç”¨æ¥æ”¶é›†ç¡¬ç›˜è®¾å¤‡åˆ†åŒºè¡¨ä¿¡æ¯å¹¶å®‰è£…æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚åœ¨å®‰è£…æ ¹æ–‡ä»¶ç³»ç»Ÿä¹‹å‰ï¼Œç³»ç»Ÿä¼šå…ˆåˆ¤æ–­æ˜¯å¦éœ€è¦å…ˆå»ºç«‹è™šæ‹Ÿç›˜ã€‚è‹¥ç¼–è¯‘å†…æ ¸æ—¶è®¾ç½®äº†è™šæ‹Ÿç›˜çš„å¤§å°ï¼Œå¹¶åœ¨å‰é¢å†…æ ¸åˆå§‹åŒ–è¿‡ç¨‹ä¸­å·²ç»å¼€è¾Ÿäº†ä¸€å—å†…å­˜ç”¨ä½œè™šæ‹Ÿç›˜ï¼Œåˆ™å†…æ ¸å°±ä¼šé¦–å…ˆå°è¯•æŠŠæ ¹æ–‡ä»¶ç³»ç»ŸåŠ è½½åˆ°å†…å­˜çš„è™šæ‹Ÿç›˜åŒºä¸­ã€‚\n4.ç„¶åiniiæ‰“å¼€ä¸€ä¸ªç»ˆç«¯è®¾å¤‡tty0ï¼Œå¹¶å¤åˆ¶å…¶æ–‡ä»¶æè¿°ç¬¦ä»¥äº§ç”Ÿæ ‡å‡†è¾“å…¥stdinã€æ ‡å‡†è¾“å‡ºstdoutå’Œé”™è¯¯è¾“å‡ºwaterè®¾å¤‡ã€‚å†…æ ¸éšååˆ©ç”¨è¿™äº›æè¿°ç¬¦åœ¨ç»ˆç«¯ä¸Šæ˜¾ç¤ºä¸€äº›ç³»ç»Ÿä¿¡æ¯ï¼Œä¾‹å¦‚é«˜é€Ÿç¼“å†²åŒºä¸­ç¼“å†²å—æ€»æ•°ã€ä¸»å†…å­˜åŒºç©ºé—²å†…å­˜æ€»å­—èŠ‚æ•°ç­‰ã€‚\n5.æ¥ç€initåˆæ–°å»ºäº†ä¸€ä¸ªè¿›ç¨‹(è¿›ç¨‹2)ï¼Œå¹¶åœ¨å…¶ä¸­ä¸ºå»ºç«‹ç”¨æˆ·äº¤äº’ä½¿ç”¨ç¯å¢ƒè€Œæ‰§è¡Œä¸€äº›åˆå§‹é…ç½®æ“ä½œï¼Œå³åœ¨ç”¨æˆ·å¯ä»¥ä½¿ç”¨shellå‘½ä»¤è¡Œç¯å¢ƒä¹‹å‰ï¼Œå†…æ ¸è°ƒç”¨/bin/shç¨‹åºè¿è¡Œäº†é…ç½®æ–‡ä»¶etcä¸­è®¾ç½®çš„å‘½ä»¤ã€‚æ–‡ä»¶çš„ä½œç”¨ä¸DOSç³»ç»Ÿæ ¹ç›®å½•ä¸Šçš„AUTOEXEC.BATæ–‡ä»¶ç±»ä¼¼ã€‚è¿™æ®µä»£ç é¦–å…ˆé€šè¿‡å…³é—­æ–‡ä»¶æè¿°ç¬¦Dï¼Œå¹¶ç«‹åˆ»æ‰“å¼€æ–‡ä»¶/teé™µrÃ¹ï¼Œä»è€ŒæŠŠæ ‡å‡†è¾“å…¥stdmå®šå‘åˆ°etc/reæ–‡ä»¶ä¸Šã€‚è¿™æ ·ï¼Œæ‰€æœ‰çš„æ ‡å‡†è¾“å…¥æ•°æ®éƒ½å°†ä»è¯¥æ–‡ä»¶ä¸­è¯»å–ã€‚ç„¶åå†…æ ¸ä»¥éäº¤äº’å½¢å¼æ‰§è¡Œ/bin/shï¼Œä»è€Œå®ç°æ‰§è¡Œ/etc.reæ–‡ä»¶ä¸­çš„å‘½ä»¤ã€‚å½“è¯¥æ–‡ä»¶ä¸­çš„å‘½ä»¤æ‰§è¡Œå®Œæ¯•åï¼Œ/bin/shå°±ä¼šç«‹åˆ»é€€å‡ºã€‚å› æ­¤è¿›ç¨‹2ä¹Ÿå°±éšä¹‹ç»“æŸã€‚\n6.initå‡½æ•°çš„æœ€åä¸€éƒ¨ä»½ç”¨äºåœ¨æ–°å»ºè¿›ç¨‹ä¸­ä¸ºç”¨æˆ·å»ºç«‹ä¸€ä¸ªæ–°çš„ä¼šè¯ï¼Œå¹¶è¿è¡Œç”¨æˆ·ç™»å½•shellç¨‹åºï¼Œ/bin/shã€‚åœ¨ç³»ç»Ÿæ‰§è¡Œè¿›ç¨‹2ä¸­çš„ç¨‹åºæ—¶ï¼Œçˆ¶è¿›ç¨‹(mitè¿›ç¨‹)ä¸€ç›´ç­‰å¾…ç€å®ƒçš„ç»“æŸã€‚éšç€è¿›ç¨‹2çš„é€€å‡ºï¼Œçˆ¶è¿›ç¨‹å°±è¿›å…¥åˆ°ä¸€ä¸ªæ— é™å¾ªç¯ä¸­ã€‚åœ¨è¯¥å¾ªç¯ä¸­ï¼Œçˆ¶è¿›ç¨‹ä¼šå†æ¬¡ç”Ÿæˆä¸€ä¸ªæ–°è¿›ç¨‹ï¼Œç„¶ååœ¨è¯¥è¿›ç¨‹ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ä¼šè¯ï¼Œå¹¶ä»¥ç™»å½•shellæ–¹å¼å†æ¬¡æ‰§è¡Œç¨‹åº/bin/shï¼Œä»¥åˆ›å»ºç”¨æˆ·äº¤äº’shellç¯å¢ƒã€‚ç„¶åçˆ¶è¿›ç¨‹ç»§ç»­ç­‰å¾…è¯¥å­è¿›ç¨‹ã€‚ç™»å½•shellè™½ç„¶ä¸å‰é¢çš„éäº¤äº’å¼shellæ˜¯åŒä¸€ä¸ªç¨‹åº/bin/shï¼Œä½†æ˜¯æ‰€ä½¿ç”¨çš„å‘½ä»¤è¡Œå‚æ•°( argV[ ])ä¸åŒã€‚ç™»å½•shellçš„ç¬¬0ä¸ªå‘½ä»¤è¡Œå‚æ•°çš„ç¬¬1ä¸ªå­—ç¬¦ä¸€å®šæ˜¯ä¸€ä¸ªå‡å·æ¯”ã€‚è¿™ä¸ªç‰¹å®šçš„æ ‡å¿—ä¼šåœ¨/bin/shæ‰§è¡Œæ—¶é€šçŸ¥å®ƒè¿™ä¸æ˜¯ä¸€æ¬¡æ™®é€šçš„è¿è¡Œï¼Œè€Œæ˜¯ä½œä¸ºç™»å½•shellè¿è¡Œbin/shçš„ã€‚ä»è¿™æ—¶å¼€å§‹ï¼Œç”¨æˆ·å°±å¯ä»¥æ­£å¸¸ä½¿ç”¨Linuxå‘½ä»¤è¡Œç¯å¢ƒäº†ï¼Œè€Œçˆ¶è¿›ç¨‹éšä¹‹åˆè¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚æ­¤åè‹¥ç”¨æˆ·åœ¨å‘½ä»¤è¡Œä¸Šæ‰§è¡Œäº†exitæˆ–Ilogountå‘½ä»¤ï¼Œé‚£ä¹ˆåœ¨æ˜¾ç¤ºä¸€æ¡å½“å‰ç™»å½•shellé€€å‡ºçš„ä¿¡æ¯åï¼Œç³»ç»Ÿå°±ä¼šåœ¨è¿™ä¸ªæ— é™å¾ªç¯ä¸­å†æ¬¡é‡å¤ä»¥ä¸Šåˆ›å»ºç™»å½•shellè¿›ç¨‹çš„è¿‡ç¨‹ã€‚\n7.ä»»åŠ¡1ä¸­è¿è¡Œçš„init()å‡½æ•°çš„åä¸¤éƒ¨åˆ†å®é™…ä¸Šåº”è¯¥æ˜¯ç‹¬ç«‹çš„ç¯å¢ƒåˆå§‹åŒ–ç¨‹åºmitç­‰çš„åŠŸèƒ½ã€‚\n3.å†…è”å‡½æ•°\nç”±äºåˆ›å»ºæ–°è¿›ç¨‹æ˜¯é€šè¿‡å®Œå…¨å¤åˆ¶çˆ¶è¿›ç¨‹çš„ä»£ç æ®µå’Œæ•°æ®æ®µï¼Œå› æ­¤åœ¨é¦–æ¬¡ä½¿ç”¨fork()åˆ›å»ºè¿›ç¨‹çš„æ—¶å€™ï¼Œä¸ºäº†ç¡®ä¿æ–°è¿›ç¨‹ ç”¨æˆ·æ€æ ˆä¸­æ²¡æœ‰è¿›ç¨‹0çš„å¤šä½™ä¿¡æ¯ï¼Œè¦æ±‚è¿›ç¨‹0åœ¨åˆ›å»ºé¦–ä¸ªæ–°è¿›ç¨‹(è¿›ç¨‹1)ä¹‹å‰ï¼Œä¸è¦ä½¿ç”¨å…¶ç”¨æˆ·æ€æ ˆï¼Œå³è¦æ±‚ä»»åŠ¡0ä¸è¦è°ƒç”¨å‡½æ•°ã€‚\næ‰€ä»¥åœ¨mainç¨‹åºç§»åŠ¨åˆ°ä»»åŠ¡0æ‰§è¡Œåï¼Œä»»åŠ¡0ä¸­çš„ä»£ç fork()ä¸èƒ½ä»¥å‡½æ•°å½¢å¼è¿›è¡Œè°ƒç”¨ï¼Œä»è€Œå¼•å…¥äº†gccå‡½æ•°å†…åµŒå½¢å¼æ¥æ‰§è¡Œè¿™ä¸ªç³»ç»Ÿè°ƒç”¨ã€‚\nstatic inline _syscall0(int ,fork) â€”\u003eå†…è”å‡½æ•° é€šè¿‡å£°æ˜ä¸€ä¸ªå†…è”å‡½æ•°ï¼Œå¯ä»¥è®©gccæŠŠå‡½æ•°çš„ä»£ç é›†æˆè°ƒç”¨åˆ°å®ƒçš„ä»£ç ä¸­ çœå»å‡½æ•°è°ƒç”¨çš„å†…å­˜ï¼Œæé«˜ä»£ç æ‰§è¡Œé€Ÿåº¦ æ³¨;è¿™é‡Œçš„0è¡¨ç¤ºåé¢ä¸ºå‚æ•°ï¼Œè‹¥æœ‰ä¸€ä¸ªå‚æ•°åˆ™æ˜¯_syscall1\n-syscall0()æ˜¯unistd.hä¸­å†…åµŒå®ä»£ç ï¼Œä»¥åµŒå…¥å¼æ±‡ç¼–å½¢å¼è°ƒç”¨Linuxçš„ç³»ç»Ÿè°ƒç”¨ä¸­æ–­ int 0x80ï¼Œä¹Ÿå³æ˜¯int fork()åˆ›å»ºè¿›ç¨‹ç³»ç»Ÿè°ƒç”¨\ngccè¯­æ³•æ–‡ç« è¯¦æƒ…ï¼š\næ·»åŠ é“¾æ¥æè¿°\n1 2 3 4 5 6 7 8 9 10 11 12 #define _syscall0(type,name) type name(void) { long __res; // å£°æ˜ä¸€ä¸ªå¯„å­˜å™¨ __asm__ volatile (\"int $0x80\" //è°ƒç”¨ç³»ç»Ÿä¸­æ–­ 0x80 : \"=a\" (__res) //å°†è¿”å›å€¼--\u003eeax(_res) è¾“å‡ºå¯„å­˜å™¨ : \"0\" (__NR_##name)); //è¾“å…¥ä¸ºç³»ç»Ÿä¸­æ–­è°ƒç”¨å·_NR_name è¾“å…¥å¯„å­˜å™¨ if (__res \u003e= 0) return (type) __res; errno = -__res; return -1; } (4)CMOS PCæœºçš„CMOSå†…å­˜å¤§å°ä¸º128æˆ–è€…64å­—èŠ‚å†…å­˜å—ï¼Œæ˜¯ç³»ç»Ÿå®æ—¶æ—¶é’ŸèŠ¯ç‰‡RTCçš„ä¸€éƒ¨åˆ†ï¼Œä¿å­˜æ—¶é—´å’Œæ—¥æœŸä¿¡æ¯ï¼Œå­˜æ”¾çš„æ ¼å¼æ˜¯BCDç \nè¦è®¿é—®CMOSéœ€è¦é€šè¿‡ç«¯å£0x70(åœ°å€ç«¯å£)ï¼Œ0x71(æ•°æ®ç«¯å£)\nCMOS64å­—èŠ‚ä¿¡æ¯ï¼š\nåˆå§‹åŒ–ç¨‹åºâ€”main(2) ä¸€ã€æºç åˆ†æ ç³»ç»Ÿåˆå§‹åŒ–ç¨‹åºinit/main.cä¸»è¦åŠŸèƒ½æ˜¯å¯¹ç³»ç»Ÿè¿›è¡Œåˆå§‹åŒ–ï¼Œå¹¶åˆ‡æ¢åˆ°ç”¨æˆ·æ¨¡å¼ä¸‹æ‰§è¡Œç™»å½•ç¨‹åº\n(1)åº“æ–‡ä»¶ä»‹ç»\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 // å®å®šä¹‰__LIBRARY__ä¸ºäº†åŒ…æ‹¬åœ¨unistd.hä¸­å†…åµŒæ±‡ç¼–ä»£ç  #define __LIBRARY__ // *.hæ‰€åœ¨å¤´æ–‡ä»¶é»˜è®¤ç›®å½•åœ¨include/ // unistd.hæ˜¯æ ‡å‡†ç¬¦å·å¸¸æ•°ä¸ç±»å‹æ–‡ä»¶ï¼Œå®šä¹‰äº†å„ç§ç¬¦å·å¸¸æ•°å’Œç±»å‹ï¼Œå¹¶å£°æ˜äº†å„ç§å‡½æ•° // è‹¥å®šä¹‰äº†_LIBRARY_,åˆ™è¿˜ä¼šåŒ…å«ç³»ç»Ÿè°ƒç”¨å·å’Œå†…åµŒæ±‡ç¼–ä»£ç å¦‚syscall0 #include // æ—¶é—´ç±»å‹å¤´æ–‡ä»¶ï¼Œå®šä¹‰äº†tmç»“æ„å’Œå…³äºæ—¶é—´çš„å‡½æ•°åŸå‹ #include #include //å®šä¹‰äº†tty_io,ä¸²å£é€šä¿¡æ–¹é¢çš„å‚æ•°ï¼Œå¸¸æ•° #include //è°ƒåº¦ï¼Œå®šä¹‰äº†ä»»åŠ¡ç»“æ„ä½“task_struct,ç¬¬ä¸€ä¸ªåˆå§‹ä»»åŠ¡çš„æ•°æ® #include //å®šä¹‰äº†æ®µæè¿°ç¬¦çš„ç®€å•ç»“æ„å’Œå‡ ä¸ªé€‰æ‹©ç¬¦å¸¸é‡ #include //ä»¥å®çš„å½¢å¼å®šä¹‰äº†æœ‰å…³æè¿°ç¬¦å‚æ•°è®¾ç½®æˆ–ä¿®æ”¹æè¿°ç¬¦ï¼Œä¸­æ–­é—¨ç­‰æ±‡ç¼–ç¨‹åº #include //ä»¥åµŒå…¥å¼æ±‡ç¼–ç¨‹åºå½¢å¼å®šä¹‰äº†å¯¹ioç«¯æ“ä½œçš„å‡½æ•° #include //æ ‡å‡†å®šä¹‰å¤´æ–‡ä»¶ï¼Œå®šä¹‰äº†NULL,TYPE,MEMBER #include //æ ‡å¿—å‚æ•°å¤´æ–‡ä»¶ï¼Œä»¥å®çš„å½¢å¼å®šä¹‰äº†å˜é‡å‚æ•°åˆ—è¡¨ //ä¸€ä¸ªç±»å‹ï¼šva_list,ä¸‰ä¸ªå®ï¼šva_start,va_arg,va_end //vsprintf,vprintf,vfprintf #include //æ ‡å‡†ç¬¦å·å¸¸æ•°ä¸ç±»å‹æ–‡ä»¶ï¼Œå®šä¹‰äº†å„ç§ç¬¦å·å¸¸æ•°å’Œç±»å‹ï¼Œå¹¶å£°æ˜äº†å„ç§å‡½æ•° #include //æ–‡ä»¶æ§åˆ¶å¤´æ–‡ä»¶ï¼Œç”¨äºæ–‡ä»¶åŠå…¶æè¿°ç¬¦çš„æ“ä½œæ§åˆ¶å¸¸æ•°ç¬¦å·çš„å®šä¹‰\t#include //ç±»å‹å¤´æ–‡ä»¶ï¼Œå®šä¹‰äº†åŸºæœ¬çš„ç³»ç»Ÿæ•°æ®ç±»å‹ #include //æ–‡ä»¶ç³»ç»Ÿå¤´æ–‡ä»¶ï¼Œå®šä¹‰äº†æ–‡ä»¶è¡¨ç»“æ„(file,buffer_head,m_inode) (2)CMOSè¯»å–æ—¶é—´\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 //è¯»å–CMOSå®æ—¶æ—¶é’Ÿä¿¡æ¯ //outb_pç«¯å£è¾“å‡ºå®å®šä¹‰ï¼Œinb_pç«¯å£è¾“å…¥å®å®šä¹‰ //0x70æ˜¯å†™åœ°å€ç«¯å£å· 0x80|addræ˜¯è¦è¯»å–CMOSå†…å­˜åœ°å€ï¼Œ0x71æ˜¯åº¦æ•°æ®ç«¯å£å· #define CMOS_READ(addr) ({ outb_p(0x80|addr,0x70); inb_p(0x71); }) //å°†BCDç è½¬åŒ–ä¸ºäºŒè¿›åˆ¶æ•°å€¼ //(val)\u002615å–BCDç ç¬¬å››ä½ä¹Ÿå°±æ˜¯ä¸ªä½ï¼Œval)\u003e\u003e4å³ç§»å››ä½åªå‰©é«˜å››ä½ä¹Ÿå°±æ˜¯åä½ #define BCD_TO_BIN(val) ((val)=((val)\u002615) + ((val)\u003e\u003e4)*10) //è¯¥å‡½æ•°å–CMOSå®æ—¶ä¸­ä¿¡æ¯ä½œä¸ºå¼€æœºæ—¶é—´ï¼Œå¹¶ä¿å­˜åˆ°å…¨å±€å˜é‡startup_time static void time_init(void) { struct tm time; //æ—¶é—´ç»“æ„ä½“ do { //ä»CMOSå†…å­˜åˆ—è¡¨ä¸­è¯»å–æ—¶é—´ time.tm_sec = CMOS_READ(0); //ç§’å€¼(BCDç å½¢å¼) time.tm_min = CMOS_READ(2); time.tm_hour = CMOS_READ(4); time.tm_mday = CMOS_READ(7); time.tm_mon = CMOS_READ(8); time.tm_year = CMOS_READ(9); } while (time.tm_sec != CMOS_READ(0)); BCD_TO_BIN(time.tm_sec); //è½¬æ¢ä½2è¿›åˆ¶æ•°å€¼ BCD_TO_BIN(time.tm_min); BCD_TO_BIN(time.tm_hour); BCD_TO_BIN(time.tm_mday); BCD_TO_BIN(time.tm_mon); BCD_TO_BIN(time.tm_year); time.tm_mon--; startup_time = kernel_mktime(\u0026time); //è®¡ç®—å¼€æœºæ—¶é—´ } (3)å†…æ ¸æ‰€æœ‰åˆå§‹åŒ–\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 //å†…æ ¸è¿›è¡Œæ‰€æœ‰æ–¹é¢çš„åˆå§‹åŒ– mem_init(main_memory_start,memory_end); //ä¸»å†…å­˜åŒºåˆå§‹ trap_init(); //é™·é˜±é—¨(ç¡¬ä»¶ä¸­æ–­å‘é‡)åˆå§‹åŒ– blk_dev_init(); //å—è®¾å¤‡åˆå§‹åŒ– chr_dev_init(); //å­—ç¬¦è®¾å¤‡åˆå§‹åŒ– tty_init(); //ttyåˆå§‹åŒ– time_init(); //è®¾ç½®å¼€æœºå¯åŠ¨æ—¶é—´ sched_init(); //è°ƒåº¦ç¨‹åºåˆå§‹åŒ–(åŠ è½½ä»»åŠ¡0çš„tr,ldtr) buffer_init(buffer_memory_end); //ç¼“å†²ç®¡ç†åˆå§‹åŒ–ï¼Œå»ºå†…å­˜é“¾è¡¨ hd_init(); //ç¡¬ç›˜åˆå§‹åŒ– floppy_init(); //è½¯ç›˜åˆå§‹åŒ– sti(); //æ‰€æœ‰åˆå§‹åŒ–å®Œæˆï¼Œå¼€å¯ä¸­æ–­ //ä¸‹é¢è¿‡ç¨‹é€šè¿‡åœ¨å †æ ˆä¸­è®¾ç½®çš„å‚æ•°ï¼Œåˆ©ç”¨ä¸­æ–­è¿”å›æŒ‡ä»¤å¯åŠ¨ä»»åŠ¡0æ‰§è¡Œ move_to_user_mode(); //åˆ‡æ¢åˆ°ç”¨æˆ·æ¨¡å¼ (4)åˆ‡æ¢åˆ°ç”¨æˆ·æ¨¡å¼\n1 2 3 4 5 //ä¸‹é¢è¿‡ç¨‹é€šè¿‡åœ¨å †æ ˆä¸­è®¾ç½®çš„å‚æ•°ï¼Œåˆ©ç”¨ä¸­æ–­è¿”å›æŒ‡ä»¤å¯åŠ¨ä»»åŠ¡0æ‰§è¡Œ move_to_user_mode(); //åˆ‡æ¢åˆ°ç”¨æˆ·æ¨¡å¼ if (!fork()) {\t/* we count on this going ok */ init(); //åœ¨æ–°å»ºçš„å­è¿›ç¨‹ä¸­è¿è¡Œ } äºŒã€å®Œæ•´æºç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 /* * linux/init/main.c * * (C) 1991 Linus Torvalds */ // å®å®šä¹‰__LIBRARY__ä¸ºäº†åŒ…æ‹¬åœ¨unistd.hä¸­å†…åµŒæ±‡ç¼–ä»£ç  #define __LIBRARY__ // *.hæ‰€åœ¨å¤´æ–‡ä»¶é»˜è®¤ç›®å½•åœ¨include/ // unistd.hæ˜¯æ ‡å‡†ç¬¦å·å¸¸æ•°ä¸ç±»å‹æ–‡ä»¶ï¼Œå®šä¹‰äº†å„ç§ç¬¦å·å¸¸æ•°å’Œç±»å‹ï¼Œå¹¶å£°æ˜äº†å„ç§å‡½æ•° // è‹¥å®šä¹‰äº†_LIBRARY_,åˆ™è¿˜ä¼šåŒ…å«ç³»ç»Ÿè°ƒç”¨å·å’Œå†…åµŒæ±‡ç¼–ä»£ç å¦‚syscall0 #include // æ—¶é—´ç±»å‹å¤´æ–‡ä»¶ï¼Œå®šä¹‰äº†tmç»“æ„å’Œå…³äºæ—¶é—´çš„å‡½æ•°åŸå‹ #include /* * we need this inline - forking from kernel space will result * in NO COPY ON WRITE (!!!), until an execve is executed. This * is no problem, but for the stack. This is handled by not letting * main() use the stack at all after fork(). Thus, no function * calls - which means inline code for fork too, as otherwise we * would use the stack upon exit from 'fork()'. * * Actually only pause and fork are needed inline, so that there * won't be any messing with the stack from main(), but we define * some others too. */ /* åœ¨å†…æ ¸ç©ºé—´åˆ›å»ºè¿›ç¨‹å°†ä¼šå¯¼è‡´æ²¡æœ‰å†™æ—¶å¤åˆ¶ï¼Œ ä¸ºäº†ä¿è¯ä¸ä½¿ç”¨ä»»åŠ¡0çš„ç”¨æˆ·æ ˆï¼š mainåœ¨ç§»åŠ¨åˆ°ç”¨æˆ·æ¨¡å¼(åˆ°ä»»åŠ¡0)åæ‰§è¡Œå†…åµŒæ–¹å¼çš„fork()å’Œpause() åœ¨æ‰§è¡Œmove_to_user_mode()åï¼Œmainå°±ä»¥ä»»åŠ¡0çš„æ–¹å¼è¿è¡Œ ä»»åŠ¡0æ˜¯æ‰€æœ‰å­è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ å½“å®ƒåˆ›å»ºå­è¿›ç¨‹æ—¶ï¼Œç”±äºä»»åŠ¡1å±äºå†…æ ¸ç©ºé—´ï¼Œæ— å†™æ—¶å¤åˆ¶ ä»»åŠ¡0çš„ç”¨æˆ·ç©ºæ ˆå°±æ˜¯ä»»åŠ¡1çš„ç”¨æˆ·æ ˆï¼Œå³ä»–ä»¬å…±ç”¨ä¸€ä¸ªæ ˆç©ºé—´ å› æ­¤åœ¨è¿è¡Œä»»åŠ¡0æ—¶ä¸è¦å¯¹å †æ ˆæœ‰ä»»ä½•çš„æ“ä½œ ä½†åœ¨å†æ¬¡æ‰§è¡Œfork()å¹¶æ‰§è¡Œè¿‡execve()å,è¢«åŠ è½½çš„ç¨‹åºä¹Ÿä¸å±äºå†…æ ¸ç©ºé—´ */ // å®šä¹‰å†…è”å‡½æ•° static inline _syscall0(int,fork) // å®é™…ä¸Šæ˜¯ int fork()åˆ›å»ºè¿›ç¨‹ç³»ç»Ÿè°ƒç”¨ static inline _syscall0(int,pause) //int pause()ç³»ç»Ÿè°ƒç”¨ ï¼šæš‚åœè¿›ç¨‹çš„æ‰§è¡Œï¼Œç›´åˆ°æ”¶åˆ°ä¸€ä¸ªä¿¡æ¯ static inline _syscall1(int,setup,void *,BIOS) // int setup(void *,BIOS)ç³»ç»Ÿè°ƒç”¨ ç”¨äºlinuxåˆå§‹åŒ– static inline _syscall0(int,sync) // int sync()ç³»ç»Ÿè°ƒç”¨ï¼šæ›´æ–°æ–‡ä»¶ç³»ç»Ÿ #include //å®šä¹‰äº†tty_io,ä¸²å£é€šä¿¡æ–¹é¢çš„å‚æ•°ï¼Œå¸¸æ•° #include //è°ƒåº¦ï¼Œå®šä¹‰äº†ä»»åŠ¡ç»“æ„ä½“task_struct,ç¬¬ä¸€ä¸ªåˆå§‹ä»»åŠ¡çš„æ•°æ® #include //å®šä¹‰äº†æ®µæè¿°ç¬¦çš„ç®€å•ç»“æ„å’Œå‡ ä¸ªé€‰æ‹©ç¬¦å¸¸é‡ #include //ä»¥å®çš„å½¢å¼å®šä¹‰äº†æœ‰å…³æè¿°ç¬¦å‚æ•°è®¾ç½®æˆ–ä¿®æ”¹æè¿°ç¬¦ï¼Œä¸­æ–­é—¨ç­‰æ±‡ç¼–ç¨‹åº #include //ä»¥åµŒå…¥å¼æ±‡ç¼–ç¨‹åºå½¢å¼å®šä¹‰äº†å¯¹ioç«¯æ“ä½œçš„å‡½æ•° #include //æ ‡å‡†å®šä¹‰å¤´æ–‡ä»¶ï¼Œå®šä¹‰äº†NULL,TYPE,MEMBER #include //æ ‡å¿—å‚æ•°å¤´æ–‡ä»¶ï¼Œä»¥å®çš„å½¢å¼å®šä¹‰äº†å˜é‡å‚æ•°åˆ—è¡¨ //ä¸€ä¸ªç±»å‹ï¼šva_list,ä¸‰ä¸ªå®ï¼šva_start,va_arg,va_end //vsprintf,vprintf,vfprintf #include //æ ‡å‡†ç¬¦å·å¸¸æ•°ä¸ç±»å‹æ–‡ä»¶ï¼Œå®šä¹‰äº†å„ç§ç¬¦å·å¸¸æ•°å’Œç±»å‹ï¼Œå¹¶å£°æ˜äº†å„ç§å‡½æ•° #include //æ–‡ä»¶æ§åˆ¶å¤´æ–‡ä»¶ï¼Œç”¨äºæ–‡ä»¶åŠå…¶æè¿°ç¬¦çš„æ“ä½œæ§åˆ¶å¸¸æ•°ç¬¦å·çš„å®šä¹‰\t#include //ç±»å‹å¤´æ–‡ä»¶ï¼Œå®šä¹‰äº†åŸºæœ¬çš„ç³»ç»Ÿæ•°æ®ç±»å‹ #include //æ–‡ä»¶ç³»ç»Ÿå¤´æ–‡ä»¶ï¼Œå®šä¹‰äº†æ–‡ä»¶è¡¨ç»“æ„(file,buffer_head,m_inode) static char printbuf[1024]; //é™æ€å­—ç¬¦ä¸²æ•°ç»„ï¼Œç”¨ä½œå†…æ ¸æ˜¾ç¤ºä¿¡æ¯çš„ç¼“å­˜ extern int vsprintf(); //æ ¼å¼åŒ–è¾“å‡ºåˆ°ä¸€å­—ç¬¦ä¸²ä¸­ extern void init(void); //åˆå§‹åŒ– extern void blk_dev_init(void);//å—è®¾å¤‡åˆå§‹åŒ– extern void chr_dev_init(void);//å­—ç¬¦è®¾å¤‡åˆå§‹åŒ– extern void hd_init(void);\t//ç¡¬ç›˜åˆå§‹åŒ– extern void floppy_init(void); //è½¯é©±åˆå§‹åŒ– extern void mem_init(long start, long end); //å†…å­˜ç®¡ç†åˆå§‹åŒ– extern long rd_init(long mem_start, int length); //è™šæ‹Ÿç›˜åˆå§‹åŒ– extern long kernel_mktime(struct tm * tm); //è®¡ç®—ç³»ç»Ÿå¼€æœºå¯åŠ¨æ—¶é—´(s) extern long startup_time; //å†…æ ¸å¯åŠ¨æ—¶é—´(s) /* * This is set up by the setup-routine at boot-time */ //è¿™äº›æ•°æ®åœ¨å†…æ ¸å¼•å¯¼æœŸé—´ç”±setupè®¾ç½® //å°†æŒ‡å®šçš„çº¿æ€§åœ°å€å¼ºè¡Œè½¬æ¢ä¸ºç»™çš„æ•°æ®ç±»å‹çš„æŒ‡é’ˆï¼Œå¹¶è·å–æŒ‡é’ˆæ‰€æŒ‡çš„å†…å®¹ #define EXT_MEM_K (*(unsigned short *)0x90002) //1MBä»¥åçš„æ‰©å±•å†…å®¹å¤§å° #define DRIVE_INFO (*(struct drive_info *)0x90080) //ç¡¬ç›˜å‚æ•°è¡¨çš„32å­—èŠ‚å†…å®¹ #define ORIG_ROOT_DEV (*(unsigned short *)0x901FC) //æ ¹æ–‡ä»¶ç³»ç»Ÿæ‰€åœ¨è®¾å¤‡å· /* * Yeah, yeah, it's ugly, but I cannot find how to do this correctly * and this seems to work. I anybody has more info on the real-time * clock I'd be interested. Most of this was trial and error, and some * bios-listing reading. Urghh. */ //è¯»å–CMOSå®æ—¶æ—¶é’Ÿä¿¡æ¯ //outb_pç«¯å£è¾“å‡ºå®å®šä¹‰ï¼Œinb_pç«¯å£è¾“å…¥å®å®šä¹‰ //0x70æ˜¯å†™åœ°å€ç«¯å£å· 0x80|addræ˜¯è¦è¯»å–CMOSå†…å­˜åœ°å€ï¼Œ0x71æ˜¯åº¦æ•°æ®ç«¯å£å· #define CMOS_READ(addr) ({ outb_p(0x80|addr,0x70); inb_p(0x71); }) //å°†BCDç è½¬åŒ–ä¸ºäºŒè¿›åˆ¶æ•°å€¼ //(val)\u002615å–BCDç ç¬¬å››ä½ä¹Ÿå°±æ˜¯ä¸ªä½ï¼Œval)\u003e\u003e4å³ç§»å››ä½åªå‰©é«˜å››ä½ä¹Ÿå°±æ˜¯åä½ #define BCD_TO_BIN(val) ((val)=((val)\u002615) + ((val)\u003e\u003e4)*10) //è¯¥å‡½æ•°å–CMOSå®æ—¶ä¸­ä¿¡æ¯ä½œä¸ºå¼€æœºæ—¶é—´ï¼Œå¹¶ä¿å­˜åˆ°å…¨å±€å˜é‡startup_time static void time_init(void) { struct tm time; //æ—¶é—´ç»“æ„ä½“ do { //ä»CMOSå†…å­˜åˆ—è¡¨ä¸­è¯»å–æ—¶é—´ time.tm_sec = CMOS_READ(0); //ç§’å€¼(BCDç å½¢å¼) time.tm_min = CMOS_READ(2); time.tm_hour = CMOS_READ(4); time.tm_mday = CMOS_READ(7); time.tm_mon = CMOS_READ(8); time.tm_year = CMOS_READ(9); } while (time.tm_sec != CMOS_READ(0)); BCD_TO_BIN(time.tm_sec); //è½¬æ¢ä½2è¿›åˆ¶æ•°å€¼ BCD_TO_BIN(time.tm_min); BCD_TO_BIN(time.tm_hour); BCD_TO_BIN(time.tm_mday); BCD_TO_BIN(time.tm_mon); BCD_TO_BIN(time.tm_year); time.tm_mon--; startup_time = kernel_mktime(\u0026time); //è®¡ç®—å¼€æœºæ—¶é—´ } static long memory_end = 0; //æœºå™¨å…·æœ‰çš„ç‰©ç†å†…å­˜å®¹é‡ static long buffer_memory_end = 0; //é«˜é€Ÿç¼“å†²åŒºæœ«ç«¯åœ°å€ static long main_memory_start = 0; //ä¸»å†…å­˜(å°†ç”¨äºåˆ†é¡µ)å¼€å§‹çš„ä½ç½® struct drive_info { char dummy[32]; } drive_info; //ç”¨äºå­˜æ”¾ç¡¬ç›˜å‚æ•°è¡¨ä¿¡æ¯ //å†…æ ¸åˆå§‹åŒ–ä¸»ç¨‹åºï¼Œåˆå§‹åŒ–ç»“æŸä»¥åå°†ä»¥ä»»åŠ¡0(idleä»»åŠ¡ä½ç©ºé—²ä»»åŠ¡)çš„èº«ä»½è¿è¡Œ void main(void)\t/* This really IS void, no error here. */ {\t/* The startup routine assumes (well, ...) this */ /* * Interrupts are still disabled. Do necessary setups, then * enable them */ //æ­¤æ—¶ä¸­æ–­è¢«å…³é—­ï¼Œåšå®Œå¿…è¦çš„è®¾ç½®åå°±å°†å…¶å¼€å¯ ROOT_DEV = ORIG_ROOT_DEV; //ä¿å­˜æ ¹è®¾å¤‡å· --\u003eROOT_DEV drive_info = DRIVE_INFO; //ä¿å­˜0x90080ç£ç›˜å‚æ•°è¡¨å†…å®¹ memory_end = (1\u003c\u003c20) + (EXT_MEM_K\u003c\u003c10); //æœºå™¨å†…å­˜æ•°---\u003ememory_end ,å†…å­˜å¤§å°=1MB+æ‰©å±•å†…å­˜(k)*1024å­—èŠ‚ memory_end \u0026= 0xfffff000; //å¿½ç•¥ä¸åˆ°4kb(1é¡µ)çš„å†…å­˜æ•° if (memory_end \u003e 16*1024*1024) //å¤§äº16MB åˆ™ç­‰äº16MB memory_end = 16*1024*1024; if (memory_end \u003e 12*1024*1024) //å†…å­˜\u003e12MB,é«˜é€Ÿç¼“å†²æœ«ç«¯=4mb buffer_memory_end = 4*1024*1024; //é«˜é€Ÿç¼“å†²æœ«ç«¯åœ°å€---\u003ebuffer_memory_end else if (memory_end \u003e 6*1024*1024) //å†…å­˜\u003e6MB,é«˜é€Ÿç¼“å†²æœ«ç«¯=4mb buffer_memory_end = 2*1024*1024; else //å¦åˆ™é«˜é€Ÿç¼“å†²æœ«ç«¯=1mb buffer_memory_end = 1*1024*1024; main_memory_start = buffer_memory_end; //ä¸»å†…å­˜å¼€å§‹åœ°å€=é«˜é€Ÿç¼“å†²æœ«ç«¯ //å¦‚æœåœ¨Makefileä¸­å®šä¹‰äº†å†…å­˜è™šæ‹Ÿç›˜ç¬¦å·RAMDISKï¼Œåˆ™åˆå§‹åŒ–è™šæ‹Ÿç›˜(ä¸»å†…å­˜å‡å°‘) #ifdef RAMDISK main_memory_start += rd_init(main_memory_start, RAMDISK*1024); #endif //å†…æ ¸è¿›è¡Œæ‰€æœ‰æ–¹é¢çš„åˆå§‹åŒ– mem_init(main_memory_start,memory_end); //ä¸»å†…å­˜åŒºåˆå§‹ trap_init(); //é™·é˜±é—¨(ç¡¬ä»¶ä¸­æ–­å‘é‡)åˆå§‹åŒ– blk_dev_init(); //å—è®¾å¤‡åˆå§‹åŒ– chr_dev_init(); //å­—ç¬¦è®¾å¤‡åˆå§‹åŒ– tty_init(); //ttyåˆå§‹åŒ– time_init(); //è®¾ç½®å¼€æœºå¯åŠ¨æ—¶é—´ sched_init(); //è°ƒåº¦ç¨‹åºåˆå§‹åŒ–(åŠ è½½ä»»åŠ¡0çš„tr,ldtr) buffer_init(buffer_memory_end); //ç¼“å†²ç®¡ç†åˆå§‹åŒ–ï¼Œå»ºå†…å­˜é“¾è¡¨ hd_init(); //ç¡¬ç›˜åˆå§‹åŒ– floppy_init(); //è½¯ç›˜åˆå§‹åŒ– sti(); //æ‰€æœ‰åˆå§‹åŒ–å®Œæˆï¼Œå¼€å¯ä¸­æ–­ //ä¸‹é¢è¿‡ç¨‹é€šè¿‡åœ¨å †æ ˆä¸­è®¾ç½®çš„å‚æ•°ï¼Œåˆ©ç”¨ä¸­æ–­è¿”å›æŒ‡ä»¤å¯åŠ¨ä»»åŠ¡0æ‰§è¡Œ move_to_user_mode(); //åˆ‡æ¢åˆ°ç”¨æˆ·æ¨¡å¼ if (!fork()) {\t/* we count on this going ok */ init(); //åœ¨æ–°å»ºçš„å­è¿›ç¨‹ä¸­è¿è¡Œ } /* * NOTE!! For any other task 'pause()' would mean we have to get a * signal to awaken, but task0 is the sole exception (see 'schedule()') * as task 0 gets activated at every idle moment (when no other tasks * can run). For task0 'pause()' just means we go check if some other * task can run, and if not we return here. */ //è¿è¡Œä»»åŠ¡0 //pause()ç³»ç»Ÿè°ƒç”¨ä¼šæŠŠä»»åŠ¡0è½¬æ¢æˆå¯ä¸­æ–­ç­‰å¾…çŠ¶æ€ï¼Œå†æ‰§è¡Œè°ƒåº¦å‡½æ•° //è‹¥è°ƒåº¦å‡½æ•°å‘ç°ç³»ç»Ÿä¸­æ²¡æœ‰æ²¡æœ‰å…¶ä»–ä»»åŠ¡å¯ä»¥è¿è¡Œå°±ä¼šåˆ‡æ¢åˆ°ä»»åŠ¡0ï¼Œè€Œä¸ä¾èµ–ä»»åŠ¡0çš„çŠ¶æ€\tfor(;;) pause(); } //printf()äº§ç”Ÿæ ¼å¼åŒ–ä¿¡æ¯è¾“å‡ºåˆ°æ ‡å‡†è®¾å¤‡stdout(1),åœ¨å±å¹•ä¸Šæ˜¾ç¤º // å‚æ•°fmtï¼šæŒ‡å®šè¾“å‡ºå°†é‡‡ç”¨çš„æ ¼å¼ static int printf(const char *fmt, ...) { va_list args; int i; va_start(args, fmt); write(1,printbuf,i=vsprintf(printbuf, fmt, args)); va_end(args); return i; } //è¯»å–å¹¶æ‰§è¡Œ/etc/rcæ–‡ä»¶æ‰€ä½¿ç”¨çš„å‘½ä»¤è¡Œå‚æ•°å’Œç¯å¢ƒå‚æ•° static char * argv_rc[] = { \"/bin/sh\", NULL }; static char * envp_rc[] = { \"HOME=/\", NULL }; //è¿è¡Œç™»å½•shellæ—¶æ‰€ä½¿ç”¨çš„å‘½ä»¤è¡Œå‚æ•°å’Œç¯å¢ƒå‚æ•° static char * argv[] = { \"-/bin/sh\",NULL }; static char * envp[] = { \"HOME=/usr/root\", NULL }; //åœ¨main()ä¸­è¿›è¡Œäº†ç³»ç»Ÿåˆå§‹åŒ–ï¼ŒåŒ…æ‹¬å†…å­˜ç®¡ç†ï¼Œå„ç§ç¡¬ä»¶è®¾å¤‡å’Œé©±åŠ¨è®¾å¤‡ //è€Œinit()è¿è¡Œåœ¨ä»»åŠ¡0ç¬¬ä¸€æ¬¡åˆ›å»ºçš„å­è¿›ç¨‹ï¼Œå¯¹ç¬¬ä¸€ä¸ªè¦æ‰§è¡Œçš„shellç¨‹åºçš„ç¯å¢ƒè¿›è¡Œåˆå§‹åŒ– //ç„¶åä»¥ç™»å½•shellæ–¹å¼åŠ è½½è¯¥ç¨‹åºå¹¶æ‰§è¡Œ void init(void) { int pid,i; //setup()ç”¨äºè¯»å–ç¡¬ç›˜å‚æ•°åŒ…å«åˆ†åŒºè¡¨ä¿¡æ¯å¹¶åŠ è½½è™šæ‹Ÿä¿¡æ¯å’Œå®‰è£…æ ¹æ–‡ä»¶ç³»ç»Ÿè®¾å¤‡ setup((void *) \u0026drive_info); (void) open(\"/dev/tty0\",O_RDWR,0); //ç»ˆç«¯æ§åˆ¶å° (void) dup(0); (void) dup(0); //æ‰“å°ç¼“å†²åŒºå—æ•°å’Œæ€»å­—èŠ‚æ•°ï¼Œæ¯å—1024å­—èŠ‚ï¼Œä»¥åŠä¸»å†…å­˜åŒºç©ºé—²å†…å­˜å­—èŠ‚æ•° printf(\"%d buffers = %d bytes buffer spacenr\",NR_BUFFERS, NR_BUFFERS*BLOCK_SIZE); printf(\"Free mem: %d bytesnr\",memory_end-main_memory_start); //åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹(ä»»åŠ¡2) --\u003eè¿”å›å€¼ä¸º =0,çˆ¶è¿›ç¨‹--\u003eè¿”å›å€¼ = å­è¿›ç¨‹pid //åˆ›å»ºå¤±è´¥ if (!(pid=fork())) { close(0); if (open(\"/etc/rc\",O_RDONLY,0)) _exit(1); execve(\"/bin/sh\",argv_rc,envp_rc); _exit(2); } //çˆ¶è¿›ç¨‹ if (pid\u003e0) while (pid != wait(\u0026i)) //ç­‰å¾…å­è¿›ç¨‹ç»“æŸã€‚\u0026iå­˜æ”¾è¿”å›çŠ¶æ€ä¿¡æ¯çš„ä½ç½® /* nothing */; //ä¸Šä¸€ä¸ªè¿›ç¨‹ç»“æŸï¼Œä¸‹é¢å¾ªç¯åœ¨åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ while (1) { //åˆ›å»ºå¤±è´¥ if ((pid=fork())\u003c0) { printf(\"Fork failed in initrn\"); continue; } //æ–°çš„å­è¿›ç¨‹ if (!pid) { close(0);close(1);close(2); setsid(); //åˆ›æ–°ä¼šè¯æœŸ (void) open(\"/dev/tty0\",O_RDWR,0); (void) dup(0); (void) dup(0); _exit(execve(\"/bin/sh\",argv,envp)); } while (1) if (pid == wait(\u0026i)) break; printf(\"nrchild %d died with code %04xnr\",pid,i); sync(); //åŒæ­¥æ“ä½œï¼Œåˆ·æ–°ç¼“å†²åŒº } _exit(0);\t/* NOTE! _exit, not exit() */ //_exit() ç»ˆæ­¢ä¸€ä¸ªå‡½æ•°å±äºsys_exitç³»ç»Ÿè°ƒç”¨ //exit() ç»ˆæ­¢ä¸€ä¸ªå‡½æ•°ï¼Œå±äºåº“å‡½æ•°ï¼Œå®ƒä¼šå…ˆæ‰§è¡Œä¸€äº›æ¸…é™¤æ“ä½œï¼Œç„¶åè°ƒç”¨_exit() } ",
  "wordCount" : "27755",
  "inLanguage": "zh",
  "datePublished": "2022-05-14T00:00:00Z",
  "dateModified": "2022-05-14T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "chance7bin"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://chance7bin.github.io/posts/basic/os/%E4%B8%80%E5%86%85%E6%A0%B8%E5%90%AF%E5%8A%A8/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Binb's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://chance7bin.github.io/" accesskey="h" title="Binb&#39;s Blog (Alt + H)">
                <img src="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg" alt="" aria-label="logo"
                    height="35">Binb&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://chance7bin.github.io/search" title="ğŸ”æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ”æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="https://chance7bin.github.io/" title="ğŸ  ä¸»é¡µ">
                    <span>ğŸ  ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://chance7bin.github.io/archives/" title="â±ï¸ æ—¶é—´è½´">
                    <span>â±ï¸ æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://chance7bin.github.io/posts" title="ğŸ“š æ–‡ç« ">
                    <span>ğŸ“š æ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://chance7bin.github.io/tags" title="ğŸ”– æ ‡ç­¾">
                    <span>ğŸ”– æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://github.com/chance7bin" title="GitHub">
                    <span>GitHub</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://chance7bin.github.io/">ğŸ  ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://chance7bin.github.io/posts/">ğŸ“š æ–‡ç« </a>&nbsp;Â»&nbsp;<a href="https://chance7bin.github.io/posts/basic/">ğŸ“• è®¡ç®—æœºåŸºç¡€</a>&nbsp;Â»&nbsp;<a href="https://chance7bin.github.io/posts/basic/os/">æ“ä½œç³»ç»Ÿ</a></div>
    <h1 class="post-title">
      ä¸€ã€å†…æ ¸å¯åŠ¨
    </h1>
    <div class="post-meta">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">


<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }

    .parent-post-meta {
        display: flex;
        flex-wrap: wrap;
        opacity: 0.8;
    }
</style>

<span class="parent-post-meta">
    <span id="post_meta_style_1">
        <span class="fa fa-calendar-check-o"></span>
        <span>2022-05-14
            &nbsp;&nbsp;
        </span>
    </span>
    
    
    
    
    
    
    
    <span id="post_meta_style_3">
        <span class="fa fa-file-word-o"></span>
        <span>27755å­—
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_4">
        <span class="fa fa-clock-o"></span>
        <span>56åˆ†é’Ÿ
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_5">
        <span class="fa fa-user-o"></span>
        <span>chance7bin
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_6">
        <span class="fa fa-tags" style="opacity: 0.8"></span>
        <span>
            <span class="post-tags-meta">
                <a href="https://chance7bin.github.io/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="color: var(--secondary)!important;">æ“ä½œç³»ç»Ÿ</a>
            </span>
        </span>
    </span>

    
</span>


      
      
      
      
      
      
      
          
          
          
              
              
              
              
          
      
    </div>
  </header>
   <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e5%bc%95%e5%af%bc%e5%90%af%e5%8a%a8%e7%a8%8b%e5%ba%8f---bootsect" aria-label="å¼•å¯¼å¯åŠ¨ç¨‹åº&amp;mdash;bootsect">å¼•å¯¼å¯åŠ¨ç¨‹åº&mdash;bootsect</a><ul>
                            
                    <li>
                        <a href="#1%e7%ae%80%e4%bb%8b" aria-label="1.ç®€ä»‹">1.ç®€ä»‹</a></li>
                    <li>
                        <a href="#2%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f%e5%90%af%e5%8a%a8%e6%b5%81%e7%a8%8b" aria-label="2.æ“ä½œç³»ç»Ÿå¯åŠ¨æµç¨‹">2.æ“ä½œç³»ç»Ÿå¯åŠ¨æµç¨‹</a></li>
                    <li>
                        <a href="#3%e5%bc%95%e5%af%bc%e6%89%87%e5%8c%ba%e4%bb%a3%e7%a0%81-bootsects" aria-label="3.å¼•å¯¼æ‰‡åŒºä»£ç : bootsect.s">3.å¼•å¯¼æ‰‡åŒºä»£ç : bootsect.s</a></li>
                    <li>
                        <a href="#4%e5%ae%8c%e6%95%b4%e7%9a%84bootsects%e6%ba%90%e7%a0%81" aria-label="4.å®Œæ•´çš„bootsect.sæºç ï¼š">4.å®Œæ•´çš„bootsect.sæºç ï¼š</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f%e5%8a%a0%e8%bd%bd---setup" aria-label="æ“ä½œç³»ç»ŸåŠ è½½&amp;mdash;setup">æ“ä½œç³»ç»ŸåŠ è½½&mdash;setup</a><ul>
                            
                    <li>
                        <a href="#1%e7%ae%80%e4%bb%8b-1" aria-label="1.ç®€ä»‹">1.ç®€ä»‹</a></li>
                    <li>
                        <a href="#2%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90" aria-label="2.æºç åˆ†æ">2.æºç åˆ†æ</a></li>
                    <li>
                        <a href="#setup%e7%a8%8b%e5%ba%8f%e5%ae%8c%e6%95%b4%e4%bb%a3%e7%a0%81" aria-label="setupç¨‹åºå®Œæ•´ä»£ç ">setupç¨‹åºå®Œæ•´ä»£ç </a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%86%85%e6%a0%b8%e5%bc%95%e5%af%bc%e7%a8%8b%e5%ba%8f---head" aria-label="å†…æ ¸å¼•å¯¼ç¨‹åº&amp;mdash;head">å†…æ ¸å¼•å¯¼ç¨‹åº&mdash;head</a><ul>
                            
                    <li>
                        <a href="#1%e7%ae%80%e4%bb%8b-2" aria-label="1.ç®€ä»‹">1.ç®€ä»‹</a></li>
                    <li>
                        <a href="#2%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90-1" aria-label="2.æºç åˆ†æ">2.æºç åˆ†æ</a></li>
                    <li>
                        <a href="#3head%e5%ae%8c%e6%95%b4%e6%ba%90%e7%a0%81" aria-label="3.headå®Œæ•´æºç ">3.headå®Œæ•´æºç </a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%88%9d%e5%a7%8b%e5%8c%96%e7%a8%8b%e5%ba%8f---main1" aria-label="åˆå§‹åŒ–ç¨‹åº&amp;mdash;main(1)">åˆå§‹åŒ–ç¨‹åº&mdash;main(1)</a><ul>
                            
                    <li>
                        <a href="#1%e5%b0%8f%e7%bb%93" aria-label="(1)å°ç»“">(1)å°ç»“</a></li>
                    <li>
                        <a href="#2%e5%8a%9f%e8%83%bd%e6%8f%8f%e8%bf%b0" aria-label="(2)åŠŸèƒ½æè¿°">(2)åŠŸèƒ½æè¿°</a></li>
                    <li>
                        <a href="#4cmos" aria-label="(4)CMOS">(4)CMOS</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%88%9d%e5%a7%8b%e5%8c%96%e7%a8%8b%e5%ba%8f---main2" aria-label="åˆå§‹åŒ–ç¨‹åº&amp;mdash;main(2)">åˆå§‹åŒ–ç¨‹åº&mdash;main(2)</a><ul>
                            
                    <li>
                        <a href="#%e4%b8%80%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90" aria-label="ä¸€ã€æºç åˆ†æ">ä¸€ã€æºç åˆ†æ</a></li>
                    <li>
                        <a href="#%e4%ba%8c%e5%ae%8c%e6%95%b4%e6%ba%90%e7%a0%81" aria-label="äºŒã€å®Œæ•´æºç ">äºŒã€å®Œæ•´æºç </a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>
  <div class="post-content"><h1 id="å¼•å¯¼å¯åŠ¨ç¨‹åº---bootsect">å¼•å¯¼å¯åŠ¨ç¨‹åº&mdash;bootsect<a hidden class="anchor" aria-hidden="true" href="#å¼•å¯¼å¯åŠ¨ç¨‹åº---bootsect">#</a></h1>
<h2 id="1ç®€ä»‹">1.ç®€ä»‹<a hidden class="anchor" aria-hidden="true" href="#1ç®€ä»‹">#</a></h2>
<p><strong>å†¯Â·è¯ºä¾æ›¼å­˜å‚¨ç¨‹åºæ€æƒ³</strong></p>
<p>å­˜å‚¨ç¨‹åºçš„ä¸»è¦æ€æƒ³ï¼šå°†ç¨‹åºå’Œæ•°æ®å­˜æ”¾åˆ°è®¡ç®—æœºå†…éƒ¨çš„å­˜å‚¨å™¨ä¸­ï¼Œè®¡ç®—æœºåœ¨ç¨‹åºçš„æ§åˆ¶ä¸‹ä¸€æ­¥ä¸€æ­¥è¿›è¡Œå¤„ç†</p>
<p>è®¡ç®—æœºç”±äº”å¤§éƒ¨ä»¶ç»„æˆï¼šè¾“å…¥è®¾å¤‡ã€è¾“å‡ºè®¾å¤‡ã€å­˜å‚¨å™¨ã€è¿ç®—å™¨ã€æ§åˆ¶å™¨</p>
<p>==<strong>å–æŒ‡æ‰§è¡Œï¼ˆå–æŒ‡ã€{é—´æŒ‡}ã€æ‰§è¡Œã€{ä¸­æ–­} å¤§æ‹¬å·å¯é€‰ ï¼‰</strong>==</p>
<img src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012320821.png" alt="image-20211122152739894" style="zoom: 80%;" /> 
<p>æ‰“å¼€ç”µæºï¼Œè®¡ç®—æœºæ‰§è¡Œçš„ç¬¬ä¸€å¥æŒ‡ä»¤ä»€ä¹ˆ?
æŒ‡é’ˆIPåŠå…¶æŒ‡å‘çš„å†…å®¹</p>
<p>å¯¹äºX86PCæœºè€Œè¨€ï¼š
(1)x86 PCåˆšå¼€æœºæ—¶CPUå¤„äºå®æ¨¡å¼
(2)å¼€æœºæ—¶ï¼ŒCS=0xFFFF; IP=0x0000
(3)å¯»å€0xFFFF0(ROM BIOSæ˜ å°„åŒº)
(4)æ£€æŸ¥RAMï¼Œé”®ç›˜ï¼Œæ˜¾ç¤ºå™¨ï¼Œè½¯ç¡¬ç£ç›˜
(5)å°†ç£ç›˜0ç£é“0æ‰‡åŒºè¯»å…¥0x7c00å¤„
(6)è®¾ç½®cs=0x07c0ï¼Œip=0x0000</p>
<p><strong>æ³¨ï¼šå®æ¨¡å¼å’Œä¿æŠ¤æ¨¡å¼å¯¹åº”ï¼Œå®æ¨¡å¼çš„å¯»å€CS:IP(CSå·¦ç§»4ä½+IP)ï¼Œ å’Œä¿æŠ¤æ¨¡å¼(32ä½æ±‡ç¼–æ¨¡å¼ä¸‹)ä¸ä¸€</strong></p>
<p><strong>0x7c00å¤„å­˜æ”¾çš„ä»£ç </strong>ï¼šä»ç£ç›˜å¼•å¯¼æ‰‡åŒºè¯»å…¥çš„512ä¸ªå­—èŠ‚</p>
<p>1.å¼•å¯¼æ‰‡åŒºå°±æ˜¯==å¯åŠ¨è®¾å¤‡çš„ç¬¬ä¸€ä¸ªæ‰‡åŒº==ï¼ˆå¼€æœºæ—¶æŒ‰ä½delé”®å¯è¿›å…¥å¯åŠ¨è®¾å¤‡è®¾ç½®ç•Œé¢ï¼Œå¯ ä»¥è®¾ç½®ä¸ºå…‰ç›˜å¯åŠ¨!ï¼‰</p>
<p>2.å¯åŠ¨è®¾å¤‡ä¿¡æ¯è¢«è®¾ç½®åœ¨CMOSä¸­ï¼ˆCMOS: (64B-128B)ã€‚ç”¨æ¥å­˜å‚¨å®æ—¶é’Ÿå’Œç¡¬ä»¶é…ç½®ä¿¡æ¯ã€‚ï¼‰</p>
<p>å› æ­¤ï¼Œç¡¬ç›˜çš„ç¬¬ä¸€ä¸ªæ‰‡åŒºä¸Šå­˜æ”¾ç€å¼€æœºåæ‰§è¡Œçš„ç¬¬ä¸€æ®µæˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„ç¨‹åº</p>
<p>==æ“ä½œç³»ç»Ÿçš„æ•…äº‹ä»è¿™é‡Œå¼€å§‹&hellip;==</p>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012320822.png" alt="image-20211122155624183"  />
</p>
<h2 id="2æ“ä½œç³»ç»Ÿå¯åŠ¨æµç¨‹">2.æ“ä½œç³»ç»Ÿå¯åŠ¨æµç¨‹<a hidden class="anchor" aria-hidden="true" href="#2æ“ä½œç³»ç»Ÿå¯åŠ¨æµç¨‹">#</a></h2>
<p>bootsect.så’Œsetup.sæ˜¯å®æ—¶æ¨¡å¼ä¸‹è¿è¡Œçš„16ä½ä»£ç ç¨‹åºï¼Œé‡‡ç”¨è¿‘ä¼¼Intelè¯­æ³•ï¼Œè€Œhead.sä½¿ç”¨GUNæ±‡ç¼–æ ¼å¼(AT&amp;T),å¹¶ä¸”è¿è¡Œåˆ°ä¿æŠ¤æ¨¡å¼ä¸‹ã€‚</p>
<p>å½“PCçš„ç”µæºæ‰“å¼€åï¼ŒCPUè‡ªåŠ¨è¿›å…¥å®æ¨¡å¼ï¼Œå¹¶ä»åœ°å€0XFFFF0å¼€å§‹æ‰§è¡Œç¨‹åºä»£ç ï¼Œè¿™ä¸ªåœ°å€é€šå¸¸æ˜¯ROM-BIOSä¸­çš„åœ°å€ï¼ŒPCæœºçš„BIOSå°†æ‰§è¡ŒæŸäº›ç³»ç»Ÿæ£€æµ‹ï¼Œå¹¶åœ¨ç‰©ç†åœ°å€0å¤„å¼€å§‹åˆå§‹åŒ–ä¸­æ–­å‘é‡ã€‚ç„¶åï¼Œå®ƒå°†å¯ä»¥å¯åŠ¨è®¾å¤‡çš„ç¬¬ä¸€ä¸ªæ‰‡åŒº(ç£ç›˜å¼•å¯¼æ‰‡åŒºï¼Œ512byte)è¯»å…¥å†…å­˜ç»å¯¹åœ°å€0x7C00å¤„ï¼Œå¹¶è·³è½¬åˆ°è¿™ä¸ªåœ°æ–¹ï¼Œå¯åŠ¨è®¾å¤‡é€šå¸¸æ˜¯è½¯é©±æˆ–è€…ç¡¬ç›˜ã€‚</p>
<p>Linuxæœ€å‰é¢éƒ¨åˆ†(boot/bootsect.s)ï¼Œå®ƒå°†ç”±BIOSè¯»å…¥å†…å­˜ç»å¯¹åœ°å€0x7C00å¤„ï¼Œå½“å®ƒè¢«æ‰§è¡Œæ—¶å°±ä¼šæŠŠè‡ªå·±ç§»åŠ¨åˆ°å†…å­˜ç»å¯¹åœ°å€0X90000å¤„ï¼Œå¹¶æŠŠå¯åŠ¨è®¾å¤‡ä¸­å2kbå­—èŠ‚ä»£ç (boot/setup.s)è¯»å…¥åˆ°å†…å­˜0x90200å¤„ï¼Œè€Œå†…æ ¸çš„å…¶ä»–éƒ¨åˆ†(systemæ¨¡å—ï¼‰åˆ™è¢«è¯»å…¥åˆ°å†…å­˜åœ°å€0x10000å¼€å§‹å¤„</p>
<p>setup.så°†ä¼šæŠŠsystemæ¨¡å—ç§»åŠ¨åˆ°ç‰©ç†å†…å­˜èµ·å§‹ä½ç½®å¤„ï¼Œè¿™æ ·systemæ¨¡å—ä¸­ä»£ç çš„åœ°å€å°±ç­‰äºå®é™…çš„ç‰©ç†åœ°å€ï¼Œä¾¿äºå¯¹å†…æ ¸ä»£ç å’Œæ•°æ®æ“ä½œã€‚</p>
<p>ä»æœºå™¨åŠ ç”µå¼€å§‹æ‰§è¡Œé¡ºåº
<img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012320825.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"  />

å¯åŠ¨å¼•å¯¼æ—¶å†…æ ¸åœ¨å†…å­˜ä¸­çš„ä½ç½®å’Œç§»åŠ¨ï¼š
<img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012320830.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"  />
</p>
<p>æ•´ä¸ªç³»ç»Ÿä»åœ°å€0x10000ç§»è‡³0x0000å¤„ï¼Œè¿›å…¥ä¿æŠ¤æ¨¡å¼å¹¶è·³è½¬è‡³ç³»ç»Ÿçš„ä½™ä¸‹éƒ¨åˆ†(åœ¨0x0000chu)ã€‚æ­¤æ—¶æ‰€æœ‰çš„32ä½è¿è¡Œæ–¹å¼çš„è®¾ç½®å¯åŠ¨è¢«å®Œæˆï¼šIDT,GDTå’ŒLDTè¢«åŠ è½½ï¼Œå¤„ç†å™¨å’Œåå¤„ç†å™¨ä¹Ÿç¡®è®¤ï¼Œåˆ†é¡µå·¥ä½œä¹Ÿè®¾ç½®å®Œæˆã€‚</p>
<p>æœ€ç»ˆè°ƒç”¨init/main.cä¸­main()ç¨‹åº</p>
<h2 id="3å¼•å¯¼æ‰‡åŒºä»£ç -bootsects">3.å¼•å¯¼æ‰‡åŒºä»£ç : bootsect.s<a hidden class="anchor" aria-hidden="true" href="#3å¼•å¯¼æ‰‡åŒºä»£ç -bootsects">#</a></h2>
<p>bootsect.sä»£ç æ˜¯ç£ç›˜å¼•å¯¼å—ç¨‹åºï¼Œé©»ç•™åœ¨ç£ç›˜çš„ç¬¬ä¸€ä¸ªæ‰‡åŒºä¸­ï¼ˆå¼•å¯¼æ‰‡åŒºï¼Œ0ç£é“ï¼ˆæŸ±é¢ï¼‰ï¼Œ0ç£å¤´ï¼Œç¬¬ä¸€ä¸ªæ‰‡åŒºï¼‰</p>
<p>åœ¨PCæœºåŠ ç”µROM BIOSè‡ªæ£€åï¼ŒROM BIOSä¼šæŠŠå¼•å¯¼æ‰‡åŒºä»£ç bootsectåŠ è½½åˆ°å†…å­˜åœ°å€0x7C00å¼€å§‹å¤„å¹¶æ‰§è¡Œä¹‹ã€‚åœ¨bootsectä»£ç æ‰§è¡ŒæœŸé—´ï¼Œå®ƒä¼šå°†è‡ªå·±ç§»åŠ¨åˆ°å†…å­˜ç»å¯¹åœ°å€0x90000å¼€å§‹å¤„å¹¶ç»§ç»­æ‰§è¡Œã€‚</p>
<p>è¯¥ç¨‹åºçš„ä¸»è¦ä½œç”¨æ˜¯é¦–å…ˆæŠŠä»ç£ç›˜ç¬¬2ä¸ªæ‰‡åŒºå¼€å§‹çš„4ä¸ªæ‰‡åŒºçš„setupæ¨¡å—(ç”± setup.sç¼–è¯‘è€Œæˆ)åŠ è½½åˆ°å†…å­˜ç´§æ¥ç€bootsectåé¢ä½ç½®å¤„(0x90200),ç„¶ååˆ©ç”¨BIOSä¸­æ–­ 0x13 ï¼Œå–ç£ç›˜å‚æ•°è¡¨ä¸­å½“å‰å¯åŠ¨å¼•å¯¼ç›˜çš„å‚æ•°ï¼Œæ¥ç€åœ¨å±å¹•ä¸Šæ˜¾ç¤ºâ€œLoading system.â€å­—ç¬¦ä¸²ã€‚</p>
<p>å†æŠŠç£ç›˜ä¸Šsetupæ¨¡å—åé¢çš„systemæ¨¡å—åŠ è½½åˆ°å†…å­˜0x10000å¼€å§‹çš„åœ°æ–¹ã€‚éšåç¡®å®šæ ¹æ–‡ä»¶ç³»ç»Ÿçš„è®¾å¤‡å·ï¼Œè‹¥æ²¡æœ‰æŒ‡å®šï¼Œåˆ™æ ¹æ®æ‰€ä¿å­˜çš„å¼•å¯¼ç›˜çš„æ¯ç£é“æ‰‡åŒºæ•°åˆ¤åˆ«å‡ºç›˜çš„ç±»å‹å’Œç§ç±»å¹¶ä¿å­˜å…¶è®¾å¤‡å·äº root_dev( å¼•å¯¼å—çš„508åœ°å€å¤„)ï¼Œæœ€åé•¿è·³è½¬åˆ°setupç¨‹åºçš„å¼€å§‹å¤„(0x00200)æ‰§è¡Œsetupç¨‹åºã€‚</p>
<p>å„æºæ–‡ä»¶ä½ç½®
<img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012320826.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"  />
</p>
<p>1.ç”±BIOSè¯»å…¥å†…å­˜ç»å¯¹åœ°å€0x7C00å¤„ï¼Œå½“å®ƒè¢«æ‰§è¡Œæ—¶å°±ä¼šæŠŠè‡ªå·±ç§»åŠ¨åˆ°å†…å­˜ç»å¯¹åœ°å€0X90000å¤„</p>
<p><code>ds:si</code></p>
<p><code>es:di</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">; bootsectå¯åŠ¨ç¨‹åºå°†å®ƒè‡ªèº«ä»å†…å®¹0x07c00(BOOTSEG)å¤„å¤åˆ¶è‡³å†…å­˜0x9000(INITSEG)å¤„
</span></span><span class="line"><span class="cl">entry start            ;å…³é”®å­—entryå‘Šè¯‰é“¾æ¥å™¨&#34;ç¨‹åºå…¥å£&#34;
</span></span><span class="line"><span class="cl">start:
</span></span><span class="line"><span class="cl">	mov	ax,#BOOTSEG    ;BOOTSEG = 0x07c0 èµ‹å€¼ç»™axï¼Œ
</span></span><span class="line"><span class="cl">	mov	ds,ax          ;æºåœ°å€
</span></span><span class="line"><span class="cl">	mov	ax,#INITSEG    ;INITSEG = 0x9000 èµ‹å€¼ç»™bx
</span></span><span class="line"><span class="cl">	mov	es,ax		   ;ç›®æ ‡åœ°å€
</span></span><span class="line"><span class="cl">	mov	cx,#256        ;å¾ªç¯æ¬¡æ•°ï¼Œæ¯æ¬¡å¾ªç¯å®Œæ¬¡æ•°å‡ä¸€
</span></span><span class="line"><span class="cl">	sub	si,si          ;æ¸…é›¶
</span></span><span class="line"><span class="cl">	sub	di,di          ;æ¸…é›¶
</span></span><span class="line"><span class="cl">	rep				   ;repæ˜¯repeatï¼Œrepé…åˆ movw(movsb) å°±æ˜¯å¤šæ¬¡å¤åˆ¶ç›´åˆ°cx=0ä¸ºæ­¢ å¤åˆ¶çš„æ¬¡æ•°æ”¾åœ¨cxä¸­
</span></span><span class="line"><span class="cl">	movw               ;ç”¨äºæŠŠå†…å®¹ä»ds:si å¤åˆ¶es:di  ä»¥å­—ä½å•ä½
</span></span><span class="line"><span class="cl">	jmpi	go,INITSEG ;é—´æ¥è·³è½¬ å³ç¨‹åºè·³åˆ°9000:0 å»ç»§ç»­æ‰§è¡Œ  CS=INITSEGï¼ŒIP=go(åç§»åœ°å€)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">; ä»è¿™é‡Œå¼€å§‹cpuå·²ç»è·³åˆ°å†…å­˜0x90000å»æ‰§è¡Œï¼Œ
</span></span><span class="line"><span class="cl">; BIOSæŠŠå¼•å¯¼æ‰‡åŒºåŠ è½½åˆ°0x7c00å¤„å¹¶æŠŠæ‰§è¡Œæƒäº¤ç»™å¼•å¯¼ç¨‹åºï¼Œ(ss=0x00,sp=0xfffe)
</span></span><span class="line"><span class="cl">; å°†ds,es,ss,éƒ½è®¾ç½®æˆç§»åŠ¨åä»£ç æ‰€åœ¨æ®µ(0x9000)
</span></span><span class="line"><span class="cl">go:	mov	ax,cs          ;ax = cs = INITSEG = 0x9000
</span></span><span class="line"><span class="cl">	mov	ds,ax          ;æ•°æ®æ®µåœ°å€
</span></span><span class="line"><span class="cl">	mov	es,ax          ;é™„åŠ æ®µåœ°å€
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">! put stack at 0x9ff00. ;å°†å †æ ˆæŒ‡é’ˆspæŒ‡å‘0x9fff00(0x9000:0xff00)
</span></span><span class="line"><span class="cl">	mov	ss,ax           ;æ ˆæ®µåœ°å€
</span></span><span class="line"><span class="cl">; ä¿è¯æ ˆæŒ‡é’ˆspåªè¦æŒ‡å‘è¿œå¤§äº512byteå­—èŠ‚åç§»(å³åœ°å€0x90200)
</span></span><span class="line"><span class="cl">; å› ä¸ºåœ¨0x90200åè¦å­˜æ”¾setupç¨‹åºï¼Œå¤§çº¦ä¸º4ä¸ªæ‰‡åŒº spæŒ‡å‘å¤§äº(0x200+0x200*4+å †æ ˆå¤§å°)
</span></span><span class="line"><span class="cl">	mov	sp,#0xFF00		! arbitrary value &gt;&gt;512  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">! load the setup-sectors directly after the bootblock.
</span></span><span class="line"><span class="cl">; åœ¨bootsectç¨‹åºç´§è·Ÿç€åŠ è½½setupç¨‹åº
</span></span><span class="line"><span class="cl">! Note that &#39;es&#39; is already set up.
</span></span><span class="line"><span class="cl">; esåœ¨ç§»åŠ¨ä»£ç æ—¶è®¾ç½®å¥½äº†æŒ‡å‘ç›®çš„åœ°å€0x9000
</span></span></code></pre></td></tr></table>
</div>
</div><p>2.åˆ©ç”¨BIOSä¸­æ–­ INT 0x13 å°†setupæ¨¡å—ä»ç£ç›˜ç¬¬2ä¸ªæ‰‡åŒºå¼€å§‹è¯»åˆ°0x90200,ç„¶åå–ç£ç›˜å‚æ•°è¡¨ä¸­å½“å‰å¯åŠ¨å¼•å¯¼ç›˜çš„å‚æ•°ï¼Œæ¥ç€åœ¨å±å¹•ä¸Šæ˜¾ç¤ºâ€œLoading system.â€å­—ç¬¦ä¸²</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">; è¿™ä¸€æ®µä¸»è¦æ˜¯åˆ©ç”¨BIOSä¸­æ–­ INT 0x13 å°†setupæ¨¡å—ä»ç£ç›˜ç¬¬2ä¸ªæ‰‡åŒºå¼€å§‹è¯»åˆ°0x90200,
</span></span><span class="line"><span class="cl">; ä¸€ä¸ªå››ä¸ªæ‰‡åŒºï¼Œå¦‚æœè¯»é”™ï¼Œåˆ™å¤ä½é©±åŠ¨å™¨ï¼Œå¹¶é‡è¯•
</span></span><span class="line"><span class="cl">; INT 0x13 ä½¿ç”¨æ–¹æ³•ï¼š
</span></span><span class="line"><span class="cl">; è¯»æ‰‡åŒºï¼š
</span></span><span class="line"><span class="cl">; ah = 0x02 --è¯»ç£ç›˜æ‰‡åŒºåˆ°å†…å­˜
</span></span><span class="line"><span class="cl">; al = éœ€è¦è¯»å‡ºçš„æ‰‡åŒºæ•°é‡
</span></span><span class="line"><span class="cl">; ch = ç£é“(æŸ±é¢)å·ä½8ä½
</span></span><span class="line"><span class="cl">; cl = å¼€å§‹æ‰‡åŒº(ä½0-5)ï¼Œç£é“å·é«˜ä¸¤ä½(ä½6-7)
</span></span><span class="line"><span class="cl">; dh = ç£å¤´å·
</span></span><span class="line"><span class="cl">; dl = é©±åŠ¨å™¨å·(å¦‚æœæ˜¯ç¡¬ç›˜åˆ™ä½7è¦ç½®ä½)
</span></span><span class="line"><span class="cl">; es:bx--&gt;æŒ‡å‘æ•°æ®ç¼“å­˜åŒº ï¼Œå¦‚æœå‡ºé”™åˆ™CFæ ‡å¿—ç½®ä½ï¼Œahä¸­æ˜¯å‡ºé”™ç 
</span></span><span class="line"><span class="cl">load_setup:
</span></span><span class="line"><span class="cl">	mov	dx,#0x0000		! drive 0, head 0
</span></span><span class="line"><span class="cl">	mov	cx,#0x0002		! sector 2, track 0
</span></span><span class="line"><span class="cl">	mov	bx,#0x0200		! address = 512, in INITSEG
</span></span><span class="line"><span class="cl">	mov	ax,#0x0200+SETUPLEN	! service 2, nr of sectors
</span></span><span class="line"><span class="cl">	int	0x13			! read it
</span></span><span class="line"><span class="cl">; JNC:Jump Not Carry æ²¡è¿›ä½æ—¶è·³è½¬ æ­£ç¡®è¯»å–æ—¶CF=0
</span></span><span class="line"><span class="cl">	jnc	ok_load_setup		! ok - continue
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">; è¯»å–å‡ºé”™ï¼Œå¯¹é©±åŠ¨å™¨0è¿›è¡Œè¯»æ“ä½œ å¹¶é‡æ–°è¯»å–åŠ è½½setupç¨‹åº
</span></span><span class="line"><span class="cl">	mov	dx,#0x0000
</span></span><span class="line"><span class="cl">	mov	ax,#0x0000		! reset the diskette
</span></span><span class="line"><span class="cl">	int	0x13
</span></span><span class="line"><span class="cl">	j	load_setup      ! jmpæŒ‡ä»¤  è¿”å›åˆ°é‡æ–°åŠ è½½setupå¤„
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ok_load_setup:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">! Get disk drive parameters, specifically nr of sectors/track
</span></span><span class="line"><span class="cl">; å–ç£ç›˜é©±åŠ¨å™¨çš„å‚æ•°ï¼Œç‰¹åˆ«æ˜¯æ¯é“çš„æ‰‡åŒºæ•°é‡
</span></span><span class="line"><span class="cl">; å–ç£ç›˜é©±åŠ¨å™¨çš„å‚æ•° INT 0x13è°ƒç”¨æ ¼å¼å’Œè¿”å›ä¿¡æ¯ï¼š
</span></span><span class="line"><span class="cl">; è°ƒç”¨æ ¼å¼:
</span></span><span class="line"><span class="cl">; ah = 0x08        dl = é©±åŠ¨å™¨å·(å¦‚æœæ˜¯ç¡¬ç›˜åˆ™ä½7è¦ç½®ä½)
</span></span><span class="line"><span class="cl">; è¿”å›ä¿¡æ¯ï¼š
</span></span><span class="line"><span class="cl">; å¦‚æœå‡ºé”™ï¼Œåˆ™CFå€¼ä½ï¼Œå¹¶ä¸”ah = çŠ¶æ€ç 
</span></span><span class="line"><span class="cl">; ah = 0, al = 0  bl = é©±åŠ¨å™¨ç±»å‹(AT/PS2)
</span></span><span class="line"><span class="cl">; ch = ç£é“(æŸ±é¢)å·ä½8ä½
</span></span><span class="line"><span class="cl">; cl = å¼€å§‹æ‰‡åŒº(ä½0-5)ï¼Œç£é“å·é«˜ä¸¤ä½(ä½6-7)	
</span></span><span class="line"><span class="cl">; dh = æœ€å¤§ç£å¤´æ•° ï¼Œ   dl = é©±åŠ¨å™¨æ•°é‡
</span></span><span class="line"><span class="cl">; es:di---&gt;è½¯é©±ç£ç›˜å‚æ•°è¡¨
</span></span><span class="line"><span class="cl">	mov	dl,#0x00
</span></span><span class="line"><span class="cl">	mov	ax,#0x0800		! AH=8 is get drive parameters
</span></span><span class="line"><span class="cl">	int	0x13
</span></span><span class="line"><span class="cl">	mov	ch,#0x00
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">; è¿™æ¡æŒ‡ä»¤è¡¨ç¤ºä¸‹ä¸€æ¡æŒ‡ä»¤çš„æ“ä½œæ•°åœ¨csæ®µå¯„å­˜å™¨æ‰€æŒ‡çš„æ®µä¸­
</span></span><span class="line"><span class="cl">	seg cs
</span></span><span class="line"><span class="cl">; ä¿æŒæ¯ç£é“æ‰‡åŒºæ•° (cx = æ¯ç£é“æ‰‡åŒºæ•°)
</span></span><span class="line"><span class="cl">	mov	sectors,cx
</span></span><span class="line"><span class="cl">	mov	ax,#INITSEG
</span></span><span class="line"><span class="cl">; ç”±äºä¸Šé¢å–ç£é“å‚æ•°ä¸­æ–­æ”¹æ‰äº†esçš„å€¼ï¼Œè¿™é‡Œé‡æ–°å¤åˆ¶ï¼Œ 	
</span></span><span class="line"><span class="cl">	mov	es,ax
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">! Print some inane message
</span></span><span class="line"><span class="cl">; æ˜¾ç¤ºä¿¡æ¯ï¼š&#34;&#39;Loading system ...&#39;å›è½¦æ¢è¡Œ&#34; åŒ…æ‹¬å›è½¦æ¢è¡Œä¸€å…±24ä¸ªå­—ç¬¦
</span></span><span class="line"><span class="cl">; BIOSä¸­æ–­0x10åŠŸèƒ½å· ah= 0x03,è¯»å…‰æ ‡çš„ä½ç½®
</span></span><span class="line"><span class="cl">; è¾“å…¥:bh = é¡µå·
</span></span><span class="line"><span class="cl">; è¿”å›ï¼šch = æ‰«æå¼€å§‹çº¿ï¼Œcl = ç»“æŸå¼€å§‹çº¿,dh = è¡Œå·(0x00é¡¶ç«¯)ï¼Œdl=åˆ—å·(0x00æœ€å·¦è¾¹)
</span></span><span class="line"><span class="cl">ï¼
</span></span><span class="line"><span class="cl">; BIOSä¸­æ–­0x10åŠŸèƒ½å· ah= 0x13,æ˜¾ç¤ºå­—ç¬¦ä¸²
</span></span><span class="line"><span class="cl">; è¾“å…¥ï¼šal=æ”¾ç½®å…‰æ ‡çš„æ–¹å¼åŠè§„å®šå±æ€§ï¼Œ0x01--è¡¨ç¤ºä½¿ç”¨blä¸­çš„å±æ€§ï¼Œå…‰æ ‡åœåœ¨å­—ç¬¦ä¸²ç»“å°¾å¤„
</span></span><span class="line"><span class="cl">; es:bp æ­¤å¯„å­˜å™¨æŒ‡å‘è¦æ˜¾ç¤ºå­—ç¬¦ä¸²èµ·å§‹ä½ç½®å¤„
</span></span><span class="line"><span class="cl">; cx = æ˜¾ç¤ºçš„å­—ç¬¦ä¸²å­—ç¬¦æ•°
</span></span><span class="line"><span class="cl">; bh = æ˜¾ç¤ºé¡µé¢å· bl = å­—ç¬¦å±æ€§ dh = è¡Œå·ï¼Œdl=åˆ—å·
</span></span><span class="line"><span class="cl">	mov	ah,#0x03		! read cursor pos
</span></span><span class="line"><span class="cl">	xor	bh,bh           ! é¦–å…ˆè¯»å…‰æ ‡çš„ä½ç½®ï¼Œè¿”å›å…‰æ ‡ä½ç½®å€¼åœ¨dx
</span></span><span class="line"><span class="cl">	int	0x10            ï¼dh = è¡Œ(0-23)  dl = åˆ—(0-79) æ˜¾ç¤ºå­—ç¬¦ä¸²ä½¿ç”¨
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	mov	cx,#24          ! æ˜¾ç¤º24ä¸ªå­—ç¬¦
</span></span><span class="line"><span class="cl">	mov	bx,#0x0007		! page 0, attribute 7 (normal)
</span></span><span class="line"><span class="cl">	mov	bp,#msg1		! es:bp å¯„å­˜å™¨æŒ‡å‘è¦æ˜¾ç¤ºå­—ç¬¦ä¸²èµ·å§‹ä½ç½®å¤„
</span></span><span class="line"><span class="cl">	mov	ax,#0x1301	 	! write string, move cursor 
</span></span><span class="line"><span class="cl">	int	0x10
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">! ok, we&#39;ve written the message, now
</span></span><span class="line"><span class="cl">! we want to load the system (at 0x10000)
</span></span><span class="line"><span class="cl">; å°†systemåŠ è½½åˆ°0x10000
</span></span><span class="line"><span class="cl">	mov	ax,#SYSSEG
</span></span><span class="line"><span class="cl">	mov	es,ax		! segment of 0x010000 
</span></span><span class="line"><span class="cl">	call	read_it      ; è¯»ç£ç›˜ä¸Šsystemæ¨¡å—ï¼Œesä¸ºè¾“å…¥å‚æ•°
</span></span><span class="line"><span class="cl">	call	kill_motor   ; å…³é—­é©±åŠ¨å™¨é©¬è¾¾ï¼Œè¿™æ ·å°±å¯ä»¥çŸ¥é“é©±åŠ¨å™¨çš„çŠ¶æ€
</span></span></code></pre></td></tr></table>
</div>
</div><p>3.æ£€æµ‹ä½¿ç”¨çš„æ ¹æ–‡ä»¶ç³»ç»Ÿ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">; æ£€æµ‹ä½¿ç”¨çš„æ ¹æ–‡ä»¶ç³»ç»Ÿ
</span></span><span class="line"><span class="cl">; å¦‚æœå·²ç»æŒ‡å®šäº†è®¾å¤‡å¹¶ä¸”ä¸ç­‰äº0ï¼Œå°±ç›´æ¥ä½¿ç”¨ç»™å®šçš„è®¾å¤‡ï¼Œå¦åˆ™å°±éœ€è¦æŠ¥é“çš„æ¯ç£é“æ‰‡åŒºæ•°æ¥
</span></span><span class="line"><span class="cl">; ç¡®å®šæ˜¯ä½¿ç”¨/dev/PS0(2,28) è¿˜æ˜¯/dev/at0(2,8)
</span></span><span class="line"><span class="cl">; åœ¨Linuxä¸­è½¯é©±çš„ä¸»è®¾å¤‡æ˜¯2ï¼Œæ¬¡è®¾å¤‡ = type*4 + nr 
</span></span><span class="line"><span class="cl">; typeæ˜¯è½¯é©±çš„ç±»å‹(2--&gt;1.2MB,7--&gt;1,44MB)
</span></span><span class="line"><span class="cl">; nr(0-3)å¯¹åº”è½¯é©±A,B,C,D
</span></span><span class="line"><span class="cl">; /dev/PS0(2,28)---&gt;1.44mb Aé©±åŠ¨å™¨ï¼Œè®¾å¤‡å·0x21c  7*4+0 =28
</span></span><span class="line"><span class="cl">; /dev/at0(2,8)---&gt;1.2MB Aé©±åŠ¨å™¨ï¼Œè®¾å¤‡å·0x0208
</span></span><span class="line"><span class="cl">	seg cs
</span></span><span class="line"><span class="cl">	mov	ax,root_dev     ï¼å–508ï¼Œ509 byteå¤„çš„æ ¹è®¾å¤‡å·,root_devå®šä¹‰åœ¨è¿™é‡Œ
</span></span><span class="line"><span class="cl">	cmp	ax,#0
</span></span><span class="line"><span class="cl">	jne	root_defined    ï¼åˆ¤æ–­æ˜¯å¦è¢«å®šä¹‰ï¼Œæ¯å®šä¹‰è·³åˆ°å®šä¹‰å¤„
</span></span><span class="line"><span class="cl">	seg cs
</span></span><span class="line"><span class="cl">	mov	bx,sectors
</span></span><span class="line"><span class="cl">	mov	ax,#0x0208		! /dev/ps0 - 1.2Mb
</span></span><span class="line"><span class="cl">	cmp	bx,#15			! åˆ¤æ–­æ¯ç£é“æ‰‡åŒºæ•°æ˜¯å¦ç­‰äº15 ï¼Œsectorsç­‰äº15åˆ™æ˜¯1.2Mbé©±åŠ¨å™¨
</span></span><span class="line"><span class="cl">	je	root_defined
</span></span><span class="line"><span class="cl">	mov	ax,#0x021c		! /dev/PS0 - 1.44Mb
</span></span><span class="line"><span class="cl">	cmp	bx,#18          ! sectorsç­‰äº18åˆ™æ˜¯1.44Mbé©±åŠ¨å™¨
</span></span><span class="line"><span class="cl">	je	root_defined
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">; å¦‚æœéƒ½ä¸ä¸€æ ·ï¼Œåˆ™æ­»å¾ªç¯(æ­»æœº)
</span></span><span class="line"><span class="cl">undef_root:
</span></span><span class="line"><span class="cl">	jmp undef_root
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root_defined:
</span></span><span class="line"><span class="cl">	seg cs
</span></span><span class="line"><span class="cl">	mov	root_dev,ax      ï¼å°†æ£€æµ‹åˆ°çš„è®¾å¤‡å·ä¿å­˜åˆ°root_dev
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">! after that (everyting loaded), we jump to
</span></span><span class="line"><span class="cl">! the setup-routine loaded directly after
</span></span><span class="line"><span class="cl">! the bootblock:
</span></span><span class="line"><span class="cl">; åˆ°è¿™é‡Œï¼Œæ‰€æœ‰çš„ç¨‹åºéƒ½åŠ è½½å®Œæ¯•ï¼Œç„¶åè·³è½¬åˆ°åŠ è½½åˆ°bootsectåé¢çš„setupç¨‹åº
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	jmpi	0,SETUPSEG    ï¼ï¼ï¼ï¼ï¼ï¼æœ¬ç¨‹åºç»“æŸ
</span></span></code></pre></td></tr></table>
</div>
</div><p>4.å‰©ä½™çš„ç¨‹åºä¸¤ä¸ªå­ç¨‹åºï¼Œ(read_it)ç”¨äºè¯»å–systemæ¨¡å—ï¼Œ(kill_moter)ç”¨äºå…³é—­è½¯ä»¶çš„é©¬è¾¾ï¼Œå°±ä¸ä¸€ä¸€ä»‹ç»äº†ã€‚</p>
<h2 id="4å®Œæ•´çš„bootsectsæºç ">4.å®Œæ•´çš„bootsect.sæºç ï¼š<a hidden class="anchor" aria-hidden="true" href="#4å®Œæ•´çš„bootsectsæºç ">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">!
</span></span><span class="line"><span class="cl">! SYS_SIZE is the number of clicks (16 bytes) to be loaded.
</span></span><span class="line"><span class="cl">! 0x3000 is 0x30000 bytes = 196kB, more than enough for current
</span></span><span class="line"><span class="cl">! versions of linux
</span></span><span class="line"><span class="cl">SYSSIZE = 0x3000
</span></span><span class="line"><span class="cl">;SYS_SIZEæ˜¯è¦åŠ è½½çš„ç³»ç»Ÿæ¨¡å—é•¿åº¦ï¼Œå•ä½æ˜¯èŠ‚ï¼Œ16 bytesä¸º1èŠ‚
</span></span><span class="line"><span class="cl">;0x3000å­—èŠ‚ = 196kB
</span></span><span class="line"><span class="cl">!
</span></span><span class="line"><span class="cl">;æ“ä½œç³»ç»Ÿå¯åŠ¨æµç¨‹
</span></span><span class="line"><span class="cl">!	bootsect.s		(C) 1991 Linus Torvalds
</span></span><span class="line"><span class="cl">!
</span></span><span class="line"><span class="cl">! bootsect.s is loaded at 0x7c00 by the bios-startup routines, and moves
</span></span><span class="line"><span class="cl">! iself out of the way to address 0x90000, and jumps there.
</span></span><span class="line"><span class="cl">!
</span></span><span class="line"><span class="cl">! It then loads &#39;setup&#39; directly after itself (0x90200), and the system
</span></span><span class="line"><span class="cl">! at 0x10000, using BIOS interrupts. 
</span></span><span class="line"><span class="cl">!
</span></span><span class="line"><span class="cl">! NOTE! currently system is at most 8*65536 bytes long. This should be no
</span></span><span class="line"><span class="cl">! problem, even in the future. I want to keep it simple. This 512 kB
</span></span><span class="line"><span class="cl">! kernel size should be enough, especially as this doesn&#39;t contain the
</span></span><span class="line"><span class="cl">! buffer cache as in minix
</span></span><span class="line"><span class="cl">!
</span></span><span class="line"><span class="cl">! The loader has been made as simple as possible, and continuos
</span></span><span class="line"><span class="cl">! read errors will result in a unbreakable loop. Reboot by hand. It
</span></span><span class="line"><span class="cl">! loads pretty fast by getting whole sectors at a time whenever possible.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">;ä¼ªæŒ‡ä»¤ï¼Œ .globlç”¨äºå®šä¹‰éšåçš„æ ‡è¯†ç¬¦æ˜¯å¤–éƒ¨æˆ–è€…å…¨å±€çš„
</span></span><span class="line"><span class="cl">.globl begtext, begdata, begbss, endtext, enddata, endbss  !å…¨å±€æ ‡è¯†ç¬¦ï¼Œä¾›ld86é“¾ä½¿ç”¨
</span></span><span class="line"><span class="cl">.text                                                      ï¼æ­£æ–‡æ®µ
</span></span><span class="line"><span class="cl">begtext:                                                   ï¼æ ‡å· ä»£è¡¨å…¶æ‰€åœ¨çš„ä½ç½®ï¼Œé€šå¸¸æŒ‡æ˜ä¸€ä¸ªè·³è½¬å‘½ä»¤çš„ç›®æ ‡åœ°å€
</span></span><span class="line"><span class="cl">.data                                                      ï¼æ•°æ®æ®µ
</span></span><span class="line"><span class="cl">begdata:
</span></span><span class="line"><span class="cl">.bss                                                       ï¼æœªåˆå§‹åŒ–æ•°æ®æ®µ
</span></span><span class="line"><span class="cl">begbss:         
</span></span><span class="line"><span class="cl">.text                                                      ï¼æ­£æ–‡æ®µ
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SETUPLEN = 4				! nr of setup-sectors
</span></span><span class="line"><span class="cl">							ï¼setupç¨‹åºçš„æ‰‡åŒºæ•°å€¼
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">BOOTSEG  = 0x07c0	   		! original address of boot-sector
</span></span><span class="line"><span class="cl">							ï¼BIOSåŠ è½½bootsectä»£ç çš„åŸå§‹æ®µåœ°å€
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">INITSEG  = 0x9000			! we move boot here - out of the way
</span></span><span class="line"><span class="cl">							ï¼å°†bootsectç§»åŠ¨åˆ°è¿™é‡Œ
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SETUPSEG = 0x9020			! setup starts here
</span></span><span class="line"><span class="cl">							ï¼setupç¨‹åºä»è¿™é‡Œå¼€å§‹
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SYSSEG   = 0x1000			! system loaded at 0x10000 (65536).
</span></span><span class="line"><span class="cl">							ï¼systemæ¨¡å—åŠ è½½åˆ°0x010000(64kb).
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ENDSEG   = SYSSEG + SYSSIZE		! where to stop loading
</span></span><span class="line"><span class="cl">								! åœæ­¢åŠ è½½çš„æ®µåœ°å€
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">! ROOT_DEV:	0x000 - same type of floppy as boot.
</span></span><span class="line"><span class="cl">; æ ¹æ–‡ä»¶ç³»ç»Ÿè®¾å¤‡ä½¿ç”¨ä¸å¼•å¯¼æ—¶ç›¸åŒçš„è½¯é©±è®¾å¤‡
</span></span><span class="line"><span class="cl">!		0x301 - first partition on first drive etc
</span></span><span class="line"><span class="cl">; æ ¹æ–‡ä»¶ç³»ç»Ÿè®¾å¤‡åœ¨ç¬¬ä¸€ä¸ªç¡¬ç›˜çš„ç¬¬ä¸€ä¸ªåˆ†åŒºä¸Š
</span></span><span class="line"><span class="cl">ROOT_DEV = 0x306
</span></span><span class="line"><span class="cl">; è®¾å¤‡å·0x36æŒ‡å®šæ ¹æ–‡ä»¶ç³»ç»Ÿæ—¶ç¬¬2ä¸ªç¡¬ç›˜çš„ç¬¬ä¸€ä¸ªåˆ†åŒº
</span></span><span class="line"><span class="cl">; è®¾å¤‡å·å‘½åæ–¹å¼ï¼š
</span></span><span class="line"><span class="cl">; è®¾å¤‡å· = ä¸»è®¾å¤‡å·*256 + æ¬¡è®¾å¤‡å· (dev_no = (major&lt;&lt;8)+minor)
</span></span><span class="line"><span class="cl">; ä¸»è®¾å¤‡å·ï¼š1-å†…å­˜ï¼Œ2-ç£ç›˜ï¼Œ3-ç¡¬ç›˜ï¼Œ4-ttyx,5-tty,6-å¹¶è¡Œå£ï¼Œ7-éå‘½åç®¡é“
</span></span><span class="line"><span class="cl">; 0x300 - /dev/hd0  --ä»£è¡¨æ•´ä¸ªç¬¬ä¸€ä¸ªç¡¬ç›˜
</span></span><span class="line"><span class="cl">; 0x30(1-4) - /dev/hd(1-4)  --ä»£è¡¨ç¬¬ä¸€ä¸ªç›˜çš„1-4ä¸ªåˆ†åŒº
</span></span><span class="line"><span class="cl">; 0x305 - /dev/hd5  --ä»£è¡¨æ•´ä¸ªç¬¬äºŒä¸ªç¡¬ç›˜
</span></span><span class="line"><span class="cl">; 0x30(6-9) - /dev/hd(6-9)  --ä»£è¡¨ç¬¬äºŒä¸ªç›˜çš„1-4ä¸ªåˆ†åŒº
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">; bootsectå¯åŠ¨ç¨‹åºå°†å®ƒè‡ªèº«ä»å†…å®¹0x07c00(BOOTSEG)å¤„å¤åˆ¶è‡³å†…å­˜0x9000(INITSEG)å¤„
</span></span><span class="line"><span class="cl">entry start            ;å…³é”®å­—entryå‘Šè¯‰é“¾æ¥å™¨&#34;ç¨‹åºå…¥å£&#34;
</span></span><span class="line"><span class="cl">start:
</span></span><span class="line"><span class="cl">	mov	ax,#BOOTSEG    ;BOOTSEG = 0x07c0 èµ‹å€¼ç»™axï¼Œ
</span></span><span class="line"><span class="cl">	mov	ds,ax          ;æºåœ°å€
</span></span><span class="line"><span class="cl">	mov	ax,#INITSEG    ;INITSEG = 0x9000 èµ‹å€¼ç»™bx
</span></span><span class="line"><span class="cl">	mov	es,ax		   ;ç›®æ ‡åœ°å€
</span></span><span class="line"><span class="cl">	mov	cx,#256        ;å¾ªç¯æ¬¡æ•°ï¼Œæ¯æ¬¡å¾ªç¯å®Œæ¬¡æ•°å‡ä¸€
</span></span><span class="line"><span class="cl">	sub	si,si          ;æ¸…é›¶
</span></span><span class="line"><span class="cl">	sub	di,di          ;æ¸…é›¶
</span></span><span class="line"><span class="cl">	rep				   ;repæ˜¯repeatï¼Œrepé…åˆ movw(movsb) å°±æ˜¯å¤šæ¬¡å¤åˆ¶ç›´åˆ°cx=0ä¸ºæ­¢ å¤åˆ¶çš„æ¬¡æ•°æ”¾åœ¨cxä¸­
</span></span><span class="line"><span class="cl">	movw               ;ç”¨äºæŠŠå†…å®¹ä»ds:si å¤åˆ¶es:di  ä»¥å­—ä½å•ä½
</span></span><span class="line"><span class="cl">	jmpi	go,INITSEG ;é—´æ¥è·³è½¬ å³ç¨‹åºè·³åˆ°9000:0 å»ç»§ç»­æ‰§è¡Œ  CS=INITSEGï¼ŒIP=go(åç§»åœ°å€)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">; ä»è¿™é‡Œå¼€å§‹cpuå·²ç»è·³åˆ°å†…å­˜0x90000å»æ‰§è¡Œï¼Œ
</span></span><span class="line"><span class="cl">; BIOSæŠŠå¼•å¯¼æ‰‡åŒºåŠ è½½åˆ°0x7c00å¤„å¹¶æŠŠæ‰§è¡Œæƒäº¤ç»™å¼•å¯¼ç¨‹åºï¼Œ(ss=0x00,sp=0xfffe)
</span></span><span class="line"><span class="cl">; å°†ds,es,ss,éƒ½è®¾ç½®æˆç§»åŠ¨åä»£ç æ‰€åœ¨æ®µ(0x9000)
</span></span><span class="line"><span class="cl">go:	mov	ax,cs          ;ax = cs = INITSEG = 0x9000
</span></span><span class="line"><span class="cl">	mov	ds,ax          ;æ•°æ®æ®µåœ°å€
</span></span><span class="line"><span class="cl">	mov	es,ax          ;é™„åŠ æ®µåœ°å€
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">! put stack at 0x9ff00. ;å°†å †æ ˆæŒ‡é’ˆspæŒ‡å‘0x9fff00(0x9000:0xff00)
</span></span><span class="line"><span class="cl">	mov	ss,ax           ;æ ˆæ®µåœ°å€
</span></span><span class="line"><span class="cl">; ä¿è¯æ ˆæŒ‡é’ˆspåªè¦æŒ‡å‘è¿œå¤§äº512byteå­—èŠ‚åç§»(å³åœ°å€0x90200)
</span></span><span class="line"><span class="cl">; å› ä¸ºåœ¨0x90200åè¦å­˜æ”¾setupç¨‹åºï¼Œå¤§çº¦ä¸º4ä¸ªæ‰‡åŒº spæŒ‡å‘å¤§äº(0x200+0x200*4+å †æ ˆå¤§å°)
</span></span><span class="line"><span class="cl">	mov	sp,#0xFF00		! arbitrary value &gt;&gt;512  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">! load the setup-sectors directly after the bootblock.
</span></span><span class="line"><span class="cl">; åœ¨bootsectç¨‹åºç´§è·Ÿç€åŠ è½½setupç¨‹åº
</span></span><span class="line"><span class="cl">! Note that &#39;es&#39; is already set up.
</span></span><span class="line"><span class="cl">; esåœ¨ç§»åŠ¨ä»£ç æ—¶è®¾ç½®å¥½äº†æŒ‡å‘ç›®çš„åœ°å€0x9000
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">; è¿™ä¸€æ®µä¸»è¦æ˜¯åˆ©ç”¨BIOSä¸­æ–­ INT 0x13 å°†setupæ¨¡å—ä»ç£ç›˜ç¬¬2ä¸ªæ‰‡åŒºå¼€å§‹è¯»åˆ°0x90200,
</span></span><span class="line"><span class="cl">; ä¸€ä¸ªå››ä¸ªæ‰‡åŒºï¼Œå¦‚æœè¯»é”™ï¼Œåˆ™å¤ä½é©±åŠ¨å™¨ï¼Œå¹¶é‡è¯•
</span></span><span class="line"><span class="cl">; INT 0x13 ä½¿ç”¨æ–¹æ³•ï¼š
</span></span><span class="line"><span class="cl">; è¯»æ‰‡åŒºï¼š
</span></span><span class="line"><span class="cl">; ah = 0x02 --è¯»ç£ç›˜æ‰‡åŒºåˆ°å†…å­˜
</span></span><span class="line"><span class="cl">; al = éœ€è¦è¯»å‡ºçš„æ‰‡åŒºæ•°é‡
</span></span><span class="line"><span class="cl">; ch = ç£é“(æŸ±é¢)å·ä½8ä½
</span></span><span class="line"><span class="cl">; cl = å¼€å§‹æ‰‡åŒº(ä½0-5)ï¼Œç£é“å·é«˜ä¸¤ä½(ä½6-7)
</span></span><span class="line"><span class="cl">; dh = ç£å¤´å·
</span></span><span class="line"><span class="cl">; dl = é©±åŠ¨å™¨å·(å¦‚æœæ˜¯ç¡¬ç›˜åˆ™ä½7è¦ç½®ä½)
</span></span><span class="line"><span class="cl">; es:bx--&gt;æŒ‡å‘æ•°æ®ç¼“å­˜åŒº ï¼Œå¦‚æœå‡ºé”™åˆ™CFæ ‡å¿—ç½®ä½ï¼Œahä¸­æ˜¯å‡ºé”™ç 
</span></span><span class="line"><span class="cl">load_setup:
</span></span><span class="line"><span class="cl">	mov	dx,#0x0000		! drive 0, head 0
</span></span><span class="line"><span class="cl">	mov	cx,#0x0002		! sector 2, track 0
</span></span><span class="line"><span class="cl">	mov	bx,#0x0200		! address = 512, in INITSEG
</span></span><span class="line"><span class="cl">	mov	ax,#0x0200+SETUPLEN	! service 2, nr of sectors
</span></span><span class="line"><span class="cl">	int	0x13			! read it
</span></span><span class="line"><span class="cl">; JNC:Jump Not Carry æ²¡è¿›ä½æ—¶è·³è½¬ æ­£ç¡®è¯»å–æ—¶CF=0
</span></span><span class="line"><span class="cl">	jnc	ok_load_setup		! ok - continue
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">; è¯»å–å‡ºé”™ï¼Œå¯¹é©±åŠ¨å™¨0è¿›è¡Œè¯»æ“ä½œ å¹¶é‡æ–°è¯»å–åŠ è½½setupç¨‹åº
</span></span><span class="line"><span class="cl">	mov	dx,#0x0000
</span></span><span class="line"><span class="cl">	mov	ax,#0x0000		! reset the diskette
</span></span><span class="line"><span class="cl">	int	0x13
</span></span><span class="line"><span class="cl">	j	load_setup      ! jmpæŒ‡ä»¤  è¿”å›åˆ°é‡æ–°åŠ è½½setupå¤„
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ok_load_setup:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">! Get disk drive parameters, specifically nr of sectors/track
</span></span><span class="line"><span class="cl">; å–ç£ç›˜é©±åŠ¨å™¨çš„å‚æ•°ï¼Œç‰¹åˆ«æ˜¯æ¯é“çš„æ‰‡åŒºæ•°é‡
</span></span><span class="line"><span class="cl">; å–ç£ç›˜é©±åŠ¨å™¨çš„å‚æ•° INT 0x13è°ƒç”¨æ ¼å¼å’Œè¿”å›ä¿¡æ¯ï¼š
</span></span><span class="line"><span class="cl">; è°ƒç”¨æ ¼å¼:
</span></span><span class="line"><span class="cl">; ah = 0x08        dl = é©±åŠ¨å™¨å·(å¦‚æœæ˜¯ç¡¬ç›˜åˆ™ä½7è¦ç½®ä½)
</span></span><span class="line"><span class="cl">; è¿”å›ä¿¡æ¯ï¼š
</span></span><span class="line"><span class="cl">; å¦‚æœå‡ºé”™ï¼Œåˆ™CFå€¼ä½ï¼Œå¹¶ä¸”ah = çŠ¶æ€ç 
</span></span><span class="line"><span class="cl">; ah = 0, al = 0  bl = é©±åŠ¨å™¨ç±»å‹(AT/PS2)
</span></span><span class="line"><span class="cl">; ch = ç£é“(æŸ±é¢)å·ä½8ä½
</span></span><span class="line"><span class="cl">; cl = å¼€å§‹æ‰‡åŒº(ä½0-5)ï¼Œç£é“å·é«˜ä¸¤ä½(ä½6-7)	
</span></span><span class="line"><span class="cl">; dh = æœ€å¤§ç£å¤´æ•° ï¼Œ   dl = é©±åŠ¨å™¨æ•°é‡
</span></span><span class="line"><span class="cl">; es:di---&gt;è½¯é©±ç£ç›˜å‚æ•°è¡¨
</span></span><span class="line"><span class="cl">	mov	dl,#0x00
</span></span><span class="line"><span class="cl">	mov	ax,#0x0800		! AH=8 is get drive parameters
</span></span><span class="line"><span class="cl">	int	0x13
</span></span><span class="line"><span class="cl">	mov	ch,#0x00
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">; è¿™æ¡æŒ‡ä»¤è¡¨ç¤ºä¸‹ä¸€æ¡æŒ‡ä»¤çš„æ“ä½œæ•°åœ¨csæ®µå¯„å­˜å™¨æ‰€æŒ‡çš„æ®µä¸­
</span></span><span class="line"><span class="cl">	seg cs
</span></span><span class="line"><span class="cl">; ä¿æŒæ¯ç£é“æ‰‡åŒºæ•° (cx = æ¯ç£é“æ‰‡åŒºæ•°)
</span></span><span class="line"><span class="cl">	mov	sectors,cx
</span></span><span class="line"><span class="cl">	mov	ax,#INITSEG
</span></span><span class="line"><span class="cl">; ç”±äºä¸Šé¢å–ç£é“å‚æ•°ä¸­æ–­æ”¹æ‰äº†esçš„å€¼ï¼Œè¿™é‡Œé‡æ–°å¤åˆ¶ï¼Œ 	
</span></span><span class="line"><span class="cl">	mov	es,ax
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">! Print some inane message
</span></span><span class="line"><span class="cl">; æ˜¾ç¤ºä¿¡æ¯ï¼š&#34;&#39;Loading system ...&#39;å›è½¦æ¢è¡Œ&#34; åŒ…æ‹¬å›è½¦æ¢è¡Œä¸€å…±24ä¸ªå­—ç¬¦
</span></span><span class="line"><span class="cl">; BIOSä¸­æ–­0x10åŠŸèƒ½å· ah= 0x03,è¯»å…‰æ ‡çš„ä½ç½®
</span></span><span class="line"><span class="cl">; è¾“å…¥:bh = é¡µå·
</span></span><span class="line"><span class="cl">; è¿”å›ï¼šch = æ‰«æå¼€å§‹çº¿ï¼Œcl = ç»“æŸå¼€å§‹çº¿,dh = è¡Œå·(0x00é¡¶ç«¯)ï¼Œdl=åˆ—å·(0x00æœ€å·¦è¾¹)
</span></span><span class="line"><span class="cl">ï¼
</span></span><span class="line"><span class="cl">; BIOSä¸­æ–­0x10åŠŸèƒ½å· ah= 0x13,æ˜¾ç¤ºå­—ç¬¦ä¸²
</span></span><span class="line"><span class="cl">; è¾“å…¥ï¼šal=æ”¾ç½®å…‰æ ‡çš„æ–¹å¼åŠè§„å®šå±æ€§ï¼Œ0x01--è¡¨ç¤ºä½¿ç”¨blä¸­çš„å±æ€§ï¼Œå…‰æ ‡åœåœ¨å­—ç¬¦ä¸²ç»“å°¾å¤„
</span></span><span class="line"><span class="cl">; es:bp æ­¤å¯„å­˜å™¨æŒ‡å‘è¦æ˜¾ç¤ºå­—ç¬¦ä¸²èµ·å§‹ä½ç½®å¤„
</span></span><span class="line"><span class="cl">; cx = æ˜¾ç¤ºçš„å­—ç¬¦ä¸²å­—ç¬¦æ•°
</span></span><span class="line"><span class="cl">; bh = æ˜¾ç¤ºé¡µé¢å· bl = å­—ç¬¦å±æ€§ dh = è¡Œå·ï¼Œdl=åˆ—å·
</span></span><span class="line"><span class="cl">	mov	ah,#0x03		! read cursor pos
</span></span><span class="line"><span class="cl">	xor	bh,bh           ! é¦–å…ˆè¯»å…‰æ ‡çš„ä½ç½®ï¼Œè¿”å›å…‰æ ‡ä½ç½®å€¼åœ¨dx
</span></span><span class="line"><span class="cl">	int	0x10            ï¼dh = è¡Œ(0-23)  dl = åˆ—(0-79) æ˜¾ç¤ºå­—ç¬¦ä¸²ä½¿ç”¨
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	mov	cx,#24          ! æ˜¾ç¤º24ä¸ªå­—ç¬¦
</span></span><span class="line"><span class="cl">	mov	bx,#0x0007		! page 0, attribute 7 (normal)
</span></span><span class="line"><span class="cl">	mov	bp,#msg1		! es:bp å¯„å­˜å™¨æŒ‡å‘è¦æ˜¾ç¤ºå­—ç¬¦ä¸²èµ·å§‹ä½ç½®å¤„
</span></span><span class="line"><span class="cl">	mov	ax,#0x1301	 	! write string, move cursor 
</span></span><span class="line"><span class="cl">	int	0x10
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">! ok, we&#39;ve written the message, now
</span></span><span class="line"><span class="cl">! we want to load the system (at 0x10000)
</span></span><span class="line"><span class="cl">; å°†systemåŠ è½½åˆ°0x10000
</span></span><span class="line"><span class="cl">	mov	ax,#SYSSEG
</span></span><span class="line"><span class="cl">	mov	es,ax		! segment of 0x010000 
</span></span><span class="line"><span class="cl">	call	read_it      ; è¯»ç£ç›˜ä¸Šsystemæ¨¡å—ï¼Œesä¸ºè¾“å…¥å‚æ•°
</span></span><span class="line"><span class="cl">	call	kill_motor   ; å…³é—­é©±åŠ¨å™¨é©¬è¾¾ï¼Œè¿™æ ·å°±å¯ä»¥çŸ¥é“é©±åŠ¨å™¨çš„çŠ¶æ€
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">! After that we check which root-device to use. If the device is
</span></span><span class="line"><span class="cl">! defined (!= 0), nothing is done and the given device is used.
</span></span><span class="line"><span class="cl">! Otherwise, either /dev/PS0 (2,28) or /dev/at0 (2,8), depending
</span></span><span class="line"><span class="cl">! on the number of sectors that the BIOS reports currently.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">; æ£€æµ‹ä½¿ç”¨çš„æ ¹æ–‡ä»¶ç³»ç»Ÿ
</span></span><span class="line"><span class="cl">; å¦‚æœå·²ç»æŒ‡å®šäº†è®¾å¤‡å¹¶ä¸”ä¸ç­‰äº0ï¼Œå°±ç›´æ¥ä½¿ç”¨ç»™å®šçš„è®¾å¤‡ï¼Œå¦åˆ™å°±éœ€è¦æŠ¥é“çš„æ¯ç£é“æ‰‡åŒºæ•°æ¥
</span></span><span class="line"><span class="cl">; ç¡®å®šæ˜¯ä½¿ç”¨/dev/PS0(2,28) è¿˜æ˜¯/dev/at0(2,8)
</span></span><span class="line"><span class="cl">; åœ¨Linuxä¸­è½¯é©±çš„ä¸»è®¾å¤‡æ˜¯2ï¼Œæ¬¡è®¾å¤‡ = type*4 + nr 
</span></span><span class="line"><span class="cl">; typeæ˜¯è½¯é©±çš„ç±»å‹(2--&gt;1.2MB,7--&gt;1,44MB)
</span></span><span class="line"><span class="cl">; nr(0-3)å¯¹åº”è½¯é©±A,B,C,D
</span></span><span class="line"><span class="cl">; /dev/PS0(2,28)---&gt;1.44mb Aé©±åŠ¨å™¨ï¼Œè®¾å¤‡å·0x21c  7*4+0 =28
</span></span><span class="line"><span class="cl">; /dev/at0(2,8)---&gt;1.2MB Aé©±åŠ¨å™¨ï¼Œè®¾å¤‡å·0x0208
</span></span><span class="line"><span class="cl">	seg cs
</span></span><span class="line"><span class="cl">	mov	ax,root_dev     ï¼å–508ï¼Œ509 byteå¤„çš„æ ¹è®¾å¤‡å·,root_devå®šä¹‰åœ¨è¿™é‡Œ
</span></span><span class="line"><span class="cl">	cmp	ax,#0
</span></span><span class="line"><span class="cl">	jne	root_defined    ï¼åˆ¤æ–­æ˜¯å¦è¢«å®šä¹‰ï¼Œæ¯å®šä¹‰è·³åˆ°å®šä¹‰å¤„
</span></span><span class="line"><span class="cl">	seg cs
</span></span><span class="line"><span class="cl">	mov	bx,sectors
</span></span><span class="line"><span class="cl">	mov	ax,#0x0208		! /dev/ps0 - 1.2Mb
</span></span><span class="line"><span class="cl">	cmp	bx,#15			! åˆ¤æ–­æ¯ç£é“æ‰‡åŒºæ•°æ˜¯å¦ç­‰äº15 ï¼Œsectorsç­‰äº15åˆ™æ˜¯1.2Mbé©±åŠ¨å™¨
</span></span><span class="line"><span class="cl">	je	root_defined
</span></span><span class="line"><span class="cl">	mov	ax,#0x021c		! /dev/PS0 - 1.44Mb
</span></span><span class="line"><span class="cl">	cmp	bx,#18          ! sectorsç­‰äº18åˆ™æ˜¯1.44Mbé©±åŠ¨å™¨
</span></span><span class="line"><span class="cl">	je	root_defined
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">; å¦‚æœéƒ½ä¸ä¸€æ ·ï¼Œåˆ™æ­»å¾ªç¯(æ­»æœº)
</span></span><span class="line"><span class="cl">undef_root:
</span></span><span class="line"><span class="cl">	jmp undef_root
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root_defined:
</span></span><span class="line"><span class="cl">	seg cs
</span></span><span class="line"><span class="cl">	mov	root_dev,ax      ï¼å°†æ£€æµ‹åˆ°çš„è®¾å¤‡å·ä¿å­˜åˆ°root_dev
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">! after that (everyting loaded), we jump to
</span></span><span class="line"><span class="cl">! the setup-routine loaded directly after
</span></span><span class="line"><span class="cl">! the bootblock:
</span></span><span class="line"><span class="cl">; åˆ°è¿™é‡Œï¼Œæ‰€æœ‰çš„ç¨‹åºéƒ½åŠ è½½å®Œæ¯•ï¼Œç„¶åè·³è½¬åˆ°åŠ è½½åˆ°bootsectåé¢çš„setupç¨‹åº
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	jmpi	0,SETUPSEG    ï¼ï¼ï¼ï¼ï¼ï¼æœ¬ç¨‹åºç»“æŸ
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">; ä¸‹é¢æ˜¯ä¸¤ä¸ªå­ç¨‹åºï¼Œ(read_it)ç”¨äºè¯»å–systemæ¨¡å—ï¼Œ(kill_moter)ç”¨äºå…³é—­è½¯ä»¶çš„é©¬è¾¾
</span></span><span class="line"><span class="cl">! This routine loads the system at address 0x10000, making sure
</span></span><span class="line"><span class="cl">! no 64kB boundaries are crossed. We try to load it as fast as
</span></span><span class="line"><span class="cl">! possible, loading whole tracks whenever we can.
</span></span><span class="line"><span class="cl">!
</span></span><span class="line"><span class="cl">! in:	es - starting address segment (normally 0x1000)
</span></span><span class="line"><span class="cl">!
</span></span><span class="line"><span class="cl">; è¯¥å­ç¨‹åºå°†ç³»ç»Ÿæ¨¡å—åŠ è½½åˆ°å†…å­˜åœ°å€0x10000å¤„ï¼Œå¹¶ç¡®å®šæ²¡æœ‰è·¨è¶Š64kbå†…å­˜è¾¹ç•Œ
</span></span><span class="line"><span class="cl">; å°½å¿«å¯èƒ½çš„åŠ è½½ï¼Œæ¯æ¬¡åŠ è½½æ•´æ¡ç£é“çš„æ•°æ®
</span></span><span class="line"><span class="cl">; è¾“å…¥ï¼šeså¼€å§‹å†…å­˜åœ°å€æ®µå€¼(ä¸€èˆ¬0x1000)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">; .wordå®šä¹‰ä¸€ä¸ªå­—å†…å­˜
</span></span><span class="line"><span class="cl">; (1+SETUPLEN)è¡¨ç¤ºå¼€å§‹å·²ç»è¯»è¿›ä¸€ä¸ªå¼•å¯¼æ‰‡åŒºå’Œsetupç¨‹åºæ‰€å çš„æ‰‡åŒºæ•°SETUPLEN 
</span></span><span class="line"><span class="cl">sread:	.word 1+SETUPLEN	! sectors read of current track å½“å‰ç£é“ä¸­å·²è¯»æ‰‡åŒºæ•°
</span></span><span class="line"><span class="cl">head:	.word 0			! current head  å½“å‰ç£å¤´å·
</span></span><span class="line"><span class="cl">track:	.word 0			! current track å½“å‰ç£é“å·
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">read_it:
</span></span><span class="line"><span class="cl">	mov ax,es
</span></span><span class="line"><span class="cl">	test ax,#0x0fff
</span></span><span class="line"><span class="cl">die:	jne die			! es must be at 64kB boundary
</span></span><span class="line"><span class="cl">	xor bx,bx		! bx is starting address within segment
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">rp_read:
</span></span><span class="line"><span class="cl">	mov ax,es
</span></span><span class="line"><span class="cl">	cmp ax,#ENDSEG		! have we loaded all yet?
</span></span><span class="line"><span class="cl">	jb ok1_read
</span></span><span class="line"><span class="cl">	ret
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ok1_read:
</span></span><span class="line"><span class="cl">	seg cs
</span></span><span class="line"><span class="cl">	mov ax,sectors
</span></span><span class="line"><span class="cl">	sub ax,sread
</span></span><span class="line"><span class="cl">	mov cx,ax
</span></span><span class="line"><span class="cl">	shl cx,#9
</span></span><span class="line"><span class="cl">	add cx,bx
</span></span><span class="line"><span class="cl">	jnc ok2_read
</span></span><span class="line"><span class="cl">	je ok2_read
</span></span><span class="line"><span class="cl">	xor ax,ax
</span></span><span class="line"><span class="cl">	sub ax,bx
</span></span><span class="line"><span class="cl">	shr ax,#9
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ok2_read:
</span></span><span class="line"><span class="cl">	call read_track
</span></span><span class="line"><span class="cl">	mov cx,ax
</span></span><span class="line"><span class="cl">	add ax,sread
</span></span><span class="line"><span class="cl">	seg cs
</span></span><span class="line"><span class="cl">	cmp ax,sectors
</span></span><span class="line"><span class="cl">	jne ok3_read
</span></span><span class="line"><span class="cl">	mov ax,#1
</span></span><span class="line"><span class="cl">	sub ax,head
</span></span><span class="line"><span class="cl">	jne ok4_read
</span></span><span class="line"><span class="cl">	inc track
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ok4_read:
</span></span><span class="line"><span class="cl">	mov head,ax
</span></span><span class="line"><span class="cl">	xor ax,ax
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ok3_read:
</span></span><span class="line"><span class="cl">	mov sread,ax
</span></span><span class="line"><span class="cl">	shl cx,#9
</span></span><span class="line"><span class="cl">	add bx,cx
</span></span><span class="line"><span class="cl">	jnc rp_read
</span></span><span class="line"><span class="cl">	mov ax,es
</span></span><span class="line"><span class="cl">	add ax,#0x1000
</span></span><span class="line"><span class="cl">	mov es,ax
</span></span><span class="line"><span class="cl">	xor bx,bx
</span></span><span class="line"><span class="cl">	jmp rp_read
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">read_track:
</span></span><span class="line"><span class="cl">	push ax
</span></span><span class="line"><span class="cl">	push bx
</span></span><span class="line"><span class="cl">	push cx
</span></span><span class="line"><span class="cl">	push dx
</span></span><span class="line"><span class="cl">	mov dx,track
</span></span><span class="line"><span class="cl">	mov cx,sread
</span></span><span class="line"><span class="cl">	inc cx
</span></span><span class="line"><span class="cl">	mov ch,dl
</span></span><span class="line"><span class="cl">	mov dx,head
</span></span><span class="line"><span class="cl">	mov dh,dl
</span></span><span class="line"><span class="cl">	mov dl,#0
</span></span><span class="line"><span class="cl">	and dx,#0x0100
</span></span><span class="line"><span class="cl">	mov ah,#2
</span></span><span class="line"><span class="cl">	int 0x13
</span></span><span class="line"><span class="cl">	jc bad_rt
</span></span><span class="line"><span class="cl">	pop dx
</span></span><span class="line"><span class="cl">	pop cx
</span></span><span class="line"><span class="cl">	pop bx
</span></span><span class="line"><span class="cl">	pop ax
</span></span><span class="line"><span class="cl">	ret
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">bad_rt:	mov ax,#0
</span></span><span class="line"><span class="cl">	mov dx,#0
</span></span><span class="line"><span class="cl">	int 0x13
</span></span><span class="line"><span class="cl">	pop dx
</span></span><span class="line"><span class="cl">	pop cx
</span></span><span class="line"><span class="cl">	pop bx
</span></span><span class="line"><span class="cl">	pop ax
</span></span><span class="line"><span class="cl">	jmp read_track  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/*
</span></span><span class="line"><span class="cl"> * This procedure turns off the floppy drive motor, so
</span></span><span class="line"><span class="cl"> * that we enter the kernel in a known state, and
</span></span><span class="line"><span class="cl"> * don&#39;t have to worry about it later.
</span></span><span class="line"><span class="cl"> */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> ; è¿™ä¸ªç¨‹åºç”¨äºå…³é—­è½¯ä»¶é©¬è¾¾ï¼Œè¿™æ ·è¿›å…¥å†…æ ¸å°±å¯ä»¥çŸ¥é“å®ƒæ‰€å¤„çš„çŠ¶æ€
</span></span><span class="line"><span class="cl">kill_motor:
</span></span><span class="line"><span class="cl">	push dx
</span></span><span class="line"><span class="cl">	mov dx,#0x3f2         !è½¯ä»¶æ§åˆ¶å¡çš„æ•°å­—è¾“å‡ºå¯„å­˜å™¨(DOR)ç«¯å£ï¼Œåªå†™
</span></span><span class="line"><span class="cl">	mov al,#0
</span></span><span class="line"><span class="cl">	outb
</span></span><span class="line"><span class="cl">	pop dx
</span></span><span class="line"><span class="cl">	ret
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sectors:
</span></span><span class="line"><span class="cl">	.word 0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">msg1:                           ! è°ƒç”¨BIOSä¸­æ–­æ˜¾ç¤ºä¿¡æ¯
</span></span><span class="line"><span class="cl">	.byte 13,10                 ! å›è½¦æ¢è¡Œçš„asciiç 
</span></span><span class="line"><span class="cl">	.ascii &#34;Loading system ...&#34; ï¼ æ˜¾ç¤ºå­—ç¬¦ä¸²
</span></span><span class="line"><span class="cl">	.byte 13,10,13,10           ï¼ä¸€ä¸ª24ä¸ªå­—ç¬¦
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">; è¡¨ç¤ºä¸‹é¢è¯­å¥ä»åœ°å€508(0x1fc)å¼€å§‹ï¼Œæ‰€ä»¥root_devåœ¨å¯åŠ¨æ‰‡åŒºçš„ç¬¬508å¼€å§‹çš„2ä¸ªå­—èŠ‚ä¸­
</span></span><span class="line"><span class="cl">.org 508
</span></span><span class="line"><span class="cl">root_dev:
</span></span><span class="line"><span class="cl">	.word ROOT_DEV               ï¼å­˜æ”¾æ ¹æ–‡ä»¶ç³»ç»Ÿæ‰€åœ¨è®¾å¤‡å·(init/main.cä¸­ä¼šç”¨)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">; ä¸‹é¢æ˜¯å¯åŠ¨ç›˜å…·æœ‰æœ‰æ•ˆå¼•å¯¼æ‰‡åŒºçš„æ ‡å¿—ï¼Œåœ¨BIOSç¨‹åºåŠ è½½å¼•å¯¼æ‰‡åŒºæ—¶è¯†åˆ«ä½¿ç”¨ï¼Œ
</span></span><span class="line"><span class="cl">; å®ƒå¿…é¡»ä½äºå¼•å¯¼æ‰‡åŒºçš„æœ€åä¸¤ä¸ªå­—èŠ‚ä¸­
</span></span><span class="line"><span class="cl">boot_flag:
</span></span><span class="line"><span class="cl">	.word 0xAA55
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">.text
</span></span><span class="line"><span class="cl">endtext:
</span></span><span class="line"><span class="cl">.data
</span></span><span class="line"><span class="cl">enddata:
</span></span><span class="line"><span class="cl">.bss
</span></span><span class="line"><span class="cl">endbss:
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="æ“ä½œç³»ç»ŸåŠ è½½---setup">æ“ä½œç³»ç»ŸåŠ è½½&mdash;setup<a hidden class="anchor" aria-hidden="true" href="#æ“ä½œç³»ç»ŸåŠ è½½---setup">#</a></h1>
<h2 id="1ç®€ä»‹-1">1.ç®€ä»‹<a hidden class="anchor" aria-hidden="true" href="#1ç®€ä»‹-1">#</a></h2>
<p>ä½œç”¨ï¼š<strong>setup.sæ˜¯æ“ä½œç³»ç»ŸåŠ è½½ç¨‹åºï¼Œå®ƒçš„ä½œç”¨æ˜¯åˆ©ç”¨ROM BIOSä¸­æ–­è¯»å–ç³»ç»Ÿæ•°æ®ï¼Œå¹¶å°†è¿™äº›æ•°æ®ä¿å­˜åˆ°0x90000å¼€å§‹çš„ä½ç½®å¤„(è¦†ç›–äº†åŸæ¥bootsectç¨‹åºæ‰€åœ¨çš„åœ°æ–¹)</strong></p>
<p>è¯»å–åˆ°æ•°æ®ä¿å­˜çš„ä½ç½®:
<img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012320500.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"  />
</p>
<p>å°†è¯»å–åˆ°çš„æ•°æ®ä¿å­˜åï¼Œ==setupå°†systemæ¨¡å—ä»0x10000-0x8ffffæ•´å—ç§»åŠ¨åˆ°å†…å­˜ç»å¯¹åœ°å€0x00000å¤„==ã€‚
ç„¶ååŠ è½½ä¸­æ–­æè¿°ç¬¦è¡¨å¯„å­˜å™¨(idir)å’Œå…¨å±€æè¿°ç¬¦è¡¨å¯„å­˜å™¨(gdtr)ï¼Œå¼€å¯A20åœ°å€çº¿ï¼Œé‡æ–°è®¾ç½®ä¸¤ä¸ªä¸­æ–­æ§åˆ¶èŠ¯ç‰‡8259Aï¼Œå°†ç¡¬ä»¶ä¸­æ–­å·é‡æ–°è®¾ç½®ä¸º0x20-0x2fã€‚å†è®¾ç½®cpuçš„æ§åˆ¶å¯„å­˜å™¨CR0(æœºå™¨çŠ¶æ€å­—)ï¼Œä»è€Œè¿›å…¥32ä½ä¿æŠ¤æ¨¡å¼ï¼Œå¹¶è·³åˆ°systemæ¨¡å—æœ€å‰é¢éƒ¨åˆ†çš„head.sç¨‹åºç»§ç»­è¿è¡Œã€‚</p>
<p>ä¸ºäº†èƒ½è®©head.såœ¨32ä½ä¿æŠ¤æ¨¡å¼ä¸‹è¿è¡Œï¼Œåœ¨ç¨‹åºä¸­ä¸´æ—¶è®¾ç½®ä¸­æ–­æè¿°ç¬¦(IDT)å’Œå…¨å±€æè¿°ç¬¦è¡¨(GDT)ï¼Œå¹¶åœ¨GDTä¸­è®¾ç½®å½“å‰å†…æ ¸ä»£ç æ®µçš„æè¿°ç¬¦å’Œæ•°æ®æ®µçš„æè¿°ç¬¦ã€‚</p>
<p><strong>GDT</strong>
æ®µæè¿°ç¬¦å­˜æ”¾åœ¨æè¿°ç¬¦è¡¨ä¸­ã€‚æè¿°ç¬¦è¡¨å…¶å®å°±æ˜¯å†…å­˜ä¸­æè¿°ç¬¦é¡¹çš„ä¸€ä¸ªé˜µåˆ—ã€‚</p>
<p><strong>æè¿°ç¬¦è¡¨æœ‰ä¸¤ç±»ï¼šå…¨å±€æè¿°ç¬¦è¡¨(Global descriptor table-GDT)å’Œå±€éƒ¨æè¿°ç¬¦è¡¨(Local descriptor tableâˆ’LDT)ã€‚</strong></p>
<p>å¤„ç†å™¨æ˜¯é€šè¿‡ä½¿ç”¨GDTRå’ŒLDTRå¯„å­˜å™¨æ¥å®šä½GDTè¡¨å’Œå½“å‰çš„LDTè¡¨ã€‚</p>
<p>è¿™ä¸¤ä¸ªå¯„å­˜å™¨ä»¥çº¿æ€§åœ°å€çš„æ–¹å¼ä¿å­˜äº†æè¿°ç¬¦è¡¨çš„åŸºåœ°å€å’Œè¡¨çš„é•¿åº¦ã€‚</p>
<p>æŒ‡ä»¤Igdå’Œsgdç”¨äºè®¿é—®GDTRå¯„å­˜å™¨ï¼› æŒ‡ä»¤Hdtå’Œslutç”¨äºè®¿é—®LDTRå¯„å­˜å™¨ã€‚ lgdä½¿ç”¨å†…å­˜ä¸­ä¸€ä¸ª6å­—èŠ‚æ“ä½œæ•°æ¥åŠ è½½GDTRå¯„å­˜å™¨ã€‚å¤´ä¸¤ä¸ªå­—èŠ‚ä»£è¡¨æè¿°ç¬¦è¡¨çš„é•¿åº¦ï¼Œå4ä¸ªå­—èŠ‚æ˜¯æè¿°ç¬¦è¡¨çš„åŸºåœ°å€ã€‚ä½†ï¼Œè®¿é—®LDTRå¯„å­˜å™¨çš„æŒ‡ä»¤lutæ‰€ä½¿ç”¨çš„æ“ä½œæ•°å´æ˜¯ä¸€ä¸ª2å­—èŠ‚çš„æ“ä½œæ•°ï¼Œè¡¨ç¤ºå…¨å±€æè¿°ç¬¦è¡¨GDTä¸­ä¸€ä¸ªæè¿°ç¬¦é¡¹çš„é€‰æ‹©ç¬¦ã€‚è¯¥é€‰æ‹©ç¬¦æ‰€å¯¹åº”çš„GDTè¡¨ä¸­çš„æè¿°ç¬¦é¡¹åº”è¯¥å¯¹åº”ä¸€ä¸ªå±€éƒ¨æè¿°ç¬¦è¡¨ã€‚</p>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012320505.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"  />
</p>
<p>setupè®¾ç½®çš„GDTæè¿°ç¬¦é¡¹ï¼Œä»£ç æ®µæè¿°ç¬¦çš„å€¼æ˜¯0x00C09A0000007FF,</p>
<p>è¡¨ç¤ºä»£ç æ®µçš„é™é•¿æ˜¯ 8MB(=(0x7F+1)âˆ—4KB, è¿™é‡ŒåŠ 1æ˜¯å› ä¸ºé™é•¿å€¼æ˜¯ä»0å¼€å§‹ç®—èµ·çš„ï¼Œæ®µåœ¨çº¿æ€§åœ°å€ç©ºé—´ä¸­çš„åŸºå€æ˜¯0ï¼Œæ®µç±»å‹å€¼009Aè¡¨ç¤ºè¯¥æ®µå­˜åœ¨äºå†…å­˜ä¸­ã€æ®µçš„ç‰¹æƒçº§åˆ«ä¸º0ã€æ®µç±»å‹æ˜¯å¯è¯»å¯æ‰§è¡Œçš„ä»£ç æ®µï¼Œæ®µä»£ç æ˜¯32ä½çš„å¹¶ä¸”æ®µçš„é¢—ç²’åº¦æ˜¯4KBã€‚</p>
<p>æ•°æ®æ®µæè¿°ç¬¦çš„å€¼æ˜¯0x00C0920000007FFï¼Œè¡¨ç¤ºæ•°æ®æ®µçš„é™é•¿æ˜¯8MBâ€¦æ®µåœ¨çº¿æ€§åœ°å€ç©ºé—´ä¸­çš„åŸºå€æ˜¯0ã€‚æ®µç±»å‹å€¼0x92è¡¨ç¤ºè¯¥æ®µå­˜åœ¨äºå†…å­˜ä¸­ã€æ®µçš„ç‰¹æƒçº§åˆ«ä¸º0ã€æ®µç±»å‹æ˜¯å¯è¯»å¯å†™çš„æ•°æ®æ®µã€æ®µä»£ç æ˜¯32ä½çš„å¹¶ä¸”æ®µçš„é¢—ç²’åº¦æ˜¯4KBã€‚</p>
<p>é€»è¾‘åœ°å€çš„é€‰æ‹©ç¬¦éƒ¨åˆ†ç”¨äºæŒ‡å®šä¸€æè¿°ç¬¦ï¼Œå®ƒæ˜¯é€šè¿‡æŒ‡å®šä¸€æè¿°ç¬¦è¡¨å¹¶ä¸”ç´¢å¼•å…¶ä¸­çš„ä¸€ä¸ªæè¿°ç¬¦é¡¹å®Œæˆçš„ã€‚</p>
<p>æ®µé€‰æ‹©ç¬¦æ ¼å¼ï¼š</p>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012320515.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"  />
</p>
<p>å…¶ä¸­ç´¢å¼•å€¼ç”¨äºæŒ‡å®šæè¿°ç¬¦è¡¨ä¸­8192(2**13)ä¸ªæè¿°ç¬¦ä¸­çš„ä¸€ä¸ªã€‚</p>
<p>å¤„ç†å™¨å°†è¯¥ç´¢å¼•å€¼ä¹˜ä¸Š8ï¼Œå¹¶åŠ ä¸Šæè¿°ç¬¦è¡¨çš„åŸºåœ°å€å³å¯è®¿é—®è¡¨ä¸­æŒ‡å®šçš„æ®µæè¿°ç¬¦ã€‚</p>
<p>è¡¨æŒ‡ç¤ºå™¨(Table Indicator - TD)ç”¨äºæŒ‡å®šé€‰æ‹©ç¬¦æ‰€å¼•ç”¨çš„æè¿°ç¬¦è¡¨ã€‚å€¼ä¸º0è¡¨ç¤ºæŒ‡å®šGDTè¡¨ï¼Œå€¼ä¸º1è¡¨ç¤ºæŒ‡å®šå½“å‰çš„LDTè¡¨ã€‚è¯·æ±‚è€…ç‰¹æƒçº§ï¼ˆR capaestorâ€™sPrivalege Level-RPL)ç”¨äºä¿æŠ¤æœºåˆ¶ã€‚</p>
<p>ç”±äºGDTè¡¨çš„ç¬¬ä¸€é¡¹(ç´¢å¼•å€¼ä¸º0)æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œå› æ­¤ä¸€ä¸ªå…·æœ‰ç´¢å¼•å€¼0å’Œè¡¨æŒ‡ç¤ºå™¨å€¼ä¹Ÿä¸º0çš„é€‰æ‹©ç¬¦(ä¹Ÿå³æŒ‡å‘GDTçš„ç¬¬ä¸€é¡¹çš„é€‰æ‹©ç¬¦)å¯ä»¥ç”¨ä½œä¸ºä¸€ä¸ªç©º(null)é€‰æ‹©ç¬¦ã€‚å½“ä¸€ä¸ªæ®µå¯„å­˜å™¨(ä¸èƒ½æ˜¯ CSæˆ–SS)åŠ è½½äº†ä¸€ä¸ªç©ºé€‰æ‹©ç¬¦æ—¶ï¼Œå¤„ç†å™¨å¹¶ä¸ä¼šäº§ç”Ÿä¸€ä¸ªå¼‚å¸¸ã€‚ä½†æ˜¯è‹¥ä½¿ç”¨è¿™ä¸ªæ®µå¯„å­˜å™¨è®¿é—®å†…å­˜æ—¶å°±ä¼šäº§ç”Ÿä¸€ä¸ªå¼‚å¸¸ã€‚å¯¹äºåˆå§‹åŒ–è¿˜æœªä½¿ç”¨çš„æ®µå¯„å­˜å™¨ä»¥é™·å…¥æ„å¤–çš„å¼•ç”¨æ¥è¯´ï¼Œè¿™ä¸ªç‰¹æ€§æ˜¯å¾ˆæœ‰ç”¨çš„ã€‚</p>
<p>åœ¨è¿›å…¥ä¿æŠ¤æ¨¡å¼ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»é¦–å…ˆè®¾ç½®å¥½å°†è¦ç”¨åˆ°çš„æ®µæè¿°ç¬¦è¡¨ï¼Œä¾‹å¦‚å…¨å±€æè¿°ç¬¦è¡¨GDTã€‚ç„¶åä½¿ç”¨æŒ‡ä»¤lgdtæŠŠæè¿°ç¬¦è¡¨çš„åŸºåœ°å€å‘ŠçŸ¥CPU(GDTè¡¨çš„åŸºåœ°å€å­˜å…¥gçŸ¥å¯„å­˜å™¨)ã€‚å†å°†æœºå™¨çŠ¶æ€å­—çš„ä¿æŠ¤æ¨¡å¼æ ‡å¿—ç½®ä½å³å¯è¿›å…¥32ä½ä¿æŠ¤è¿è¡Œæ¨¡å¼ã€‚</p>
<p><strong>Linux 0.11ç¡¬ç›˜è®¾å¤‡å·</strong></p>
<p>åœ¨Linuxä¸­ï¼Œç¡¬ç›˜çš„ä¸»åŒºå·æ˜¯3ï¼Œå…¶ä»–è®¾å¤‡çš„ä¸»è®¾å¤‡å·åˆ†åˆ«ä¸ºï¼š</p>
<blockquote>
<p>1â€“å†…å­˜
2â€“ç£ç›˜
3â€“ç¡¬ç›˜
4â€“ttyx
5â€“tty
6â€“å¹¶è¡Œå£
7â€“éå‘½åç®¡é“</p>
</blockquote>
<p>ä¸€ä¸ªç¡¬ç›˜å¯ä»¥æœ‰1-4ä¸ªåˆ†åŒºï¼Œå¯ä»¥ä¾æ®åˆ†åŒºçš„ä¸åŒç”¨æ¬¡è®¾å¤‡å·è¿›è¡ŒæŒ‡å®šåˆ†åŒºï¼Œæ‰€ä»¥ï¼šè®¾å¤‡å·=ä¸»è®¾å¤‡å·*256+æ¬¡è®¾å¤‡å·</p>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012320525.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"  />
</p>
<p><strong>ç£ç›˜</strong></p>
<p>ä¸€ä¸ªç£ç›˜ç”±å¤šä¸ªç›˜ç‰‡ï¼ˆå¦‚ä¸‹å›¾ä¸­çš„ 0 å·ç›˜ç‰‡ï¼‰å åŠ è€Œæˆã€‚ç›˜ç‰‡çš„è¡¨é¢æ¶‚æœ‰ç£æ€§ç‰©è´¨ï¼Œè¿™äº›ç£æ€§ç‰©è´¨ç”¨æ¥è®°å½•äºŒè¿›åˆ¶æ•°æ®ã€‚å› ä¸ºæ­£åä¸¤é¢éƒ½å¯æ¶‚ä¸Šç£æ€§ç‰©è´¨ï¼Œæ•…ä¸€ä¸ªç›˜ç‰‡å¯èƒ½ä¼šæœ‰ä¸¤ä¸ªç›˜é¢</p>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012320518.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"  />
</p>
<p>æ¯ä¸ªç›˜ç‰‡è¢«åˆ’åˆ†ä¸ºä¸€ä¸ªä¸ª<strong>ç£é“</strong>ï¼Œæ¯ä¸ªç£é“åˆåˆ’åˆ†ä¸ºä¸€ä¸ªä¸ª<strong>æ‰‡åŒº</strong></p>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012320532.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"  />
</p>
<p><strong>æŸ±é¢</strong></p>
<p>æ¯ä¸ªç›˜é¢å¯¹åº”ä¸€ä¸ªç£å¤´ã€‚æ‰€æœ‰çš„ç£å¤´éƒ½æ˜¯è¿åœ¨åŒä¸€ä¸ªç£è‡‚ä¸Šçš„ï¼Œå› æ­¤æ‰€æœ‰ç£å¤´åªèƒ½â€œå…±è¿›é€€â€ã€‚æ‰€æœ‰ç›˜é¢ä¸­ç›¸å¯¹ä½ç½®ç›¸åŒçš„ç£é“ç»„æˆæŸ±é¢</p>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012320853.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"  />
</p>
<p>ç£ç›˜çš„ç‰©ç†åœ°å€</p>
<p>å¯ç”¨ï¼ˆæŸ±é¢å·ï¼Œç›˜é¢å·ï¼Œæ‰‡åŒºå·ï¼‰æ¥å®šä½ä»»æ„ä¸€ä¸ªâ€œç£ç›˜å—â€</p>
<p>å¯æ ¹æ®è¯¥åœ°å€è¯»å–ä¸€ä¸ªâ€œå—â€ï¼Œæ“ä½œå¦‚ä¸‹ï¼š</p>
<p>â‘  æ ¹æ®â€œæŸ±é¢å·â€ç§»åŠ¨ç£è‡‚ï¼Œè®©ç£å¤´æŒ‡å‘æŒ‡å®šæŸ±é¢ï¼›</p>
<p>â‘¡ æ¿€æ´»æŒ‡å®šç›˜é¢å¯¹åº”çš„ç£å¤´ï¼›</p>
<p>â‘¢ ç£ç›˜æ—‹è½¬çš„è¿‡ç¨‹ä¸­ï¼ŒæŒ‡å®šçš„æ‰‡åŒºä¼šä»ç£å¤´ä¸‹é¢åˆ’è¿‡ï¼Œè¿™æ ·å°±å®Œæˆäº†å¯¹æŒ‡å®šæ‰‡åŒºçš„è¯»/å†™</p>
<h2 id="2æºç åˆ†æ">2.æºç åˆ†æ<a hidden class="anchor" aria-hidden="true" href="#2æºç åˆ†æ">#</a></h2>
<p><strong>1.setupå®ŒæˆOSå‰çš„åˆå§‹åŒ–å’Œè®¾ç½®</strong></p>
<blockquote>
<p>1)ä¿å­˜å…‰æ ‡çš„ä½ç½®
2)å¾—åˆ°æ‰©å±•å†…å­˜çš„å¤§å°
3)å¾—åˆ°æ˜¾ç¤ºå¡å½“å‰çš„æ˜¾ç¤ºæ¨¡å¼
4)æ£€æµ‹æ˜¾ç¤ºæ–¹å¼
5)è¯»å–ç¡¬ç›˜å‚æ•°è¡¨ä¿¡æ¯</p>
</blockquote>
<p>ç¡¬ç›˜åŸºæœ¬å‚æ•°è¡¨(INT 0x41)</p>
<p>åœ¨ä¸­æ–­å‘é‡è¡¨ä¸­ï¼Œint 0x41çš„ä¸­æ–­å‘é‡ä½ç½®ï¼ˆ4*0x41=0x0000:0x0140ï¼‰å­˜æ”¾çš„ä¸æ˜¯ä¸­æ–­ç¨‹åºçš„åœ°å€å…¥å£ï¼Œè€Œæ˜¯ç¬¬ä¸€ä¸ªç¡¬ç›˜å‚æ•°è¡¨çš„ä¿¡æ¯ï¼Œ0x46å­˜æ”¾ç¬¬äºŒä¸ªç¡¬ç›˜å‚æ•°è¡¨</p>
<p>ç¡¬ç›˜å‚æ•°è¡¨ä¿¡æ¯ï¼š</p>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012320869.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"  />
</p>
<p><strong>2.å°†æ•´ä¸ªsystemæ¨¡å—ç§»åŠ¨åˆ°0x00000å¤„</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">; bootsectå¼•å¯¼ç¨‹åºå°†systemæ¨¡å—ç§»åŠ¨åˆ°(0x10000)å¤„ï¼Œ
</span></span><span class="line"><span class="cl">; å¹¶æŠŠè‡ªå·±ç§»åŠ¨åˆ°(0x90000)å¤„ï¼ŒæŠŠsetupåŠ è½½åœ¨å®ƒåé¢
</span></span><span class="line"><span class="cl">; ä¸‹é¢è¿™æ®µç¨‹åºå°†æ•´ä¸ªsystemæ¨¡å—ç§»åŠ¨åˆ°0x00000å¤„ï¼Œ
</span></span><span class="line"><span class="cl">; å³æŠŠä»0x10000åˆ°0x8ffffçš„å†…å­˜æ•°æ®å—æ•´å—çš„å‘å†…å­˜åœ°å€ä½ç«¯ç§»åŠ¨äº†0x10000çš„ä½ç½®
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	mov	ax,#0x0000
</span></span><span class="line"><span class="cl">	cld			! &#39;direction&#39;=0, movs moves forward
</span></span><span class="line"><span class="cl">do_move:
</span></span><span class="line"><span class="cl">	mov	es,ax		! destination segment
</span></span><span class="line"><span class="cl">	add	ax,#0x1000
</span></span><span class="line"><span class="cl">	cmp	ax,#0x9000  ! åˆ¤æ–­ä»£ç æ˜¯å¦ç§»åŠ¨å®Œæˆ
</span></span><span class="line"><span class="cl">	jz	end_move    ! ç§»åŠ¨å®Œæˆåˆ™è·³è½¬
</span></span><span class="line"><span class="cl">	mov	ds,ax		! source segment
</span></span><span class="line"><span class="cl">	sub	di,di
</span></span><span class="line"><span class="cl">	sub	si,si
</span></span><span class="line"><span class="cl">	mov 	cx,#0x8000   ! å¾ªç¯ç§»åŠ¨ï¼Œå¾ªç¯æ¬¡æ•°ï¼Œæ¯æ¬¡å¾ªç¯å®Œæ¬¡æ•°å‡ ç§»åŠ¨0x8000å­—
</span></span><span class="line"><span class="cl">	rep				! ç”¨äºæŠŠå†…å®¹ä»ds:si å¤åˆ¶es:di  ä»¥å­—èŠ‚å•ä½
</span></span><span class="line"><span class="cl">	movsw           ! repæ˜¯repeatï¼Œrepé…åˆ movw(movsb) å°±æ˜¯å¤šæ¬¡å¤åˆ¶ç›´åˆ°cx=0ä¸ºæ­¢ å¤åˆ¶çš„æ¬¡æ•°æ”¾åœ¨cxä¸­
</span></span><span class="line"><span class="cl">	jmp	do_move
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç§»åŠ¨åå†…å­˜å­˜æ”¾æ•°æ®ï¼š</p>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012320891.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"  />
</p>
<p><strong>3.è·³è½¬åˆ°ç»å¯¹åœ°å€0x00000å¤„</strong></p>
<p>åœ¨è·³è½¬ä¹‹å‰è¿˜è¦è¿›è¡Œç›¸åº”çš„è®¾ç½®</p>
<blockquote>
<p>1)åŠ è½½æ®µæè¿°ç¬¦ï¼Œè®¾ç½®å…¨å±€æè¿°ç¬¦è¡¨å’Œä¸­æ–­æè¿°è¡¨
2)å¼€å¯A20åœ°å€çº¿ï¼Œä¸ºäº†èƒ½å¤Ÿè®¿é—®å’Œä½¿ç”¨1MBä»¥ä¸Šçš„ç‰©ç†å†…å­˜
3)é‡æ–°å¯¹ä¸­æ–­è¿›è¡Œç¼–ç¨‹</p>
</blockquote>
<p>è¿›å…¥ä¿æŠ¤æ¨¡å¼ï¼šjmpi 0,8</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">;è¿›å…¥ä¿æŠ¤æ¨¡å¼ï¼Œåªæ˜¯è·³è½¬åˆ°ç»å¯¹åœ°å€0x00000å¤„
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">; åŠ è½½æœºå™¨çŠ¶æ€å­—(æ§åˆ¶å¯„å­˜å™¨CR0)ï¼Œå°†0ä½ç½®1ï¼ŒCPUåˆ‡æ¢åˆ°ä¿æŠ¤æ¨¡å¼
</span></span><span class="line"><span class="cl">	mov	ax,#0x0001	! protected mode (PE) bit ä¿æŠ¤æ¨¡å¼æ¯”ç‰¹ä½(PE)
</span></span><span class="line"><span class="cl">	lmsw	ax		! This is it!             åŠ è½½çŠ¶æ€å¯„å­˜å™¨
</span></span><span class="line"><span class="cl">	;æ®µé€‰æ‹©ç¬¦8è¡¨ç¤ºè¯·æ±‚ç‰¹æƒ0çº§ï¼Œä½¿ç”¨GDTç¬¬äºŒä¸ªæ®µæè¿°ç¬¦
</span></span><span class="line"><span class="cl">	jmpi	0,8		! jmp offset 0 of segment 8 (cs)  è·³è½¬è‡³csæ®µåç§»åœ°å€ä½0å¤„(systemå·²ç»ç§»åŠ¨åˆ°0x00000å¤„)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="setupç¨‹åºå®Œæ•´ä»£ç ">setupç¨‹åºå®Œæ•´ä»£ç <a hidden class="anchor" aria-hidden="true" href="#setupç¨‹åºå®Œæ•´ä»£ç ">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">!
</span></span><span class="line"><span class="cl">!	setup.s		(C) 1991 Linus Torvalds
</span></span><span class="line"><span class="cl">!
</span></span><span class="line"><span class="cl">! setup.s is responsible for getting the system data from the BIOS,
</span></span><span class="line"><span class="cl">! and putting them into the appropriate places in system memory.
</span></span><span class="line"><span class="cl">! both setup.s and system has been loaded by the bootblock.
</span></span><span class="line"><span class="cl">!
</span></span><span class="line"><span class="cl">! This code asks the bios for memory/disk/other parameters, and
</span></span><span class="line"><span class="cl">! puts them in a &#34;safe&#34; place: 0x90000-0x901FF, ie where the
</span></span><span class="line"><span class="cl">! boot-block used to be. It is then up to the protected mode
</span></span><span class="line"><span class="cl">! system to read them from there before the area is overwritten
</span></span><span class="line"><span class="cl">! for buffer-blocks.
</span></span><span class="line"><span class="cl">!
</span></span><span class="line"><span class="cl">; setupä»BIOSä¸­è·å–æ•°æ®ï¼Œå¹¶å°†è¿™äº›æ•°æ®ä¿å­˜åˆ°0x90000å¼€å§‹çš„ä½ç½®å¤„(0x90000-0x901FFè¦†ç›–äº†åŸæ¥bootsectç¨‹åºæ‰€åœ¨çš„åœ°æ–¹)
</span></span><span class="line"><span class="cl">; æ­¤æ—¶setupå’Œsystemå·²ç»ç”±bootsectå¼•å¯¼å—åŠ è½½åˆ°å†…å­˜ä¸­
</span></span><span class="line"><span class="cl">; 
</span></span><span class="line"><span class="cl">! NOTE! These had better be the same as in bootsect.s!
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">INITSEG  = 0x9000	! we move boot here - out of the way åŸæ¥bootsectæ‰€åœ¨æ®µ
</span></span><span class="line"><span class="cl">SYSSEG   = 0x1000	! system loaded at 0x10000 (65536).   systemæ‰€åœ¨0x10000å¤„
</span></span><span class="line"><span class="cl">SETUPSEG = 0x9020	! this is the current segment          æœ¬ç¨‹åºæ‰€åœ¨æ®µåœ°å€
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">.globl begtext, begdata, begbss, endtext, enddata, endbss
</span></span><span class="line"><span class="cl">.text
</span></span><span class="line"><span class="cl">begtext:
</span></span><span class="line"><span class="cl">.data
</span></span><span class="line"><span class="cl">begdata:
</span></span><span class="line"><span class="cl">.bss
</span></span><span class="line"><span class="cl">begbss:
</span></span><span class="line"><span class="cl">.text
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">entry start
</span></span><span class="line"><span class="cl">start:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">! ok, the read went well so we get current cursor position and save it for
</span></span><span class="line"><span class="cl">! posterity.
</span></span><span class="line"><span class="cl">; ä¿å­˜å…‰æ ‡çš„ä½ç½®
</span></span><span class="line"><span class="cl">; ä½¿ç”¨BIOSä¸­æ–­å–å±å¹•å½“å‰å…‰æ ‡çš„ä½ç½®(åˆ—ï¼Œè¡Œ)ï¼Œä¿å­˜åˆ°å†…å­˜(0x90000)å¤„,2ä¸ªbyte
</span></span><span class="line"><span class="cl">; æ§åˆ¶å°åˆå§‹åŒ–ç¨‹åºä¼šåˆ°æ­¤å¤„è¯»å–è¯¥å€¼
</span></span><span class="line"><span class="cl">; BISO ä¸­æ–­0x10 åŠŸèƒ½å· ah = 0x30 ï¼Œè¯»å…‰æ ‡çš„ä½ç½®
</span></span><span class="line"><span class="cl">; è¾“å…¥ï¼šbh=é¡µå·
</span></span><span class="line"><span class="cl">; è¿”å›ï¼šè¿”å›ï¼šch = æ‰«æå¼€å§‹çº¿ï¼Œcl = ç»“æŸå¼€å§‹çº¿,dh = è¡Œå·(0x00é¡¶ç«¯)ï¼Œdl=åˆ—å·(0x00æœ€å·¦è¾¹)
</span></span><span class="line"><span class="cl">	mov	ax,#INITSEG ! this is done in bootsect already, but...
</span></span><span class="line"><span class="cl">	mov	ds,ax
</span></span><span class="line"><span class="cl">	mov	ah,#0x03	! read cursor pos åŠŸèƒ½å· ah = 0x30 ï¼Œè¯»å…‰æ ‡çš„ä½ç½®
</span></span><span class="line"><span class="cl">	xor	bh,bh
</span></span><span class="line"><span class="cl">	int	0x10		! save it in known place, con_init fetches
</span></span><span class="line"><span class="cl">	mov	[0],dx		! it from 0x90000.  å°†dsè®¾ç½®æˆ0x90000(INITSEG)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">! Get memory size (extended mem, kB)
</span></span><span class="line"><span class="cl">; å¾—åˆ°æ‰©å±•å†…å­˜çš„å¤§å°
</span></span><span class="line"><span class="cl">; åˆ©ç”¨BIOSä¸­æ–­0x15 åŠŸèƒ½å· ah= 0x88å–ç³»ç»Ÿæ‰€å«æ‰©å±•å†…å­˜å¤§å°å¹¶ä¿å­˜åˆ°0x90002å¤„
</span></span><span class="line"><span class="cl">; è¿”å›ï¼š ax= 0x10000(1M)å¤„å¼€å§‹çš„æ‰©å±•å†…å­˜å¤§å°ï¼Œè‹¥å‡ºé”™CFç½®ä½ï¼Œax=å‡ºé”™ç 
</span></span><span class="line"><span class="cl">	mov	ah,#0x88
</span></span><span class="line"><span class="cl">	int	0x15
</span></span><span class="line"><span class="cl">	mov	[2],ax      !æ‰©å±•å†…å­˜çš„å¤§å°ä¿å­˜åˆ°0x90002å¤„
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">! Get video-card data:
</span></span><span class="line"><span class="cl">; å¾—åˆ°æ˜¾ç¤ºå¡å½“å‰çš„æ˜¾ç¤ºæ¨¡å¼
</span></span><span class="line"><span class="cl">; è°ƒç”¨BIOSä¸­æ–­0x10ï¼ŒåŠŸèƒ½å· ah = 0x0f
</span></span><span class="line"><span class="cl">; è¿”å›ï¼šah=å­—ç¬¦åˆ—æ•°ï¼Œal=æ˜¾ç¤ºæ¨¡å¼ï¼Œbh=æ˜¾ç¤ºå½“å‰é¡µæ•°
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	mov	ah,#0x0f
</span></span><span class="line"><span class="cl">	int	0x10
</span></span><span class="line"><span class="cl">	mov	[4],bx		! bh = display page
</span></span><span class="line"><span class="cl">	mov	[6],ax		! al = video mode, ah = window width
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">! check for EGA/VGA and some config parameters
</span></span><span class="line"><span class="cl">; æ£€æµ‹æ˜¾ç¤ºæ–¹å¼
</span></span><span class="line"><span class="cl">; è°ƒç”¨BIOSä¸­æ–­0x10, åŠŸèƒ½å· ah=0x12,bl=0x10
</span></span><span class="line"><span class="cl">	mov	ah,#0x12
</span></span><span class="line"><span class="cl">	mov	bl,#0x10
</span></span><span class="line"><span class="cl">	int	0x10
</span></span><span class="line"><span class="cl">	mov	[8],ax      ! 0x90008 =ax
</span></span><span class="line"><span class="cl">	mov	[10],bx     ! 0x9000A = å®‰è£…çš„æ˜¾ç¤ºå†…å­˜ï¼Œ0x9000B = æ˜¾ç¤ºçŠ¶æ€
</span></span><span class="line"><span class="cl">	mov	[12],cx		ï¼0X9000C = æ˜¾å¡ç‰¹æ€§å‚æ•°
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">! Get hd0 data
</span></span><span class="line"><span class="cl">; å–ç¬¬ä¸€ä¸ªç¡¬ç›˜ä¿¡æ¯
</span></span><span class="line"><span class="cl">; ç¬¬ä¸€ä¸ªç¡¬ç›˜å‚æ•°è¡¨çš„é¦–åœ°å€æ˜¯ä¸­æ–­å‘é‡0x41çš„å‘é‡å€¼
</span></span><span class="line"><span class="cl">; ç¬¬äºŒä¸ªç´§è·Ÿç€å¯¹åº”ç€ä¸­æ–­å‘é‡0x46
</span></span><span class="line"><span class="cl">; ä¸‹é¢ä¸¤ä¸ªç¨‹åºåˆ†åˆ«å¤åˆ¶BIOSæœ‰å…³ç¡¬ç›˜å‚æ•°è¡¨ï¼Œ
</span></span><span class="line"><span class="cl">; ç¬¬ä¸€ä¸ªç¡¬ç›˜å­˜æ”¾åœ¨0x90080,ç¬¬äºŒä¸ªç¡¬ç›˜å­˜æ”¾åœ¨0x90090
</span></span><span class="line"><span class="cl">	mov	ax,#0x0000
</span></span><span class="line"><span class="cl">	mov	ds,ax
</span></span><span class="line"><span class="cl">	lds	si,[4*0x41]         !å–ä¸­æ–­å‘é‡0x41å¯¹åº”çš„åœ°å€ ï¼Œhd0å‚æ•°è¡¨çš„åœ°å€--&gt; ds:si
</span></span><span class="line"><span class="cl">	mov	ax,#INITSEG         
</span></span><span class="line"><span class="cl">	mov	es,ax
</span></span><span class="line"><span class="cl">	mov	di,#0x0080          ï¼ä¼ è¾“çš„ç›®çš„åœ°å€(0x9000:0x0080) --&gt;es:di
</span></span><span class="line"><span class="cl">	mov	cx,#0x10            ! å¾ªç¯æ¬¡æ•°ï¼Œæ¯æ¬¡å¾ªç¯å®Œæ¬¡æ•°å‡ä¸€ï¼Œå…±ä¼ è¾“16ä¸ªå­—èŠ‚
</span></span><span class="line"><span class="cl">	rep						! repæ˜¯repeatï¼Œrepé…åˆ movw(movsb) å°±æ˜¯å¤šæ¬¡å¤åˆ¶ç›´åˆ°cx=0ä¸ºæ­¢ å¤åˆ¶çš„æ¬¡æ•°æ”¾åœ¨cxä¸­
</span></span><span class="line"><span class="cl">	movsb                   ! ç”¨äºæŠŠå†…å®¹ä»ds:si å¤åˆ¶es:di  ä»¥å­—èŠ‚å•ä½
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">! Get hd1 data
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	mov	ax,#0x0000
</span></span><span class="line"><span class="cl">	mov	ds,ax
</span></span><span class="line"><span class="cl">	lds	si,[4*0x46]         !å–ä¸­æ–­å‘é‡0x41å¯¹åº”çš„åœ°å€ ï¼Œhd0å‚æ•°è¡¨çš„åœ°å€--&gt; ds:si
</span></span><span class="line"><span class="cl">	mov	ax,#INITSEG 
</span></span><span class="line"><span class="cl">	mov	es,ax
</span></span><span class="line"><span class="cl">	mov	di,#0x0090
</span></span><span class="line"><span class="cl">	mov	cx,#0x10
</span></span><span class="line"><span class="cl">	rep
</span></span><span class="line"><span class="cl">	movsb
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">! Check that there IS a hd1 :-)
</span></span><span class="line"><span class="cl">; æ£€æµ‹æ˜¯å¦æœ‰ç¬¬äºŒä¸ªç¡¬ç›˜ï¼Œå¦‚æœæ²¡æœ‰åˆ™æŠŠç¬¬2ä¸ªæ¸…é›¶
</span></span><span class="line"><span class="cl">; åˆ©ç”¨BIOSä¸­æ–­è°ƒç”¨0x13çš„å–ç›˜çš„ç±»å‹ï¼ŒåŠŸèƒ½å· ah =0x15
</span></span><span class="line"><span class="cl">	mov	ax,#0x01500
</span></span><span class="line"><span class="cl">	mov	dl,#0x81         ! dl = é©±åŠ¨å™¨å·(0x8Xæ˜¯ç¡¬ç›˜ï¼Œ0x81æ˜¯ç¬¬ä¸€ä¸ªç¡¬ç›˜ï¼Œ0x82æ˜¯ç¬¬äºŒä¸ªç¡¬ç›˜)
</span></span><span class="line"><span class="cl">	int	0x13
</span></span><span class="line"><span class="cl">	jc	no_disk1         ! ç¬¬äºŒä¸ªä¸å­˜åœ¨
</span></span><span class="line"><span class="cl">	cmp	ah,#3			 ! ah =ç±»å‹ç  æŒ‡ç¡¬ç›˜
</span></span><span class="line"><span class="cl">	je	is_disk1         ! å­˜åœ¨
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">; ç¬¬äºŒä¸ªç¡¬ç›˜ä¸å­˜åœ¨ï¼Œå¯¹ç¬¬äºŒä¸ªç¡¬ç›˜è¡¨æ¸…é›¶
</span></span><span class="line"><span class="cl">no_disk1:
</span></span><span class="line"><span class="cl">	mov	ax,#INITSEG
</span></span><span class="line"><span class="cl">	mov	es,ax
</span></span><span class="line"><span class="cl">	mov	di,#0x0090
</span></span><span class="line"><span class="cl">	mov	cx,#0x10
</span></span><span class="line"><span class="cl">	mov	ax,#0x00
</span></span><span class="line"><span class="cl">	rep
</span></span><span class="line"><span class="cl">	stosb
</span></span><span class="line"><span class="cl">; ç¬¬äºŒä¸ªç¡¬ç›˜å­˜åœ¨ï¼Œè¿›å…¥ä¿æŠ¤æ¨¡å¼ï¼Œä»æ­¤å¼€å§‹ä¸å…è®¸ä¸­æ®µ
</span></span><span class="line"><span class="cl">is_disk1:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">! now we want to move to protected mode ...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	cli			! no interrupts allowed !
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">! first we move the system to it&#39;s rightful place
</span></span><span class="line"><span class="cl">; bootsectå¼•å¯¼ç¨‹åºå°†systemæ¨¡å—ç§»åŠ¨åˆ°(0x10000)å¤„ï¼Œ
</span></span><span class="line"><span class="cl">; å¹¶æŠŠè‡ªå·±ç§»åŠ¨åˆ°(0x90000)å¤„ï¼ŒæŠŠsetupåŠ è½½åœ¨å®ƒåé¢
</span></span><span class="line"><span class="cl">; ä¸‹é¢è¿™æ®µç¨‹åºå°†æ•´ä¸ªsystemæ¨¡å—ç§»åŠ¨åˆ°0x00000å¤„ï¼Œ
</span></span><span class="line"><span class="cl">; å³æŠŠä»0x10000åˆ°0x8ffffçš„å†…å­˜æ•°æ®å—æ•´å—çš„å‘å†…å­˜åœ°å€ä½ç«¯ç§»åŠ¨äº†0x10000çš„ä½ç½®
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	mov	ax,#0x0000
</span></span><span class="line"><span class="cl">	cld			! &#39;direction&#39;=0, movs moves forward
</span></span><span class="line"><span class="cl">do_move:
</span></span><span class="line"><span class="cl">	mov	es,ax		! destination segment
</span></span><span class="line"><span class="cl">	add	ax,#0x1000
</span></span><span class="line"><span class="cl">	cmp	ax,#0x9000  ! åˆ¤æ–­ä»£ç æ˜¯å¦ç§»åŠ¨å®Œæˆ
</span></span><span class="line"><span class="cl">	jz	end_move    ! ç§»åŠ¨å®Œæˆåˆ™è·³è½¬
</span></span><span class="line"><span class="cl">	mov	ds,ax		! source segment
</span></span><span class="line"><span class="cl">	sub	di,di
</span></span><span class="line"><span class="cl">	sub	si,si
</span></span><span class="line"><span class="cl">	mov 	cx,#0x8000   ! å¾ªç¯ç§»åŠ¨ï¼Œå¾ªç¯æ¬¡æ•°ï¼Œæ¯æ¬¡å¾ªç¯å®Œæ¬¡æ•°å‡ ç§»åŠ¨0x8000å­—
</span></span><span class="line"><span class="cl">	rep				! ç”¨äºæŠŠå†…å®¹ä»ds:si å¤åˆ¶es:di  ä»¥å­—èŠ‚å•ä½
</span></span><span class="line"><span class="cl">	movsw           ! repæ˜¯repeatï¼Œrepé…åˆ movw(movsb) å°±æ˜¯å¤šæ¬¡å¤åˆ¶ç›´åˆ°cx=0ä¸ºæ­¢ å¤åˆ¶çš„æ¬¡æ•°æ”¾åœ¨cxä¸­
</span></span><span class="line"><span class="cl">	jmp	do_move
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">! then we load the segment descriptors
</span></span><span class="line"><span class="cl">; åŠ è½½æ®µæè¿°ç¬¦ï¼Œè®¾ç½®å…¨å±€æè¿°ç¬¦è¡¨å’Œä¸­æ–­æè¿°è¡¨
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">end_move:
</span></span><span class="line"><span class="cl">	mov	ax,#SETUPSEG	! right, forgot this at first. didn&#39;t work :-)
</span></span><span class="line"><span class="cl">	mov	ds,ax
</span></span><span class="line"><span class="cl">; lidtæŒ‡ä»¤ç”¨äºåŠ è½½ä¸­æ–­æè¿°ç¬¦è¡¨(IDT)å¯„å­˜å™¨
</span></span><span class="line"><span class="cl">; ä¸­æ–­æè¿°ç¬¦è¡¨ä¸­æ¯ä¸€ä¸ª8ä¸ªå­—èŠ‚å¯¹åº”æ¯ä¸ªä¸­æ–­å‘ç”Ÿæ—¶æ‰€éœ€è¦çš„ä¸­æ–­ç¨‹åºåœ°å€å…¥å£
</span></span><span class="line"><span class="cl">	lidt	idt_48		! load idt with 0,0   
</span></span><span class="line"><span class="cl">; lgdtæŒ‡ä»¤ç”¨äºåŠ è½½å…¨å±€æè¿°ç¬¦è¡¨(GDT)å¯„å­˜å™¨
</span></span><span class="line"><span class="cl">; å…¨å±€æè¿°ç¬¦è¡¨ä¸­æ¯ä¸ªæè¿°ç¬¦é¡¹(8å­—èŠ‚)æè¿°äº†ä¿æŠ¤æ¨¡å¼ä¸‹æ•°æ®æ®µå’Œä»£ç æ®µçš„ä¿¡æ¯
</span></span><span class="line"><span class="cl">	lgdt	gdt_48		! load gdt with whatever appropriate
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">! that was painless, now we enable A20
</span></span><span class="line"><span class="cl">; å¼€å¯A20åœ°å€çº¿ï¼Œä¸ºäº†èƒ½å¤Ÿè®¿é—®å’Œä½¿ç”¨1MBä»¥ä¸Šçš„ç‰©ç†å†…å­˜
</span></span><span class="line"><span class="cl">	call	empty_8042    ! æµ‹è¯•8042çŠ¶æ€å¯„å­˜å™¨ï¼Œç­‰å¾…è¾“å…¥ç¼“å†²å™¨ç©ºï¼Œ
</span></span><span class="line"><span class="cl">	mov	al,#0xD1		  ! command write 0xD1å‘½ä»¤ç è¡¨ç¤ºå†™æ•°æ®åˆ°8042çš„P2ç«¯å£
</span></span><span class="line"><span class="cl">	out	#0x64,al
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	call	empty_8042    ï¼ç­‰å¾…è¾“å…¥ç¼“å†²å™¨ç©ºï¼Œçœ‹å‘½ä»¤æ˜¯å¦è¢«æ¥å—
</span></span><span class="line"><span class="cl">	mov	al,#0xDF		  ! A20 on
</span></span><span class="line"><span class="cl">	out	#0x60,al
</span></span><span class="line"><span class="cl">	call	empty_8042    ï¼è‹¥æ­¤æ—¶è¾“å…¥ç¼“å†²å™¨ä¸ºç©ºï¼Œåˆ™è¡¨ç¤ºA20çº¿ä¹Ÿé€‰é€š 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">! well, that went ok, I hope. Now we have to reprogram the interrupts :-(
</span></span><span class="line"><span class="cl">! we put them right after the intel-reserved hardware interrupts, at
</span></span><span class="line"><span class="cl">! int 0x20-0x2F. There they won&#39;t mess up anything. Sadly IBM really
</span></span><span class="line"><span class="cl">! messed this up with the original PC, and they haven&#39;t been able to
</span></span><span class="line"><span class="cl">! rectify it afterwards. Thus the bios puts interrupts at 0x08-0x0f,
</span></span><span class="line"><span class="cl">! which is used for the internal hardware interrupts as well. We just
</span></span><span class="line"><span class="cl">! have to reprogram the 8259&#39;s, and it isn&#39;t fun.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">; é‡æ–°å¯¹ä¸­æ–­è¿›è¡Œç¼–ç¨‹
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	mov	al,#0x11		! initialization sequence
</span></span><span class="line"><span class="cl">	out	#0x20,al		! send it to 8259A-1  å‘é€åˆ°8259Aä¸»èŠ¯ç‰‡
</span></span><span class="line"><span class="cl">;   0x00ebç›´æ¥ä½¿ç”¨æœºå™¨ç è¡¨ç¤ºä¸¤æ¡ç›¸å¯¹è·³è½¬æŒ‡ä»¤ï¼Œèµ·å»¶æ—¶ä½œç”¨
</span></span><span class="line"><span class="cl">	.word	0x00eb,0x00eb		! jmp $+2, jmp $+2
</span></span><span class="line"><span class="cl">	out	#0xA0,al		! and to 8259A-2   å†å‘é€åˆ°8259Aä»èŠ¯ç‰‡
</span></span><span class="line"><span class="cl">	.word	0x00eb,0x00eb
</span></span><span class="line"><span class="cl">;   ç³»ç»Ÿç¡¬ä»¶ä¸­æ–­å·è¢«è®¾ç½®æˆ0x20å¼€å§‹
</span></span><span class="line"><span class="cl">	mov	al,#0x20		! start of hardware int&#39;s (0x20)
</span></span><span class="line"><span class="cl">	out	#0x21,al		ï¼é€ä¸»èŠ¯ç‰‡ICW2å‘½ä»¤å­—ï¼Œè®¾ç½®èµ·å§‹ä¸­æ–­ï¼Œè¦é€å¥‡ç«¯å£
</span></span><span class="line"><span class="cl">	.word	0x00eb,0x00eb
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	mov	al,#0x28		! start of hardware int&#39;s 2 (0x28)
</span></span><span class="line"><span class="cl">	out	#0xA1,al        ï¼é€ä¸»èŠ¯ç‰‡ICW2å‘½ä»¤å­—ï¼Œä»èŠ¯ç‰‡çš„èµ·å§‹ä¸­æ–­å·
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	.word	0x00eb,0x00eb
</span></span><span class="line"><span class="cl">	mov	al,#0x04		! 8259-1 is master
</span></span><span class="line"><span class="cl">	out	#0x21,al        !ICW3
</span></span><span class="line"><span class="cl">	.word	0x00eb,0x00eb
</span></span><span class="line"><span class="cl">	mov	al,#0x02		! 8259-2 is slave
</span></span><span class="line"><span class="cl">	out	#0xA1,al
</span></span><span class="line"><span class="cl">	.word	0x00eb,0x00eb
</span></span><span class="line"><span class="cl">	mov	al,#0x01		! 8086 mode for both
</span></span><span class="line"><span class="cl">	out	#0x21,al
</span></span><span class="line"><span class="cl">	.word	0x00eb,0x00eb
</span></span><span class="line"><span class="cl">	out	#0xA1,al
</span></span><span class="line"><span class="cl">	.word	0x00eb,0x00eb
</span></span><span class="line"><span class="cl">	mov	al,#0xFF		! mask off all interrupts for now
</span></span><span class="line"><span class="cl">	out	#0x21,al
</span></span><span class="line"><span class="cl">	.word	0x00eb,0x00eb
</span></span><span class="line"><span class="cl">	out	#0xA1,al
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">! well, that certainly wasn&#39;t fun :-(. Hopefully it works, and we don&#39;t
</span></span><span class="line"><span class="cl">! need no steenking BIOS anyway (except for the initial loading :-).
</span></span><span class="line"><span class="cl">! The BIOS-routine wants lots of unnecessary data, and it&#39;s less
</span></span><span class="line"><span class="cl">! &#34;interesting&#34; anyway. This is how REAL programmers do it.
</span></span><span class="line"><span class="cl">!
</span></span><span class="line"><span class="cl">! Well, now&#39;s the time to actually move into protected mode. To make
</span></span><span class="line"><span class="cl">! things as simple as possible, we do no register set-up or anything,
</span></span><span class="line"><span class="cl">! we let the gnu-compiled 32-bit programs do that. We just jump to
</span></span><span class="line"><span class="cl">! absolute address 0x00000, in 32-bit protected mode.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">; è¿›å…¥ä¿æŠ¤æ¨¡å¼ï¼Œåªæ˜¯è·³è½¬åˆ°ç»å¯¹åœ°å€0x00000å¤„
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">; åŠ è½½æœºå™¨çŠ¶æ€å­—(æ§åˆ¶å¯„å­˜å™¨CR0)ï¼Œå°†0ä½ç½®1ï¼ŒCPUåˆ‡æ¢åˆ°ä¿æŠ¤æ¨¡å¼
</span></span><span class="line"><span class="cl">	mov	ax,#0x0001	! protected mode (PE) bit ä¿æŠ¤æ¨¡å¼æ¯”ç‰¹ä½(PE)
</span></span><span class="line"><span class="cl">	lmsw	ax		! This is it!             åŠ è½½çŠ¶æ€å¯„å­˜å™¨
</span></span><span class="line"><span class="cl">	;æ®µé€‰æ‹©ç¬¦8è¡¨ç¤ºè¯·æ±‚ç‰¹æƒ0çº§ï¼Œä½¿ç”¨GDTç¬¬äºŒä¸ªæ®µæè¿°ç¬¦
</span></span><span class="line"><span class="cl">	jmpi	0,8		! jmp offset 0 of segment 8 (cs)  è·³è½¬è‡³csæ®µåç§»åœ°å€ä½0å¤„(systemå·²ç»ç§»åŠ¨åˆ°0x00000å¤„)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">! This routine checks that the keyboard command queue is empty
</span></span><span class="line"><span class="cl">! No timeout is used - if this hangs there is something wrong with
</span></span><span class="line"><span class="cl">! the machine, and we probably couldn&#39;t proceed anyway.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">; æ£€å·®é”®ç›˜å‘½ä»¤é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º
</span></span><span class="line"><span class="cl">; åªæœ‰å½“è¾“å…¥ç¼“å†²å™¨ä¸ºç©º(é”®ç›˜æ§åˆ¶å™¨çŠ¶æ€å¯„å­˜å™¨ä½1 = 0)æ‰å¯ä»¥è¿›è¡Œå†™å‘½ä»¤
</span></span><span class="line"><span class="cl">empty_8042:
</span></span><span class="line"><span class="cl">	.word	0x00eb,0x00eb      ï¼å»¶æ—¶ä½œç”¨
</span></span><span class="line"><span class="cl">	in	al,#0x64	! 8042 status port
</span></span><span class="line"><span class="cl">	test	al,#2		! is input buffer full?
</span></span><span class="line"><span class="cl">	jnz	empty_8042	! yes - loop
</span></span><span class="line"><span class="cl">	ret
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">; GDTå…¨å±€æè¿°ç¬¦è¡¨å¼€å§‹å¤„ï¼Œæè¿°ç¬¦è¡¨ç”±å¤šä¸ª8å­—èŠ‚é•¿çš„æè¿°ç¬¦é¡¹ç»„æˆ,
</span></span><span class="line"><span class="cl">; 3ä¸ªæè¿°ç¬¦é¡¹
</span></span><span class="line"><span class="cl">; ç¬¬ä¸€é¡¹æ²¡æœ‰ä½œç”¨ï¼Œä½†æ˜¯å¿…é¡»å­˜åœ¨
</span></span><span class="line"><span class="cl">; ç¬¬äºŒé¡¹æ˜¯ç³»ç»Ÿä»£ç æ®µæè¿°ç¬¦
</span></span><span class="line"><span class="cl">; ç¬¬ä¸‰é¡¹æ˜¯ç³»ç»Ÿæ•°æ®æ®µæè¿°ç¬¦
</span></span><span class="line"><span class="cl">gdt:
</span></span><span class="line"><span class="cl">	.word	0,0,0,0		! dummy  ç¬¬ä¸€ä¸ªæè¿°ç¬¦ ä¸ç”¨
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">; åœ¨GDTè¡¨è¿™é‡Œçš„åç§»é‡æ˜¯0x80,å®ƒæ˜¯å†…æ ¸ä»£ç æ®µé€‰æ‹©ç¬¦çš„å€¼
</span></span><span class="line"><span class="cl">	.word	0x07FF		! 8Mb - limit=2047 (2048*4096=8Mb)
</span></span><span class="line"><span class="cl">	.word	0x0000		! base address=0
</span></span><span class="line"><span class="cl">	.word	0x9A00		! code read/exec
</span></span><span class="line"><span class="cl">	.word	0x00C0		! granularity=4096, 386
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">; åœ¨GDTè¡¨è¿™é‡Œçš„åç§»é‡æ˜¯0x10,å®ƒæ˜¯å†…æ ¸æ•°æ®æ®µé€‰æ‹©ç¬¦çš„å€¼
</span></span><span class="line"><span class="cl">	.word	0x07FF		! 8Mb - limit=2047 (2048*4096=8Mb)
</span></span><span class="line"><span class="cl">	.word	0x0000		! base address=0
</span></span><span class="line"><span class="cl">	.word	0x9200		! data read/write
</span></span><span class="line"><span class="cl">	.word	0x00C0		! granularity=4096, 386
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">; åŠ è½½ä¸­æ–­æè¿°ç¬¦è¡¨å¯„å­˜å™¨(idtr)
</span></span><span class="line"><span class="cl">; è¿™é‡Œè®¾ç½®ä¸€ä¸ªé•¿åº¦ä¸º0çš„ç©ºè¡¨
</span></span><span class="line"><span class="cl">idt_48:
</span></span><span class="line"><span class="cl">	.word	0			! idt limit=0
</span></span><span class="line"><span class="cl">	.word	0,0			! idt base=0L
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">; åŠ è½½å…¨å±€æè¿°ç¬¦è¡¨å¯„å­˜å™¨(gdtr)
</span></span><span class="line"><span class="cl">; GDTè¡¨é•¿åº¦ä¸º2kb
</span></span><span class="line"><span class="cl">gdt_48:
</span></span><span class="line"><span class="cl">	.word	0x800		! gdt limit=2048, 256 GDT entries
</span></span><span class="line"><span class="cl">	.word	512+gdt,0x9	! gdt base = 0X9xxxx
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">.text
</span></span><span class="line"><span class="cl">endtext:
</span></span><span class="line"><span class="cl">.data
</span></span><span class="line"><span class="cl">enddata:
</span></span><span class="line"><span class="cl">.bss
</span></span><span class="line"><span class="cl">endbss:
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="å†…æ ¸å¼•å¯¼ç¨‹åº---head">å†…æ ¸å¼•å¯¼ç¨‹åº&mdash;head<a hidden class="anchor" aria-hidden="true" href="#å†…æ ¸å¼•å¯¼ç¨‹åº---head">#</a></h1>
<h2 id="1ç®€ä»‹-2">1.ç®€ä»‹<a hidden class="anchor" aria-hidden="true" href="#1ç®€ä»‹-2">#</a></h2>
<p>head.s ç¨‹åºåœ¨è¢«ç¼–è¯‘ç”Ÿæˆç›®æ ‡æ–‡ä»¶åä¼šä¸å†…æ ¸å…¶ä»–ç¨‹åºä¸€èµ·è¢«é“¾æ¥æˆ system æ¨¡å—ï¼Œå®ƒä½äº system æ¨¡å—çš„æœ€å¼€å§‹éƒ¨åˆ†ã€‚systemæ¨¡å—å°†è¢«æ”¾ç½®åœ¨ç£ç›˜ä¸Šsetupæ¨¡å—ä¹‹åçš„æ‰‡åŒºï¼Œä»ç£ç›˜ä¸Šç¬¬6ä¸ªæ‰‡åŒºå¼€å§‹æ”¾ç½®ã€‚</p>
<p>æ³¨ï¼šè¿™æ®µç¨‹åºå¤„äºç»å¯¹åœ°å€0x00000å¤„ã€‚</p>
<p>ç¨‹åºè¿›å…¥ä¿æŠ¤æ¨¡å¼ï¼Œç¨‹åºé‡‡ç”¨AT&amp;Tè¯­æ³•æ ¼å¼ã€‚</p>
<p>Linux AT&amp;Tæ±‡ç¼–è¯­æ³•ç®€ä»‹ï¼š</p>
<p><a href="https://blog.csdn.net/qq_53144843/article/details/120346586?spm=1001.2014.3001.5501">æ·»åŠ é“¾æ¥æè¿°</a></p>
<p>ä½œç”¨ï¼šhead.sç¨‹åºï¼šè®¾ç½®ä¸­æ–­æè¿°ç¬¦è¡¨é¡¹ï¼ˆå“‘ä¸­æ–­ï¼‰ï¼›æ£€æŸ¥A20ï¼›æµ‹è¯•æ˜¯å¦æœ‰åå¤„ç†å™¨ï¼›åˆå§‹åŒ–å†…å­˜é¡µç›®å½•è¡¨ï¼›è·³è½¬åˆ°main.cæ‰§è¡Œå†…æ ¸åˆå§‹åŒ–</p>
<p>headå®Œæˆåå®Œæˆäº†å†…å­˜é¡µç›®å½•å’Œé¡µè¡¨çš„è®¾ç½®ï¼Œå¹¶é‡æ–°è®¾ç½®äº†å†…æ ¸å®é™…ä½¿ç”¨çš„ä¸­æ–­æè¿°ç¬¦è¡¨idtå’Œå…¨å±€æè¿°ç¬¦è¡¨GDT,è¿˜ä¸ºè½¯ç›˜é©±åŠ¨ç¨‹åºå¼€è¾Ÿäº†1KBå­—èŠ‚çš„ç¼“å†²åŒºã€‚</p>
<p>32ä½ä¸‹å¯»å€</p>
<p>å°†å®æ¨¡å¼ä¸‹çš„æ®µå¯„å­˜å™¨å½“ä½œä¿æŠ¤æ¨¡å¼ä¸‹çš„æ®µæè¿°ç¬¦çš„æŒ‡é’ˆä½¿ç”¨ï¼Œæ­¤æ—¶æ®µå¯„å­˜å™¨ä¸­å­˜æ”¾çš„æ˜¯ä¸€ä¸ªæè¿°ç¬¦åœ¨æè¿°ç¬¦è¡¨ä¸­çš„åç§»åœ°å€å¯„å­˜å™¨ï¼Œè€Œå½“å‰æè¿°ç¬¦è¡¨çš„åŸºåœ°å€åˆ™ä¿å­˜åœ¨æè¿°ç¬¦è¡¨å¯„å­˜å™¨ä¸­ã€‚</p>
<p>headç¨‹åºç»“æŸåå†…å­˜æ˜ åƒ</p>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012320487.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"  />
</p>
<p><strong>.align</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">.align  2
</span></span><span class="line"><span class="cl">å®Œæ•´æ ¼å¼ ï¼š.align val1,val2,val3
</span></span><span class="line"><span class="cl">val1 æ˜¯éœ€è¦å¯¹é½çš„å€¼
</span></span><span class="line"><span class="cl">val2 å¡«å……å­—èŠ‚æŒ‡å®šçš„å€¼
</span></span><span class="line"><span class="cl">val3 æŒ‡æ˜æœ€å¤§ç”¨äºå¡«å……æˆ–è·³è¿‡çš„ç›´æ¥æ•°
</span></span></code></pre></td></tr></table>
</div>
</div><p>.alignæ˜¯æ±‡ç¼–è¯­è¨€æŒ‡ç¤ºç¬¦ã€‚å…¶å«ä¹‰æ˜¯è¾¹ç•Œå¯¹é½è°ƒæ•´ã€‚â€2â€è¡¨ç¤ºæŠŠéšåçš„ä»£ç æˆ–æ•°æ®çš„åç§»ä½ç½®è°ƒæ•´åˆ°åœ°å€å€¼æœ€å 2 æ¯”ç‰¹ä½ä¸ºé›¶çš„ä½ç½®ï¼Œå³æŒ‰ 4ï¼ˆ=2^2ï¼‰å­—èŠ‚æ–¹å¼å¯¹é½å†…å­˜åœ°å€ã€‚ä¸è¿‡ç°åœ¨ GNU as ç›´æ¥å†™å‡ºå¯¹é½çš„å€¼è€Œé 2 çš„å¹‚æ¬¡ã€‚ä½¿ç”¨è¯¥æŒ‡ç¤ºç¬¦çš„ç›®çš„æ˜¯ä¸ºäº†æé«˜ 32 ä½ CPU è®¿é—®å†…å­˜ä¸­ä»£ç æˆ–æ•°æ®çš„æ•ˆç‡ã€‚</p>
<p><strong>.ORG</strong></p>
<p>ORGä¼ªæŒ‡ä»¤ç”¨æ¥è¡¨ç¤ºèµ·å§‹çš„åç§»åœ°å€ï¼Œç´§æ¥ç€ORGçš„æ•°å€¼å°±æ˜¯åç§»åœ°å€çš„èµ·å§‹å€¼ã€‚ORGä¼ªæ“ä½œå¸¸ç”¨æ¥æŒ‡å®šæ•°æ®çš„å­˜å‚¨åœ°å€ï¼Œæœ‰æ—¶ä¹Ÿç”¨æ¥æŒ‡å®šä»£ç æ®µçš„èµ·å§‹åœ°å€</p>
<p><strong>fill</strong></p>
<p><strong>fillä¼ªæŒ‡ä»¤çš„æ ¼å¼æ˜¯ .fill repeat,size,value</strong></p>
<p>è¡¨ç¤ºäº§ç”Ÿ repeat ä¸ªå¤§å°ä¸º size å­—èŠ‚çš„é‡å¤æ‹·è´ã€‚size æœ€å¤§æ˜¯ 8ï¼Œsize å­—èŠ‚çš„å€¼æ˜¯ value.</p>
<p><strong>æŒ‰ä½å¼‚æˆ–</strong> xor</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="mf">1.</span> <span class="err">ä½¿æŸäº›ç‰¹å®šçš„ä½ç¿»è½¬</span>
</span></span><span class="line"><span class="cl"><span class="err">ä¾‹å¦‚è¦ä½¿</span> <span class="n">EAX</span> <span class="err">çš„</span> <span class="n">b1</span> <span class="err">ä½å’Œ</span> <span class="n">b2</span> <span class="err">ä½ç¿»è½¬ï¼š</span>
</span></span><span class="line"><span class="cl"><span class="err">ã€€ã€€ã€€ã€€ã€€</span> <span class="n">EAX</span> <span class="o">=</span> <span class="n">EAX</span> <span class="o">^</span> <span class="mo">00000110</span>
</span></span><span class="line"><span class="cl"><span class="err">ã€€ã€€ã€€ã€€ã€€</span> 
</span></span><span class="line"><span class="cl"><span class="mf">2.</span><span class="err">ä¸ä½¿ç”¨ä¸´æ—¶å˜é‡å°±å¯ä»¥å®ç°ä¸¤ä¸ªå€¼çš„äº¤æ¢</span>
</span></span><span class="line"><span class="cl"><span class="err">ä¾‹å¦‚</span> <span class="n">a</span><span class="o">=</span><span class="mi">11110000</span><span class="err">ï¼Œ</span><span class="n">b</span><span class="o">=</span><span class="mo">00001111</span><span class="err">ï¼Œè¦äº¤æ¢</span><span class="n">a</span><span class="err">ã€</span><span class="n">b</span><span class="err">çš„å€¼</span>
</span></span><span class="line"><span class="cl"><span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">^</span><span class="n">b</span><span class="err">ï¼›</span> <span class="err">ã€€ã€€</span><span class="c1">//a=11111111
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">^</span><span class="n">a</span><span class="err">ï¼›</span> <span class="err">ã€€ã€€</span><span class="c1">//b=11110000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">^</span><span class="n">b</span><span class="err">ï¼›</span> <span class="err">ã€€ã€€</span><span class="c1">//a=00001111
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="mf">3.</span><span class="err">åœ¨æ±‡ç¼–è¯­è¨€ä¸­ç»å¸¸ç”¨äºå°†å˜é‡ç½®é›¶</span>
</span></span><span class="line"><span class="cl"><span class="n">xor</span> <span class="n">eax</span><span class="err">ï¼Œ</span><span class="n">eax</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="mf">4.</span><span class="err">å¿«é€Ÿåˆ¤æ–­ä¸¤ä¸ªå€¼æ˜¯å¦ç›¸ç­‰</span>
</span></span><span class="line"><span class="cl"><span class="err">ä¾‹å¦‚åˆ¤æ–­ä¸¤ä¸ªæ•´æ•°</span><span class="n">a</span><span class="err">ã€</span><span class="n">b</span><span class="err">æ˜¯å¦ç›¸ç­‰ï¼Œå¯é€šè¿‡ä¸‹åˆ—è¯­å¥å®ç°ï¼š</span>
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="p">((</span><span class="n">a</span> <span class="o">^</span> <span class="n">b</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="err">ï¼›</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>LSSæŒ‡ä»¤</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">æ ¼å¼ï¼šLSS r32,m16:32  #ç”¨å†…å­˜ä¸­çš„é•¿æŒ‡é’ˆåŠ è½½ SS:r32
</span></span><span class="line"><span class="cl">m16:32è¡¨ç¤ºä¸€ä¸ªå†…å­˜æ“ä½œæ•°ï¼Œè¿™ä¸ªæ“ä½œæ•°æ˜¯ä¸€ä¸ªé•¿æŒ‡é’ˆï¼Œç”±2éƒ¨åˆ†ç»„æˆï¼š16ä½çš„æ®µé€‰æ‹©
</span></span><span class="line"><span class="cl">å­å’Œ32ä½çš„åç§»ã€‚
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="2æºç åˆ†æ-1">2.æºç åˆ†æ<a hidden class="anchor" aria-hidden="true" href="#2æºç åˆ†æ-1">#</a></h2>
<p>1.å¯åŠ¨32ä½ç¨‹åº</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">startup_32:
</span></span><span class="line"><span class="cl">	movl $0x10,%eax  	;0x10 GDTä¸­çš„åç§»å€¼(ä¸€ä¸ªæè¿°ç¬¦è¡¨é¡¹çš„é€‰æ‹©ç¬¦)
</span></span><span class="line"><span class="cl">						;è¯·æ±‚ç‰¹çº§æƒ0(ä½0-1 =0)ï¼ŒGDT(ä½2=0)ï¼Œé€‰æ‹©è¡¨ä¸­ç¬¬2é¡¹(ä½3-15=2)
</span></span><span class="line"><span class="cl">						; æ­£å¥½æŒ‡å‘æ•°æ®æ®µæè¿°ç¬¦é¡¹
</span></span><span class="line"><span class="cl">	mov %ax,%ds         ; è®¾ç½®ds,es,fs,gsä¸ºsetupä¸­æ„é€ çš„æ•°æ®æ®µçš„é€‰æ‹©ç¬¦ =0x10      
</span></span><span class="line"><span class="cl">	mov %ax,%es			;å¹¶å°†å †æ ˆæ”¾ç½®åœ¨stack_start(æŒ‡é’ˆ)æŒ‡å‘çš„user_stackæ•°ç»„åŒº
</span></span><span class="line"><span class="cl">	mov %ax,%fs
</span></span><span class="line"><span class="cl">	mov %ax,%gs
</span></span><span class="line"><span class="cl">	lss _stack_start,%esp  ;_stack_start--&gt;ss:esp,è®¾ç½®ç³»ç»Ÿå †æ ˆ
</span></span><span class="line"><span class="cl">						   ;ç§»åŠ¨åˆ°ä»»åŠ¡0æ‰§è¡Œ(init/main.c)ï¼Œè¯¥æ ˆå°±è¢«ç”¨åšä»»åŠ¡0å’Œä»»åŠ¡1å…±åŒä½¿ç”¨çš„ç”¨æˆ·æ ˆ
</span></span><span class="line"><span class="cl">	call setup_idt         ; è°ƒç”¨è®¾ç½®ä¸­æ–­æè¿°ç¬¦è¡¨å­ç¨‹åº
</span></span><span class="line"><span class="cl">	call setup_gdt         ; è°ƒç”¨è®¾ç½®å…¨å±€æè¿°ç¬¦è¡¨å­ç¨‹åº
</span></span><span class="line"><span class="cl">	movl $0x10,%eax		# reload all the segment registers
</span></span><span class="line"><span class="cl">	mov %ax,%ds		# after changing gdt. CS was already
</span></span><span class="line"><span class="cl">	mov %ax,%es		# reloaded in &#39;setup_gdt&#39;
</span></span><span class="line"><span class="cl">	mov %ax,%fs		# å› ä¸ºä¿®æ”¹äº†gdt,æ‰€ä»¥é‡æ–°åŠ è½½è¿™äº›å¯„å­˜å™¨
</span></span><span class="line"><span class="cl">	mov %ax,%gs
</span></span></code></pre></td></tr></table>
</div>
</div><p>2.åŠ è½½å„ä¸ªæ®µå¯„å­˜å™¨ï¼Œé‡æ–°è®¾ç½®ä¸­æ–­æè¿°ç¬¦è¡¨ï¼Œå…±256é¡¹ï¼Œå¹¶ä½¿å„ä¸ªè¡¨é¡¹å‡æŒ‡å‘ä¸€ä¸ªåªæŠ¥é”™è¯¯çš„å“‘ä¸­æ–­ç¨‹åºï¼Œé‡æ–°è®¾ç½®å…¨å±€æè¿°ç¬¦è¡¨</p>
<p>1)IDT:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">;è®¾ç½®ä¸­æ–­æè¿°ç¬¦è¡¨(IDT)å­—ç¨‹åºsetup_idt
</span></span><span class="line"><span class="cl"> ; å°†ä¸­æ–­æè¿°ç¬¦è¡¨è®¾ç½®å…·æœ‰256ä¸ªé¡¹ï¼Œå¹¶éƒ½æŒ‡å‘ignore_intä¸­æ–­é—¨ï¼Œç„¶ååŠ è½½ä¸­æ–­æè¿°ç¬¦è¡¨å¯„å­˜å™¨
</span></span><span class="line"><span class="cl"> ; ä¸­æ–­æè¿°ç¬¦è¡¨ä¸­çš„é¡¹ä¸º8ä¸ªå­—èŠ‚ï¼Œç§°ä¸ºé—¨æè¿°ç¬¦
</span></span><span class="line"><span class="cl">setup_idt:
</span></span><span class="line"><span class="cl">	lea ignore_int,%edx  # å°†ignore_intæœ‰æ•ˆåœ°å€å€¼èµ‹å€¼ç»™edx
</span></span><span class="line"><span class="cl">	movl $0x00080000,%eax # å°†é€‰æ‹©ç¬¦0x0008èµ‹å€¼ç»™eaxçš„é«˜16ä½
</span></span><span class="line"><span class="cl">	movw %dx,%ax		/* selector = 0x0008 = cs */
</span></span><span class="line"><span class="cl">	movw $0x8E00,%dx	/* interrupt gate - dpl=0, present */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	lea _idt,%edi               # _idt æ˜¯ä¸­æ–­æè¿°ç¬¦è¡¨çš„åœ°å€
</span></span><span class="line"><span class="cl">	mov $256,%ecx
</span></span><span class="line"><span class="cl">rp_sidt:
</span></span><span class="line"><span class="cl">	movl %eax,(%edi)			# eax -&gt; [edi] å°†å“‘ä¸­æ–­é—¨æè¿°ç¬¦å­˜å…¥è¡¨ä¸­
</span></span><span class="line"><span class="cl">	movl %edx,4(%edi)           # edx -&gt; [edi+4]
</span></span><span class="line"><span class="cl">	addl $8,%edi				# edi + 8 -&gt; edi
</span></span><span class="line"><span class="cl">	dec %ecx
</span></span><span class="line"><span class="cl">	jne rp_sidt
</span></span><span class="line"><span class="cl">	lidt idt_descr              #åŠ è½½ä¸­æ–­æè¿°ç¬¦è¡¨å¯„å­˜å™¨
</span></span><span class="line"><span class="cl">	ret
</span></span></code></pre></td></tr></table>
</div>
</div><p>2)GDT</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># è®¾ç½®å…¨å±€æè¿°ç¬¦è¡¨é¡¹
</span></span><span class="line"><span class="cl">setup_gdt:
</span></span><span class="line"><span class="cl">	lgdt gdt_descr    # åŠ è½½å…¨å±€æè¿°ç¬¦å¯„å­˜å™¨
</span></span><span class="line"><span class="cl">	ret
</span></span></code></pre></td></tr></table>
</div>
</div><p>3.å¯¹æ¯”ç‰©ç†åœ°å€0ä¸1Må¼€å§‹å¤„çš„å†…å®¹æ˜¯å¦ç›¸åŒï¼Œå¦‚æœç›¸åŒé‚£ä¹ˆæ²¡æœ‰å¼€å¯A20åœ°å€çº¿ï¼Œè¿›å…¥æ­»å¾ªç¯</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">;æµ‹è¯•A20åœ°å€çº¿æ˜¯å¦å¼€å¯
</span></span><span class="line"><span class="cl">	;æ–¹æ³•ï¼šå‘å†…å­˜åœ°å€0å¤„å†™å…¥ä»»æ„ä¸€ä¸ªæ•°å€¼ï¼Œçœ‹å†…å­˜åœ°å€æ˜¯å¦æ˜¯è¿™ä¸ªæ•°å€¼
</span></span><span class="line"><span class="cl">	;å¦‚æœæ˜¯å°±ä¸€ç›´æ¯”è¾ƒä¸‹å»ï¼Œäº§ç”Ÿæ­»å¾ªç¯ï¼Œ
</span></span><span class="line"><span class="cl">	;è¡¨ç¤ºA20çº¿æ²¡æœ‰é€‰é€šï¼Œå†…æ ¸å°±ä¸èƒ½ä½¿ç”¨1MBä»¥åçš„å†…å­˜ç©ºé—´
</span></span><span class="line"><span class="cl">	xorl %eax,%eax
</span></span><span class="line"><span class="cl">1:	incl %eax		# check that A20 really IS enabled  
</span></span><span class="line"><span class="cl">					# 1--&gt;æ ‡å·ï¼Œè¡¨ç¤ºæ´»åŠ¨ä½ç½®è®¡æ•°çš„å½“å‰å€¼ï¼Œå¹¶å¯ä»¥ä½œä¸ºæŒ‡ä»¤çš„æ“ä½œæ•°
</span></span><span class="line"><span class="cl">	movl %eax,0x000000	# loop forever if it isn&#39;t
</span></span><span class="line"><span class="cl">	cmpl %eax,0x100000
</span></span><span class="line"><span class="cl">	je 1b           # Nb:å¼•ç”¨å…ˆå‰æœ€è¿‘çš„æ ‡å· &#39;b&#39;:backwards å‘å
</span></span><span class="line"><span class="cl">					# Nf:å¼•ç”¨ä¸‹ä¸€ä¸ªæ ‡å·     &#39;f&#39;:forwards  å‘å‰
</span></span><span class="line"><span class="cl">					# è¿™é‡Œâ€˜1bâ€™è¡¨ç¤ºï¼šå‘åè·³è½¬åˆ°æ ‡å·1å»
</span></span><span class="line"><span class="cl">					# å¦‚æœæ˜¯5f,åˆ™æ˜¯å‘å‰è·³è½¬åˆ°æ ‡å·5å»
</span></span></code></pre></td></tr></table>
</div>
</div><p>4.æµ‹è¯•PCæœºæ˜¯å¦å«æœ‰æ•°æ®åå¤„ç†å™¨èŠ¯ç‰‡ï¼Œå¹¶åœ¨æ§åˆ¶å¯„å­˜å™¨CR0ä¸­è®¾ç½®ç›¸åº”çš„æ ‡å¿—ä½</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">; æ£€æµ‹486æ•°å­¦åå¤„ç†å™¨èŠ¯ç‰‡æ˜¯å¦å­˜åœ¨
</span></span><span class="line"><span class="cl"> ; æ–¹æ³•ï¼šä¿®æ”¹æ§åˆ¶å¯„å­˜å™¨CR0ï¼Œç„¶åæ‰§è¡Œä¸€æ¡åå¤„ç†å™¨æŒ‡ä»¤ï¼Œè‹¥å‡ºé”™ï¼Œåˆ™ä¸å­˜å’‹
</span></span><span class="line"><span class="cl"> ; éœ€è¦è®¾ç½®åå¤„ç†å™¨ä»¿çœŸä½(EM)ä½2,å¹¶å¤ä½åå¤„ç†å™¨å­˜åœ¨æ ‡å¿—(MP)ä½2
</span></span><span class="line"><span class="cl">	movl %cr0,%eax		# check math chip
</span></span><span class="line"><span class="cl">	andl $0x80000011,%eax	# Save PG,PE,ET
</span></span><span class="line"><span class="cl">/* &#34;orl $0x10020,%eax&#34; here for 486 might be good */
</span></span><span class="line"><span class="cl">	orl $2,%eax		# set MP   å¹¶å¤ä½åå¤„ç†å™¨å­˜åœ¨æ ‡å¿—(MP)
</span></span><span class="line"><span class="cl">	movl %eax,%cr0
</span></span><span class="line"><span class="cl">	call check_x87
</span></span><span class="line"><span class="cl">	jmp after_page_tables
</span></span></code></pre></td></tr></table>
</div>
</div><p>5.è®¾ç½®ç®¡ç†å†…å­˜çš„åˆ†é¡µå¤„ç†æœºåˆ¶ï¼Œå°†é¡µç›®å½•è¡¨æ”¾åœ¨ç»å¯¹ç‰©ç†åœ°å€0å¼€å§‹å¤„ç´§éšå…¶åæ”¾ç½®å…±å¯å¯»å€16MBå†…å­˜çš„4ä¸ªé¡µè¡¨ï¼Œå¹¶åˆ†åˆ«è®¾ç½®å®ƒä»¬çš„è¡¨é¡¹</p>
<p>6.æœ€ååˆ©ç”¨è¿”å›æŒ‡ä»¤å°†é¢„å…ˆæ”¾ç½®åœ¨å †æ ˆä¸­çš„/init/main.cç¨‹åºçš„å…¥å£åœ°å€å¼¹å‡ºï¼Œè¿è¡Œmain()ç¨‹åº</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># ä¸‹é¢å‡ ä¸ªå…¥æ ˆæ“ä½œä¸ºäº†è·³è½¬åˆ°init/main.cä¸­main()å‡½æ•°åšå‡†å¤‡
</span></span><span class="line"><span class="cl"># å‰é¢ä¸‰ä¸ªå…¥æ ˆ0å€¼åˆ†åˆ«è¡¨ç¤ºenvp,argvæŒ‡é’ˆå’Œargcçš„å€¼
</span></span><span class="line"><span class="cl">after_page_tables:
</span></span><span class="line"><span class="cl">	pushl $0		# These are the parameters to main :-)  mainå‡½æ•°å‚æ•° envp
</span></span><span class="line"><span class="cl">	pushl $0		# argvæŒ‡é’ˆ
</span></span><span class="line"><span class="cl">	pushl $0		# argc
</span></span><span class="line"><span class="cl">	pushl $L6		# return address for main, if it decides to. æ¨¡æ‹Ÿè°ƒç”¨mainæ—¶é¦–å…ˆå°†è¿”å›åœ°å€å…¥æ ˆçš„æ“ä½œ
</span></span><span class="line"><span class="cl">	pushl $_main    # _main---&gt;main
</span></span><span class="line"><span class="cl">	jmp setup_paging
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># mainå‡½æ•°åˆ°ä¸äº†è¿™é‡Œ ï¼Œåˆ°æ ‡å·L6è¿™é‡Œï¼Œæ˜¯ä¸€ä¸ªæ­»å¾ªç¯
</span></span><span class="line"><span class="cl">L6: 
</span></span><span class="line"><span class="cl">	jmp L6			# main should never return here, but
</span></span><span class="line"><span class="cl">				    # just in case, we know what happens.
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="3headå®Œæ•´æºç ">3.headå®Œæ•´æºç <a hidden class="anchor" aria-hidden="true" href="#3headå®Œæ•´æºç ">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/*
</span></span><span class="line"><span class="cl"> *  linux/boot/head.s
</span></span><span class="line"><span class="cl"> *
</span></span><span class="line"><span class="cl"> *  (C) 1991  Linus Torvalds
</span></span><span class="line"><span class="cl"> */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/*
</span></span><span class="line"><span class="cl"> *  head.s contains the 32-bit startup code.
</span></span><span class="line"><span class="cl"> *
</span></span><span class="line"><span class="cl"> * NOTE!!! Startup happens at absolute address 0x00000000, which is also where
</span></span><span class="line"><span class="cl"> * the page directory will exist. The startup code will be overwritten by
</span></span><span class="line"><span class="cl"> * the page directory.
</span></span><span class="line"><span class="cl"> */
</span></span><span class="line"><span class="cl"> ; headç¨‹åºå«æœ‰32å¯åŠ¨ç¨‹åºä»£ç 
</span></span><span class="line"><span class="cl"> ; 32å¯åŠ¨ç¨‹åºä»£ç æ˜¯ä»ç»å¯¹åœ°å€0x00000å¤„å¼€å§‹
</span></span><span class="line"><span class="cl"> ; é¡µç›®å½•ä¹Ÿåœ¨è¯¥å†…å­˜ï¼Œä»¥åå¯åŠ¨ä»£ç å°†ä¼šè¢«è¦†ç›–
</span></span><span class="line"><span class="cl">.text
</span></span><span class="line"><span class="cl">.globl _idt,_gdt,_pg_dir,_tmp_floppy_area
</span></span><span class="line"><span class="cl">_pg_dir:                ; é¡µç›®å½•å°†ä¼šæ”¾åœ¨åœ¨è¿™é‡Œ
</span></span><span class="line"><span class="cl">startup_32:
</span></span><span class="line"><span class="cl">	movl $0x10,%eax  	;0x10 GDTä¸­çš„åç§»å€¼(ä¸€ä¸ªæè¿°ç¬¦è¡¨é¡¹çš„é€‰æ‹©ç¬¦)
</span></span><span class="line"><span class="cl">						;è¯·æ±‚ç‰¹çº§æƒ0(ä½0-1 =0)ï¼ŒGDT(ä½2=0)ï¼Œé€‰æ‹©è¡¨ä¸­ç¬¬2é¡¹(ä½3-15=2)
</span></span><span class="line"><span class="cl">						; æ­£å¥½æŒ‡å‘æ•°æ®æ®µæè¿°ç¬¦é¡¹
</span></span><span class="line"><span class="cl">	mov %ax,%ds         ; è®¾ç½®ds,es,fs,gsä¸ºsetupä¸­æ„é€ çš„æ•°æ®æ®µçš„é€‰æ‹©ç¬¦ =0x10      
</span></span><span class="line"><span class="cl">	mov %ax,%es			;å¹¶å°†å †æ ˆæ”¾ç½®åœ¨stack_start(æŒ‡é’ˆ)æŒ‡å‘çš„user_stackæ•°ç»„åŒº
</span></span><span class="line"><span class="cl">	mov %ax,%fs
</span></span><span class="line"><span class="cl">	mov %ax,%gs
</span></span><span class="line"><span class="cl">	lss _stack_start,%esp  ;_stack_start--&gt;ss:esp,è®¾ç½®ç³»ç»Ÿå †æ ˆ
</span></span><span class="line"><span class="cl">						   ;ç§»åŠ¨åˆ°ä»»åŠ¡0æ‰§è¡Œ(init/main.c)ï¼Œè¯¥æ ˆå°±è¢«ç”¨åšä»»åŠ¡0å’Œä»»åŠ¡1å…±åŒä½¿ç”¨çš„ç”¨æˆ·æ ˆ
</span></span><span class="line"><span class="cl">	call setup_idt         ; è°ƒç”¨è®¾ç½®ä¸­æ–­æè¿°ç¬¦è¡¨å­ç¨‹åº
</span></span><span class="line"><span class="cl">	call setup_gdt         ; è°ƒç”¨è®¾ç½®å…¨å±€æè¿°ç¬¦è¡¨å­ç¨‹åº
</span></span><span class="line"><span class="cl">	movl $0x10,%eax		# reload all the segment registers
</span></span><span class="line"><span class="cl">	mov %ax,%ds		# after changing gdt. CS was already
</span></span><span class="line"><span class="cl">	mov %ax,%es		# reloaded in &#39;setup_gdt&#39;
</span></span><span class="line"><span class="cl">	mov %ax,%fs		# å› ä¸ºä¿®æ”¹äº†gdt,æ‰€ä»¥é‡æ–°åŠ è½½è¿™äº›å¯„å­˜å™¨
</span></span><span class="line"><span class="cl">	mov %ax,%gs
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	lss _stack_start,%esp
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	;æµ‹è¯•A20åœ°å€çº¿æ˜¯å¦å¼€å¯
</span></span><span class="line"><span class="cl">	;æ–¹æ³•ï¼šå‘å†…å­˜åœ°å€0å¤„å†™å…¥ä»»æ„ä¸€ä¸ªæ•°å€¼ï¼Œçœ‹å†…å­˜åœ°å€æ˜¯å¦æ˜¯è¿™ä¸ªæ•°å€¼
</span></span><span class="line"><span class="cl">	;å¦‚æœæ˜¯å°±ä¸€ç›´æ¯”è¾ƒä¸‹å»ï¼Œäº§ç”Ÿæ­»å¾ªç¯ï¼Œ
</span></span><span class="line"><span class="cl">	;è¡¨ç¤ºA20çº¿æ²¡æœ‰é€‰é€šï¼Œå†…æ ¸å°±ä¸èƒ½ä½¿ç”¨1MBä»¥åçš„å†…å­˜ç©ºé—´
</span></span><span class="line"><span class="cl">	xorl %eax,%eax
</span></span><span class="line"><span class="cl">1:	incl %eax		# check that A20 really IS enabled  
</span></span><span class="line"><span class="cl">					# 1--&gt;æ ‡å·ï¼Œè¡¨ç¤ºæ´»åŠ¨ä½ç½®è®¡æ•°çš„å½“å‰å€¼ï¼Œå¹¶å¯ä»¥ä½œä¸ºæŒ‡ä»¤çš„æ“ä½œæ•°
</span></span><span class="line"><span class="cl">	movl %eax,0x000000	# loop forever if it isn&#39;t
</span></span><span class="line"><span class="cl">	cmpl %eax,0x100000
</span></span><span class="line"><span class="cl">	je 1b           # Nb:å¼•ç”¨å…ˆå‰æœ€è¿‘çš„æ ‡å· &#39;b&#39;:backwards å‘å
</span></span><span class="line"><span class="cl">					# Nf:å¼•ç”¨ä¸‹ä¸€ä¸ªæ ‡å·     &#39;f&#39;:forwards  å‘å‰
</span></span><span class="line"><span class="cl">					# è¿™é‡Œâ€˜1bâ€™è¡¨ç¤ºï¼šå‘åè·³è½¬åˆ°æ ‡å·1å»
</span></span><span class="line"><span class="cl">					# å¦‚æœæ˜¯5f,åˆ™æ˜¯å‘å‰è·³è½¬åˆ°æ ‡å·5å»
</span></span><span class="line"><span class="cl">					
</span></span><span class="line"><span class="cl">/*
</span></span><span class="line"><span class="cl"> * NOTE! 486 should set bit 16, to check for write-protect in supervisor
</span></span><span class="line"><span class="cl"> * mode. Then it would be unnecessary with the &#34;verify_area()&#34;-calls.
</span></span><span class="line"><span class="cl"> * 486 users probably want to set the NE (#5) bit also, so as to use
</span></span><span class="line"><span class="cl"> * int 16 for math errors.
</span></span><span class="line"><span class="cl"> */
</span></span><span class="line"><span class="cl"> ; æ£€æµ‹486æ•°å­¦åå¤„ç†å™¨èŠ¯ç‰‡æ˜¯å¦å­˜åœ¨
</span></span><span class="line"><span class="cl"> ; æ–¹æ³•ï¼šä¿®æ”¹æ§åˆ¶å¯„å­˜å™¨CR0ï¼Œç„¶åæ‰§è¡Œä¸€æ¡åå¤„ç†å™¨æŒ‡ä»¤ï¼Œè‹¥å‡ºé”™ï¼Œåˆ™ä¸å­˜å’‹
</span></span><span class="line"><span class="cl"> ; éœ€è¦è®¾ç½®åå¤„ç†å™¨ä»¿çœŸä½(EM)ä½2,å¹¶å¤ä½åå¤„ç†å™¨å­˜åœ¨æ ‡å¿—(MP)ä½2
</span></span><span class="line"><span class="cl">	movl %cr0,%eax		# check math chip
</span></span><span class="line"><span class="cl">	andl $0x80000011,%eax	# Save PG,PE,ET
</span></span><span class="line"><span class="cl">/* &#34;orl $0x10020,%eax&#34; here for 486 might be good */
</span></span><span class="line"><span class="cl">	orl $2,%eax		# set MP   å¹¶å¤ä½åå¤„ç†å™¨å­˜åœ¨æ ‡å¿—(MP)
</span></span><span class="line"><span class="cl">	movl %eax,%cr0
</span></span><span class="line"><span class="cl">	call check_x87
</span></span><span class="line"><span class="cl">	jmp after_page_tables
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/*
</span></span><span class="line"><span class="cl"> * We depend on ET to be correct. This checks for 287/387.
</span></span><span class="line"><span class="cl"> */
</span></span><span class="line"><span class="cl"> ; fninitå’Œfstswæ˜¯åå¤„ç†å™¨çš„æŒ‡ä»¤
</span></span><span class="line"><span class="cl">check_x87:
</span></span><span class="line"><span class="cl">	fninit           # å‘åå¤„ç†å™¨å‘å‡ºåˆå§‹åŒ–æŒ‡ä»¤
</span></span><span class="line"><span class="cl">	fstsw %ax        # å°†åå¤„ç†å™¨çŠ¶æ€å­—å¤åˆ¶ç»™ax
</span></span><span class="line"><span class="cl">	cmpb $0,%al		 # åˆå§‹åŒ–åçŠ¶æ€å­—åº”è¯¥ä½0ï¼Œå¦åˆ™åå¤„ç†å™¨ä¸å­˜åœ¨
</span></span><span class="line"><span class="cl">	je 1f			/* no coprocessor: have to set bits */ #è·³è½¬åˆ°æ ‡å·ä½1å¤„(å‰é¢)
</span></span><span class="line"><span class="cl">	movl %cr0,%eax   # å¦‚æœå­˜åœ¨åˆ™è·³åˆ°æ ‡å·ä½1å¤„ï¼Œå¦åˆ™æ”¹å†™cr0
</span></span><span class="line"><span class="cl">	xorl $6,%eax		/* reset MP, set EM */ ;è®¾ç½®åå¤„ç†å™¨ä»¿çœŸä½(EM)
</span></span><span class="line"><span class="cl">	movl %eax,%cr0
</span></span><span class="line"><span class="cl">	ret
</span></span><span class="line"><span class="cl"># .align æ˜¯æ±‡ç¼–è¯­è¨€æŒ‡ç¤ºç¬¦ï¼Œç”¨äºå­˜å‚¨è¾¹ç•Œå¯¹é½è°ƒæ•´
</span></span><span class="line"><span class="cl"># 2è¡¨ç¤ºæŠŠéšåçš„ä»£ç å’Œæ•°æ®çš„åç§»ä½ç½®è°ƒæ•´åˆ°åœ°å€å€¼æœ€å2æ¯”ç‰¹ä½ä¸º0çš„ä½ç½®(2*2)
</span></span><span class="line"><span class="cl"># å³æŒ‰å››å­—èŠ‚æ–¹å¼å¯¹é½å†…å­˜åœ°å€
</span></span><span class="line"><span class="cl"># ä½¿ç”¨è¯¥æŒ‡ç¤ºç¬¦ç›®çš„æ˜¯ä¸ºäº†æé«˜32ä½cpuè®¿é—®å†…å­˜ä¸­ä»£ç æˆ–æ•°æ®çš„é€Ÿåº¦å’Œæ•ˆç‡
</span></span><span class="line"><span class="cl">.align 2
</span></span><span class="line"><span class="cl"># 287åå¤„ç†ç ï¼Œå°†80287è®¾ç½®ä¸ºä¿æŠ¤æ¨¡å¼
</span></span><span class="line"><span class="cl">1:	.byte 0xDB,0xE4		/* fsetpm for 287, ignored by 387 */ 
</span></span><span class="line"><span class="cl">	ret
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/*
</span></span><span class="line"><span class="cl"> *  setup_idt
</span></span><span class="line"><span class="cl"> *
</span></span><span class="line"><span class="cl"> *  sets up a idt with 256 entries pointing to
</span></span><span class="line"><span class="cl"> *  ignore_int, interrupt gates. It then loads
</span></span><span class="line"><span class="cl"> *  idt. Everything that wants to install itself
</span></span><span class="line"><span class="cl"> *  in the idt-table may do so themselves. Interrupts
</span></span><span class="line"><span class="cl"> *  are enabled elsewhere, when we can be relatively
</span></span><span class="line"><span class="cl"> *  sure everything is ok. This routine will be over-
</span></span><span class="line"><span class="cl"> *  written by the page tables.
</span></span><span class="line"><span class="cl"> */
</span></span><span class="line"><span class="cl"> ;è®¾ç½®ä¸­æ–­æè¿°ç¬¦è¡¨(IDT)å­—ç¨‹åºsetup_idt
</span></span><span class="line"><span class="cl"> ; å°†ä¸­æ–­æè¿°ç¬¦è¡¨è®¾ç½®å…·æœ‰256ä¸ªé¡¹ï¼Œå¹¶éƒ½æŒ‡å‘ignore_intä¸­æ–­é—¨ï¼Œç„¶ååŠ è½½ä¸­æ–­æè¿°ç¬¦è¡¨å¯„å­˜å™¨
</span></span><span class="line"><span class="cl"> ; ä¸­æ–­æè¿°ç¬¦è¡¨ä¸­çš„é¡¹ä¸º8ä¸ªå­—èŠ‚ï¼Œç§°ä¸ºé—¨æè¿°ç¬¦
</span></span><span class="line"><span class="cl">setup_idt:
</span></span><span class="line"><span class="cl">	lea ignore_int,%edx  # å°†ignore_intæœ‰æ•ˆåœ°å€å€¼èµ‹å€¼ç»™edx
</span></span><span class="line"><span class="cl">	movl $0x00080000,%eax # å°†é€‰æ‹©ç¬¦0x0008èµ‹å€¼ç»™eaxçš„é«˜16ä½
</span></span><span class="line"><span class="cl">	movw %dx,%ax		/* selector = 0x0008 = cs */
</span></span><span class="line"><span class="cl">	movw $0x8E00,%dx	/* interrupt gate - dpl=0, present */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	lea _idt,%edi               # _idt æ˜¯ä¸­æ–­æè¿°ç¬¦è¡¨çš„åœ°å€
</span></span><span class="line"><span class="cl">	mov $256,%ecx
</span></span><span class="line"><span class="cl">rp_sidt:
</span></span><span class="line"><span class="cl">	movl %eax,(%edi)			# eax -&gt; [edi] å°†å“‘ä¸­æ–­é—¨æè¿°ç¬¦å­˜å…¥è¡¨ä¸­
</span></span><span class="line"><span class="cl">	movl %edx,4(%edi)           # edx -&gt; [edi+4]
</span></span><span class="line"><span class="cl">	addl $8,%edi				# edi + 8 -&gt; edi
</span></span><span class="line"><span class="cl">	dec %ecx
</span></span><span class="line"><span class="cl">	jne rp_sidt
</span></span><span class="line"><span class="cl">	lidt idt_descr              #åŠ è½½ä¸­æ–­æè¿°ç¬¦è¡¨å¯„å­˜å™¨
</span></span><span class="line"><span class="cl">	ret
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/*
</span></span><span class="line"><span class="cl"> *  setup_gdt
</span></span><span class="line"><span class="cl"> *
</span></span><span class="line"><span class="cl"> *  This routines sets up a new gdt and loads it.
</span></span><span class="line"><span class="cl"> *  Only two entries are currently built, the same
</span></span><span class="line"><span class="cl"> *  ones that were built in init.s. The routine
</span></span><span class="line"><span class="cl"> *  is VERY complicated at two whole lines, so this
</span></span><span class="line"><span class="cl"> *  rather long comment is certainly needed :-).
</span></span><span class="line"><span class="cl"> *  This routine will beoverwritten by the page tables.
</span></span><span class="line"><span class="cl"> */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> # è®¾ç½®å…¨å±€æè¿°ç¬¦è¡¨é¡¹
</span></span><span class="line"><span class="cl">setup_gdt:
</span></span><span class="line"><span class="cl">	lgdt gdt_descr    # åŠ è½½å…¨å±€æè¿°ç¬¦å¯„å­˜å™¨
</span></span><span class="line"><span class="cl">	ret
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/*
</span></span><span class="line"><span class="cl"> * I put the kernel page tables right after the page directory,
</span></span><span class="line"><span class="cl"> * using 4 of them to span 16 Mb of physical memory. People with
</span></span><span class="line"><span class="cl"> * more than 16MB will have to expand this.
</span></span><span class="line"><span class="cl"> */
</span></span><span class="line"><span class="cl"> # å°†å†…æ ¸çš„å†…å­˜é¡µè¡¨ç›´æ¥æ”¾åœ¨é¡µç›®å½•åï¼Œä½¿ç”¨4ä¸ªè¡¨æ¥å¯»å€16MBçš„ç‰©ç†åœ°å€
</span></span><span class="line"><span class="cl">.org 0x1000            # ä»åç§»åœ°å€0x1000å¤„å¼€å§‹æ˜¯ç¬¬ä¸€ä¸ªé¡µè¡¨(åç§»0å¼€å§‹å°†å­˜æ”¾é¡µè¡¨ç›®å½•)
</span></span><span class="line"><span class="cl">pg0:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">.org 0x2000
</span></span><span class="line"><span class="cl">pg1:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">.org 0x3000
</span></span><span class="line"><span class="cl">pg2:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">.org 0x4000
</span></span><span class="line"><span class="cl">pg3:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">.org 0x5000            # å®šä¹‰ä¸‹é¢çš„å†…å­˜æ•°æ®ä»åç§»åœ°å€0x5000å¼€å§‹
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/*
</span></span><span class="line"><span class="cl"> * tmp_floppy_area is used by the floppy-driver when DMA cannot
</span></span><span class="line"><span class="cl"> * reach to a buffer-block. It needs to be aligned, so that it isn&#39;t
</span></span><span class="line"><span class="cl"> * on a 64kB border.
</span></span><span class="line"><span class="cl"> */
</span></span><span class="line"><span class="cl"> # å½“DMA(ç›´æ¥å­˜å‚¨å™¨è®¿é—®)ä¸èƒ½è®¿é—®ç¼“å†²å—æ—¶ï¼Œåˆ™_tmp_floppy_areaå†…å­˜å—å°±å¯ä»¥ä¾›è½¯ç›˜é©±åŠ¨ç¨‹åºä½¿ç”¨
</span></span><span class="line"><span class="cl"> # éœ€è¦ä¿è¯åœ°å€å¯¹é½
</span></span><span class="line"><span class="cl">_tmp_floppy_area:
</span></span><span class="line"><span class="cl">	.fill 1024,1,0    # ä¿ç•™1024é¡¹ï¼Œæ¯ä¸€é¡¹ä¸€ä¸ªå­—èŠ‚ï¼Œå¡«å……æ•°å€¼ä¸º0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># ä¸‹é¢å‡ ä¸ªå…¥æ ˆæ“ä½œä¸ºäº†è·³è½¬åˆ°init/main.cä¸­main()å‡½æ•°åšå‡†å¤‡
</span></span><span class="line"><span class="cl"># å‰é¢ä¸‰ä¸ªå…¥æ ˆ0å€¼åˆ†åˆ«è¡¨ç¤ºenvp,argvæŒ‡é’ˆå’Œargcçš„å€¼
</span></span><span class="line"><span class="cl">after_page_tables:
</span></span><span class="line"><span class="cl">	pushl $0		# These are the parameters to main :-)  mainå‡½æ•°å‚æ•° envp
</span></span><span class="line"><span class="cl">	pushl $0		# argvæŒ‡é’ˆ
</span></span><span class="line"><span class="cl">	pushl $0		# argc
</span></span><span class="line"><span class="cl">	pushl $L6		# return address for main, if it decides to. æ¨¡æ‹Ÿè°ƒç”¨mainæ—¶é¦–å…ˆå°†è¿”å›åœ°å€å…¥æ ˆçš„æ“ä½œ
</span></span><span class="line"><span class="cl">	pushl $_main    # _main---&gt;main
</span></span><span class="line"><span class="cl">	jmp setup_paging
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># mainå‡½æ•°åˆ°ä¸äº†è¿™é‡Œ ï¼Œåˆ°æ ‡å·L6è¿™é‡Œï¼Œæ˜¯ä¸€ä¸ªæ­»å¾ªç¯
</span></span><span class="line"><span class="cl">L6: 
</span></span><span class="line"><span class="cl">	jmp L6			# main should never return here, but
</span></span><span class="line"><span class="cl">				# just in case, we know what happens.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/* This is the default interrupt &#34;handler&#34; :-) */
</span></span><span class="line"><span class="cl"># ä¸‹é¢æ˜¯é»˜è®¤çš„ä¸­æ–­&#39;å‘é‡å¥æŸ„&#39;&#39;
</span></span><span class="line"><span class="cl">int_msg:
</span></span><span class="line"><span class="cl">	.asciz &#34;Unknown interruptnr&#34;     # å®šä¹‰â€˜æœªçŸ¥çš„æŒ‡å®šâ€™
</span></span><span class="line"><span class="cl">.align 2                               # æŒ‰4å­—èŠ‚æ–¹å¼å¯¹é½å†…å­˜åœ°å€
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># ä¸­æ–­å¤„ç†è¿‡ç¨‹
</span></span><span class="line"><span class="cl">ignore_int:
</span></span><span class="line"><span class="cl">	pushl %eax
</span></span><span class="line"><span class="cl">	pushl %ecx
</span></span><span class="line"><span class="cl">	pushl %edx
</span></span><span class="line"><span class="cl">	push %ds                            # è¿™é‡Œè¯·æ³¨æ„dsï¼Œesï¼Œfsï¼Œgsç­‰è™½ç„¶æ˜¯16ä½çš„å¯„å­˜å™¨
</span></span><span class="line"><span class="cl">	push %es                            # ä½†ä»ç„¶ä¼šä»¥32ä½çš„å½¢å¼å…¥æ ˆï¼Œå³éœ€è¦å ç”¨4ä¸ªå­—èŠ‚çš„æ ˆç©ºé—´
</span></span><span class="line"><span class="cl">	push %fs                            # ä»¥ä¸Šç”¨äºä¿å­˜å¯„å­˜å™¨
</span></span><span class="line"><span class="cl">	movl $0x10,%eax
</span></span><span class="line"><span class="cl">	mov %ax,%ds
</span></span><span class="line"><span class="cl">	mov %ax,%es
</span></span><span class="line"><span class="cl">	mov %ax,%fs
</span></span><span class="line"><span class="cl">	pushl $int_msg 
</span></span><span class="line"><span class="cl">	call _printk                        # è¯¥å‡½æ•°åœ¨ kernel/printk.c ä¸­
</span></span><span class="line"><span class="cl">	popl %eax                           # æ¸…ç†å‚æ•°
</span></span><span class="line"><span class="cl">	pop %fs
</span></span><span class="line"><span class="cl">	pop %es
</span></span><span class="line"><span class="cl">	pop %ds
</span></span><span class="line"><span class="cl">	popl %edx
</span></span><span class="line"><span class="cl">	popl %ecx
</span></span><span class="line"><span class="cl">	popl %eax
</span></span><span class="line"><span class="cl">	iret                                # ä¸­æ–­è¿”å›(æŠŠä¸­æ–­è°ƒç”¨æ˜¯å‹å…¥æ ˆçš„CPUæ ‡å¿—å¯„å­˜å™¨å€¼ä¹Ÿå¼¹å‡º)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/*
</span></span><span class="line"><span class="cl"> * Setup_paging
</span></span><span class="line"><span class="cl"> *
</span></span><span class="line"><span class="cl"> * This routine sets up paging by setting the page bit
</span></span><span class="line"><span class="cl"> * in cr0. The page tables are set up, identity-mapping
</span></span><span class="line"><span class="cl"> * the first 16MB. The pager assumes that no illegal
</span></span><span class="line"><span class="cl"> * addresses are produced (ie &gt;4Mb on a 4Mb machine).
</span></span><span class="line"><span class="cl"> *
</span></span><span class="line"><span class="cl"> * NOTE! Although all physical memory should be identity
</span></span><span class="line"><span class="cl"> * mapped by this routine, only the kernel page functions
</span></span><span class="line"><span class="cl"> * use the &gt;1Mb addresses directly. All &#34;normal&#34; functions
</span></span><span class="line"><span class="cl"> * use just the lower 1Mb, or the local data space, which
</span></span><span class="line"><span class="cl"> * will be mapped to some other place - mm keeps track of
</span></span><span class="line"><span class="cl"> * that.
</span></span><span class="line"><span class="cl"> *
</span></span><span class="line"><span class="cl"> * For those with more memory than 16 Mb - tough luck. I&#39;ve
</span></span><span class="line"><span class="cl"> * not got it, why should you :-) The source is here. Change
</span></span><span class="line"><span class="cl"> * it. (Seriously - it shouldn&#39;t be too difficult. Mostly
</span></span><span class="line"><span class="cl"> * change some constants etc. I left it at 16Mb, as my machine
</span></span><span class="line"><span class="cl"> * even cannot be extended past that (ok, but it was cheap :-)
</span></span><span class="line"><span class="cl"> * I&#39;ve tried to show which constants to change by having
</span></span><span class="line"><span class="cl"> * some kind of marker at them (search for &#34;16Mb&#34;), but I
</span></span><span class="line"><span class="cl"> * won&#39;t guarantee that&#39;s all :-( )
</span></span><span class="line"><span class="cl"> */
</span></span><span class="line"><span class="cl"> # ä¸‹é¢è¿™æ®µå­ç¨‹åºé€šè¿‡æ§åˆ¶CR0çš„æ ‡å¿—ä½(PGä½31)æ¥å¯åŠ¨å¯¹å†…å­˜çš„åˆ†é¡µå¤„ç†åŠŸèƒ½ï¼Œå¹¶è®¾ç½®å„ä¸ªè¡¨é¡¹çš„å†…å®¹	
</span></span><span class="line"><span class="cl">.align 2                    # æŒ‰4å­—èŠ‚æ–¹å¼å¯¹é½å†…å­˜åœ°å€è¾¹ç•Œ
</span></span><span class="line"><span class="cl">setup_paging:
</span></span><span class="line"><span class="cl">	movl $1024*5,%ecx		/* 5 pages - pg_dir+4 page tables */#å¯¹(1é¡µç›®å½•+4é¡µé¡µè¡¨)æ¸…é›¶
</span></span><span class="line"><span class="cl">	xorl %eax,%eax
</span></span><span class="line"><span class="cl">	xorl %edi,%edi			/* pg_dir is at 0x000 */ #ç›®å½•é¡µä»0x00å¼€å§‹
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	cld;rep;stosl
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	# è®¾ç½®é¡µç›®å½•è¡¨ä¸­çš„é¡¹ï¼Œå†…æ ¸ä¸­æœ‰4ä¸ªé¡µè¡¨éœ€è¦è®¾ç½®4é¡¹
</span></span><span class="line"><span class="cl">	movl $pg0+7,_pg_dir		/* set present bit/user r/w */# pg0+7ï¼š0x000010007,é¡µç›®å½•è¡¨ä¸­çš„ç¬¬ä¸€é¡¹
</span></span><span class="line"><span class="cl">	movl $pg1+7,_pg_dir+4		/*  --------- &#34; &#34; --------- */
</span></span><span class="line"><span class="cl">	movl $pg2+7,_pg_dir+8		/*  --------- &#34; &#34; --------- */
</span></span><span class="line"><span class="cl">	movl $pg3+7,_pg_dir+12		/*  --------- &#34; &#34; --------- */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	# å¡«å†™4ä¸ªé¡µè¡¨ä¸­æ‰€æœ‰å†…å®¹ï¼š4(é¡µè¡¨)*1024(é¡¹)=4096(é¡¹)
</span></span><span class="line"><span class="cl">	movl $pg3+4092,%edi
</span></span><span class="line"><span class="cl">	movl $0xfff007,%eax		/*  16Mb - 4096 + 7 (r/w user,p) */
</span></span><span class="line"><span class="cl">	std
</span></span><span class="line"><span class="cl">1:	stosl			/* fill pages backwards - more efficient :-) */
</span></span><span class="line"><span class="cl">	subl $0x1000,%eax
</span></span><span class="line"><span class="cl">	jge 1b
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	# è®¾ç½®é¡µç›®å½•è¡¨åŸºå€å¯„å­˜å™¨CR3çš„å€¼(ä¿å­˜çš„é¡µç›®å½•è¡¨çš„ç‰©ç†åœ°å€)ï¼ŒæŒ‡å‘é¡µç›®å½•è¡¨ï¼Œ
</span></span><span class="line"><span class="cl">	xorl %eax,%eax		/* pg_dir is at 0x0000 */
</span></span><span class="line"><span class="cl">	movl %eax,%cr3		/* cr3 - page directory start */
</span></span><span class="line"><span class="cl">	movl %cr0,%eax
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	# è®¾ç½®å¯ç”¨åˆ†é¡µå¤„ç†ï¼Œ(cr0çš„æ ‡å¿—PG,ä½31)
</span></span><span class="line"><span class="cl">	orl $0x80000000,%eax
</span></span><span class="line"><span class="cl">	movl %eax,%cr0		/* set paging (PG) bit */
</span></span><span class="line"><span class="cl">	ret			/* this also flushes prefetch-queue */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># åœ¨æ”¹å˜åˆ†é¡µå¤„ç†æ ‡å¿—åè¦æ±‚ä½¿ç”¨è½¬ç§»æŒ‡ä»¤åˆ·æ–°é¢„å–æŒ‡ä»¤é˜Ÿåˆ—ï¼Œè¿™é‡Œç”¨çš„æ˜¯è¿”å›æŒ‡ä»¤ret
</span></span><span class="line"><span class="cl"># è¿”å›æŒ‡ä»¤çš„ä½œç”¨å°†mainç¨‹åºå‹å…¥æ ˆä¸­çš„åœ°å€å¼¹å‡ºï¼Œå¹¶è½¬åˆ°init/main.cå»è¿è¡Œ
</span></span><span class="line"><span class="cl">.align 2
</span></span><span class="line"><span class="cl">.word 0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># åŠ è½½ä¸­æ–­æè¿°ç¬¦è¡¨å¯„å­˜å™¨idtrçš„lidtæŒ‡ä»¤
</span></span><span class="line"><span class="cl">idt_descr:
</span></span><span class="line"><span class="cl">	.word 256*8-1		# idt contains 256 entries
</span></span><span class="line"><span class="cl">	.long _idt
</span></span><span class="line"><span class="cl">.align 2
</span></span><span class="line"><span class="cl">.word 0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># åŠ è½½å…¨å±€æè¿°ç¬¦è¡¨å¯„å­˜å™¨gdtrçš„lgdtæŒ‡ä»¤
</span></span><span class="line"><span class="cl">gdt_descr:
</span></span><span class="line"><span class="cl">	.word 256*8-1		# so does gdt (not that that&#39;s any
</span></span><span class="line"><span class="cl">	.long _gdt		# magic number, but it works for me :^)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	.align 3
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">_idt:	.fill 256,8,0		# idt is uninitialized
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># å…¨å±€è¡¨ï¼Œå‰4é¡¹æ˜¯ç©ºé¡¹ï¼Œä»£ç æ®µæè¿°ç¬¦ï¼Œæ•°æ®æ®µæè¿°ç¬¦ï¼Œç³»ç»Ÿè°ƒç”¨æ®µæè¿°ç¬¦
</span></span><span class="line"><span class="cl">_gdt:	.quad 0x0000000000000000	/* NULL descriptor */
</span></span><span class="line"><span class="cl">	.quad 0x00c09a0000000fff	/* 16Mb */
</span></span><span class="line"><span class="cl">	.quad 0x00c0920000000fff	/* 16Mb */
</span></span><span class="line"><span class="cl">	.quad 0x0000000000000000	/* TEMPORARY - don&#39;t use */
</span></span><span class="line"><span class="cl">	.fill 252,8,0			/* space for LDT&#39;s and TSS&#39;s etc */
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="åˆå§‹åŒ–ç¨‹åº---main1">åˆå§‹åŒ–ç¨‹åº&mdash;main(1)<a hidden class="anchor" aria-hidden="true" href="#åˆå§‹åŒ–ç¨‹åº---main1">#</a></h1>
<h2 id="1å°ç»“">(1)å°ç»“<a hidden class="anchor" aria-hidden="true" href="#1å°ç»“">#</a></h2>
<p>1.bootsect.sç¨‹åºçš„ä¸»è¦åŠŸèƒ½ï¼šå°†setup.så’Œsystemæ¨¡å—åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¹¶ä¸”å°†è‡ªèº«ç§»åŠ¨åˆ°0x90000å¤„ï¼Œç„¶åæ§åˆ¶æƒäº¤ç»™setup.sç¨‹åº</p>
<p>2.setupç¨‹åºï¼šåˆ©ç”¨BIOSè·å–ç¡¬ä»¶å‚æ•°å¹¶ä¿å­˜ï¼ˆmain.cä¼šç”¨åˆ°çš„ï¼‰ï¼›å°†systemç§»åŠ¨åˆ°0x00000ï¼›æè¿°ç¬¦è¡¨å¯„å­˜å™¨è®¾ç½®ï¼›ç¡¬ä»¶ä¸­æ–­è®¾ç½®ï¼›è®¾ç½®CR0è¿›å…¥32ä½ä¿æŠ¤æ¨¡å¼ï¼Œæ§åˆ¶æƒäº¤ç»™head.s</p>
<p>3.head.sç¨‹åºï¼šåˆæ­¥åˆå§‹åŒ–ä¸­æ–­æè¿°ç¬¦è¡¨é¡¹ï¼ˆå“‘ä¸­æ–­ï¼‰ï¼›æ£€æŸ¥A20ï¼›æµ‹è¯•æ˜¯å¦æœ‰åå¤„ç†å™¨ï¼›åˆå§‹åŒ–å†…å­˜é¡µç›®å½•è¡¨ï¼›è·³è½¬åˆ°main.cæ‰§è¡Œå†…æ ¸åˆå§‹åŒ–</p>
<h2 id="2åŠŸèƒ½æè¿°">(2)åŠŸèƒ½æè¿°<a hidden class="anchor" aria-hidden="true" href="#2åŠŸèƒ½æè¿°">#</a></h2>
<p>ç³»ç»Ÿæ‰§è¡Œå®Œboot/head.sç¨‹åºå°±ä¼šå°†æ‰§è¡Œæƒäº¤ç»™main.c</p>
<p>main.cé¦–å…ˆåˆ©ç”¨setup.så–å¾—çš„ç³»ç»Ÿå‚æ•°è®¾ç½®ç³»ç»Ÿçš„æ ¹æ–‡ä»¶è®¾å¤‡å·ä»¥åŠä¸€äº›å†…å­˜å…¨å±€å˜é‡ï¼Œè¿™äº›å˜é‡æŒ‡æ˜äº†ä¸»å†…å­˜çš„å¼€å§‹åœ°å€ï¼Œç³»ç»Ÿæ‰€æ‹¥æœ‰çš„å†…å­˜å®¹é‡å’Œä½œä¸ºé«˜é€Ÿç¼“å­˜åŒºçš„æœ«ç«¯åœ°å€ã€‚è‹¥å®šä¹‰äº†è™šæ‹Ÿç›˜ï¼Œåˆ™ä¸»å†…å­˜å°†é€‚å½“å‡å°‘</p>
<p>å¦‚åŒç³»ç»ŸåŠŸèƒ½</p>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012320707.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"  />
</p>
<p>é«˜é€Ÿç¼“å†²åŒºè¿˜è¦æ‰£é™¤è¢«æ˜¾å­˜å’ŒROM BIOSå ç”¨çš„éƒ¨åˆ†ã€‚</p>
<p>é«˜é€Ÿç¼“å­˜åŒºæ˜¯ç”¨äºç£ç›˜ç­‰å—è®¾å¤‡ä¸´æ—¶å­˜æ”¾æ•°æ®çš„åœ°æ–¹ï¼Œä»¥1kå­—èŠ‚ä¸ºæ•°æ®å—å•ä½ã€‚</p>
<p>ä¸»å†…å­˜åŒºçš„å†…å­˜ç”±å†…å­˜ç®¡ç†æ¨¡å—mmé€šè¿‡åˆ†é¡µæœºåˆ¶è¿›è¡Œç®¡ç†åˆ†é…ï¼Œä»¥4kå­—èŠ‚ä¸ºä¸€ä¸ªå†…å­˜é¡µå•ä½</p>
<p>å†…æ ¸ç¨‹åºå¯ä»¥è‡ªç”±è®¿é—®é«˜é€Ÿç¼“å†²åŒºçš„æ•°æ®ï¼Œä½†éœ€è¦é€šè¿‡mmæ‰èƒ½ä½¿ç”¨åˆ†é…åˆ°çš„å†…å­˜é¡µé¢</p>
<p>å†…æ ¸è¿›è¡Œæ‰€æœ‰çš„æ–¹é¢çš„ç¡¬ä»¶åˆå§‹åŒ–å·¥ä½œã€‚åŒ…æ‹¬é™·é˜±é—¨ï¼Œå—è®¾å¤‡ï¼Œå­—ç¬¦è®¾å¤‡ï¼Œttyï¼Œè¿˜åŒ…æ‹¬äººå·¥è®¾ç½®çš„ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼ˆtask 0).</p>
<p>æ‰€æœ‰çš„åˆå§‹åŒ–å·¥ä½œå®Œæˆåç¨‹åºå°±è®¾ç½®ä¸­æ–­å…è®¸æ ‡å¿—ä»¥å¼€å¯ä¸­æ–­ï¼Œå¹¶åˆ‡æ¢åˆ°ä»»åŠ¡0ä¸­å…è®¸ã€‚</p>
<p>åœ¨æ•´ä¸ªå†…æ ¸åˆå§‹åŒ–å®Œæˆåï¼Œå†…æ ¸å°†æ‰§è¡Œæƒåˆ‡æ¢åˆ°ç”¨æˆ·æ¨¡å¼ï¼ˆä»»åŠ¡0ï¼‰ï¼Œ</p>
<p>CPUä»0ç‰¹æƒçº§åˆ‡æ¢åˆ°äº†ç¬¬3ä¸ªç‰¹æƒçº§ï¼Œç„¶åæ­¤æ—¶mainå‡½æ•°å·¥ä½œå°±åœ¨ä»»åŠ¡0ä¸­ï¼Œæœ€åç³»ç»Ÿç¬¬ä¸€æ¬¡è°ƒç”¨è¿›ç¨‹åˆ›å»ºå‡½æ•°fork()ï¼Œåˆ›å»ºå‡ºä¸€ä¸ªç”¨äºè¿è¡Œinit() çš„å­è¿›ç¨‹ï¼ˆinitè¿›ç¨‹ï¼‰</p>
<p>å†…æ ¸åˆå§‹åŒ–æµç¨‹</p>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012320708.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"  />
</p>
<p>1.main.cç¨‹åºé¦–å…ˆç¡®å®šå¦‚ä½•åˆ†é…ä½¿ç”¨ç³»ç»Ÿç‰©ç†å†…å­˜ï¼Œç„¶åè°ƒç”¨å†…æ ¸å„éƒ¨åˆ†çš„åˆå§‹åŒ–å‡½æ•°åˆ†åˆ«å¯¹å†…å­˜ç®¡ç†ã€ä¸­æ–­å¤„ç†ã€å—è®¾å¤‡å’Œå­—ç¬¦è®¾å¤‡ã€è¿›ç¨‹ç®¡ç†ä»¥åŠç¡¬ç›˜å’Œè½¯ç›˜ç¡¬ä»¶è¿›è¡Œåˆå§‹åŒ–å¤„ç†ã€‚åœ¨å®Œæˆäº†è¿™äº›æ“ä½œä¹‹åï¼Œç³»ç»Ÿå„éƒ¨åˆ†å·²ç»å¤„äºå¯è¿è¡ŒçŠ¶æ€ã€‚æ­¤åç¨‹åºæŠŠè‡ªå·±â€œæ‰‹å·¥â€ç§»åŠ¨åˆ°ä»»åŠ¡0ï¼ˆè¿›ç¨‹0ï¼‰ä¸­è¿è¡Œï¼Œå¹¶ä½¿ç”¨fork/è°ƒç”¨é¦–æ¬¡åˆ›å»ºå‡ºè¿›ç¨‹1ï¼ˆintiè¿›ç¨‹ï¼‰ï¼Œå¹¶åœ¨å…¶ä¸­è°ƒç”¨min()å‡½æ•°ã€‚åœ¨è¯¥å‡½æ•°ä¸­ç¨‹åºå°†ç»§ç»­è¿›è¡Œåº”ç”¨ç¯å¢ƒçš„åˆå§‹åŒ–å¹¶æ‰§è¡Œshellç™»å½•ç¨‹åºã€‚è€ŒåŸè¿›ç¨‹0åˆ™ä¼šåœ¨ç³»ç»Ÿç©ºé—²æ—¶è¢«è°ƒåº¦æ‰§è¡Œï¼Œ<strong>å› æ­¤è¿›ç¨‹0é€šå¸¸ä¹Ÿè¢«ç§°ä¸ºidleè¿›ç¨‹ã€‚æ­¤æ—¶è¿›ç¨‹0ä»…æ‰§è¡Œpause()ç³»ç»Ÿè°ƒç”¨ï¼Œå¹¶åˆä¼šè°ƒç”¨è°ƒåº¦å‡½æ•°ã€‚</strong></p>
<p>2.<strong>init å‡½æ•°çš„åŠŸèƒ½å¯åˆ†ä¸º4ä¸ªéƒ¨åˆ†ï¼š</strong></p>
<p><strong>â‘ å®‰è£…æ ¹æ–‡ä»¶ç³»ç»Ÿï¼›</strong></p>
<p><strong>â‘¡æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯ï¼›</strong></p>
<p><strong>â‘¢è¿è¡Œç³»ç»Ÿåˆå§‹èµ„æºé…ç½®æ–‡ä»¶reä¸­çš„å‘½ä»¤ï¼›</strong></p>
<p><strong>â‘£æ‰§è¡Œç”¨æˆ·ç™»å½•shellç¨‹åºã€‚</strong></p>
<p>3.ä»£ç é¦–å…ˆè°ƒç”¨ç³»ç»Ÿè°ƒç”¨setup()ï¼Œç”¨æ¥æ”¶é›†ç¡¬ç›˜è®¾å¤‡åˆ†åŒºè¡¨ä¿¡æ¯å¹¶å®‰è£…æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚åœ¨å®‰è£…æ ¹æ–‡ä»¶ç³»ç»Ÿä¹‹å‰ï¼Œç³»ç»Ÿä¼šå…ˆåˆ¤æ–­æ˜¯å¦éœ€è¦å…ˆå»ºç«‹è™šæ‹Ÿç›˜ã€‚è‹¥ç¼–è¯‘å†…æ ¸æ—¶è®¾ç½®äº†è™šæ‹Ÿç›˜çš„å¤§å°ï¼Œå¹¶åœ¨å‰é¢å†…æ ¸åˆå§‹åŒ–è¿‡ç¨‹ä¸­å·²ç»å¼€è¾Ÿäº†ä¸€å—å†…å­˜ç”¨ä½œè™šæ‹Ÿç›˜ï¼Œåˆ™å†…æ ¸å°±ä¼šé¦–å…ˆå°è¯•æŠŠæ ¹æ–‡ä»¶ç³»ç»ŸåŠ è½½åˆ°å†…å­˜çš„è™šæ‹Ÿç›˜åŒºä¸­ã€‚</p>
<p>4.ç„¶åiniiæ‰“å¼€ä¸€ä¸ªç»ˆç«¯è®¾å¤‡tty0ï¼Œå¹¶å¤åˆ¶å…¶æ–‡ä»¶æè¿°ç¬¦ä»¥äº§ç”Ÿæ ‡å‡†è¾“å…¥stdinã€æ ‡å‡†è¾“å‡ºstdoutå’Œé”™è¯¯è¾“å‡ºwaterè®¾å¤‡ã€‚å†…æ ¸éšååˆ©ç”¨è¿™äº›æè¿°ç¬¦åœ¨ç»ˆç«¯ä¸Šæ˜¾ç¤ºä¸€äº›ç³»ç»Ÿä¿¡æ¯ï¼Œä¾‹å¦‚é«˜é€Ÿç¼“å†²åŒºä¸­ç¼“å†²å—æ€»æ•°ã€ä¸»å†…å­˜åŒºç©ºé—²å†…å­˜æ€»å­—èŠ‚æ•°ç­‰ã€‚</p>
<p>5.æ¥ç€initåˆæ–°å»ºäº†ä¸€ä¸ªè¿›ç¨‹(è¿›ç¨‹2)ï¼Œå¹¶åœ¨å…¶ä¸­ä¸ºå»ºç«‹ç”¨æˆ·äº¤äº’ä½¿ç”¨ç¯å¢ƒè€Œæ‰§è¡Œä¸€äº›åˆå§‹é…ç½®æ“ä½œï¼Œå³åœ¨ç”¨æˆ·å¯ä»¥ä½¿ç”¨shellå‘½ä»¤è¡Œç¯å¢ƒä¹‹å‰ï¼Œå†…æ ¸è°ƒç”¨/bin/shç¨‹åºè¿è¡Œäº†é…ç½®æ–‡ä»¶etcä¸­è®¾ç½®çš„å‘½ä»¤ã€‚æ–‡ä»¶çš„ä½œç”¨ä¸DOSç³»ç»Ÿæ ¹ç›®å½•ä¸Šçš„AUTOEXEC.BATæ–‡ä»¶ç±»ä¼¼ã€‚è¿™æ®µä»£ç é¦–å…ˆé€šè¿‡å…³é—­æ–‡ä»¶æè¿°ç¬¦Dï¼Œå¹¶ç«‹åˆ»æ‰“å¼€æ–‡ä»¶/teé™µrÃ¹ï¼Œä»è€ŒæŠŠæ ‡å‡†è¾“å…¥stdmå®šå‘åˆ°etc/reæ–‡ä»¶ä¸Šã€‚è¿™æ ·ï¼Œæ‰€æœ‰çš„æ ‡å‡†è¾“å…¥æ•°æ®éƒ½å°†ä»è¯¥æ–‡ä»¶ä¸­è¯»å–ã€‚ç„¶åå†…æ ¸ä»¥éäº¤äº’å½¢å¼æ‰§è¡Œ/bin/shï¼Œä»è€Œå®ç°æ‰§è¡Œ/etc.reæ–‡ä»¶ä¸­çš„å‘½ä»¤ã€‚å½“è¯¥æ–‡ä»¶ä¸­çš„å‘½ä»¤æ‰§è¡Œå®Œæ¯•åï¼Œ/bin/shå°±ä¼šç«‹åˆ»é€€å‡ºã€‚å› æ­¤è¿›ç¨‹2ä¹Ÿå°±éšä¹‹ç»“æŸã€‚</p>
<p>6.initå‡½æ•°çš„æœ€åä¸€éƒ¨ä»½ç”¨äºåœ¨æ–°å»ºè¿›ç¨‹ä¸­ä¸ºç”¨æˆ·å»ºç«‹ä¸€ä¸ªæ–°çš„ä¼šè¯ï¼Œå¹¶è¿è¡Œç”¨æˆ·ç™»å½•shellç¨‹åºï¼Œ/bin/shã€‚åœ¨ç³»ç»Ÿæ‰§è¡Œè¿›ç¨‹2ä¸­çš„ç¨‹åºæ—¶ï¼Œçˆ¶è¿›ç¨‹(mitè¿›ç¨‹)ä¸€ç›´ç­‰å¾…ç€å®ƒçš„ç»“æŸã€‚éšç€è¿›ç¨‹2çš„é€€å‡ºï¼Œçˆ¶è¿›ç¨‹å°±è¿›å…¥åˆ°ä¸€ä¸ªæ— é™å¾ªç¯ä¸­ã€‚åœ¨è¯¥å¾ªç¯ä¸­ï¼Œçˆ¶è¿›ç¨‹ä¼šå†æ¬¡ç”Ÿæˆä¸€ä¸ªæ–°è¿›ç¨‹ï¼Œç„¶ååœ¨è¯¥è¿›ç¨‹ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ä¼šè¯ï¼Œå¹¶ä»¥ç™»å½•shellæ–¹å¼å†æ¬¡æ‰§è¡Œç¨‹åº/bin/shï¼Œä»¥åˆ›å»ºç”¨æˆ·äº¤äº’shellç¯å¢ƒã€‚ç„¶åçˆ¶è¿›ç¨‹ç»§ç»­ç­‰å¾…è¯¥å­è¿›ç¨‹ã€‚ç™»å½•shellè™½ç„¶ä¸å‰é¢çš„éäº¤äº’å¼shellæ˜¯åŒä¸€ä¸ªç¨‹åº/bin/shï¼Œä½†æ˜¯æ‰€ä½¿ç”¨çš„å‘½ä»¤è¡Œå‚æ•°( argV[ ])ä¸åŒã€‚ç™»å½•shellçš„ç¬¬0ä¸ªå‘½ä»¤è¡Œå‚æ•°çš„ç¬¬1ä¸ªå­—ç¬¦ä¸€å®šæ˜¯ä¸€ä¸ªå‡å·æ¯”ã€‚è¿™ä¸ªç‰¹å®šçš„æ ‡å¿—ä¼šåœ¨/bin/shæ‰§è¡Œæ—¶é€šçŸ¥å®ƒè¿™ä¸æ˜¯ä¸€æ¬¡æ™®é€šçš„è¿è¡Œï¼Œè€Œæ˜¯ä½œä¸ºç™»å½•shellè¿è¡Œbin/shçš„ã€‚ä»è¿™æ—¶å¼€å§‹ï¼Œç”¨æˆ·å°±å¯ä»¥æ­£å¸¸ä½¿ç”¨Linuxå‘½ä»¤è¡Œç¯å¢ƒäº†ï¼Œè€Œçˆ¶è¿›ç¨‹éšä¹‹åˆè¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚æ­¤åè‹¥ç”¨æˆ·åœ¨å‘½ä»¤è¡Œä¸Šæ‰§è¡Œäº†exitæˆ–Ilogountå‘½ä»¤ï¼Œé‚£ä¹ˆåœ¨æ˜¾ç¤ºä¸€æ¡å½“å‰ç™»å½•shellé€€å‡ºçš„ä¿¡æ¯åï¼Œç³»ç»Ÿå°±ä¼šåœ¨è¿™ä¸ªæ— é™å¾ªç¯ä¸­å†æ¬¡é‡å¤ä»¥ä¸Šåˆ›å»ºç™»å½•shellè¿›ç¨‹çš„è¿‡ç¨‹ã€‚</p>
<p>7.ä»»åŠ¡1ä¸­è¿è¡Œçš„init()å‡½æ•°çš„åä¸¤éƒ¨åˆ†å®é™…ä¸Šåº”è¯¥æ˜¯ç‹¬ç«‹çš„ç¯å¢ƒåˆå§‹åŒ–ç¨‹åºmitç­‰çš„åŠŸèƒ½ã€‚</p>
<p><strong>3.å†…è”å‡½æ•°</strong></p>
<p>ç”±äºåˆ›å»ºæ–°è¿›ç¨‹æ˜¯é€šè¿‡å®Œå…¨å¤åˆ¶çˆ¶è¿›ç¨‹çš„ä»£ç æ®µå’Œæ•°æ®æ®µï¼Œå› æ­¤åœ¨é¦–æ¬¡ä½¿ç”¨fork()åˆ›å»ºè¿›ç¨‹çš„æ—¶å€™ï¼Œä¸ºäº†ç¡®ä¿æ–°è¿›ç¨‹ ç”¨æˆ·æ€æ ˆä¸­æ²¡æœ‰è¿›ç¨‹0çš„å¤šä½™ä¿¡æ¯ï¼Œè¦æ±‚è¿›ç¨‹0åœ¨åˆ›å»ºé¦–ä¸ªæ–°è¿›ç¨‹(è¿›ç¨‹1)ä¹‹å‰ï¼Œä¸è¦ä½¿ç”¨å…¶ç”¨æˆ·æ€æ ˆï¼Œå³è¦æ±‚ä»»åŠ¡0ä¸è¦è°ƒç”¨å‡½æ•°ã€‚</p>
<p>æ‰€ä»¥åœ¨mainç¨‹åºç§»åŠ¨åˆ°ä»»åŠ¡0æ‰§è¡Œåï¼Œä»»åŠ¡0ä¸­çš„ä»£ç fork()ä¸èƒ½ä»¥å‡½æ•°å½¢å¼è¿›è¡Œè°ƒç”¨ï¼Œä»è€Œå¼•å…¥äº†gccå‡½æ•°å†…åµŒå½¢å¼æ¥æ‰§è¡Œè¿™ä¸ªç³»ç»Ÿè°ƒç”¨ã€‚</p>
<blockquote>
<p>static inline _syscall0(int ,fork) â€”&gt;å†…è”å‡½æ•°
é€šè¿‡å£°æ˜ä¸€ä¸ªå†…è”å‡½æ•°ï¼Œå¯ä»¥è®©gccæŠŠå‡½æ•°çš„ä»£ç é›†æˆè°ƒç”¨åˆ°å®ƒçš„ä»£ç ä¸­
çœå»å‡½æ•°è°ƒç”¨çš„å†…å­˜ï¼Œæé«˜ä»£ç æ‰§è¡Œé€Ÿåº¦
æ³¨;è¿™é‡Œçš„0è¡¨ç¤ºåé¢ä¸ºå‚æ•°ï¼Œè‹¥æœ‰ä¸€ä¸ªå‚æ•°åˆ™æ˜¯_syscall1</p>
</blockquote>
<p>-syscall0()æ˜¯unistd.hä¸­å†…åµŒå®ä»£ç ï¼Œä»¥åµŒå…¥å¼æ±‡ç¼–å½¢å¼è°ƒç”¨Linuxçš„ç³»ç»Ÿè°ƒç”¨ä¸­æ–­ int 0x80ï¼Œä¹Ÿå³æ˜¯int fork()åˆ›å»ºè¿›ç¨‹ç³»ç»Ÿè°ƒç”¨</p>
<p>gccè¯­æ³•æ–‡ç« è¯¦æƒ…ï¼š</p>
<p><a href="https://blog.csdn.net/qq_53144843/article/details/120351692?spm=1001.2014.3001.5501">æ·»åŠ é“¾æ¥æè¿°</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define _syscall0(type,name) 
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">type</span> <span class="nf">name</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span> 
</span></span><span class="line"><span class="cl"><span class="kt">long</span> <span class="n">__res</span><span class="p">;</span>                     <span class="c1">// å£°æ˜ä¸€ä¸ªå¯„å­˜å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">__asm__</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">&#34;int $0x80&#34;</span>   <span class="c1">//è°ƒç”¨ç³»ç»Ÿä¸­æ–­ 0x80
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="o">:</span> <span class="s">&#34;=a&#34;</span> <span class="p">(</span><span class="n">__res</span><span class="p">)</span>              <span class="c1">//å°†è¿”å›å€¼--&gt;eax(_res) è¾“å‡ºå¯„å­˜å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="o">:</span> <span class="s">&#34;0&#34;</span> <span class="p">(</span><span class="n">__NR_</span><span class="err">##</span><span class="n">name</span><span class="p">));</span>     <span class="c1">//è¾“å…¥ä¸ºç³»ç»Ÿä¸­æ–­è°ƒç”¨å·_NR_name è¾“å…¥å¯„å­˜å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="n">__res</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="n">__res</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl"><span class="n">errno</span> <span class="o">=</span> <span class="o">-</span><span class="n">__res</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="4cmos">(4)CMOS<a hidden class="anchor" aria-hidden="true" href="#4cmos">#</a></h2>
<p>PCæœºçš„CMOSå†…å­˜å¤§å°ä¸º128æˆ–è€…64å­—èŠ‚å†…å­˜å—ï¼Œæ˜¯ç³»ç»Ÿå®æ—¶æ—¶é’ŸèŠ¯ç‰‡RTCçš„ä¸€éƒ¨åˆ†ï¼Œä¿å­˜æ—¶é—´å’Œæ—¥æœŸä¿¡æ¯ï¼Œå­˜æ”¾çš„æ ¼å¼æ˜¯BCDç </p>
<p>è¦è®¿é—®CMOSéœ€è¦é€šè¿‡ç«¯å£0x70(åœ°å€ç«¯å£)ï¼Œ0x71(æ•°æ®ç«¯å£)</p>
<p>CMOS64å­—èŠ‚ä¿¡æ¯ï¼š</p>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202308012321763.png" alt="image-20230801232102695"  />
</p>
<h1 id="åˆå§‹åŒ–ç¨‹åº---main2">åˆå§‹åŒ–ç¨‹åº&mdash;main(2)<a hidden class="anchor" aria-hidden="true" href="#åˆå§‹åŒ–ç¨‹åº---main2">#</a></h1>
<h2 id="ä¸€æºç åˆ†æ">ä¸€ã€æºç åˆ†æ<a hidden class="anchor" aria-hidden="true" href="#ä¸€æºç åˆ†æ">#</a></h2>
<p>ç³»ç»Ÿåˆå§‹åŒ–ç¨‹åºinit/main.cä¸»è¦åŠŸèƒ½æ˜¯å¯¹ç³»ç»Ÿè¿›è¡Œåˆå§‹åŒ–ï¼Œå¹¶åˆ‡æ¢åˆ°ç”¨æˆ·æ¨¡å¼ä¸‹æ‰§è¡Œç™»å½•ç¨‹åº</p>
<p>(1)åº“æ–‡ä»¶ä»‹ç»</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//  å®å®šä¹‰__LIBRARY__ä¸ºäº†åŒ…æ‹¬åœ¨unistd.hä¸­å†…åµŒæ±‡ç¼–ä»£ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define __LIBRARY__
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// *.hæ‰€åœ¨å¤´æ–‡ä»¶é»˜è®¤ç›®å½•åœ¨include/
</span></span></span><span class="line"><span class="cl"><span class="c1">// unistd.hæ˜¯æ ‡å‡†ç¬¦å·å¸¸æ•°ä¸ç±»å‹æ–‡ä»¶ï¼Œå®šä¹‰äº†å„ç§ç¬¦å·å¸¸æ•°å’Œç±»å‹ï¼Œå¹¶å£°æ˜äº†å„ç§å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1">// è‹¥å®šä¹‰äº†_LIBRARY_,åˆ™è¿˜ä¼šåŒ…å«ç³»ç»Ÿè°ƒç”¨å·å’Œå†…åµŒæ±‡ç¼–ä»£ç å¦‚syscall0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// æ—¶é—´ç±»å‹å¤´æ–‡ä»¶ï¼Œå®šä¹‰äº†tmç»“æ„å’Œå…³äºæ—¶é—´çš„å‡½æ•°åŸå‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/tty.h&gt;   //å®šä¹‰äº†tty_io,ä¸²å£é€šä¿¡æ–¹é¢çš„å‚æ•°ï¼Œå¸¸æ•°</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/sched.h&gt; //è°ƒåº¦ï¼Œå®šä¹‰äº†ä»»åŠ¡ç»“æ„ä½“task_struct,ç¬¬ä¸€ä¸ªåˆå§‹ä»»åŠ¡çš„æ•°æ®</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/head.h&gt;  //å®šä¹‰äº†æ®µæè¿°ç¬¦çš„ç®€å•ç»“æ„å’Œå‡ ä¸ªé€‰æ‹©ç¬¦å¸¸é‡</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;asm/system.h&gt;  //ä»¥å®çš„å½¢å¼å®šä¹‰äº†æœ‰å…³æè¿°ç¬¦å‚æ•°è®¾ç½®æˆ–ä¿®æ”¹æè¿°ç¬¦ï¼Œä¸­æ–­é—¨ç­‰æ±‡ç¼–ç¨‹åº</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;asm/io.h&gt;      //ä»¥åµŒå…¥å¼æ±‡ç¼–ç¨‹åºå½¢å¼å®šä¹‰äº†å¯¹ioç«¯æ“ä½œçš„å‡½æ•°</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stddef.h&gt;     //æ ‡å‡†å®šä¹‰å¤´æ–‡ä»¶ï¼Œå®šä¹‰äº†NULL,TYPE,MEMBER</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdarg.h&gt;		//æ ‡å¿—å‚æ•°å¤´æ–‡ä»¶ï¼Œä»¥å®çš„å½¢å¼å®šä¹‰äº†å˜é‡å‚æ•°åˆ—è¡¨</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>						<span class="c1">//ä¸€ä¸ªç±»å‹ï¼šva_list,ä¸‰ä¸ªå®ï¼šva_start,va_arg,va_end
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>						<span class="c1">//vsprintf,vprintf,vfprintf
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;		//æ ‡å‡†ç¬¦å·å¸¸æ•°ä¸ç±»å‹æ–‡ä»¶ï¼Œå®šä¹‰äº†å„ç§ç¬¦å·å¸¸æ•°å’Œç±»å‹ï¼Œå¹¶å£°æ˜äº†å„ç§å‡½æ•°</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;      //æ–‡ä»¶æ§åˆ¶å¤´æ–‡ä»¶ï¼Œç”¨äºæ–‡ä»¶åŠå…¶æè¿°ç¬¦çš„æ“ä½œæ§åˆ¶å¸¸æ•°ç¬¦å·çš„å®šä¹‰	</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;  //ç±»å‹å¤´æ–‡ä»¶ï¼Œå®šä¹‰äº†åŸºæœ¬çš„ç³»ç»Ÿæ•°æ®ç±»å‹</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/fs.h&gt;   //æ–‡ä»¶ç³»ç»Ÿå¤´æ–‡ä»¶ï¼Œå®šä¹‰äº†æ–‡ä»¶è¡¨ç»“æ„(file,buffer_head,m_inode)</span><span class="cp">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>(2)CMOSè¯»å–æ—¶é—´</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//è¯»å–CMOSå®æ—¶æ—¶é’Ÿä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1">//outb_pç«¯å£è¾“å‡ºå®å®šä¹‰ï¼Œinb_pç«¯å£è¾“å…¥å®å®šä¹‰
</span></span></span><span class="line"><span class="cl"><span class="c1">//0x70æ˜¯å†™åœ°å€ç«¯å£å· 0x80|addræ˜¯è¦è¯»å–CMOSå†…å­˜åœ°å€ï¼Œ0x71æ˜¯åº¦æ•°æ®ç«¯å£å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define CMOS_READ(addr) ({ 
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nf">outb_p</span><span class="p">(</span><span class="mh">0x80</span><span class="o">|</span><span class="n">addr</span><span class="p">,</span><span class="mh">0x70</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl"><span class="nf">inb_p</span><span class="p">(</span><span class="mh">0x71</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//å°†BCDç è½¬åŒ–ä¸ºäºŒè¿›åˆ¶æ•°å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1">//(val)&amp;15å–BCDç ç¬¬å››ä½ä¹Ÿå°±æ˜¯ä¸ªä½ï¼Œval)&gt;&gt;4å³ç§»å››ä½åªå‰©é«˜å››ä½ä¹Ÿå°±æ˜¯åä½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define BCD_TO_BIN(val) ((val)=((val)&amp;15) + ((val)&gt;&gt;4)*10)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//è¯¥å‡½æ•°å–CMOSå®æ—¶ä¸­ä¿¡æ¯ä½œä¸ºå¼€æœºæ—¶é—´ï¼Œå¹¶ä¿å­˜åˆ°å…¨å±€å˜é‡startup_time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">time_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">tm</span> <span class="n">time</span><span class="p">;</span>                         <span class="c1">//æ—¶é—´ç»“æ„ä½“
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="k">do</span> <span class="p">{</span>                                    <span class="c1">//ä»CMOSå†…å­˜åˆ—è¡¨ä¸­è¯»å–æ—¶é—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">time</span><span class="p">.</span><span class="n">tm_sec</span> <span class="o">=</span> <span class="nf">CMOS_READ</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>         <span class="c1">//ç§’å€¼(BCDç å½¢å¼)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">time</span><span class="p">.</span><span class="n">tm_min</span> <span class="o">=</span> <span class="nf">CMOS_READ</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">time</span><span class="p">.</span><span class="n">tm_hour</span> <span class="o">=</span> <span class="nf">CMOS_READ</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">time</span><span class="p">.</span><span class="n">tm_mday</span> <span class="o">=</span> <span class="nf">CMOS_READ</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">time</span><span class="p">.</span><span class="n">tm_mon</span> <span class="o">=</span> <span class="nf">CMOS_READ</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">time</span><span class="p">.</span><span class="n">tm_year</span> <span class="o">=</span> <span class="nf">CMOS_READ</span><span class="p">(</span><span class="mi">9</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">tm_sec</span> <span class="o">!=</span> <span class="nf">CMOS_READ</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="nf">BCD_TO_BIN</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">tm_sec</span><span class="p">);</span>                 <span class="c1">//è½¬æ¢ä½2è¿›åˆ¶æ•°å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">BCD_TO_BIN</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">tm_min</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">BCD_TO_BIN</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">tm_hour</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">BCD_TO_BIN</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">tm_mday</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">BCD_TO_BIN</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">tm_mon</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">BCD_TO_BIN</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">tm_year</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">time</span><span class="p">.</span><span class="n">tm_mon</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">startup_time</span> <span class="o">=</span> <span class="nf">kernel_mktime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">time</span><span class="p">);</span>      <span class="c1">//è®¡ç®—å¼€æœºæ—¶é—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>(3)å†…æ ¸æ‰€æœ‰åˆå§‹åŒ–</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//å†…æ ¸è¿›è¡Œæ‰€æœ‰æ–¹é¢çš„åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">mem_init</span><span class="p">(</span><span class="n">main_memory_start</span><span class="p">,</span><span class="n">memory_end</span><span class="p">);</span> <span class="c1">//ä¸»å†…å­˜åŒºåˆå§‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">trap_init</span><span class="p">();</span>                            <span class="c1">//é™·é˜±é—¨(ç¡¬ä»¶ä¸­æ–­å‘é‡)åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">blk_dev_init</span><span class="p">();</span>                         <span class="c1">//å—è®¾å¤‡åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">chr_dev_init</span><span class="p">();</span>                         <span class="c1">//å­—ç¬¦è®¾å¤‡åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">tty_init</span><span class="p">();</span>                             <span class="c1">//ttyåˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">time_init</span><span class="p">();</span>                            <span class="c1">//è®¾ç½®å¼€æœºå¯åŠ¨æ—¶é—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">sched_init</span><span class="p">();</span>                           <span class="c1">//è°ƒåº¦ç¨‹åºåˆå§‹åŒ–(åŠ è½½ä»»åŠ¡0çš„tr,ldtr)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">buffer_init</span><span class="p">(</span><span class="n">buffer_memory_end</span><span class="p">);</span>         <span class="c1">//ç¼“å†²ç®¡ç†åˆå§‹åŒ–ï¼Œå»ºå†…å­˜é“¾è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">hd_init</span><span class="p">();</span>                              <span class="c1">//ç¡¬ç›˜åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">floppy_init</span><span class="p">();</span>                          <span class="c1">//è½¯ç›˜åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">sti</span><span class="p">();</span>                                  <span class="c1">//æ‰€æœ‰åˆå§‹åŒ–å®Œæˆï¼Œå¼€å¯ä¸­æ–­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">//ä¸‹é¢è¿‡ç¨‹é€šè¿‡åœ¨å †æ ˆä¸­è®¾ç½®çš„å‚æ•°ï¼Œåˆ©ç”¨ä¸­æ–­è¿”å›æŒ‡ä»¤å¯åŠ¨ä»»åŠ¡0æ‰§è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">move_to_user_mode</span><span class="p">();</span>                    <span class="c1">//åˆ‡æ¢åˆ°ç”¨æˆ·æ¨¡å¼
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>(4)åˆ‡æ¢åˆ°ç”¨æˆ·æ¨¡å¼</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//ä¸‹é¢è¿‡ç¨‹é€šè¿‡åœ¨å †æ ˆä¸­è®¾ç½®çš„å‚æ•°ï¼Œåˆ©ç”¨ä¸­æ–­è¿”å›æŒ‡ä»¤å¯åŠ¨ä»»åŠ¡0æ‰§è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">move_to_user_mode</span><span class="p">();</span>                    <span class="c1">//åˆ‡æ¢åˆ°ç”¨æˆ·æ¨¡å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">fork</span><span class="p">())</span> <span class="p">{</span>		<span class="cm">/* we count on this going ok */</span>
</span></span><span class="line"><span class="cl">		<span class="nf">init</span><span class="p">();</span>         <span class="c1">//åœ¨æ–°å»ºçš„å­è¿›ç¨‹ä¸­è¿è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="äºŒå®Œæ•´æºç ">äºŒã€å®Œæ•´æºç <a hidden class="anchor" aria-hidden="true" href="#äºŒå®Œæ•´æºç ">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> *  linux/init/main.c
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> *  (C) 1991  Linus Torvalds
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="c1">//  å®å®šä¹‰__LIBRARY__ä¸ºäº†åŒ…æ‹¬åœ¨unistd.hä¸­å†…åµŒæ±‡ç¼–ä»£ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define __LIBRARY__
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// *.hæ‰€åœ¨å¤´æ–‡ä»¶é»˜è®¤ç›®å½•åœ¨include/
</span></span></span><span class="line"><span class="cl"><span class="c1">// unistd.hæ˜¯æ ‡å‡†ç¬¦å·å¸¸æ•°ä¸ç±»å‹æ–‡ä»¶ï¼Œå®šä¹‰äº†å„ç§ç¬¦å·å¸¸æ•°å’Œç±»å‹ï¼Œå¹¶å£°æ˜äº†å„ç§å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1">// è‹¥å®šä¹‰äº†_LIBRARY_,åˆ™è¿˜ä¼šåŒ…å«ç³»ç»Ÿè°ƒç”¨å·å’Œå†…åµŒæ±‡ç¼–ä»£ç å¦‚syscall0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// æ—¶é—´ç±»å‹å¤´æ–‡ä»¶ï¼Œå®šä¹‰äº†tmç»“æ„å’Œå…³äºæ—¶é—´çš„å‡½æ•°åŸå‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * we need this inline - forking from kernel space will result
</span></span></span><span class="line"><span class="cl"><span class="cm"> * in NO COPY ON WRITE (!!!), until an execve is executed. This
</span></span></span><span class="line"><span class="cl"><span class="cm"> * is no problem, but for the stack. This is handled by not letting
</span></span></span><span class="line"><span class="cl"><span class="cm"> * main() use the stack at all after fork(). Thus, no function
</span></span></span><span class="line"><span class="cl"><span class="cm"> * calls - which means inline code for fork too, as otherwise we
</span></span></span><span class="line"><span class="cl"><span class="cm"> * would use the stack upon exit from &#39;fork()&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Actually only pause and fork are needed inline, so that there
</span></span></span><span class="line"><span class="cl"><span class="cm"> * won&#39;t be any messing with the stack from main(), but we define
</span></span></span><span class="line"><span class="cl"><span class="cm"> * some others too.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">åœ¨å†…æ ¸ç©ºé—´åˆ›å»ºè¿›ç¨‹å°†ä¼šå¯¼è‡´æ²¡æœ‰å†™æ—¶å¤åˆ¶ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">ä¸ºäº†ä¿è¯ä¸ä½¿ç”¨ä»»åŠ¡0çš„ç”¨æˆ·æ ˆï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm">mainåœ¨ç§»åŠ¨åˆ°ç”¨æˆ·æ¨¡å¼(åˆ°ä»»åŠ¡0)åæ‰§è¡Œå†…åµŒæ–¹å¼çš„fork()å’Œpause()
</span></span></span><span class="line"><span class="cl"><span class="cm">åœ¨æ‰§è¡Œmove_to_user_mode()åï¼Œmainå°±ä»¥ä»»åŠ¡0çš„æ–¹å¼è¿è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">ä»»åŠ¡0æ˜¯æ‰€æœ‰å­è¿›ç¨‹çš„çˆ¶è¿›ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="cm">å½“å®ƒåˆ›å»ºå­è¿›ç¨‹æ—¶ï¼Œç”±äºä»»åŠ¡1å±äºå†…æ ¸ç©ºé—´ï¼Œæ— å†™æ—¶å¤åˆ¶
</span></span></span><span class="line"><span class="cl"><span class="cm">ä»»åŠ¡0çš„ç”¨æˆ·ç©ºæ ˆå°±æ˜¯ä»»åŠ¡1çš„ç”¨æˆ·æ ˆï¼Œå³ä»–ä»¬å…±ç”¨ä¸€ä¸ªæ ˆç©ºé—´
</span></span></span><span class="line"><span class="cl"><span class="cm">å› æ­¤åœ¨è¿è¡Œä»»åŠ¡0æ—¶ä¸è¦å¯¹å †æ ˆæœ‰ä»»ä½•çš„æ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="cm">ä½†åœ¨å†æ¬¡æ‰§è¡Œfork()å¹¶æ‰§è¡Œè¿‡execve()å,è¢«åŠ è½½çš„ç¨‹åºä¹Ÿä¸å±äºå†…æ ¸ç©ºé—´
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// å®šä¹‰å†…è”å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kr">inline</span> <span class="nf">_syscall0</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="n">fork</span><span class="p">)</span> <span class="c1">// å®é™…ä¸Šæ˜¯ int fork()åˆ›å»ºè¿›ç¨‹ç³»ç»Ÿè°ƒç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kr">inline</span> <span class="nf">_syscall0</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="n">pause</span><span class="p">)</span> <span class="c1">//int pause()ç³»ç»Ÿè°ƒç”¨ ï¼šæš‚åœè¿›ç¨‹çš„æ‰§è¡Œï¼Œç›´åˆ°æ”¶åˆ°ä¸€ä¸ªä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kr">inline</span> <span class="nf">_syscall1</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="n">setup</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span><span class="n">BIOS</span><span class="p">)</span> <span class="c1">// int setup(void *,BIOS)ç³»ç»Ÿè°ƒç”¨  ç”¨äºlinuxåˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kr">inline</span> <span class="nf">_syscall0</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="n">sync</span><span class="p">)</span> <span class="c1">// int sync()ç³»ç»Ÿè°ƒç”¨ï¼šæ›´æ–°æ–‡ä»¶ç³»ç»Ÿ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/tty.h&gt;   //å®šä¹‰äº†tty_io,ä¸²å£é€šä¿¡æ–¹é¢çš„å‚æ•°ï¼Œå¸¸æ•°</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/sched.h&gt; //è°ƒåº¦ï¼Œå®šä¹‰äº†ä»»åŠ¡ç»“æ„ä½“task_struct,ç¬¬ä¸€ä¸ªåˆå§‹ä»»åŠ¡çš„æ•°æ®</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/head.h&gt;  //å®šä¹‰äº†æ®µæè¿°ç¬¦çš„ç®€å•ç»“æ„å’Œå‡ ä¸ªé€‰æ‹©ç¬¦å¸¸é‡</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;asm/system.h&gt;  //ä»¥å®çš„å½¢å¼å®šä¹‰äº†æœ‰å…³æè¿°ç¬¦å‚æ•°è®¾ç½®æˆ–ä¿®æ”¹æè¿°ç¬¦ï¼Œä¸­æ–­é—¨ç­‰æ±‡ç¼–ç¨‹åº</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;asm/io.h&gt;      //ä»¥åµŒå…¥å¼æ±‡ç¼–ç¨‹åºå½¢å¼å®šä¹‰äº†å¯¹ioç«¯æ“ä½œçš„å‡½æ•°</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stddef.h&gt;     //æ ‡å‡†å®šä¹‰å¤´æ–‡ä»¶ï¼Œå®šä¹‰äº†NULL,TYPE,MEMBER</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdarg.h&gt;		//æ ‡å¿—å‚æ•°å¤´æ–‡ä»¶ï¼Œä»¥å®çš„å½¢å¼å®šä¹‰äº†å˜é‡å‚æ•°åˆ—è¡¨</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>						<span class="c1">//ä¸€ä¸ªç±»å‹ï¼šva_list,ä¸‰ä¸ªå®ï¼šva_start,va_arg,va_end
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>						<span class="c1">//vsprintf,vprintf,vfprintf
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;		//æ ‡å‡†ç¬¦å·å¸¸æ•°ä¸ç±»å‹æ–‡ä»¶ï¼Œå®šä¹‰äº†å„ç§ç¬¦å·å¸¸æ•°å’Œç±»å‹ï¼Œå¹¶å£°æ˜äº†å„ç§å‡½æ•°</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;      //æ–‡ä»¶æ§åˆ¶å¤´æ–‡ä»¶ï¼Œç”¨äºæ–‡ä»¶åŠå…¶æè¿°ç¬¦çš„æ“ä½œæ§åˆ¶å¸¸æ•°ç¬¦å·çš„å®šä¹‰	</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;  //ç±»å‹å¤´æ–‡ä»¶ï¼Œå®šä¹‰äº†åŸºæœ¬çš„ç³»ç»Ÿæ•°æ®ç±»å‹</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/fs.h&gt;   //æ–‡ä»¶ç³»ç»Ÿå¤´æ–‡ä»¶ï¼Œå®šä¹‰äº†æ–‡ä»¶è¡¨ç»“æ„(file,buffer_head,m_inode)</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">char</span> <span class="n">printbuf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span> <span class="c1">//é™æ€å­—ç¬¦ä¸²æ•°ç»„ï¼Œç”¨ä½œå†…æ ¸æ˜¾ç¤ºä¿¡æ¯çš„ç¼“å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">int</span> <span class="nf">vsprintf</span><span class="p">();</span>         <span class="c1">//æ ¼å¼åŒ–è¾“å‡ºåˆ°ä¸€å­—ç¬¦ä¸²ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">extern</span> <span class="kt">void</span> <span class="nf">init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>        <span class="c1">//åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">extern</span> <span class="kt">void</span> <span class="nf">blk_dev_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span><span class="c1">//å—è®¾å¤‡åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">extern</span> <span class="kt">void</span> <span class="nf">chr_dev_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span><span class="c1">//å­—ç¬¦è®¾å¤‡åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">extern</span> <span class="kt">void</span> <span class="nf">hd_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>	   <span class="c1">//ç¡¬ç›˜åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">extern</span> <span class="kt">void</span> <span class="nf">floppy_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span> <span class="c1">//è½¯é©±åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">extern</span> <span class="kt">void</span> <span class="nf">mem_init</span><span class="p">(</span><span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="kt">long</span> <span class="n">end</span><span class="p">);</span>       <span class="c1">//å†…å­˜ç®¡ç†åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">extern</span> <span class="kt">long</span> <span class="nf">rd_init</span><span class="p">(</span><span class="kt">long</span> <span class="n">mem_start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">);</span>  <span class="c1">//è™šæ‹Ÿç›˜åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">extern</span> <span class="kt">long</span> <span class="nf">kernel_mktime</span><span class="p">(</span><span class="k">struct</span> <span class="n">tm</span> <span class="o">*</span> <span class="n">tm</span><span class="p">);</span>        <span class="c1">//è®¡ç®—ç³»ç»Ÿå¼€æœºå¯åŠ¨æ—¶é—´(s)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">extern</span> <span class="kt">long</span> <span class="n">startup_time</span><span class="p">;</span>                         <span class="c1">//å†…æ ¸å¯åŠ¨æ—¶é—´(s)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * This is set up by the setup-routine at boot-time
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="c1">//è¿™äº›æ•°æ®åœ¨å†…æ ¸å¼•å¯¼æœŸé—´ç”±setupè®¾ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1">//å°†æŒ‡å®šçš„çº¿æ€§åœ°å€å¼ºè¡Œè½¬æ¢ä¸ºç»™çš„æ•°æ®ç±»å‹çš„æŒ‡é’ˆï¼Œå¹¶è·å–æŒ‡é’ˆæ‰€æŒ‡çš„å†…å®¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define EXT_MEM_K (*(unsigned short *)0x90002)       </span><span class="c1">//1MBä»¥åçš„æ‰©å±•å†…å®¹å¤§å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define DRIVE_INFO (*(struct drive_info *)0x90080)   </span><span class="c1">//ç¡¬ç›˜å‚æ•°è¡¨çš„32å­—èŠ‚å†…å®¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define ORIG_ROOT_DEV (*(unsigned short *)0x901FC)   </span><span class="c1">//æ ¹æ–‡ä»¶ç³»ç»Ÿæ‰€åœ¨è®¾å¤‡å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Yeah, yeah, it&#39;s ugly, but I cannot find how to do this correctly
</span></span></span><span class="line"><span class="cl"><span class="cm"> * and this seems to work. I anybody has more info on the real-time
</span></span></span><span class="line"><span class="cl"><span class="cm"> * clock I&#39;d be interested. Most of this was trial and error, and some
</span></span></span><span class="line"><span class="cl"><span class="cm"> * bios-listing reading. Urghh.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//è¯»å–CMOSå®æ—¶æ—¶é’Ÿä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1">//outb_pç«¯å£è¾“å‡ºå®å®šä¹‰ï¼Œinb_pç«¯å£è¾“å…¥å®å®šä¹‰
</span></span></span><span class="line"><span class="cl"><span class="c1">//0x70æ˜¯å†™åœ°å€ç«¯å£å· 0x80|addræ˜¯è¦è¯»å–CMOSå†…å­˜åœ°å€ï¼Œ0x71æ˜¯åº¦æ•°æ®ç«¯å£å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define CMOS_READ(addr) ({ 
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nf">outb_p</span><span class="p">(</span><span class="mh">0x80</span><span class="o">|</span><span class="n">addr</span><span class="p">,</span><span class="mh">0x70</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl"><span class="nf">inb_p</span><span class="p">(</span><span class="mh">0x71</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//å°†BCDç è½¬åŒ–ä¸ºäºŒè¿›åˆ¶æ•°å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1">//(val)&amp;15å–BCDç ç¬¬å››ä½ä¹Ÿå°±æ˜¯ä¸ªä½ï¼Œval)&gt;&gt;4å³ç§»å››ä½åªå‰©é«˜å››ä½ä¹Ÿå°±æ˜¯åä½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define BCD_TO_BIN(val) ((val)=((val)&amp;15) + ((val)&gt;&gt;4)*10)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//è¯¥å‡½æ•°å–CMOSå®æ—¶ä¸­ä¿¡æ¯ä½œä¸ºå¼€æœºæ—¶é—´ï¼Œå¹¶ä¿å­˜åˆ°å…¨å±€å˜é‡startup_time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">time_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">tm</span> <span class="n">time</span><span class="p">;</span>                         <span class="c1">//æ—¶é—´ç»“æ„ä½“
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="k">do</span> <span class="p">{</span>                                    <span class="c1">//ä»CMOSå†…å­˜åˆ—è¡¨ä¸­è¯»å–æ—¶é—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">time</span><span class="p">.</span><span class="n">tm_sec</span> <span class="o">=</span> <span class="nf">CMOS_READ</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>         <span class="c1">//ç§’å€¼(BCDç å½¢å¼)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">time</span><span class="p">.</span><span class="n">tm_min</span> <span class="o">=</span> <span class="nf">CMOS_READ</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">time</span><span class="p">.</span><span class="n">tm_hour</span> <span class="o">=</span> <span class="nf">CMOS_READ</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">time</span><span class="p">.</span><span class="n">tm_mday</span> <span class="o">=</span> <span class="nf">CMOS_READ</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">time</span><span class="p">.</span><span class="n">tm_mon</span> <span class="o">=</span> <span class="nf">CMOS_READ</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">time</span><span class="p">.</span><span class="n">tm_year</span> <span class="o">=</span> <span class="nf">CMOS_READ</span><span class="p">(</span><span class="mi">9</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">tm_sec</span> <span class="o">!=</span> <span class="nf">CMOS_READ</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="nf">BCD_TO_BIN</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">tm_sec</span><span class="p">);</span>                 <span class="c1">//è½¬æ¢ä½2è¿›åˆ¶æ•°å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">BCD_TO_BIN</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">tm_min</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">BCD_TO_BIN</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">tm_hour</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">BCD_TO_BIN</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">tm_mday</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">BCD_TO_BIN</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">tm_mon</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">BCD_TO_BIN</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">tm_year</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">time</span><span class="p">.</span><span class="n">tm_mon</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">startup_time</span> <span class="o">=</span> <span class="nf">kernel_mktime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">time</span><span class="p">);</span>      <span class="c1">//è®¡ç®—å¼€æœºæ—¶é—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">long</span> <span class="n">memory_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                  <span class="c1">//æœºå™¨å…·æœ‰çš„ç‰©ç†å†…å­˜å®¹é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">long</span> <span class="n">buffer_memory_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>           <span class="c1">//é«˜é€Ÿç¼“å†²åŒºæœ«ç«¯åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">long</span> <span class="n">main_memory_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>           <span class="c1">//ä¸»å†…å­˜(å°†ç”¨äºåˆ†é¡µ)å¼€å§‹çš„ä½ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">drive_info</span> <span class="p">{</span> <span class="kt">char</span> <span class="n">dummy</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span> <span class="p">}</span> <span class="n">drive_info</span><span class="p">;</span> <span class="c1">//ç”¨äºå­˜æ”¾ç¡¬ç›˜å‚æ•°è¡¨ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//å†…æ ¸åˆå§‹åŒ–ä¸»ç¨‹åºï¼Œåˆå§‹åŒ–ç»“æŸä»¥åå°†ä»¥ä»»åŠ¡0(idleä»»åŠ¡ä½ç©ºé—²ä»»åŠ¡)çš„èº«ä»½è¿è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>		<span class="cm">/* This really IS void, no error here. */</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>			<span class="cm">/* The startup routine assumes (well, ...) this */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Interrupts are still disabled. Do necessary setups, then
</span></span></span><span class="line"><span class="cl"><span class="cm"> * enable them
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="c1">//æ­¤æ—¶ä¸­æ–­è¢«å…³é—­ï¼Œåšå®Œå¿…è¦çš„è®¾ç½®åå°±å°†å…¶å¼€å¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"> 	<span class="n">ROOT_DEV</span> <span class="o">=</span> <span class="n">ORIG_ROOT_DEV</span><span class="p">;</span>                     <span class="c1">//ä¿å­˜æ ¹è®¾å¤‡å· --&gt;ROOT_DEV
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"> 	<span class="n">drive_info</span> <span class="o">=</span> <span class="n">DRIVE_INFO</span><span class="p">;</span>                      <span class="c1">//ä¿å­˜0x90080ç£ç›˜å‚æ•°è¡¨å†…å®¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="n">memory_end</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">20</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">EXT_MEM_K</span><span class="o">&lt;&lt;</span><span class="mi">10</span><span class="p">);</span>       <span class="c1">//æœºå™¨å†…å­˜æ•°---&gt;memory_end ,å†…å­˜å¤§å°=1MB+æ‰©å±•å†…å­˜(k)*1024å­—èŠ‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">memory_end</span> <span class="o">&amp;=</span> <span class="mh">0xfffff000</span><span class="p">;</span>                     <span class="c1">//å¿½ç•¥ä¸åˆ°4kb(1é¡µ)çš„å†…å­˜æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">memory_end</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span>                <span class="c1">//å¤§äº16MB åˆ™ç­‰äº16MB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">memory_end</span> <span class="o">=</span> <span class="mi">16</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">memory_end</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span>                <span class="c1">//å†…å­˜&gt;12MB,é«˜é€Ÿç¼“å†²æœ«ç«¯=4mb
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">buffer_memory_end</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>          <span class="c1">//é«˜é€Ÿç¼“å†²æœ«ç«¯åœ°å€---&gt;buffer_memory_end
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">memory_end</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span>             <span class="c1">//å†…å­˜&gt;6MB,é«˜é€Ÿç¼“å†²æœ«ç«¯=4mb
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">buffer_memory_end</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>           
</span></span><span class="line"><span class="cl">	<span class="k">else</span>                                           <span class="c1">//å¦åˆ™é«˜é€Ÿç¼“å†²æœ«ç«¯=1mb
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">buffer_memory_end</span> <span class="o">=</span> <span class="mi">1</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">main_memory_start</span> <span class="o">=</span> <span class="n">buffer_memory_end</span><span class="p">;</span>        <span class="c1">//ä¸»å†…å­˜å¼€å§‹åœ°å€=é«˜é€Ÿç¼“å†²æœ«ç«¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//å¦‚æœåœ¨Makefileä¸­å®šä¹‰äº†å†…å­˜è™šæ‹Ÿç›˜ç¬¦å·RAMDISKï¼Œåˆ™åˆå§‹åŒ–è™šæ‹Ÿç›˜(ä¸»å†…å­˜å‡å°‘)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#ifdef RAMDISK
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="n">main_memory_start</span> <span class="o">+=</span> <span class="nf">rd_init</span><span class="p">(</span><span class="n">main_memory_start</span><span class="p">,</span> <span class="n">RAMDISK</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//å†…æ ¸è¿›è¡Œæ‰€æœ‰æ–¹é¢çš„åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">mem_init</span><span class="p">(</span><span class="n">main_memory_start</span><span class="p">,</span><span class="n">memory_end</span><span class="p">);</span> <span class="c1">//ä¸»å†…å­˜åŒºåˆå§‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">trap_init</span><span class="p">();</span>                            <span class="c1">//é™·é˜±é—¨(ç¡¬ä»¶ä¸­æ–­å‘é‡)åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">blk_dev_init</span><span class="p">();</span>                         <span class="c1">//å—è®¾å¤‡åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">chr_dev_init</span><span class="p">();</span>                         <span class="c1">//å­—ç¬¦è®¾å¤‡åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">tty_init</span><span class="p">();</span>                             <span class="c1">//ttyåˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">time_init</span><span class="p">();</span>                            <span class="c1">//è®¾ç½®å¼€æœºå¯åŠ¨æ—¶é—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">sched_init</span><span class="p">();</span>                           <span class="c1">//è°ƒåº¦ç¨‹åºåˆå§‹åŒ–(åŠ è½½ä»»åŠ¡0çš„tr,ldtr)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">buffer_init</span><span class="p">(</span><span class="n">buffer_memory_end</span><span class="p">);</span>         <span class="c1">//ç¼“å†²ç®¡ç†åˆå§‹åŒ–ï¼Œå»ºå†…å­˜é“¾è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">hd_init</span><span class="p">();</span>                              <span class="c1">//ç¡¬ç›˜åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">floppy_init</span><span class="p">();</span>                          <span class="c1">//è½¯ç›˜åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">sti</span><span class="p">();</span>                                  <span class="c1">//æ‰€æœ‰åˆå§‹åŒ–å®Œæˆï¼Œå¼€å¯ä¸­æ–­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">//ä¸‹é¢è¿‡ç¨‹é€šè¿‡åœ¨å †æ ˆä¸­è®¾ç½®çš„å‚æ•°ï¼Œåˆ©ç”¨ä¸­æ–­è¿”å›æŒ‡ä»¤å¯åŠ¨ä»»åŠ¡0æ‰§è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">move_to_user_mode</span><span class="p">();</span>                    <span class="c1">//åˆ‡æ¢åˆ°ç”¨æˆ·æ¨¡å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">fork</span><span class="p">())</span> <span class="p">{</span>		<span class="cm">/* we count on this going ok */</span>
</span></span><span class="line"><span class="cl">		<span class="nf">init</span><span class="p">();</span>         <span class="c1">//åœ¨æ–°å»ºçš„å­è¿›ç¨‹ä¸­è¿è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> *   NOTE!!   For any other task &#39;pause()&#39; would mean we have to get a
</span></span></span><span class="line"><span class="cl"><span class="cm"> * signal to awaken, but task0 is the sole exception (see &#39;schedule()&#39;)
</span></span></span><span class="line"><span class="cl"><span class="cm"> * as task 0 gets activated at every idle moment (when no other tasks
</span></span></span><span class="line"><span class="cl"><span class="cm"> * can run). For task0 &#39;pause()&#39; just means we go check if some other
</span></span></span><span class="line"><span class="cl"><span class="cm"> * task can run, and if not we return here.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//è¿è¡Œä»»åŠ¡0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//pause()ç³»ç»Ÿè°ƒç”¨ä¼šæŠŠä»»åŠ¡0è½¬æ¢æˆå¯ä¸­æ–­ç­‰å¾…çŠ¶æ€ï¼Œå†æ‰§è¡Œè°ƒåº¦å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//è‹¥è°ƒåº¦å‡½æ•°å‘ç°ç³»ç»Ÿä¸­æ²¡æœ‰æ²¡æœ‰å…¶ä»–ä»»åŠ¡å¯ä»¥è¿è¡Œå°±ä¼šåˆ‡æ¢åˆ°ä»»åŠ¡0ï¼Œè€Œä¸ä¾èµ–ä»»åŠ¡0çš„çŠ¶æ€	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span><span class="p">(;;)</span> <span class="nf">pause</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//printf()äº§ç”Ÿæ ¼å¼åŒ–ä¿¡æ¯è¾“å‡ºåˆ°æ ‡å‡†è®¾å¤‡stdout(1),åœ¨å±å¹•ä¸Šæ˜¾ç¤º
</span></span></span><span class="line"><span class="cl"><span class="c1">// å‚æ•°fmtï¼šæŒ‡å®šè¾“å‡ºå°†é‡‡ç”¨çš„æ ¼å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">printf</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">va_list</span> <span class="n">args</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">printbuf</span><span class="p">,</span><span class="n">i</span><span class="o">=</span><span class="nf">vsprintf</span><span class="p">(</span><span class="n">printbuf</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="nf">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//è¯»å–å¹¶æ‰§è¡Œ/etc/rcæ–‡ä»¶æ‰€ä½¿ç”¨çš„å‘½ä»¤è¡Œå‚æ•°å’Œç¯å¢ƒå‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv_rc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#34;/bin/sh&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">envp_rc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#34;HOME=/&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//è¿è¡Œç™»å½•shellæ—¶æ‰€ä½¿ç”¨çš„å‘½ä»¤è¡Œå‚æ•°å’Œç¯å¢ƒå‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#34;-/bin/sh&#34;</span><span class="p">,</span><span class="nb">NULL</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">envp</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#34;HOME=/usr/root&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//åœ¨main()ä¸­è¿›è¡Œäº†ç³»ç»Ÿåˆå§‹åŒ–ï¼ŒåŒ…æ‹¬å†…å­˜ç®¡ç†ï¼Œå„ç§ç¡¬ä»¶è®¾å¤‡å’Œé©±åŠ¨è®¾å¤‡
</span></span></span><span class="line"><span class="cl"><span class="c1">//è€Œinit()è¿è¡Œåœ¨ä»»åŠ¡0ç¬¬ä¸€æ¬¡åˆ›å»ºçš„å­è¿›ç¨‹ï¼Œå¯¹ç¬¬ä¸€ä¸ªè¦æ‰§è¡Œçš„shellç¨‹åºçš„ç¯å¢ƒè¿›è¡Œåˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1">//ç„¶åä»¥ç™»å½•shellæ–¹å¼åŠ è½½è¯¥ç¨‹åºå¹¶æ‰§è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">pid</span><span class="p">,</span><span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//setup()ç”¨äºè¯»å–ç¡¬ç›˜å‚æ•°åŒ…å«åˆ†åŒºè¡¨ä¿¡æ¯å¹¶åŠ è½½è™šæ‹Ÿä¿¡æ¯å’Œå®‰è£…æ ¹æ–‡ä»¶ç³»ç»Ÿè®¾å¤‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">setup</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">drive_info</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/dev/tty0&#34;</span><span class="p">,</span><span class="n">O_RDWR</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span> <span class="c1">//ç»ˆç«¯æ§åˆ¶å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">dup</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">dup</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//æ‰“å°ç¼“å†²åŒºå—æ•°å’Œæ€»å­—èŠ‚æ•°ï¼Œæ¯å—1024å­—èŠ‚ï¼Œä»¥åŠä¸»å†…å­˜åŒºç©ºé—²å†…å­˜å­—èŠ‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%d buffers = %d bytes buffer spacenr&#34;</span><span class="p">,</span><span class="n">NR_BUFFERS</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">NR_BUFFERS</span><span class="o">*</span><span class="n">BLOCK_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Free mem: %d bytesnr&#34;</span><span class="p">,</span><span class="n">memory_end</span><span class="o">-</span><span class="n">main_memory_start</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹(ä»»åŠ¡2) --&gt;è¿”å›å€¼ä¸º =0,çˆ¶è¿›ç¨‹--&gt;è¿”å›å€¼ = å­è¿›ç¨‹pid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">//åˆ›å»ºå¤±è´¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pid</span><span class="o">=</span><span class="nf">fork</span><span class="p">()))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">close</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="nf">open</span><span class="p">(</span><span class="s">&#34;/etc/rc&#34;</span><span class="p">,</span><span class="n">O_RDONLY</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="nf">_exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">execve</span><span class="p">(</span><span class="s">&#34;/bin/sh&#34;</span><span class="p">,</span><span class="n">argv_rc</span><span class="p">,</span><span class="n">envp_rc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">_exit</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//çˆ¶è¿›ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">pid</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">while</span> <span class="p">(</span><span class="n">pid</span> <span class="o">!=</span> <span class="nf">wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i</span><span class="p">))</span>  <span class="c1">//ç­‰å¾…å­è¿›ç¨‹ç»“æŸã€‚&amp;iå­˜æ”¾è¿”å›çŠ¶æ€ä¿¡æ¯çš„ä½ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="cm">/* nothing */</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//ä¸Šä¸€ä¸ªè¿›ç¨‹ç»“æŸï¼Œä¸‹é¢å¾ªç¯åœ¨åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//åˆ›å»ºå¤±è´¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">((</span><span class="n">pid</span><span class="o">=</span><span class="nf">fork</span><span class="p">())</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Fork failed in initrn&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//æ–°çš„å­è¿›ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nf">close</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="nf">close</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="nf">close</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="nf">setsid</span><span class="p">();</span>                    		<span class="c1">//åˆ›æ–°ä¼šè¯æœŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/dev/tty0&#34;</span><span class="p">,</span><span class="n">O_RDWR</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">dup</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">dup</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="nf">_exit</span><span class="p">(</span><span class="nf">execve</span><span class="p">(</span><span class="s">&#34;/bin/sh&#34;</span><span class="p">,</span><span class="n">argv</span><span class="p">,</span><span class="n">envp</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="nf">wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;nrchild %d died with code %04xnr&#34;</span><span class="p">,</span><span class="n">pid</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">sync</span><span class="p">();</span>                                 <span class="c1">//åŒæ­¥æ“ä½œï¼Œåˆ·æ–°ç¼“å†²åŒº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>	<span class="cm">/* NOTE! _exit, not exit() */</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//_exit() ç»ˆæ­¢ä¸€ä¸ªå‡½æ•°å±äºsys_exitç³»ç»Ÿè°ƒç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//exit() ç»ˆæ­¢ä¸€ä¸ªå‡½æ•°ï¼Œå±äºåº“å‡½æ•°ï¼Œå®ƒä¼šå…ˆæ‰§è¡Œä¸€äº›æ¸…é™¤æ“ä½œï¼Œç„¶åè°ƒç”¨_exit()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>

  </div>

  <footer class="post-footer">
    
<nav class="paginav">
  <a class="prev" href="https://chance7bin.github.io/posts/basic/network/%E5%9B%BE%E8%A7%A3tcpip/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>å›¾è§£TCPIP</span>
  </a>
  <a class="next" href="https://chance7bin.github.io/posts/basic/network/%E5%9B%BE%E8%A7%A3http/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>å›¾è§£HTTP</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://chance7bin.github.io/">Binb&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerHTML = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
