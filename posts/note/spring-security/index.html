<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Spring Security | Binb&#39;s Blog</title>
<meta name="keywords" content="Spring Boot">
<meta name="description" content="å‚è€ƒé“¾æ¥ï¼š https://blog.csdn.net/liuminglei1987/category_10122574.html ä»é›¶æ­å»ºè‹¥ä¾(Ruoyi-Vue)ç®¡ç†ç³»ç»Ÿ(10)&ndash;Spring Securityæ ¸å¿ƒå†…å®¹æ¢³ç† SpringSecuri">
<meta name="author" content="chance7bin">
<link rel="canonical" href="https://chance7bin.github.io/posts/note/spring-security/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.be81eec981a615a87a88f121642d7eebde74d033438693944db2fd6b827284ff.css" integrity="" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.acb54fd32bbc1982428b8850317e45d076b95012730a5936667e6bc21777692a.js" integrity=""
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<link rel="icon" type="image/png" sizes="16x16" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<link rel="icon" type="image/png" sizes="32x32" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<link rel="apple-touch-icon" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<link rel="mask-icon" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Spring Security" />
<meta property="og:description" content="å‚è€ƒé“¾æ¥ï¼š https://blog.csdn.net/liuminglei1987/category_10122574.html ä»é›¶æ­å»ºè‹¥ä¾(Ruoyi-Vue)ç®¡ç†ç³»ç»Ÿ(10)&ndash;Spring Securityæ ¸å¿ƒå†…å®¹æ¢³ç† SpringSecuri" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://chance7bin.github.io/posts/note/spring-security/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-10T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-06-10T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Spring Security"/>
<meta name="twitter:description" content="å‚è€ƒé“¾æ¥ï¼š https://blog.csdn.net/liuminglei1987/category_10122574.html ä»é›¶æ­å»ºè‹¥ä¾(Ruoyi-Vue)ç®¡ç†ç³»ç»Ÿ(10)&ndash;Spring Securityæ ¸å¿ƒå†…å®¹æ¢³ç† SpringSecuri"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "ğŸ“š æ–‡ç« ",
      "item": "https://chance7bin.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ‘¨ğŸ»â€ğŸ’» æˆ‘çš„ç¬”è®°",
      "item": "https://chance7bin.github.io/posts/note/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Spring Security",
      "item": "https://chance7bin.github.io/posts/note/spring-security/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Spring Security",
  "name": "Spring Security",
  "description": "å‚è€ƒé“¾æ¥ï¼š https://blog.csdn.net/liuminglei1987/category_10122574.html ä»é›¶æ­å»ºè‹¥ä¾(Ruoyi-Vue)ç®¡ç†ç³»ç»Ÿ(10)\u0026ndash;Spring Securityæ ¸å¿ƒå†…å®¹æ¢³ç† SpringSecuri",
  "keywords": [
    "Spring Boot"
  ],
  "articleBody": " å‚è€ƒé“¾æ¥ï¼š\nhttps://blog.csdn.net/liuminglei1987/category_10122574.html\nä»é›¶æ­å»ºè‹¥ä¾(Ruoyi-Vue)ç®¡ç†ç³»ç»Ÿ(10)â€“Spring Securityæ ¸å¿ƒå†…å®¹æ¢³ç†\nSpringSecurity-ä»å…¥é—¨åˆ°ç²¾é€š\nè®¤è¯†SpringSecurity Spring Security æ˜¯é’ˆå¯¹Springé¡¹ç›®çš„å®‰å…¨æ¡†æ¶ï¼Œä¹Ÿæ˜¯Spring Bootåº•å±‚å®‰å…¨æ¨¡å—é»˜è®¤çš„æŠ€æœ¯é€‰å‹ï¼Œä»–å¯ä»¥å®ç°å¼ºå¤§çš„Webå®‰å…¨æ§åˆ¶ï¼Œå¯¹äºå®‰å…¨æ§åˆ¶ï¼Œæˆ‘ä»¬ä»…éœ€è¦å¼•å…¥ spring-boot-starter-security æ¨¡å—ï¼Œè¿›è¡Œå°‘é‡çš„é…ç½®ï¼Œå³å¯å®ç°å¼ºå¤§çš„å®‰å…¨ç®¡ç†ï¼\nè®°ä½å‡ ä¸ªç±»ï¼š\nWebSecurityConfigurerAdapterï¼šè‡ªå®šä¹‰Securityç­–ç•¥ AuthenticationManagerBuilderï¼šè‡ªå®šä¹‰è®¤è¯ç­–ç•¥ @EnableWebSecurityï¼šå¼€å¯WebSecurityæ¨¡å¼ Spring Securityçš„ä¸¤ä¸ªä¸»è¦ç›®æ ‡æ˜¯ â€œè®¤è¯â€ å’Œ â€œæˆæƒâ€ï¼ˆè®¿é—®æ§åˆ¶ï¼‰ã€‚\nâ€œè®¤è¯â€ï¼ˆAuthenticationï¼‰\nèº«ä»½éªŒè¯æ˜¯å…³äºéªŒè¯æ‚¨çš„å‡­æ®ï¼Œå¦‚ç”¨æˆ·å/ç”¨æˆ·IDå’Œå¯†ç ï¼Œä»¥éªŒè¯æ‚¨çš„èº«ä»½ã€‚\nèº«ä»½éªŒè¯é€šå¸¸é€šè¿‡ç”¨æˆ·åå’Œå¯†ç å®Œæˆï¼Œæœ‰æ—¶ä¸èº«ä»½éªŒè¯å› ç´ ç»“åˆä½¿ç”¨ã€‚\nâ€œæˆæƒâ€ ï¼ˆAuthorizationï¼‰\næˆæƒå‘ç”Ÿåœ¨ç³»ç»ŸæˆåŠŸéªŒè¯æ‚¨çš„èº«ä»½åï¼Œæœ€ç»ˆä¼šæˆäºˆæ‚¨è®¿é—®èµ„æºï¼ˆå¦‚ä¿¡æ¯ï¼Œæ–‡ä»¶ï¼Œæ•°æ®åº“ï¼Œèµ„é‡‘ï¼Œä½ç½®ï¼Œå‡ ä¹ä»»ä½•å†…å®¹ï¼‰çš„å®Œå…¨æƒé™ã€‚\nè¿™ä¸ªæ¦‚å¿µæ˜¯é€šç”¨çš„ï¼Œè€Œä¸æ˜¯åªåœ¨Spring Security ä¸­å­˜åœ¨ã€‚\nSpring Secutityæ ¸å¿ƒå†…å®¹ Spring Secutityä¸­çš„ç”¨æˆ·ä¿¡æ¯ 1.UserDetailsServiceï¼š\nè¯¥æ–¹æ³•å¾ˆå®¹æ˜“ç†è§£ï¼š é€šè¿‡ç”¨æˆ·åæ¥åŠ è½½ç”¨æˆ· ã€‚è¿™ä¸ªæ–¹æ³•ä¸»è¦ç”¨äºä»ç³»ç»Ÿæ•°æ®ä¸­æŸ¥è¯¢å¹¶åŠ è½½å…·ä½“çš„ç”¨æˆ·åˆ° Spring Securityä¸­ã€‚\nåœ¨å¼€å‘ä¸­æˆ‘ä»¬ä¸€èˆ¬å®šä¹‰ä¸€ä¸ªè¿™ä¸ªæ¥å£çš„å®ç°ç±»ï¼Œè‡ªå®šä¹‰loadUserByUsernameæ–¹æ³•ï¼Œå®ç°ä»æ•°æ®æºè·å–ç”¨æˆ·ï¼ŒåŠ è½½ç”¨æˆ·ä¿¡æ¯ã€‚ä¹Ÿå¯ä»¥åœ¨å…¶ä¸­å®ç°ä¸€äº›æ ¡éªŒç”¨æˆ·é€»è¾‘ã€‚\n1 2 3 4 5 6 @Service public class UserDetailsServiceImpl implements UserDetailsService { @Override public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException { 2.UserDetails:\nä»ä¸Šé¢ UserDetailsService å¯ä»¥çŸ¥é“æœ€ç»ˆäº¤ç»™Spring Securityçš„æ˜¯UserDetails ã€‚è¯¥æ¥å£æ˜¯æä¾›ç”¨æˆ·ä¿¡æ¯çš„æ ¸å¿ƒæ¥å£ã€‚è¯¥æ¥å£å®ç°ä»…ä»…å­˜å‚¨ç”¨æˆ·çš„ä¿¡æ¯ã€‚åç»­ä¼šå°†è¯¥æ¥å£æä¾›çš„ç”¨æˆ·ä¿¡æ¯å°è£…åˆ°è®¤è¯å¯¹è±¡Authentication ä¸­å»ã€‚\nUserDetailsä¸­é»˜è®¤æä¾›ï¼š\nç”¨æˆ·çš„æƒé™é›†ï¼Œ é»˜è®¤éœ€è¦æ·»åŠ  ROLE_ å‰ç¼€ ç”¨æˆ·çš„åŠ å¯†åçš„å¯†ç ï¼Œ ä¸åŠ å¯†ä¼šä½¿ç”¨ {noop} å‰ç¼€ åº”ç”¨å†…å”¯ä¸€çš„ç”¨æˆ·å è´¦æˆ·æ˜¯å¦è¿‡æœŸ è´¦æˆ·æ˜¯å¦é”å®š å‡­è¯æ˜¯å¦è¿‡æœŸ ç”¨æˆ·æ˜¯å¦å¯ç”¨ åœ¨æˆ‘ä»¬è‡ªå·±çš„é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬è¦å®šä¹‰ä¸ªç”¨æˆ·ç±»å®ç°è¯¥æ¥å£ï¼Œåœ¨è¯¥ç”¨æˆ·ç±»ä¸­æˆ‘ä»¬å¯ä»¥æ‰©å±•æ›´å¤šçš„ç”¨æˆ·ä¿¡æ¯ï¼Œæ¯”å¦‚æ‰‹æœºã€é‚®ç®±ç­‰ç­‰\n3.UserDetailsServiceAutoConfiguration\nå…³äºåŠ å¯† ä»»ä½•åº”ç”¨è€ƒè™‘åˆ°å®‰å…¨ï¼Œç»ä¸èƒ½æ˜æ–‡çš„æ–¹å¼ä¿å­˜å¯†ç åˆ°æ•°æ®åº“ã€‚å¯†ç åº”è¯¥é€šè¿‡å“ˆå¸Œç®—æ³•è¿›è¡ŒåŠ å¯†ã€‚\næœ‰å¾ˆå¤šæ ‡å‡†çš„ç®—æ³•æ¯”å¦‚SHAæˆ–è€…MD5ï¼Œç»“åˆsalt(ç›)æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚\nSpring Securityæä¾›BCryptPasswordEncoderç±»,å®ç°Springçš„PasswordEncoderæ¥å£ä½¿ç”¨BCryptå¼ºå“ˆå¸Œæ–¹æ³•æ¥åŠ å¯†å¯†ç ã€‚BCryptå¼ºå“ˆå¸Œæ–¹æ³• æ¯æ¬¡åŠ å¯†çš„ç»“æœéƒ½ä¸ä¸€æ ·æ—¢ç„¶æ¯æ¬¡åŠ å¯†ç»“æœä¸ä¸€æ ·ï¼Œå°±ä¸å¯ä»¥é€šè¿‡ç›¸åŒå­—ç¬¦ä¸²åŠ å¯†åçš„ç»“æœæ¥åˆ¤å®šæ˜¯ä¸æ˜¯åŒä¸€ä¸ªå­—ç¬¦ä¸²äº†ï¼Œè¿™å°±æ›´åŠ å¢å¼ºäº†å®‰å…¨æ€§ã€‚\nå¦‚æœéœ€è¦åˆ¤æ–­æ˜¯å¦æ˜¯åŸæ¥çš„å¯†ç ï¼Œéœ€è¦ç”¨å®ƒè‡ªå¸¦çš„æ–¹æ³•ã€‚\nåŠ å¯†ï¼š\n1 2 BCryptPasswordEncoder encode = new BCryptPasswordEncoder(); encode.encode(password); åˆ¤æ–­ï¼š\néœ€è¦é€šè¿‡è‡ªå¸¦çš„æ–¹æ³• matches å°†æœªç»è¿‡åŠ å¯†çš„å¯†ç å’Œå·²ç»è¿‡åŠ å¯†çš„å¯†ç ä¼ è¿›å»è¿›è¡Œåˆ¤æ–­ï¼Œè¿”å›å¸ƒå°”å€¼ã€‚\n1 encode.matches(oldpassword,user1.getPassword()); Spring Securityçš„é…ç½® è‡ªå®šä¹‰SecurityConfig\né¦–å…ˆè¦ç»§æ‰¿WebSecurityConfigurerAdapterï¼Œå…¶æ¬¡æœ€å¸¸ç”¨çš„æ˜¯å®ç°configure(AuthenticationManagerBuilder auth)ã€configure(WebSecurity web)ã€configure(HttpSecurity http)ä¸‰ä¸ªæ–¹æ³•å®ç°æˆ‘ä»¬å¯¹Spring Securityçš„è‡ªå®šä¹‰å®‰å…¨é…ç½®ã€‚\nvoid configure(AuthenticationManagerBuilder auth) ç”¨æ¥é…ç½®è®¤è¯ç®¡ç†å™¨ AuthenticationManagerã€‚ void configure(WebSecurity web)ç”¨æ¥é…ç½® WebSecurity ã€‚è€Œ WebSecurityæ˜¯åŸºäºServlet Filterç”¨æ¥é…ç½® springSecurityFilterChainã€‚è€Œ springSecurityFilterChain åˆè¢«å§”æ‰˜ç»™äº† Spring Security æ ¸å¿ƒè¿‡æ»¤å™¨ Bean DelegatingFilterProxy ã€‚ ç›¸å…³é€»è¾‘ä½ å¯ä»¥åœ¨ WebSecurityConfiguration ä¸­æ‰¾åˆ°ã€‚æˆ‘ä»¬ä¸€èˆ¬ä¸ä¼šè¿‡å¤šæ¥è‡ªå®šä¹‰ WebSecurity , ä½¿ç”¨è¾ƒå¤šçš„ä½¿å…¶ ignoring() æ–¹æ³•ç”¨æ¥å¿½ç•¥ Spring Security å¯¹é™æ€èµ„æºçš„æ§åˆ¶ã€‚ void configure(HttpSecurity http) è¿™ä¸ªæ˜¯æˆ‘ä»¬ä½¿ç”¨æœ€å¤šçš„ï¼Œç”¨æ¥é…ç½® HttpSecurity ã€‚ HttpSecurityç”¨äºæ„å»ºä¸€ä¸ªå®‰å…¨è¿‡æ»¤å™¨é“¾ SecurityFilterChainã€‚ SecurityFilterChain æœ€ç»ˆè¢«æ³¨å…¥æ ¸å¿ƒè¿‡æ»¤å™¨ ã€‚HttpSecurityæœ‰è®¸å¤šæˆ‘ä»¬éœ€è¦çš„é…ç½®ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒæ¥è¿›è¡Œè‡ªå®šä¹‰å®‰å…¨è®¿é—®ç­–ç•¥ã€‚ è®¤è¯æµç¨‹å›¾ ç™»é™†æ ¡éªŒæµç¨‹ SpringSecurityå®Œæ•´æµç¨‹ SpringSecurityçš„åŸç†å…¶å®å°±æ˜¯ä¸€ä¸ªè¿‡æ»¤å™¨é“¾ï¼Œå†…éƒ¨åŒ…å«äº†æä¾›å„ç§åŠŸèƒ½çš„è¿‡æ»¤å™¨ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹å…¥é—¨æ¡ˆä¾‹ä¸­çš„è¿‡æ»¤å™¨ã€‚\nå›¾ä¸­åªå±•ç¤ºäº†æ ¸å¿ƒè¿‡æ»¤å™¨ï¼Œå…¶å®ƒçš„éæ ¸å¿ƒè¿‡æ»¤å™¨å¹¶æ²¡æœ‰åœ¨å›¾ä¸­å±•ç¤ºã€‚\nUsernamePasswordAuthenticationFilterï¼šè´Ÿè´£å¤„ç†æˆ‘ä»¬åœ¨ç™»é™†é¡µé¢å¡«å†™äº†ç”¨æˆ·åå¯†ç åçš„ç™»é™†è¯·æ±‚ã€‚å…¥é—¨æ¡ˆä¾‹çš„è®¤è¯å·¥ä½œä¸»è¦æœ‰å®ƒè´Ÿè´£ã€‚\nExceptionTranslationFilterï¼š å¤„ç†è¿‡æ»¤å™¨é“¾ä¸­æŠ›å‡ºçš„ä»»ä½•AccessDeniedExceptionå’ŒAuthenticationException ã€‚\nFilterSecurityInterceptorï¼š è´Ÿè´£æƒé™æ ¡éªŒçš„è¿‡æ»¤å™¨ã€‚\nè®¤è¯æµç¨‹è¯¦è§£ æ¦‚å¿µé€ŸæŸ¥:\nAuthenticationæ¥å£: å®ƒçš„å®ç°ç±»ï¼Œè¡¨ç¤ºå½“å‰è®¿é—®ç³»ç»Ÿçš„ç”¨æˆ·ï¼Œå°è£…äº†ç”¨æˆ·ç›¸å…³ä¿¡æ¯ã€‚\nAuthenticationManageræ¥å£ï¼šå®šä¹‰äº†è®¤è¯Authenticationçš„æ–¹æ³•\nUserDetailsServiceæ¥å£ï¼šåŠ è½½ç”¨æˆ·ç‰¹å®šæ•°æ®çš„æ ¸å¿ƒæ¥å£ã€‚é‡Œé¢å®šä¹‰äº†ä¸€ä¸ªæ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯çš„æ–¹æ³•ã€‚\nUserDetailsæ¥å£ï¼šæä¾›æ ¸å¿ƒç”¨æˆ·ä¿¡æ¯ã€‚é€šè¿‡UserDetailsServiceæ ¹æ®ç”¨æˆ·åè·å–å¤„ç†çš„ç”¨æˆ·ä¿¡æ¯è¦å°è£…æˆUserDetailså¯¹è±¡è¿”å›ã€‚ç„¶åå°†è¿™äº›ä¿¡æ¯å°è£…åˆ°Authenticationå¯¹è±¡ä¸­ã€‚\nè®¤è¯è¿‡ç¨‹ è®¤è¯è¿‡æ»¤å™¨UsernamePasswordAuthenticationFilter:å®ƒçš„ä½œç”¨æ˜¯æ‹¦æˆªç™»å½•è¯·æ±‚å¹¶è·å–è´¦å·å’Œ å¯†ç ï¼Œç„¶åæŠŠè´¦å·å¯†ç å°è£…åˆ°è®¤è¯å‡­æ® UsernamePasswordAuthenticationToken ä¸­ï¼Œç„¶åæŠŠå‡­æ®äº¤ ç»™ç‰¹å®šé…ç½®çš„ AuthenticationManagerå»ä½œè®¤è¯ã€‚\næˆæƒ æƒé™æ§åˆ¶é…ç½® ä¸€ã€åŸºäºé…ç½®è¡¨è¾¾å¼æ§åˆ¶ URL è·¯å¾„\nåœ¨ç»§æ‰¿WebSecurityConfigurerAdapterçš„é…ç½®ç±»ä¸­çš„configure(HttpSecurity http)ä¸­è¿›è¡Œé…ç½®ã€‚\nä¾‹å¦‚ï¼š\n1 2 3 4 5 6 7 8 protected void configure(HttpSecurity http) throws Exception { http.authorizeRequests() .antMatchers(\"/admin/**\").hasRole(\"admin\") .antMatchers(\"/user/**\").hasAnyRole(\"admin\", \"user\") .anyRequest().authenticated() .and() ... } å¸¸ç”¨çš„é…ç½®å¯é€‰é¡¹ï¼š\näºŒã€åŸºäºæ³¨è§£çš„æ¥å£æƒé™æ§åˆ¶\næˆ‘ä»¬å¯ä»¥åœ¨ä»»ä½• @Configurationå®ä¾‹ä¸Šä½¿ç”¨ @EnableGlobalMethodSecurityæ³¨è§£æ¥å¯ç”¨å…¨å±€æ–¹ æ³•å®‰å…¨æ³¨è§£åŠŸèƒ½\nä¾‹å¦‚ï¼š\n1 2 3 4 5 6 @Configuration @EnableGlobalMethodSecurity(prePostEnabled = true,securedEnabled = true,jsr250Enabled = true) public class SecurityConfig extends WebSecurityConfigurerAdapter { ... ... } è®¾ç½® prePostEnabledä¸º true ï¼Œåˆ™å¼€å¯äº†åŸºäºè¡¨è¾¾å¼ çš„æ–¹æ³•å®‰å…¨æ§åˆ¶ã€‚ è¿™ä¸ªé…ç½®å¼€å¯äº†å››ä¸ªæ³¨è§£ï¼Œåˆ†åˆ«æ˜¯ï¼š\n@PreAuthorizeï¼šåœ¨æ ‡è®°çš„æ–¹æ³•è°ƒç”¨ä¹‹å‰ï¼Œé€šè¿‡è¡¨è¾¾å¼æ¥è®¡ç®—æ˜¯å¦å¯ä»¥æˆæƒè®¿é—®ã€‚ @PostAuthorizeï¼šåœ¨æ ‡è®°çš„æ–¹æ³•è°ƒç”¨ä¹‹åï¼Œé€šè¿‡è¡¨è¾¾å¼æ¥è®¡ç®—æ˜¯å¦å¯ä»¥æˆæƒè®¿é—®ã€‚è¯¥æ³¨è§£æ˜¯é’ˆå¯¹@PreAuthorize ã€‚åŒºåˆ« åœ¨äºå…ˆæ‰§è¡Œæ–¹æ³•ã€‚è€Œåè¿›è¡Œè¡¨è¾¾å¼åˆ¤æ–­ã€‚å¦‚æœæ–¹æ³•æ²¡æœ‰è¿”å›å€¼å®é™…ä¸Šç­‰äºå¼€æ”¾æƒé™æ§åˆ¶ï¼›å¦‚æœæœ‰è¿”å›å€¼ å®é™…çš„ç»“æœæ˜¯ç”¨æˆ·æ“ä½œæˆåŠŸä½†æ˜¯å¾—ä¸åˆ°å“åº”ã€‚ @PreFilter:åŸºäºæ–¹æ³•å…¥å‚ç›¸å…³çš„è¡¨è¾¾å¼ï¼Œå¯¹å…¥å‚è¿›è¡Œè¿‡æ»¤ã€‚ @PostFilter:å’Œ @PreFilterä¸åŒçš„æ˜¯ï¼Œ åŸºäºè¿”å›å€¼ç›¸å…³çš„è¡¨è¾¾å¼ï¼Œå¯¹è¿”å›å€¼è¿›è¡Œè¿‡æ»¤ã€‚åˆ†é¡µæ…ç”¨ï¼ è¯¥è¿‡ç¨‹å‘ç”Ÿæ¥å£è¿›è¡Œæ•°æ®è¿”å›ä¹‹å‰ã€‚ è®¾ç½®securedEnabled ä¸º true ï¼Œå°±å¼€å¯äº†è§’è‰²æ³¨è§£@Secured ï¼Œè¯¥æ³¨è§£åŠŸèƒ½è¦ç®€å•çš„å¤šï¼Œé»˜è®¤æƒ…å†µä¸‹åªèƒ½åŸºäºè§’è‰²ï¼ˆé»˜è®¤éœ€è¦å¸¦å‰ç¼€ ROLE_ ï¼‰é›†åˆæ¥è¿›è¡Œè®¿é—®æ§åˆ¶å†³ç­–ã€‚\nè¯¥æ³¨è§£çš„æœºåˆ¶æ˜¯åªè¦å…¶å£°æ˜çš„è§’è‰²é›†åˆ(value )ä¸­åŒ…å«å½“å‰ç”¨æˆ·æŒæœ‰çš„ä»»ä¸€è§’è‰²å°±å¯ä»¥è®¿é—®ã€‚ä¹Ÿå°±æ˜¯ ç”¨æˆ·çš„è§’è‰²é›†åˆå’Œ@Securedæ³¨è§£çš„è§’è‰²é›†åˆè¦å­˜åœ¨éç©ºçš„äº¤é›†ã€‚ ä¸æ”¯æŒä½¿ç”¨ SpELè¡¨è¾¾å¼è¿›è¡Œå†³ç­–ã€‚\nè®¾ç½® jsr250Enabledä¸º true ï¼Œå°±å¼€å¯äº† JavaEE å®‰å…¨ æ³¨è§£ä¸­çš„ä»¥ä¸‹ä¸‰ä¸ªï¼š\n@DenyAll æ‹’ç»æ‰€æœ‰çš„è®¿é—® @PermitAll åŒæ„æ‰€æœ‰çš„è®¿é—® @RolesAllowed ç”¨æ³•å’Œ@Secured ä¸€æ ·ã€‚ ==åŸºäºæ³¨è§£çš„æƒé™æ§åˆ¶ä¸¤ç§å®ç°æ–¹å¼ï¼š==\n**ç¬¬ä¸€ç§ï¼š**ä½¿ç”¨spring securityè‡ªå¸¦çš„æ³¨è§£\n@PreAuthorize(\"hasAnyAuthority('admin','test','system:dept:list')\")\nhasRoleè¦æ±‚æœ‰å¯¹åº”çš„è§’è‰²æ‰å¯ä»¥è®¿é—®ï¼Œä½†æ˜¯å®ƒå†…éƒ¨ä¼šæŠŠæˆ‘ä»¬ä¼ å…¥çš„å‚æ•°æ‹¼æ¥ä¸Š ROLE_ åå†å»æ¯”è¾ƒã€‚æ‰€ä»¥è¿™ç§æƒ…å†µä¸‹è¦ç”¨ç”¨æˆ·å¯¹åº”çš„æƒé™ä¹Ÿè¦æœ‰ ROLE_ è¿™ä¸ªå‰ç¼€æ‰å¯ä»¥ã€‚\nç¬¬äºŒç§ï¼šè‡ªå®šä¹‰æƒé™æ ¡éªŒæ–¹æ³•\nåœ¨@PreAuthorizeæ³¨è§£ä¸­ä½¿ç”¨æˆ‘ä»¬çš„æ–¹æ³•\n1 2 3 4 5 6 7 @PreAuthorize(\"@ss.hasPermi('system:menu:list')\") @GetMapping(\"/list\") public AjaxResult list(SysMenu menu) { List\u003cSysMenu\u003e menus = menuService.selectMenuList(menu, getUserId()); return AjaxResult.success(menus); } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 /** * éªŒè¯ç”¨æˆ·æ˜¯å¦å…·å¤‡æŸæƒé™ * * @param permission æƒé™å­—ç¬¦ä¸² * @return ç”¨æˆ·æ˜¯å¦å…·å¤‡æŸæƒé™ */ public boolean hasPermi(String permission) { if (StringUtils.isEmpty(permission)) { return false; } LoginUser loginUser = SecurityUtils.getLoginUser(); if (StringUtils.isNull(loginUser) || CollectionUtils.isEmpty(loginUser.getPermissions())) { return false; } return hasPermissions(loginUser.getPermissions(), permission); } æˆæƒåŸºæœ¬æµç¨‹ åœ¨SpringSecurityä¸­ï¼Œä¼šä½¿ç”¨é»˜è®¤çš„FilterSecurityInterceptoræ¥è¿›è¡Œæƒé™æ ¡éªŒã€‚åœ¨FilterSecurityInterceptorä¸­ä¼šä»SecurityContextHolderè·å–å…¶ä¸­çš„Authenticationï¼Œç„¶åè·å–å…¶ä¸­çš„æƒé™ä¿¡æ¯ã€‚å½“å‰ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰è®¿é—®å½“å‰èµ„æºæ‰€éœ€çš„æƒé™ã€‚\næ‰€ä»¥æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­åªéœ€è¦æŠŠå½“å‰ç™»å½•ç”¨æˆ·çš„æƒé™ä¿¡æ¯ä¹Ÿå­˜å…¥Authenticationã€‚\nç„¶åè®¾ç½®æˆ‘ä»¬çš„èµ„æºæ‰€éœ€è¦çš„æƒé™å³å¯ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 /** * éªŒè¯ç”¨æˆ·æ˜¯å¦å…·å¤‡æŸæƒé™ * * @param permission æƒé™å­—ç¬¦ä¸² * @return ç”¨æˆ·æ˜¯å¦å…·å¤‡æŸæƒé™ */ public boolean hasPermi(String permission) { if (StringUtils.isEmpty(permission)) { return false; } LoginUser loginUser = SecurityUtils.getLoginUser(); if (StringUtils.isNull(loginUser) || CollectionUtils.isEmpty(loginUser.getPermissions())) { return false; } return hasPermissions(loginUser.getPermissions(), permission); } /** * è·å–ç”¨æˆ· **/ public static LoginUser getLoginUser() { try { return (LoginUser) getAuthentication().getPrincipal(); } catch (Exception e) { throw new ServiceException(\"è·å–ç”¨æˆ·ä¿¡æ¯å¼‚å¸¸\", HttpStatus.UNAUTHORIZED); } } RBACæƒé™æ¨¡å‹ RBACæƒé™æ¨¡å‹ï¼ˆRole-Based Access Controlï¼‰å³ï¼šåŸºäºè§’è‰²çš„æƒé™æ§åˆ¶ã€‚è¿™æ˜¯ç›®å‰æœ€å¸¸è¢«å¼€å‘è€…ä½¿ç”¨ä¹Ÿæ˜¯ç›¸å¯¹æ˜“ç”¨ã€é€šç”¨æƒé™æ¨¡å‹ã€‚\nå‚è€ƒé“¾æ¥ï¼š\nSpring Security ä¸­çš„ hasRole å’Œ hasAuthority æœ‰åŒºåˆ«å—ï¼Ÿ\nç™»å½•å®ç° 1.å¼•å…¥ Spring Security æ¨¡å— 1 2 3 4 org.springframework.boot spring-boot-starter-security å¼•å…¥ä¾èµ–åæˆ‘ä»¬åœ¨å°è¯•å»è®¿é—®ä¹‹å‰çš„æ¥å£å°±ä¼šè‡ªåŠ¨è·³è½¬åˆ°ä¸€ä¸ªSpringSecurityçš„é»˜è®¤ç™»é™†é¡µé¢ï¼Œé»˜è®¤ç”¨æˆ·åæ˜¯user,å¯†ç ä¼šè¾“å‡ºåœ¨æ§åˆ¶å°ã€‚ å¿…é¡»ç™»é™†ä¹‹åæ‰èƒ½å¯¹æ¥å£è¿›è¡Œè®¿é—®ã€‚\n2.ç¼–å†™ Spring Security é…ç½®ç±» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 @EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true) public class SecurityConfig extends WebSecurityConfigurerAdapter { /** * è‡ªå®šä¹‰ç”¨æˆ·è®¤è¯é€»è¾‘ */ @Autowired private UserDetailsService userDetailsService; /** * è®¤è¯å¤±è´¥å¤„ç†ç±» */ @Autowired private AuthenticationEntryPointImpl unauthorizedHandler; /** * é€€å‡ºå¤„ç†ç±» */ @Autowired private LogoutSuccessHandlerImpl logoutSuccessHandler; /** * tokenè®¤è¯è¿‡æ»¤å™¨ */ @Autowired private JwtAuthenticationTokenFilter authenticationTokenFilter; /** * è·¨åŸŸè¿‡æ»¤å™¨ */ @Autowired private CorsFilter corsFilter; /** * å…è®¸åŒ¿åè®¿é—®çš„åœ°å€ */ @Autowired private PermitAllUrlProperties permitAllUrl; /** * è§£å†³ æ— æ³•ç›´æ¥æ³¨å…¥ AuthenticationManager * * @return * @throws Exception */ @Bean @Override public AuthenticationManager authenticationManagerBean() throws Exception { return super.authenticationManagerBean(); } /** * anyRequest | åŒ¹é…æ‰€æœ‰è¯·æ±‚è·¯å¾„ * access | SpringElè¡¨è¾¾å¼ç»“æœä¸ºtrueæ—¶å¯ä»¥è®¿é—® * anonymous | åŒ¿åå¯ä»¥è®¿é—® * denyAll | ç”¨æˆ·ä¸èƒ½è®¿é—® * fullyAuthenticated | ç”¨æˆ·å®Œå…¨è®¤è¯å¯ä»¥è®¿é—®ï¼ˆéremember-meä¸‹è‡ªåŠ¨ç™»å½•ï¼‰ * hasAnyAuthority | å¦‚æœæœ‰å‚æ•°ï¼Œå‚æ•°è¡¨ç¤ºæƒé™ï¼Œåˆ™å…¶ä¸­ä»»ä½•ä¸€ä¸ªæƒé™å¯ä»¥è®¿é—® * hasAnyRole | å¦‚æœæœ‰å‚æ•°ï¼Œå‚æ•°è¡¨ç¤ºè§’è‰²ï¼Œåˆ™å…¶ä¸­ä»»ä½•ä¸€ä¸ªè§’è‰²å¯ä»¥è®¿é—® * hasAuthority | å¦‚æœæœ‰å‚æ•°ï¼Œå‚æ•°è¡¨ç¤ºæƒé™ï¼Œåˆ™å…¶æƒé™å¯ä»¥è®¿é—® * hasIpAddress | å¦‚æœæœ‰å‚æ•°ï¼Œå‚æ•°è¡¨ç¤ºIPåœ°å€ï¼Œå¦‚æœç”¨æˆ·IPå’Œå‚æ•°åŒ¹é…ï¼Œåˆ™å¯ä»¥è®¿é—® * hasRole | å¦‚æœæœ‰å‚æ•°ï¼Œå‚æ•°è¡¨ç¤ºè§’è‰²ï¼Œåˆ™å…¶è§’è‰²å¯ä»¥è®¿é—® * permitAll | ç”¨æˆ·å¯ä»¥ä»»æ„è®¿é—® * rememberMe | å…è®¸é€šè¿‡remember-meç™»å½•çš„ç”¨æˆ·è®¿é—® * authenticated | ç”¨æˆ·ç™»å½•åå¯è®¿é—® */ @Override protected void configure(HttpSecurity httpSecurity) throws Exception { // æ³¨è§£æ ‡è®°å…è®¸åŒ¿åè®¿é—®çš„url ExpressionUrlAuthorizationConfigurer\u003cHttpSecurity\u003e.ExpressionInterceptUrlRegistry registry = httpSecurity.authorizeRequests(); permitAllUrl.getUrls().forEach(url -\u003e registry.antMatchers(url).permitAll()); httpSecurity // CSRFç¦ç”¨ï¼Œå› ä¸ºä¸ä½¿ç”¨session // å…³é—­csrfåŠŸèƒ½:è·¨ç«™è¯·æ±‚ä¼ªé€ ,é»˜è®¤åªèƒ½é€šè¿‡postæ–¹å¼æäº¤logoutè¯·æ±‚ .csrf().disable() // è®¤è¯å¤±è´¥å¤„ç†ç±» .exceptionHandling().authenticationEntryPoint(unauthorizedHandler).and() // åŸºäºtokenï¼Œæ‰€ä»¥ä¸éœ€è¦session .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS).and() // è¿‡æ»¤è¯·æ±‚ .authorizeRequests() // å¯¹äºç™»å½•login æ³¨å†Œregister éªŒè¯ç captchaImage å…è®¸åŒ¿åè®¿é—® .antMatchers(\"/login\", \"/register\", \"/captchaImage\").anonymous() // é™æ€èµ„æºï¼Œå¯åŒ¿åè®¿é—® .antMatchers(HttpMethod.GET, \"/\", \"/*.html\", \"/**/*.html\", \"/**/*.css\", \"/**/*.js\", \"/profile/**\").permitAll() .antMatchers(\"/swagger-ui.html\", \"/swagger-resources/**\", \"/webjars/**\", \"/*/api-docs\", \"/druid/**\").permitAll() // é™¤ä¸Šé¢å¤–çš„æ‰€æœ‰è¯·æ±‚å…¨éƒ¨éœ€è¦é‰´æƒè®¤è¯ .anyRequest().authenticated() .and() .headers().frameOptions().disable(); // æ·»åŠ Logout filter httpSecurity.logout().logoutUrl(\"/logout\").logoutSuccessHandler(logoutSuccessHandler); // æ·»åŠ JWT filter httpSecurity.addFilterBefore(authenticationTokenFilter, UsernamePasswordAuthenticationFilter.class); // æ·»åŠ CORS filter httpSecurity.addFilterBefore(corsFilter, JwtAuthenticationTokenFilter.class); httpSecurity.addFilterBefore(corsFilter, LogoutFilter.class); // å¼€å¯è‡ªåŠ¨é…ç½®çš„ç™»å½•åŠŸèƒ½ // http.formLogin() // .loginPage(\"/toLogin\") //è‡ªå®šä¹‰ç™»å½•é¡µ // .loginProcessingUrl(\"/loginRequest\") // ç™»é™†è¡¨å•æäº¤çš„è¯·æ±‚ // .passwordParameter(\"password\"); // è¡¨å•ä¸­passwordéœ€ä¸è¯¥å¤„å¯¹åº”ã€‚é»˜è®¤æ˜¯password // http.formLogin(); // å¼€å¯è‡ªåŠ¨é…ç½®çš„æ³¨é”€çš„åŠŸèƒ½ // http.logout().logoutSuccessUrl(\"/\"); // æ³¨é”€æˆåŠŸæ¥åˆ°é¦–é¡µ // è®°ä½æˆ‘ // http.rememberMe(); // http.rememberMe(). // rememberMeParameter(\"remember\"); // å®šåˆ¶è®°ä½æˆ‘çš„å‚æ•° } /** * å¼ºæ•£åˆ—å“ˆå¸ŒåŠ å¯†å®ç° */ @Bean public BCryptPasswordEncoder bCryptPasswordEncoder() { return new BCryptPasswordEncoder(); } /** * èº«ä»½è®¤è¯æ¥å£ */ @Override protected void configure(AuthenticationManagerBuilder auth) throws Exception { // æ•°æ®åº“éªŒè¯ // Spring Security æä¾›äº†BCryptPasswordEncoderç±», // å®ç°Springçš„PasswordEncoderæ¥å£ä½¿ç”¨BCryptå¼ºå“ˆå¸Œæ–¹æ³•æ¥åŠ å¯†å¯†ç  auth.userDetailsService(userDetailsService).passwordEncoder(bCryptPasswordEncoder()); } } 3.é…ç½®ç±»ç›¸å…³æ¨¡å— UserDetailsService è‡ªå®šä¹‰ç”¨æˆ·è®¤è¯é€»è¾‘\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 @Service public class UserDetailsServiceImpl implements UserDetailsService { private static final Logger log = LoggerFactory.getLogger(UserDetailsServiceImpl.class); @Autowired private ISysUserService userService; @Autowired private SysPasswordService passwordService; @Autowired private SysPermissionService permissionService; @Override public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException { SysUser user = userService.selectUserByUserName(username); if (StringUtils.isNull(user)) { log.info(\"ç™»å½•ç”¨æˆ·ï¼š{} ä¸å­˜åœ¨.\", username); throw new ServiceException(\"ç™»å½•ç”¨æˆ·ï¼š\" + username + \" ä¸å­˜åœ¨\"); } else if (UserStatus.DELETED.getCode().equals(user.getDelFlag())) { log.info(\"ç™»å½•ç”¨æˆ·ï¼š{} å·²è¢«åˆ é™¤.\", username); throw new ServiceException(\"å¯¹ä¸èµ·ï¼Œæ‚¨çš„è´¦å·ï¼š\" + username + \" å·²è¢«åˆ é™¤\"); } else if (UserStatus.DISABLE.getCode().equals(user.getStatus())) { log.info(\"ç™»å½•ç”¨æˆ·ï¼š{} å·²è¢«åœç”¨.\", username); throw new ServiceException(\"å¯¹ä¸èµ·ï¼Œæ‚¨çš„è´¦å·ï¼š\" + username + \" å·²åœç”¨\"); } passwordService.validate(user); return createLoginUser(user); } public UserDetails createLoginUser(SysUser user) { return new LoginUser(user.getUserId(), user); } } AuthenticationEntryPointImpl è®¤è¯å¤±è´¥å¤„ç†ç±» è¿”å›æœªæˆæƒ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 @Component public class AuthenticationEntryPointImpl implements AuthenticationEntryPoint, Serializable { private static final long serialVersionUID = -8970718410437077606L; @Override public void commence(HttpServletRequest request, HttpServletResponse response, AuthenticationException e) throws IOException { int code = HttpStatus.UNAUTHORIZED; String msg = StringUtils.format(\"è¯·æ±‚è®¿é—®ï¼š{}ï¼Œè®¤è¯å¤±è´¥ï¼Œæ— æ³•è®¿é—®ç³»ç»Ÿèµ„æº\", request.getRequestURI()); ServletUtils.renderString(response, JSON.toJSONString(ApiResponse.error(code, msg))); } } LogoutSuccessHandlerImpl è‡ªå®šä¹‰é€€å‡ºå¤„ç†ç±» è¿”å›æˆåŠŸ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 @Configuration public class LogoutSuccessHandlerImpl implements LogoutSuccessHandler { @Autowired private TokenService tokenService; @Autowired private IAsyncService asyncService; /** * é€€å‡ºå¤„ç† * * @return */ @Override public void onLogoutSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException { LoginUser loginUser = tokenService.getLoginUser(request); if (StringUtils.isNotNull(loginUser)) { String userName = loginUser.getUsername(); // åˆ é™¤ç”¨æˆ·ç¼“å­˜è®°å½• tokenService.delLoginUser(loginUser.getToken()); // è®°å½•ç”¨æˆ·é€€å‡ºæ—¥å¿— asyncService.recordLogininfor(userName, Constants.LOGOUT, \"é€€å‡ºæˆåŠŸ\"); } ServletUtils.renderString(response, JSON.toJSONString(ApiResponse.error(HttpStatus.SUCCESS, \"é€€å‡ºæˆåŠŸ\"))); } } JwtAuthenticationTokenFiltertoken tokenè¿‡æ»¤å™¨ éªŒè¯tokenæœ‰æ•ˆæ€§\nSecurityContextHolder ç±»æœ€æ ¸å¿ƒçš„ä½œç”¨ï¼Œä¾¿æ˜¯å°†å½“å‰ç»™å®šçš„ SecurityContext ä¸ å½“å‰æ‰§è¡Œçº¿ç¨‹ç»‘å®šï¼Œä»è€Œæ–¹ä¾¿åç»­ç›´æ¥è·å–ã€‚\nåœ¨SecurityContextHolderä¸­ä¿å­˜çš„æ˜¯å½“å‰è®¿é—®è€…çš„ä¿¡æ¯ã€‚Spring Securityä½¿ç”¨ä¸€ä¸ªAuthenticationå¯¹è±¡æ¥è¡¨ç¤ºè¿™ä¸ªä¿¡æ¯ã€‚\né€šè¿‡SecurityContextHolder.getContext().setAuthentication(authentication);æ–¹å¼å°†ç”¨æˆ·ç›¸å…³çš„ä¿¡æ¯å­˜æ”¾åˆ°ç³»ç»Ÿçš„å®‰å…¨ä¸Šä¸‹æ–‡ä¸­ï¼Œå¹¶ä¸”ç”±äº SecurityContextHolderé»˜è®¤æ˜¯mode_threadlocalæ¨¡å¼ï¼Œé‚£ä¹ˆä¼šå°†æ‰€æœ‰ç™»å½•çš„ç”¨æˆ·ä¿¡æ¯éƒ½ä¿å­˜ï¼Œæ¯ä¸ªç™»å½•çš„ç”¨æˆ·éƒ½å¯ä»¥é€šè¿‡SecurityContextHolder.getContext().getAuthentication();æ–¹å¼è·å– å½“å‰è‡ªå·±ä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 @Component public class JwtAuthenticationTokenFilter extends OncePerRequestFilter { @Autowired private TokenService tokenService; @Override protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain chain) throws ServletException, IOException { LoginUser loginUser = tokenService.getLoginUser(request); if (StringUtils.isNotNull(loginUser) \u0026\u0026 StringUtils.isNull(SecurityUtils.getAuthentication())) { tokenService.verifyToken(loginUser); // è·å–æƒé™ä¿¡æ¯å°è£…åˆ°Authenticationä¸­ UsernamePasswordAuthenticationToken authenticationToken = new UsernamePasswordAuthenticationToken(loginUser, null, loginUser.getAuthorities()); authenticationToken.setDetails(new WebAuthenticationDetailsSource().buildDetails(request)); // å­˜å…¥SecurityContextHolder SecurityContextHolder.getContext().setAuthentication(authenticationToken); } chain.doFilter(request, response); } } ResourcesConfig è·¨åŸŸè¿‡æ»¤å™¨\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 @Configuration public class ResourcesConfig implements WebMvcConfigurer { /** * è·¨åŸŸé…ç½® */ @Bean public CorsFilter corsFilter() { CorsConfiguration config = new CorsConfiguration(); config.setAllowCredentials(true); // è®¾ç½®è®¿é—®æºåœ°å€ config.addAllowedOriginPattern(\"*\"); // è®¾ç½®è®¿é—®æºè¯·æ±‚å¤´ config.addAllowedHeader(\"*\"); // è®¾ç½®è®¿é—®æºè¯·æ±‚æ–¹æ³• config.addAllowedMethod(\"*\"); // æœ‰æ•ˆæœŸ 1800ç§’ config.setMaxAge(1800L); // æ·»åŠ æ˜ å°„è·¯å¾„ï¼Œæ‹¦æˆªä¸€åˆ‡è¯·æ±‚ UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource(); source.registerCorsConfiguration(\"/**\", config); // è¿”å›æ–°çš„CorsFilter return new CorsFilter(source); } } PermitAllUrlProperties è®¾ç½®Anonymousæ³¨è§£å…è®¸åŒ¿åè®¿é—®çš„url\nå‚è€ƒé“¾æ¥ï¼š\nApplicationContextAwareæ¥å£çš„ä½œç”¨\nè¿™ä¸ªæ¥å£å…¶å®å°±æ˜¯è·å–Springå®¹å™¨çš„Beanï¼Œåœ¨æˆ‘ä»¬å†™ä¸€äº›æ¡†æ¶ä»£ç æ—¶ï¼Œæˆ–è€…æ˜¯çœ‹ä¸€äº›æ¡†æ¶æºç æ—¶ç»å¸¸ä¼šçœ‹åˆ°è¿™ä¸ªæ¥å£ApplicationContextAware çš„ä½¿ç”¨ï¼ŒSpringå®¹å™¨ä¼šæ£€æµ‹å®¹å™¨ä¸­çš„æ‰€æœ‰Beanï¼Œå¦‚æœå‘ç°æŸä¸ªBeanå®ç°äº†ApplicationContextAwareæ¥å£ï¼ŒSpringå®¹å™¨ä¼šåœ¨åˆ›å»ºè¯¥Beanä¹‹åï¼Œè‡ªåŠ¨è°ƒç”¨è¯¥Beançš„setApplicationContextAware()æ–¹æ³•ï¼Œè°ƒç”¨è¯¥æ–¹æ³•æ—¶ï¼Œä¼šå°†å®¹å™¨æœ¬èº«ä½œä¸ºå‚æ•°ä¼ ç»™è¯¥æ–¹æ³•â€”â€”è¯¥æ–¹æ³•ä¸­çš„å®ç°éƒ¨åˆ†å°†Springä¼ å…¥çš„å‚æ•°ï¼ˆå®¹å™¨æœ¬èº«ï¼‰èµ‹ç»™è¯¥ç±»å¯¹è±¡çš„applicationContextå®ä¾‹å˜é‡ï¼Œå› æ­¤æ¥ä¸‹æ¥å¯ä»¥é€šè¿‡è¯¥applicationContextå®ä¾‹å˜é‡æ¥è®¿é—®å®¹å™¨æœ¬èº«\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 @Configuration public class PermitAllUrlProperties implements InitializingBean, ApplicationContextAware { private static final Pattern PATTERN = Pattern.compile(\"\\\\{(.*?)\\\\}\"); private ApplicationContext applicationContext; private List\u003cString\u003e urls = new ArrayList\u003c\u003e(); public String ASTERISK = \"*\"; @Override public void afterPropertiesSet() { RequestMappingHandlerMapping mapping = applicationContext.getBean(RequestMappingHandlerMapping.class); Map\u003cRequestMappingInfo, HandlerMethod\u003e map = mapping.getHandlerMethods(); map.keySet().forEach(info -\u003e { HandlerMethod handlerMethod = map.get(info); // è·å–æ–¹æ³•ä¸Šè¾¹çš„æ³¨è§£ æ›¿ä»£path variable ä¸º * Anonymous method = AnnotationUtils.findAnnotation(handlerMethod.getMethod(), Anonymous.class); Optional.ofNullable(method).ifPresent(anonymous -\u003e info.getPatternsCondition().getPatterns() .forEach(url -\u003e urls.add(RegExUtils.replaceAll(url, PATTERN, ASTERISK)))); // è·å–ç±»ä¸Šè¾¹çš„æ³¨è§£, æ›¿ä»£path variable ä¸º * Anonymous controller = AnnotationUtils.findAnnotation(handlerMethod.getBeanType(), Anonymous.class); Optional.ofNullable(controller).ifPresent(anonymous -\u003e info.getPatternsCondition().getPatterns() .forEach(url -\u003e urls.add(RegExUtils.replaceAll(url, PATTERN, ASTERISK)))); }); } @Override public void setApplicationContext(ApplicationContext context) throws BeansException { this.applicationContext = context; } public List\u003cString\u003e getUrls() { return urls; } public void setUrls(List\u003cString\u003e urls) { this.urls = urls; } } 4.ç™»å½•æ¨¡å— authenticationManager.authenticate ä¼šè°ƒç”¨ UserDetailsServiceImpl.loadUserByUsername è¿›è¡Œèº«ä»½è®¤è¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 public String login(String username, String password, String code, String uuid) { // boolean captchaEnabled = configService.selectCaptchaEnabled(); // éªŒè¯ç å¼€å…³ if (false) { // validateCaptcha(username, code, uuid); } // ç”¨æˆ·éªŒè¯ Authentication authentication = null; try { UsernamePasswordAuthenticationToken authenticationToken = new UsernamePasswordAuthenticationToken(username, password); AuthenticationContextHolder.setContext(authenticationToken); // è¯¥æ–¹æ³•ä¼šå»è°ƒç”¨UserDetailsServiceImpl.loadUserByUsername authentication = authenticationManager.authenticate(authenticationToken); } catch (Exception e) { if (e instanceof BadCredentialsException) { String message = MessageUtils.message(\"user.password.not.match\"); asyncService.recordLogininfor(username, Constants.LOGIN_FAIL, message); throw new ServiceException(message); } else { asyncService.recordLogininfor(username, Constants.LOGIN_FAIL, e.getMessage()); throw new ServiceException(e.getMessage()); } } asyncService.recordLogininfor(username, Constants.LOGIN_SUCCESS, MessageUtils.message(\"user.login.success\")); LoginUser loginUser = (LoginUser) authentication.getPrincipal(); recordLoginInfo(loginUser.getUserId()); // ç”Ÿæˆtoken return tokenService.createToken(loginUser); } 5.ç™»å‡ºæ¨¡å— SecurityConfigä¸­æ·»åŠ ç™»å‡ºè¿‡æ»¤é“¾\n1 2 // æ·»åŠ Logout filter httpSecurity.logout().logoutUrl(\"/logout\").logoutSuccessHandler(logoutSuccessHandler); LogoutSuccessHandlerImplè‡ªå®šä¹‰é€€å‡ºå¤„ç†ç±» è¿”å›æˆåŠŸ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 @Configuration public class LogoutSuccessHandlerImpl implements LogoutSuccessHandler { @Autowired private TokenService tokenService; @Autowired private IAsyncService asyncService; /** * é€€å‡ºå¤„ç† * * @return */ @Override public void onLogoutSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException { LoginUser loginUser = tokenService.getLoginUser(request); if (StringUtils.isNotNull(loginUser)) { String userName = loginUser.getUsername(); // åˆ é™¤ç”¨æˆ·ç¼“å­˜è®°å½• tokenService.delLoginUser(loginUser.getToken()); // è®°å½•ç”¨æˆ·é€€å‡ºæ—¥å¿— asyncService.recordLogininfor(userName, Constants.LOGOUT, \"é€€å‡ºæˆåŠŸ\"); } ServletUtils.renderString(response, JSON.toJSONString(ApiResponse.error(HttpStatus.SUCCESS, \"é€€å‡ºæˆåŠŸ\"))); } } 6.æ³¨å†Œæ¨¡å— 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 public String register(RegisterDTO registerBody) { String msg = \"\", username = registerBody.getUsername(), password = registerBody.getPassword(); boolean captchaEnabled = configService.selectCaptchaEnabled(); // éªŒè¯ç å¼€å…³ if (captchaEnabled) { // validateCaptcha(username, registerBody.getCode(), registerBody.getUuid()); } if (StringUtils.isEmpty(username)) { msg = \"ç”¨æˆ·åä¸èƒ½ä¸ºç©º\"; } else if (StringUtils.isEmpty(password)) { msg = \"ç”¨æˆ·å¯†ç ä¸èƒ½ä¸ºç©º\"; } else if (username.length() \u003c UserConstants.USERNAME_MIN_LENGTH || username.length() \u003e UserConstants.USERNAME_MAX_LENGTH) { msg = \"è´¦æˆ·é•¿åº¦å¿…é¡»åœ¨2åˆ°20ä¸ªå­—ç¬¦ä¹‹é—´\"; } else if (password.length() \u003c UserConstants.PASSWORD_MIN_LENGTH || password.length() \u003e UserConstants.PASSWORD_MAX_LENGTH) { msg = \"å¯†ç é•¿åº¦å¿…é¡»åœ¨5åˆ°20ä¸ªå­—ç¬¦ä¹‹é—´\"; } else if (UserConstants.NOT_UNIQUE.equals(userService.checkUserNameUnique(username))) { msg = \"ä¿å­˜ç”¨æˆ·'\" + username + \"'å¤±è´¥ï¼Œæ³¨å†Œè´¦å·å·²å­˜åœ¨\"; } else { SysUser sysUser = new SysUser(); sysUser.setUserName(username); sysUser.setPassword(SecurityUtils.encryptPassword(registerBody.getPassword())); boolean regFlag = userService.registerUser(sysUser); if (!regFlag) { msg = \"æ³¨å†Œå¤±è´¥,è¯·è”ç³»ç³»ç»Ÿç®¡ç†äººå‘˜\"; } else { asyncService.recordLogininfor(username, Constants.REGISTER, MessageUtils.message(\"user.register.success\")); } } return msg; } æˆæƒå®ç° 1.åˆ›å»ºæ•°æ®åº“è¡¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 -- ---------------------------- -- è§’è‰²ä¿¡æ¯è¡¨ -- ---------------------------- drop table if exists sys_role; create table sys_role ( role_id bigint(20) not null auto_increment comment 'è§’è‰²ID', role_name varchar(30) not null comment 'è§’è‰²åç§°', role_key varchar(100) not null comment 'è§’è‰²æƒé™å­—ç¬¦ä¸²', role_sort int(4) not null comment 'æ˜¾ç¤ºé¡ºåº', data_scope char(1) default '1' comment 'æ•°æ®èŒƒå›´ï¼ˆ1ï¼šå…¨éƒ¨æ•°æ®æƒé™ 2ï¼šè‡ªå®šæ•°æ®æƒé™ 3ï¼šæœ¬éƒ¨é—¨æ•°æ®æƒé™ 4ï¼šæœ¬éƒ¨é—¨åŠä»¥ä¸‹æ•°æ®æƒé™ï¼‰', menu_check_strictly tinyint(1) default 1 comment 'èœå•æ ‘é€‰æ‹©é¡¹æ˜¯å¦å…³è”æ˜¾ç¤º', dept_check_strictly tinyint(1) default 1 comment 'éƒ¨é—¨æ ‘é€‰æ‹©é¡¹æ˜¯å¦å…³è”æ˜¾ç¤º', status char(1) not null comment 'è§’è‰²çŠ¶æ€ï¼ˆ0æ­£å¸¸ 1åœç”¨ï¼‰', del_flag char(1) default '0' comment 'åˆ é™¤æ ‡å¿—ï¼ˆ0ä»£è¡¨å­˜åœ¨ 2ä»£è¡¨åˆ é™¤ï¼‰', create_by varchar(64) default '' comment 'åˆ›å»ºè€…', create_time datetime comment 'åˆ›å»ºæ—¶é—´', update_by varchar(64) default '' comment 'æ›´æ–°è€…', update_time datetime comment 'æ›´æ–°æ—¶é—´', remark varchar(500) default null comment 'å¤‡æ³¨', primary key (role_id) ) engine=innodb auto_increment=100 comment = 'è§’è‰²ä¿¡æ¯è¡¨'; -- ---------------------------- -- èœå•æƒé™è¡¨ -- ---------------------------- drop table if exists sys_menu; create table sys_menu ( menu_id bigint(20) not null auto_increment comment 'èœå•ID', menu_name varchar(50) not null comment 'èœå•åç§°', parent_id bigint(20) default 0 comment 'çˆ¶èœå•ID', order_num int(4) default 0 comment 'æ˜¾ç¤ºé¡ºåº', path varchar(200) default '' comment 'è·¯ç”±åœ°å€', component varchar(255) default null comment 'ç»„ä»¶è·¯å¾„', query varchar(255) default null comment 'è·¯ç”±å‚æ•°', is_frame int(1) default 1 comment 'æ˜¯å¦ä¸ºå¤–é“¾ï¼ˆ0æ˜¯ 1å¦ï¼‰', is_cache int(1) default 0 comment 'æ˜¯å¦ç¼“å­˜ï¼ˆ0ç¼“å­˜ 1ä¸ç¼“å­˜ï¼‰', menu_type char(1) default '' comment 'èœå•ç±»å‹ï¼ˆMç›®å½• Cèœå• FæŒ‰é’®ï¼‰', visible char(1) default 0 comment 'èœå•çŠ¶æ€ï¼ˆ0æ˜¾ç¤º 1éšè—ï¼‰', status char(1) default 0 comment 'èœå•çŠ¶æ€ï¼ˆ0æ­£å¸¸ 1åœç”¨ï¼‰', perms varchar(100) default null comment 'æƒé™æ ‡è¯†', icon varchar(100) default '#' comment 'èœå•å›¾æ ‡', create_by varchar(64) default '' comment 'åˆ›å»ºè€…', create_time datetime comment 'åˆ›å»ºæ—¶é—´', update_by varchar(64) default '' comment 'æ›´æ–°è€…', update_time datetime comment 'æ›´æ–°æ—¶é—´', remark varchar(500) default '' comment 'å¤‡æ³¨', primary key (menu_id) ) engine=innodb auto_increment=2000 comment = 'èœå•æƒé™è¡¨'; -- ---------------------------- -- è§’è‰²å’Œèœå•å…³è”è¡¨ è§’è‰²1-Nèœå• -- ---------------------------- drop table if exists sys_role_menu; create table sys_role_menu ( role_id bigint(20) not null comment 'è§’è‰²ID', menu_id bigint(20) not null comment 'èœå•ID', primary key(role_id, menu_id) ) engine=innodb comment = 'è§’è‰²å’Œèœå•å…³è”è¡¨'; -- ---------------------------- -- ç”¨æˆ·å’Œè§’è‰²å…³è”è¡¨ ç”¨æˆ·N-1è§’è‰² -- ---------------------------- drop table if exists sys_user_role; create table sys_user_role ( user_id bigint(20) not null comment 'ç”¨æˆ·ID', role_id bigint(20) not null comment 'è§’è‰²ID', primary key(user_id, role_id) ) engine=innodb comment = 'ç”¨æˆ·å’Œè§’è‰²å…³è”è¡¨'; 2.æƒé™è¿‡æ»¤å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 @Component public class JwtAuthenticationTokenFilter extends OncePerRequestFilter { @Autowired private TokenService tokenService; @Override protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain chain) throws ServletException, IOException { LoginUser loginUser = tokenService.getLoginUser(request); if (StringUtils.isNotNull(loginUser) \u0026\u0026 StringUtils.isNull(SecurityUtils.getAuthentication())) { tokenService.verifyToken(loginUser); // è·å–æƒé™ä¿¡æ¯å°è£…åˆ°Authenticationä¸­ UsernamePasswordAuthenticationToken authenticationToken = new UsernamePasswordAuthenticationToken(loginUser, null, loginUser.getAuthorities()); authenticationToken.setDetails(new WebAuthenticationDetailsSource().buildDetails(request)); // å­˜å…¥SecurityContextHolder SecurityContextHolder.getContext().setAuthentication(authenticationToken); } chain.doFilter(request, response); } } 3.ç™»å½•æ—¶æƒé™èµ‹å€¼ åœ¨ UserDetailsServiceImpl çš„ loadUserByUsername ä¸­ä¸ºuserèµ‹ä¸Šæƒé™\n4.æƒé™æŸ¥è¯¢Mapper 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 ",
  "wordCount" : "9406",
  "inLanguage": "zh",
  "datePublished": "2023-06-10T00:00:00Z",
  "dateModified": "2023-06-10T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "chance7bin"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://chance7bin.github.io/posts/note/spring-security/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Binb's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://chance7bin.github.io/" accesskey="h" title="Binb&#39;s Blog (Alt + H)">
                <img src="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg" alt="" aria-label="logo"
                    height="35">Binb&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://chance7bin.github.io/search" title="ğŸ”æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ”æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="https://chance7bin.github.io/" title="ğŸ  ä¸»é¡µ">
                    <span>ğŸ  ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://chance7bin.github.io/archives/" title="â±ï¸ æ—¶é—´è½´">
                    <span>â±ï¸ æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://chance7bin.github.io/posts" title="ğŸ“š æ–‡ç« ">
                    <span>ğŸ“š æ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://chance7bin.github.io/tags" title="ğŸ”– æ ‡ç­¾">
                    <span>ğŸ”– æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://github.com/chance7bin" title="GitHub">
                    <span>GitHub</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://chance7bin.github.io/">ğŸ  ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://chance7bin.github.io/posts/">ğŸ“š æ–‡ç« </a>&nbsp;Â»&nbsp;<a href="https://chance7bin.github.io/posts/note/">ğŸ‘¨ğŸ»â€ğŸ’» æˆ‘çš„ç¬”è®°</a></div>
    <h1 class="post-title">
      Spring Security
    </h1>
    <div class="post-meta">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">


<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }

    .parent-post-meta {
        display: flex;
        flex-wrap: wrap;
        opacity: 0.8;
    }
</style>

<span class="parent-post-meta">
    <span id="post_meta_style_1">
        <span class="fa fa-calendar-check-o"></span>
        <span>2023-06-10
            &nbsp;&nbsp;
        </span>
    </span>
    
    
    
    
    
    
    
    <span id="post_meta_style_3">
        <span class="fa fa-file-word-o"></span>
        <span>9406å­—
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_4">
        <span class="fa fa-clock-o"></span>
        <span>19åˆ†é’Ÿ
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_5">
        <span class="fa fa-user-o"></span>
        <span>chance7bin
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_6">
        <span class="fa fa-tags" style="opacity: 0.8"></span>
        <span>
            <span class="post-tags-meta">
                <a href="https://chance7bin.github.io/tags/spring-boot/" style="color: var(--secondary)!important;">Spring Boot</a>
            </span>
        </span>
    </span>

    
</span>


      
      
      
      
      
      
      
          
          
          
              
              
              
              
          
      
    </div>
  </header>
   <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e8%ae%a4%e8%af%86springsecurity" aria-label="è®¤è¯†SpringSecurity">è®¤è¯†SpringSecurity</a></li>
                    <li>
                        <a href="#spring-secutity%e6%a0%b8%e5%bf%83%e5%86%85%e5%ae%b9" aria-label="Spring Secutityæ ¸å¿ƒå†…å®¹">Spring Secutityæ ¸å¿ƒå†…å®¹</a><ul>
                            
                    <li>
                        <a href="#spring-secutity%e4%b8%ad%e7%9a%84%e7%94%a8%e6%88%b7%e4%bf%a1%e6%81%af" aria-label="Spring Secutityä¸­çš„ç”¨æˆ·ä¿¡æ¯">Spring Secutityä¸­çš„ç”¨æˆ·ä¿¡æ¯</a></li>
                    <li>
                        <a href="#%e5%85%b3%e4%ba%8e%e5%8a%a0%e5%af%86" aria-label="å…³äºåŠ å¯†">å…³äºåŠ å¯†</a></li>
                    <li>
                        <a href="#spring-security%e7%9a%84%e9%85%8d%e7%bd%ae" aria-label="Spring Securityçš„é…ç½®">Spring Securityçš„é…ç½®</a></li>
                    <li>
                        <a href="#%e8%ae%a4%e8%af%81%e6%b5%81%e7%a8%8b%e5%9b%be" aria-label="è®¤è¯æµç¨‹å›¾">è®¤è¯æµç¨‹å›¾</a><ul>
                            
                    <li>
                        <a href="#%e7%99%bb%e9%99%86%e6%a0%a1%e9%aa%8c%e6%b5%81%e7%a8%8b" aria-label="ç™»é™†æ ¡éªŒæµç¨‹">ç™»é™†æ ¡éªŒæµç¨‹</a></li>
                    <li>
                        <a href="#springsecurity%e5%ae%8c%e6%95%b4%e6%b5%81%e7%a8%8b" aria-label="SpringSecurityå®Œæ•´æµç¨‹">SpringSecurityå®Œæ•´æµç¨‹</a></li>
                    <li>
                        <a href="#%e8%ae%a4%e8%af%81%e6%b5%81%e7%a8%8b%e8%af%a6%e8%a7%a3" aria-label="è®¤è¯æµç¨‹è¯¦è§£">è®¤è¯æµç¨‹è¯¦è§£</a></li>
                    <li>
                        <a href="#%e8%ae%a4%e8%af%81%e8%bf%87%e7%a8%8b" aria-label="è®¤è¯è¿‡ç¨‹">è®¤è¯è¿‡ç¨‹</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e6%8e%88%e6%9d%83" aria-label="æˆæƒ">æˆæƒ</a><ul>
                            
                    <li>
                        <a href="#%e6%9d%83%e9%99%90%e6%8e%a7%e5%88%b6%e9%85%8d%e7%bd%ae" aria-label="æƒé™æ§åˆ¶é…ç½®">æƒé™æ§åˆ¶é…ç½®</a></li>
                    <li>
                        <a href="#%e6%8e%88%e6%9d%83%e5%9f%ba%e6%9c%ac%e6%b5%81%e7%a8%8b" aria-label="æˆæƒåŸºæœ¬æµç¨‹">æˆæƒåŸºæœ¬æµç¨‹</a></li>
                    <li>
                        <a href="#rbac%e6%9d%83%e9%99%90%e6%a8%a1%e5%9e%8b" aria-label="RBACæƒé™æ¨¡å‹">RBACæƒé™æ¨¡å‹</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#%e7%99%bb%e5%bd%95%e5%ae%9e%e7%8e%b0" aria-label="ç™»å½•å®ç°">ç™»å½•å®ç°</a><ul>
                            
                    <li>
                        <a href="#1%e5%bc%95%e5%85%a5-spring-security-%e6%a8%a1%e5%9d%97" aria-label="1.å¼•å…¥ Spring Security æ¨¡å—">1.å¼•å…¥ Spring Security æ¨¡å—</a></li>
                    <li>
                        <a href="#2%e7%bc%96%e5%86%99-spring-security-%e9%85%8d%e7%bd%ae%e7%b1%bb" aria-label="2.ç¼–å†™ Spring Security é…ç½®ç±»">2.ç¼–å†™ Spring Security é…ç½®ç±»</a></li>
                    <li>
                        <a href="#3%e9%85%8d%e7%bd%ae%e7%b1%bb%e7%9b%b8%e5%85%b3%e6%a8%a1%e5%9d%97" aria-label="3.é…ç½®ç±»ç›¸å…³æ¨¡å—">3.é…ç½®ç±»ç›¸å…³æ¨¡å—</a></li>
                    <li>
                        <a href="#4%e7%99%bb%e5%bd%95%e6%a8%a1%e5%9d%97" aria-label="4.ç™»å½•æ¨¡å—">4.ç™»å½•æ¨¡å—</a></li>
                    <li>
                        <a href="#5%e7%99%bb%e5%87%ba%e6%a8%a1%e5%9d%97" aria-label="5.ç™»å‡ºæ¨¡å—">5.ç™»å‡ºæ¨¡å—</a></li>
                    <li>
                        <a href="#6%e6%b3%a8%e5%86%8c%e6%a8%a1%e5%9d%97" aria-label="6.æ³¨å†Œæ¨¡å—">6.æ³¨å†Œæ¨¡å—</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e6%8e%88%e6%9d%83%e5%ae%9e%e7%8e%b0" aria-label="æˆæƒå®ç°">æˆæƒå®ç°</a><ul>
                            
                    <li>
                        <a href="#1%e5%88%9b%e5%bb%ba%e6%95%b0%e6%8d%ae%e5%ba%93%e8%a1%a8" aria-label="1.åˆ›å»ºæ•°æ®åº“è¡¨">1.åˆ›å»ºæ•°æ®åº“è¡¨</a></li>
                    <li>
                        <a href="#2%e6%9d%83%e9%99%90%e8%bf%87%e6%bb%a4%e5%99%a8" aria-label="2.æƒé™è¿‡æ»¤å™¨">2.æƒé™è¿‡æ»¤å™¨</a></li>
                    <li>
                        <a href="#3%e7%99%bb%e5%bd%95%e6%97%b6%e6%9d%83%e9%99%90%e8%b5%8b%e5%80%bc" aria-label="3.ç™»å½•æ—¶æƒé™èµ‹å€¼">3.ç™»å½•æ—¶æƒé™èµ‹å€¼</a></li>
                    <li>
                        <a href="#4%e6%9d%83%e9%99%90%e6%9f%a5%e8%af%a2mapper" aria-label="4.æƒé™æŸ¥è¯¢Mapper">4.æƒé™æŸ¥è¯¢Mapper</a></li>
                    <li>
                        <a href="#5%e8%87%aa%e5%ae%9a%e4%b9%89%e6%9d%83%e9%99%90%e6%96%b9%e6%b3%95" aria-label="5.è‡ªå®šä¹‰æƒé™æ–¹æ³•">5.è‡ªå®šä¹‰æƒé™æ–¹æ³•</a></li>
                    <li>
                        <a href="#6%e6%8e%a5%e5%8f%a3%e5%ae%9e%e7%8e%b0" aria-label="6.æ¥å£å®ç°">6.æ¥å£å®ç°</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>
  <div class="post-content"><blockquote>
<p>å‚è€ƒé“¾æ¥ï¼š</p>
<p><a href="https://blog.csdn.net/liuminglei1987/category_10122574.html">https://blog.csdn.net/liuminglei1987/category_10122574.html</a></p>
<p><a href="https://blog.csdn.net/qq_37132495/article/details/116274034">ä»é›¶æ­å»ºè‹¥ä¾(Ruoyi-Vue)ç®¡ç†ç³»ç»Ÿ(10)&ndash;Spring Securityæ ¸å¿ƒå†…å®¹æ¢³ç†</a></p>
<p><a href="https://blog.csdn.net/weixin_43847283/article/details/124075302">SpringSecurity-ä»å…¥é—¨åˆ°ç²¾é€š</a></p>
</blockquote>
<h2 id="è®¤è¯†springsecurity">è®¤è¯†SpringSecurity<a hidden class="anchor" aria-hidden="true" href="#è®¤è¯†springsecurity">#</a></h2>
<p>Spring Security æ˜¯é’ˆå¯¹Springé¡¹ç›®çš„å®‰å…¨æ¡†æ¶ï¼Œä¹Ÿæ˜¯Spring Bootåº•å±‚å®‰å…¨æ¨¡å—é»˜è®¤çš„æŠ€æœ¯é€‰å‹ï¼Œä»–å¯ä»¥å®ç°å¼ºå¤§çš„Webå®‰å…¨æ§åˆ¶ï¼Œå¯¹äºå®‰å…¨æ§åˆ¶ï¼Œæˆ‘ä»¬ä»…éœ€è¦å¼•å…¥ spring-boot-starter-security æ¨¡å—ï¼Œè¿›è¡Œå°‘é‡çš„é…ç½®ï¼Œå³å¯å®ç°å¼ºå¤§çš„å®‰å…¨ç®¡ç†ï¼</p>
<p>è®°ä½å‡ ä¸ªç±»ï¼š</p>
<ul>
<li>WebSecurityConfigurerAdapterï¼šè‡ªå®šä¹‰Securityç­–ç•¥</li>
<li>AuthenticationManagerBuilderï¼šè‡ªå®šä¹‰è®¤è¯ç­–ç•¥</li>
<li>@EnableWebSecurityï¼šå¼€å¯WebSecurityæ¨¡å¼</li>
</ul>
<p>Spring Securityçš„ä¸¤ä¸ªä¸»è¦ç›®æ ‡æ˜¯ â€œè®¤è¯â€ å’Œ â€œæˆæƒâ€ï¼ˆè®¿é—®æ§åˆ¶ï¼‰ã€‚</p>
<p><strong>â€œè®¤è¯â€ï¼ˆAuthenticationï¼‰</strong></p>
<p>èº«ä»½éªŒè¯æ˜¯å…³äºéªŒè¯æ‚¨çš„å‡­æ®ï¼Œå¦‚ç”¨æˆ·å/ç”¨æˆ·IDå’Œå¯†ç ï¼Œä»¥éªŒè¯æ‚¨çš„èº«ä»½ã€‚</p>
<p>èº«ä»½éªŒè¯é€šå¸¸é€šè¿‡ç”¨æˆ·åå’Œå¯†ç å®Œæˆï¼Œæœ‰æ—¶ä¸èº«ä»½éªŒè¯å› ç´ ç»“åˆä½¿ç”¨ã€‚</p>
<p><strong>â€œæˆæƒâ€ ï¼ˆAuthorizationï¼‰</strong></p>
<p>æˆæƒå‘ç”Ÿåœ¨ç³»ç»ŸæˆåŠŸéªŒè¯æ‚¨çš„èº«ä»½åï¼Œæœ€ç»ˆä¼šæˆäºˆæ‚¨è®¿é—®èµ„æºï¼ˆå¦‚ä¿¡æ¯ï¼Œæ–‡ä»¶ï¼Œæ•°æ®åº“ï¼Œèµ„é‡‘ï¼Œä½ç½®ï¼Œå‡ ä¹ä»»ä½•å†…å®¹ï¼‰çš„å®Œå…¨æƒé™ã€‚</p>
<p>è¿™ä¸ªæ¦‚å¿µæ˜¯é€šç”¨çš„ï¼Œè€Œä¸æ˜¯åªåœ¨Spring Security ä¸­å­˜åœ¨ã€‚</p>
<h2 id="spring-secutityæ ¸å¿ƒå†…å®¹">Spring Secutityæ ¸å¿ƒå†…å®¹<a hidden class="anchor" aria-hidden="true" href="#spring-secutityæ ¸å¿ƒå†…å®¹">#</a></h2>
<h3 id="spring-secutityä¸­çš„ç”¨æˆ·ä¿¡æ¯">Spring Secutityä¸­çš„ç”¨æˆ·ä¿¡æ¯<a hidden class="anchor" aria-hidden="true" href="#spring-secutityä¸­çš„ç”¨æˆ·ä¿¡æ¯">#</a></h3>
<p>1.<code>UserDetailsService</code>ï¼š</p>
<p>è¯¥æ–¹æ³•å¾ˆå®¹æ˜“ç†è§£ï¼š <strong>é€šè¿‡ç”¨æˆ·åæ¥åŠ è½½ç”¨æˆ·</strong> ã€‚è¿™ä¸ªæ–¹æ³•ä¸»è¦ç”¨äºä»ç³»ç»Ÿæ•°æ®ä¸­æŸ¥è¯¢å¹¶åŠ è½½å…·ä½“çš„ç”¨æˆ·åˆ° Spring Securityä¸­ã€‚</p>
<p><strong>åœ¨å¼€å‘ä¸­æˆ‘ä»¬ä¸€èˆ¬å®šä¹‰ä¸€ä¸ªè¿™ä¸ªæ¥å£çš„å®ç°ç±»ï¼Œè‡ªå®šä¹‰loadUserByUsernameæ–¹æ³•ï¼Œå®ç°ä»æ•°æ®æºè·å–ç”¨æˆ·ï¼ŒåŠ è½½ç”¨æˆ·ä¿¡æ¯ã€‚ä¹Ÿå¯ä»¥åœ¨å…¶ä¸­å®ç°ä¸€äº›æ ¡éªŒç”¨æˆ·é€»è¾‘ã€‚</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Service</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserDetailsServiceImpl</span> <span class="kd">implements</span> <span class="n">UserDetailsService</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">UsernameNotFoundException</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>2.<code>UserDetails</code>:</p>
<p>ä»ä¸Šé¢ <code>UserDetailsService</code> å¯ä»¥çŸ¥é“æœ€ç»ˆäº¤ç»™Spring Securityçš„æ˜¯<code>UserDetails</code> ã€‚è¯¥æ¥å£æ˜¯æä¾›ç”¨æˆ·ä¿¡æ¯çš„æ ¸å¿ƒæ¥å£ã€‚è¯¥æ¥å£å®ç°ä»…ä»…å­˜å‚¨ç”¨æˆ·çš„ä¿¡æ¯ã€‚åç»­ä¼šå°†è¯¥æ¥å£æä¾›çš„ç”¨æˆ·ä¿¡æ¯å°è£…åˆ°è®¤è¯å¯¹è±¡<code>Authentication</code> ä¸­å»ã€‚</p>
<p><code>UserDetails</code>ä¸­é»˜è®¤æä¾›ï¼š</p>
<ul>
<li>ç”¨æˆ·çš„æƒé™é›†ï¼Œ é»˜è®¤éœ€è¦æ·»åŠ  ROLE_ å‰ç¼€</li>
<li>ç”¨æˆ·çš„åŠ å¯†åçš„å¯†ç ï¼Œ ä¸åŠ å¯†ä¼šä½¿ç”¨ {noop} å‰ç¼€</li>
<li>åº”ç”¨å†…å”¯ä¸€çš„ç”¨æˆ·å</li>
<li>è´¦æˆ·æ˜¯å¦è¿‡æœŸ</li>
<li>è´¦æˆ·æ˜¯å¦é”å®š</li>
<li>å‡­è¯æ˜¯å¦è¿‡æœŸ</li>
<li>ç”¨æˆ·æ˜¯å¦å¯ç”¨</li>
</ul>
<p><strong>åœ¨æˆ‘ä»¬è‡ªå·±çš„é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬è¦å®šä¹‰ä¸ªç”¨æˆ·ç±»å®ç°è¯¥æ¥å£ï¼Œåœ¨è¯¥ç”¨æˆ·ç±»ä¸­æˆ‘ä»¬å¯ä»¥æ‰©å±•æ›´å¤šçš„ç”¨æˆ·ä¿¡æ¯ï¼Œæ¯”å¦‚æ‰‹æœºã€é‚®ç®±ç­‰ç­‰</strong></p>
<p>3.<code>UserDetailsServiceAutoConfiguration</code></p>
<h3 id="å…³äºåŠ å¯†">å…³äºåŠ å¯†<a hidden class="anchor" aria-hidden="true" href="#å…³äºåŠ å¯†">#</a></h3>
<p>ä»»ä½•åº”ç”¨è€ƒè™‘åˆ°å®‰å…¨ï¼Œç»ä¸èƒ½æ˜æ–‡çš„æ–¹å¼ä¿å­˜å¯†ç åˆ°æ•°æ®åº“ã€‚å¯†ç åº”è¯¥é€šè¿‡å“ˆå¸Œç®—æ³•è¿›è¡ŒåŠ å¯†ã€‚</p>
<p>æœ‰å¾ˆå¤šæ ‡å‡†çš„ç®—æ³•æ¯”å¦‚SHAæˆ–è€…MD5ï¼Œç»“åˆsalt(ç›)æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚</p>
<p>Spring Securityæä¾›BCryptPasswordEncoderç±»,å®ç°Springçš„PasswordEncoderæ¥å£ä½¿ç”¨BCryptå¼ºå“ˆå¸Œæ–¹æ³•æ¥åŠ å¯†å¯†ç ã€‚BCryptå¼ºå“ˆå¸Œæ–¹æ³• æ¯æ¬¡åŠ å¯†çš„ç»“æœéƒ½ä¸ä¸€æ ·æ—¢ç„¶æ¯æ¬¡åŠ å¯†ç»“æœä¸ä¸€æ ·ï¼Œå°±ä¸å¯ä»¥é€šè¿‡ç›¸åŒå­—ç¬¦ä¸²åŠ å¯†åçš„ç»“æœæ¥åˆ¤å®šæ˜¯ä¸æ˜¯åŒä¸€ä¸ªå­—ç¬¦ä¸²äº†ï¼Œè¿™å°±æ›´åŠ å¢å¼ºäº†å®‰å…¨æ€§ã€‚</p>
<p>å¦‚æœéœ€è¦åˆ¤æ–­æ˜¯å¦æ˜¯åŸæ¥çš„å¯†ç ï¼Œéœ€è¦ç”¨å®ƒè‡ªå¸¦çš„æ–¹æ³•ã€‚</p>
<p><strong>åŠ å¯†ï¼š</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">BCryptPasswordEncoder</span> <span class="n">encode</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BCryptPasswordEncoder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">encode</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">password</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>åˆ¤æ–­ï¼š</strong></p>
<p>éœ€è¦é€šè¿‡è‡ªå¸¦çš„æ–¹æ³• matches å°†æœªç»è¿‡åŠ å¯†çš„å¯†ç å’Œå·²ç»è¿‡åŠ å¯†çš„å¯†ç ä¼ è¿›å»è¿›è¡Œåˆ¤æ–­ï¼Œè¿”å›å¸ƒå°”å€¼ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">encode</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="n">oldpassword</span><span class="o">,</span><span class="n">user1</span><span class="o">.</span><span class="na">getPassword</span><span class="o">());</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="spring-securityçš„é…ç½®">Spring Securityçš„é…ç½®<a hidden class="anchor" aria-hidden="true" href="#spring-securityçš„é…ç½®">#</a></h3>
<p>è‡ªå®šä¹‰<code>SecurityConfig</code></p>
<p>é¦–å…ˆè¦ç»§æ‰¿<code>WebSecurityConfigurerAdapter</code>ï¼Œå…¶æ¬¡æœ€å¸¸ç”¨çš„æ˜¯å®ç°<code>configure(AuthenticationManagerBuilder auth)</code>ã€<code>configure(WebSecurity web)</code>ã€<code>configure(HttpSecurity http)</code>ä¸‰ä¸ªæ–¹æ³•å®ç°æˆ‘ä»¬å¯¹Spring Securityçš„è‡ªå®šä¹‰å®‰å…¨é…ç½®ã€‚</p>
<ul>
<li><code>void configure(AuthenticationManagerBuilder auth) </code>ç”¨æ¥é…ç½®è®¤è¯ç®¡ç†å™¨ <code>AuthenticationManager</code>ã€‚</li>
<li><code>void configure(WebSecurity web)</code>ç”¨æ¥é…ç½® <code>WebSecurity</code> ã€‚è€Œ <code>WebSecurity</code>æ˜¯åŸºäºServlet Filterç”¨æ¥é…ç½® <code>springSecurityFilterChain</code>ã€‚è€Œ <code>springSecurityFilterChain</code> åˆè¢«å§”æ‰˜ç»™äº† Spring Security æ ¸å¿ƒè¿‡æ»¤å™¨ Bean <code>DelegatingFilterProxy</code> ã€‚ ç›¸å…³é€»è¾‘ä½ å¯ä»¥åœ¨ <code>WebSecurityConfiguration</code> ä¸­æ‰¾åˆ°ã€‚æˆ‘ä»¬ä¸€èˆ¬ä¸ä¼šè¿‡å¤šæ¥è‡ªå®šä¹‰ <code>WebSecurity</code> , ä½¿ç”¨è¾ƒå¤šçš„ä½¿å…¶ <code>ignoring()</code> æ–¹æ³•ç”¨æ¥å¿½ç•¥ Spring Security å¯¹é™æ€èµ„æºçš„æ§åˆ¶ã€‚</li>
<li><code>void configure(HttpSecurity http)</code> è¿™ä¸ªæ˜¯æˆ‘ä»¬ä½¿ç”¨æœ€å¤šçš„ï¼Œç”¨æ¥é…ç½® <code>HttpSecurity</code> ã€‚ <code>HttpSecurity</code>ç”¨äºæ„å»ºä¸€ä¸ªå®‰å…¨è¿‡æ»¤å™¨é“¾ <code>SecurityFilterChain</code>ã€‚ <code>SecurityFilterChain</code> æœ€ç»ˆè¢«æ³¨å…¥æ ¸å¿ƒè¿‡æ»¤å™¨ ã€‚<code>HttpSecurity</code>æœ‰è®¸å¤šæˆ‘ä»¬éœ€è¦çš„é…ç½®ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒæ¥è¿›è¡Œè‡ªå®šä¹‰å®‰å…¨è®¿é—®ç­–ç•¥ã€‚</li>
</ul>
<h3 id="è®¤è¯æµç¨‹å›¾">è®¤è¯æµç¨‹å›¾<a hidden class="anchor" aria-hidden="true" href="#è®¤è¯æµç¨‹å›¾">#</a></h3>
<h4 id="ç™»é™†æ ¡éªŒæµç¨‹">ç™»é™†æ ¡éªŒæµç¨‹<a hidden class="anchor" aria-hidden="true" href="#ç™»é™†æ ¡éªŒæµç¨‹">#</a></h4>
<img src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202307252346782.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:67%;" /> 
<h4 id="springsecurityå®Œæ•´æµç¨‹">SpringSecurityå®Œæ•´æµç¨‹<a hidden class="anchor" aria-hidden="true" href="#springsecurityå®Œæ•´æµç¨‹">#</a></h4>
<p>SpringSecurityçš„åŸç†å…¶å®å°±æ˜¯ä¸€ä¸ªè¿‡æ»¤å™¨é“¾ï¼Œå†…éƒ¨åŒ…å«äº†æä¾›å„ç§åŠŸèƒ½çš„è¿‡æ»¤å™¨ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹å…¥é—¨æ¡ˆä¾‹ä¸­çš„è¿‡æ»¤å™¨ã€‚</p>
<img src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202307252346833.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:67%;" /> 
<p>å›¾ä¸­åªå±•ç¤ºäº†æ ¸å¿ƒè¿‡æ»¤å™¨ï¼Œå…¶å®ƒçš„éæ ¸å¿ƒè¿‡æ»¤å™¨å¹¶æ²¡æœ‰åœ¨å›¾ä¸­å±•ç¤ºã€‚</p>
<p><code>UsernamePasswordAuthenticationFilter</code>ï¼šè´Ÿè´£å¤„ç†æˆ‘ä»¬åœ¨ç™»é™†é¡µé¢å¡«å†™äº†ç”¨æˆ·åå¯†ç åçš„ç™»é™†è¯·æ±‚ã€‚å…¥é—¨æ¡ˆä¾‹çš„è®¤è¯å·¥ä½œä¸»è¦æœ‰å®ƒè´Ÿè´£ã€‚</p>
<p><code>ExceptionTranslationFilter</code>ï¼š å¤„ç†è¿‡æ»¤å™¨é“¾ä¸­æŠ›å‡ºçš„ä»»ä½•AccessDeniedExceptionå’ŒAuthenticationException ã€‚</p>
<p><code>FilterSecurityInterceptor</code>ï¼š è´Ÿè´£æƒé™æ ¡éªŒçš„è¿‡æ»¤å™¨ã€‚</p>
<h4 id="è®¤è¯æµç¨‹è¯¦è§£">è®¤è¯æµç¨‹è¯¦è§£<a hidden class="anchor" aria-hidden="true" href="#è®¤è¯æµç¨‹è¯¦è§£">#</a></h4>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202307252346849.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"  />
</p>
<p>æ¦‚å¿µé€ŸæŸ¥:</p>
<p>Authenticationæ¥å£: å®ƒçš„å®ç°ç±»ï¼Œè¡¨ç¤ºå½“å‰è®¿é—®ç³»ç»Ÿçš„ç”¨æˆ·ï¼Œå°è£…äº†ç”¨æˆ·ç›¸å…³ä¿¡æ¯ã€‚</p>
<p>AuthenticationManageræ¥å£ï¼šå®šä¹‰äº†è®¤è¯Authenticationçš„æ–¹æ³•</p>
<p>UserDetailsServiceæ¥å£ï¼šåŠ è½½ç”¨æˆ·ç‰¹å®šæ•°æ®çš„æ ¸å¿ƒæ¥å£ã€‚é‡Œé¢å®šä¹‰äº†ä¸€ä¸ªæ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯çš„æ–¹æ³•ã€‚</p>
<p>UserDetailsæ¥å£ï¼šæä¾›æ ¸å¿ƒç”¨æˆ·ä¿¡æ¯ã€‚é€šè¿‡UserDetailsServiceæ ¹æ®ç”¨æˆ·åè·å–å¤„ç†çš„ç”¨æˆ·ä¿¡æ¯è¦å°è£…æˆUserDetailså¯¹è±¡è¿”å›ã€‚ç„¶åå°†è¿™äº›ä¿¡æ¯å°è£…åˆ°Authenticationå¯¹è±¡ä¸­ã€‚</p>
<h4 id="è®¤è¯è¿‡ç¨‹">è®¤è¯è¿‡ç¨‹<a hidden class="anchor" aria-hidden="true" href="#è®¤è¯è¿‡ç¨‹">#</a></h4>
<p>è®¤è¯è¿‡æ»¤å™¨<code>UsernamePasswordAuthenticationFilter</code>:å®ƒçš„ä½œç”¨æ˜¯æ‹¦æˆªç™»å½•è¯·æ±‚å¹¶è·å–è´¦å·å’Œ å¯†ç ï¼Œç„¶åæŠŠè´¦å·å¯†ç å°è£…åˆ°è®¤è¯å‡­æ® <code>UsernamePasswordAuthenticationToken</code> ä¸­ï¼Œç„¶åæŠŠå‡­æ®äº¤ ç»™ç‰¹å®šé…ç½®çš„ <code>AuthenticationManager</code>å»ä½œè®¤è¯ã€‚</p>
<img src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202307252346910.png" alt="image-20210312074036145" style="zoom: 80%;" /> 
<h3 id="æˆæƒ">æˆæƒ<a hidden class="anchor" aria-hidden="true" href="#æˆæƒ">#</a></h3>
<h4 id="æƒé™æ§åˆ¶é…ç½®">æƒé™æ§åˆ¶é…ç½®<a hidden class="anchor" aria-hidden="true" href="#æƒé™æ§åˆ¶é…ç½®">#</a></h4>
<p><strong>ä¸€ã€åŸºäºé…ç½®è¡¨è¾¾å¼æ§åˆ¶ URL è·¯å¾„</strong></p>
<p>åœ¨ç»§æ‰¿<code>WebSecurityConfigurerAdapter</code>çš„é…ç½®ç±»ä¸­çš„<code>configure(HttpSecurity http)</code>ä¸­è¿›è¡Œé…ç½®ã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">&#34;/admin/**&#34;</span><span class="o">).</span><span class="na">hasRole</span><span class="o">(</span><span class="s">&#34;admin&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">&#34;/user/**&#34;</span><span class="o">).</span><span class="na">hasAnyRole</span><span class="o">(</span><span class="s">&#34;admin&#34;</span><span class="o">,</span> <span class="s">&#34;user&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">and</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">            <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¸¸ç”¨çš„é…ç½®å¯é€‰é¡¹ï¼š</p>
<img src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202307252346802.png" alt="image-20220901105205311"  /> 
<p><strong>äºŒã€åŸºäºæ³¨è§£çš„æ¥å£æƒé™æ§åˆ¶</strong></p>
<p>æˆ‘ä»¬å¯ä»¥åœ¨ä»»ä½• <code>@Configuration</code>å®ä¾‹ä¸Šä½¿ç”¨ <code>@EnableGlobalMethodSecurity</code>æ³¨è§£æ¥å¯ç”¨å…¨å±€æ–¹ æ³•å®‰å…¨æ³¨è§£åŠŸèƒ½</p>
<p>ä¾‹å¦‚ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableGlobalMethodSecurity</span><span class="o">(</span><span class="n">prePostEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span><span class="n">securedEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span><span class="n">jsr250Enabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>è®¾ç½® <code>prePostEnabled</code>ä¸º true ï¼Œåˆ™å¼€å¯äº†åŸºäºè¡¨è¾¾å¼ çš„æ–¹æ³•å®‰å…¨æ§åˆ¶ã€‚</li>
</ul>
<p>è¿™ä¸ªé…ç½®å¼€å¯äº†å››ä¸ªæ³¨è§£ï¼Œåˆ†åˆ«æ˜¯ï¼š</p>
<ol>
<li><code>@PreAuthorize</code>ï¼šåœ¨æ ‡è®°çš„æ–¹æ³•è°ƒç”¨ä¹‹å‰ï¼Œé€šè¿‡è¡¨è¾¾å¼æ¥è®¡ç®—æ˜¯å¦å¯ä»¥æˆæƒè®¿é—®ã€‚</li>
<li><code>@PostAuthorize</code>ï¼šåœ¨æ ‡è®°çš„æ–¹æ³•è°ƒç”¨ä¹‹åï¼Œé€šè¿‡è¡¨è¾¾å¼æ¥è®¡ç®—æ˜¯å¦å¯ä»¥æˆæƒè®¿é—®ã€‚è¯¥æ³¨è§£æ˜¯é’ˆå¯¹<code>@PreAuthorize</code> ã€‚åŒºåˆ« åœ¨äºå…ˆæ‰§è¡Œæ–¹æ³•ã€‚è€Œåè¿›è¡Œè¡¨è¾¾å¼åˆ¤æ–­ã€‚å¦‚æœæ–¹æ³•æ²¡æœ‰è¿”å›å€¼å®é™…ä¸Šç­‰äºå¼€æ”¾æƒé™æ§åˆ¶ï¼›å¦‚æœæœ‰è¿”å›å€¼ å®é™…çš„ç»“æœæ˜¯ç”¨æˆ·æ“ä½œæˆåŠŸä½†æ˜¯å¾—ä¸åˆ°å“åº”ã€‚</li>
<li><code>@PreFilter</code>:åŸºäºæ–¹æ³•å…¥å‚ç›¸å…³çš„è¡¨è¾¾å¼ï¼Œå¯¹å…¥å‚è¿›è¡Œè¿‡æ»¤ã€‚</li>
<li><code>@PostFilter</code>:å’Œ <code>@PreFilter</code>ä¸åŒçš„æ˜¯ï¼Œ åŸºäºè¿”å›å€¼ç›¸å…³çš„è¡¨è¾¾å¼ï¼Œå¯¹è¿”å›å€¼è¿›è¡Œè¿‡æ»¤ã€‚åˆ†é¡µæ…ç”¨ï¼ è¯¥è¿‡ç¨‹å‘ç”Ÿæ¥å£è¿›è¡Œæ•°æ®è¿”å›ä¹‹å‰ã€‚</li>
</ol>
<ul>
<li>
<p>è®¾ç½®<code>securedEnabled</code> ä¸º true ï¼Œå°±å¼€å¯äº†è§’è‰²æ³¨è§£<code>@Secured</code> ï¼Œè¯¥æ³¨è§£åŠŸèƒ½è¦ç®€å•çš„å¤šï¼Œé»˜è®¤æƒ…å†µä¸‹åªèƒ½åŸºäºè§’è‰²ï¼ˆé»˜è®¤éœ€è¦å¸¦å‰ç¼€ ROLE_ ï¼‰é›†åˆæ¥è¿›è¡Œè®¿é—®æ§åˆ¶å†³ç­–ã€‚</p>
<p>è¯¥æ³¨è§£çš„æœºåˆ¶æ˜¯åªè¦å…¶å£°æ˜çš„è§’è‰²é›†åˆ(value )ä¸­åŒ…å«å½“å‰ç”¨æˆ·æŒæœ‰çš„ä»»ä¸€è§’è‰²å°±å¯ä»¥è®¿é—®ã€‚ä¹Ÿå°±æ˜¯ ç”¨æˆ·çš„è§’è‰²é›†åˆå’Œ<code>@Secured</code>æ³¨è§£çš„è§’è‰²é›†åˆè¦å­˜åœ¨éç©ºçš„äº¤é›†ã€‚ ä¸æ”¯æŒä½¿ç”¨ <code>SpEL</code>è¡¨è¾¾å¼è¿›è¡Œå†³ç­–ã€‚</p>
</li>
<li>
<p>è®¾ç½® <code>jsr250Enabled</code>ä¸º true ï¼Œå°±å¼€å¯äº† JavaEE å®‰å…¨ æ³¨è§£ä¸­çš„ä»¥ä¸‹ä¸‰ä¸ªï¼š</p>
</li>
</ul>
<ol>
<li><code>@DenyAll</code> æ‹’ç»æ‰€æœ‰çš„è®¿é—®</li>
<li><code>@PermitAll</code> åŒæ„æ‰€æœ‰çš„è®¿é—®</li>
<li><code>@RolesAllowed</code> ç”¨æ³•å’Œ<code>@Secured</code> ä¸€æ ·ã€‚</li>
</ol>
<p>==<strong>åŸºäºæ³¨è§£çš„æƒé™æ§åˆ¶ä¸¤ç§å®ç°æ–¹å¼ï¼š</strong>==</p>
<p>**ç¬¬ä¸€ç§ï¼š**ä½¿ç”¨<code>spring security</code>è‡ªå¸¦çš„æ³¨è§£</p>
<p><code>@PreAuthorize(&quot;hasAnyAuthority('admin','test','system:dept:list')&quot;)</code></p>
<blockquote>
<p>hasRoleè¦æ±‚æœ‰å¯¹åº”çš„è§’è‰²æ‰å¯ä»¥è®¿é—®ï¼Œä½†æ˜¯å®ƒå†…éƒ¨ä¼šæŠŠæˆ‘ä»¬ä¼ å…¥çš„å‚æ•°æ‹¼æ¥ä¸Š <strong>ROLE_</strong> åå†å»æ¯”è¾ƒã€‚æ‰€ä»¥è¿™ç§æƒ…å†µä¸‹è¦ç”¨ç”¨æˆ·å¯¹åº”çš„æƒé™ä¹Ÿè¦æœ‰ <strong>ROLE_</strong> è¿™ä¸ªå‰ç¼€æ‰å¯ä»¥ã€‚</p>
</blockquote>
<p><strong>ç¬¬äºŒç§ï¼šè‡ªå®šä¹‰æƒé™æ ¡éªŒæ–¹æ³•</strong></p>
<p>åœ¨@PreAuthorizeæ³¨è§£ä¸­ä½¿ç”¨æˆ‘ä»¬çš„æ–¹æ³•</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@PreAuthorize</span><span class="o">(</span><span class="s">&#34;@ss.hasPermi(&#39;system:menu:list&#39;)&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/list&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">AjaxResult</span> <span class="nf">list</span><span class="o">(</span><span class="n">SysMenu</span> <span class="n">menu</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">SysMenu</span><span class="o">&gt;</span> <span class="n">menus</span> <span class="o">=</span> <span class="n">menuService</span><span class="o">.</span><span class="na">selectMenuList</span><span class="o">(</span><span class="n">menu</span><span class="o">,</span> <span class="n">getUserId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">AjaxResult</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="n">menus</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * éªŒè¯ç”¨æˆ·æ˜¯å¦å…·å¤‡æŸæƒé™
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param permission æƒé™å­—ç¬¦ä¸²
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return ç”¨æˆ·æ˜¯å¦å…·å¤‡æŸæƒé™
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasPermi</span><span class="o">(</span><span class="n">String</span> <span class="n">permission</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">permission</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">LoginUser</span> <span class="n">loginUser</span> <span class="o">=</span> <span class="n">SecurityUtils</span><span class="o">.</span><span class="na">getLoginUser</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isNull</span><span class="o">(</span><span class="n">loginUser</span><span class="o">)</span> <span class="o">||</span> <span class="n">CollectionUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">loginUser</span><span class="o">.</span><span class="na">getPermissions</span><span class="o">()))</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">hasPermissions</span><span class="o">(</span><span class="n">loginUser</span><span class="o">.</span><span class="na">getPermissions</span><span class="o">(),</span> <span class="n">permission</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="æˆæƒåŸºæœ¬æµç¨‹">æˆæƒåŸºæœ¬æµç¨‹<a hidden class="anchor" aria-hidden="true" href="#æˆæƒåŸºæœ¬æµç¨‹">#</a></h4>
<p>åœ¨SpringSecurityä¸­ï¼Œä¼šä½¿ç”¨é»˜è®¤çš„FilterSecurityInterceptoræ¥è¿›è¡Œæƒé™æ ¡éªŒã€‚åœ¨<code>FilterSecurityInterceptor</code>ä¸­ä¼šä»<code>SecurityContextHolder</code>è·å–å…¶ä¸­çš„<code>Authentication</code>ï¼Œç„¶åè·å–å…¶ä¸­çš„æƒé™ä¿¡æ¯ã€‚å½“å‰ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰è®¿é—®å½“å‰èµ„æºæ‰€éœ€çš„æƒé™ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­åªéœ€è¦æŠŠå½“å‰ç™»å½•ç”¨æˆ·çš„æƒé™ä¿¡æ¯ä¹Ÿå­˜å…¥<code>Authentication</code>ã€‚</p>
<p>ç„¶åè®¾ç½®æˆ‘ä»¬çš„èµ„æºæ‰€éœ€è¦çš„æƒé™å³å¯ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * éªŒè¯ç”¨æˆ·æ˜¯å¦å…·å¤‡æŸæƒé™
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param permission æƒé™å­—ç¬¦ä¸²
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return ç”¨æˆ·æ˜¯å¦å…·å¤‡æŸæƒé™
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasPermi</span><span class="o">(</span><span class="n">String</span> <span class="n">permission</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">permission</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">LoginUser</span> <span class="n">loginUser</span> <span class="o">=</span> <span class="n">SecurityUtils</span><span class="o">.</span><span class="na">getLoginUser</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isNull</span><span class="o">(</span><span class="n">loginUser</span><span class="o">)</span> <span class="o">||</span> <span class="n">CollectionUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">loginUser</span><span class="o">.</span><span class="na">getPermissions</span><span class="o">()))</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">hasPermissions</span><span class="o">(</span><span class="n">loginUser</span><span class="o">.</span><span class="na">getPermissions</span><span class="o">(),</span> <span class="n">permission</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * è·å–ç”¨æˆ·
</span></span></span><span class="line"><span class="cl"><span class="cm"> **/</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">LoginUser</span> <span class="nf">getLoginUser</span><span class="o">()</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">(</span><span class="n">LoginUser</span><span class="o">)</span> <span class="n">getAuthentication</span><span class="o">().</span><span class="na">getPrincipal</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">ServiceException</span><span class="o">(</span><span class="s">&#34;è·å–ç”¨æˆ·ä¿¡æ¯å¼‚å¸¸&#34;</span><span class="o">,</span> <span class="n">HttpStatus</span><span class="o">.</span><span class="na">UNAUTHORIZED</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="rbacæƒé™æ¨¡å‹">RBACæƒé™æ¨¡å‹<a hidden class="anchor" aria-hidden="true" href="#rbacæƒé™æ¨¡å‹">#</a></h4>
<p>RBACæƒé™æ¨¡å‹ï¼ˆRole-Based Access Controlï¼‰å³ï¼šåŸºäºè§’è‰²çš„æƒé™æ§åˆ¶ã€‚è¿™æ˜¯ç›®å‰æœ€å¸¸è¢«å¼€å‘è€…ä½¿ç”¨ä¹Ÿæ˜¯ç›¸å¯¹æ˜“ç”¨ã€é€šç”¨æƒé™æ¨¡å‹ã€‚</p>
<img src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202307252346799.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:80%;" /> 
<blockquote>
<p>å‚è€ƒé“¾æ¥ï¼š</p>
<p><a href="https://cloud.tencent.com/developer/article/1703187">Spring Security ä¸­çš„ hasRole å’Œ hasAuthority æœ‰åŒºåˆ«å—ï¼Ÿ</a></p>
</blockquote>
<h2 id="ç™»å½•å®ç°">ç™»å½•å®ç°<a hidden class="anchor" aria-hidden="true" href="#ç™»å½•å®ç°">#</a></h2>
<h3 id="1å¼•å…¥-spring-security-æ¨¡å—">1.å¼•å…¥ Spring Security æ¨¡å—<a hidden class="anchor" aria-hidden="true" href="#1å¼•å…¥-spring-security-æ¨¡å—">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-security<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¼•å…¥ä¾èµ–åæˆ‘ä»¬åœ¨å°è¯•å»è®¿é—®ä¹‹å‰çš„æ¥å£å°±ä¼šè‡ªåŠ¨è·³è½¬åˆ°ä¸€ä¸ªSpringSecurityçš„é»˜è®¤ç™»é™†é¡µé¢ï¼Œé»˜è®¤ç”¨æˆ·åæ˜¯user,å¯†ç ä¼šè¾“å‡ºåœ¨æ§åˆ¶å°ã€‚ å¿…é¡»ç™»é™†ä¹‹åæ‰èƒ½å¯¹æ¥å£è¿›è¡Œè®¿é—®ã€‚</p>
<h3 id="2ç¼–å†™-spring-security-é…ç½®ç±»">2.ç¼–å†™ Spring Security é…ç½®ç±»<a hidden class="anchor" aria-hidden="true" href="#2ç¼–å†™-spring-security-é…ç½®ç±»">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@EnableGlobalMethodSecurity</span><span class="o">(</span><span class="n">prePostEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">securedEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * è‡ªå®šä¹‰ç”¨æˆ·è®¤è¯é€»è¾‘
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">UserDetailsService</span> <span class="n">userDetailsService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * è®¤è¯å¤±è´¥å¤„ç†ç±»
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">AuthenticationEntryPointImpl</span> <span class="n">unauthorizedHandler</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * é€€å‡ºå¤„ç†ç±»
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">LogoutSuccessHandlerImpl</span> <span class="n">logoutSuccessHandler</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * tokenè®¤è¯è¿‡æ»¤å™¨
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">JwtAuthenticationTokenFilter</span> <span class="n">authenticationTokenFilter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * è·¨åŸŸè¿‡æ»¤å™¨
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">CorsFilter</span> <span class="n">corsFilter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * å…è®¸åŒ¿åè®¿é—®çš„åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">PermitAllUrlProperties</span> <span class="n">permitAllUrl</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * è§£å†³ æ— æ³•ç›´æ¥æ³¨å…¥ AuthenticationManager
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws Exception
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AuthenticationManager</span> <span class="nf">authenticationManagerBean</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">authenticationManagerBean</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * anyRequest          |   åŒ¹é…æ‰€æœ‰è¯·æ±‚è·¯å¾„
</span></span></span><span class="line"><span class="cl"><span class="cm">     * access              |   SpringElè¡¨è¾¾å¼ç»“æœä¸ºtrueæ—¶å¯ä»¥è®¿é—®
</span></span></span><span class="line"><span class="cl"><span class="cm">     * anonymous           |   åŒ¿åå¯ä»¥è®¿é—®
</span></span></span><span class="line"><span class="cl"><span class="cm">     * denyAll             |   ç”¨æˆ·ä¸èƒ½è®¿é—®
</span></span></span><span class="line"><span class="cl"><span class="cm">     * fullyAuthenticated  |   ç”¨æˆ·å®Œå…¨è®¤è¯å¯ä»¥è®¿é—®ï¼ˆéremember-meä¸‹è‡ªåŠ¨ç™»å½•ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="cm">     * hasAnyAuthority     |   å¦‚æœæœ‰å‚æ•°ï¼Œå‚æ•°è¡¨ç¤ºæƒé™ï¼Œåˆ™å…¶ä¸­ä»»ä½•ä¸€ä¸ªæƒé™å¯ä»¥è®¿é—®
</span></span></span><span class="line"><span class="cl"><span class="cm">     * hasAnyRole          |   å¦‚æœæœ‰å‚æ•°ï¼Œå‚æ•°è¡¨ç¤ºè§’è‰²ï¼Œåˆ™å…¶ä¸­ä»»ä½•ä¸€ä¸ªè§’è‰²å¯ä»¥è®¿é—®
</span></span></span><span class="line"><span class="cl"><span class="cm">     * hasAuthority        |   å¦‚æœæœ‰å‚æ•°ï¼Œå‚æ•°è¡¨ç¤ºæƒé™ï¼Œåˆ™å…¶æƒé™å¯ä»¥è®¿é—®
</span></span></span><span class="line"><span class="cl"><span class="cm">     * hasIpAddress        |   å¦‚æœæœ‰å‚æ•°ï¼Œå‚æ•°è¡¨ç¤ºIPåœ°å€ï¼Œå¦‚æœç”¨æˆ·IPå’Œå‚æ•°åŒ¹é…ï¼Œåˆ™å¯ä»¥è®¿é—®
</span></span></span><span class="line"><span class="cl"><span class="cm">     * hasRole             |   å¦‚æœæœ‰å‚æ•°ï¼Œå‚æ•°è¡¨ç¤ºè§’è‰²ï¼Œåˆ™å…¶è§’è‰²å¯ä»¥è®¿é—®
</span></span></span><span class="line"><span class="cl"><span class="cm">     * permitAll           |   ç”¨æˆ·å¯ä»¥ä»»æ„è®¿é—®
</span></span></span><span class="line"><span class="cl"><span class="cm">     * rememberMe          |   å…è®¸é€šè¿‡remember-meç™»å½•çš„ç”¨æˆ·è®¿é—®
</span></span></span><span class="line"><span class="cl"><span class="cm">     * authenticated       |   ç”¨æˆ·ç™»å½•åå¯è®¿é—®
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">httpSecurity</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ³¨è§£æ ‡è®°å…è®¸åŒ¿åè®¿é—®çš„url
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ExpressionUrlAuthorizationConfigurer</span><span class="o">&lt;</span><span class="n">HttpSecurity</span><span class="o">&gt;.</span><span class="na">ExpressionInterceptUrlRegistry</span> <span class="n">registry</span> <span class="o">=</span> <span class="n">httpSecurity</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">permitAllUrl</span><span class="o">.</span><span class="na">getUrls</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">url</span> <span class="o">-&gt;</span> <span class="n">registry</span><span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="n">url</span><span class="o">).</span><span class="na">permitAll</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">httpSecurity</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// CSRFç¦ç”¨ï¼Œå› ä¸ºä¸ä½¿ç”¨session
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// å…³é—­csrfåŠŸèƒ½:è·¨ç«™è¯·æ±‚ä¼ªé€ ,é»˜è®¤åªèƒ½é€šè¿‡postæ–¹å¼æäº¤logoutè¯·æ±‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">csrf</span><span class="o">().</span><span class="na">disable</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// è®¤è¯å¤±è´¥å¤„ç†ç±»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">exceptionHandling</span><span class="o">().</span><span class="na">authenticationEntryPoint</span><span class="o">(</span><span class="n">unauthorizedHandler</span><span class="o">).</span><span class="na">and</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// åŸºäºtokenï¼Œæ‰€ä»¥ä¸éœ€è¦session
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">sessionManagement</span><span class="o">().</span><span class="na">sessionCreationPolicy</span><span class="o">(</span><span class="n">SessionCreationPolicy</span><span class="o">.</span><span class="na">STATELESS</span><span class="o">).</span><span class="na">and</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// è¿‡æ»¤è¯·æ±‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// å¯¹äºç™»å½•login æ³¨å†Œregister éªŒè¯ç captchaImage å…è®¸åŒ¿åè®¿é—®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">&#34;/login&#34;</span><span class="o">,</span> <span class="s">&#34;/register&#34;</span><span class="o">,</span> <span class="s">&#34;/captchaImage&#34;</span><span class="o">).</span><span class="na">anonymous</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// é™æ€èµ„æºï¼Œå¯åŒ¿åè®¿é—®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="n">HttpMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="s">&#34;/&#34;</span><span class="o">,</span> <span class="s">&#34;/*.html&#34;</span><span class="o">,</span> <span class="s">&#34;/**/*.html&#34;</span><span class="o">,</span> <span class="s">&#34;/**/*.css&#34;</span><span class="o">,</span> <span class="s">&#34;/**/*.js&#34;</span><span class="o">,</span> <span class="s">&#34;/profile/**&#34;</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">&#34;/swagger-ui.html&#34;</span><span class="o">,</span> <span class="s">&#34;/swagger-resources/**&#34;</span><span class="o">,</span> <span class="s">&#34;/webjars/**&#34;</span><span class="o">,</span> <span class="s">&#34;/*/api-docs&#34;</span><span class="o">,</span> <span class="s">&#34;/druid/**&#34;</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// é™¤ä¸Šé¢å¤–çš„æ‰€æœ‰è¯·æ±‚å…¨éƒ¨éœ€è¦é‰´æƒè®¤è¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">and</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">headers</span><span class="o">().</span><span class="na">frameOptions</span><span class="o">().</span><span class="na">disable</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ·»åŠ Logout filter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">httpSecurity</span><span class="o">.</span><span class="na">logout</span><span class="o">().</span><span class="na">logoutUrl</span><span class="o">(</span><span class="s">&#34;/logout&#34;</span><span class="o">).</span><span class="na">logoutSuccessHandler</span><span class="o">(</span><span class="n">logoutSuccessHandler</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ·»åŠ JWT filter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">httpSecurity</span><span class="o">.</span><span class="na">addFilterBefore</span><span class="o">(</span><span class="n">authenticationTokenFilter</span><span class="o">,</span> <span class="n">UsernamePasswordAuthenticationFilter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ·»åŠ CORS filter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">httpSecurity</span><span class="o">.</span><span class="na">addFilterBefore</span><span class="o">(</span><span class="n">corsFilter</span><span class="o">,</span> <span class="n">JwtAuthenticationTokenFilter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">httpSecurity</span><span class="o">.</span><span class="na">addFilterBefore</span><span class="o">(</span><span class="n">corsFilter</span><span class="o">,</span> <span class="n">LogoutFilter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// å¼€å¯è‡ªåŠ¨é…ç½®çš„ç™»å½•åŠŸèƒ½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// http.formLogin()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//     .loginPage(&#34;/toLogin&#34;)  //è‡ªå®šä¹‰ç™»å½•é¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//     .loginProcessingUrl(&#34;/loginRequest&#34;)  // ç™»é™†è¡¨å•æäº¤çš„è¯·æ±‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//     .passwordParameter(&#34;password&#34;);  // è¡¨å•ä¸­passwordéœ€ä¸è¯¥å¤„å¯¹åº”ã€‚é»˜è®¤æ˜¯password
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// http.formLogin();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¼€å¯è‡ªåŠ¨é…ç½®çš„æ³¨é”€çš„åŠŸèƒ½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// http.logout().logoutSuccessUrl(&#34;/&#34;); // æ³¨é”€æˆåŠŸæ¥åˆ°é¦–é¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1">// è®°ä½æˆ‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// http.rememberMe();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// http.rememberMe().
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//     rememberMeParameter(&#34;remember&#34;); // å®šåˆ¶è®°ä½æˆ‘çš„å‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * å¼ºæ•£åˆ—å“ˆå¸ŒåŠ å¯†å®ç°
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">BCryptPasswordEncoder</span> <span class="nf">bCryptPasswordEncoder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">BCryptPasswordEncoder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * èº«ä»½è®¤è¯æ¥å£
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">AuthenticationManagerBuilder</span> <span class="n">auth</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ•°æ®åº“éªŒè¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Spring Security æä¾›äº†BCryptPasswordEncoderç±»,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å®ç°Springçš„PasswordEncoderæ¥å£ä½¿ç”¨BCryptå¼ºå“ˆå¸Œæ–¹æ³•æ¥åŠ å¯†å¯†ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">auth</span><span class="o">.</span><span class="na">userDetailsService</span><span class="o">(</span><span class="n">userDetailsService</span><span class="o">).</span><span class="na">passwordEncoder</span><span class="o">(</span><span class="n">bCryptPasswordEncoder</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="3é…ç½®ç±»ç›¸å…³æ¨¡å—">3.é…ç½®ç±»ç›¸å…³æ¨¡å—<a hidden class="anchor" aria-hidden="true" href="#3é…ç½®ç±»ç›¸å…³æ¨¡å—">#</a></h3>
<p><code>UserDetailsService</code> è‡ªå®šä¹‰ç”¨æˆ·è®¤è¯é€»è¾‘</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Service</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserDetailsServiceImpl</span> <span class="kd">implements</span> <span class="n">UserDetailsService</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">UserDetailsServiceImpl</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">ISysUserService</span> <span class="n">userService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">SysPasswordService</span> <span class="n">passwordService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">SysPermissionService</span> <span class="n">permissionService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">UsernameNotFoundException</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SysUser</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">selectUserByUserName</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isNull</span><span class="o">(</span><span class="n">user</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;ç™»å½•ç”¨æˆ·ï¼š{} ä¸å­˜åœ¨.&#34;</span><span class="o">,</span> <span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">ServiceException</span><span class="o">(</span><span class="s">&#34;ç™»å½•ç”¨æˆ·ï¼š&#34;</span> <span class="o">+</span> <span class="n">username</span> <span class="o">+</span> <span class="s">&#34; ä¸å­˜åœ¨&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">UserStatus</span><span class="o">.</span><span class="na">DELETED</span><span class="o">.</span><span class="na">getCode</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getDelFlag</span><span class="o">()))</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;ç™»å½•ç”¨æˆ·ï¼š{} å·²è¢«åˆ é™¤.&#34;</span><span class="o">,</span> <span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">ServiceException</span><span class="o">(</span><span class="s">&#34;å¯¹ä¸èµ·ï¼Œæ‚¨çš„è´¦å·ï¼š&#34;</span> <span class="o">+</span> <span class="n">username</span> <span class="o">+</span> <span class="s">&#34; å·²è¢«åˆ é™¤&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">UserStatus</span><span class="o">.</span><span class="na">DISABLE</span><span class="o">.</span><span class="na">getCode</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getStatus</span><span class="o">()))</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;ç™»å½•ç”¨æˆ·ï¼š{} å·²è¢«åœç”¨.&#34;</span><span class="o">,</span> <span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">ServiceException</span><span class="o">(</span><span class="s">&#34;å¯¹ä¸èµ·ï¼Œæ‚¨çš„è´¦å·ï¼š&#34;</span> <span class="o">+</span> <span class="n">username</span> <span class="o">+</span> <span class="s">&#34; å·²åœç”¨&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">passwordService</span><span class="o">.</span><span class="na">validate</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">createLoginUser</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">UserDetails</span> <span class="nf">createLoginUser</span><span class="o">(</span><span class="n">SysUser</span> <span class="n">user</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">LoginUser</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(),</span> <span class="n">user</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code> AuthenticationEntryPointImpl</code> è®¤è¯å¤±è´¥å¤„ç†ç±» è¿”å›æœªæˆæƒ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Component</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthenticationEntryPointImpl</span> <span class="kd">implements</span> <span class="n">AuthenticationEntryPoint</span><span class="o">,</span> <span class="n">Serializable</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">8970718410437077606L</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">commence</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">AuthenticationException</span> <span class="n">e</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="kd">throws</span> <span class="n">IOException</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">code</span> <span class="o">=</span> <span class="n">HttpStatus</span><span class="o">.</span><span class="na">UNAUTHORIZED</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">StringUtils</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&#34;è¯·æ±‚è®¿é—®ï¼š{}ï¼Œè®¤è¯å¤±è´¥ï¼Œæ— æ³•è®¿é—®ç³»ç»Ÿèµ„æº&#34;</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getRequestURI</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">ServletUtils</span><span class="o">.</span><span class="na">renderString</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="n">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">ApiResponse</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">code</span><span class="o">,</span> <span class="n">msg</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>LogoutSuccessHandlerImpl</code> è‡ªå®šä¹‰é€€å‡ºå¤„ç†ç±» è¿”å›æˆåŠŸ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogoutSuccessHandlerImpl</span> <span class="kd">implements</span> <span class="n">LogoutSuccessHandler</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">TokenService</span> <span class="n">tokenService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">IAsyncService</span> <span class="n">asyncService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * é€€å‡ºå¤„ç†
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onLogoutSuccess</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">Authentication</span> <span class="n">authentication</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LoginUser</span> <span class="n">loginUser</span> <span class="o">=</span> <span class="n">tokenService</span><span class="o">.</span><span class="na">getLoginUser</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isNotNull</span><span class="o">(</span><span class="n">loginUser</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">userName</span> <span class="o">=</span> <span class="n">loginUser</span><span class="o">.</span><span class="na">getUsername</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// åˆ é™¤ç”¨æˆ·ç¼“å­˜è®°å½•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">tokenService</span><span class="o">.</span><span class="na">delLoginUser</span><span class="o">(</span><span class="n">loginUser</span><span class="o">.</span><span class="na">getToken</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// è®°å½•ç”¨æˆ·é€€å‡ºæ—¥å¿—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">asyncService</span><span class="o">.</span><span class="na">recordLogininfor</span><span class="o">(</span><span class="n">userName</span><span class="o">,</span> <span class="n">Constants</span><span class="o">.</span><span class="na">LOGOUT</span><span class="o">,</span> <span class="s">&#34;é€€å‡ºæˆåŠŸ&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">ServletUtils</span><span class="o">.</span><span class="na">renderString</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="n">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">ApiResponse</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">SUCCESS</span><span class="o">,</span> <span class="s">&#34;é€€å‡ºæˆåŠŸ&#34;</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>JwtAuthenticationTokenFiltertoken</code> tokenè¿‡æ»¤å™¨ éªŒè¯tokenæœ‰æ•ˆæ€§</p>
<blockquote>
<p><strong>SecurityContextHolder</strong> ç±»æœ€æ ¸å¿ƒçš„ä½œç”¨ï¼Œä¾¿æ˜¯å°†å½“å‰ç»™å®šçš„ SecurityContext ä¸ å½“å‰æ‰§è¡Œçº¿ç¨‹ç»‘å®šï¼Œä»è€Œæ–¹ä¾¿åç»­ç›´æ¥è·å–ã€‚</p>
<p>åœ¨<code>SecurityContextHolder</code>ä¸­ä¿å­˜çš„æ˜¯å½“å‰è®¿é—®è€…çš„ä¿¡æ¯ã€‚<code>Spring Security</code>ä½¿ç”¨ä¸€ä¸ª<code>Authentication</code>å¯¹è±¡æ¥è¡¨ç¤ºè¿™ä¸ªä¿¡æ¯ã€‚</p>
<p>é€šè¿‡<code>SecurityContextHolder.getContext().setAuthentication(authentication);</code>æ–¹å¼å°†ç”¨æˆ·ç›¸å…³çš„ä¿¡æ¯å­˜æ”¾åˆ°ç³»ç»Ÿçš„å®‰å…¨ä¸Šä¸‹æ–‡ä¸­ï¼Œå¹¶ä¸”ç”±äº<code> SecurityContextHolder</code>é»˜è®¤æ˜¯<code>mode_threadlocal</code>æ¨¡å¼ï¼Œé‚£ä¹ˆä¼šå°†æ‰€æœ‰ç™»å½•çš„ç”¨æˆ·ä¿¡æ¯éƒ½ä¿å­˜ï¼Œæ¯ä¸ªç™»å½•çš„ç”¨æˆ·éƒ½å¯ä»¥é€šè¿‡<code>SecurityContextHolder.getContext().getAuthentication();</code>æ–¹å¼è·å–
å½“å‰è‡ªå·±ä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Component</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JwtAuthenticationTokenFilter</span> <span class="kd">extends</span> <span class="n">OncePerRequestFilter</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">TokenService</span> <span class="n">tokenService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doFilterInternal</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">FilterChain</span> <span class="n">chain</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LoginUser</span> <span class="n">loginUser</span> <span class="o">=</span> <span class="n">tokenService</span><span class="o">.</span><span class="na">getLoginUser</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isNotNull</span><span class="o">(</span><span class="n">loginUser</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">StringUtils</span><span class="o">.</span><span class="na">isNull</span><span class="o">(</span><span class="n">SecurityUtils</span><span class="o">.</span><span class="na">getAuthentication</span><span class="o">()))</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">tokenService</span><span class="o">.</span><span class="na">verifyToken</span><span class="o">(</span><span class="n">loginUser</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// è·å–æƒé™ä¿¡æ¯å°è£…åˆ°Authenticationä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">UsernamePasswordAuthenticationToken</span> <span class="n">authenticationToken</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UsernamePasswordAuthenticationToken</span><span class="o">(</span><span class="n">loginUser</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">loginUser</span><span class="o">.</span><span class="na">getAuthorities</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">authenticationToken</span><span class="o">.</span><span class="na">setDetails</span><span class="o">(</span><span class="k">new</span> <span class="n">WebAuthenticationDetailsSource</span><span class="o">().</span><span class="na">buildDetails</span><span class="o">(</span><span class="n">request</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å­˜å…¥SecurityContextHolder
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">setAuthentication</span><span class="o">(</span><span class="n">authenticationToken</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">chain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>ResourcesConfig</code> è·¨åŸŸè¿‡æ»¤å™¨</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ResourcesConfig</span> <span class="kd">implements</span> <span class="n">WebMvcConfigurer</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * è·¨åŸŸé…ç½®
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">CorsFilter</span> <span class="nf">corsFilter</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">CorsConfiguration</span> <span class="n">config</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CorsConfiguration</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span><span class="o">.</span><span class="na">setAllowCredentials</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// è®¾ç½®è®¿é—®æºåœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">config</span><span class="o">.</span><span class="na">addAllowedOriginPattern</span><span class="o">(</span><span class="s">&#34;*&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// è®¾ç½®è®¿é—®æºè¯·æ±‚å¤´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">config</span><span class="o">.</span><span class="na">addAllowedHeader</span><span class="o">(</span><span class="s">&#34;*&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// è®¾ç½®è®¿é—®æºè¯·æ±‚æ–¹æ³•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">config</span><span class="o">.</span><span class="na">addAllowedMethod</span><span class="o">(</span><span class="s">&#34;*&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æœ‰æ•ˆæœŸ 1800ç§’
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">config</span><span class="o">.</span><span class="na">setMaxAge</span><span class="o">(</span><span class="mi">1800L</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ·»åŠ æ˜ å°„è·¯å¾„ï¼Œæ‹¦æˆªä¸€åˆ‡è¯·æ±‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">UrlBasedCorsConfigurationSource</span> <span class="n">source</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UrlBasedCorsConfigurationSource</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">source</span><span class="o">.</span><span class="na">registerCorsConfiguration</span><span class="o">(</span><span class="s">&#34;/**&#34;</span><span class="o">,</span> <span class="n">config</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// è¿”å›æ–°çš„CorsFilter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="k">new</span> <span class="n">CorsFilter</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>PermitAllUrlProperties</code> è®¾ç½®Anonymousæ³¨è§£å…è®¸åŒ¿åè®¿é—®çš„url</p>
<blockquote>
<p>å‚è€ƒé“¾æ¥ï¼š</p>
<p><a href="https://blog.csdn.net/CSDN877425287/article/details/115499665">ApplicationContextAwareæ¥å£çš„ä½œç”¨</a></p>
<p>è¿™ä¸ªæ¥å£å…¶å®å°±æ˜¯è·å–Springå®¹å™¨çš„Beanï¼Œåœ¨æˆ‘ä»¬å†™ä¸€äº›æ¡†æ¶ä»£ç æ—¶ï¼Œæˆ–è€…æ˜¯çœ‹ä¸€äº›æ¡†æ¶æºç æ—¶ç»å¸¸ä¼šçœ‹åˆ°è¿™ä¸ªæ¥å£ApplicationContextAware çš„ä½¿ç”¨ï¼ŒSpringå®¹å™¨ä¼šæ£€æµ‹å®¹å™¨ä¸­çš„æ‰€æœ‰Beanï¼Œå¦‚æœå‘ç°æŸä¸ªBeanå®ç°äº†ApplicationContextAwareæ¥å£ï¼ŒSpringå®¹å™¨ä¼šåœ¨åˆ›å»ºè¯¥Beanä¹‹åï¼Œè‡ªåŠ¨è°ƒç”¨è¯¥Beançš„setApplicationContextAware()æ–¹æ³•ï¼Œè°ƒç”¨è¯¥æ–¹æ³•æ—¶ï¼Œä¼šå°†å®¹å™¨æœ¬èº«ä½œä¸ºå‚æ•°ä¼ ç»™è¯¥æ–¹æ³•â€”â€”è¯¥æ–¹æ³•ä¸­çš„å®ç°éƒ¨åˆ†å°†Springä¼ å…¥çš„å‚æ•°ï¼ˆå®¹å™¨æœ¬èº«ï¼‰èµ‹ç»™è¯¥ç±»å¯¹è±¡çš„applicationContextå®ä¾‹å˜é‡ï¼Œå› æ­¤æ¥ä¸‹æ¥å¯ä»¥é€šè¿‡è¯¥applicationContextå®ä¾‹å˜é‡æ¥è®¿é—®å®¹å™¨æœ¬èº«</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span> 
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PermitAllUrlProperties</span> <span class="kd">implements</span> <span class="n">InitializingBean</span><span class="o">,</span> <span class="n">ApplicationContextAware</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Pattern</span> <span class="n">PATTERN</span> <span class="o">=</span> <span class="n">Pattern</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="s">&#34;\\{(.*?)\\}&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">ApplicationContext</span> <span class="n">applicationContext</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">urls</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="n">ASTERISK</span> <span class="o">=</span> <span class="s">&#34;*&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterPropertiesSet</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">RequestMappingHandlerMapping</span> <span class="n">mapping</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">RequestMappingHandlerMapping</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Map</span><span class="o">&lt;</span><span class="n">RequestMappingInfo</span><span class="o">,</span> <span class="n">HandlerMethod</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="na">getHandlerMethods</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">map</span><span class="o">.</span><span class="na">keySet</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">info</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">HandlerMethod</span> <span class="n">handlerMethod</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">info</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// è·å–æ–¹æ³•ä¸Šè¾¹çš„æ³¨è§£ æ›¿ä»£path variable ä¸º *
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">Anonymous</span> <span class="n">method</span> <span class="o">=</span> <span class="n">AnnotationUtils</span><span class="o">.</span><span class="na">findAnnotation</span><span class="o">(</span><span class="n">handlerMethod</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(),</span> <span class="n">Anonymous</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="n">method</span><span class="o">).</span><span class="na">ifPresent</span><span class="o">(</span><span class="n">anonymous</span> <span class="o">-&gt;</span> <span class="n">info</span><span class="o">.</span><span class="na">getPatternsCondition</span><span class="o">().</span><span class="na">getPatterns</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">url</span> <span class="o">-&gt;</span> <span class="n">urls</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">RegExUtils</span><span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">PATTERN</span><span class="o">,</span> <span class="n">ASTERISK</span><span class="o">))));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// è·å–ç±»ä¸Šè¾¹çš„æ³¨è§£, æ›¿ä»£path variable ä¸º *
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">Anonymous</span> <span class="n">controller</span> <span class="o">=</span> <span class="n">AnnotationUtils</span><span class="o">.</span><span class="na">findAnnotation</span><span class="o">(</span><span class="n">handlerMethod</span><span class="o">.</span><span class="na">getBeanType</span><span class="o">(),</span> <span class="n">Anonymous</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="n">controller</span><span class="o">).</span><span class="na">ifPresent</span><span class="o">(</span><span class="n">anonymous</span> <span class="o">-&gt;</span> <span class="n">info</span><span class="o">.</span><span class="na">getPatternsCondition</span><span class="o">().</span><span class="na">getPatterns</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">url</span> <span class="o">-&gt;</span> <span class="n">urls</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">RegExUtils</span><span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">PATTERN</span><span class="o">,</span> <span class="n">ASTERISK</span><span class="o">))));</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setApplicationContext</span><span class="o">(</span><span class="n">ApplicationContext</span> <span class="n">context</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">BeansException</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">applicationContext</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">getUrls</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">urls</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUrls</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">urls</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">urls</span> <span class="o">=</span> <span class="n">urls</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="4ç™»å½•æ¨¡å—">4.ç™»å½•æ¨¡å—<a hidden class="anchor" aria-hidden="true" href="#4ç™»å½•æ¨¡å—">#</a></h3>
<p><code>authenticationManager.authenticate</code> ä¼šè°ƒç”¨ <code>UserDetailsServiceImpl.loadUserByUsername</code> è¿›è¡Œèº«ä»½è®¤è¯</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">String</span> <span class="nf">login</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">password</span><span class="o">,</span> <span class="n">String</span> <span class="n">code</span><span class="o">,</span> <span class="n">String</span> <span class="n">uuid</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// boolean captchaEnabled = configService.selectCaptchaEnabled();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// éªŒè¯ç å¼€å…³
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="kc">false</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// validateCaptcha(username, code, uuid);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ç”¨æˆ·éªŒè¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Authentication</span> <span class="n">authentication</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">UsernamePasswordAuthenticationToken</span> <span class="n">authenticationToken</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UsernamePasswordAuthenticationToken</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">AuthenticationContextHolder</span><span class="o">.</span><span class="na">setContext</span><span class="o">(</span><span class="n">authenticationToken</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// è¯¥æ–¹æ³•ä¼šå»è°ƒç”¨UserDetailsServiceImpl.loadUserByUsername
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">authentication</span> <span class="o">=</span> <span class="n">authenticationManager</span><span class="o">.</span><span class="na">authenticate</span><span class="o">(</span><span class="n">authenticationToken</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="k">instanceof</span> <span class="n">BadCredentialsException</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span> <span class="n">message</span> <span class="o">=</span> <span class="n">MessageUtils</span><span class="o">.</span><span class="na">message</span><span class="o">(</span><span class="s">&#34;user.password.not.match&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">asyncService</span><span class="o">.</span><span class="na">recordLogininfor</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">Constants</span><span class="o">.</span><span class="na">LOGIN_FAIL</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="k">new</span> <span class="n">ServiceException</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">asyncService</span><span class="o">.</span><span class="na">recordLogininfor</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">Constants</span><span class="o">.</span><span class="na">LOGIN_FAIL</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="k">new</span> <span class="n">ServiceException</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">asyncService</span><span class="o">.</span><span class="na">recordLogininfor</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">Constants</span><span class="o">.</span><span class="na">LOGIN_SUCCESS</span><span class="o">,</span> <span class="n">MessageUtils</span><span class="o">.</span><span class="na">message</span><span class="o">(</span><span class="s">&#34;user.login.success&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">LoginUser</span> <span class="n">loginUser</span> <span class="o">=</span> <span class="o">(</span><span class="n">LoginUser</span><span class="o">)</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">recordLoginInfo</span><span class="o">(</span><span class="n">loginUser</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ç”Ÿæˆtoken
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">tokenService</span><span class="o">.</span><span class="na">createToken</span><span class="o">(</span><span class="n">loginUser</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="5ç™»å‡ºæ¨¡å—">5.ç™»å‡ºæ¨¡å—<a hidden class="anchor" aria-hidden="true" href="#5ç™»å‡ºæ¨¡å—">#</a></h3>
<p><code>SecurityConfig</code>ä¸­æ·»åŠ ç™»å‡ºè¿‡æ»¤é“¾</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// æ·»åŠ Logout filter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">httpSecurity</span><span class="o">.</span><span class="na">logout</span><span class="o">().</span><span class="na">logoutUrl</span><span class="o">(</span><span class="s">&#34;/logout&#34;</span><span class="o">).</span><span class="na">logoutSuccessHandler</span><span class="o">(</span><span class="n">logoutSuccessHandler</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>LogoutSuccessHandlerImpl</code>è‡ªå®šä¹‰é€€å‡ºå¤„ç†ç±» è¿”å›æˆåŠŸ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogoutSuccessHandlerImpl</span> <span class="kd">implements</span> <span class="n">LogoutSuccessHandler</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">TokenService</span> <span class="n">tokenService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">IAsyncService</span> <span class="n">asyncService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * é€€å‡ºå¤„ç†
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onLogoutSuccess</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">Authentication</span> <span class="n">authentication</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LoginUser</span> <span class="n">loginUser</span> <span class="o">=</span> <span class="n">tokenService</span><span class="o">.</span><span class="na">getLoginUser</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isNotNull</span><span class="o">(</span><span class="n">loginUser</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">userName</span> <span class="o">=</span> <span class="n">loginUser</span><span class="o">.</span><span class="na">getUsername</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// åˆ é™¤ç”¨æˆ·ç¼“å­˜è®°å½•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">tokenService</span><span class="o">.</span><span class="na">delLoginUser</span><span class="o">(</span><span class="n">loginUser</span><span class="o">.</span><span class="na">getToken</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// è®°å½•ç”¨æˆ·é€€å‡ºæ—¥å¿—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">asyncService</span><span class="o">.</span><span class="na">recordLogininfor</span><span class="o">(</span><span class="n">userName</span><span class="o">,</span> <span class="n">Constants</span><span class="o">.</span><span class="na">LOGOUT</span><span class="o">,</span> <span class="s">&#34;é€€å‡ºæˆåŠŸ&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">ServletUtils</span><span class="o">.</span><span class="na">renderString</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="n">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">ApiResponse</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">SUCCESS</span><span class="o">,</span> <span class="s">&#34;é€€å‡ºæˆåŠŸ&#34;</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="6æ³¨å†Œæ¨¡å—">6.æ³¨å†Œæ¨¡å—<a hidden class="anchor" aria-hidden="true" href="#6æ³¨å†Œæ¨¡å—">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">String</span> <span class="nf">register</span><span class="o">(</span><span class="n">RegisterDTO</span> <span class="n">registerBody</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="o">,</span> <span class="n">username</span> <span class="o">=</span> <span class="n">registerBody</span><span class="o">.</span><span class="na">getUsername</span><span class="o">(),</span> <span class="n">password</span> <span class="o">=</span> <span class="n">registerBody</span><span class="o">.</span><span class="na">getPassword</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">captchaEnabled</span> <span class="o">=</span> <span class="n">configService</span><span class="o">.</span><span class="na">selectCaptchaEnabled</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// éªŒè¯ç å¼€å…³
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">captchaEnabled</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// validateCaptcha(username, registerBody.getCode(), registerBody.getUuid());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">username</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#34;ç”¨æˆ·åä¸èƒ½ä¸ºç©º&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">password</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#34;ç”¨æˆ·å¯†ç ä¸èƒ½ä¸ºç©º&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">username</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">UserConstants</span><span class="o">.</span><span class="na">USERNAME_MIN_LENGTH</span>
</span></span><span class="line"><span class="cl">        <span class="o">||</span> <span class="n">username</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">UserConstants</span><span class="o">.</span><span class="na">USERNAME_MAX_LENGTH</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#34;è´¦æˆ·é•¿åº¦å¿…é¡»åœ¨2åˆ°20ä¸ªå­—ç¬¦ä¹‹é—´&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">password</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">UserConstants</span><span class="o">.</span><span class="na">PASSWORD_MIN_LENGTH</span>
</span></span><span class="line"><span class="cl">        <span class="o">||</span> <span class="n">password</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">UserConstants</span><span class="o">.</span><span class="na">PASSWORD_MAX_LENGTH</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#34;å¯†ç é•¿åº¦å¿…é¡»åœ¨5åˆ°20ä¸ªå­—ç¬¦ä¹‹é—´&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">UserConstants</span><span class="o">.</span><span class="na">NOT_UNIQUE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">userService</span><span class="o">.</span><span class="na">checkUserNameUnique</span><span class="o">(</span><span class="n">username</span><span class="o">)))</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#34;ä¿å­˜ç”¨æˆ·&#39;&#34;</span> <span class="o">+</span> <span class="n">username</span> <span class="o">+</span> <span class="s">&#34;&#39;å¤±è´¥ï¼Œæ³¨å†Œè´¦å·å·²å­˜åœ¨&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SysUser</span> <span class="n">sysUser</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SysUser</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">sysUser</span><span class="o">.</span><span class="na">setUserName</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">sysUser</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="n">SecurityUtils</span><span class="o">.</span><span class="na">encryptPassword</span><span class="o">(</span><span class="n">registerBody</span><span class="o">.</span><span class="na">getPassword</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">regFlag</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">registerUser</span><span class="o">(</span><span class="n">sysUser</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">regFlag</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#34;æ³¨å†Œå¤±è´¥,è¯·è”ç³»ç³»ç»Ÿç®¡ç†äººå‘˜&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">asyncService</span><span class="o">.</span><span class="na">recordLogininfor</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">Constants</span><span class="o">.</span><span class="na">REGISTER</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">MessageUtils</span><span class="o">.</span><span class="na">message</span><span class="o">(</span><span class="s">&#34;user.register.success&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">msg</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="æˆæƒå®ç°">æˆæƒå®ç°<a hidden class="anchor" aria-hidden="true" href="#æˆæƒå®ç°">#</a></h2>
<h3 id="1åˆ›å»ºæ•°æ®åº“è¡¨">1.åˆ›å»ºæ•°æ®åº“è¡¨<a hidden class="anchor" aria-hidden="true" href="#1åˆ›å»ºæ•°æ®åº“è¡¨">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- ----------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1">-- è§’è‰²ä¿¡æ¯è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1">-- ----------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">drop</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="n">sys_role</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">sys_role</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">role_id</span><span class="w">              </span><span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w">      </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="n">auto_increment</span><span class="w">    </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;è§’è‰²ID&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">role_name</span><span class="w">            </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="w">     </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w">                   </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;è§’è‰²åç§°&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">role_key</span><span class="w">             </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w">    </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w">                   </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;è§’è‰²æƒé™å­—ç¬¦ä¸²&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">role_sort</span><span class="w">            </span><span class="nb">int</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w">          </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w">                   </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;æ˜¾ç¤ºé¡ºåº&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">data_scope</span><span class="w">           </span><span class="nb">char</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w">         </span><span class="k">default</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="w">                </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;æ•°æ®èŒƒå›´ï¼ˆ1ï¼šå…¨éƒ¨æ•°æ®æƒé™ 2ï¼šè‡ªå®šæ•°æ®æƒé™ 3ï¼šæœ¬éƒ¨é—¨æ•°æ®æƒé™ 4ï¼šæœ¬éƒ¨é—¨åŠä»¥ä¸‹æ•°æ®æƒé™ï¼‰&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">menu_check_strictly</span><span class="w">  </span><span class="n">tinyint</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w">      </span><span class="k">default</span><span class="w"> </span><span class="mi">1</span><span class="w">                  </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;èœå•æ ‘é€‰æ‹©é¡¹æ˜¯å¦å…³è”æ˜¾ç¤º&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">dept_check_strictly</span><span class="w">  </span><span class="n">tinyint</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w">      </span><span class="k">default</span><span class="w"> </span><span class="mi">1</span><span class="w">                  </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;éƒ¨é—¨æ ‘é€‰æ‹©é¡¹æ˜¯å¦å…³è”æ˜¾ç¤º&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">status</span><span class="w">               </span><span class="nb">char</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w">         </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w">                   </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;è§’è‰²çŠ¶æ€ï¼ˆ0æ­£å¸¸ 1åœç”¨ï¼‰&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">del_flag</span><span class="w">             </span><span class="nb">char</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w">         </span><span class="k">default</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="w">                </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;åˆ é™¤æ ‡å¿—ï¼ˆ0ä»£è¡¨å­˜åœ¨ 2ä»£è¡¨åˆ é™¤ï¼‰&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">create_by</span><span class="w">            </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span><span class="w">     </span><span class="k">default</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w">                 </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;åˆ›å»ºè€…&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">create_time</span><span class="w">          </span><span class="n">datetime</span><span class="w">                                   </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;åˆ›å»ºæ—¶é—´&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">update_by</span><span class="w">            </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span><span class="w">     </span><span class="k">default</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w">                 </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;æ›´æ–°è€…&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">update_time</span><span class="w">          </span><span class="n">datetime</span><span class="w">                                   </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;æ›´æ–°æ—¶é—´&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">remark</span><span class="w">               </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="w">    </span><span class="k">default</span><span class="w"> </span><span class="k">null</span><span class="w">               </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;å¤‡æ³¨&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="p">(</span><span class="n">role_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">engine</span><span class="o">=</span><span class="n">innodb</span><span class="w"> </span><span class="n">auto_increment</span><span class="o">=</span><span class="mi">100</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;è§’è‰²ä¿¡æ¯è¡¨&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- ----------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1">-- èœå•æƒé™è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1">-- ----------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">drop</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="n">sys_menu</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">sys_menu</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">menu_id</span><span class="w">           </span><span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w">      </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="n">auto_increment</span><span class="w">    </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;èœå•ID&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">menu_name</span><span class="w">         </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w">     </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w">                   </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;èœå•åç§°&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">parent_id</span><span class="w">         </span><span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w">      </span><span class="k">default</span><span class="w"> </span><span class="mi">0</span><span class="w">                  </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;çˆ¶èœå•ID&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">order_num</span><span class="w">         </span><span class="nb">int</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w">          </span><span class="k">default</span><span class="w"> </span><span class="mi">0</span><span class="w">                  </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;æ˜¾ç¤ºé¡ºåº&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">path</span><span class="w">              </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span><span class="w">    </span><span class="k">default</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w">                 </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;è·¯ç”±åœ°å€&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">component</span><span class="w">         </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w">    </span><span class="k">default</span><span class="w"> </span><span class="k">null</span><span class="w">               </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;ç»„ä»¶è·¯å¾„&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">query</span><span class="w">             </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w">    </span><span class="k">default</span><span class="w"> </span><span class="k">null</span><span class="w">               </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;è·¯ç”±å‚æ•°&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">is_frame</span><span class="w">          </span><span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w">          </span><span class="k">default</span><span class="w"> </span><span class="mi">1</span><span class="w">                  </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;æ˜¯å¦ä¸ºå¤–é“¾ï¼ˆ0æ˜¯ 1å¦ï¼‰&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">is_cache</span><span class="w">          </span><span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w">          </span><span class="k">default</span><span class="w"> </span><span class="mi">0</span><span class="w">                  </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;æ˜¯å¦ç¼“å­˜ï¼ˆ0ç¼“å­˜ 1ä¸ç¼“å­˜ï¼‰&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">menu_type</span><span class="w">         </span><span class="nb">char</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w">         </span><span class="k">default</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w">                 </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;èœå•ç±»å‹ï¼ˆMç›®å½• Cèœå• FæŒ‰é’®ï¼‰&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">visible</span><span class="w">           </span><span class="nb">char</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w">         </span><span class="k">default</span><span class="w"> </span><span class="mi">0</span><span class="w">                  </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;èœå•çŠ¶æ€ï¼ˆ0æ˜¾ç¤º 1éšè—ï¼‰&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">status</span><span class="w">            </span><span class="nb">char</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w">         </span><span class="k">default</span><span class="w"> </span><span class="mi">0</span><span class="w">                  </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;èœå•çŠ¶æ€ï¼ˆ0æ­£å¸¸ 1åœç”¨ï¼‰&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">perms</span><span class="w">             </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w">    </span><span class="k">default</span><span class="w"> </span><span class="k">null</span><span class="w">               </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;æƒé™æ ‡è¯†&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">icon</span><span class="w">              </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w">    </span><span class="k">default</span><span class="w"> </span><span class="s1">&#39;#&#39;</span><span class="w">                </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;èœå•å›¾æ ‡&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">create_by</span><span class="w">         </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span><span class="w">     </span><span class="k">default</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w">                 </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;åˆ›å»ºè€…&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">create_time</span><span class="w">       </span><span class="n">datetime</span><span class="w">                                   </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;åˆ›å»ºæ—¶é—´&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">update_by</span><span class="w">         </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span><span class="w">     </span><span class="k">default</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w">                 </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;æ›´æ–°è€…&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">update_time</span><span class="w">       </span><span class="n">datetime</span><span class="w">                                   </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;æ›´æ–°æ—¶é—´&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">remark</span><span class="w">            </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="w">    </span><span class="k">default</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w">                 </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;å¤‡æ³¨&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="p">(</span><span class="n">menu_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">engine</span><span class="o">=</span><span class="n">innodb</span><span class="w"> </span><span class="n">auto_increment</span><span class="o">=</span><span class="mi">2000</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;èœå•æƒé™è¡¨&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- ----------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1">-- è§’è‰²å’Œèœå•å…³è”è¡¨  è§’è‰²1-Nèœå•
</span></span></span><span class="line"><span class="cl"><span class="c1">-- ----------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">drop</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="n">sys_role_menu</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">sys_role_menu</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">role_id</span><span class="w">   </span><span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;è§’è‰²ID&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">menu_id</span><span class="w">   </span><span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;èœå•ID&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="p">(</span><span class="n">role_id</span><span class="p">,</span><span class="w"> </span><span class="n">menu_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">engine</span><span class="o">=</span><span class="n">innodb</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;è§’è‰²å’Œèœå•å…³è”è¡¨&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- ----------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1">-- ç”¨æˆ·å’Œè§’è‰²å…³è”è¡¨  ç”¨æˆ·N-1è§’è‰²
</span></span></span><span class="line"><span class="cl"><span class="c1">-- ----------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">drop</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="n">sys_user_role</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">sys_user_role</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">user_id</span><span class="w">   </span><span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;ç”¨æˆ·ID&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">role_id</span><span class="w">   </span><span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;è§’è‰²ID&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">role_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">engine</span><span class="o">=</span><span class="n">innodb</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;ç”¨æˆ·å’Œè§’è‰²å…³è”è¡¨&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="2æƒé™è¿‡æ»¤å™¨">2.æƒé™è¿‡æ»¤å™¨<a hidden class="anchor" aria-hidden="true" href="#2æƒé™è¿‡æ»¤å™¨">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Component</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JwtAuthenticationTokenFilter</span> <span class="kd">extends</span> <span class="n">OncePerRequestFilter</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">TokenService</span> <span class="n">tokenService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doFilterInternal</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">FilterChain</span> <span class="n">chain</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LoginUser</span> <span class="n">loginUser</span> <span class="o">=</span> <span class="n">tokenService</span><span class="o">.</span><span class="na">getLoginUser</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isNotNull</span><span class="o">(</span><span class="n">loginUser</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">StringUtils</span><span class="o">.</span><span class="na">isNull</span><span class="o">(</span><span class="n">SecurityUtils</span><span class="o">.</span><span class="na">getAuthentication</span><span class="o">()))</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">tokenService</span><span class="o">.</span><span class="na">verifyToken</span><span class="o">(</span><span class="n">loginUser</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// è·å–æƒé™ä¿¡æ¯å°è£…åˆ°Authenticationä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">UsernamePasswordAuthenticationToken</span> <span class="n">authenticationToken</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UsernamePasswordAuthenticationToken</span><span class="o">(</span><span class="n">loginUser</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">loginUser</span><span class="o">.</span><span class="na">getAuthorities</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">authenticationToken</span><span class="o">.</span><span class="na">setDetails</span><span class="o">(</span><span class="k">new</span> <span class="n">WebAuthenticationDetailsSource</span><span class="o">().</span><span class="na">buildDetails</span><span class="o">(</span><span class="n">request</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å­˜å…¥SecurityContextHolder
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">setAuthentication</span><span class="o">(</span><span class="n">authenticationToken</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">chain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="3ç™»å½•æ—¶æƒé™èµ‹å€¼">3.ç™»å½•æ—¶æƒé™èµ‹å€¼<a hidden class="anchor" aria-hidden="true" href="#3ç™»å½•æ—¶æƒé™èµ‹å€¼">#</a></h3>
<p>åœ¨ <code>UserDetailsServiceImpl</code> çš„ <code>loadUserByUsername</code> ä¸­ä¸ºuserèµ‹ä¸Šæƒé™</p>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202307252346035.png" alt="image-20220901230449453"  />
</p>
<h3 id="4æƒé™æŸ¥è¯¢mapper">4.æƒé™æŸ¥è¯¢Mapper<a hidden class="anchor" aria-hidden="true" href="#4æƒé™æŸ¥è¯¢mapper">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&#34;selectMenuListByUserId&#34;</span> <span class="na">parameterType=</span><span class="s">&#34;SysMenu&#34;</span> <span class="na">resultMap=</span><span class="s">&#34;SysMenuResult&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">   select distinct m.menu_id, m.parent_id, m.menu_name, m.path, m.component, m.`query`, m.visible, m.status, ifnull(m.perms,&#39;&#39;) as perms, m.is_frame, m.is_cache, m.menu_type, m.icon, m.order_num, m.create_time
</span></span><span class="line"><span class="cl">   from sys_menu m
</span></span><span class="line"><span class="cl">   left join sys_role_menu rm on m.menu_id = rm.menu_id
</span></span><span class="line"><span class="cl">   left join sys_user_role ur on rm.role_id = ur.role_id
</span></span><span class="line"><span class="cl">   left join sys_role ro on ur.role_id = ro.role_id
</span></span><span class="line"><span class="cl">   where ur.user_id = #{params.userId}
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;if</span> <span class="na">test=</span><span class="s">&#34;menuName != null and menuName != &#39;&#39;&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">           AND m.menu_name like concat(&#39;%&#39;, #{menuName}, &#39;%&#39;)
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;/if&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;if</span> <span class="na">test=</span><span class="s">&#34;visible != null and visible != &#39;&#39;&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">           AND m.visible = #{visible}
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;/if&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;if</span> <span class="na">test=</span><span class="s">&#34;status != null and status != &#39;&#39;&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">           AND m.status = #{status}
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;/if&gt;</span>
</span></span><span class="line"><span class="cl">   order by m.parent_id, m.order_num
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/select&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="5è‡ªå®šä¹‰æƒé™æ–¹æ³•">5.è‡ªå®šä¹‰æƒé™æ–¹æ³•<a hidden class="anchor" aria-hidden="true" href="#5è‡ªå®šä¹‰æƒé™æ–¹æ³•">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Service</span><span class="o">(</span><span class="s">&#34;ss&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PermissionService</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/** æ‰€æœ‰æƒé™æ ‡è¯† */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">ALL_PERMISSION</span> <span class="o">=</span> <span class="s">&#34;*:*:*&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/** ç®¡ç†å‘˜è§’è‰²æƒé™æ ‡è¯† */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">SUPER_ADMIN</span> <span class="o">=</span> <span class="s">&#34;admin&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">ROLE_DELIMETER</span> <span class="o">=</span> <span class="s">&#34;,&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">PERMISSION_DELIMETER</span> <span class="o">=</span> <span class="s">&#34;,&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * éªŒè¯ç”¨æˆ·æ˜¯å¦å…·å¤‡æŸæƒé™
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param permission æƒé™å­—ç¬¦ä¸²
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return ç”¨æˆ·æ˜¯å¦å…·å¤‡æŸæƒé™
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasPermi</span><span class="o">(</span><span class="n">String</span> <span class="n">permission</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">permission</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">LoginUser</span> <span class="n">loginUser</span> <span class="o">=</span> <span class="n">SecurityUtils</span><span class="o">.</span><span class="na">getLoginUser</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isNull</span><span class="o">(</span><span class="n">loginUser</span><span class="o">)</span> <span class="o">||</span> <span class="n">CollectionUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">loginUser</span><span class="o">.</span><span class="na">getPermissions</span><span class="o">()))</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">hasPermissions</span><span class="o">(</span><span class="n">loginUser</span><span class="o">.</span><span class="na">getPermissions</span><span class="o">(),</span> <span class="n">permission</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="6æ¥å£å®ç°">6.æ¥å£å®ç°<a hidden class="anchor" aria-hidden="true" href="#6æ¥å£å®ç°">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * è·å–èœå•åˆ—è¡¨
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@PreAuthorize</span><span class="o">(</span><span class="s">&#34;@ss.hasPermi(&#39;system:menu:list&#39;)&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/list&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">AjaxResult</span> <span class="nf">list</span><span class="o">(</span><span class="n">SysMenu</span> <span class="n">menu</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">SysMenu</span><span class="o">&gt;</span> <span class="n">menus</span> <span class="o">=</span> <span class="n">menuService</span><span class="o">.</span><span class="na">selectMenuList</span><span class="o">(</span><span class="n">menu</span><span class="o">,</span> <span class="n">getUserId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">AjaxResult</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="n">menus</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>

  </div>

  <footer class="post-footer">
    
<nav class="paginav">
  <a class="prev" href="https://chance7bin.github.io/posts/design/redis%E5%92%8Cmysql%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7%E5%AE%9E%E7%8E%B0/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>rediså’Œmysqlç¼“å­˜ä¸€è‡´æ€§å®ç°</span>
  </a>
  <a class="next" href="https://chance7bin.github.io/posts/design/%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>æ–­ç‚¹ç»­ä¼ </span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://chance7bin.github.io/">Binb&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerHTML = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
