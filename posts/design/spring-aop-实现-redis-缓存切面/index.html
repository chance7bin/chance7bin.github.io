<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Spring AOP å®ç° Redis ç¼“å­˜åˆ‡é¢ | Binb&#39;s Blog</title>
<meta name="keywords" content="ç³»ç»Ÿè®¾è®¡, ç¼“å­˜">
<meta name="description" content="@EnableCaching spring bootæä¾›äº†æ¯”è¾ƒç®€å•çš„ç¼“å­˜æ–¹æ¡ˆã€‚åªè¦ä½¿ç”¨ @EnableCaching å³å¯å®Œæˆç®€å•çš„ç¼“å­˜åŠŸèƒ½ã€‚ https://blog.csdn.net/micro_hz/article/details/76599632 å‚è€ƒåšå®¢ Springçš„é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼ˆAOPï¼‰ Spring AOP å®ç° Redis ç¼“å­˜åˆ‡é¢ Sp">
<meta name="author" content="chance7bin">
<link rel="canonical" href="https://chance7bin.github.io/posts/design/spring-aop-%E5%AE%9E%E7%8E%B0-redis-%E7%BC%93%E5%AD%98%E5%88%87%E9%9D%A2/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.be81eec981a615a87a88f121642d7eebde74d033438693944db2fd6b827284ff.css" integrity="" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.acb54fd32bbc1982428b8850317e45d076b95012730a5936667e6bc21777692a.js" integrity=""
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<link rel="icon" type="image/png" sizes="16x16" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<link rel="icon" type="image/png" sizes="32x32" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<link rel="apple-touch-icon" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<link rel="mask-icon" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Spring AOP å®ç° Redis ç¼“å­˜åˆ‡é¢" />
<meta property="og:description" content="@EnableCaching spring bootæä¾›äº†æ¯”è¾ƒç®€å•çš„ç¼“å­˜æ–¹æ¡ˆã€‚åªè¦ä½¿ç”¨ @EnableCaching å³å¯å®Œæˆç®€å•çš„ç¼“å­˜åŠŸèƒ½ã€‚ https://blog.csdn.net/micro_hz/article/details/76599632 å‚è€ƒåšå®¢ Springçš„é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼ˆAOPï¼‰ Spring AOP å®ç° Redis ç¼“å­˜åˆ‡é¢ Sp" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://chance7bin.github.io/posts/design/spring-aop-%E5%AE%9E%E7%8E%B0-redis-%E7%BC%93%E5%AD%98%E5%88%87%E9%9D%A2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-31T22:37:33+08:00" />
<meta property="article:modified_time" content="2023-05-31T22:37:33+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Spring AOP å®ç° Redis ç¼“å­˜åˆ‡é¢"/>
<meta name="twitter:description" content="@EnableCaching spring bootæä¾›äº†æ¯”è¾ƒç®€å•çš„ç¼“å­˜æ–¹æ¡ˆã€‚åªè¦ä½¿ç”¨ @EnableCaching å³å¯å®Œæˆç®€å•çš„ç¼“å­˜åŠŸèƒ½ã€‚ https://blog.csdn.net/micro_hz/article/details/76599632 å‚è€ƒåšå®¢ Springçš„é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼ˆAOPï¼‰ Spring AOP å®ç° Redis ç¼“å­˜åˆ‡é¢ Sp"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "ğŸ“š æ–‡ç« ",
      "item": "https://chance7bin.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ¨ ç³»ç»Ÿè®¾è®¡",
      "item": "https://chance7bin.github.io/posts/design/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Spring AOP å®ç° Redis ç¼“å­˜åˆ‡é¢",
      "item": "https://chance7bin.github.io/posts/design/spring-aop-%E5%AE%9E%E7%8E%B0-redis-%E7%BC%93%E5%AD%98%E5%88%87%E9%9D%A2/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Spring AOP å®ç° Redis ç¼“å­˜åˆ‡é¢",
  "name": "Spring AOP å®ç° Redis ç¼“å­˜åˆ‡é¢",
  "description": "@EnableCaching spring bootæä¾›äº†æ¯”è¾ƒç®€å•çš„ç¼“å­˜æ–¹æ¡ˆã€‚åªè¦ä½¿ç”¨ @EnableCaching å³å¯å®Œæˆç®€å•çš„ç¼“å­˜åŠŸèƒ½ã€‚ https://blog.csdn.net/micro_hz/article/details/76599632 å‚è€ƒåšå®¢ Springçš„é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼ˆAOPï¼‰ Spring AOP å®ç° Redis ç¼“å­˜åˆ‡é¢ Sp",
  "keywords": [
    "ç³»ç»Ÿè®¾è®¡", "ç¼“å­˜"
  ],
  "articleBody": "@EnableCaching spring bootæä¾›äº†æ¯”è¾ƒç®€å•çš„ç¼“å­˜æ–¹æ¡ˆã€‚åªè¦ä½¿ç”¨ @EnableCaching å³å¯å®Œæˆç®€å•çš„ç¼“å­˜åŠŸèƒ½ã€‚\nhttps://blog.csdn.net/micro_hz/article/details/76599632\nå‚è€ƒåšå®¢ Springçš„é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼ˆAOPï¼‰\nSpring AOP å®ç° Redis ç¼“å­˜åˆ‡é¢\nSpringBootä¸­é€šè¿‡è‡ªå®šä¹‰ç¼“å­˜æ³¨è§£(AOPåˆ‡é¢æ‹¦æˆª)å®ç°æ•°æ®åº“æ•°æ®ç¼“å­˜åˆ°Redis\nSpringBoot + Redisï¼šåŸºæœ¬é…ç½®åŠä½¿ç”¨\nSpringä¸­è‡ªå®šä¹‰æ³¨è§£æ”¯æŒSpElè¡¨è¾¾å¼ï¼ˆä»…é™åœ¨AOPä¸­ä½¿ç”¨ï¼‰\næ·»åŠ ä¾èµ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 org.springframework.boot spring-boot-starter-data-redis org.apache.commons commons-pool2 2.8.1 org.springframework spring-aspects 4.3.14.RELEASE ymlé…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 spring: data: redis: repositories: enabled: false redis: # Redisé»˜è®¤æƒ…å†µä¸‹æœ‰16ä¸ªåˆ†ç‰‡ï¼Œè¿™é‡Œé…ç½®å…·ä½“ä½¿ç”¨çš„åˆ†ç‰‡ï¼Œé»˜è®¤æ˜¯0 database: 0 host: localhost port: 6379 # è¿æ¥å¯†ç ï¼ˆé»˜è®¤ä¸ºç©ºï¼‰ password: # è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’) timeout: 10000ms lettuce: pool: # è¿æ¥æ± æœ€å¤§è¿æ¥æ•°ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰ é»˜è®¤ 8 max-active: 8 # è¿æ¥æ± æœ€å¤§é˜»å¡ç­‰å¾…æ—¶é—´ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰ é»˜è®¤ -1 max-wait: -1 # è¿æ¥æ± ä¸­çš„æœ€å¤§ç©ºé—²è¿æ¥ é»˜è®¤ 8 max-idle: 8 # è¿æ¥æ± ä¸­çš„æœ€å°ç©ºé—²è¿æ¥ é»˜è®¤ 0 min-idle: 0 ä»£ç  è‡ªå®šä¹‰RedisTemplate ä½¿ç”¨fastjsonè¿›è¡Œåºåˆ—åŒ–\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 package njgis.opengms.portal.config; import com.fasterxml.jackson.annotation.JsonAutoDetect; import com.fasterxml.jackson.annotation.JsonTypeInfo; import com.fasterxml.jackson.annotation.PropertyAccessor; import com.fasterxml.jackson.databind.ObjectMapper; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; import org.springframework.data.redis.connection.RedisConnectionFactory; import org.springframework.data.redis.core.RedisTemplate; import org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer; import org.springframework.data.redis.serializer.RedisSerializer; import org.springframework.data.redis.serializer.StringRedisSerializer; /** * @Description * @Author bin * @Date 2022/07/19 */ @Configuration public class RedisConfig { @Bean public RedisTemplate\u003cString, Object\u003e template(RedisConnectionFactory factory) { // åˆ›å»ºRedisTemplateå¯¹è±¡ RedisTemplate\u003cString, Object\u003e template = new RedisTemplate\u003c\u003e(); // é…ç½®è¿æ¥å·¥å‚ template.setConnectionFactory(factory); // redis key åºåˆ—åŒ–æ–¹å¼ä½¿ç”¨stringSerial template.setKeySerializer(new StringRedisSerializer()); // redis value åºåˆ—åŒ–æ–¹å¼è‡ªå®šä¹‰ // template.setValueSerializer(new GenericFastJsonRedisSerializer()); template.setValueSerializer(valueSerializer()); // redis hash key åºåˆ—åŒ–æ–¹å¼ä½¿ç”¨stringSerial template.setHashKeySerializer(new StringRedisSerializer()); // redis hash value åºåˆ—åŒ–æ–¹å¼è‡ªå®šä¹‰ // template.setHashValueSerializer(new GenericFastJsonRedisSerializer()); template.setHashValueSerializer(valueSerializer()); return template; } private RedisSerializer\u003cObject\u003e valueSerializer() { Jackson2JsonRedisSerializer\u003cObject\u003e jackson2JsonRedisSerializer = new Jackson2JsonRedisSerializer\u003c\u003e(Object.class); ObjectMapper objectMapper = new ObjectMapper(); objectMapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY); // æ­¤é¡¹å¿…é¡»é…ç½®ï¼Œå¦åˆ™å¦‚æœåºåˆ—åŒ–çš„å¯¹è±¡é‡Œè¾¹è¿˜æœ‰å¯¹è±¡ï¼Œä¼šæŠ¥å¦‚ä¸‹é”™è¯¯ï¼š // java.lang.ClassCastException: java.util.LinkedHashMap cannot be cast to XXX objectMapper.activateDefaultTyping( objectMapper.getPolymorphicTypeValidator(), ObjectMapper.DefaultTyping.NON_FINAL, JsonTypeInfo.As.PROPERTY); // æ—§ç‰ˆå†™æ³•ï¼š // objectMapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL, JsonTypeInfo.As.PROPERTY); jackson2JsonRedisSerializer.setObjectMapper(objectMapper); return jackson2JsonRedisSerializer; } } redisç¼“å­˜æ³¨è§£ï¼šæ’å…¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 import njgis.opengms.portal.enums.ItemTypeEnum; import java.lang.annotation.ElementType; import java.lang.annotation.Retention; import java.lang.annotation.RetentionPolicy; import java.lang.annotation.Target; /** * @Description æ–°å¢redisç¼“å­˜ * @Author bin * @Date 2022/07/19 */ @Retention(RetentionPolicy.RUNTIME) @Target(ElementType.METHOD) public @interface AopCacheEnable { //redisç¼“å­˜key String key(); //redisç¼“å­˜å­˜æ´»æ—¶é—´é»˜è®¤å€¼ï¼ˆå¯è‡ªå®šä¹‰ï¼‰ long expireTime() default 3600; //redisç¼“å­˜çš„åˆ†ç»„ ItemTypeEnum group() default ItemTypeEnum.PortalItem; } redisç¼“å­˜æ³¨è§£ï¼šåˆ é™¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 import java.lang.annotation.ElementType; import java.lang.annotation.Retention; import java.lang.annotation.RetentionPolicy; import java.lang.annotation.Target; /** * @Description * @Author bin * @Date 2022/07/19 */ @Retention(RetentionPolicy.RUNTIME) @Target(ElementType.METHOD) public @interface AopCacheEvict { //redisä¸­çš„keyå€¼ String key(); //redisç¼“å­˜çš„åˆ†ç»„ String group(); } è‡ªå®šä¹‰ç¼“å­˜åˆ‡é¢å…·ä½“å®ç°ç±» CacheEnableAspect.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 import lombok.extern.slf4j.Slf4j; import njgis.opengms.portal.enums.ItemTypeEnum; import njgis.opengms.portal.service.RedisService; import org.aspectj.lang.ProceedingJoinPoint; import org.aspectj.lang.Signature; import org.aspectj.lang.annotation.Around; import org.aspectj.lang.annotation.Aspect; import org.aspectj.lang.annotation.Pointcut; import org.aspectj.lang.reflect.MethodSignature; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.core.DefaultParameterNameDiscoverer; import org.springframework.expression.EvaluationContext; import org.springframework.expression.Expression; import org.springframework.expression.spel.standard.SpelExpressionParser; import org.springframework.expression.spel.support.StandardEvaluationContext; import org.springframework.stereotype.Component; import java.lang.reflect.Method; /** * @Description è‡ªå®šä¹‰ç¼“å­˜åˆ‡é¢å…·ä½“å®ç°ç±» * @Author bin * @Date 2022/07/19 */ @Slf4j @Aspect @Component public class CacheEnableAspect { @Autowired RedisService redisService; /** * ç”¨äºSpELè¡¨è¾¾å¼è§£æ. */ private SpelExpressionParser parser = new SpelExpressionParser(); /** * ç”¨äºè·å–æ–¹æ³•å‚æ•°å®šä¹‰åå­—. */ private DefaultParameterNameDiscoverer nameDiscoverer = new DefaultParameterNameDiscoverer(); /** * Mapperå±‚åˆ‡ç‚¹ ä½¿ç”¨åˆ°äº†æˆ‘ä»¬å®šä¹‰çš„ AopCacheEnable ä½œä¸ºåˆ‡ç‚¹è¡¨è¾¾å¼ã€‚ */ @Pointcut(\"@annotation(njgis.opengms.portal.component.AopCacheEnable)\") public void queryCache() { } /** * Mapperå±‚åˆ‡ç‚¹ ä½¿ç”¨åˆ°äº†æˆ‘ä»¬å®šä¹‰çš„ AopCacheEvict ä½œä¸ºåˆ‡ç‚¹è¡¨è¾¾å¼ã€‚ */ @Pointcut(\"@annotation(njgis.opengms.portal.component.AopCacheEvict)\") public void ClearCache() { } @Around(\"queryCache()\") public Object Interceptor(ProceedingJoinPoint pjp) throws Throwable { // StringBuilder redisKeySb = new StringBuilder(\"AOP\").append(\"::\"); StringBuilder redisKeySb = new StringBuilder(\"AOP\"); // ç±» // String className = pjp.getTarget().toString().split(\"@\")[0]; // redisKeySb.append(className).append(\"::\"); //è·å–å½“å‰è¢«åˆ‡æ³¨è§£çš„æ–¹æ³•å Method method = getMethod(pjp); //è·å–å½“å‰è¢«åˆ‡æ–¹æ³•çš„æ³¨è§£ AopCacheEnable aopCacheEnable = method.getAnnotation(AopCacheEnable.class); if (aopCacheEnable == null) { return pjp.proceed(); } //è·å–è¢«åˆ‡æ³¨è§£æ–¹æ³•è¿”å›ç±»å‹ // Type returnType = method.getAnnotatedReturnType().getType(); // String[] split = returnType.getTypeName().split(\"\\\\.\"); // String type = split[split.length - 1]; // redisKeySb.append(\":\").append(type); //ä»æ³¨è§£ä¸­è·å–key //é€šè¿‡æ³¨è§£keyä½¿ç”¨çš„SpELè¡¨è¾¾å¼è·å–åˆ°SpELæ‰§è¡Œç»“æœ String key = aopCacheEnable.key(); // redisKeySb.append(args); String resV = generateKeyBySpEL(key, pjp).toString(); redisKeySb.append(\":\").append(aopCacheEnable.group()).append(\":\").append(resV); //è·å–æ–¹æ³•å‚æ•°å€¼ // Object[] arguments = pjp.getArgs(); // redisKeySb.append(\":\").append(arguments[0]); String redisKey = redisKeySb.toString(); Object result = redisService.get(redisKey); if (result != null) { log.info(\"ä»Redisä¸­è·å–æ•°æ®ï¼š{}\", result); return result; } else { try { result = pjp.proceed(); log.info(\"ä»æ•°æ®åº“ä¸­è·å–æ•°æ®ï¼š{}\", result); } catch (Throwable e) { throw new RuntimeException(e.getMessage(), e); } // è·å–å¤±æ•ˆæ—¶é—´ long expire = aopCacheEnable.expireTime(); redisService.set(redisKey, result, expire); } return result; } /*** å®šä¹‰æ¸…é™¤ç¼“å­˜é€»è¾‘ï¼Œå…ˆæ“ä½œæ•°æ®åº“ï¼Œåæ¸…é™¤ç¼“å­˜*/ @Around(value = \"ClearCache()\") public Object evict(ProceedingJoinPoint pjp) throws Throwable { StringBuilder redisKeySb = new StringBuilder(\"AOP\"); Method method = getMethod(pjp); // è·å–æ–¹æ³•çš„æ³¨è§£ AopCacheEvict cacheEvict = method.getAnnotation(AopCacheEvict.class); if (cacheEvict == null) { return pjp.proceed(); } //ä»æ³¨è§£ä¸­è·å–key //é€šè¿‡æ³¨è§£keyä½¿ç”¨çš„SpELè¡¨è¾¾å¼è·å–åˆ°SpELæ‰§è¡Œç»“æœ String key = cacheEvict.key(); // redisKeySb.append(args); key = generateKeyBySpEL(key, pjp).toString(); //æ¸…æ¥šç¼“å­˜çš„groupä»å‚æ•°æ‹¿ String group = cacheEvict.group(); ItemTypeEnum type = (ItemTypeEnum)generateKeyBySpEL(group, pjp); redisKeySb.append(\":\").append(type).append(\":\").append(key); //å…ˆæ“ä½œdb Object result = pjp.proceed(); //æ ¹æ®keyä»ç¼“å­˜ä¸­åˆ é™¤ String redisKey = redisKeySb.toString(); redisService.delete(redisKey); return result; } /** * è·å–è¢«æ‹¦æˆªæ–¹æ³•å¯¹è±¡ */ public Method getMethod(ProceedingJoinPoint pjp) { Signature signature = pjp.getSignature(); MethodSignature methodSignature = (MethodSignature) signature; Method targetMethod = methodSignature.getMethod(); return targetMethod; } public Object generateKeyBySpEL(String spELString, ProceedingJoinPoint joinPoint) { MethodSignature methodSignature = (MethodSignature) joinPoint.getSignature(); String[] paramNames = nameDiscoverer.getParameterNames(methodSignature.getMethod()); Expression expression = parser.parseExpression(spELString); EvaluationContext context = new StandardEvaluationContext(); Object[] args = joinPoint.getArgs(); for (int i = 0; i \u003c args.length; i++) { context.setVariable(paramNames[i], args[i]); } return expression.getValue(context); } } æ³¨æ„è¿™é‡Œçš„queryCacheå’ŒClearCacheï¼Œé‡Œé¢åˆ‡ç‚¹è¡¨è¾¾å¼\nåˆ†åˆ«å¯¹åº”ä¸Šé¢è‡ªå®šä¹‰çš„ä¸¤ä¸ªAopCacheEnableå’ŒAopCacheEvictã€‚\nç„¶ååœ¨ç¯ç»•é€šçŸ¥çš„queryCacheæ–¹æ³•æ‰§è¡Œå‰åæ—¶\nè·å–è¢«åˆ‡æ–¹æ³•çš„å‚æ•°ï¼Œå‚æ•°ä¸­çš„keyï¼Œç„¶åæ ¹æ®keyå»redisä¸­å»æŸ¥è¯¢\nServiceå±‚ redisæœåŠ¡æ¥å£\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 public interface RedisService { void set(String key, Object value); void set(String key, Object value, long expire); Object get(String key); void expire(String key, long expire); void delete(String key); // ç”±äºdaoæ¥å£åŒæ—¶ç»§æ‰¿äº†MongoRepositoryå’ŒGenericItemDaoï¼Œ // æ‰€ä»¥è¿™è¾¹å†™æ¥å£è°ƒç”¨ä»–ä»¬é˜²æ­¢ç»§æ‰¿å†²çª PortalItem insertItem(PortalItem item, ItemTypeEnum type); PortalItem saveItem(PortalItem item, ItemTypeEnum type); void deleteItem(PortalItem item, ItemTypeEnum type); } AopCacheEnableæµ‹è¯•\n1 2 3 4 public interface ModelItemDao extends MongoRepository\u003cModelItem,String\u003e, GenericItemDao\u003cModelItem\u003e { @AopCacheEnable(key = \"#id\", group = ItemTypeEnum.ModelItem) ModelItem findFirstById(String id); } AopCacheEvictæµ‹è¯•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 @Service(\"redisService\") public class RedisServiceImpl implements RedisService { @Autowired private RedisTemplate\u003cString, Object\u003e redisTemplate; @Autowired GenericService genericService; @Override public void set(String key, Object value) { redisTemplate.opsForValue().set(key, value); } @Override public void set(String key, Object value, long expire) { redisTemplate.opsForValue().set(key, value, expire, TimeUnit.SECONDS); } @Override public Object get(String key) { return redisTemplate.opsForValue().get(key); } @Override public void expire(String key, long expire) { redisTemplate.expire(key, expire, TimeUnit.SECONDS); } @Override public void delete(String key) { redisTemplate.delete(key); } @Override public PortalItem insertItem(PortalItem item, ItemTypeEnum type) { GenericItemDao itemDao = (GenericItemDao)genericService.daoFactory(type).get(\"itemDao\"); PortalItem result = (PortalItem)itemDao.insert(item); return result; } @Override @AopCacheEvict(key = \"#item.id\", group = \"#type\") public PortalItem saveItem(PortalItem item, ItemTypeEnum type) { GenericItemDao itemDao = (GenericItemDao)genericService.daoFactory(type).get(\"itemDao\"); PortalItem result = (PortalItem)itemDao.save(item); return result; } @Override public void deleteItem(PortalItem item, ItemTypeEnum type) { GenericItemDao itemDao = (GenericItemDao)genericService.daoFactory(type).get(\"itemDao\"); itemDao.delete(item); } } æµ‹è¯• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 @Test public void aopFindTest(){ for (int i = 0; i \u003c 5; i++) { ModelItem modelItem = modelItemDao.findFirstById(\"3f6857ba-c2d2-4e27-b220-6e5367803a12\"); System.out.println(modelItem); } } @Test public void aopSaveTest(){ ModelItem modelItem = modelItemDao.findFirstById(\"3f6857ba-c2d2-4e27-b220-6e5367803a12\"); modelItem.setThumbsUpCount(50); redisService.saveItem(modelItem,ItemTypeEnum.ModelItem); } é‡åˆ°çš„é—®é¢˜ é—®é¢˜ï¼š\nCould not safely identify store assignment for repository candidate interface æ¡ä»¶ï¼š ä½¿ç”¨äº†Spring data jpa ä½œä¸ºæŒä¹…å±‚æ¡†æ¶å¹¶åŒæ—¶ä½¿ç”¨starterå¼•å…¥äº†Elasticsearchæˆ–Redisä¾èµ–åŒ…ã€‚\nåŸå› ï¼š RedisRepositoriesAutoConfigurationæˆ–ElasticsearchRepositoriesAutoConfiguration é‡Œé¢çš„æ³¨è§£@ConditionalOnPropertyä¼šåˆ¤æ–­ spring.data.redis/elasticsearch.repositories.enabled è¿™ä¸ªé…ç½®é¡¹æ˜¯å¦å­˜åœ¨ã€‚è‹¥å­˜åœ¨ä¼šè‡ªåŠ¨æ‰«æç»§æ‰¿org.springframework.data.repository.Repositoryçš„å®ä½“Repositoryæ¥å£ã€‚\nè§£å†³åŠæ³•ï¼š\n1 2 3 4 5 6 7 8 spring: data: redis: repositories: enabled: false elasticsearch: repositories: enabled: false é—®é¢˜ï¼š\nRedisè·å–ç¼“å­˜å¼‚å¸¸ Resolved [java.lang.ClassCastException: java.util.LinkedHashMap cannot be cast to com.alibaba.fastjson.JSONObject]\nå‡ºç°åœºæ™¯ï¼š\nSpringBooté¡¹ç›®ä¸­ä½¿ç”¨Redisæ¥è¿›è¡Œç¼“å­˜ã€‚æŠŠæ•°æ®æ”¾åˆ°ç¼“å­˜ä¸­æ—¶æ²¡æœ‰é—®é¢˜ï¼Œä½†ä»ç¼“å­˜ä¸­å–å‡ºæ¥ååºåˆ—åŒ–ä¸ºå¯¹è±¡æ—¶æŠ¥é”™ï¼šâ€œjava.lang.ClassCastException: java.util.LinkedHashMap cannot be cast to xxxâ€ã€‚ï¼ˆxxxä¸ºååºåˆ—åŒ–çš„ç›®æ ‡å¯¹è±¡å¯¹åº”çš„ç±»ã€‚ï¼‰\nåªæœ‰è¿™ä¸ªç±»é‡Œæœ‰å…¶ä»–å¯¹è±¡å­—æ®µæ‰ä¼šæŠ¥è¿™ä¸ªé—®é¢˜ï¼Œå¦‚æœè¿™ä¸ªç±»é‡Œéƒ½æ˜¯åˆå§‹çš„ç±»å‹ï¼ˆæ¯”å¦‚ï¼šIntegerï¼ŒStringï¼‰åˆ™ä¸ä¼šæŠ¥è¿™ä¸ªé”™è¯¯ã€‚\nåªè¦ç”¨åˆ°Redisåºåˆ—åŒ–ååºåˆ—åŒ–çš„åœ°æ–¹éƒ½ä¼šé‡åˆ°è¿™ä¸ªé—®é¢˜ï¼Œæ¯”å¦‚ï¼šRedisTemplateï¼ŒRedissonï¼Œ@Cacheableæ³¨è§£ç­‰ã€‚\nåŸå› ï¼š\nSpringBoot çš„ç¼“å­˜ä½¿ç”¨ jackson æ¥åšæ•°æ®çš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–ï¼Œå¦‚æœé»˜è®¤ä½¿ç”¨ Object ä½œä¸ºåºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„ç±»å‹ï¼Œåˆ™å…¶åªèƒ½è¯†åˆ« java åŸºæœ¬ç±»å‹ï¼Œé‡åˆ°å¤æ‚ç±»å‹æ—¶ï¼Œjackson å°±ä¼šå…ˆåºåˆ—åŒ–æˆ LinkedHashMap ï¼Œç„¶åå†å°è¯•å¼ºè½¬ä¸ºæ‰€éœ€ç±»åˆ«ï¼Œè¿™æ ·å¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¼šå¼ºè½¬å¤±è´¥ã€‚\nè§£å†³æ–¹æ³•ï¼š\nå‡ºç°è¿™ç§å¼‚å¸¸ï¼Œéœ€è¦è‡ªå®šä¹‰ObjectMapperï¼Œè®¾ç½®ä¸€äº›å‚æ•°ï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨Jackson2JsonRedisSerializerç±»ä¸­é»™è®¤çš„ObjectMapperï¼Œçœ‹æºä»£ç å¯ä»¥çŸ¥é“ï¼ŒJackson2JsonRedisSerializerä¸­çš„ObjectMapperæ˜¯ç›´æ¥ä½¿ç”¨new ObjectMapper()åˆ›å»ºçš„ï¼Œè¿™æ ·ObjectMapperä¼šå°†Redisä¸­çš„å­—ç¬¦ä¸²ååºåˆ—åŒ–ä¸ºjava.util.LinkedHashMapç±»å‹ï¼Œå¯¼è‡´åç»­Springå¯¹å…¶è¿›è¡Œè½¬æ¢æˆæŠ¥é”™ã€‚å…¶å®æˆ‘ä»¬åªè¦å®ƒè¿”å›Objectç±»å‹å°±å¯ä»¥äº†ã€‚\nä¿®æ”¹RedisTemplateè¿™ä¸ªbeançš„valueSerializerï¼Œè®¾ç½®é»˜è®¤ç±»å‹ã€‚\nå‚è€ƒåšå®¢ï¼š\nhttps://blog.51cto.com/knifeedge/5010643\nä¿®æ”¹é…ç½®ç±»\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 @Configuration public class RedisConfig { @Bean public RedisTemplate\u003cString, Object\u003e template(RedisConnectionFactory factory) { // åˆ›å»ºRedisTemplateå¯¹è±¡ RedisTemplate\u003cString, Object\u003e template = new RedisTemplate\u003c\u003e(); // é…ç½®è¿æ¥å·¥å‚ template.setConnectionFactory(factory); // redis key åºåˆ—åŒ–æ–¹å¼ä½¿ç”¨stringSerial template.setKeySerializer(new StringRedisSerializer()); // redis value åºåˆ—åŒ–æ–¹å¼è‡ªå®šä¹‰ï¼Œä½¿ç”¨jacksonä¼šå‡ºç°è½¬æ¢ç±»å‹çš„é”™è¯¯ // template.setValueSerializer(new GenericFastJsonRedisSerializer()); template.setValueSerializer(valueSerializer()); // redis hash key åºåˆ—åŒ–æ–¹å¼ä½¿ç”¨stringSerial template.setHashKeySerializer(new StringRedisSerializer()); // redis hash value åºåˆ—åŒ–æ–¹å¼è‡ªå®šä¹‰ï¼Œä½¿ç”¨jacksonä¼šå‡ºç°è½¬æ¢ç±»å‹çš„é”™è¯¯ // template.setHashValueSerializer(new GenericFastJsonRedisSerializer()); template.setHashValueSerializer(valueSerializer()); return template; } private RedisSerializer\u003cObject\u003e valueSerializer() { Jackson2JsonRedisSerializer\u003cObject\u003e jackson2JsonRedisSerializer = new Jackson2JsonRedisSerializer\u003c\u003e(Object.class); ObjectMapper objectMapper = new ObjectMapper(); objectMapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY); // æ­¤é¡¹å¿…é¡»é…ç½®ï¼Œå¦åˆ™å¦‚æœåºåˆ—åŒ–çš„å¯¹è±¡é‡Œè¾¹è¿˜æœ‰å¯¹è±¡ï¼Œä¼šæŠ¥å¦‚ä¸‹é”™è¯¯ï¼š // java.lang.ClassCastException: java.util.LinkedHashMap cannot be cast to XXX objectMapper.activateDefaultTyping( objectMapper.getPolymorphicTypeValidator(), ObjectMapper.DefaultTyping.NON_FINAL, JsonTypeInfo.As.PROPERTY); // æ—§ç‰ˆå†™æ³•ï¼š // objectMapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL, JsonTypeInfo.As.PROPERTY); jackson2JsonRedisSerializer.setObjectMapper(objectMapper); return jackson2JsonRedisSerializer; } } é—®é¢˜ï¼š\næ³¨è§£ä¸ç”Ÿæ•ˆ ==æ³¨è§£ç”Ÿæ•ˆä»£ç ==\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 @UserCacheEnable(key = \"#email\") public JSONObject getItemUserInfoByEmail(String email) { User user = null; JSONObject userJson = new JSONObject(); if (email.contains(\"@\")){ user = userDao.findFirstByEmail(email); } else { user = userDao.findFirstByAccessId(email); if (user != null){ email = user.getEmail(); } else { userJson.put(\"name\", email); userJson.put(\"email\", null); userJson.put(\"accessId\", null); userJson.put(\"image\", null); return userJson; } } JSONObject userInfo = getInfoFromUserServer(email); userJson.put(\"name\", userInfo.getString(\"name\")); // userJson.put(\"id\", user.getId()); userJson.put(\"email\", user.getEmail()); userJson.put(\"accessId\", user.getAccessId()); // userJson.put(\"image\", user.getAvatar().equals(\"\") ? \"\" : htmlLoadPath + user.getAvatar()); userJson.put(\"image\", userInfo.getString(\"avatar\")); return userJson; } ==æ³¨è§£å¤±æ•ˆä»£ç ==\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 @UserCacheEnable(key = \"#email\") public JSONObject getInfoFromUserServer(String email){ // return getInfoFromUserServerPart(email); JSONObject jsonObject = new JSONObject(); try { RestTemplate restTemplate = new RestTemplate(); String userInfoUrl = \"http://\" + userServer + \"/user/\" + email + \"/\" + userServerCilent + \"/\" + userServerCilentPWD; HttpHeaders headers = new HttpHeaders(); MediaType mediaType = MediaType.parseMediaType(\"application/json;charset=UTF-8\"); headers.setContentType(mediaType); headers.set(\"user-agent\", \"portal_backend\"); HttpEntity httpEntity = new HttpEntity(headers); ResponseEntity\u003cJSONObject\u003e response = restTemplate.exchange(userInfoUrl, HttpMethod.GET, httpEntity, JSONObject.class); JSONObject userInfo = response.getBody().getJSONObject(\"data\"); String avatar = userInfo.getString(\"avatar\"); if(avatar!=null){ // avatar = \"/userServer\" + avatar; //ä¿®æ­£avatarå‰é¢åŠ äº†/userServer // avatar = avatar.replaceAll(\"/userServer\",\"\"); genericService.formatUserAvatar(avatar); } userInfo.put(\"avatar\",avatar); userInfo.put(\"msg\",\"suc\"); return userInfo; }catch(Exception e){ log.error(e.getMessage()); // System.out.println(e.fillInStackTrace()); jsonObject.put(\"msg\",\"no user\"); } return jsonObject; } åŸå› ï¼š\nSpring AOP æ³¨è§£ä¸ºä»€ä¹ˆå¤±æ•ˆï¼Ÿ\nå¦‚ä¸‹é¢å‡ ç§åœºæ™¯\n1ã€Controllerç›´æ¥è°ƒç”¨Service Bæ–¹æ³•ï¼šController \u003e Service A\nåœ¨Service A ä¸ŠåŠ @Transactionalçš„æ—¶å€™å¯ä»¥æ­£å¸¸å®ç°AOPåŠŸèƒ½ã€‚\n2ã€==Controllerè°ƒç”¨Service Aæ–¹æ³•ï¼ŒAå†è°ƒç”¨Bæ–¹æ³•ï¼šController \u003e Service A \u003e Service B==\nåœ¨Service Bä¸ŠåŠ @Transactionalçš„æ—¶å€™ä¸èƒ½å®ç°AOPåŠŸèƒ½ï¼Œå› ä¸º==åœ¨Service Aæ–¹æ³•ä¸­è°ƒç”¨Service Bæ–¹æ³•æƒ³å½“äºä½¿ç”¨this.B()ï¼Œthisä»£è¡¨çš„æ˜¯Serviceç±»æœ¬èº«ï¼Œå¹¶ä¸æ˜¯çœŸå®çš„ä»£ç†Serviceå¯¹è±¡==ï¼Œæ‰€ä»¥è¿™ç§ä¸èƒ½å®ç°ä»£ç†åŠŸèƒ½ã€‚\næ‰€ä»¥ï¼Œå¦‚æœä¸æ˜¯ç›´æ¥è°ƒç”¨çš„æ–¹å¼ï¼Œæ˜¯ä¸èƒ½å®ç°ä»£ç†åŠŸèƒ½çš„ï¼Œéå¸¸éœ€è¦æ³¨æ„ã€‚\n",
  "wordCount" : "4375",
  "inLanguage": "zh",
  "datePublished": "2023-05-31T22:37:33+08:00",
  "dateModified": "2023-05-31T22:37:33+08:00",
  "author":[{
    "@type": "Person",
    "name": "chance7bin"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://chance7bin.github.io/posts/design/spring-aop-%E5%AE%9E%E7%8E%B0-redis-%E7%BC%93%E5%AD%98%E5%88%87%E9%9D%A2/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Binb's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://chance7bin.github.io/" accesskey="h" title="Binb&#39;s Blog (Alt + H)">
                <img src="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg" alt="" aria-label="logo"
                    height="35">Binb&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://chance7bin.github.io/search" title="ğŸ”æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ”æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="https://chance7bin.github.io/" title="ğŸ  ä¸»é¡µ">
                    <span>ğŸ  ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://chance7bin.github.io/archives/" title="â±ï¸ æ—¶é—´è½´">
                    <span>â±ï¸ æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://chance7bin.github.io/posts" title="ğŸ“š æ–‡ç« ">
                    <span>ğŸ“š æ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://chance7bin.github.io/tags" title="ğŸ”– æ ‡ç­¾">
                    <span>ğŸ”– æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://github.com/chance7bin" title="GitHub">
                    <span>GitHub</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://chance7bin.github.io/">ğŸ  ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://chance7bin.github.io/posts/">ğŸ“š æ–‡ç« </a>&nbsp;Â»&nbsp;<a href="https://chance7bin.github.io/posts/design/">ğŸ¨ ç³»ç»Ÿè®¾è®¡</a></div>
    <h1 class="post-title">
      Spring AOP å®ç° Redis ç¼“å­˜åˆ‡é¢
    </h1>
    <div class="post-meta">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">


<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }

    .parent-post-meta {
        display: flex;
        flex-wrap: wrap;
        opacity: 0.8;
    }
</style>

<span class="parent-post-meta">
    <span id="post_meta_style_1">
        <span class="fa fa-calendar-check-o"></span>
        <span>2023-05-31
            &nbsp;&nbsp;
        </span>
    </span>
    
    
    
    
    
    
    
    <span id="post_meta_style_3">
        <span class="fa fa-file-word-o"></span>
        <span>4375å­—
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_4">
        <span class="fa fa-clock-o"></span>
        <span>9åˆ†é’Ÿ
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_5">
        <span class="fa fa-user-o"></span>
        <span>chance7bin
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_6">
        <span class="fa fa-tags" style="opacity: 0.8"></span>
        <span>
            <span class="post-tags-meta">
                <a href="https://chance7bin.github.io/tags/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/" style="color: var(--secondary)!important;">ç³»ç»Ÿè®¾è®¡</a>
                &nbsp;<a href="https://chance7bin.github.io/tags/%E7%BC%93%E5%AD%98/" style="color: var(--secondary)!important;">ç¼“å­˜</a>
            </span>
        </span>
    </span>

    
</span>


      
      
      
      
      
      
      
          
          
          
              
              
              
              
          
      
    </div>
  </header>
   <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#enablecaching" aria-label="@EnableCaching">@EnableCaching</a></li>
                    <li>
                        <a href="#%e5%8f%82%e8%80%83%e5%8d%9a%e5%ae%a2" aria-label="å‚è€ƒåšå®¢">å‚è€ƒåšå®¢</a></li>
                    <li>
                        <a href="#%e6%b7%bb%e5%8a%a0%e4%be%9d%e8%b5%96" aria-label="æ·»åŠ ä¾èµ–">æ·»åŠ ä¾èµ–</a></li>
                    <li>
                        <a href="#yml%e9%85%8d%e7%bd%ae" aria-label="ymlé…ç½®">ymlé…ç½®</a></li>
                    <li>
                        <a href="#%e4%bb%a3%e7%a0%81" aria-label="ä»£ç ">ä»£ç </a><ul>
                            
                    <li>
                        <a href="#%e8%87%aa%e5%ae%9a%e4%b9%89redistemplate" aria-label="è‡ªå®šä¹‰RedisTemplate">è‡ªå®šä¹‰RedisTemplate</a></li>
                    <li>
                        <a href="#redis%e7%bc%93%e5%ad%98%e6%b3%a8%e8%a7%a3%e6%8f%92%e5%85%a5" aria-label="redisç¼“å­˜æ³¨è§£ï¼šæ’å…¥"><strong>redisç¼“å­˜æ³¨è§£ï¼šæ’å…¥</strong></a></li>
                    <li>
                        <a href="#redis%e7%bc%93%e5%ad%98%e6%b3%a8%e8%a7%a3%e5%88%a0%e9%99%a4" aria-label="redisç¼“å­˜æ³¨è§£ï¼šåˆ é™¤"><strong>redisç¼“å­˜æ³¨è§£ï¼šåˆ é™¤</strong></a></li>
                    <li>
                        <a href="#%e8%87%aa%e5%ae%9a%e4%b9%89%e7%bc%93%e5%ad%98%e5%88%87%e9%9d%a2%e5%85%b7%e4%bd%93%e5%ae%9e%e7%8e%b0%e7%b1%bb" aria-label="è‡ªå®šä¹‰ç¼“å­˜åˆ‡é¢å…·ä½“å®ç°ç±»"><strong>è‡ªå®šä¹‰ç¼“å­˜åˆ‡é¢å…·ä½“å®ç°ç±»</strong></a></li>
                    <li>
                        <a href="#service%e5%b1%82" aria-label="Serviceå±‚"><strong>Serviceå±‚</strong></a></li></ul>
                    </li>
                    <li>
                        <a href="#%e6%b5%8b%e8%af%95" aria-label="æµ‹è¯•">æµ‹è¯•</a></li>
                    <li>
                        <a href="#%e9%81%87%e5%88%b0%e7%9a%84%e9%97%ae%e9%a2%98" aria-label="é‡åˆ°çš„é—®é¢˜">é‡åˆ°çš„é—®é¢˜</a><ul>
                            
                    <li>
                        <a href="#could-not-safely-identify-store-assignment-for-repository-candidate-interface" aria-label="Could not safely identify store assignment for repository candidate interface"><strong>Could not safely identify store assignment for repository candidate interface</strong></a></li>
                    <li>
                        <a href="#redis%e8%8e%b7%e5%8f%96%e7%bc%93%e5%ad%98%e5%bc%82%e5%b8%b8" aria-label="Redisè·å–ç¼“å­˜å¼‚å¸¸">Redisè·å–ç¼“å­˜å¼‚å¸¸</a></li>
                    <li>
                        <a href="#%e6%b3%a8%e8%a7%a3%e4%b8%8d%e7%94%9f%e6%95%88" aria-label="æ³¨è§£ä¸ç”Ÿæ•ˆ"><strong>æ³¨è§£ä¸ç”Ÿæ•ˆ</strong></a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>
  <div class="post-content"><h3 id="enablecaching">@EnableCaching<a hidden class="anchor" aria-hidden="true" href="#enablecaching">#</a></h3>
<p>spring bootæä¾›äº†æ¯”è¾ƒç®€å•çš„ç¼“å­˜æ–¹æ¡ˆã€‚åªè¦ä½¿ç”¨ <code>@EnableCaching</code> å³å¯å®Œæˆç®€å•çš„ç¼“å­˜åŠŸèƒ½ã€‚</p>
<p><a href="https://blog.csdn.net/micro_hz/article/details/76599632">https://blog.csdn.net/micro_hz/article/details/76599632</a></p>
<h3 id="å‚è€ƒåšå®¢">å‚è€ƒåšå®¢<a hidden class="anchor" aria-hidden="true" href="#å‚è€ƒåšå®¢">#</a></h3>
<p><a href="https://zhuanlan.zhihu.com/p/161705262">Springçš„é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼ˆAOPï¼‰</a></p>
<p><a href="https://blog.csdn.net/qq_36160730/article/details/109326302">Spring AOP å®ç° Redis ç¼“å­˜åˆ‡é¢</a></p>
<p><a href="https://blog.csdn.net/BADAO_LIUMANG_QIZHI/article/details/118267333">SpringBootä¸­é€šè¿‡è‡ªå®šä¹‰ç¼“å­˜æ³¨è§£(AOPåˆ‡é¢æ‹¦æˆª)å®ç°æ•°æ®åº“æ•°æ®ç¼“å­˜åˆ°Redis</a></p>
<p><a href="https://www.cnblogs.com/caizhaokai/p/11037610.html">SpringBoot + Redisï¼šåŸºæœ¬é…ç½®åŠä½¿ç”¨</a></p>
<p><a href="https://blog.csdn.net/qq_24434671/article/details/101615398">Springä¸­è‡ªå®šä¹‰æ³¨è§£æ”¯æŒSpElè¡¨è¾¾å¼ï¼ˆä»…é™åœ¨AOPä¸­ä½¿ç”¨ï¼‰</a></p>
<h3 id="æ·»åŠ ä¾èµ–">æ·»åŠ ä¾èµ–<a hidden class="anchor" aria-hidden="true" href="#æ·»åŠ ä¾èµ–">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!--redis--&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c">&lt;!--spring2.0é›†æˆredisæ‰€éœ€common-pool2--&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>org.apache.commons<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>commons-pool2<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>2.8.1<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c">&lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-aspects --&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>spring-aspects<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>4.3.14.RELEASE<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ymlé…ç½®">ymlé…ç½®<a hidden class="anchor" aria-hidden="true" href="#ymlé…ç½®">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">redis</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">repositories</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">redis</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Redisé»˜è®¤æƒ…å†µä¸‹æœ‰16ä¸ªåˆ†ç‰‡ï¼Œè¿™é‡Œé…ç½®å…·ä½“ä½¿ç”¨çš„åˆ†ç‰‡ï¼Œé»˜è®¤æ˜¯0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">database</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">localhost</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">6379</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># è¿æ¥å¯†ç ï¼ˆé»˜è®¤ä¸ºç©ºï¼‰</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">password</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l">10000ms</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">lettuce</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">pool</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># è¿æ¥æ± æœ€å¤§è¿æ¥æ•°ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰ é»˜è®¤ 8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">max-active</span><span class="p">:</span><span class="w"> </span><span class="m">8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># è¿æ¥æ± æœ€å¤§é˜»å¡ç­‰å¾…æ—¶é—´ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰ é»˜è®¤ -1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">max-wait</span><span class="p">:</span><span class="w"> </span>-<span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># è¿æ¥æ± ä¸­çš„æœ€å¤§ç©ºé—²è¿æ¥ é»˜è®¤ 8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">max-idle</span><span class="p">:</span><span class="w"> </span><span class="m">8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># è¿æ¥æ± ä¸­çš„æœ€å°ç©ºé—²è¿æ¥ é»˜è®¤ 0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">min-idle</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ä»£ç ">ä»£ç <a hidden class="anchor" aria-hidden="true" href="#ä»£ç ">#</a></h3>
<h4 id="è‡ªå®šä¹‰redistemplate">è‡ªå®šä¹‰RedisTemplate<a hidden class="anchor" aria-hidden="true" href="#è‡ªå®šä¹‰redistemplate">#</a></h4>
<p>ä½¿ç”¨fastjsonè¿›è¡Œåºåˆ—åŒ–</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">njgis.opengms.portal.config</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.fasterxml.jackson.annotation.JsonAutoDetect</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.fasterxml.jackson.annotation.JsonTypeInfo</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.fasterxml.jackson.annotation.PropertyAccessor</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.fasterxml.jackson.databind.ObjectMapper</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.data.redis.connection.RedisConnectionFactory</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.data.redis.core.RedisTemplate</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.data.redis.serializer.RedisSerializer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.data.redis.serializer.StringRedisSerializer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @Description
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @Author bin
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @Date 2022/07/19
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisConfig</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">RedisTemplate</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="nf">template</span><span class="o">(</span><span class="n">RedisConnectionFactory</span> <span class="n">factory</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// åˆ›å»ºRedisTemplate&lt;String, Object&gt;å¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">RedisTemplate</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">template</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RedisTemplate</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// é…ç½®è¿æ¥å·¥å‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">template</span><span class="o">.</span><span class="na">setConnectionFactory</span><span class="o">(</span><span class="n">factory</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// redis key åºåˆ—åŒ–æ–¹å¼ä½¿ç”¨stringSerial
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">template</span><span class="o">.</span><span class="na">setKeySerializer</span><span class="o">(</span><span class="k">new</span> <span class="n">StringRedisSerializer</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// redis value åºåˆ—åŒ–æ–¹å¼è‡ªå®šä¹‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// template.setValueSerializer(new GenericFastJsonRedisSerializer());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">template</span><span class="o">.</span><span class="na">setValueSerializer</span><span class="o">(</span><span class="n">valueSerializer</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// redis hash key åºåˆ—åŒ–æ–¹å¼ä½¿ç”¨stringSerial
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">template</span><span class="o">.</span><span class="na">setHashKeySerializer</span><span class="o">(</span><span class="k">new</span> <span class="n">StringRedisSerializer</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// redis hash value åºåˆ—åŒ–æ–¹å¼è‡ªå®šä¹‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// template.setHashValueSerializer(new GenericFastJsonRedisSerializer());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">template</span><span class="o">.</span><span class="na">setHashValueSerializer</span><span class="o">(</span><span class="n">valueSerializer</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">template</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">RedisSerializer</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">valueSerializer</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Jackson2JsonRedisSerializer</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">jackson2JsonRedisSerializer</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">Jackson2JsonRedisSerializer</span><span class="o">&lt;&gt;(</span><span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ObjectMapper</span> <span class="n">objectMapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectMapper</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">objectMapper</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="n">PropertyAccessor</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span> <span class="n">JsonAutoDetect</span><span class="o">.</span><span class="na">Visibility</span><span class="o">.</span><span class="na">ANY</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// æ­¤é¡¹å¿…é¡»é…ç½®ï¼Œå¦åˆ™å¦‚æœåºåˆ—åŒ–çš„å¯¹è±¡é‡Œè¾¹è¿˜æœ‰å¯¹è±¡ï¼Œä¼šæŠ¥å¦‚ä¸‹é”™è¯¯ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//     java.lang.ClassCastException: java.util.LinkedHashMap cannot be cast to XXX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">objectMapper</span><span class="o">.</span><span class="na">activateDefaultTyping</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">objectMapper</span><span class="o">.</span><span class="na">getPolymorphicTypeValidator</span><span class="o">(),</span>
</span></span><span class="line"><span class="cl">            <span class="n">ObjectMapper</span><span class="o">.</span><span class="na">DefaultTyping</span><span class="o">.</span><span class="na">NON_FINAL</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">JsonTypeInfo</span><span class="o">.</span><span class="na">As</span><span class="o">.</span><span class="na">PROPERTY</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ—§ç‰ˆå†™æ³•ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// objectMapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL, JsonTypeInfo.As.PROPERTY);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="n">jackson2JsonRedisSerializer</span><span class="o">.</span><span class="na">setObjectMapper</span><span class="o">(</span><span class="n">objectMapper</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">jackson2JsonRedisSerializer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="redisç¼“å­˜æ³¨è§£æ’å…¥"><strong>redisç¼“å­˜æ³¨è§£ï¼šæ’å…¥</strong><a hidden class="anchor" aria-hidden="true" href="#redisç¼“å­˜æ³¨è§£æ’å…¥">#</a></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">njgis.opengms.portal.enums.ItemTypeEnum</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.lang.annotation.ElementType</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.lang.annotation.RetentionPolicy</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @Description æ–°å¢redisç¼“å­˜
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @Author bin
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @Date 2022/07/19
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Target</span><span class="o">(</span><span class="n">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="nd">@interface</span> <span class="n">AopCacheEnable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//redisç¼“å­˜key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">String</span> <span class="nf">key</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//redisç¼“å­˜å­˜æ´»æ—¶é—´é»˜è®¤å€¼ï¼ˆå¯è‡ªå®šä¹‰ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">long</span> <span class="nf">expireTime</span><span class="o">()</span> <span class="k">default</span> <span class="mi">3600</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//redisç¼“å­˜çš„åˆ†ç»„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ItemTypeEnum</span> <span class="nf">group</span><span class="o">()</span> <span class="k">default</span> <span class="n">ItemTypeEnum</span><span class="o">.</span><span class="na">PortalItem</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="redisç¼“å­˜æ³¨è§£åˆ é™¤"><strong>redisç¼“å­˜æ³¨è§£ï¼šåˆ é™¤</strong><a hidden class="anchor" aria-hidden="true" href="#redisç¼“å­˜æ³¨è§£åˆ é™¤">#</a></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.lang.annotation.ElementType</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.lang.annotation.RetentionPolicy</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @Description
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @Author bin
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @Date 2022/07/19
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Target</span><span class="o">(</span><span class="n">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="nd">@interface</span> <span class="n">AopCacheEvict</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//redisä¸­çš„keyå€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">String</span> <span class="nf">key</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//redisç¼“å­˜çš„åˆ†ç»„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">String</span> <span class="nf">group</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="è‡ªå®šä¹‰ç¼“å­˜åˆ‡é¢å…·ä½“å®ç°ç±»"><strong>è‡ªå®šä¹‰ç¼“å­˜åˆ‡é¢å…·ä½“å®ç°ç±»</strong><a hidden class="anchor" aria-hidden="true" href="#è‡ªå®šä¹‰ç¼“å­˜åˆ‡é¢å…·ä½“å®ç°ç±»">#</a></h4>
<p>CacheEnableAspect.java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">njgis.opengms.portal.enums.ItemTypeEnum</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">njgis.opengms.portal.service.RedisService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.aspectj.lang.ProceedingJoinPoint</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.aspectj.lang.Signature</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Around</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Aspect</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Pointcut</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.aspectj.lang.reflect.MethodSignature</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.core.DefaultParameterNameDiscoverer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.expression.EvaluationContext</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.expression.Expression</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.expression.spel.standard.SpelExpressionParser</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.expression.spel.support.StandardEvaluationContext</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @Description è‡ªå®šä¹‰ç¼“å­˜åˆ‡é¢å…·ä½“å®ç°ç±»
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @Author bin
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @Date 2022/07/19
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Aspect</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Component</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CacheEnableAspect</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="n">RedisService</span> <span class="n">redisService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * ç”¨äºSpELè¡¨è¾¾å¼è§£æ.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">SpelExpressionParser</span> <span class="n">parser</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SpelExpressionParser</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * ç”¨äºè·å–æ–¹æ³•å‚æ•°å®šä¹‰åå­—.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">DefaultParameterNameDiscoverer</span> <span class="n">nameDiscoverer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultParameterNameDiscoverer</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Mapperå±‚åˆ‡ç‚¹ ä½¿ç”¨åˆ°äº†æˆ‘ä»¬å®šä¹‰çš„ AopCacheEnable ä½œä¸ºåˆ‡ç‚¹è¡¨è¾¾å¼ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Pointcut</span><span class="o">(</span><span class="s">&#34;@annotation(njgis.opengms.portal.component.AopCacheEnable)&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">queryCache</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Mapperå±‚åˆ‡ç‚¹ ä½¿ç”¨åˆ°äº†æˆ‘ä»¬å®šä¹‰çš„ AopCacheEvict ä½œä¸ºåˆ‡ç‚¹è¡¨è¾¾å¼ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Pointcut</span><span class="o">(</span><span class="s">&#34;@annotation(njgis.opengms.portal.component.AopCacheEvict)&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">ClearCache</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Around</span><span class="o">(</span><span class="s">&#34;queryCache()&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">Interceptor</span><span class="o">(</span><span class="n">ProceedingJoinPoint</span> <span class="n">pjp</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// StringBuilder redisKeySb = new StringBuilder(&#34;AOP&#34;).append(&#34;::&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">StringBuilder</span> <span class="n">redisKeySb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">(</span><span class="s">&#34;AOP&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// ç±»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// String className = pjp.getTarget().toString().split(&#34;@&#34;)[0];
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// redisKeySb.append(className).append(&#34;::&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1">//è·å–å½“å‰è¢«åˆ‡æ³¨è§£çš„æ–¹æ³•å
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">getMethod</span><span class="o">(</span><span class="n">pjp</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//è·å–å½“å‰è¢«åˆ‡æ–¹æ³•çš„æ³¨è§£
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">AopCacheEnable</span> <span class="n">aopCacheEnable</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="n">AopCacheEnable</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">aopCacheEnable</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">pjp</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//è·å–è¢«åˆ‡æ³¨è§£æ–¹æ³•è¿”å›ç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Type returnType = method.getAnnotatedReturnType().getType();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// String[] split = returnType.getTypeName().split(&#34;\\.&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// String type = split[split.length - 1];
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// redisKeySb.append(&#34;:&#34;).append(type);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1">//ä»æ³¨è§£ä¸­è·å–key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//é€šè¿‡æ³¨è§£keyä½¿ç”¨çš„SpELè¡¨è¾¾å¼è·å–åˆ°SpELæ‰§è¡Œç»“æœ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">aopCacheEnable</span><span class="o">.</span><span class="na">key</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// redisKeySb.append(args);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">resV</span> <span class="o">=</span> <span class="n">generateKeyBySpEL</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">pjp</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">redisKeySb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&#34;:&#34;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">aopCacheEnable</span><span class="o">.</span><span class="na">group</span><span class="o">()).</span><span class="na">append</span><span class="o">(</span><span class="s">&#34;:&#34;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">resV</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//è·å–æ–¹æ³•å‚æ•°å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Object[] arguments = pjp.getArgs();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// redisKeySb.append(&#34;:&#34;).append(arguments[0]);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">redisKey</span> <span class="o">=</span> <span class="n">redisKeySb</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">redisService</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">redisKey</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;ä»Redisä¸­è·å–æ•°æ®ï¼š{}&#34;</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">result</span> <span class="o">=</span> <span class="n">pjp</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;ä»æ•°æ®åº“ä¸­è·å–æ•°æ®ï¼š{}&#34;</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// è·å–å¤±æ•ˆæ—¶é—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">long</span> <span class="n">expire</span> <span class="o">=</span> <span class="n">aopCacheEnable</span><span class="o">.</span><span class="na">expireTime</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">redisService</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">redisKey</span><span class="o">,</span> <span class="n">result</span><span class="o">,</span> <span class="n">expire</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/*** å®šä¹‰æ¸…é™¤ç¼“å­˜é€»è¾‘ï¼Œå…ˆæ“ä½œæ•°æ®åº“ï¼Œåæ¸…é™¤ç¼“å­˜*/</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Around</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;ClearCache()&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">evict</span><span class="o">(</span><span class="n">ProceedingJoinPoint</span> <span class="n">pjp</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">StringBuilder</span> <span class="n">redisKeySb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">(</span><span class="s">&#34;AOP&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">getMethod</span><span class="o">(</span><span class="n">pjp</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// è·å–æ–¹æ³•çš„æ³¨è§£
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">AopCacheEvict</span> <span class="n">cacheEvict</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="n">AopCacheEvict</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">cacheEvict</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">pjp</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//ä»æ³¨è§£ä¸­è·å–key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//é€šè¿‡æ³¨è§£keyä½¿ç”¨çš„SpELè¡¨è¾¾å¼è·å–åˆ°SpELæ‰§è¡Œç»“æœ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">cacheEvict</span><span class="o">.</span><span class="na">key</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// redisKeySb.append(args);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">key</span> <span class="o">=</span> <span class="n">generateKeyBySpEL</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">pjp</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//æ¸…æ¥šç¼“å­˜çš„groupä»å‚æ•°æ‹¿
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">group</span> <span class="o">=</span> <span class="n">cacheEvict</span><span class="o">.</span><span class="na">group</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">ItemTypeEnum</span> <span class="n">type</span> <span class="o">=</span> <span class="o">(</span><span class="n">ItemTypeEnum</span><span class="o">)</span><span class="n">generateKeyBySpEL</span><span class="o">(</span><span class="n">group</span><span class="o">,</span> <span class="n">pjp</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">redisKeySb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&#34;:&#34;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">type</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">&#34;:&#34;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//å…ˆæ“ä½œdb
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">pjp</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//æ ¹æ®keyä»ç¼“å­˜ä¸­åˆ é™¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">redisKey</span> <span class="o">=</span> <span class="n">redisKeySb</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">redisService</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">redisKey</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * è·å–è¢«æ‹¦æˆªæ–¹æ³•å¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Method</span> <span class="nf">getMethod</span><span class="o">(</span><span class="n">ProceedingJoinPoint</span> <span class="n">pjp</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Signature</span> <span class="n">signature</span> <span class="o">=</span> <span class="n">pjp</span><span class="o">.</span><span class="na">getSignature</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">MethodSignature</span> <span class="n">methodSignature</span> <span class="o">=</span> <span class="o">(</span><span class="n">MethodSignature</span><span class="o">)</span> <span class="n">signature</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">Method</span> <span class="n">targetMethod</span> <span class="o">=</span> <span class="n">methodSignature</span><span class="o">.</span><span class="na">getMethod</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">targetMethod</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">generateKeyBySpEL</span><span class="o">(</span><span class="n">String</span> <span class="n">spELString</span><span class="o">,</span> <span class="n">ProceedingJoinPoint</span> <span class="n">joinPoint</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">MethodSignature</span> <span class="n">methodSignature</span> <span class="o">=</span> <span class="o">(</span><span class="n">MethodSignature</span><span class="o">)</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">getSignature</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span><span class="o">[]</span> <span class="n">paramNames</span> <span class="o">=</span> <span class="n">nameDiscoverer</span><span class="o">.</span><span class="na">getParameterNames</span><span class="o">(</span><span class="n">methodSignature</span><span class="o">.</span><span class="na">getMethod</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">Expression</span> <span class="n">expression</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="na">parseExpression</span><span class="o">(</span><span class="n">spELString</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">EvaluationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StandardEvaluationContext</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">getArgs</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">context</span><span class="o">.</span><span class="na">setVariable</span><span class="o">(</span><span class="n">paramNames</span><span class="o">[</span><span class="n">i</span><span class="o">],</span> <span class="n">args</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">expression</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ³¨æ„è¿™é‡Œçš„queryCacheå’ŒClearCacheï¼Œé‡Œé¢åˆ‡ç‚¹è¡¨è¾¾å¼</p>
<p>åˆ†åˆ«å¯¹åº”ä¸Šé¢è‡ªå®šä¹‰çš„ä¸¤ä¸ªAopCacheEnableå’ŒAopCacheEvictã€‚</p>
<p>ç„¶ååœ¨ç¯ç»•é€šçŸ¥çš„queryCacheæ–¹æ³•æ‰§è¡Œå‰åæ—¶</p>
<p>è·å–è¢«åˆ‡æ–¹æ³•çš„å‚æ•°ï¼Œå‚æ•°ä¸­çš„keyï¼Œç„¶åæ ¹æ®keyå»redisä¸­å»æŸ¥è¯¢</p>
<h4 id="serviceå±‚"><strong>Serviceå±‚</strong><a hidden class="anchor" aria-hidden="true" href="#serviceå±‚">#</a></h4>
<p>redisæœåŠ¡æ¥å£</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">RedisService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">,</span> <span class="kt">long</span> <span class="n">expire</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Object</span> <span class="nf">get</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">expire</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="kt">long</span> <span class="n">expire</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">delete</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ç”±äºdaoæ¥å£åŒæ—¶ç»§æ‰¿äº†MongoRepositoryå’ŒGenericItemDaoï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ‰€ä»¥è¿™è¾¹å†™æ¥å£è°ƒç”¨ä»–ä»¬é˜²æ­¢ç»§æ‰¿å†²çª
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">PortalItem</span> <span class="nf">insertItem</span><span class="o">(</span><span class="n">PortalItem</span> <span class="n">item</span><span class="o">,</span> <span class="n">ItemTypeEnum</span> <span class="n">type</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">PortalItem</span> <span class="nf">saveItem</span><span class="o">(</span><span class="n">PortalItem</span> <span class="n">item</span><span class="o">,</span> <span class="n">ItemTypeEnum</span> <span class="n">type</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">deleteItem</span><span class="o">(</span><span class="n">PortalItem</span> <span class="n">item</span><span class="o">,</span> <span class="n">ItemTypeEnum</span> <span class="n">type</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>AopCacheEnableæµ‹è¯•</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ModelItemDao</span> <span class="kd">extends</span> <span class="n">MongoRepository</span><span class="o">&lt;</span><span class="n">ModelItem</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;,</span> <span class="n">GenericItemDao</span><span class="o">&lt;</span><span class="n">ModelItem</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@AopCacheEnable</span><span class="o">(</span><span class="n">key</span> <span class="o">=</span> <span class="s">&#34;#id&#34;</span><span class="o">,</span> <span class="n">group</span> <span class="o">=</span> <span class="n">ItemTypeEnum</span><span class="o">.</span><span class="na">ModelItem</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ModelItem</span> <span class="nf">findFirstById</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>AopCacheEvictæµ‹è¯•</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Service</span><span class="o">(</span><span class="s">&#34;redisService&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisServiceImpl</span> <span class="kd">implements</span> <span class="n">RedisService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">RedisTemplate</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">redisTemplate</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="n">GenericService</span> <span class="n">genericService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">,</span> <span class="kt">long</span> <span class="n">expire</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="n">expire</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">get</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">expire</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="kt">long</span> <span class="n">expire</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">expire</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">expire</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">delete</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">PortalItem</span> <span class="nf">insertItem</span><span class="o">(</span><span class="n">PortalItem</span> <span class="n">item</span><span class="o">,</span> <span class="n">ItemTypeEnum</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">GenericItemDao</span> <span class="n">itemDao</span> <span class="o">=</span> <span class="o">(</span><span class="n">GenericItemDao</span><span class="o">)</span><span class="n">genericService</span><span class="o">.</span><span class="na">daoFactory</span><span class="o">(</span><span class="n">type</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;itemDao&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">PortalItem</span> <span class="n">result</span> <span class="o">=</span> <span class="o">(</span><span class="n">PortalItem</span><span class="o">)</span><span class="n">itemDao</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">item</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@AopCacheEvict</span><span class="o">(</span><span class="n">key</span> <span class="o">=</span> <span class="s">&#34;#item.id&#34;</span><span class="o">,</span> <span class="n">group</span> <span class="o">=</span> <span class="s">&#34;#type&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">PortalItem</span> <span class="nf">saveItem</span><span class="o">(</span><span class="n">PortalItem</span> <span class="n">item</span><span class="o">,</span> <span class="n">ItemTypeEnum</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">GenericItemDao</span> <span class="n">itemDao</span> <span class="o">=</span> <span class="o">(</span><span class="n">GenericItemDao</span><span class="o">)</span><span class="n">genericService</span><span class="o">.</span><span class="na">daoFactory</span><span class="o">(</span><span class="n">type</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;itemDao&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">PortalItem</span> <span class="n">result</span> <span class="o">=</span> <span class="o">(</span><span class="n">PortalItem</span><span class="o">)</span><span class="n">itemDao</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">item</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteItem</span><span class="o">(</span><span class="n">PortalItem</span> <span class="n">item</span><span class="o">,</span> <span class="n">ItemTypeEnum</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">GenericItemDao</span> <span class="n">itemDao</span> <span class="o">=</span> <span class="o">(</span><span class="n">GenericItemDao</span><span class="o">)</span><span class="n">genericService</span><span class="o">.</span><span class="na">daoFactory</span><span class="o">(</span><span class="n">type</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;itemDao&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">itemDao</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">item</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æµ‹è¯•">æµ‹è¯•<a hidden class="anchor" aria-hidden="true" href="#æµ‹è¯•">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Test</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">aopFindTest</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ModelItem</span> <span class="n">modelItem</span> <span class="o">=</span> <span class="n">modelItemDao</span><span class="o">.</span><span class="na">findFirstById</span><span class="o">(</span><span class="s">&#34;3f6857ba-c2d2-4e27-b220-6e5367803a12&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">modelItem</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Test</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">aopSaveTest</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="n">ModelItem</span> <span class="n">modelItem</span> <span class="o">=</span> <span class="n">modelItemDao</span><span class="o">.</span><span class="na">findFirstById</span><span class="o">(</span><span class="s">&#34;3f6857ba-c2d2-4e27-b220-6e5367803a12&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">modelItem</span><span class="o">.</span><span class="na">setThumbsUpCount</span><span class="o">(</span><span class="mi">50</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">redisService</span><span class="o">.</span><span class="na">saveItem</span><span class="o">(</span><span class="n">modelItem</span><span class="o">,</span><span class="n">ItemTypeEnum</span><span class="o">.</span><span class="na">ModelItem</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="é‡åˆ°çš„é—®é¢˜">é‡åˆ°çš„é—®é¢˜<a hidden class="anchor" aria-hidden="true" href="#é‡åˆ°çš„é—®é¢˜">#</a></h3>
<p><strong>é—®é¢˜ï¼š</strong></p>
<h4 id="could-not-safely-identify-store-assignment-for-repository-candidate-interface"><strong>Could not safely identify store assignment for repository candidate interface</strong><a hidden class="anchor" aria-hidden="true" href="#could-not-safely-identify-store-assignment-for-repository-candidate-interface">#</a></h4>
<p><strong>æ¡ä»¶ï¼š</strong>
ä½¿ç”¨äº†Spring data jpa ä½œä¸ºæŒä¹…å±‚æ¡†æ¶å¹¶åŒæ—¶ä½¿ç”¨starterå¼•å…¥äº†Elasticsearchæˆ–Redisä¾èµ–åŒ…ã€‚</p>
<p><strong>åŸå› ï¼š</strong>
RedisRepositoriesAutoConfigurationæˆ–ElasticsearchRepositoriesAutoConfiguration é‡Œé¢çš„æ³¨è§£@ConditionalOnPropertyä¼šåˆ¤æ–­ spring.data.redis/elasticsearch.repositories.enabled è¿™ä¸ªé…ç½®é¡¹æ˜¯å¦å­˜åœ¨ã€‚è‹¥å­˜åœ¨ä¼šè‡ªåŠ¨æ‰«æç»§æ‰¿org.springframework.data.repository.Repositoryçš„å®ä½“Repositoryæ¥å£ã€‚</p>
<p><strong>è§£å†³åŠæ³•ï¼š</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">redis</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">repositories</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">elasticsearch</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">repositories</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>é—®é¢˜ï¼š</strong></p>
<h4 id="redisè·å–ç¼“å­˜å¼‚å¸¸">Redisè·å–ç¼“å­˜å¼‚å¸¸<a hidden class="anchor" aria-hidden="true" href="#redisè·å–ç¼“å­˜å¼‚å¸¸">#</a></h4>
<p><strong>Resolved [java.lang.ClassCastException: java.util.LinkedHashMap cannot be cast to com.alibaba.fastjson.JSONObject]</strong></p>
<p><strong>å‡ºç°åœºæ™¯ï¼š</strong></p>
<p>SpringBooté¡¹ç›®ä¸­ä½¿ç”¨Redisæ¥è¿›è¡Œç¼“å­˜ã€‚æŠŠæ•°æ®æ”¾åˆ°ç¼“å­˜ä¸­æ—¶æ²¡æœ‰é—®é¢˜ï¼Œä½†ä»ç¼“å­˜ä¸­å–å‡ºæ¥ååºåˆ—åŒ–ä¸ºå¯¹è±¡æ—¶æŠ¥é”™ï¼šâ€œjava.lang.ClassCastException: java.util.LinkedHashMap cannot be cast to xxxâ€ã€‚ï¼ˆxxxä¸ºååºåˆ—åŒ–çš„ç›®æ ‡å¯¹è±¡å¯¹åº”çš„ç±»ã€‚ï¼‰</p>
<p>åªæœ‰è¿™ä¸ªç±»é‡Œæœ‰å…¶ä»–å¯¹è±¡å­—æ®µæ‰ä¼šæŠ¥è¿™ä¸ªé—®é¢˜ï¼Œå¦‚æœè¿™ä¸ªç±»é‡Œéƒ½æ˜¯åˆå§‹çš„ç±»å‹ï¼ˆæ¯”å¦‚ï¼šIntegerï¼ŒStringï¼‰åˆ™ä¸ä¼šæŠ¥è¿™ä¸ªé”™è¯¯ã€‚</p>
<p>åªè¦ç”¨åˆ°Redisåºåˆ—åŒ–ååºåˆ—åŒ–çš„åœ°æ–¹éƒ½ä¼šé‡åˆ°è¿™ä¸ªé—®é¢˜ï¼Œæ¯”å¦‚ï¼šRedisTemplateï¼ŒRedissonï¼Œ@Cacheableæ³¨è§£ç­‰ã€‚</p>
<p><strong>åŸå› ï¼š</strong></p>
<p>SpringBoot çš„ç¼“å­˜ä½¿ç”¨ jackson æ¥åšæ•°æ®çš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–ï¼Œå¦‚æœé»˜è®¤ä½¿ç”¨ Object ä½œä¸ºåºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„ç±»å‹ï¼Œåˆ™å…¶åªèƒ½è¯†åˆ« java åŸºæœ¬ç±»å‹ï¼Œé‡åˆ°å¤æ‚ç±»å‹æ—¶ï¼Œjackson å°±ä¼šå…ˆåºåˆ—åŒ–æˆ LinkedHashMap ï¼Œç„¶åå†å°è¯•å¼ºè½¬ä¸ºæ‰€éœ€ç±»åˆ«ï¼Œè¿™æ ·å¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¼šå¼ºè½¬å¤±è´¥ã€‚</p>
<p><strong>è§£å†³æ–¹æ³•ï¼š</strong></p>
<p>å‡ºç°è¿™ç§å¼‚å¸¸ï¼Œéœ€è¦è‡ªå®šä¹‰ObjectMapperï¼Œè®¾ç½®ä¸€äº›å‚æ•°ï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨Jackson2JsonRedisSerializerç±»ä¸­é»™è®¤çš„ObjectMapperï¼Œçœ‹æºä»£ç å¯ä»¥çŸ¥é“ï¼ŒJackson2JsonRedisSerializerä¸­çš„ObjectMapperæ˜¯ç›´æ¥ä½¿ç”¨new ObjectMapper()åˆ›å»ºçš„ï¼Œè¿™æ ·ObjectMapperä¼šå°†Redisä¸­çš„å­—ç¬¦ä¸²ååºåˆ—åŒ–ä¸ºjava.util.LinkedHashMapç±»å‹ï¼Œå¯¼è‡´åç»­Springå¯¹å…¶è¿›è¡Œè½¬æ¢æˆæŠ¥é”™ã€‚å…¶å®æˆ‘ä»¬åªè¦å®ƒè¿”å›Objectç±»å‹å°±å¯ä»¥äº†ã€‚</p>
<p><strong>ä¿®æ”¹RedisTemplateè¿™ä¸ªbeançš„valueSerializerï¼Œè®¾ç½®é»˜è®¤ç±»å‹ã€‚</strong></p>
<p><strong>å‚è€ƒåšå®¢ï¼š</strong></p>
<p><a href="https://blog.51cto.com/knifeedge/5010643">https://blog.51cto.com/knifeedge/5010643</a></p>
<p>ä¿®æ”¹é…ç½®ç±»</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisConfig</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">RedisTemplate</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="nf">template</span><span class="o">(</span><span class="n">RedisConnectionFactory</span> <span class="n">factory</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// åˆ›å»ºRedisTemplate&lt;String, Object&gt;å¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">RedisTemplate</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">template</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RedisTemplate</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// é…ç½®è¿æ¥å·¥å‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">template</span><span class="o">.</span><span class="na">setConnectionFactory</span><span class="o">(</span><span class="n">factory</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// redis key åºåˆ—åŒ–æ–¹å¼ä½¿ç”¨stringSerial
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">template</span><span class="o">.</span><span class="na">setKeySerializer</span><span class="o">(</span><span class="k">new</span> <span class="n">StringRedisSerializer</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// redis value åºåˆ—åŒ–æ–¹å¼è‡ªå®šä¹‰ï¼Œä½¿ç”¨jacksonä¼šå‡ºç°è½¬æ¢ç±»å‹çš„é”™è¯¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// template.setValueSerializer(new GenericFastJsonRedisSerializer());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">template</span><span class="o">.</span><span class="na">setValueSerializer</span><span class="o">(</span><span class="n">valueSerializer</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// redis hash key åºåˆ—åŒ–æ–¹å¼ä½¿ç”¨stringSerial
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">template</span><span class="o">.</span><span class="na">setHashKeySerializer</span><span class="o">(</span><span class="k">new</span> <span class="n">StringRedisSerializer</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// redis hash value åºåˆ—åŒ–æ–¹å¼è‡ªå®šä¹‰ï¼Œä½¿ç”¨jacksonä¼šå‡ºç°è½¬æ¢ç±»å‹çš„é”™è¯¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// template.setHashValueSerializer(new GenericFastJsonRedisSerializer());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">template</span><span class="o">.</span><span class="na">setHashValueSerializer</span><span class="o">(</span><span class="n">valueSerializer</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">template</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">RedisSerializer</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">valueSerializer</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Jackson2JsonRedisSerializer</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">jackson2JsonRedisSerializer</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">Jackson2JsonRedisSerializer</span><span class="o">&lt;&gt;(</span><span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ObjectMapper</span> <span class="n">objectMapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectMapper</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">objectMapper</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="n">PropertyAccessor</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span> <span class="n">JsonAutoDetect</span><span class="o">.</span><span class="na">Visibility</span><span class="o">.</span><span class="na">ANY</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// æ­¤é¡¹å¿…é¡»é…ç½®ï¼Œå¦åˆ™å¦‚æœåºåˆ—åŒ–çš„å¯¹è±¡é‡Œè¾¹è¿˜æœ‰å¯¹è±¡ï¼Œä¼šæŠ¥å¦‚ä¸‹é”™è¯¯ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//     java.lang.ClassCastException: java.util.LinkedHashMap cannot be cast to XXX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">objectMapper</span><span class="o">.</span><span class="na">activateDefaultTyping</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">objectMapper</span><span class="o">.</span><span class="na">getPolymorphicTypeValidator</span><span class="o">(),</span>
</span></span><span class="line"><span class="cl">            <span class="n">ObjectMapper</span><span class="o">.</span><span class="na">DefaultTyping</span><span class="o">.</span><span class="na">NON_FINAL</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">JsonTypeInfo</span><span class="o">.</span><span class="na">As</span><span class="o">.</span><span class="na">PROPERTY</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ—§ç‰ˆå†™æ³•ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// objectMapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL, JsonTypeInfo.As.PROPERTY);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="n">jackson2JsonRedisSerializer</span><span class="o">.</span><span class="na">setObjectMapper</span><span class="o">(</span><span class="n">objectMapper</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">jackson2JsonRedisSerializer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>é—®é¢˜ï¼š</strong></p>
<h4 id="æ³¨è§£ä¸ç”Ÿæ•ˆ"><strong>æ³¨è§£ä¸ç”Ÿæ•ˆ</strong><a hidden class="anchor" aria-hidden="true" href="#æ³¨è§£ä¸ç”Ÿæ•ˆ">#</a></h4>
<p>==æ³¨è§£ç”Ÿæ•ˆä»£ç ==</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@UserCacheEnable</span><span class="o">(</span><span class="n">key</span> <span class="o">=</span> <span class="s">&#34;#email&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">JSONObject</span> <span class="nf">getItemUserInfoByEmail</span><span class="o">(</span><span class="n">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">JSONObject</span> <span class="n">userJson</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JSONObject</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">email</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">&#34;@&#34;</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">        <span class="n">user</span> <span class="o">=</span> <span class="n">userDao</span><span class="o">.</span><span class="na">findFirstByEmail</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">user</span> <span class="o">=</span> <span class="n">userDao</span><span class="o">.</span><span class="na">findFirstByAccessId</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">user</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">email</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="na">getEmail</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">userJson</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">,</span> <span class="n">email</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">userJson</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;email&#34;</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">userJson</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;accessId&#34;</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">userJson</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;image&#34;</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">userJson</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">JSONObject</span> <span class="n">userInfo</span> <span class="o">=</span> <span class="n">getInfoFromUserServer</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">userJson</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">,</span> <span class="n">userInfo</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// userJson.put(&#34;id&#34;, user.getId());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">userJson</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;email&#34;</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getEmail</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">userJson</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;accessId&#34;</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getAccessId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// userJson.put(&#34;image&#34;, user.getAvatar().equals(&#34;&#34;) ? &#34;&#34; : htmlLoadPath + user.getAvatar());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">userJson</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;image&#34;</span><span class="o">,</span> <span class="n">userInfo</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;avatar&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">userJson</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>==æ³¨è§£å¤±æ•ˆä»£ç ==</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@UserCacheEnable</span><span class="o">(</span><span class="n">key</span> <span class="o">=</span> <span class="s">&#34;#email&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">JSONObject</span> <span class="nf">getInfoFromUserServer</span><span class="o">(</span><span class="n">String</span> <span class="n">email</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// return getInfoFromUserServerPart(email);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">JSONObject</span> <span class="n">jsonObject</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JSONObject</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">RestTemplate</span> <span class="n">restTemplate</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RestTemplate</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">userInfoUrl</span> <span class="o">=</span> <span class="s">&#34;http://&#34;</span> <span class="o">+</span> <span class="n">userServer</span> <span class="o">+</span> <span class="s">&#34;/user/&#34;</span> <span class="o">+</span> <span class="n">email</span> <span class="o">+</span> <span class="s">&#34;/&#34;</span> <span class="o">+</span> <span class="n">userServerCilent</span> <span class="o">+</span> <span class="s">&#34;/&#34;</span> <span class="o">+</span> <span class="n">userServerCilentPWD</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">HttpHeaders</span> <span class="n">headers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">MediaType</span> <span class="n">mediaType</span> <span class="o">=</span> <span class="n">MediaType</span><span class="o">.</span><span class="na">parseMediaType</span><span class="o">(</span><span class="s">&#34;application/json;charset=UTF-8&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">headers</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="n">mediaType</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">headers</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&#34;user-agent&#34;</span><span class="o">,</span> <span class="s">&#34;portal_backend&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">HttpEntity</span> <span class="n">httpEntity</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpEntity</span><span class="o">(</span><span class="n">headers</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">JSONObject</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">restTemplate</span><span class="o">.</span><span class="na">exchange</span><span class="o">(</span><span class="n">userInfoUrl</span><span class="o">,</span> <span class="n">HttpMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="n">httpEntity</span><span class="o">,</span> <span class="n">JSONObject</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">JSONObject</span> <span class="n">userInfo</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getBody</span><span class="o">().</span><span class="na">getJSONObject</span><span class="o">(</span><span class="s">&#34;data&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">avatar</span> <span class="o">=</span> <span class="n">userInfo</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;avatar&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">avatar</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// avatar = &#34;/userServer&#34; + avatar;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//ä¿®æ­£avatarå‰é¢åŠ äº†/userServer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// avatar = avatar.replaceAll(&#34;/userServer&#34;,&#34;&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">genericService</span><span class="o">.</span><span class="na">formatUserAvatar</span><span class="o">(</span><span class="n">avatar</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">userInfo</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;avatar&#34;</span><span class="o">,</span><span class="n">avatar</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">userInfo</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;msg&#34;</span><span class="o">,</span><span class="s">&#34;suc&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">userInfo</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// System.out.println(e.fillInStackTrace());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">jsonObject</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;msg&#34;</span><span class="o">,</span><span class="s">&#34;no user&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">jsonObject</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>åŸå› ï¼š</strong></p>
<p><a href="https://www.cnblogs.com/javastack/p/13361157.html">Spring AOP æ³¨è§£ä¸ºä»€ä¹ˆå¤±æ•ˆï¼Ÿ</a></p>
<p><strong>å¦‚ä¸‹é¢å‡ ç§åœºæ™¯</strong></p>
<p>1ã€Controllerç›´æ¥è°ƒç”¨Service Bæ–¹æ³•ï¼šController &gt; Service A</p>
<p>åœ¨Service A ä¸ŠåŠ @Transactionalçš„æ—¶å€™å¯ä»¥æ­£å¸¸å®ç°AOPåŠŸèƒ½ã€‚</p>
<p>2ã€==Controllerè°ƒç”¨Service Aæ–¹æ³•ï¼ŒAå†è°ƒç”¨Bæ–¹æ³•ï¼šController &gt; Service A &gt; Service B==</p>
<p>åœ¨Service Bä¸ŠåŠ @Transactionalçš„æ—¶å€™ä¸èƒ½å®ç°AOPåŠŸèƒ½ï¼Œå› ä¸º==åœ¨Service Aæ–¹æ³•ä¸­è°ƒç”¨Service Bæ–¹æ³•æƒ³å½“äºä½¿ç”¨this.B()ï¼Œthisä»£è¡¨çš„æ˜¯Serviceç±»æœ¬èº«ï¼Œå¹¶ä¸æ˜¯çœŸå®çš„ä»£ç†Serviceå¯¹è±¡==ï¼Œæ‰€ä»¥è¿™ç§ä¸èƒ½å®ç°ä»£ç†åŠŸèƒ½ã€‚</p>
<p>æ‰€ä»¥ï¼Œå¦‚æœä¸æ˜¯ç›´æ¥è°ƒç”¨çš„æ–¹å¼ï¼Œæ˜¯ä¸èƒ½å®ç°ä»£ç†åŠŸèƒ½çš„ï¼Œéå¸¸éœ€è¦æ³¨æ„ã€‚</p>


  </div>

  <footer class="post-footer">
    
<nav class="paginav">
  <a class="prev" href="https://chance7bin.github.io/posts/design/%E9%99%90%E6%B5%81/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>é™æµ</span>
  </a>
  <a class="next" href="https://chance7bin.github.io/posts/note/windows%E9%85%8D%E7%BD%AEnfs/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>Windowsé…ç½®NFS</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://chance7bin.github.io/">Binb&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerHTML = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
