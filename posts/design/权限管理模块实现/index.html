<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>æƒé™ç®¡ç†æ¨¡å—å®ç° | Binb&#39;s Blog</title>
<meta name="keywords" content="ç³»ç»Ÿè®¾è®¡, æƒé™ç®¡ç†">
<meta name="description" content="0 å¼•è¨€ è¯¥ç¯‡æ–‡ç« æ˜¯å¯¹Spring Securityå­¦ä¹ çš„æ€»ç»“ï¼Œä»¥åŠç³»ç»Ÿä¸­è®¤è¯æˆæƒçš„ä»£ç å®ç° å‚è€ƒé“¾æ¥ SpringSecurity-ä»å…¥é—¨åˆ°ç²¾é€š 1 Spring">
<meta name="author" content="chance7bin">
<link rel="canonical" href="https://chance7bin.github.io/posts/design/%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.be81eec981a615a87a88f121642d7eebde74d033438693944db2fd6b827284ff.css" integrity="" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.acb54fd32bbc1982428b8850317e45d076b95012730a5936667e6bc21777692a.js" integrity=""
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<link rel="icon" type="image/png" sizes="16x16" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<link rel="icon" type="image/png" sizes="32x32" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<link rel="apple-touch-icon" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<link rel="mask-icon" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="æƒé™ç®¡ç†æ¨¡å—å®ç°" />
<meta property="og:description" content="0 å¼•è¨€ è¯¥ç¯‡æ–‡ç« æ˜¯å¯¹Spring Securityå­¦ä¹ çš„æ€»ç»“ï¼Œä»¥åŠç³»ç»Ÿä¸­è®¤è¯æˆæƒçš„ä»£ç å®ç° å‚è€ƒé“¾æ¥ SpringSecurity-ä»å…¥é—¨åˆ°ç²¾é€š 1 Spring" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://chance7bin.github.io/posts/design/%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-18T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-06-18T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="æƒé™ç®¡ç†æ¨¡å—å®ç°"/>
<meta name="twitter:description" content="0 å¼•è¨€ è¯¥ç¯‡æ–‡ç« æ˜¯å¯¹Spring Securityå­¦ä¹ çš„æ€»ç»“ï¼Œä»¥åŠç³»ç»Ÿä¸­è®¤è¯æˆæƒçš„ä»£ç å®ç° å‚è€ƒé“¾æ¥ SpringSecurity-ä»å…¥é—¨åˆ°ç²¾é€š 1 Spring"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "ğŸ“š æ–‡ç« ",
      "item": "https://chance7bin.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ¨ ç³»ç»Ÿè®¾è®¡",
      "item": "https://chance7bin.github.io/posts/design/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "æƒé™ç®¡ç†æ¨¡å—å®ç°",
      "item": "https://chance7bin.github.io/posts/design/%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "æƒé™ç®¡ç†æ¨¡å—å®ç°",
  "name": "æƒé™ç®¡ç†æ¨¡å—å®ç°",
  "description": "0 å¼•è¨€ è¯¥ç¯‡æ–‡ç« æ˜¯å¯¹Spring Securityå­¦ä¹ çš„æ€»ç»“ï¼Œä»¥åŠç³»ç»Ÿä¸­è®¤è¯æˆæƒçš„ä»£ç å®ç° å‚è€ƒé“¾æ¥ SpringSecurity-ä»å…¥é—¨åˆ°ç²¾é€š 1 Spring",
  "keywords": [
    "ç³»ç»Ÿè®¾è®¡", "æƒé™ç®¡ç†"
  ],
  "articleBody": "0 å¼•è¨€ è¯¥ç¯‡æ–‡ç« æ˜¯å¯¹Spring Securityå­¦ä¹ çš„æ€»ç»“ï¼Œä»¥åŠç³»ç»Ÿä¸­è®¤è¯æˆæƒçš„ä»£ç å®ç°\nå‚è€ƒé“¾æ¥\nSpringSecurity-ä»å…¥é—¨åˆ°ç²¾é€š\n1 Spring Security Spring Security æ˜¯ Spring å®¶æ—ä¸­çš„ä¸€ä¸ªå®‰å…¨ç®¡ç†æ¡†æ¶ã€‚ç›¸æ¯”ä¸å¦å¤–ä¸€ä¸ªå®‰å…¨æ¡†æ¶Shiroï¼Œå®ƒæä¾›äº†æ›´ä¸°å¯Œçš„åŠŸèƒ½ï¼Œç¤¾åŒºèµ„æºä¹Ÿæ¯”Shiroä¸°å¯Œã€‚\nä¸€èˆ¬æ¥è¯´ä¸­å¤§å‹çš„é¡¹ç›®éƒ½æ˜¯ä½¿ç”¨SpringSecurity æ¥åšå®‰å…¨æ¡†æ¶ã€‚å°é¡¹ç›®æœ‰Shiroçš„æ¯”è¾ƒå¤šï¼Œå› ä¸ºç›¸æ¯”ä¸SpringSecurityï¼ŒShiroçš„ä¸Šæ‰‹æ›´åŠ çš„ç®€å•ã€‚\nä¸€èˆ¬Webåº”ç”¨çš„éœ€è¦è¿›è¡Œè®¤è¯å’Œæˆæƒã€‚\nè®¤è¯ï¼šéªŒè¯å½“å‰è®¿é—®ç³»ç»Ÿçš„æ˜¯ä¸æ˜¯æœ¬ç³»ç»Ÿçš„ç”¨æˆ·ï¼Œå¹¶ä¸”è¦ç¡®è®¤å…·ä½“æ˜¯å“ªä¸ªç”¨æˆ·\næˆæƒï¼šç»è¿‡è®¤è¯ååˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è¿›è¡ŒæŸä¸ªæ“ä½œ\nè€Œè®¤è¯å’Œæˆæƒä¹Ÿæ˜¯SpringSecurityä½œä¸ºå®‰å…¨æ¡†æ¶çš„æ ¸å¿ƒåŠŸèƒ½ã€‚\n1.1 Spring SecurityåŸç†åˆæ¢ è®¤è¯åŸºæœ¬æµç¨‹ï¼š\næ ¹æ®username, passwordå°è£…ä¸€ä¸ªAuthenticationå¯¹è±¡authenticationTokenï¼Œå¹¶åŠ å…¥åˆ°SecurityContextHolderçš„contextä¸­ è°ƒç”¨AuthenticationManageræ¥å£çš„authenticate(authenticationToken)æ–¹æ³•è¿›è¡Œè®¤è¯ åœ¨ç¬¬2æ­¥è°ƒç”¨authenticateæ–¹æ³•æ—¶ï¼Œå®ƒå®é™…ä¼šæ‰§è¡Œå®ç°äº†UserDetailsServiceæ¥å£çš„loadUserByUsernameæ–¹æ³•ï¼Œè®¤è¯ç”¨æˆ·çš„é€»è¾‘å°±å†™åœ¨è¯¥æ–¹æ³•ä¸­ åœ¨loadUserByUsernameæ–¹æ³•ä¸­ï¼Œä»AuthenticationContextHolderè·å–ç¬¬ä¸€æ­¥ä¼ å…¥çš„username, passwordï¼Œä¸æ•°æ®åº“çš„å¯†ç åšå¯¹æ¯”ï¼ŒéªŒè¯ç”¨æˆ·å¯†ç æ˜¯å¦æ­£ç¡®ï¼Œè‹¥æ­£ç¡®ï¼Œåˆ™æŠŠç”¨æˆ·ä¿¡æ¯å°è£…åˆ°å®ç°äº†UserDetailsæ¥å£çš„ç±»ä¸­ æ­¥éª¤1æ‰©å±•\nè®¤è¯è¿‡æ»¤å™¨UsernamePasswordAuthenticationFilterï¼šå®ƒçš„ä½œç”¨æ˜¯æ‹¦æˆªç™»å½•è¯·æ±‚å¹¶è·å–è´¦å·å’Œå¯†ç ï¼Œç„¶åæŠŠè´¦å·å¯†ç å°è£…åˆ°è®¤è¯å‡­æ® UsernamePasswordAuthenticationToken ä¸­ï¼Œç„¶åæŠŠå‡­æ®äº¤ ç»™ç‰¹å®šé…ç½®çš„ AuthenticationManagerå»ä½œè®¤è¯ã€‚\næ­¥éª¤2æ‰©å±•\nAuthenticationManager çš„å®ç° ProviderManager ç®¡ç†äº†ä¼—å¤šçš„ AuthenticationProvider ã€‚æ¯ ä¸€ä¸ª AuthenticationProvideréƒ½åªæ”¯æŒç‰¹å®šç±»å‹çš„ Authentication ï¼Œç„¶åæ˜¯å¯¹é€‚é…åˆ°çš„ Authentication è¿›è¡Œè®¤è¯ï¼Œåªè¦æœ‰ä¸€ä¸ª AuthenticationProviderè®¤è¯æˆåŠŸï¼Œé‚£ä¹ˆå°±è®¤ä¸ºè®¤è¯æˆåŠŸï¼Œæ‰€æœ‰çš„éƒ½æ²¡æœ‰é€šè¿‡æ‰è®¤ä¸ºæ˜¯è®¤è¯å¤±è´¥ã€‚è®¤è¯æˆåŠŸåçš„ Authentication å°±å˜æˆæˆä¿¡å‡­æ®ï¼Œå¹¶è§¦å‘è®¤è¯æˆåŠŸçš„äº‹ä»¶ã€‚è®¤è¯å¤±è´¥çš„å°±æŠ›å‡ºå¼‚å¸¸è§¦å‘è®¤è¯å¤±è´¥çš„äº‹ä»¶ã€‚\n1.2 Spring Secutityæ ¸å¿ƒå†…å®¹ 1.2.1 Spring Secutityä¸­çš„ç”¨æˆ·ä¿¡æ¯ 1.UserDetailsServiceï¼š\nè¯¥æ–¹æ³•å¾ˆå®¹æ˜“ç†è§£ï¼š é€šè¿‡ç”¨æˆ·åæ¥åŠ è½½ç”¨æˆ· ã€‚è¿™ä¸ªæ–¹æ³•ä¸»è¦ç”¨äºä»ç³»ç»Ÿæ•°æ®ä¸­æŸ¥è¯¢å¹¶åŠ è½½å…·ä½“çš„ç”¨æˆ·åˆ° Spring Securityä¸­ã€‚\nåœ¨å¼€å‘ä¸­æˆ‘ä»¬ä¸€èˆ¬å®šä¹‰ä¸€ä¸ªè¿™ä¸ªæ¥å£çš„å®ç°ç±»ï¼Œè‡ªå®šä¹‰loadUserByUsernameæ–¹æ³•ï¼Œå®ç°ä»æ•°æ®æºè·å–ç”¨æˆ·ï¼ŒåŠ è½½ç”¨æˆ·ä¿¡æ¯ã€‚ä¹Ÿå¯ä»¥åœ¨å…¶ä¸­å®ç°ä¸€äº›æ ¡éªŒç”¨æˆ·é€»è¾‘ã€‚\n2.UserDetails:\nä»ä¸Šé¢ UserDetailsService å¯ä»¥çŸ¥é“æœ€ç»ˆäº¤ç»™Spring Securityçš„æ˜¯UserDetails ã€‚è¯¥æ¥å£æ˜¯æä¾›ç”¨æˆ·ä¿¡æ¯çš„æ ¸å¿ƒæ¥å£ã€‚è¯¥æ¥å£å®ç°ä»…ä»…å­˜å‚¨ç”¨æˆ·çš„ä¿¡æ¯ã€‚åç»­ä¼šå°†è¯¥æ¥å£æä¾›çš„ç”¨æˆ·ä¿¡æ¯å°è£…åˆ°è®¤è¯å¯¹è±¡Authentication ä¸­å»ã€‚\nUserDetailsä¸­é»˜è®¤æä¾›ï¼š\nç”¨æˆ·çš„æƒé™é›†ï¼Œ é»˜è®¤éœ€è¦æ·»åŠ  ROLE_ å‰ç¼€ ç”¨æˆ·çš„åŠ å¯†åçš„å¯†ç ï¼Œ ä¸åŠ å¯†ä¼šä½¿ç”¨ {noop} å‰ç¼€ åº”ç”¨å†…å”¯ä¸€çš„ç”¨æˆ·å è´¦æˆ·æ˜¯å¦è¿‡æœŸ è´¦æˆ·æ˜¯å¦é”å®š å‡­è¯æ˜¯å¦è¿‡æœŸ ç”¨æˆ·æ˜¯å¦å¯ç”¨ åœ¨æˆ‘ä»¬è‡ªå·±çš„é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬è¦å®šä¹‰ä¸ªç”¨æˆ·ç±»å®ç°è¯¥æ¥å£ï¼Œåœ¨è¯¥ç”¨æˆ·ç±»ä¸­æˆ‘ä»¬å¯ä»¥æ‰©å±•æ›´å¤šçš„ç”¨æˆ·ä¿¡æ¯ï¼Œæ¯”å¦‚æ‰‹æœºã€é‚®ç®±ç­‰ç­‰\n1.2.2 Spring Securityçš„é…ç½® è‡ªå®šä¹‰SecurityConfig\né¦–å…ˆè¦ç»§æ‰¿WebSecurityConfigurerAdapterï¼Œå…¶æ¬¡æœ€å¸¸ç”¨çš„æ˜¯å®ç°configure(AuthenticationManagerBuilder auth)ã€configure(WebSecurity web)ã€configure(HttpSecurity http)ä¸‰ä¸ªæ–¹æ³•å®ç°æˆ‘ä»¬å¯¹Spring Securityçš„è‡ªå®šä¹‰å®‰å…¨é…ç½®ã€‚\nvoid configure(AuthenticationManagerBuilder auth) ç”¨æ¥é…ç½®è®¤è¯ç®¡ç†å™¨ AuthenticationManagerã€‚ void configure(WebSecurity web)ç”¨æ¥é…ç½® WebSecurity ã€‚è€Œ WebSecurityæ˜¯åŸºäºServlet Filterç”¨æ¥é…ç½® springSecurityFilterChainã€‚è€Œ springSecurityFilterChain åˆè¢«å§”æ‰˜ç»™äº† Spring Security æ ¸å¿ƒè¿‡æ»¤å™¨ Bean DelegatingFilterProxy ã€‚ ç›¸å…³é€»è¾‘å¯ä»¥åœ¨ WebSecurityConfiguration ä¸­æ‰¾åˆ°ã€‚æˆ‘ä»¬ä¸€èˆ¬ä¸ä¼šè¿‡å¤šæ¥è‡ªå®šä¹‰ WebSecurity , ä½¿ç”¨è¾ƒå¤šçš„ä½¿å…¶ ignoring() æ–¹æ³•ç”¨æ¥å¿½ç•¥ Spring Security å¯¹é™æ€èµ„æºçš„æ§åˆ¶ã€‚ void configure(HttpSecurity http) è¿™ä¸ªæ˜¯æˆ‘ä»¬ä½¿ç”¨æœ€å¤šçš„ï¼Œç”¨æ¥é…ç½® HttpSecurity ã€‚ HttpSecurityç”¨äºæ„å»ºä¸€ä¸ªå®‰å…¨è¿‡æ»¤å™¨é“¾ SecurityFilterChainã€‚ SecurityFilterChain æœ€ç»ˆè¢«æ³¨å…¥æ ¸å¿ƒè¿‡æ»¤å™¨ ã€‚HttpSecurityæœ‰è®¸å¤šæˆ‘ä»¬éœ€è¦çš„é…ç½®ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒæ¥è¿›è¡Œè‡ªå®šä¹‰å®‰å…¨è®¿é—®ç­–ç•¥ã€‚ 1.2.3 è®¤è¯è¿‡ç¨‹ è¯¦è§ [1.1 Spring SecurityåŸç†åˆæ¢](# 1.1 Spring SecurityåŸç†åˆæ¢)\n1.2.4 è¿‡æ»¤å™¨å’Œè¿‡æ»¤é“¾ SpringSecurityçš„åŸç†å…¶å®å°±æ˜¯ä¸€ä¸ªè¿‡æ»¤å™¨é“¾ï¼Œå†…éƒ¨åŒ…å«äº†æä¾›å„ç§åŠŸèƒ½çš„è¿‡æ»¤å™¨ã€‚\nSpring Security ä»¥ä¸€ä¸ªå• Filter(FilterChainProxy)å­˜åœ¨äºæ•´ä¸ªè¿‡æ»¤å™¨é“¾ä¸­ï¼Œè€Œ è¿™ä¸ª FilterChainProxy å®é™…å†…éƒ¨ä»£ç†ç€ä¼—å¤šçš„ Spring Security Filter ã€‚\nå›¾ä¸­åªå±•ç¤ºäº†æ ¸å¿ƒè¿‡æ»¤å™¨ï¼Œå…¶å®ƒçš„éæ ¸å¿ƒè¿‡æ»¤å™¨å¹¶æ²¡æœ‰åœ¨å›¾ä¸­å±•ç¤ºã€‚\nUsernamePasswordAuthenticationFilter:è´Ÿè´£å¤„ç†æˆ‘ä»¬åœ¨ç™»é™†é¡µé¢å¡«å†™äº†ç”¨æˆ·åå¯†ç åçš„ç™»é™†è¯·æ±‚ã€‚å…¥é—¨æ¡ˆä¾‹çš„è®¤è¯å·¥ä½œä¸»è¦æœ‰å®ƒè´Ÿè´£ã€‚\nExceptionTranslationFilterï¼š å¤„ç†è¿‡æ»¤å™¨é“¾ä¸­æŠ›å‡ºçš„ä»»ä½•AccessDeniedExceptionå’ŒAuthenticationException ã€‚\nFilterSecurityInterceptorï¼š è´Ÿè´£æƒé™æ ¡éªŒçš„è¿‡æ»¤å™¨ã€‚\næˆ‘ä»¬å¯ä»¥é€šè¿‡DebugæŸ¥çœ‹å½“å‰ç³»ç»Ÿä¸­SpringSecurityè¿‡æ»¤å™¨é“¾ä¸­æœ‰å“ªäº›è¿‡æ»¤å™¨åŠå®ƒä»¬çš„é¡ºåºã€‚\nå‘é¡¹ç›®ä¸­æ·»åŠ è¿‡æ»¤å™¨ï¼š\nåœ¨é…ç½®æ–‡ä»¶çš„configure(HttpSecurity httpSecurity)æ–¹æ³•ä¸­ï¼š\n4ä¸ªæ–¹æ³•åˆ†åˆ«æ˜¯ï¼šaddFilterâ€“æ·»åŠ è¿‡æ»¤å™¨ï¼›addFilterAfterâ€“æŠŠè¿‡æ»¤å™¨æ·»åŠ åˆ°æŸè¿‡æ»¤å™¨ä¹‹åï¼›addFilterAtâ€“æ›¿ä»£æŸè¿‡æ»¤å™¨ï¼›addFilterBeforeâ€“æŠŠè¿‡æ»¤å™¨æ·»åŠ åˆ°æŸè¿‡æ»¤å™¨ä¹‹å‰\n1.2.5 æƒé™ç›¸å…³ ä¸€ã€åŸºäºé…ç½®è¡¨è¾¾å¼æ§åˆ¶ URL è·¯å¾„\nåœ¨ç»§æ‰¿WebSecurityConfigurerAdapterçš„é…ç½®ç±»ä¸­çš„configure(HttpSecurity http)ä¸­è¿›è¡Œé…ç½®ã€‚\n1 2 3 4 5 6 7 8 protected void configure(HttpSecurity http) throws Exception { http.authorizeRequests() .antMatchers(\"/admin/**\").hasRole(\"admin\") .antMatchers(\"/user/**\").hasAnyRole(\"admin\", \"user\") .anyRequest().authenticated() .and() ... } äºŒã€åŸºäºæ³¨è§£çš„æ¥å£æƒé™æ§åˆ¶\næˆ‘ä»¬å¯ä»¥åœ¨ä»»ä½• @Configurationå®ä¾‹ä¸Šä½¿ç”¨ @EnableGlobalMethodSecurityæ³¨è§£æ¥å¯ç”¨å…¨å±€æ–¹ æ³•å®‰å…¨æ³¨è§£åŠŸèƒ½\n1 2 3 4 5 6 @Configuration @EnableGlobalMethodSecurity(prePostEnabled = true,securedEnabled = true,jsr250Enabled = true) public class SecurityConfig extends WebSecurityConfigurerAdapter { ... ... } è®¾ç½® prePostEnabledä¸º true ï¼Œåˆ™å¼€å¯äº†åŸºäºè¡¨è¾¾å¼ çš„æ–¹æ³•å®‰å…¨æ§åˆ¶ã€‚ 2 è®¤è¯ 2.1 ç™»å½•æ ¡éªŒæµç¨‹ 2.2 ç™»å½•åŠŸèƒ½æ ¸å¿ƒä»£ç  åœ¨SpringBooté¡¹ç›®ä¸­ä½¿ç”¨SpringSecurityæˆ‘ä»¬åªéœ€è¦å¼•å…¥ä¾èµ–å³å¯ã€‚\n1 2 3 4 5 org.springframework.boot spring-boot-starter-security 1.æ ¹æ®username, passwordå°è£…ä¸€ä¸ªAuthenticationå¯¹è±¡authenticationTokenï¼Œè°ƒç”¨AuthenticationManageræ¥å£çš„authenticate(authenticationToken)æ–¹æ³•è¿›è¡Œè®¤è¯\nAuthenticationç±»ä¸­ï¼šprincipalå±æ€§å¯¹åº”ç”¨æˆ·åï¼›credentialså±æ€§å¯¹åº”å¯†ç \nè‹¥æ˜¯éœ€è¦æ ¹æ®é‚®ç®±ç™»å½•çš„è¯æŠŠemailæ”¾åˆ°principalï¼Œ\nloadUserByUsernameæ–¹æ³•çš„å‚æ•°å°±æ˜¯è¿™ä¸ªemail\nåœ¨æ¥å£ä¸­æˆ‘ä»¬é€šè¿‡AuthenticationManagerçš„authenticateæ–¹æ³•æ¥è¿›è¡Œç”¨æˆ·è®¤è¯ï¼Œæ‰€ä»¥éœ€è¦åœ¨SecurityConfigä¸­é…ç½®æŠŠAuthenticationManageræ³¨å…¥å®¹å™¨ã€‚\n1 2 3 4 5 6 7 8 9 10 public String login(String username, String password, String code, String uuid) { // ç”¨æˆ·éªŒè¯ UsernamePasswordAuthenticationToken authenticationToken = new UsernamePasswordAuthenticationToken(username, password); AuthenticationContextHolder.setContext(authenticationToken); // è¯¥æ–¹æ³•ä¼šå»è°ƒç”¨UserDetailsServiceImpl.loadUserByUsername Authentication authentication = authenticationManager.authenticate(authenticationToken); // ç”Ÿæˆtoken return tokenService.createToken(loginUser); } å¯†ç åŠ å¯†å­˜å‚¨\nå®é™…é¡¹ç›®ä¸­æˆ‘ä»¬ä¸ä¼šæŠŠå¯†ç æ˜æ–‡å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ã€‚\nä¸€èˆ¬ä½¿ç”¨SpringSecurityä¸ºæˆ‘ä»¬æä¾›çš„BCryptPasswordEncoderã€‚\næˆ‘ä»¬åªéœ€è¦ä½¿ç”¨æŠŠBCryptPasswordEncoderå¯¹è±¡æ³¨å…¥Springå®¹å™¨ä¸­ï¼ŒSpringSecurityå°±ä¼šä½¿ç”¨è¯¥PasswordEncoderæ¥è¿›è¡Œå¯†ç æ ¡éªŒ\néƒ¨åˆ†SecurityConfigé…ç½®ï¼ˆ[å®Œæ•´é…ç½®](# 2.4 é…ç½®SecurityConfig)ï¼‰\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 @Configuration public class SecurityConfig extends WebSecurityConfigurerAdapter { @Override protected void configure(HttpSecurity http) throws Exception { http //å…³é—­csrf .csrf().disable() //ä¸é€šè¿‡Sessionè·å–SecurityContext .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS) .and() .authorizeRequests() // å¯¹äºç™»å½•æ¥å£ å…è®¸åŒ¿åè®¿é—® .antMatchers(\"/user/login\").anonymous() // é™¤ä¸Šé¢å¤–çš„æ‰€æœ‰è¯·æ±‚å…¨éƒ¨éœ€è¦é‰´æƒè®¤è¯ .anyRequest().authenticated(); } @Bean @Override public AuthenticationManager authenticationManagerBean() throws Exception { return super.authenticationManagerBean(); } /** * å¼ºæ•£åˆ—å“ˆå¸ŒåŠ å¯†å®ç° */ @Bean public BCryptPasswordEncoder bCryptPasswordEncoder() { return new BCryptPasswordEncoder(); } /** * èº«ä»½è®¤è¯æ¥å£ */ @Override protected void configure(AuthenticationManagerBuilder auth) throws Exception { // æ•°æ®åº“éªŒè¯ // Spring Security æä¾›äº†BCryptPasswordEncoderç±», // å®ç°Springçš„PasswordEncoderæ¥å£ä½¿ç”¨BCryptå¼ºå“ˆå¸Œæ–¹æ³•æ¥åŠ å¯†å¯†ç  auth.userDetailsService(userDetailsService).passwordEncoder(bCryptPasswordEncoder()); } } 2.åˆ›å»ºä¸€ä¸ªserviceï¼Œå®ç°UserDetailsServiceæ¥å£ï¼Œå¹¶é‡å†™loadUserByUsernameæ–¹æ³•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 @Service public class UserDetailsServiceImpl implements UserDetailsService{ @Override public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException { SysUser user = userService.selectUserByUserName(username); validate(user); return createLoginUser(user); } public UserDetails createLoginUser(SysUser user) { return new LoginUser(user.getUserId(), user); } } 3.å®ç°å¯†ç éªŒè¯é€»è¾‘\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 public void validate(SysUser user){ Authentication usernamePasswordAuthenticationToken = AuthenticationContextHolder.getContext(); String username = usernamePasswordAuthenticationToken.getName(); String password = usernamePasswordAuthenticationToken.getCredentials().toString(); if (!matches(user, password)) { throw new ServiceException(\"å¯†ç é”™è¯¯\"); } } public boolean matches(SysUser user, String rawPassword){ return matchesPassword(rawPassword, user.getPassword()); } /** * åˆ¤æ–­å¯†ç æ˜¯å¦ç›¸åŒ * * @param rawPassword çœŸå®å¯†ç  * @param encodedPassword åŠ å¯†åå­—ç¬¦ * @return ç»“æœ */ public boolean matchesPassword(String rawPassword, String encodedPassword) { BCryptPasswordEncoder passwordEncoder = new BCryptPasswordEncoder(); return passwordEncoder.matches(rawPassword, encodedPassword); } 4.éªŒè¯æˆåŠŸåï¼Œåˆ›å»ºä»¤ç‰Œï¼Œå­˜å…¥redisä¸­ï¼Œå¹¶å°†tokenè¿”å›ç»™å‰ç«¯ï¼ˆå®ç°æ­¥éª¤1ä¸­çš„createTokenæ–¹æ³•ï¼‰\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 /** * åˆ›å»ºä»¤ç‰Œ * * @param loginUser ç”¨æˆ·ä¿¡æ¯ * @return ä»¤ç‰Œ */ public String createToken(LoginUser loginUser) { String token = UUID.fastUUID().toString(); loginUser.setToken(token); refreshToken(loginUser); Map\u003cString, Object\u003e claims = new HashMap\u003c\u003e(); claims.put(Constants.LOGIN_USER_KEY, token); return createToken(claims); } /** * åˆ·æ–°ä»¤ç‰Œæœ‰æ•ˆæœŸ * * @param loginUser ç™»å½•ä¿¡æ¯ */ public void refreshToken(LoginUser loginUser) { loginUser.setLoginTime(System.currentTimeMillis()); loginUser.setExpireTime(loginUser.getLoginTime() + expireTime * MILLIS_MINUTE); // æ ¹æ®uuidå°†loginUserç¼“å­˜ String userKey = getTokenKey(loginUser.getToken()); // \"login_tokens:\" + uuid; redisCache.set(userKey, loginUser, expireTime, TimeUnit.MINUTES); } /** * ä»æ•°æ®å£°æ˜ç”Ÿæˆä»¤ç‰Œ * * @param claims æ•°æ®å£°æ˜ * @return ä»¤ç‰Œ */ private String createToken(Map\u003cString, Object\u003e claims) { String token = Jwts.builder() .setClaims(claims) .signWith(SignatureAlgorithm.HS512, secret).compact(); return token; } 2.3 æ ¡éªŒåŠŸèƒ½æ ¸å¿ƒä»£ç  è®¿é—®ç³»ç»Ÿèµ„æºæ—¶ï¼Œå¦‚æœæ¯æ¬¡éƒ½éœ€è¦å»æ•°æ®åº“éªŒè¯å¯†ç æ˜¯ååˆ†æ¶ˆè€—èµ„æºçš„ï¼Œ[2.2](# 2.2 ç™»å½•åŠŸèƒ½æ ¸å¿ƒä»£ç )ä¸­ï¼Œæœ€åè¿”å›äº†ä¸€ä¸ªtokenï¼Œå¯åŸºäºè¯¥tokenå®ç°ä¿å­˜ç™»å½•çŠ¶æ€çš„åŠŸèƒ½\n1.å‰ç«¯å°†åç«¯è¿”å›çš„tokenå­˜å…¥Cookieä¸­\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 login(userInfo) { const username = userInfo.username.trim(); const password = userInfo.password; return new Promise\u003cvoid\u003e((resolve, reject) =\u003e { login(username, password) .then((res: any) =\u003e { setToken(res.token); this.token = res.token; resolve(); }) .catch((error) =\u003e { reject(error); }); }); } 1 2 3 4 5 6 import Cookies from \"js-cookie\"; const TokenKey = \"Admin-Token\"; export function setToken(token: string) { return Cookies.set(TokenKey, token); } 2.è¯·æ±‚æ¥å£æ—¶éƒ½é™„ä¸Štokenï¼ŒéªŒè¯ç”¨æˆ·æ˜¯å¦ç™»å½•\nrequest.ts\n1 2 3 4 5 6 7 8 9 // requestæ‹¦æˆªå™¨ service.interceptors.request.use( (config: any) =\u003e { // æ˜¯å¦éœ€è¦è®¾ç½® token const isToken = (config.headers || {}).isToken === false; if (getToken() \u0026\u0026 !isToken) { // è®©æ¯ä¸ªè¯·æ±‚æºå¸¦è‡ªå®šä¹‰token è¯·æ ¹æ®å®é™…æƒ…å†µè‡ªè¡Œä¿®æ”¹ config.headers[\"Authorization\"] = \"Bearer \" + getToken(); } 3.å®šä¹‰Jwtè®¤è¯è¿‡æ»¤å™¨ JwtAuthenticationTokenFilterï¼ŒéªŒè¯tokenæœ‰æ•ˆæ€§\nå› ä¸ºredisè®¾ç½®äº†ç™»é™†ä»¤ç‰Œçš„è¿‡æœŸæ—¶é—´ï¼Œæ‰€ä»¥å¦‚æœä»¤ç‰Œè¿‡æœŸäº†ï¼Œredisä¸­å°±ä¸å­˜åœ¨tokenè§£æåçš„redisKeyï¼Œä¼šç›´æ¥è¿”å›nullï¼Œè¿™ç§å…¶æ¦‚å†µå°±è¦é‡æ–°ç™»å½•äº†ã€‚\næ·»åŠ ä¾èµ–\n1 2 3 4 5 6 io.jsonwebtoken jjwt ${jwt.version} JwtAuthenticationTokenFilter\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 /** * tokenè¿‡æ»¤å™¨ éªŒè¯tokenæœ‰æ•ˆæ€§ * * @author 7bin */ @Component public class JwtAuthenticationTokenFilter extends OncePerRequestFilter { @Autowired private TokenService tokenService; @Override protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain chain) throws ServletException, IOException { LoginUser loginUser = tokenService.getLoginUser(request); if (StringUtils.isNotNull(loginUser) \u0026\u0026 StringUtils.isNull(SecurityUtils.getAuthentication())) { // éªŒè¯ä»¤ç‰Œæœ‰æ•ˆæœŸï¼Œç›¸å·®ä¸è¶³20åˆ†é’Ÿï¼Œè‡ªåŠ¨åˆ·æ–°ç¼“å­˜ tokenService.verifyToken(loginUser); // è·å–æƒé™ä¿¡æ¯å°è£…åˆ°Authenticationä¸­ UsernamePasswordAuthenticationToken authenticationToken = new UsernamePasswordAuthenticationToken(loginUser, null, loginUser.getAuthorities()); authenticationToken.setDetails(new WebAuthenticationDetailsSource().buildDetails(request)); // é€šè¿‡éªŒè¯ï¼Œåœ¨Spring Securityä¸Šä¸‹æ–‡ä¸­å†™å…¥ç”¨æˆ·ç™»å½•ç›¸å…³æ‰€æœ‰ä¿¡æ¯ SecurityContextHolder.getContext().setAuthentication(authenticationToken); } chain.doFilter(request, response); } } å¦‚ä½•æ ¹æ®tokenè·å–ç™»å½•ç”¨æˆ·ä¿¡æ¯\næ ¸å¿ƒï¼šä»requestè§£ætokenè·å–å…¶ä¸­çš„userIdï¼Œåˆ°redisä¸­æ ¹æ®userIdè·å–ç”¨æˆ·ä¿¡æ¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 /** * è·å–ç”¨æˆ·èº«ä»½ä¿¡æ¯ * * @return ç”¨æˆ·ä¿¡æ¯ */ public LoginUser getLoginUser(HttpServletRequest request) { // è·å–è¯·æ±‚æºå¸¦çš„ä»¤ç‰Œ String token = getToken(request); if (StringUtils.isNotEmpty(token)) { try { Claims claims = parseToken(token); // è§£æå¯¹åº”çš„æƒé™ä»¥åŠç”¨æˆ·ä¿¡æ¯ String uuid = (String) claims.get(Constants.LOGIN_USER_KEY); String userKey = getTokenKey(uuid); LoginUser user = redisCache.get(userKey); return user; } catch (Exception e) { log.error(e.getMessage()); } } return null; } /** * ä»¤ç‰Œå‰ç¼€ */ public static final String TOKEN_PREFIX = \"Bearer \"; /** * è·å–è¯·æ±‚token * * @param request * @return token */ private String getToken(HttpServletRequest request) { String token = request.getHeader(header); if (StringUtils.isNotEmpty(token) \u0026\u0026 token.startsWith(Constants.TOKEN_PREFIX)) { token = token.replace(Constants.TOKEN_PREFIX, \"\"); } return token; } /** * ä»ä»¤ç‰Œä¸­è·å–æ•°æ®å£°æ˜ * * @param token ä»¤ç‰Œ * @return æ•°æ®å£°æ˜ */ private Claims parseToken(String token) { return Jwts.parser() .setSigningKey(secret) .parseClaimsJws(token) .getBody(); } 2.4 é…ç½®SecurityConfig åœ¨SecurityConfigä¸­æ³¨å…¥ï¼š\nLogoutSuccessHandlerImpl è‡ªå®šä¹‰å®ç°çš„UserDetailsService JwtAuthenticationTokenFilter AuthenticationEntryPoint CorsFilter â€¦ ä»¥åŠç›¸å…³æƒé™æ§åˆ¶configure\nå®Œæ•´spring securityé…ç½®å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 /** * spring securityé…ç½® * * @author 7bin */ @EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true) public class SecurityConfig extends WebSecurityConfigurerAdapter { /** * è‡ªå®šä¹‰ç”¨æˆ·è®¤è¯é€»è¾‘ */ @Autowired private UserDetailsService userDetailsService; /** * è®¤è¯å¤±è´¥å¤„ç†ç±»ï¼ˆæŠ›å‡ºAuthenticationExceptionå¼‚å¸¸èµ°è¿™é‡Œï¼‰ */ @Autowired private AuthenticationEntryPointImpl unauthorizedHandler; /** * é€€å‡ºå¤„ç†ç±» */ @Autowired private LogoutSuccessHandlerImpl logoutSuccessHandler; /** * tokenè®¤è¯è¿‡æ»¤å™¨ */ @Autowired private JwtAuthenticationTokenFilter authenticationTokenFilter; /** * è·¨åŸŸè¿‡æ»¤å™¨ */ @Autowired private CorsFilter corsFilter; /** * å…è®¸åŒ¿åè®¿é—®çš„åœ°å€ */ @Autowired private PermitAllUrlProperties permitAllUrl; /** * è§£å†³ æ— æ³•ç›´æ¥æ³¨å…¥ AuthenticationManager * * @return * @throws Exception */ @Bean @Override public AuthenticationManager authenticationManagerBean() throws Exception { return super.authenticationManagerBean(); } /** * anyRequest | åŒ¹é…æ‰€æœ‰è¯·æ±‚è·¯å¾„ * access | SpringElè¡¨è¾¾å¼ç»“æœä¸ºtrueæ—¶å¯ä»¥è®¿é—® * anonymous | åŒ¿åå¯ä»¥è®¿é—® * denyAll | ç”¨æˆ·ä¸èƒ½è®¿é—® * fullyAuthenticated | ç”¨æˆ·å®Œå…¨è®¤è¯å¯ä»¥è®¿é—®ï¼ˆéremember-meä¸‹è‡ªåŠ¨ç™»å½•ï¼‰ * hasAnyAuthority | å¦‚æœæœ‰å‚æ•°ï¼Œå‚æ•°è¡¨ç¤ºæƒé™ï¼Œåˆ™å…¶ä¸­ä»»ä½•ä¸€ä¸ªæƒé™å¯ä»¥è®¿é—® * hasAnyRole | å¦‚æœæœ‰å‚æ•°ï¼Œå‚æ•°è¡¨ç¤ºè§’è‰²ï¼Œåˆ™å…¶ä¸­ä»»ä½•ä¸€ä¸ªè§’è‰²å¯ä»¥è®¿é—® * hasAuthority | å¦‚æœæœ‰å‚æ•°ï¼Œå‚æ•°è¡¨ç¤ºæƒé™ï¼Œåˆ™å…¶æƒé™å¯ä»¥è®¿é—® * hasIpAddress | å¦‚æœæœ‰å‚æ•°ï¼Œå‚æ•°è¡¨ç¤ºIPåœ°å€ï¼Œå¦‚æœç”¨æˆ·IPå’Œå‚æ•°åŒ¹é…ï¼Œåˆ™å¯ä»¥è®¿é—® * hasRole | å¦‚æœæœ‰å‚æ•°ï¼Œå‚æ•°è¡¨ç¤ºè§’è‰²ï¼Œåˆ™å…¶è§’è‰²å¯ä»¥è®¿é—® * permitAll | ç”¨æˆ·å¯ä»¥ä»»æ„è®¿é—® * rememberMe | å…è®¸é€šè¿‡remember-meç™»å½•çš„ç”¨æˆ·è®¿é—® * authenticated | ç”¨æˆ·ç™»å½•åå¯è®¿é—® */ @Override protected void configure(HttpSecurity httpSecurity) throws Exception { // æ³¨è§£æ ‡è®°å…è®¸åŒ¿åè®¿é—®çš„url ExpressionUrlAuthorizationConfigurer\u003cHttpSecurity\u003e.ExpressionInterceptUrlRegistry registry = httpSecurity.authorizeRequests(); permitAllUrl.getUrls().forEach(url -\u003e registry.antMatchers(url).permitAll()); httpSecurity // CSRFç¦ç”¨ï¼Œå› ä¸ºä¸ä½¿ç”¨session // å…³é—­csrfåŠŸèƒ½:è·¨ç«™è¯·æ±‚ä¼ªé€ ,é»˜è®¤åªèƒ½é€šè¿‡postæ–¹å¼æäº¤logoutè¯·æ±‚ .csrf().disable() // è®¤è¯å¤±è´¥å¤„ç†ç±» .exceptionHandling().authenticationEntryPoint(unauthorizedHandler).and() // åŸºäºtokenï¼Œæ‰€ä»¥ä¸éœ€è¦session .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS).and() // è¿‡æ»¤è¯·æ±‚ .authorizeRequests() // anonymous() :åŒ¿åè®¿é—®, ä»…å…è®¸åŒ¿åç”¨æˆ·è®¿é—®, å¦‚æœç™»å½•è®¤è¯å, å¸¦æœ‰tokenä¿¡æ¯å†å»è¯·æ±‚, è¿™ä¸ªanonymous()å…³è”çš„èµ„æºå°±ä¸èƒ½è¢«è®¿é—®ï¼Œ // permitAll() :ç™»å½•èƒ½è®¿é—®,ä¸ç™»å½•ä¹Ÿèƒ½è®¿é—®, ä¸€èˆ¬ç”¨äºé™æ€èµ„æºjsç­‰ // å¯¹äºç™»å½•login æ³¨å†Œregister éªŒè¯ç captchaImage å…è®¸åŒ¿åè®¿é—® .antMatchers(\"/login\", \"/register\", \"/captchaImage\",\"/docker/**\").anonymous() // é™æ€èµ„æºï¼Œå¯åŒ¿åè®¿é—® .antMatchers(HttpMethod.GET, \"/\", \"/*.html\", \"/**/*.html\", \"/**/*.css\", \"/**/*.js\", \"/profile/**\").permitAll() .antMatchers(\"/swagger-ui.html\", \"/swagger-resources/**\", \"/webjars/**\", \"/*/api-docs\", \"/druid/**\").permitAll() // é™¤ä¸Šé¢å¤–çš„æ‰€æœ‰è¯·æ±‚å…¨éƒ¨éœ€è¦é‰´æƒè®¤è¯ .anyRequest().authenticated() .and() .headers().frameOptions().disable(); // æ·»åŠ Logout filter httpSecurity.logout().logoutUrl(\"/logout\").logoutSuccessHandler(logoutSuccessHandler); // æ·»åŠ JWT filter httpSecurity.addFilterBefore(authenticationTokenFilter, UsernamePasswordAuthenticationFilter.class); // æ·»åŠ CORS filter httpSecurity.addFilterBefore(corsFilter, JwtAuthenticationTokenFilter.class); httpSecurity.addFilterBefore(corsFilter, LogoutFilter.class); } /** * å¼ºæ•£åˆ—å“ˆå¸ŒåŠ å¯†å®ç° */ @Bean public BCryptPasswordEncoder bCryptPasswordEncoder() { return new BCryptPasswordEncoder(); } /** * èº«ä»½è®¤è¯æ¥å£ */ @Override protected void configure(AuthenticationManagerBuilder auth) throws Exception { // æ•°æ®åº“éªŒè¯ // Spring Security æä¾›äº†BCryptPasswordEncoderç±», // å®ç°Springçš„PasswordEncoderæ¥å£ä½¿ç”¨BCryptå¼ºå“ˆå¸Œæ–¹æ³•æ¥åŠ å¯†å¯†ç  auth.userDetailsService(userDetailsService).passwordEncoder(bCryptPasswordEncoder()); } } 2.5 æ€è€ƒ ä»€ä¹ˆæ—¶å€™ä¼šèµ°åˆ°è®¤è¯å¤±è´¥çš„å¤„ç†ç±»å‘¢ï¼ˆè¿˜ä¸çŸ¥é“ï¼‰\nhttpSecurity.exceptionHandling().authenticationEntryPoint(unauthorizedHandler)\nAuthenticationExceptionå¼‚å¸¸è¯¦è§£\n3 æˆæƒ 3.1 RBACæƒé™æ¨¡å‹ RBACæƒé™æ¨¡å‹ï¼ˆRole-Based Access Controlï¼‰å³ï¼šåŸºäºè§’è‰²çš„æƒé™æ§åˆ¶ã€‚è¿™æ˜¯ç›®å‰æœ€å¸¸è¢«å¼€å‘è€…ä½¿ç”¨ä¹Ÿæ˜¯ç›¸å¯¹æ˜“ç”¨ã€é€šç”¨æƒé™æ¨¡å‹ã€‚\n3.1.1 æ•°æ®åº“è¡¨ç»“æ„ å¦‚ä¸‹å›¾æ˜¯RBACæƒé™æ¨¡å‹å„è¡¨çš„åŸºæœ¬å±æ€§\nå½“åˆ¤æ–­æŸä¸ªç”¨æˆ·æ˜¯å¦æ‹¥æœ‰æŸä¸ªæƒé™çš„æ—¶å€™ï¼Œå¯æ ¹æ®user_roleè¡¨è·å–åˆ°è¯¥userå…³è”çš„roleï¼Œä¹‹åå¯æ ¹æ®role_menuè¡¨è·å–åˆ°è¯¥roleèƒ½å¤Ÿè®¿é—®çš„menuï¼ˆæƒé™ï¼‰\n3.1.2 å¦‚ä½•è·å–ç”¨æˆ·å…·æœ‰å“ªäº›æƒé™ï¼Ÿ åœ¨ç”¨æˆ·ç™»å½•çš„æ—¶å€™ï¼ˆloadUserByUsernameæ–¹æ³•ä¸­ï¼‰ï¼Œå°†æƒé™ä¿¡æ¯å†™å…¥LoginUserä¸­\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 @Override public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException { SysUser user = userService.selectUserByUserName(username); if (StringUtils.isNull(user)) { log.info(\"ç™»å½•ç”¨æˆ·ï¼š{} ä¸å­˜åœ¨.\", username); throw new ServiceException(\"ç™»å½•ç”¨æˆ·ï¼š\" + username + \" ä¸å­˜åœ¨\"); } else if (UserStatus.DELETED.getCode().equals(user.getDelFlag())) { log.info(\"ç™»å½•ç”¨æˆ·ï¼š{} å·²è¢«åˆ é™¤.\", username); throw new ServiceException(\"å¯¹ä¸èµ·ï¼Œæ‚¨çš„è´¦å·ï¼š\" + username + \" å·²è¢«åˆ é™¤\"); } else if (UserStatus.DISABLE.getCode().equals(user.getStatus())) { log.info(\"ç™»å½•ç”¨æˆ·ï¼š{} å·²è¢«åœç”¨.\", username); throw new ServiceException(\"å¯¹ä¸èµ·ï¼Œæ‚¨çš„è´¦å·ï¼š\" + username + \" å·²åœç”¨\"); } passwordService.validate(user); return createLoginUser(user); } public UserDetails createLoginUser(SysUser user) { return new LoginUser(user.getUserId(), user, permissionService.getMenuPermission(user)); } PermissionService\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 /** * è·å–èœå•æ•°æ®æƒé™ * * @param user ç”¨æˆ·ä¿¡æ¯ * @return èœå•æƒé™ä¿¡æ¯ */ public Set\u003cString\u003e getMenuPermission(SysUser user) { Set\u003cString\u003e perms = new HashSet\u003cString\u003e(); // ç®¡ç†å‘˜æ‹¥æœ‰æ‰€æœ‰æƒé™ if (user.isAdmin()) { perms.add(\"*:*:*\"); } else { List\u003cSysRole\u003e roles = user.getRoles(); if (!roles.isEmpty() \u0026\u0026 roles.size() \u003e 1) { // å¤šè§’è‰²è®¾ç½®permissionså±æ€§ï¼Œä»¥ä¾¿æ•°æ®æƒé™åŒ¹é…æƒé™ for (SysRole role : roles) { Set\u003cString\u003e rolePerms = menuService.selectMenuPermsByRoleId(role.getRoleId()); role.setPermissions(rolePerms); perms.addAll(rolePerms); } } else { perms.addAll(menuService.selectMenuPermsByUserId(user.getUserId())); } } return perms; } Mapper\n1 2 3 4 5 6 7 8 ",
  "wordCount" : "8435",
  "inLanguage": "zh",
  "datePublished": "2023-06-18T00:00:00Z",
  "dateModified": "2023-06-18T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "chance7bin"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://chance7bin.github.io/posts/design/%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Binb's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://chance7bin.github.io/" accesskey="h" title="Binb&#39;s Blog (Alt + H)">
                <img src="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg" alt="" aria-label="logo"
                    height="35">Binb&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://chance7bin.github.io/search" title="ğŸ”æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ”æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="https://chance7bin.github.io/" title="ğŸ  ä¸»é¡µ">
                    <span>ğŸ  ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://chance7bin.github.io/archives/" title="â±ï¸ æ—¶é—´è½´">
                    <span>â±ï¸ æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://chance7bin.github.io/posts" title="ğŸ“š æ–‡ç« ">
                    <span>ğŸ“š æ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://chance7bin.github.io/tags" title="ğŸ”– æ ‡ç­¾">
                    <span>ğŸ”– æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://github.com/chance7bin" title="GitHub">
                    <span>GitHub</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://chance7bin.github.io/">ğŸ  ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://chance7bin.github.io/posts/">ğŸ“š æ–‡ç« </a>&nbsp;Â»&nbsp;<a href="https://chance7bin.github.io/posts/design/">ğŸ¨ ç³»ç»Ÿè®¾è®¡</a></div>
    <h1 class="post-title">
      æƒé™ç®¡ç†æ¨¡å—å®ç°
    </h1>
    <div class="post-meta">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">


<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }

    .parent-post-meta {
        display: flex;
        flex-wrap: wrap;
        opacity: 0.8;
    }
</style>

<span class="parent-post-meta">
    <span id="post_meta_style_1">
        <span class="fa fa-calendar-check-o"></span>
        <span>2023-06-18
            &nbsp;&nbsp;
        </span>
    </span>
    
    
    
    
    
    
    
    <span id="post_meta_style_3">
        <span class="fa fa-file-word-o"></span>
        <span>8435å­—
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_4">
        <span class="fa fa-clock-o"></span>
        <span>17åˆ†é’Ÿ
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_5">
        <span class="fa fa-user-o"></span>
        <span>chance7bin
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_6">
        <span class="fa fa-tags" style="opacity: 0.8"></span>
        <span>
            <span class="post-tags-meta">
                <a href="https://chance7bin.github.io/tags/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/" style="color: var(--secondary)!important;">ç³»ç»Ÿè®¾è®¡</a>
                &nbsp;<a href="https://chance7bin.github.io/tags/%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/" style="color: var(--secondary)!important;">æƒé™ç®¡ç†</a>
            </span>
        </span>
    </span>

    
</span>


      
      
      
      
      
      
      
          
          
          
              
              
              
              
          
      
    </div>
  </header>
   <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#0-%e5%bc%95%e8%a8%80" aria-label="0 å¼•è¨€">0 å¼•è¨€</a></li>
                    <li>
                        <a href="#1-spring-security" aria-label="1 Spring Security">1 Spring Security</a><ul>
                            
                    <li>
                        <a href="#11-spring-security%e5%8e%9f%e7%90%86%e5%88%9d%e6%8e%a2" aria-label="1.1 Spring SecurityåŸç†åˆæ¢">1.1 Spring SecurityåŸç†åˆæ¢</a></li>
                    <li>
                        <a href="#12-spring-secutity%e6%a0%b8%e5%bf%83%e5%86%85%e5%ae%b9" aria-label="1.2 Spring Secutityæ ¸å¿ƒå†…å®¹">1.2 Spring Secutityæ ¸å¿ƒå†…å®¹</a><ul>
                            
                    <li>
                        <a href="#121-spring-secutity%e4%b8%ad%e7%9a%84%e7%94%a8%e6%88%b7%e4%bf%a1%e6%81%af" aria-label="1.2.1 Spring Secutityä¸­çš„ç”¨æˆ·ä¿¡æ¯">1.2.1 Spring Secutityä¸­çš„ç”¨æˆ·ä¿¡æ¯</a></li>
                    <li>
                        <a href="#122-spring-security%e7%9a%84%e9%85%8d%e7%bd%ae" aria-label="1.2.2 Spring Securityçš„é…ç½®">1.2.2 Spring Securityçš„é…ç½®</a></li>
                    <li>
                        <a href="#123-%e8%ae%a4%e8%af%81%e8%bf%87%e7%a8%8b" aria-label="1.2.3 è®¤è¯è¿‡ç¨‹">1.2.3 è®¤è¯è¿‡ç¨‹</a></li>
                    <li>
                        <a href="#124-%e8%bf%87%e6%bb%a4%e5%99%a8%e5%92%8c%e8%bf%87%e6%bb%a4%e9%93%be" aria-label="1.2.4 è¿‡æ»¤å™¨å’Œè¿‡æ»¤é“¾">1.2.4 è¿‡æ»¤å™¨å’Œè¿‡æ»¤é“¾</a></li>
                    <li>
                        <a href="#125-%e6%9d%83%e9%99%90%e7%9b%b8%e5%85%b3" aria-label="1.2.5 æƒé™ç›¸å…³">1.2.5 æƒé™ç›¸å…³</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#2-%e8%ae%a4%e8%af%81" aria-label="2 è®¤è¯">2 è®¤è¯</a><ul>
                            
                    <li>
                        <a href="#21-%e7%99%bb%e5%bd%95%e6%a0%a1%e9%aa%8c%e6%b5%81%e7%a8%8b" aria-label="2.1 ç™»å½•æ ¡éªŒæµç¨‹">2.1 ç™»å½•æ ¡éªŒæµç¨‹</a></li>
                    <li>
                        <a href="#22-%e7%99%bb%e5%bd%95%e5%8a%9f%e8%83%bd%e6%a0%b8%e5%bf%83%e4%bb%a3%e7%a0%81" aria-label="2.2 ç™»å½•åŠŸèƒ½æ ¸å¿ƒä»£ç ">2.2 ç™»å½•åŠŸèƒ½æ ¸å¿ƒä»£ç </a></li>
                    <li>
                        <a href="#23-%e6%a0%a1%e9%aa%8c%e5%8a%9f%e8%83%bd%e6%a0%b8%e5%bf%83%e4%bb%a3%e7%a0%81" aria-label="2.3 æ ¡éªŒåŠŸèƒ½æ ¸å¿ƒä»£ç ">2.3 æ ¡éªŒåŠŸèƒ½æ ¸å¿ƒä»£ç </a></li>
                    <li>
                        <a href="#24-%e9%85%8d%e7%bd%aesecurityconfig" aria-label="2.4 é…ç½®SecurityConfig">2.4 é…ç½®SecurityConfig</a></li>
                    <li>
                        <a href="#25-%e6%80%9d%e8%80%83" aria-label="2.5 æ€è€ƒ">2.5 æ€è€ƒ</a></li></ul>
                    </li>
                    <li>
                        <a href="#3-%e6%8e%88%e6%9d%83" aria-label="3 æˆæƒ">3 æˆæƒ</a><ul>
                            
                    <li>
                        <a href="#31-rbac%e6%9d%83%e9%99%90%e6%a8%a1%e5%9e%8b" aria-label="3.1 RBACæƒé™æ¨¡å‹">3.1 RBACæƒé™æ¨¡å‹</a><ul>
                            
                    <li>
                        <a href="#311-%e6%95%b0%e6%8d%ae%e5%ba%93%e8%a1%a8%e7%bb%93%e6%9e%84" aria-label="3.1.1 æ•°æ®åº“è¡¨ç»“æ„">3.1.1 æ•°æ®åº“è¡¨ç»“æ„</a></li>
                    <li>
                        <a href="#312-%e5%a6%82%e4%bd%95%e8%8e%b7%e5%8f%96%e7%94%a8%e6%88%b7%e5%85%b7%e6%9c%89%e5%93%aa%e4%ba%9b%e6%9d%83%e9%99%90" aria-label="3.1.2 å¦‚ä½•è·å–ç”¨æˆ·å…·æœ‰å“ªäº›æƒé™ï¼Ÿ">3.1.2 å¦‚ä½•è·å–ç”¨æˆ·å…·æœ‰å“ªäº›æƒé™ï¼Ÿ</a></li></ul>
                    </li>
                    <li>
                        <a href="#32-preauthorize" aria-label="3.2 @PreAuthorize">3.2 @PreAuthorize</a></li>
                    <li>
                        <a href="#33-%e8%87%aa%e5%ae%9a%e4%b9%89%e6%9d%83%e9%99%90" aria-label="3.3 è‡ªå®šä¹‰æƒé™">3.3 è‡ªå®šä¹‰æƒé™</a><ul>
                            
                    <li>
                        <a href="#321-%e6%b3%a8%e8%a7%a3%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8" aria-label="3.2.1 æ³¨è§£å¦‚ä½•ä½¿ç”¨ï¼Ÿ">3.2.1 æ³¨è§£å¦‚ä½•ä½¿ç”¨ï¼Ÿ</a></li>
                    <li>
                        <a href="#322-%e8%87%aa%e5%ae%9a%e4%b9%89%e6%9d%83%e9%99%90%e5%ae%9e%e7%8e%b0" aria-label="3.2.2 è‡ªå®šä¹‰æƒé™å®ç°">3.2.2 è‡ªå®šä¹‰æƒé™å®ç°</a></li>
                    <li>
                        <a href="#323-%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8%e5%8e%9f%e7%94%9f%e7%9a%84%e6%9d%83%e9%99%90" aria-label="3.2.3 å¦‚ä½•ä½¿ç”¨åŸç”Ÿçš„æƒé™ï¼Ÿ">3.2.3 å¦‚ä½•ä½¿ç”¨åŸç”Ÿçš„æƒé™ï¼Ÿ</a></li></ul>
                    </li>
                    <li>
                        <a href="#34-%e5%89%8d%e7%ab%af%e6%9d%83%e9%99%90%e6%a0%a1%e9%aa%8c" aria-label="3.4 å‰ç«¯æƒé™æ ¡éªŒ">3.4 å‰ç«¯æƒé™æ ¡éªŒ</a><ul>
                            
                    <li>
                        <a href="#341-%e8%87%aa%e5%ae%9a%e4%b9%89%e6%8c%87%e4%bb%a4-directives" aria-label="3.4.1 è‡ªå®šä¹‰æŒ‡ä»¤-Directives">3.4.1 è‡ªå®šä¹‰æŒ‡ä»¤-Directives</a></li>
                    <li>
                        <a href="#342-%e5%85%a8%e5%b1%80%e6%b3%a8%e5%86%8c%e8%87%aa%e5%ae%9a%e4%b9%89%e6%8c%87%e4%bb%a4" aria-label="3.4.2 å…¨å±€æ³¨å†Œè‡ªå®šä¹‰æŒ‡ä»¤">3.4.2 å…¨å±€æ³¨å†Œè‡ªå®šä¹‰æŒ‡ä»¤</a></li>
                    <li>
                        <a href="#343-%e4%bd%bf%e7%94%a8%e8%87%aa%e5%ae%9a%e4%b9%89%e6%8c%87%e4%bb%a4" aria-label="3.4.3 ä½¿ç”¨è‡ªå®šä¹‰æŒ‡ä»¤">3.4.3 ä½¿ç”¨è‡ªå®šä¹‰æŒ‡ä»¤</a>
                    </li>
                </ul>
                </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>
  <div class="post-content"><h2 id="0-å¼•è¨€">0 å¼•è¨€<a hidden class="anchor" aria-hidden="true" href="#0-å¼•è¨€">#</a></h2>
<p><strong>è¯¥ç¯‡æ–‡ç« æ˜¯å¯¹Spring Securityå­¦ä¹ çš„æ€»ç»“ï¼Œä»¥åŠç³»ç»Ÿä¸­è®¤è¯æˆæƒçš„ä»£ç å®ç°</strong></p>
<blockquote>
<p><strong>å‚è€ƒé“¾æ¥</strong></p>
<p><a href="https://blog.csdn.net/weixin_43847283/article/details/124075302">SpringSecurity-ä»å…¥é—¨åˆ°ç²¾é€š</a></p>
</blockquote>
<h2 id="1-spring-security">1 Spring Security<a hidden class="anchor" aria-hidden="true" href="#1-spring-security">#</a></h2>
<p>Spring Security æ˜¯ Spring å®¶æ—ä¸­çš„ä¸€ä¸ªå®‰å…¨ç®¡ç†æ¡†æ¶ã€‚ç›¸æ¯”ä¸å¦å¤–ä¸€ä¸ªå®‰å…¨æ¡†æ¶Shiroï¼Œå®ƒæä¾›äº†æ›´ä¸°å¯Œçš„åŠŸèƒ½ï¼Œç¤¾åŒºèµ„æºä¹Ÿæ¯”Shiroä¸°å¯Œã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ä¸­å¤§å‹çš„é¡¹ç›®éƒ½æ˜¯ä½¿ç”¨SpringSecurity æ¥åšå®‰å…¨æ¡†æ¶ã€‚å°é¡¹ç›®æœ‰Shiroçš„æ¯”è¾ƒå¤šï¼Œå› ä¸ºç›¸æ¯”ä¸SpringSecurityï¼ŒShiroçš„ä¸Šæ‰‹æ›´åŠ çš„ç®€å•ã€‚</p>
<p>ä¸€èˆ¬Webåº”ç”¨çš„éœ€è¦è¿›è¡Œè®¤è¯å’Œæˆæƒã€‚</p>
<p><strong>è®¤è¯ï¼šéªŒè¯å½“å‰è®¿é—®ç³»ç»Ÿçš„æ˜¯ä¸æ˜¯æœ¬ç³»ç»Ÿçš„ç”¨æˆ·ï¼Œå¹¶ä¸”è¦ç¡®è®¤å…·ä½“æ˜¯å“ªä¸ªç”¨æˆ·</strong></p>
<p><strong>æˆæƒï¼šç»è¿‡è®¤è¯ååˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è¿›è¡ŒæŸä¸ªæ“ä½œ</strong></p>
<p>è€Œ<strong>è®¤è¯å’Œæˆæƒ</strong>ä¹Ÿæ˜¯SpringSecurityä½œä¸ºå®‰å…¨æ¡†æ¶çš„æ ¸å¿ƒåŠŸèƒ½ã€‚</p>
<h3 id="11-spring-securityåŸç†åˆæ¢">1.1 Spring SecurityåŸç†åˆæ¢<a hidden class="anchor" aria-hidden="true" href="#11-spring-securityåŸç†åˆæ¢">#</a></h3>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202307182337684.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"  />
</p>
<p><strong>è®¤è¯åŸºæœ¬æµç¨‹ï¼š</strong></p>
<ol>
<li>æ ¹æ®<code>username, password</code>å°è£…ä¸€ä¸ª<code>Authentication</code>å¯¹è±¡<code>authenticationToken</code>ï¼Œå¹¶åŠ å…¥åˆ°<code>SecurityContextHolder</code>çš„<code>context</code>ä¸­</li>
<li>è°ƒç”¨<code>AuthenticationManager</code>æ¥å£çš„<code>authenticate(authenticationToken)</code>æ–¹æ³•è¿›è¡Œè®¤è¯</li>
<li>åœ¨ç¬¬2æ­¥è°ƒç”¨<code>authenticate</code>æ–¹æ³•æ—¶ï¼Œå®ƒå®é™…ä¼šæ‰§è¡Œå®ç°äº†<code>UserDetailsService</code>æ¥å£çš„<code>loadUserByUsername</code>æ–¹æ³•ï¼Œè®¤è¯ç”¨æˆ·çš„é€»è¾‘å°±å†™åœ¨è¯¥æ–¹æ³•ä¸­</li>
<li>åœ¨<code>loadUserByUsername</code>æ–¹æ³•ä¸­ï¼Œä»<code>AuthenticationContextHolder</code>è·å–ç¬¬ä¸€æ­¥ä¼ å…¥çš„<code>username, password</code>ï¼Œä¸æ•°æ®åº“çš„å¯†ç åšå¯¹æ¯”ï¼ŒéªŒè¯ç”¨æˆ·å¯†ç æ˜¯å¦æ­£ç¡®ï¼Œè‹¥æ­£ç¡®ï¼Œåˆ™æŠŠç”¨æˆ·ä¿¡æ¯å°è£…åˆ°å®ç°äº†<code>UserDetails</code>æ¥å£çš„ç±»ä¸­</li>
</ol>
<blockquote>
<p><strong>æ­¥éª¤1æ‰©å±•</strong></p>
<p>è®¤è¯è¿‡æ»¤å™¨<code>UsernamePasswordAuthenticationFilter</code>ï¼šå®ƒçš„ä½œç”¨æ˜¯æ‹¦æˆªç™»å½•è¯·æ±‚å¹¶è·å–è´¦å·å’Œå¯†ç ï¼Œç„¶åæŠŠè´¦å·å¯†ç å°è£…åˆ°è®¤è¯å‡­æ® <code>UsernamePasswordAuthenticationToken</code> ä¸­ï¼Œç„¶åæŠŠå‡­æ®äº¤ ç»™ç‰¹å®šé…ç½®çš„ <code>AuthenticationManager</code>å»ä½œè®¤è¯ã€‚</p>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202307182337691.png" alt="image-20210312074036145"  />
</p>
<p><strong>æ­¥éª¤2æ‰©å±•</strong></p>
<p><code>AuthenticationManager</code> çš„å®ç° <code>ProviderManager</code> ç®¡ç†äº†ä¼—å¤šçš„ <code>AuthenticationProvider</code> ã€‚æ¯ ä¸€ä¸ª <code>AuthenticationProvider</code>éƒ½åªæ”¯æŒç‰¹å®šç±»å‹çš„ <code>Authentication</code> ï¼Œç„¶åæ˜¯å¯¹é€‚é…åˆ°çš„ <code>Authentication</code> è¿›è¡Œè®¤è¯ï¼Œåªè¦æœ‰ä¸€ä¸ª <code>AuthenticationProvider</code>è®¤è¯æˆåŠŸï¼Œé‚£ä¹ˆå°±è®¤ä¸ºè®¤è¯æˆåŠŸï¼Œæ‰€æœ‰çš„éƒ½æ²¡æœ‰é€šè¿‡æ‰è®¤ä¸ºæ˜¯è®¤è¯å¤±è´¥ã€‚è®¤è¯æˆåŠŸåçš„ <code>Authentication</code> å°±å˜æˆæˆä¿¡å‡­æ®ï¼Œå¹¶è§¦å‘è®¤è¯æˆåŠŸçš„äº‹ä»¶ã€‚è®¤è¯å¤±è´¥çš„å°±æŠ›å‡ºå¼‚å¸¸è§¦å‘è®¤è¯å¤±è´¥çš„äº‹ä»¶ã€‚</p>
</blockquote>
<h3 id="12-spring-secutityæ ¸å¿ƒå†…å®¹">1.2 Spring Secutityæ ¸å¿ƒå†…å®¹<a hidden class="anchor" aria-hidden="true" href="#12-spring-secutityæ ¸å¿ƒå†…å®¹">#</a></h3>
<h4 id="121-spring-secutityä¸­çš„ç”¨æˆ·ä¿¡æ¯">1.2.1 Spring Secutityä¸­çš„ç”¨æˆ·ä¿¡æ¯<a hidden class="anchor" aria-hidden="true" href="#121-spring-secutityä¸­çš„ç”¨æˆ·ä¿¡æ¯">#</a></h4>
<p>1.<code>UserDetailsService</code>ï¼š</p>
<p>è¯¥æ–¹æ³•å¾ˆå®¹æ˜“ç†è§£ï¼š <strong>é€šè¿‡ç”¨æˆ·åæ¥åŠ è½½ç”¨æˆ·</strong> ã€‚è¿™ä¸ªæ–¹æ³•ä¸»è¦ç”¨äºä»ç³»ç»Ÿæ•°æ®ä¸­æŸ¥è¯¢å¹¶åŠ è½½å…·ä½“çš„ç”¨æˆ·åˆ° Spring Securityä¸­ã€‚</p>
<p>åœ¨å¼€å‘ä¸­æˆ‘ä»¬ä¸€èˆ¬å®šä¹‰ä¸€ä¸ªè¿™ä¸ªæ¥å£çš„å®ç°ç±»ï¼Œè‡ªå®šä¹‰<code>loadUserByUsername</code>æ–¹æ³•ï¼Œå®ç°ä»æ•°æ®æºè·å–ç”¨æˆ·ï¼ŒåŠ è½½ç”¨æˆ·ä¿¡æ¯ã€‚ä¹Ÿå¯ä»¥åœ¨å…¶ä¸­å®ç°ä¸€äº›æ ¡éªŒç”¨æˆ·é€»è¾‘ã€‚</p>
<p>2.<code>UserDetails</code>:</p>
<p>ä»ä¸Šé¢ UserDetailsService å¯ä»¥çŸ¥é“æœ€ç»ˆäº¤ç»™Spring Securityçš„æ˜¯<code>UserDetails</code> ã€‚è¯¥æ¥å£æ˜¯æä¾›ç”¨æˆ·ä¿¡æ¯çš„æ ¸å¿ƒæ¥å£ã€‚è¯¥æ¥å£å®ç°ä»…ä»…å­˜å‚¨ç”¨æˆ·çš„ä¿¡æ¯ã€‚åç»­ä¼šå°†è¯¥æ¥å£æä¾›çš„ç”¨æˆ·ä¿¡æ¯å°è£…åˆ°è®¤è¯å¯¹è±¡<code>Authentication</code> ä¸­å»ã€‚</p>
<p><code>UserDetails</code>ä¸­é»˜è®¤æä¾›ï¼š</p>
<ul>
<li>ç”¨æˆ·çš„æƒé™é›†ï¼Œ é»˜è®¤éœ€è¦æ·»åŠ  ROLE_ å‰ç¼€</li>
<li>ç”¨æˆ·çš„åŠ å¯†åçš„å¯†ç ï¼Œ ä¸åŠ å¯†ä¼šä½¿ç”¨ {noop} å‰ç¼€</li>
<li>åº”ç”¨å†…å”¯ä¸€çš„ç”¨æˆ·å</li>
<li>è´¦æˆ·æ˜¯å¦è¿‡æœŸ</li>
<li>è´¦æˆ·æ˜¯å¦é”å®š</li>
<li>å‡­è¯æ˜¯å¦è¿‡æœŸ</li>
<li>ç”¨æˆ·æ˜¯å¦å¯ç”¨</li>
</ul>
<p><strong>åœ¨æˆ‘ä»¬è‡ªå·±çš„é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬è¦å®šä¹‰ä¸ªç”¨æˆ·ç±»å®ç°è¯¥æ¥å£ï¼Œåœ¨è¯¥ç”¨æˆ·ç±»ä¸­æˆ‘ä»¬å¯ä»¥æ‰©å±•æ›´å¤šçš„ç”¨æˆ·ä¿¡æ¯ï¼Œæ¯”å¦‚æ‰‹æœºã€é‚®ç®±ç­‰ç­‰</strong></p>
<h4 id="122-spring-securityçš„é…ç½®">1.2.2 Spring Securityçš„é…ç½®<a hidden class="anchor" aria-hidden="true" href="#122-spring-securityçš„é…ç½®">#</a></h4>
<p>è‡ªå®šä¹‰<code>SecurityConfig</code></p>
<p>é¦–å…ˆè¦ç»§æ‰¿<code>WebSecurityConfigurerAdapter</code>ï¼Œå…¶æ¬¡æœ€å¸¸ç”¨çš„æ˜¯å®ç°<code>configure(AuthenticationManagerBuilder auth)</code>ã€<code>configure(WebSecurity web)</code>ã€<code>configure(HttpSecurity http)</code>ä¸‰ä¸ªæ–¹æ³•å®ç°æˆ‘ä»¬å¯¹Spring Securityçš„è‡ªå®šä¹‰å®‰å…¨é…ç½®ã€‚</p>
<ul>
<li><code>void configure(AuthenticationManagerBuilder auth)</code> ç”¨æ¥é…ç½®è®¤è¯ç®¡ç†å™¨ <code>AuthenticationManager</code>ã€‚</li>
<li><code>void configure(WebSecurity web)</code>ç”¨æ¥é…ç½® <code>WebSecurity</code> ã€‚è€Œ <code>WebSecurity</code>æ˜¯åŸºäº<code>Servlet Filter</code>ç”¨æ¥é…ç½® <code>springSecurityFilterChain</code>ã€‚è€Œ <code>springSecurityFilterChain</code> åˆè¢«å§”æ‰˜ç»™äº† Spring Security æ ¸å¿ƒè¿‡æ»¤å™¨ Bean <code>DelegatingFilterProxy</code> ã€‚ ç›¸å…³é€»è¾‘å¯ä»¥åœ¨ <code>WebSecurityConfiguration</code> ä¸­æ‰¾åˆ°ã€‚æˆ‘ä»¬ä¸€èˆ¬ä¸ä¼šè¿‡å¤šæ¥è‡ªå®šä¹‰ <code>WebSecurity</code> , ä½¿ç”¨è¾ƒå¤šçš„ä½¿å…¶ <code>ignoring()</code> æ–¹æ³•ç”¨æ¥å¿½ç•¥ Spring Security å¯¹é™æ€èµ„æºçš„æ§åˆ¶ã€‚</li>
<li><code>void configure(HttpSecurity http)</code> è¿™ä¸ªæ˜¯æˆ‘ä»¬ä½¿ç”¨æœ€å¤šçš„ï¼Œç”¨æ¥é…ç½® <code>HttpSecurity</code> ã€‚ <code>HttpSecurity</code>ç”¨äºæ„å»ºä¸€ä¸ªå®‰å…¨è¿‡æ»¤å™¨é“¾ <code>SecurityFilterChain</code>ã€‚ <code>SecurityFilterChain</code> æœ€ç»ˆè¢«æ³¨å…¥æ ¸å¿ƒè¿‡æ»¤å™¨ ã€‚<code>HttpSecurity</code>æœ‰è®¸å¤šæˆ‘ä»¬éœ€è¦çš„é…ç½®ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒæ¥è¿›è¡Œè‡ªå®šä¹‰å®‰å…¨è®¿é—®ç­–ç•¥ã€‚</li>
</ul>
<h4 id="123-è®¤è¯è¿‡ç¨‹">1.2.3 è®¤è¯è¿‡ç¨‹<a hidden class="anchor" aria-hidden="true" href="#123-è®¤è¯è¿‡ç¨‹">#</a></h4>
<p>è¯¦è§ [1.1 Spring SecurityåŸç†åˆæ¢](# 1.1 Spring SecurityåŸç†åˆæ¢)</p>
<h4 id="124-è¿‡æ»¤å™¨å’Œè¿‡æ»¤é“¾">1.2.4 è¿‡æ»¤å™¨å’Œè¿‡æ»¤é“¾<a hidden class="anchor" aria-hidden="true" href="#124-è¿‡æ»¤å™¨å’Œè¿‡æ»¤é“¾">#</a></h4>
<p>SpringSecurityçš„åŸç†å…¶å®å°±æ˜¯ä¸€ä¸ªè¿‡æ»¤å™¨é“¾ï¼Œå†…éƒ¨åŒ…å«äº†æä¾›å„ç§åŠŸèƒ½çš„è¿‡æ»¤å™¨ã€‚</p>
<p>Spring Security ä»¥ä¸€ä¸ªå• <code>Filter(FilterChainProxy)</code>å­˜åœ¨äºæ•´ä¸ªè¿‡æ»¤å™¨é“¾ä¸­ï¼Œè€Œ è¿™ä¸ª <code>FilterChainProxy</code> å®é™…å†…éƒ¨ä»£ç†ç€ä¼—å¤šçš„ Spring Security Filter ã€‚</p>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202307182337694.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"  />
</p>
<p>å›¾ä¸­åªå±•ç¤ºäº†æ ¸å¿ƒè¿‡æ»¤å™¨ï¼Œå…¶å®ƒçš„éæ ¸å¿ƒè¿‡æ»¤å™¨å¹¶æ²¡æœ‰åœ¨å›¾ä¸­å±•ç¤ºã€‚</p>
<p><code>UsernamePasswordAuthenticationFilter</code>:è´Ÿè´£å¤„ç†æˆ‘ä»¬åœ¨ç™»é™†é¡µé¢å¡«å†™äº†ç”¨æˆ·åå¯†ç åçš„ç™»é™†è¯·æ±‚ã€‚å…¥é—¨æ¡ˆä¾‹çš„è®¤è¯å·¥ä½œä¸»è¦æœ‰å®ƒè´Ÿè´£ã€‚</p>
<p><code>ExceptionTranslationFilter</code>ï¼š å¤„ç†è¿‡æ»¤å™¨é“¾ä¸­æŠ›å‡ºçš„ä»»ä½•AccessDeniedExceptionå’ŒAuthenticationException ã€‚</p>
<p><code>FilterSecurityInterceptor</code>ï¼š è´Ÿè´£æƒé™æ ¡éªŒçš„è¿‡æ»¤å™¨ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡DebugæŸ¥çœ‹å½“å‰ç³»ç»Ÿä¸­SpringSecurityè¿‡æ»¤å™¨é“¾ä¸­æœ‰å“ªäº›è¿‡æ»¤å™¨åŠå®ƒä»¬çš„é¡ºåºã€‚</p>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202307182337700.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"  />
</p>
<p><strong>å‘é¡¹ç›®ä¸­æ·»åŠ è¿‡æ»¤å™¨ï¼š</strong></p>
<p>åœ¨é…ç½®æ–‡ä»¶çš„<code>configure(HttpSecurity httpSecurity)</code>æ–¹æ³•ä¸­ï¼š</p>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202307182337698.png" alt="img"  />
</p>
<blockquote>
<p>4ä¸ªæ–¹æ³•åˆ†åˆ«æ˜¯ï¼šaddFilterâ€“æ·»åŠ è¿‡æ»¤å™¨ï¼›addFilterAfterâ€“æŠŠè¿‡æ»¤å™¨æ·»åŠ åˆ°æŸè¿‡æ»¤å™¨ä¹‹åï¼›addFilterAtâ€“æ›¿ä»£æŸè¿‡æ»¤å™¨ï¼›addFilterBeforeâ€“æŠŠè¿‡æ»¤å™¨æ·»åŠ åˆ°æŸè¿‡æ»¤å™¨ä¹‹å‰</p>
</blockquote>
<h4 id="125-æƒé™ç›¸å…³">1.2.5 æƒé™ç›¸å…³<a hidden class="anchor" aria-hidden="true" href="#125-æƒé™ç›¸å…³">#</a></h4>
<p><strong>ä¸€ã€åŸºäºé…ç½®è¡¨è¾¾å¼æ§åˆ¶ URL è·¯å¾„</strong></p>
<p>åœ¨ç»§æ‰¿<code>WebSecurityConfigurerAdapter</code>çš„é…ç½®ç±»ä¸­çš„<code>configure(HttpSecurity http)</code>ä¸­è¿›è¡Œé…ç½®ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">&#34;/admin/**&#34;</span><span class="o">).</span><span class="na">hasRole</span><span class="o">(</span><span class="s">&#34;admin&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">&#34;/user/**&#34;</span><span class="o">).</span><span class="na">hasAnyRole</span><span class="o">(</span><span class="s">&#34;admin&#34;</span><span class="o">,</span> <span class="s">&#34;user&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">and</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">            <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>äºŒã€åŸºäºæ³¨è§£çš„æ¥å£æƒé™æ§åˆ¶</strong></p>
<p>æˆ‘ä»¬å¯ä»¥åœ¨ä»»ä½• <code>@Configuration</code>å®ä¾‹ä¸Šä½¿ç”¨ <code>@EnableGlobalMethodSecurity</code>æ³¨è§£æ¥å¯ç”¨å…¨å±€æ–¹ æ³•å®‰å…¨æ³¨è§£åŠŸèƒ½</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableGlobalMethodSecurity</span><span class="o">(</span><span class="n">prePostEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span><span class="n">securedEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span><span class="n">jsr250Enabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>è®¾ç½® <code>prePostEnabled</code>ä¸º true ï¼Œåˆ™å¼€å¯äº†åŸºäºè¡¨è¾¾å¼ çš„æ–¹æ³•å®‰å…¨æ§åˆ¶ã€‚</li>
</ul>
<h2 id="2-è®¤è¯">2 è®¤è¯<a hidden class="anchor" aria-hidden="true" href="#2-è®¤è¯">#</a></h2>
<h3 id="21-ç™»å½•æ ¡éªŒæµç¨‹">2.1 ç™»å½•æ ¡éªŒæµç¨‹<a hidden class="anchor" aria-hidden="true" href="#21-ç™»å½•æ ¡éªŒæµç¨‹">#</a></h3>
<p><img loading="lazy" src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202307182337706.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"  />
</p>
<h3 id="22-ç™»å½•åŠŸèƒ½æ ¸å¿ƒä»£ç ">2.2 ç™»å½•åŠŸèƒ½æ ¸å¿ƒä»£ç <a hidden class="anchor" aria-hidden="true" href="#22-ç™»å½•åŠŸèƒ½æ ¸å¿ƒä»£ç ">#</a></h3>
<p><strong>åœ¨SpringBooté¡¹ç›®ä¸­ä½¿ç”¨SpringSecurityæˆ‘ä»¬åªéœ€è¦å¼•å…¥ä¾èµ–å³å¯ã€‚</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!-- spring security å®‰å…¨è®¤è¯ --&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-security<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>1.æ ¹æ®<code>username, password</code>å°è£…ä¸€ä¸ª<code>Authentication</code>å¯¹è±¡<code>authenticationToken</code>ï¼Œè°ƒç”¨<code>AuthenticationManager</code>æ¥å£çš„<code>authenticate(authenticationToken)</code>æ–¹æ³•è¿›è¡Œè®¤è¯</strong></p>
<blockquote>
<p><code>Authentication</code>ç±»ä¸­ï¼š<code>principal</code>å±æ€§å¯¹åº”ç”¨æˆ·åï¼›<code>credentials</code>å±æ€§å¯¹åº”å¯†ç </p>
<p>è‹¥æ˜¯éœ€è¦æ ¹<strong>æ®é‚®ç®±ç™»å½•</strong>çš„è¯æŠŠ<code>email</code>æ”¾åˆ°<code>principal</code>ï¼Œ</p>
<p><code>loadUserByUsername</code>æ–¹æ³•çš„å‚æ•°å°±æ˜¯è¿™ä¸ª<code>email</code></p>
</blockquote>
<p>åœ¨æ¥å£ä¸­æˆ‘ä»¬é€šè¿‡<code>AuthenticationManager</code>çš„<code>authenticate</code>æ–¹æ³•æ¥è¿›è¡Œç”¨æˆ·è®¤è¯ï¼Œæ‰€ä»¥éœ€è¦åœ¨<code>SecurityConfig</code>ä¸­é…ç½®æŠŠ<code>AuthenticationManager</code>æ³¨å…¥å®¹å™¨ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">String</span> <span class="nf">login</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">password</span><span class="o">,</span> <span class="n">String</span> <span class="n">code</span><span class="o">,</span> <span class="n">String</span> <span class="n">uuid</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ç”¨æˆ·éªŒè¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">UsernamePasswordAuthenticationToken</span> <span class="n">authenticationToken</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UsernamePasswordAuthenticationToken</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">AuthenticationContextHolder</span><span class="o">.</span><span class="na">setContext</span><span class="o">(</span><span class="n">authenticationToken</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è¯¥æ–¹æ³•ä¼šå»è°ƒç”¨UserDetailsServiceImpl.loadUserByUsername
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Authentication</span> <span class="n">authentication</span> <span class="o">=</span> <span class="n">authenticationManager</span><span class="o">.</span><span class="na">authenticate</span><span class="o">(</span><span class="n">authenticationToken</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// ç”Ÿæˆtoken
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">tokenService</span><span class="o">.</span><span class="na">createToken</span><span class="o">(</span><span class="n">loginUser</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>å¯†ç åŠ å¯†å­˜å‚¨</strong></p>
<p>å®é™…é¡¹ç›®ä¸­æˆ‘ä»¬ä¸ä¼šæŠŠå¯†ç æ˜æ–‡å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ã€‚</p>
<p>ä¸€èˆ¬ä½¿ç”¨SpringSecurityä¸ºæˆ‘ä»¬æä¾›çš„BCryptPasswordEncoderã€‚</p>
<p>æˆ‘ä»¬åªéœ€è¦ä½¿ç”¨æŠŠBCryptPasswordEncoderå¯¹è±¡æ³¨å…¥Springå®¹å™¨ä¸­ï¼ŒSpringSecurityå°±ä¼šä½¿ç”¨è¯¥PasswordEncoderæ¥è¿›è¡Œå¯†ç æ ¡éªŒ</p>
<p><strong>éƒ¨åˆ†SecurityConfigé…ç½®ï¼ˆ[å®Œæ•´é…ç½®](# 2.4 é…ç½®SecurityConfig)ï¼‰</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">http</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//å…³é—­csrf
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">csrf</span><span class="o">().</span><span class="na">disable</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//ä¸é€šè¿‡Sessionè·å–SecurityContext
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">sessionManagement</span><span class="o">().</span><span class="na">sessionCreationPolicy</span><span class="o">(</span><span class="n">SessionCreationPolicy</span><span class="o">.</span><span class="na">STATELESS</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">and</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// å¯¹äºç™»å½•æ¥å£ å…è®¸åŒ¿åè®¿é—®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">&#34;/user/login&#34;</span><span class="o">).</span><span class="na">anonymous</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// é™¤ä¸Šé¢å¤–çš„æ‰€æœ‰è¯·æ±‚å…¨éƒ¨éœ€è¦é‰´æƒè®¤è¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AuthenticationManager</span> <span class="nf">authenticationManagerBean</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">authenticationManagerBean</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * å¼ºæ•£åˆ—å“ˆå¸ŒåŠ å¯†å®ç°
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">BCryptPasswordEncoder</span> <span class="nf">bCryptPasswordEncoder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">BCryptPasswordEncoder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * èº«ä»½è®¤è¯æ¥å£
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">AuthenticationManagerBuilder</span> <span class="n">auth</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ•°æ®åº“éªŒè¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Spring Security æä¾›äº†BCryptPasswordEncoderç±»,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å®ç°Springçš„PasswordEncoderæ¥å£ä½¿ç”¨BCryptå¼ºå“ˆå¸Œæ–¹æ³•æ¥åŠ å¯†å¯†ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">auth</span><span class="o">.</span><span class="na">userDetailsService</span><span class="o">(</span><span class="n">userDetailsService</span><span class="o">).</span><span class="na">passwordEncoder</span><span class="o">(</span><span class="n">bCryptPasswordEncoder</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>2.åˆ›å»ºä¸€ä¸ªserviceï¼Œå®ç°<code>UserDetailsService</code>æ¥å£ï¼Œå¹¶é‡å†™<code>loadUserByUsername</code>æ–¹æ³•</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Service</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserDetailsServiceImpl</span> <span class="kd">implements</span> <span class="n">UserDetailsService</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">UsernameNotFoundException</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SysUser</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">selectUserByUserName</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">        <span class="n">validate</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">createLoginUser</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">UserDetails</span> <span class="nf">createLoginUser</span><span class="o">(</span><span class="n">SysUser</span> <span class="n">user</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">LoginUser</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(),</span> <span class="n">user</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>3.å®ç°å¯†ç éªŒè¯é€»è¾‘</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">validate</span><span class="o">(</span><span class="n">SysUser</span> <span class="n">user</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">Authentication</span> <span class="n">usernamePasswordAuthenticationToken</span> <span class="o">=</span> <span class="n">AuthenticationContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">usernamePasswordAuthenticationToken</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">password</span> <span class="o">=</span> <span class="n">usernamePasswordAuthenticationToken</span><span class="o">.</span><span class="na">getCredentials</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(!</span><span class="n">matches</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">password</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">ServiceException</span><span class="o">(</span><span class="s">&#34;å¯†ç é”™è¯¯&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">matches</span><span class="o">(</span><span class="n">SysUser</span> <span class="n">user</span><span class="o">,</span> <span class="n">String</span> <span class="n">rawPassword</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">matchesPassword</span><span class="o">(</span><span class="n">rawPassword</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getPassword</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * åˆ¤æ–­å¯†ç æ˜¯å¦ç›¸åŒ
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param rawPassword çœŸå®å¯†ç 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param encodedPassword åŠ å¯†åå­—ç¬¦
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return ç»“æœ
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">matchesPassword</span><span class="o">(</span><span class="n">String</span> <span class="n">rawPassword</span><span class="o">,</span> <span class="n">String</span> <span class="n">encodedPassword</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">BCryptPasswordEncoder</span> <span class="n">passwordEncoder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BCryptPasswordEncoder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">passwordEncoder</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="n">rawPassword</span><span class="o">,</span> <span class="n">encodedPassword</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>4.éªŒè¯æˆåŠŸåï¼Œåˆ›å»ºä»¤ç‰Œï¼Œå­˜å…¥redisä¸­ï¼Œå¹¶å°†tokenè¿”å›ç»™å‰ç«¯ï¼ˆå®ç°æ­¥éª¤1ä¸­çš„<code>createToken</code>æ–¹æ³•ï¼‰</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * åˆ›å»ºä»¤ç‰Œ
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param loginUser ç”¨æˆ·ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return ä»¤ç‰Œ
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">String</span> <span class="nf">createToken</span><span class="o">(</span><span class="n">LoginUser</span> <span class="n">loginUser</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">UUID</span><span class="o">.</span><span class="na">fastUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">loginUser</span><span class="o">.</span><span class="na">setToken</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">refreshToken</span><span class="o">(</span><span class="n">loginUser</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">claims</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="n">claims</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">LOGIN_USER_KEY</span><span class="o">,</span> <span class="n">token</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">createToken</span><span class="o">(</span><span class="n">claims</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * åˆ·æ–°ä»¤ç‰Œæœ‰æ•ˆæœŸ
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param loginUser ç™»å½•ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">refreshToken</span><span class="o">(</span><span class="n">LoginUser</span> <span class="n">loginUser</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">loginUser</span><span class="o">.</span><span class="na">setLoginTime</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">loginUser</span><span class="o">.</span><span class="na">setExpireTime</span><span class="o">(</span><span class="n">loginUser</span><span class="o">.</span><span class="na">getLoginTime</span><span class="o">()</span> <span class="o">+</span> <span class="n">expireTime</span> <span class="o">*</span> <span class="n">MILLIS_MINUTE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ ¹æ®uuidå°†loginUserç¼“å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">String</span> <span class="n">userKey</span> <span class="o">=</span> <span class="n">getTokenKey</span><span class="o">(</span><span class="n">loginUser</span><span class="o">.</span><span class="na">getToken</span><span class="o">());</span> <span class="c1">// &#34;login_tokens:&#34; + uuid;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">redisCache</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">userKey</span><span class="o">,</span> <span class="n">loginUser</span><span class="o">,</span> <span class="n">expireTime</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ä»æ•°æ®å£°æ˜ç”Ÿæˆä»¤ç‰Œ
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param claims æ•°æ®å£°æ˜
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return ä»¤ç‰Œ
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">String</span> <span class="nf">createToken</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">claims</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">Jwts</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">setClaims</span><span class="o">(</span><span class="n">claims</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">signWith</span><span class="o">(</span><span class="n">SignatureAlgorithm</span><span class="o">.</span><span class="na">HS512</span><span class="o">,</span> <span class="n">secret</span><span class="o">).</span><span class="na">compact</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">token</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="23-æ ¡éªŒåŠŸèƒ½æ ¸å¿ƒä»£ç ">2.3 æ ¡éªŒåŠŸèƒ½æ ¸å¿ƒä»£ç <a hidden class="anchor" aria-hidden="true" href="#23-æ ¡éªŒåŠŸèƒ½æ ¸å¿ƒä»£ç ">#</a></h3>
<p>è®¿é—®ç³»ç»Ÿèµ„æºæ—¶ï¼Œå¦‚æœæ¯æ¬¡éƒ½éœ€è¦å»æ•°æ®åº“éªŒè¯å¯†ç æ˜¯ååˆ†æ¶ˆè€—èµ„æºçš„ï¼Œ[2.2](# 2.2 ç™»å½•åŠŸèƒ½æ ¸å¿ƒä»£ç )ä¸­ï¼Œæœ€åè¿”å›äº†ä¸€ä¸ªtokenï¼Œå¯åŸºäºè¯¥tokenå®ç°<strong>ä¿å­˜ç™»å½•çŠ¶æ€</strong>çš„åŠŸèƒ½</p>
<p><strong>1.å‰ç«¯å°†åç«¯è¿”å›çš„tokenå­˜å…¥Cookieä¸­</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">login</span><span class="p">(</span><span class="nx">userInfo</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">username</span> <span class="o">=</span> <span class="nx">userInfo</span><span class="p">.</span><span class="nx">username</span><span class="p">.</span><span class="nx">trim</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">userInfo</span><span class="p">.</span><span class="nx">password</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">login</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="o">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">setToken</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">token</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">token</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">token</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">resolve</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">})</span>
</span></span><span class="line"><span class="cl">      <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">error</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">Cookies</span> <span class="nx">from</span> <span class="s2">&#34;js-cookie&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">TokenKey</span> <span class="o">=</span> <span class="s2">&#34;Admin-Token&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">setToken</span><span class="p">(</span><span class="nx">token</span><span class="o">:</span> <span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">Cookies</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">TokenKey</span><span class="p">,</span> <span class="nx">token</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>2.è¯·æ±‚æ¥å£æ—¶éƒ½é™„ä¸Štokenï¼ŒéªŒè¯ç”¨æˆ·æ˜¯å¦ç™»å½•</strong></p>
<p><code>request.ts</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// requestæ‹¦æˆªå™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">service</span><span class="p">.</span><span class="nx">interceptors</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nx">config</span><span class="o">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ˜¯å¦éœ€è¦è®¾ç½® token
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">const</span> <span class="nx">isToken</span> <span class="o">=</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">headers</span> <span class="o">||</span> <span class="p">{}).</span><span class="nx">isToken</span> <span class="o">===</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">getToken</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isToken</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// è®©æ¯ä¸ªè¯·æ±‚æºå¸¦è‡ªå®šä¹‰token è¯·æ ¹æ®å®é™…æƒ…å†µè‡ªè¡Œä¿®æ”¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">config</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s2">&#34;Authorization&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;Bearer &#34;</span> <span class="o">+</span> <span class="nx">getToken</span><span class="p">();</span> 
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>3.å®šä¹‰Jwtè®¤è¯è¿‡æ»¤å™¨ <code>JwtAuthenticationTokenFilter</code>ï¼ŒéªŒè¯tokenæœ‰æ•ˆæ€§</strong></p>
<p>å› ä¸ºredisè®¾ç½®äº†ç™»é™†ä»¤ç‰Œçš„è¿‡æœŸæ—¶é—´ï¼Œæ‰€ä»¥å¦‚æœä»¤ç‰Œè¿‡æœŸäº†ï¼Œredisä¸­å°±ä¸å­˜åœ¨tokenè§£æåçš„redisKeyï¼Œä¼šç›´æ¥è¿”å›nullï¼Œè¿™ç§å…¶æ¦‚å†µå°±è¦é‡æ–°ç™»å½•äº†ã€‚</p>
<p><strong>æ·»åŠ ä¾èµ–</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!-- Tokenç”Ÿæˆä¸è§£æ--&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>io.jsonwebtoken<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>jjwt<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>${jwt.version}<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>JwtAuthenticationTokenFilter</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * tokenè¿‡æ»¤å™¨ éªŒè¯tokenæœ‰æ•ˆæ€§
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @author 7bin
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Component</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JwtAuthenticationTokenFilter</span> <span class="kd">extends</span> <span class="n">OncePerRequestFilter</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">TokenService</span> <span class="n">tokenService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doFilterInternal</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">FilterChain</span> <span class="n">chain</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LoginUser</span> <span class="n">loginUser</span> <span class="o">=</span> <span class="n">tokenService</span><span class="o">.</span><span class="na">getLoginUser</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isNotNull</span><span class="o">(</span><span class="n">loginUser</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">StringUtils</span><span class="o">.</span><span class="na">isNull</span><span class="o">(</span><span class="n">SecurityUtils</span><span class="o">.</span><span class="na">getAuthentication</span><span class="o">()))</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// éªŒè¯ä»¤ç‰Œæœ‰æ•ˆæœŸï¼Œç›¸å·®ä¸è¶³20åˆ†é’Ÿï¼Œè‡ªåŠ¨åˆ·æ–°ç¼“å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">tokenService</span><span class="o">.</span><span class="na">verifyToken</span><span class="o">(</span><span class="n">loginUser</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// è·å–æƒé™ä¿¡æ¯å°è£…åˆ°Authenticationä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">UsernamePasswordAuthenticationToken</span> <span class="n">authenticationToken</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UsernamePasswordAuthenticationToken</span><span class="o">(</span><span class="n">loginUser</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">loginUser</span><span class="o">.</span><span class="na">getAuthorities</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">authenticationToken</span><span class="o">.</span><span class="na">setDetails</span><span class="o">(</span><span class="k">new</span> <span class="n">WebAuthenticationDetailsSource</span><span class="o">().</span><span class="na">buildDetails</span><span class="o">(</span><span class="n">request</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// é€šè¿‡éªŒè¯ï¼Œåœ¨Spring Securityä¸Šä¸‹æ–‡ä¸­å†™å…¥ç”¨æˆ·ç™»å½•ç›¸å…³æ‰€æœ‰ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">setAuthentication</span><span class="o">(</span><span class="n">authenticationToken</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">chain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>å¦‚ä½•æ ¹æ®tokenè·å–ç™»å½•ç”¨æˆ·ä¿¡æ¯</strong></p>
<p>æ ¸å¿ƒï¼šä»requestè§£ætokenè·å–å…¶ä¸­çš„userIdï¼Œåˆ°redisä¸­æ ¹æ®userIdè·å–ç”¨æˆ·ä¿¡æ¯</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * è·å–ç”¨æˆ·èº«ä»½ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return ç”¨æˆ·ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">LoginUser</span> <span class="nf">getLoginUser</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è·å–è¯·æ±‚æºå¸¦çš„ä»¤ç‰Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">getToken</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isNotEmpty</span><span class="o">(</span><span class="n">token</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Claims</span> <span class="n">claims</span> <span class="o">=</span> <span class="n">parseToken</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// è§£æå¯¹åº”çš„æƒé™ä»¥åŠç”¨æˆ·ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">String</span> <span class="n">uuid</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">claims</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">LOGIN_USER_KEY</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">userKey</span> <span class="o">=</span> <span class="n">getTokenKey</span><span class="o">(</span><span class="n">uuid</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">LoginUser</span> <span class="n">user</span> <span class="o">=</span> <span class="n">redisCache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">userKey</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ä»¤ç‰Œå‰ç¼€
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TOKEN_PREFIX</span> <span class="o">=</span> <span class="s">&#34;Bearer &#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * è·å–è¯·æ±‚token
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param request
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return token
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">String</span> <span class="nf">getToken</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="n">header</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isNotEmpty</span><span class="o">(</span><span class="n">token</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">token</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">TOKEN_PREFIX</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">token</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">TOKEN_PREFIX</span><span class="o">,</span> <span class="s">&#34;&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">token</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ä»ä»¤ç‰Œä¸­è·å–æ•°æ®å£°æ˜
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param token ä»¤ç‰Œ
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return æ•°æ®å£°æ˜
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">Claims</span> <span class="nf">parseToken</span><span class="o">(</span><span class="n">String</span> <span class="n">token</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Jwts</span><span class="o">.</span><span class="na">parser</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">setSigningKey</span><span class="o">(</span><span class="n">secret</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">parseClaimsJws</span><span class="o">(</span><span class="n">token</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">getBody</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="24-é…ç½®securityconfig">2.4 é…ç½®SecurityConfig<a hidden class="anchor" aria-hidden="true" href="#24-é…ç½®securityconfig">#</a></h3>
<p>åœ¨<code>SecurityConfig</code>ä¸­æ³¨å…¥ï¼š</p>
<ul>
<li>LogoutSuccessHandlerImpl</li>
<li>è‡ªå®šä¹‰å®ç°çš„UserDetailsService</li>
<li>JwtAuthenticationTokenFilter</li>
<li>AuthenticationEntryPoint</li>
<li>CorsFilter</li>
<li>&hellip;</li>
</ul>
<p>ä»¥åŠç›¸å…³æƒé™æ§åˆ¶<code>configure</code></p>
<p><strong>å®Œæ•´spring securityé…ç½®å¦‚ä¸‹</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * spring securityé…ç½®
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @author 7bin
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableGlobalMethodSecurity</span><span class="o">(</span><span class="n">prePostEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">securedEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * è‡ªå®šä¹‰ç”¨æˆ·è®¤è¯é€»è¾‘
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">UserDetailsService</span> <span class="n">userDetailsService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * è®¤è¯å¤±è´¥å¤„ç†ç±»ï¼ˆæŠ›å‡ºAuthenticationExceptionå¼‚å¸¸èµ°è¿™é‡Œï¼‰
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">AuthenticationEntryPointImpl</span> <span class="n">unauthorizedHandler</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * é€€å‡ºå¤„ç†ç±»
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">LogoutSuccessHandlerImpl</span> <span class="n">logoutSuccessHandler</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * tokenè®¤è¯è¿‡æ»¤å™¨
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">JwtAuthenticationTokenFilter</span> <span class="n">authenticationTokenFilter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * è·¨åŸŸè¿‡æ»¤å™¨
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">CorsFilter</span> <span class="n">corsFilter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * å…è®¸åŒ¿åè®¿é—®çš„åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">PermitAllUrlProperties</span> <span class="n">permitAllUrl</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * è§£å†³ æ— æ³•ç›´æ¥æ³¨å…¥ AuthenticationManager
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws Exception
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AuthenticationManager</span> <span class="nf">authenticationManagerBean</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">authenticationManagerBean</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * anyRequest          |   åŒ¹é…æ‰€æœ‰è¯·æ±‚è·¯å¾„
</span></span></span><span class="line"><span class="cl"><span class="cm">     * access              |   SpringElè¡¨è¾¾å¼ç»“æœä¸ºtrueæ—¶å¯ä»¥è®¿é—®
</span></span></span><span class="line"><span class="cl"><span class="cm">     * anonymous           |   åŒ¿åå¯ä»¥è®¿é—®
</span></span></span><span class="line"><span class="cl"><span class="cm">     * denyAll             |   ç”¨æˆ·ä¸èƒ½è®¿é—®
</span></span></span><span class="line"><span class="cl"><span class="cm">     * fullyAuthenticated  |   ç”¨æˆ·å®Œå…¨è®¤è¯å¯ä»¥è®¿é—®ï¼ˆéremember-meä¸‹è‡ªåŠ¨ç™»å½•ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="cm">     * hasAnyAuthority     |   å¦‚æœæœ‰å‚æ•°ï¼Œå‚æ•°è¡¨ç¤ºæƒé™ï¼Œåˆ™å…¶ä¸­ä»»ä½•ä¸€ä¸ªæƒé™å¯ä»¥è®¿é—®
</span></span></span><span class="line"><span class="cl"><span class="cm">     * hasAnyRole          |   å¦‚æœæœ‰å‚æ•°ï¼Œå‚æ•°è¡¨ç¤ºè§’è‰²ï¼Œåˆ™å…¶ä¸­ä»»ä½•ä¸€ä¸ªè§’è‰²å¯ä»¥è®¿é—®
</span></span></span><span class="line"><span class="cl"><span class="cm">     * hasAuthority        |   å¦‚æœæœ‰å‚æ•°ï¼Œå‚æ•°è¡¨ç¤ºæƒé™ï¼Œåˆ™å…¶æƒé™å¯ä»¥è®¿é—®
</span></span></span><span class="line"><span class="cl"><span class="cm">     * hasIpAddress        |   å¦‚æœæœ‰å‚æ•°ï¼Œå‚æ•°è¡¨ç¤ºIPåœ°å€ï¼Œå¦‚æœç”¨æˆ·IPå’Œå‚æ•°åŒ¹é…ï¼Œåˆ™å¯ä»¥è®¿é—®
</span></span></span><span class="line"><span class="cl"><span class="cm">     * hasRole             |   å¦‚æœæœ‰å‚æ•°ï¼Œå‚æ•°è¡¨ç¤ºè§’è‰²ï¼Œåˆ™å…¶è§’è‰²å¯ä»¥è®¿é—®
</span></span></span><span class="line"><span class="cl"><span class="cm">     * permitAll           |   ç”¨æˆ·å¯ä»¥ä»»æ„è®¿é—®
</span></span></span><span class="line"><span class="cl"><span class="cm">     * rememberMe          |   å…è®¸é€šè¿‡remember-meç™»å½•çš„ç”¨æˆ·è®¿é—®
</span></span></span><span class="line"><span class="cl"><span class="cm">     * authenticated       |   ç”¨æˆ·ç™»å½•åå¯è®¿é—®
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">httpSecurity</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ³¨è§£æ ‡è®°å…è®¸åŒ¿åè®¿é—®çš„url
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ExpressionUrlAuthorizationConfigurer</span><span class="o">&lt;</span><span class="n">HttpSecurity</span><span class="o">&gt;.</span><span class="na">ExpressionInterceptUrlRegistry</span> <span class="n">registry</span> <span class="o">=</span> <span class="n">httpSecurity</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">permitAllUrl</span><span class="o">.</span><span class="na">getUrls</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">url</span> <span class="o">-&gt;</span> <span class="n">registry</span><span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="n">url</span><span class="o">).</span><span class="na">permitAll</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">httpSecurity</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// CSRFç¦ç”¨ï¼Œå› ä¸ºä¸ä½¿ç”¨session
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// å…³é—­csrfåŠŸèƒ½:è·¨ç«™è¯·æ±‚ä¼ªé€ ,é»˜è®¤åªèƒ½é€šè¿‡postæ–¹å¼æäº¤logoutè¯·æ±‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">csrf</span><span class="o">().</span><span class="na">disable</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// è®¤è¯å¤±è´¥å¤„ç†ç±»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">exceptionHandling</span><span class="o">().</span><span class="na">authenticationEntryPoint</span><span class="o">(</span><span class="n">unauthorizedHandler</span><span class="o">).</span><span class="na">and</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// åŸºäºtokenï¼Œæ‰€ä»¥ä¸éœ€è¦session
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">sessionManagement</span><span class="o">().</span><span class="na">sessionCreationPolicy</span><span class="o">(</span><span class="n">SessionCreationPolicy</span><span class="o">.</span><span class="na">STATELESS</span><span class="o">).</span><span class="na">and</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// è¿‡æ»¤è¯·æ±‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// anonymous() :åŒ¿åè®¿é—®, ä»…å…è®¸åŒ¿åç”¨æˆ·è®¿é—®, å¦‚æœç™»å½•è®¤è¯å, å¸¦æœ‰tokenä¿¡æ¯å†å»è¯·æ±‚, è¿™ä¸ªanonymous()å…³è”çš„èµ„æºå°±ä¸èƒ½è¢«è®¿é—®ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// permitAll() :ç™»å½•èƒ½è®¿é—®,ä¸ç™»å½•ä¹Ÿèƒ½è®¿é—®, ä¸€èˆ¬ç”¨äºé™æ€èµ„æºjsç­‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// å¯¹äºç™»å½•login æ³¨å†Œregister éªŒè¯ç captchaImage å…è®¸åŒ¿åè®¿é—®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">&#34;/login&#34;</span><span class="o">,</span> <span class="s">&#34;/register&#34;</span><span class="o">,</span> <span class="s">&#34;/captchaImage&#34;</span><span class="o">,</span><span class="s">&#34;/docker/**&#34;</span><span class="o">).</span><span class="na">anonymous</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// é™æ€èµ„æºï¼Œå¯åŒ¿åè®¿é—®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="n">HttpMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="s">&#34;/&#34;</span><span class="o">,</span> <span class="s">&#34;/*.html&#34;</span><span class="o">,</span> <span class="s">&#34;/**/*.html&#34;</span><span class="o">,</span> <span class="s">&#34;/**/*.css&#34;</span><span class="o">,</span> <span class="s">&#34;/**/*.js&#34;</span><span class="o">,</span> <span class="s">&#34;/profile/**&#34;</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">&#34;/swagger-ui.html&#34;</span><span class="o">,</span> <span class="s">&#34;/swagger-resources/**&#34;</span><span class="o">,</span> <span class="s">&#34;/webjars/**&#34;</span><span class="o">,</span> <span class="s">&#34;/*/api-docs&#34;</span><span class="o">,</span> <span class="s">&#34;/druid/**&#34;</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// é™¤ä¸Šé¢å¤–çš„æ‰€æœ‰è¯·æ±‚å…¨éƒ¨éœ€è¦é‰´æƒè®¤è¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">and</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">headers</span><span class="o">().</span><span class="na">frameOptions</span><span class="o">().</span><span class="na">disable</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ·»åŠ Logout filter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">httpSecurity</span><span class="o">.</span><span class="na">logout</span><span class="o">().</span><span class="na">logoutUrl</span><span class="o">(</span><span class="s">&#34;/logout&#34;</span><span class="o">).</span><span class="na">logoutSuccessHandler</span><span class="o">(</span><span class="n">logoutSuccessHandler</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ·»åŠ JWT filter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">httpSecurity</span><span class="o">.</span><span class="na">addFilterBefore</span><span class="o">(</span><span class="n">authenticationTokenFilter</span><span class="o">,</span> <span class="n">UsernamePasswordAuthenticationFilter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ·»åŠ CORS filter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">httpSecurity</span><span class="o">.</span><span class="na">addFilterBefore</span><span class="o">(</span><span class="n">corsFilter</span><span class="o">,</span> <span class="n">JwtAuthenticationTokenFilter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">httpSecurity</span><span class="o">.</span><span class="na">addFilterBefore</span><span class="o">(</span><span class="n">corsFilter</span><span class="o">,</span> <span class="n">LogoutFilter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * å¼ºæ•£åˆ—å“ˆå¸ŒåŠ å¯†å®ç°
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">BCryptPasswordEncoder</span> <span class="nf">bCryptPasswordEncoder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">BCryptPasswordEncoder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * èº«ä»½è®¤è¯æ¥å£
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">AuthenticationManagerBuilder</span> <span class="n">auth</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ•°æ®åº“éªŒè¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Spring Security æä¾›äº†BCryptPasswordEncoderç±»,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å®ç°Springçš„PasswordEncoderæ¥å£ä½¿ç”¨BCryptå¼ºå“ˆå¸Œæ–¹æ³•æ¥åŠ å¯†å¯†ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">auth</span><span class="o">.</span><span class="na">userDetailsService</span><span class="o">(</span><span class="n">userDetailsService</span><span class="o">).</span><span class="na">passwordEncoder</span><span class="o">(</span><span class="n">bCryptPasswordEncoder</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="25-æ€è€ƒ">2.5 æ€è€ƒ<a hidden class="anchor" aria-hidden="true" href="#25-æ€è€ƒ">#</a></h3>
<p><strong>ä»€ä¹ˆæ—¶å€™ä¼šèµ°åˆ°è®¤è¯å¤±è´¥çš„å¤„ç†ç±»å‘¢ï¼ˆè¿˜ä¸çŸ¥é“ï¼‰</strong></p>
<p><code>httpSecurity.exceptionHandling().authenticationEntryPoint(unauthorizedHandler)</code></p>
<blockquote>
<p><a href="https://blog.csdn.net/swebin/article/details/78213506">AuthenticationExceptionå¼‚å¸¸è¯¦è§£</a></p>
</blockquote>
<h2 id="3-æˆæƒ">3 æˆæƒ<a hidden class="anchor" aria-hidden="true" href="#3-æˆæƒ">#</a></h2>
<h3 id="31-rbacæƒé™æ¨¡å‹">3.1 RBACæƒé™æ¨¡å‹<a hidden class="anchor" aria-hidden="true" href="#31-rbacæƒé™æ¨¡å‹">#</a></h3>
<p>RBACæƒé™æ¨¡å‹ï¼ˆRole-Based Access Controlï¼‰å³ï¼šåŸºäºè§’è‰²çš„æƒé™æ§åˆ¶ã€‚è¿™æ˜¯ç›®å‰æœ€å¸¸è¢«å¼€å‘è€…ä½¿ç”¨ä¹Ÿæ˜¯ç›¸å¯¹æ˜“ç”¨ã€é€šç”¨æƒé™æ¨¡å‹ã€‚</p>
<h4 id="311-æ•°æ®åº“è¡¨ç»“æ„">3.1.1 æ•°æ®åº“è¡¨ç»“æ„<a hidden class="anchor" aria-hidden="true" href="#311-æ•°æ®åº“è¡¨ç»“æ„">#</a></h4>
<p>å¦‚ä¸‹å›¾æ˜¯RBACæƒé™æ¨¡å‹å„è¡¨çš„åŸºæœ¬å±æ€§</p>
<p><strong>å½“åˆ¤æ–­æŸä¸ªç”¨æˆ·æ˜¯å¦æ‹¥æœ‰æŸä¸ªæƒé™çš„æ—¶å€™ï¼Œå¯æ ¹æ®user_roleè¡¨è·å–åˆ°è¯¥userå…³è”çš„roleï¼Œä¹‹åå¯æ ¹æ®role_menuè¡¨è·å–åˆ°è¯¥roleèƒ½å¤Ÿè®¿é—®çš„menuï¼ˆæƒé™ï¼‰</strong></p>
<img src="https://blog-images-1301988137.cos.ap-nanjing.myqcloud.com/blog/2207/202307182337002.png" alt="image-20230609205029592" style="zoom:80%;" /> 
<h4 id="312-å¦‚ä½•è·å–ç”¨æˆ·å…·æœ‰å“ªäº›æƒé™">3.1.2 å¦‚ä½•è·å–ç”¨æˆ·å…·æœ‰å“ªäº›æƒé™ï¼Ÿ<a hidden class="anchor" aria-hidden="true" href="#312-å¦‚ä½•è·å–ç”¨æˆ·å…·æœ‰å“ªäº›æƒé™">#</a></h4>
<p>åœ¨ç”¨æˆ·ç™»å½•çš„æ—¶å€™ï¼ˆ<code>loadUserByUsername</code>æ–¹æ³•ä¸­ï¼‰ï¼Œå°†æƒé™ä¿¡æ¯å†™å…¥<code>LoginUser</code>ä¸­</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">UsernameNotFoundException</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">SysUser</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">selectUserByUserName</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isNull</span><span class="o">(</span><span class="n">user</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;ç™»å½•ç”¨æˆ·ï¼š{} ä¸å­˜åœ¨.&#34;</span><span class="o">,</span> <span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">ServiceException</span><span class="o">(</span><span class="s">&#34;ç™»å½•ç”¨æˆ·ï¼š&#34;</span> <span class="o">+</span> <span class="n">username</span> <span class="o">+</span> <span class="s">&#34; ä¸å­˜åœ¨&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">UserStatus</span><span class="o">.</span><span class="na">DELETED</span><span class="o">.</span><span class="na">getCode</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getDelFlag</span><span class="o">()))</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;ç™»å½•ç”¨æˆ·ï¼š{} å·²è¢«åˆ é™¤.&#34;</span><span class="o">,</span> <span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">ServiceException</span><span class="o">(</span><span class="s">&#34;å¯¹ä¸èµ·ï¼Œæ‚¨çš„è´¦å·ï¼š&#34;</span> <span class="o">+</span> <span class="n">username</span> <span class="o">+</span> <span class="s">&#34; å·²è¢«åˆ é™¤&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">UserStatus</span><span class="o">.</span><span class="na">DISABLE</span><span class="o">.</span><span class="na">getCode</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getStatus</span><span class="o">()))</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;ç™»å½•ç”¨æˆ·ï¼š{} å·²è¢«åœç”¨.&#34;</span><span class="o">,</span> <span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">ServiceException</span><span class="o">(</span><span class="s">&#34;å¯¹ä¸èµ·ï¼Œæ‚¨çš„è´¦å·ï¼š&#34;</span> <span class="o">+</span> <span class="n">username</span> <span class="o">+</span> <span class="s">&#34; å·²åœç”¨&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">passwordService</span><span class="o">.</span><span class="na">validate</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">createLoginUser</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">UserDetails</span> <span class="nf">createLoginUser</span><span class="o">(</span><span class="n">SysUser</span> <span class="n">user</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="n">LoginUser</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(),</span> <span class="n">user</span><span class="o">,</span> <span class="n">permissionService</span><span class="o">.</span><span class="na">getMenuPermission</span><span class="o">(</span><span class="n">user</span><span class="o">));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>PermissionService</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * è·å–èœå•æ•°æ®æƒé™
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param user ç”¨æˆ·ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return èœå•æƒé™ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">getMenuPermission</span><span class="o">(</span><span class="n">SysUser</span> <span class="n">user</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">perms</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ç®¡ç†å‘˜æ‹¥æœ‰æ‰€æœ‰æƒé™
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">isAdmin</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">perms</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;*:*:*&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">SysRole</span><span class="o">&gt;</span> <span class="n">roles</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="na">getRoles</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">roles</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">roles</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å¤šè§’è‰²è®¾ç½®permissionså±æ€§ï¼Œä»¥ä¾¿æ•°æ®æƒé™åŒ¹é…æƒé™
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">for</span> <span class="o">(</span><span class="n">SysRole</span> <span class="n">role</span> <span class="o">:</span> <span class="n">roles</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">rolePerms</span> <span class="o">=</span> <span class="n">menuService</span><span class="o">.</span><span class="na">selectMenuPermsByRoleId</span><span class="o">(</span><span class="n">role</span><span class="o">.</span><span class="na">getRoleId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="n">role</span><span class="o">.</span><span class="na">setPermissions</span><span class="o">(</span><span class="n">rolePerms</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">perms</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">rolePerms</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">perms</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">menuService</span><span class="o">.</span><span class="na">selectMenuPermsByUserId</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">perms</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>Mapper</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&#34;selectMenuPermsByUserId&#34;</span> <span class="na">parameterType=</span><span class="s">&#34;Long&#34;</span> <span class="na">resultType=</span><span class="s">&#34;String&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">select distinct m.perms
</span></span><span class="line"><span class="cl">from sys_menu m
</span></span><span class="line"><span class="cl">         left join sys_role_menu rm on m.menu_id = rm.menu_id
</span></span><span class="line"><span class="cl">         left join sys_user_role ur on rm.role_id = ur.role_id
</span></span><span class="line"><span class="cl">         left join sys_role r on r.role_id = ur.role_id
</span></span><span class="line"><span class="cl">where m.status = &#39;0&#39; and r.status = &#39;0&#39; and ur.user_id = #{userId}
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/select&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="32-preauthorize">3.2 @PreAuthorize<a hidden class="anchor" aria-hidden="true" href="#32-preauthorize">#</a></h3>
<p>SpringSecurityä¸ºæˆ‘ä»¬æä¾›äº†åŸºäºæ³¨è§£çš„æƒé™æ§åˆ¶æ–¹æ¡ˆï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬é¡¹ç›®ä¸­ä¸»è¦é‡‡ç”¨çš„æ–¹å¼ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ³¨è§£å»æŒ‡å®šè®¿é—®å¯¹åº”çš„èµ„æºæ‰€éœ€çš„æƒé™ã€‚</p>
<p>ä½†æ˜¯è¦ä½¿ç”¨å®ƒæˆ‘ä»¬éœ€è¦å…ˆå¼€å¯ç›¸å…³é…ç½®ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@EnableGlobalMethodSecurity</span><span class="o">(</span><span class="n">prePostEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åå°±å¯ä»¥ä½¿ç”¨å¯¹åº”çš„æ³¨è§£ï¼š<code>@PreAuthorize</code></p>
<blockquote>
<p><a href="https://blog.csdn.net/goodjava2007/article/details/126395140">SpringBoot - @PreAuthorizeæ³¨è§£è¯¦è§£</a></p>
</blockquote>
<h3 id="33-è‡ªå®šä¹‰æƒé™">3.3 è‡ªå®šä¹‰æƒé™<a hidden class="anchor" aria-hidden="true" href="#33-è‡ªå®šä¹‰æƒé™">#</a></h3>
<h4 id="321-æ³¨è§£å¦‚ä½•ä½¿ç”¨">3.2.1 æ³¨è§£å¦‚ä½•ä½¿ç”¨ï¼Ÿ<a hidden class="anchor" aria-hidden="true" href="#321-æ³¨è§£å¦‚ä½•ä½¿ç”¨">#</a></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * çŠ¶æ€ä¿®æ”¹
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@PreAuthorize</span><span class="o">(</span><span class="s">&#34;@ss.hasPermi(&#39;system:user:edit&#39;)&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Log</span><span class="o">(</span><span class="n">title</span> <span class="o">=</span> <span class="s">&#34;ç”¨æˆ·ç®¡ç†&#34;</span><span class="o">,</span> <span class="n">businessType</span> <span class="o">=</span> <span class="n">BusinessType</span><span class="o">.</span><span class="na">UPDATE</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@PutMapping</span><span class="o">(</span><span class="s">&#34;/status&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ApiResponse</span> <span class="nf">changeStatus</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="n">SysUser</span> <span class="n">user</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">userService</span><span class="o">.</span><span class="na">checkUserAllowed</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">SysUser</span> <span class="n">sysUser</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SysUser</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">sysUser</span><span class="o">.</span><span class="na">setUserId</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">sysUser</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getStatus</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">user</span><span class="o">.</span><span class="na">setUpdateBy</span><span class="o">(</span><span class="n">getUsername</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">affectRows</span><span class="o">(</span><span class="n">userService</span><span class="o">.</span><span class="na">updateUserStatus</span><span class="o">(</span><span class="n">user</span><span class="o">));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="322-è‡ªå®šä¹‰æƒé™å®ç°">3.2.2 è‡ªå®šä¹‰æƒé™å®ç°<a hidden class="anchor" aria-hidden="true" href="#322-è‡ªå®šä¹‰æƒé™å®ç°">#</a></h4>
<p><code>@PreAuthorize(&quot;@ss.hasPermi('system:user:edit')&quot;)</code>çš„æ„æ€æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>A. ss æ˜¯ä¸€ä¸ªæ³¨å†Œåœ¨ Springå®¹å™¨ä¸­çš„Beanï¼›</p>
<p>B. hasPermi æ˜¯PermissionServiceç±»ä¸­å®šä¹‰çš„æ–¹æ³•ï¼›</p>
<p>C.å½“Spring EL è¡¨è¾¾å¼è¿”å›Trueï¼Œåˆ™æƒé™æ ¡éªŒé€šè¿‡ï¼›</p>
<blockquote>
<p>åœ¨<code>hasPermi</code>æ–¹æ³•ä¸­ï¼Œè·å–å½“å‰ç”¨æˆ·æƒé™<code>loginUser.getPermissions()</code>ï¼Œä¸ä¼ å…¥çš„<code>permission</code>ä½œæ¯”è¾ƒï¼Œçœ‹ä¼ å…¥çš„<code>permission</code>æ˜¯å¦åœ¨<code>loginUser</code>çš„<code>permissions</code>é›†åˆä¸­</p>
</blockquote>
<p>PermissionService.javaçš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Service</span><span class="o">(</span><span class="s">&#34;ss&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PermissionService</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/** æ‰€æœ‰æƒé™æ ‡è¯† */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">ALL_PERMISSION</span> <span class="o">=</span> <span class="s">&#34;*:*:*&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/** ç®¡ç†å‘˜è§’è‰²æƒé™æ ‡è¯† */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">SUPER_ADMIN</span> <span class="o">=</span> <span class="s">&#34;admin&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">ROLE_DELIMETER</span> <span class="o">=</span> <span class="s">&#34;,&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">PERMISSION_DELIMETER</span> <span class="o">=</span> <span class="s">&#34;,&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * éªŒè¯ç”¨æˆ·æ˜¯å¦å…·å¤‡æŸæƒé™
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param permission æƒé™å­—ç¬¦ä¸²
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return ç”¨æˆ·æ˜¯å¦å…·å¤‡æŸæƒé™
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasPermi</span><span class="o">(</span><span class="n">String</span> <span class="n">permission</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">permission</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">LoginUser</span> <span class="n">loginUser</span> <span class="o">=</span> <span class="n">SecurityUtils</span><span class="o">.</span><span class="na">getLoginUser</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isNull</span><span class="o">(</span><span class="n">loginUser</span><span class="o">)</span> <span class="o">||</span> <span class="n">CollectionUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">loginUser</span><span class="o">.</span><span class="na">getPermissions</span><span class="o">()))</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">PermissionContextHolder</span><span class="o">.</span><span class="na">setContext</span><span class="o">(</span><span class="n">permission</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">hasPermissions</span><span class="o">(</span><span class="n">loginUser</span><span class="o">.</span><span class="na">getPermissions</span><span class="o">(),</span> <span class="n">permission</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="323-å¦‚ä½•ä½¿ç”¨åŸç”Ÿçš„æƒé™">3.2.3 å¦‚ä½•ä½¿ç”¨åŸç”Ÿçš„æƒé™ï¼Ÿ<a hidden class="anchor" aria-hidden="true" href="#323-å¦‚ä½•ä½¿ç”¨åŸç”Ÿçš„æƒé™">#</a></h4>
<h3 id="34-å‰ç«¯æƒé™æ ¡éªŒ">3.4 å‰ç«¯æƒé™æ ¡éªŒ<a hidden class="anchor" aria-hidden="true" href="#34-å‰ç«¯æƒé™æ ¡éªŒ">#</a></h3>
<h4 id="341-è‡ªå®šä¹‰æŒ‡ä»¤-directives">3.4.1 è‡ªå®šä¹‰æŒ‡ä»¤-Directives<a hidden class="anchor" aria-hidden="true" href="#341-è‡ªå®šä¹‰æŒ‡ä»¤-directives">#</a></h4>
<blockquote>
<p>ä½¿ç”¨vueçš„<a href="https://cn.vuejs.org/guide/reusability/custom-directives.html">è‡ªå®šä¹‰æŒ‡ä»¤-Directives</a>å®ç°å‰ç«¯æ ¹æ®æƒé™å†³å®šæ˜¯å¦æ¸²æŸ“æ“ä½œç»„ä»¶</p>
</blockquote>
<p>åˆ›å»º<strong>æ“ä½œæƒé™</strong>Directiveä»¥åŠ<strong>è§’è‰²æƒé™</strong>Directive</p>
<p>æ ¹æ®<strong>ç”¨æˆ·æ‹¥æœ‰çš„permissionsä»¥åŠroles</strong>å†³å®šæ˜¯å¦æ¸²æŸ“è¢«ç›¸åº”è‡ªå®šä¹‰ç»„ä»¶æ ‡æ³¨çš„æ“ä½œç»„ä»¶</p>
<p><code>src/directive/permission/index.ts</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">type</span> <span class="p">{</span> <span class="nx">Directive</span><span class="p">,</span> <span class="nx">DirectiveBinding</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;vue&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">useUserStore</span> <span class="nx">from</span> <span class="s2">&#34;@/stores/modules/user&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * æ“ä½œæƒé™å¤„ç†
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">hasPermi</span><span class="o">:</span> <span class="nx">Directive</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">mounted</span><span class="p">(</span><span class="nx">el</span><span class="o">:</span> <span class="nx">HTMLElement</span><span class="p">,</span> <span class="nx">binding</span><span class="o">:</span> <span class="nx">DirectiveBinding</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="p">{</span> <span class="nx">value</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">binding</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">all_permission</span> <span class="o">=</span> <span class="s2">&#34;*:*:*&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">store</span> <span class="o">=</span> <span class="nx">useUserStore</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">permissions</span> <span class="o">=</span> <span class="nx">store</span><span class="p">.</span><span class="nx">permissions</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span> <span class="k">instanceof</span> <span class="nb">Array</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">permissionFlag</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">hasPermissions</span> <span class="o">=</span> <span class="nx">permissions</span><span class="p">.</span><span class="nx">some</span><span class="p">((</span><span class="nx">permission</span><span class="o">:</span> <span class="nx">string</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">all_permission</span> <span class="o">===</span> <span class="nx">permission</span> <span class="o">||</span> <span class="nx">permissionFlag</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">permission</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hasPermissions</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">el</span><span class="p">.</span><span class="nx">parentNode</span> <span class="o">&amp;&amp;</span> <span class="nx">el</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">el</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="sb">`è¯·è®¾ç½®æ“ä½œæƒé™æ ‡ç­¾å€¼`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * è§’è‰²æƒé™å¤„ç†
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">hasRole</span><span class="o">:</span> <span class="nx">Directive</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">mounted</span><span class="p">(</span><span class="nx">el</span><span class="o">:</span> <span class="nx">HTMLElement</span><span class="p">,</span> <span class="nx">binding</span><span class="o">:</span> <span class="nx">DirectiveBinding</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="p">{</span> <span class="nx">value</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">binding</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">super_admin</span> <span class="o">=</span> <span class="s2">&#34;admin&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">store</span> <span class="o">=</span> <span class="nx">useUserStore</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">roles</span> <span class="o">=</span> <span class="nx">store</span><span class="p">.</span><span class="nx">roles</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span> <span class="k">instanceof</span> <span class="nb">Array</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">roleFlag</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">hasRole</span> <span class="o">=</span> <span class="nx">roles</span><span class="p">.</span><span class="nx">some</span><span class="p">((</span><span class="nx">role</span><span class="o">:</span> <span class="nx">string</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">super_admin</span> <span class="o">===</span> <span class="nx">role</span> <span class="o">||</span> <span class="nx">roleFlag</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">role</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hasRole</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">el</span><span class="p">.</span><span class="nx">parentNode</span> <span class="o">&amp;&amp;</span> <span class="nx">el</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">el</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="sb">`è¯·è®¾ç½®è§’è‰²æƒé™æ ‡ç­¾å€¼&#34;`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="342-å…¨å±€æ³¨å†Œè‡ªå®šä¹‰æŒ‡ä»¤">3.4.2 å…¨å±€æ³¨å†Œè‡ªå®šä¹‰æŒ‡ä»¤<a hidden class="anchor" aria-hidden="true" href="#342-å…¨å±€æ³¨å†Œè‡ªå®šä¹‰æŒ‡ä»¤">#</a></h4>
<p><code>src/directive/index.ts</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">hasRole</span><span class="p">,</span> <span class="nx">hasPermi</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;./permission&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">type</span> <span class="p">{</span> <span class="nx">App</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;@vue/runtime-core&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="kd">function</span> <span class="nx">directive</span><span class="p">(</span><span class="nx">app</span><span class="o">:</span> <span class="nx">App</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">app</span><span class="p">.</span><span class="nx">directive</span><span class="p">(</span><span class="s2">&#34;hasRole&#34;</span><span class="p">,</span> <span class="nx">hasRole</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">app</span><span class="p">.</span><span class="nx">directive</span><span class="p">(</span><span class="s2">&#34;hasPermi&#34;</span><span class="p">,</span> <span class="nx">hasPermi</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>main.ts</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">createApp</span><span class="p">(</span><span class="nx">App</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">directive</span> <span class="nx">from</span> <span class="s2">&#34;./directive&#34;</span><span class="p">;</span> <span class="c1">// directive
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">directive</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="343-ä½¿ç”¨è‡ªå®šä¹‰æŒ‡ä»¤">3.4.3 ä½¿ç”¨è‡ªå®šä¹‰æŒ‡ä»¤<a hidden class="anchor" aria-hidden="true" href="#343-ä½¿ç”¨è‡ªå®šä¹‰æŒ‡ä»¤">#</a></h4>
<p>ä¾‹å¦‚ <code>v-hasPermi=&quot;['system:role:add']&quot;</code></p>
<p>ä¼šæ ¹æ®å½“å‰ç”¨æˆ·æ˜¯å¦å…·æœ‰ <code>'system:role:add'</code> æ“ä½œæƒé™æ¥å†³å®šæ˜¯å¦æ¸²æŸ“button</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">el-button</span>
</span></span><span class="line"><span class="cl">  <span class="na">type</span><span class="o">=</span><span class="s">&#34;primary&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="na">plain</span>
</span></span><span class="line"><span class="cl">  <span class="na">icon</span><span class="o">=</span><span class="s">&#34;Plus&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="na">style</span><span class="o">=</span><span class="s">&#34;margin-right: 30px&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="na">click</span><span class="o">=</span><span class="s">&#34;handleAdd&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="na">v-hasPermi</span><span class="o">=</span><span class="s">&#34;[&#39;system:role:add&#39;]&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">&gt;</span>æ–°å¢è§’è‰²<span class="p">&lt;/</span><span class="nt">el-button</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div>

  </div>

  <footer class="post-footer">
    
<nav class="paginav">
  <a class="prev" href="https://chance7bin.github.io/posts/map/%E4%BD%BF%E7%94%A8mbtiles%E5%8F%91%E5%B8%83%E5%9C%B0%E5%9B%BE%E6%9C%8D%E5%8A%A1/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>ä½¿ç”¨mbtileså‘å¸ƒåœ°å›¾æœåŠ¡</span>
  </a>
  <a class="next" href="https://chance7bin.github.io/posts/map/java%E4%BD%BF%E7%94%A8geoserver%E5%8F%91%E5%B8%83%E5%9C%B0%E5%9B%BE%E6%9C%8D%E5%8A%A1/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>Javaä½¿ç”¨Geoserverå‘å¸ƒåœ°å›¾æœåŠ¡</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://chance7bin.github.io/">Binb&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerHTML = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
