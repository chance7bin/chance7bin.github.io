<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>æ–­ç‚¹ç»­ä¼  | Binb&#39;s Blog</title>
<meta name="keywords" content="ç³»ç»Ÿè®¾è®¡, æ–­ç‚¹ç»­ä¼ ">
<meta name="description" content="æœ¬ç¯‡æ–‡ç« ä¸»è¦å†…å®¹æ˜¯åˆ†ç‰‡ä¸Šä¼ ã€æ–­ç‚¹ç»­ä¼ ã€ç§’ä¼ çš„å®ç°æ€è·¯ å‰è¨€ åˆ†ç‰‡ï¼š åˆ†ç‰‡ä»»åŠ¡æ˜¯åœ¨å‰ç«¯ç”±vue-simple-uploaderæ’ä»¶å®Œæˆï¼Œæµç¨‹ï¼š1.å‰">
<meta name="author" content="chance7bin">
<link rel="canonical" href="https://chance7bin.github.io/posts/design/%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.be81eec981a615a87a88f121642d7eebde74d033438693944db2fd6b827284ff.css" integrity="" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.acb54fd32bbc1982428b8850317e45d076b95012730a5936667e6bc21777692a.js" integrity=""
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<link rel="icon" type="image/png" sizes="16x16" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<link rel="icon" type="image/png" sizes="32x32" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<link rel="apple-touch-icon" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<link rel="mask-icon" href="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="æ–­ç‚¹ç»­ä¼ " />
<meta property="og:description" content="æœ¬ç¯‡æ–‡ç« ä¸»è¦å†…å®¹æ˜¯åˆ†ç‰‡ä¸Šä¼ ã€æ–­ç‚¹ç»­ä¼ ã€ç§’ä¼ çš„å®ç°æ€è·¯ å‰è¨€ åˆ†ç‰‡ï¼š åˆ†ç‰‡ä»»åŠ¡æ˜¯åœ¨å‰ç«¯ç”±vue-simple-uploaderæ’ä»¶å®Œæˆï¼Œæµç¨‹ï¼š1.å‰" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://chance7bin.github.io/posts/design/%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-09T22:37:33+08:00" />
<meta property="article:modified_time" content="2023-06-09T22:37:33+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="æ–­ç‚¹ç»­ä¼ "/>
<meta name="twitter:description" content="æœ¬ç¯‡æ–‡ç« ä¸»è¦å†…å®¹æ˜¯åˆ†ç‰‡ä¸Šä¼ ã€æ–­ç‚¹ç»­ä¼ ã€ç§’ä¼ çš„å®ç°æ€è·¯ å‰è¨€ åˆ†ç‰‡ï¼š åˆ†ç‰‡ä»»åŠ¡æ˜¯åœ¨å‰ç«¯ç”±vue-simple-uploaderæ’ä»¶å®Œæˆï¼Œæµç¨‹ï¼š1.å‰"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "ğŸ“š æ–‡ç« ",
      "item": "https://chance7bin.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ¨ ç³»ç»Ÿè®¾è®¡",
      "item": "https://chance7bin.github.io/posts/design/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "æ–­ç‚¹ç»­ä¼ ",
      "item": "https://chance7bin.github.io/posts/design/%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "æ–­ç‚¹ç»­ä¼ ",
  "name": "æ–­ç‚¹ç»­ä¼ ",
  "description": "æœ¬ç¯‡æ–‡ç« ä¸»è¦å†…å®¹æ˜¯åˆ†ç‰‡ä¸Šä¼ ã€æ–­ç‚¹ç»­ä¼ ã€ç§’ä¼ çš„å®ç°æ€è·¯ å‰è¨€ åˆ†ç‰‡ï¼š åˆ†ç‰‡ä»»åŠ¡æ˜¯åœ¨å‰ç«¯ç”±vue-simple-uploaderæ’ä»¶å®Œæˆï¼Œæµç¨‹ï¼š1.å‰",
  "keywords": [
    "ç³»ç»Ÿè®¾è®¡", "æ–­ç‚¹ç»­ä¼ "
  ],
  "articleBody": " æœ¬ç¯‡æ–‡ç« ä¸»è¦å†…å®¹æ˜¯åˆ†ç‰‡ä¸Šä¼ ã€æ–­ç‚¹ç»­ä¼ ã€ç§’ä¼ çš„å®ç°æ€è·¯\nå‰è¨€ åˆ†ç‰‡ï¼š åˆ†ç‰‡ä»»åŠ¡æ˜¯åœ¨å‰ç«¯ç”±vue-simple-uploaderæ’ä»¶å®Œæˆï¼Œæµç¨‹ï¼š1.å‰ç«¯å…ˆå‘é€check-fileï¼ˆæ£€æŸ¥æ–‡ä»¶MD5ï¼‰æ¥ç¡®è®¤æ–‡ä»¶æ˜¯ç›´æ¥ç§’ä¼ è¿˜æ˜¯åˆ†ç‰‡ä¸Šä¼ ï¼Œå¦‚æœè®¡ç®—å‡ºæ–‡ä»¶æ‰€æœ‰ç‰‡å·²ç»ä¸Šä¼ å®Œæˆï¼Œåˆ™å¯ç”¨ç§’ä¼ ï¼ˆç§’ä¼ å°±æ˜¯ä¸ä¼ ï¼‰ï¼Œå¦‚æœæ˜¯æ–°æ–‡ä»¶ï¼Œåˆ™éœ€è¦åˆ†ç‰‡ä¸Šä¼ ï¼Œç”±vue-simple-uploaderæ’ä»¶å°†æ–‡ä»¶æŒ‰å›ºå®šå¤§å°è¿›è¡Œåˆ‡å‰²ï¼Œç„¶åé€ç‰‡ä¸Šä¼ ã€‚\næ–­ç‚¹ç»­ä¼ ï¼š æ„æ€å°±æ˜¯ä¸€ä¸ªå¤§æ–‡ä»¶åˆ†äº†å¤šå°‘ç‰‡ï¼Œè¿™äº›ç‰‡å·²ç»ä¸Šä¼ äº†å“ªäº›ï¼Œè¿˜æœ‰å“ªäº›æ²¡ä¸Šä¼ ï¼Œè¿™äº›éƒ½ä¼šè®°å½•åœ¨æ–‡ä»¶å­˜å‚¨ç›®å½•ä¸‹çš„.confæ–‡ä»¶ä¸­ï¼Œå½“ä½ ä¸Šä¼ å¤§æ–‡ä»¶æ—¶ï¼Œä¼ ä¸€éƒ¨åˆ†ååˆ·æ–°æµè§ˆå™¨æˆ–å…³é—­æµè§ˆå™¨ï¼Œè¿™æ—¶å€™ä¼ è¾“ä¼šä¸­æ–­ï¼Œç„¶åä½ å†æ‰“å¼€é¡µé¢é‡æ–°ä¸Šä¼ è¯¥æ–‡ä»¶ï¼Œå®ƒä¼šå…ˆæ£€æµ‹è¿˜æœ‰å“ªäº›ç‰‡æ²¡æœ‰ä¸Šä¼ ï¼Œç„¶åç›´æ¥ä¸Šä¼ çš„ä¸Šæ¬¡æœªä¼ çš„ç‰‡ï¼Œè¿™å°±æ˜¯æ–­ç‚¹ç»­ä¼ ã€‚\n**ç§’ä¼ ï¼š**æ–‡ä»¶ä¸ç»è¿‡ä¸Šä¼ çš„æ­¥éª¤ï¼Œç›´æ¥å°†æ–‡ä»¶ä¿¡æ¯ä¿å­˜åœ¨æœåŠ¡å™¨ä¸­ã€‚é€šè¿‡è®¡ç®—æ–‡ä»¶md5å®ç°\næµç¨‹ æ ¡éªŒæ–‡ä»¶ä¸Šä¼ çŠ¶æ€ï¼š å‰ç«¯ç”Ÿæˆè¯¥æ–‡ä»¶çš„MD5å¯†æ–‡å¹¶è¿›è¡Œåˆ†ç‰‡ï¼Œä¸Šä¼ ä¹‹å‰è¯·æ±‚check-md5æ¥å£ï¼Œä¼ å…¥æ–‡ä»¶åå’Œå¯†æ–‡ï¼Œæ¥å£æ ¡éªŒæ–‡ä»¶æ˜¯æœªä¸Šä¼  æˆ– ä¸Šä¼ äº†ä¸€éƒ¨åˆ† æˆ– å·²ä¸Šä¼ å®Œæˆä¸‰ä¸ªçŠ¶æ€ï¼Œå…¶ä¸­æœªä¸Šä¼ è¿”å›è‡ªå®šä¹‰çŠ¶æ€ç 404ï¼Œä¸Šä¼ ä¸€éƒ¨åˆ†åˆ™è¿”å›çŠ¶æ€206+æœªä¸Šä¼ çš„åˆ†ç‰‡IDï¼Œä¸Šä¼ å®Œæˆåˆ™è¿”å›çŠ¶æ€200ã€‚ å‰ç«¯é€ç‰‡ä¸Šä¼ ï¼š æ ¡éªŒå®Œæˆåï¼Œæ ¹æ®æ ¡éªŒç»“æœå¯¹æœªä¸Šä¼ çš„åˆ†ç‰‡è¿›è¡Œé€ä¸ªä¸Šä¼ ï¼Œä¸Šä¼ åˆ†ç‰‡æ—¶å‚æ•°ä¸»è¦æ˜¯ï¼šæ€»ç‰‡æ•°ã€å½“å‰ç‰‡IDã€ç‰‡æ–‡ä»¶ ä¸Šä¼ æ¥å£ï¼š ä¸Šä¼ æ¥å£ä¼šå…ˆå»è·å–å¹¶è§£æè¯¥æ–‡ä»¶çš„confæ–‡ä»¶ï¼ˆconfæ–‡ä»¶æ˜¯RandomAccessFileï¼Œè¯¥ç±»æ˜¯é€šè¿‡æä¾›æŒ‡é’ˆçš„æ–¹å¼æ“ä½œæ–‡ä»¶ï¼Œæ–‡ä»¶å­˜å‚¨çš„æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶æ•°ç»„ï¼Œæ‰€ä»¥å¯ä»¥ç”¨æ¥æ•°ç»„ä¸‹æ ‡æ ‡è®°ç‰‡IDï¼‰ï¼Œä½¿ç”¨setLengthæ–¹æ³•è®¾ç½®confæ–‡ä»¶é•¿åº¦ï¼Œä½¿ç”¨seekæ–¹æ³•è·³åˆ°å½“å‰ä¸Šä¼ çš„ç‰‡IDçš„ä½ç½®ï¼ŒæŠŠè¯¥ä½ç½®çš„å€¼æ›¿æ¢æˆ127ï¼Œç„¶åå°†è¯¥åˆ†ç‰‡ä½¿ç”¨æŒ‡é’ˆåç§»çš„æ–¹å¼æ’å…¥åˆ°_tmpä¸´æ—¶æ–‡ä»¶ï¼ˆä¸´æ—¶æ–‡ä»¶ä¹Ÿæ˜¯RandomAccessFileæ–‡ä»¶ï¼‰ä¸­ï¼Œç„¶åæ ¡éªŒæ˜¯å¦æ‰€æœ‰çš„ç‰‡éƒ½ä¸Šä¼ å®Œæˆï¼Œæ˜¯åˆ™ä¿®æ”¹ä¸´æ—¶æ–‡ä»¶ä¸ºæ­£å¼æ–‡ä»¶åï¼Œè‡³æ­¤ä¸Šä¼ å®Œæˆï¼Œå¦åˆ™ç›´æ¥è¿”å›è¯¥åˆ†ç‰‡ä¸Šä¼ å®Œæˆ ä¸Šä¼ è¿›åº¦ï¼š å‰ç«¯æ”¶åˆ°å½“å‰ç‰‡çš„å“åº”ç»“æœåï¼Œä¼šæ ¹æ®å·²ä¸Šä¼ ç‰‡æ•°é‡è·å–åˆ°ä¸Šä¼ è¿›åº¦ MD5çš„ç”¨æ³•ï¼š ç”¨äºè®¡ç®—æœåŠ¡å™¨æ˜¯å¦å·²ç»å­˜åœ¨ç›¸åŒmd5çš„æ–‡ä»¶ï¼Œç”¨ä½œç§’ä¼ åŠŸèƒ½çš„å®ç°ã€‚å‰ç«¯è®¡ç®—æ–‡ä»¶md5ï¼Œä¼ å…¥åç«¯è¿›è¡ŒæŸ¥æ‰¾æ˜¯å¦å·²ç»æœ‰ç›¸åŒmd5æ–‡ä»¶ï¼Œè‹¥å­˜åœ¨ç›´æ¥è¿”å›ä¸Šä¼ æˆåŠŸï¼Œå¦åˆ™èµ°ä¸Šä¼ çš„æ­¥éª¤ åç«¯æ¥å£ Controller\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 /** * æ£€æŸ¥æ–‡ä»¶MD5ï¼ˆæ–‡ä»¶MD5è‹¥å·²å­˜åœ¨è¿›è¡Œç§’ä¼ ï¼‰ * * @param md5 md5 * @param fileName æ–‡ä»¶åç§° * @return {@link ApiResponse} * @author 7bin **/ @GetMapping(value = \"/check\") public ApiResponse checkFileMd5(String md5, String fileName) { // Result result = fileService.checkFileMd5(md5, fileName); // return NovelWebUtils.forReturn(result); return ApiResponse.success(); } /** * æ–­ç‚¹ç»­ä¼ æ–¹å¼ä¸Šä¼ æ–‡ä»¶ï¼šç”¨äºå¤§æ–‡ä»¶ä¸Šä¼  * * @param chunkDTO å‚æ•° * @param request è¯·æ±‚ * @return {@link ApiResponse} * @author 7bin **/ @PostMapping(value = \"/breakpoint-upload\", consumes = \"multipart/*\", headers = \"content-type=multipart/form-data\", produces = \"application/json;charset=UTF-8\") public ApiResponse breakpointResumeUpload(Chunk chunkDTO, HttpServletRequest request) { String id = chunkDTO.getIdentifier(); int chunks = Math.toIntExact(chunkDTO.getTotalChunks()); int chunk = chunkDTO.getChunkNumber() - 1; long size = chunkDTO.getCurrentChunkSize(); String name = chunkDTO.getFilename(); MultipartFile file = chunkDTO.getFile(); String md5 = chunkDTO.getIdentifier(); UploadFileParam param = new UploadFileParam(id, chunks, chunk, size, name, file, md5); // return ApiResponse.success(); Result result = fileService.breakpointResumeUpload(param, request); return NovelWebUtils.forReturn(result); } /** * æ£€æŸ¥æ–‡ä»¶MD5ï¼ˆæ–‡ä»¶MD5è‹¥å·²å­˜åœ¨è¿›è¡Œç§’ä¼ ï¼‰ * @param chunkMap * @return {@link ApiResponse} * @author 7bin **/ @GetMapping(value = \"/breakpoint-upload\") public ApiResponse breakpointResumeUploadPre( @RequestParam Map\u003cString, String\u003e chunkMap) { String md5 = chunkMap.get(\"identifier\"); String filename = chunkMap.get(\"filename\"); Result\u003cJSONArray\u003e result = fileService.checkFileMd5(md5, filename); JSONObject res = new JSONObject(); // æ•°æ®åº“ä¸­å­˜åœ¨è¯¥md5åˆ™ç§’ä¼  if (result == null){ res.put(\"skipUpload\",true); return ApiResponse.success(res); } boolean skipUpload = false; if (\"200\".equals(result.getCode()) || \"201\".equals(result.getCode())) { skipUpload = true; } else if (\"206\".equals(result.getCode())) { // å·²ç»ä¸Šä¼ éƒ¨åˆ†åˆ†å— // dataä¸­å­˜æ”¾çš„æ˜¯è¿˜æœªä¸Šä¼ çš„åˆ†å— JSONArray data = result.getData(); res.put(\"missChunks\",data); } res.put(\"skipUpload\",skipUpload); return ApiResponse.success(res); // Result result = fileService.breakpointResumeUpload(param, request); // return NovelWebUtils.forReturn(result); } Service\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 @Override public Result\u003cJSONArray\u003e checkFileMd5(String md5, String fileName) { boolean exist = fileMapper.fileIsExist(md5); if (exist){ return null; } Result\u003cJSONArray\u003e result; try { // String realFilename = md5 + \"_\" + fileName; String realFilename = md5; result = LocalUpload.checkFileMd5(md5, realFilename, confFilePath, savePath); } catch (Exception e) { // e.printStackTrace(); log.error(e.getMessage()); throw new ServiceException(e.getMessage()); } return result; } @Override public Result breakpointResumeUpload(UploadFileParam param, HttpServletRequest request) { Result result; try { // è¿™é‡Œçš„ chunkSize(åˆ†ç‰‡å¤§å°) è¦ä¸å‰ç«¯ä¼ è¿‡æ¥çš„å¤§å°ä¸€è‡´ // long chunkSize = Objects.isNull(param.getChunkSize()) ? 5 * 1024 * 1024 // : param.getChunkSize(); // å®é™…å­˜å‚¨çš„æ–‡ä»¶æ ¼å¼ä¸º [{md5}_{filename}] // String realFilename = param.getMd5() + \"_\" + param.getName(); String realFilename = param.getMd5(); param.setName(realFilename); result = LocalUpload.fragmentFileUploader(param, confFilePath, savePath, 5242880L, request); // return NovelWebUtils.forReturn(result); } catch (Exception e) { log.error(e.getMessage()); throw new ServiceException(e.getMessage()); } return result; } å‰ç«¯ä»£ç  SimpleUploader.vue\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 \u003ctemplate\u003e \u003cdiv id=\"global-uploader\"\u003e \u003cuploader class=\"uploader-app\" :options=\"initOptions\" :file-status-text=\"fileStatusText\" :auto-start=\"false\" @file-added=\"onFileAdded\" @file-success=\"onFileSuccess\" @file-progress=\"onFileProgress\" @file-error=\"onFileError\" \u003e \u003cuploader-unsupport\u003e\u003c/uploader-unsupport\u003e \u003cuploader-drop\u003e \u003cuploader-btn \u003eé€‰æ‹©æ–‡ä»¶\u003c/uploader-btn\u003e \u003cspan style=\"margin-left: 10px\"\u003eï¼ˆæ”¯æŒä¸Šä¼ ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶ï¼‰\u003c/span\u003e \u003c/uploader-drop\u003e \u003cuploader-list\u003e \u003ctemplate #default=\"{ fileList }\"\u003e \u003cdiv class=\"file-panel\"\u003e \u003cul class=\"file-list\"\u003e \u003cli v-for=\"file in fileList\" :key=\"file.id\" class=\"file-item\" \u003e \u003cuploader-file ref=\"files\" :class=\"['file_' + file.id, customStatus]\" :file=\"file\" :list=\"true\" \u003e\u003c/uploader-file\u003e \u003c/li\u003e \u003cdiv v-if=\"!fileList.length\" class=\"no-file\"\u003e æš‚æ— å¾…ä¸Šä¼ æ–‡ä»¶ \u003c/div\u003e \u003c/ul\u003e \u003c/div\u003e \u003c/template\u003e \u003c/uploader-list\u003e \u003c/uploader\u003e \u003c/div\u003e \u003c/template\u003e \u003cscript setup\u003e import useCurrentInstance from \"@/utils/currentInstance\"; import { generateMD5 } from \"@/components/Uploader/utils/md5\"; import { ElNotification } from \"element-plus\"; import { addFileToDrive } from \"@/api/drive/drive\"; import { checkAuth } from \"@/api/admin/user\"; const { proxy } = useCurrentInstance(); // TODO ä¸Šä¼ ç»„ä»¶è¿˜æœ‰bug ä¸Šä¼ æˆåŠŸæ—¶åŠ¨ä½œæŒ‰é’®æ²¡æœ‰éšè—ï¼›åç«¯å‡ºç°é”™è¯¯ä¸Šä¼ å¤±è´¥æ—¶èƒŒæ™¯è‰²æ²¡å˜çº¢ // props // emits const emits = defineEmits(['uploadSuccess']); const drivePath = import.meta.env.VITE_APP_DRIVE_API; const initOptions = { target: drivePath + \"/file/breakpoint-upload\", chunkSize: '5242880', forceChunkSize: true, fileParameterName: 'file', maxChunkRetries: 3, // æ˜¯å¦å¼€å¯æœåŠ¡å™¨åˆ†ç‰‡æ ¡éªŒ testChunks: true, // æœåŠ¡å™¨åˆ†ç‰‡æ ¡éªŒå‡½æ•°ï¼Œç§’ä¼ åŠæ–­ç‚¹ç»­ä¼ åŸºç¡€ checkChunkUploadedByResponse: function (chunk, message) { let skip = false // console.log(\"checkChunkUploadedByResponse chunk:\", chunk); // console.log(\"checkChunkUploadedByResponse message:\", message); try { let objMessage = JSON.parse(message) // console.log(\"objMessage:\", objMessage); if (objMessage.code === 200) { if (objMessage.data.skipUpload) { skip = true } else if (objMessage.data.missChunks == null){ skip = false; } else { skip = (objMessage.data.missChunks || []).indexOf(chunk.offset.toString()) \u003c 0 } } } catch (e) {} // console.log(\"skip: \" + chunk.offset + \" \" + skip); return skip }, query: (file, chunk) =\u003e { // console.log(\"query:\", file); return { ...file.params } } } const customStatus = ref('') const fileStatusText = { success: 'ä¸Šä¼ æˆåŠŸ', error: 'ä¸Šä¼ å¤±è´¥', uploading: 'ä¸Šä¼ ä¸­', paused: 'å·²æš‚åœ', waiting: 'ç­‰å¾…ä¸Šä¼ ' } // const uploaderRef = ref() // const uploader = computed(() =\u003e uploaderRef.value?.uploader) async function onFileAdded(file) { // åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²ç»ç™»å½•äº†ï¼Œç™»å½•æ‰å¯ä»¥æ·»åŠ  await checkAuth(); // æš‚åœæ–‡ä»¶ // é€‰æ‹©æ–‡ä»¶åæš‚åœæ–‡ä»¶ä¸Šä¼ ï¼Œä¸Šä¼ æ—¶æ‰‹åŠ¨å¯åŠ¨ file.pause() // console.log(\"onFileAdded file: \", file); // panelShow.value = true // trigger('fileAdded') // å°†é¢å¤–çš„å‚æ•°èµ‹å€¼åˆ°æ¯ä¸ªæ–‡ä»¶ä¸Šï¼Œä»¥ä¸åŒæ–‡ä»¶ä½¿ç”¨ä¸åŒparamsçš„éœ€æ±‚ // file.params = customParams.value // è®¡ç®—MD5 const md5 = await computeMD5(file) startUpload(file, md5) } function computeMD5(file) { // æ–‡ä»¶çŠ¶æ€è®¾ä¸º\"è®¡ç®—MD5\" statusSet(file.id, 'md5') // è®¡ç®—MD5æ—¶éšè—\"å¼€å§‹\"æŒ‰é’® nextTick(() =\u003e { // document.querySelector(`.file_${file.id} .uploader-file-resume`).style.display = 'none' document.querySelector(`.file_${file.id} .uploader-file-actions`).style.display = 'none' }) // å¼€å§‹è®¡ç®—MD5 return new Promise((resolve, reject) =\u003e { generateMD5(file, { onProgress(currentChunk, chunks) { // å®æ—¶å±•ç¤ºMD5çš„è®¡ç®—è¿›åº¦ nextTick(() =\u003e { const md5ProgressText = 'æ ¡éªŒMD5 ' + ((currentChunk / chunks) * 100).toFixed(0) + '%' document.querySelector(`.custom-status-${file.id}`).innerText = md5ProgressText }) }, onSuccess(md5) { statusRemove(file.id) resolve(md5) }, onError() { error(`æ–‡ä»¶${file.name}è¯»å–å‡ºé”™ï¼Œè¯·æ£€æŸ¥è¯¥æ–‡ä»¶`) file.cancel() statusRemove(file.id) reject() } }) }) } // md5è®¡ç®—å®Œæ¯•ï¼Œå¼€å§‹ä¸Šä¼  function startUpload(file, md5) { file.uniqueIdentifier = md5 file.resume() } function onFileProgress(rootFile, file, chunk) { console.log( `ä¸Šä¼ ä¸­ ${file.name}ï¼Œchunkï¼š${chunk.startByte / 1024 / 1024} ~ ${ chunk.endByte / 1024 / 1024 }` ) } const onFileError = (rootFile, file, response, chunk) =\u003e { // console.log('error', file) error(response) } function error(msg) { ElNotification({ title: 'é”™è¯¯', message: msg, type: 'error', duration: 2000 }) } const onFileSuccess = (rootFile, file, response, chunk) =\u003e { // console.log(\"ä¸Šä¼ æˆåŠŸ\") // console.log(\"rootFile\",rootFile) // fileçš„relativePathæ˜¯æ–‡ä»¶å¤¹çš„ç›¸å¯¹è·¯å¾„(å¦‚æœä¸Šä¼ çš„æ˜¯æ–‡ä»¶å¤¹çš„è¯) // console.log(\"file\",file) // console.log(\"response\",JSON.parse(response)) // console.log(\"chunk\",chunk) // addFileToDrive(file.name, file.uniqueIdentifier, file.size).then(() =\u003e { // proxy.$modal.msgSuccess(\"æ–‡ä»¶ä¸Šä¼ æˆåŠŸ\"); // }) // æœåŠ¡ç«¯è‡ªå®šä¹‰çš„é”™è¯¯ï¼ˆå³httpçŠ¶æ€ç ä¸º200ï¼Œä½†æ˜¯æ˜¯é”™è¯¯çš„æƒ…å†µï¼‰ï¼Œè¿™ç§é”™è¯¯æ˜¯Uploaderæ— æ³•æ‹¦æˆªçš„ let res = JSON.parse(response) console.log(\"onFileSuccess res:\", res); if (res.code !== 200) { error(res.message) // æ–‡ä»¶çŠ¶æ€è®¾ä¸ºâ€œå¤±è´¥â€ statusSet(file.id, 'failed') return } emits(\"uploadSuccess\", file); } /** * æ–°å¢çš„è‡ªå®šä¹‰çš„çŠ¶æ€: 'md5'ã€'merging'ã€'transcoding'ã€'failed' * @param id * @param status */ function statusSet(id, status) { const statusMap = { md5: { text: 'æ ¡éªŒMD5', bgc: '#fff' }, failed: { text: 'ä¸Šä¼ å¤±è´¥', bgc: '#e2eeff' } } customStatus.value = status nextTick(() =\u003e { const statusTag = document.createElement('span') statusTag.className = `custom-status-${id} custom-status` statusTag.innerText = statusMap[status].text statusTag.style.backgroundColor = statusMap[status].bgc // custom-status æ ·å¼ä¸ç”Ÿæ•ˆ // ç”±äº styleè„šæœ¬ è®¾ç½®äº† scopedï¼Œæ·±å±‚çš„æ ·å¼ä¿®æ”¹ä¸äº† // é€šè¿‡ç»™å½“å‰ç»„ä»¶è®¾ç½®ä¸€ä¸ªidï¼Œåœ¨è¯¥idä¸‹è®¾ç½®æ ·å¼ï¼Œå°±å¯ä»¥ä¿è¯æ ·å¼ä¸å…¨å±€æ±¡æŸ“ // statusTag.style.position = 'absolute'; // statusTag.style.top = '0'; // statusTag.style.left = '0'; // statusTag.style.right = '0'; // statusTag.style.bottom = '0'; // statusTag.style.zIndex = '1'; const statusWrap = document.querySelector(`.file_${id} .uploader-file-status`) statusWrap.appendChild(statusTag) }) } function statusRemove(id) { customStatus.value = '' nextTick(() =\u003e { const statusTag = document.querySelector(`.custom-status-${id}`) document.querySelector(`.file_${id} .uploader-file-actions`).style.display = 'block' statusTag.remove() }) } \u003c/script\u003e md5.js\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 import SparkMD5 from 'spark-md5' /** * åˆ†æ®µè®¡ç®—MD5 * @param file {File} * @param options {Object} - onProgress | onSuccess | onError */ export function generateMD5(file, options = {}) { const fileReader = new FileReader() const time = new Date().getTime() const blobSlice = File.prototype.slice || File.prototype.mozSlice || File.prototype.webkitSlice const chunkSize = 10 * 1024 * 1000 const chunks = Math.ceil(file.size / chunkSize) let currentChunk = 0 const spark = new SparkMD5.ArrayBuffer() const loadNext = () =\u003e { let start = currentChunk * chunkSize let end = start + chunkSize \u003e= file.size ? file.size : start + chunkSize fileReader.readAsArrayBuffer(blobSlice.call(file.file, start, end)) } loadNext() fileReader.onload = (e) =\u003e { spark.append(e.target.result) if (currentChunk \u003c chunks) { currentChunk++ loadNext() if (options.onProgress \u0026\u0026 typeof options.onProgress == 'function') { options.onProgress(currentChunk, chunks) } } else { let md5 = spark.end() // md5è®¡ç®—å®Œæ¯• if (options.onSuccess \u0026\u0026 typeof options.onSuccess == 'function') { options.onSuccess(md5) } console.log( `MD5è®¡ç®—å®Œæ¯•ï¼š${file.name} \\nMD5ï¼š${md5} \\nåˆ†ç‰‡ï¼š${chunks} å¤§å°:${file.size} ç”¨æ—¶ï¼š${ new Date().getTime() - time } ms` ) } } fileReader.onerror = function () { console.log('MD5è®¡ç®—å¤±è´¥') if (options.onError \u0026\u0026 typeof options.onError == 'function') { options.onError() } } } ",
  "wordCount" : "3780",
  "inLanguage": "zh",
  "datePublished": "2023-06-09T22:37:33+08:00",
  "dateModified": "2023-06-09T22:37:33+08:00",
  "author":[{
    "@type": "Person",
    "name": "chance7bin"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://chance7bin.github.io/posts/design/%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Binb's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://chance7bin.github.io/" accesskey="h" title="Binb&#39;s Blog (Alt + H)">
                <img src="https://chance7bin.github.io/img/%E7%BE%8E%E9%98%9F.jpg" alt="" aria-label="logo"
                    height="35">Binb&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://chance7bin.github.io/search" title="ğŸ”æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ”æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="https://chance7bin.github.io/" title="ğŸ  ä¸»é¡µ">
                    <span>ğŸ  ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://chance7bin.github.io/archives/" title="â±ï¸ æ—¶é—´è½´">
                    <span>â±ï¸ æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://chance7bin.github.io/posts" title="ğŸ“š æ–‡ç« ">
                    <span>ğŸ“š æ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://chance7bin.github.io/tags" title="ğŸ”– æ ‡ç­¾">
                    <span>ğŸ”– æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://github.com/chance7bin" title="GitHub">
                    <span>GitHub</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://chance7bin.github.io/">ğŸ  ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://chance7bin.github.io/posts/">ğŸ“š æ–‡ç« </a>&nbsp;Â»&nbsp;<a href="https://chance7bin.github.io/posts/design/">ğŸ¨ ç³»ç»Ÿè®¾è®¡</a></div>
    <h1 class="post-title">
      æ–­ç‚¹ç»­ä¼ 
    </h1>
    <div class="post-meta">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">


<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }

    .parent-post-meta {
        display: flex;
        flex-wrap: wrap;
        opacity: 0.8;
    }
</style>

<span class="parent-post-meta">
    <span id="post_meta_style_1">
        <span class="fa fa-calendar-check-o"></span>
        <span>2023-06-09
            &nbsp;&nbsp;
        </span>
    </span>
    
    
    
    
    
    
    
    <span id="post_meta_style_3">
        <span class="fa fa-file-word-o"></span>
        <span>3780å­—
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_4">
        <span class="fa fa-clock-o"></span>
        <span>8åˆ†é’Ÿ
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_5">
        <span class="fa fa-user-o"></span>
        <span>chance7bin
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_6">
        <span class="fa fa-tags" style="opacity: 0.8"></span>
        <span>
            <span class="post-tags-meta">
                <a href="https://chance7bin.github.io/tags/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/" style="color: var(--secondary)!important;">ç³»ç»Ÿè®¾è®¡</a>
                &nbsp;<a href="https://chance7bin.github.io/tags/%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0/" style="color: var(--secondary)!important;">æ–­ç‚¹ç»­ä¼ </a>
            </span>
        </span>
    </span>

    
</span>


      
      
      
      
      
      
      
          
          
          
              
              
              
              
          
      
    </div>
  </header>
   <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e5%89%8d%e8%a8%80" aria-label="å‰è¨€">å‰è¨€</a></li>
                    <li>
                        <a href="#%e6%b5%81%e7%a8%8b" aria-label="æµç¨‹">æµç¨‹</a></li>
                    <li>
                        <a href="#%e5%90%8e%e7%ab%af%e6%8e%a5%e5%8f%a3" aria-label="åç«¯æ¥å£">åç«¯æ¥å£</a></li>
                    <li>
                        <a href="#%e5%89%8d%e7%ab%af%e4%bb%a3%e7%a0%81" aria-label="å‰ç«¯ä»£ç ">å‰ç«¯ä»£ç </a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>
  <div class="post-content"><blockquote>
<p>æœ¬ç¯‡æ–‡ç« ä¸»è¦å†…å®¹æ˜¯åˆ†ç‰‡ä¸Šä¼ ã€æ–­ç‚¹ç»­ä¼ ã€ç§’ä¼ çš„å®ç°æ€è·¯</p>
</blockquote>
<h2 id="å‰è¨€">å‰è¨€<a hidden class="anchor" aria-hidden="true" href="#å‰è¨€">#</a></h2>
<p><strong>åˆ†ç‰‡ï¼š</strong> åˆ†ç‰‡ä»»åŠ¡æ˜¯åœ¨å‰ç«¯ç”±<code>vue-simple-uploader</code>æ’ä»¶å®Œæˆï¼Œæµç¨‹ï¼š1.å‰ç«¯å…ˆå‘é€check-fileï¼ˆæ£€æŸ¥æ–‡ä»¶MD5ï¼‰æ¥ç¡®è®¤æ–‡ä»¶æ˜¯ç›´æ¥ç§’ä¼ è¿˜æ˜¯åˆ†ç‰‡ä¸Šä¼ ï¼Œå¦‚æœè®¡ç®—å‡ºæ–‡ä»¶æ‰€æœ‰ç‰‡å·²ç»ä¸Šä¼ å®Œæˆï¼Œåˆ™å¯ç”¨ç§’ä¼ ï¼ˆç§’ä¼ å°±æ˜¯ä¸ä¼ ï¼‰ï¼Œå¦‚æœæ˜¯æ–°æ–‡ä»¶ï¼Œåˆ™éœ€è¦åˆ†ç‰‡ä¸Šä¼ ï¼Œç”±<code>vue-simple-uploader</code>æ’ä»¶å°†æ–‡ä»¶æŒ‰å›ºå®šå¤§å°è¿›è¡Œåˆ‡å‰²ï¼Œç„¶åé€ç‰‡ä¸Šä¼ ã€‚</p>
<p><strong>æ–­ç‚¹ç»­ä¼ ï¼š</strong> æ„æ€å°±æ˜¯ä¸€ä¸ªå¤§æ–‡ä»¶åˆ†äº†å¤šå°‘ç‰‡ï¼Œè¿™äº›ç‰‡å·²ç»ä¸Šä¼ äº†å“ªäº›ï¼Œè¿˜æœ‰å“ªäº›æ²¡ä¸Šä¼ ï¼Œè¿™äº›éƒ½ä¼šè®°å½•åœ¨æ–‡ä»¶å­˜å‚¨ç›®å½•ä¸‹çš„<code>.conf</code>æ–‡ä»¶ä¸­ï¼Œå½“ä½ ä¸Šä¼ å¤§æ–‡ä»¶æ—¶ï¼Œä¼ ä¸€éƒ¨åˆ†ååˆ·æ–°æµè§ˆå™¨æˆ–å…³é—­æµè§ˆå™¨ï¼Œè¿™æ—¶å€™ä¼ è¾“ä¼šä¸­æ–­ï¼Œç„¶åä½ å†æ‰“å¼€é¡µé¢é‡æ–°ä¸Šä¼ è¯¥æ–‡ä»¶ï¼Œå®ƒä¼šå…ˆæ£€æµ‹è¿˜æœ‰å“ªäº›ç‰‡æ²¡æœ‰ä¸Šä¼ ï¼Œç„¶åç›´æ¥ä¸Šä¼ çš„ä¸Šæ¬¡æœªä¼ çš„ç‰‡ï¼Œè¿™å°±æ˜¯æ–­ç‚¹ç»­ä¼ ã€‚</p>
<p>**ç§’ä¼ ï¼š**æ–‡ä»¶ä¸ç»è¿‡ä¸Šä¼ çš„æ­¥éª¤ï¼Œç›´æ¥å°†æ–‡ä»¶ä¿¡æ¯ä¿å­˜åœ¨æœåŠ¡å™¨ä¸­ã€‚é€šè¿‡è®¡ç®—æ–‡ä»¶md5å®ç°</p>
<h2 id="æµç¨‹">æµç¨‹<a hidden class="anchor" aria-hidden="true" href="#æµç¨‹">#</a></h2>
<ol>
<li><strong>æ ¡éªŒæ–‡ä»¶ä¸Šä¼ çŠ¶æ€ï¼š</strong> å‰ç«¯ç”Ÿæˆè¯¥æ–‡ä»¶çš„MD5å¯†æ–‡å¹¶è¿›è¡Œåˆ†ç‰‡ï¼Œä¸Šä¼ ä¹‹å‰è¯·æ±‚check-md5æ¥å£ï¼Œä¼ å…¥æ–‡ä»¶åå’Œå¯†æ–‡ï¼Œæ¥å£æ ¡éªŒæ–‡ä»¶æ˜¯<code>æœªä¸Šä¼ </code> æˆ– <code>ä¸Šä¼ äº†ä¸€éƒ¨åˆ†</code> æˆ– <code>å·²ä¸Šä¼ å®Œæˆ</code>ä¸‰ä¸ªçŠ¶æ€ï¼Œå…¶ä¸­æœªä¸Šä¼ è¿”å›è‡ªå®šä¹‰<code>çŠ¶æ€ç 404</code>ï¼Œä¸Šä¼ ä¸€éƒ¨åˆ†åˆ™è¿”å›<code>çŠ¶æ€206+æœªä¸Šä¼ çš„åˆ†ç‰‡ID</code>ï¼Œä¸Šä¼ å®Œæˆåˆ™è¿”å›<code>çŠ¶æ€200</code>ã€‚</li>
<li><strong>å‰ç«¯é€ç‰‡ä¸Šä¼ ï¼š</strong> æ ¡éªŒå®Œæˆåï¼Œæ ¹æ®æ ¡éªŒç»“æœå¯¹æœªä¸Šä¼ çš„åˆ†ç‰‡è¿›è¡Œé€ä¸ªä¸Šä¼ ï¼Œä¸Šä¼ åˆ†ç‰‡æ—¶å‚æ•°ä¸»è¦æ˜¯ï¼š<code>æ€»ç‰‡æ•°ã€å½“å‰ç‰‡IDã€ç‰‡æ–‡ä»¶</code></li>
<li><strong>ä¸Šä¼ æ¥å£ï¼š</strong> ä¸Šä¼ æ¥å£ä¼šå…ˆå»è·å–å¹¶è§£æè¯¥æ–‡ä»¶çš„confæ–‡ä»¶ï¼ˆconfæ–‡ä»¶æ˜¯RandomAccessFileï¼Œè¯¥ç±»æ˜¯é€šè¿‡æä¾›æŒ‡é’ˆçš„æ–¹å¼æ“ä½œæ–‡ä»¶ï¼Œæ–‡ä»¶å­˜å‚¨çš„æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶æ•°ç»„ï¼Œæ‰€ä»¥å¯ä»¥ç”¨æ¥æ•°ç»„ä¸‹æ ‡æ ‡è®°ç‰‡IDï¼‰ï¼Œä½¿ç”¨setLengthæ–¹æ³•è®¾ç½®confæ–‡ä»¶é•¿åº¦ï¼Œä½¿ç”¨seekæ–¹æ³•è·³åˆ°å½“å‰ä¸Šä¼ çš„ç‰‡IDçš„ä½ç½®ï¼ŒæŠŠè¯¥ä½ç½®çš„å€¼æ›¿æ¢æˆ127ï¼Œç„¶åå°†è¯¥åˆ†ç‰‡ä½¿ç”¨æŒ‡é’ˆåç§»çš„æ–¹å¼æ’å…¥åˆ°_tmpä¸´æ—¶æ–‡ä»¶ï¼ˆä¸´æ—¶æ–‡ä»¶ä¹Ÿæ˜¯RandomAccessFileæ–‡ä»¶ï¼‰ä¸­ï¼Œç„¶åæ ¡éªŒæ˜¯å¦æ‰€æœ‰çš„ç‰‡éƒ½ä¸Šä¼ å®Œæˆï¼Œæ˜¯åˆ™ä¿®æ”¹ä¸´æ—¶æ–‡ä»¶ä¸ºæ­£å¼æ–‡ä»¶åï¼Œè‡³æ­¤ä¸Šä¼ å®Œæˆï¼Œå¦åˆ™ç›´æ¥è¿”å›è¯¥åˆ†ç‰‡ä¸Šä¼ å®Œæˆ</li>
<li><strong>ä¸Šä¼ è¿›åº¦ï¼š</strong> å‰ç«¯æ”¶åˆ°å½“å‰ç‰‡çš„å“åº”ç»“æœåï¼Œä¼šæ ¹æ®å·²ä¸Šä¼ ç‰‡æ•°é‡è·å–åˆ°ä¸Šä¼ è¿›åº¦</li>
<li><strong>MD5çš„ç”¨æ³•ï¼š</strong> ç”¨äºè®¡ç®—æœåŠ¡å™¨æ˜¯å¦å·²ç»å­˜åœ¨ç›¸åŒmd5çš„æ–‡ä»¶ï¼Œç”¨ä½œç§’ä¼ åŠŸèƒ½çš„å®ç°ã€‚å‰ç«¯è®¡ç®—æ–‡ä»¶md5ï¼Œä¼ å…¥åç«¯è¿›è¡ŒæŸ¥æ‰¾æ˜¯å¦å·²ç»æœ‰ç›¸åŒmd5æ–‡ä»¶ï¼Œè‹¥å­˜åœ¨ç›´æ¥è¿”å›ä¸Šä¼ æˆåŠŸï¼Œå¦åˆ™èµ°ä¸Šä¼ çš„æ­¥éª¤</li>
</ol>
<h2 id="åç«¯æ¥å£">åç«¯æ¥å£<a hidden class="anchor" aria-hidden="true" href="#åç«¯æ¥å£">#</a></h2>
<p><strong><code>Controller</code></strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * æ£€æŸ¥æ–‡ä»¶MD5ï¼ˆæ–‡ä»¶MD5è‹¥å·²å­˜åœ¨è¿›è¡Œç§’ä¼ ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param md5      md5
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param fileName æ–‡ä»¶åç§°
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return {@link ApiResponse}
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @author 7bin
</span></span></span><span class="line"><span class="cl"><span class="cm"> **/</span>
</span></span><span class="line"><span class="cl"><span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/check&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ApiResponse</span> <span class="nf">checkFileMd5</span><span class="o">(</span><span class="n">String</span> <span class="n">md5</span><span class="o">,</span> <span class="n">String</span> <span class="n">fileName</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Result result = fileService.checkFileMd5(md5, fileName);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// return NovelWebUtils.forReturn(result);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">ApiResponse</span><span class="o">.</span><span class="na">success</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * æ–­ç‚¹ç»­ä¼ æ–¹å¼ä¸Šä¼ æ–‡ä»¶ï¼šç”¨äºå¤§æ–‡ä»¶ä¸Šä¼ 
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param chunkDTO   å‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param request è¯·æ±‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return {@link ApiResponse}
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @author 7bin
</span></span></span><span class="line"><span class="cl"><span class="cm"> **/</span>
</span></span><span class="line"><span class="cl"><span class="nd">@PostMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/breakpoint-upload&#34;</span><span class="o">,</span> <span class="n">consumes</span> <span class="o">=</span> <span class="s">&#34;multipart/*&#34;</span><span class="o">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="s">&#34;content-type=multipart/form-data&#34;</span><span class="o">,</span> <span class="n">produces</span> <span class="o">=</span> <span class="s">&#34;application/json;charset=UTF-8&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ApiResponse</span> <span class="nf">breakpointResumeUpload</span><span class="o">(</span><span class="n">Chunk</span> <span class="n">chunkDTO</span><span class="o">,</span> <span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">id</span> <span class="o">=</span> <span class="n">chunkDTO</span><span class="o">.</span><span class="na">getIdentifier</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">chunks</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">toIntExact</span><span class="o">(</span><span class="n">chunkDTO</span><span class="o">.</span><span class="na">getTotalChunks</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">chunk</span> <span class="o">=</span> <span class="n">chunkDTO</span><span class="o">.</span><span class="na">getChunkNumber</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="n">chunkDTO</span><span class="o">.</span><span class="na">getCurrentChunkSize</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">chunkDTO</span><span class="o">.</span><span class="na">getFilename</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">MultipartFile</span> <span class="n">file</span> <span class="o">=</span> <span class="n">chunkDTO</span><span class="o">.</span><span class="na">getFile</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">md5</span> <span class="o">=</span> <span class="n">chunkDTO</span><span class="o">.</span><span class="na">getIdentifier</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">UploadFileParam</span> <span class="n">param</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UploadFileParam</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">chunks</span><span class="o">,</span> <span class="n">chunk</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">file</span><span class="o">,</span> <span class="n">md5</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// return ApiResponse.success();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Result</span> <span class="n">result</span> <span class="o">=</span> <span class="n">fileService</span><span class="o">.</span><span class="na">breakpointResumeUpload</span><span class="o">(</span><span class="n">param</span><span class="o">,</span> <span class="n">request</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">NovelWebUtils</span><span class="o">.</span><span class="na">forReturn</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * æ£€æŸ¥æ–‡ä»¶MD5ï¼ˆæ–‡ä»¶MD5è‹¥å·²å­˜åœ¨è¿›è¡Œç§’ä¼ ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param chunkMap
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return {@link ApiResponse}
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @author 7bin
</span></span></span><span class="line"><span class="cl"><span class="cm"> **/</span>
</span></span><span class="line"><span class="cl"><span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/breakpoint-upload&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ApiResponse</span> <span class="nf">breakpointResumeUploadPre</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@RequestParam</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">chunkMap</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">md5</span> <span class="o">=</span> <span class="n">chunkMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;identifier&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">chunkMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;filename&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Result</span><span class="o">&lt;</span><span class="n">JSONArray</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">fileService</span><span class="o">.</span><span class="na">checkFileMd5</span><span class="o">(</span><span class="n">md5</span><span class="o">,</span> <span class="n">filename</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">JSONObject</span> <span class="n">res</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JSONObject</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æ•°æ®åº“ä¸­å­˜åœ¨è¯¥md5åˆ™ç§’ä¼ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">res</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;skipUpload&#34;</span><span class="o">,</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ApiResponse</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="n">res</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">skipUpload</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="s">&#34;200&#34;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">getCode</span><span class="o">())</span> <span class="o">||</span> <span class="s">&#34;201&#34;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">getCode</span><span class="o">()))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">skipUpload</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="s">&#34;206&#34;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">getCode</span><span class="o">()))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å·²ç»ä¸Šä¼ éƒ¨åˆ†åˆ†å—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// dataä¸­å­˜æ”¾çš„æ˜¯è¿˜æœªä¸Šä¼ çš„åˆ†å—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">JSONArray</span> <span class="n">data</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">getData</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">res</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;missChunks&#34;</span><span class="o">,</span><span class="n">data</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">res</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;skipUpload&#34;</span><span class="o">,</span><span class="n">skipUpload</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ApiResponse</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="n">res</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Result result = fileService.breakpointResumeUpload(param, request);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// return NovelWebUtils.forReturn(result);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong><code>Service</code></strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">JSONArray</span><span class="o">&gt;</span> <span class="nf">checkFileMd5</span><span class="o">(</span><span class="n">String</span> <span class="n">md5</span><span class="o">,</span> <span class="n">String</span> <span class="n">fileName</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">exist</span> <span class="o">=</span> <span class="n">fileMapper</span><span class="o">.</span><span class="na">fileIsExist</span><span class="o">(</span><span class="n">md5</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">exist</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Result</span><span class="o">&lt;</span><span class="n">JSONArray</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// String realFilename = md5 + &#34;_&#34; + fileName;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">realFilename</span> <span class="o">=</span> <span class="n">md5</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="n">LocalUpload</span><span class="o">.</span><span class="na">checkFileMd5</span><span class="o">(</span><span class="n">md5</span><span class="o">,</span> <span class="n">realFilename</span><span class="o">,</span> <span class="n">confFilePath</span><span class="o">,</span> <span class="n">savePath</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// e.printStackTrace();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">ServiceException</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Result</span> <span class="nf">breakpointResumeUpload</span><span class="o">(</span><span class="n">UploadFileParam</span> <span class="n">param</span><span class="o">,</span> <span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Result</span> <span class="n">result</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// è¿™é‡Œçš„ chunkSize(åˆ†ç‰‡å¤§å°) è¦ä¸å‰ç«¯ä¼ è¿‡æ¥çš„å¤§å°ä¸€è‡´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// long chunkSize = Objects.isNull(param.getChunkSize()) ? 5 * 1024 * 1024
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//     : param.getChunkSize();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å®é™…å­˜å‚¨çš„æ–‡ä»¶æ ¼å¼ä¸º [{md5}_{filename}]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// String realFilename = param.getMd5() + &#34;_&#34; + param.getName();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">realFilename</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="na">getMd5</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">param</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">realFilename</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="n">LocalUpload</span><span class="o">.</span><span class="na">fragmentFileUploader</span><span class="o">(</span><span class="n">param</span><span class="o">,</span> <span class="n">confFilePath</span><span class="o">,</span> <span class="n">savePath</span><span class="o">,</span> <span class="mi">5242880L</span><span class="o">,</span> <span class="n">request</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// return NovelWebUtils.forReturn(result);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">ServiceException</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="å‰ç«¯ä»£ç ">å‰ç«¯ä»£ç <a hidden class="anchor" aria-hidden="true" href="#å‰ç«¯ä»£ç ">#</a></h2>
<p><strong><code>SimpleUploader.vue</code></strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">template</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;global-uploader&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">uploader</span>
</span></span><span class="line"><span class="cl">      <span class="na">class</span><span class="o">=</span><span class="s">&#34;uploader-app&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="na">:options</span><span class="o">=</span><span class="s">&#34;initOptions&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="na">:file-status-text</span><span class="o">=</span><span class="s">&#34;fileStatusText&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="na">:auto-start</span><span class="o">=</span><span class="s">&#34;false&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="err">@</span><span class="na">file-added</span><span class="o">=</span><span class="s">&#34;onFileAdded&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="err">@</span><span class="na">file-success</span><span class="o">=</span><span class="s">&#34;onFileSuccess&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="err">@</span><span class="na">file-progress</span><span class="o">=</span><span class="s">&#34;onFileProgress&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="err">@</span><span class="na">file-error</span><span class="o">=</span><span class="s">&#34;onFileError&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">uploader-unsupport</span><span class="p">&gt;&lt;/</span><span class="nt">uploader-unsupport</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">uploader-drop</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">uploader-btn</span> <span class="p">&gt;</span>é€‰æ‹©æ–‡ä»¶<span class="p">&lt;/</span><span class="nt">uploader-btn</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">span</span> <span class="na">style</span><span class="o">=</span><span class="s">&#34;margin-left: 10px&#34;</span><span class="p">&gt;</span>ï¼ˆæ”¯æŒä¸Šä¼ ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶ï¼‰<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!--&lt;uploader-btn directory&gt;ä¸Šä¼ æ–‡ä»¶å¤¹ &lt;/uploader-btn&gt;--&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;/</span><span class="nt">uploader-drop</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="c">&lt;!--&lt;uploader-btn id=&#34;global-uploader-btn&#34; ref=&#34;uploadBtnRef&#34;&gt;é€‰æ‹©æ–‡ä»¶&lt;/uploader-btn&gt;--&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="c">&lt;!--&lt;span&gt;ï¼ˆæ”¯æŒä¸Šä¼ ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶ï¼‰&lt;/span&gt;--&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">uploader-list</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">template</span> <span class="err">#</span><span class="na">default</span><span class="o">=</span><span class="s">&#34;{ fileList }&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;file-panel&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="c">&lt;!--&lt;div class=&#34;file-title&#34;&gt;--&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="c">&lt;!--  &lt;div class=&#34;title&#34;&gt;æ–‡ä»¶åˆ—è¡¨&lt;/div&gt;--&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="c">&lt;!--&lt;/div&gt;--&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="p">&lt;</span><span class="nt">ul</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;file-list&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">              <span class="p">&lt;</span><span class="nt">li</span>
</span></span><span class="line"><span class="cl">                  <span class="na">v-for</span><span class="o">=</span><span class="s">&#34;file in fileList&#34;</span>
</span></span><span class="line"><span class="cl">                  <span class="na">:key</span><span class="o">=</span><span class="s">&#34;file.id&#34;</span>
</span></span><span class="line"><span class="cl">                  <span class="na">class</span><span class="o">=</span><span class="s">&#34;file-item&#34;</span>
</span></span><span class="line"><span class="cl">              <span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;</span><span class="nt">uploader-file</span>
</span></span><span class="line"><span class="cl">                    <span class="na">ref</span><span class="o">=</span><span class="s">&#34;files&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="na">:class</span><span class="o">=</span><span class="s">&#34;[&#39;file_&#39; + file.id, customStatus]&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="na">:file</span><span class="o">=</span><span class="s">&#34;file&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="na">:list</span><span class="o">=</span><span class="s">&#34;true&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&gt;&lt;/</span><span class="nt">uploader-file</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">              <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">              <span class="p">&lt;</span><span class="nt">div</span> <span class="na">v-if</span><span class="o">=</span><span class="s">&#34;!fileList.length&#34;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;no-file&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="c">&lt;!--&lt;Icon icon=&#34;ri:file-3-line&#34; width=&#34;16&#34; /&gt; æš‚æ— å¾…ä¸Šä¼ æ–‡ä»¶--&gt;</span>
</span></span><span class="line"><span class="cl">                æš‚æ— å¾…ä¸Šä¼ æ–‡ä»¶
</span></span><span class="line"><span class="cl">              <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;/</span><span class="nt">template</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;/</span><span class="nt">uploader-list</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">uploader</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">template</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">script</span> <span class="na">setup</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">useCurrentInstance</span> <span class="nx">from</span> <span class="s2">&#34;@/utils/currentInstance&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">generateMD5</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;@/components/Uploader/utils/md5&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">ElNotification</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;element-plus&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">addFileToDrive</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;@/api/drive/drive&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">checkAuth</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;@/api/admin/user&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="p">{</span> <span class="nx">proxy</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">useCurrentInstance</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// TODO ä¸Šä¼ ç»„ä»¶è¿˜æœ‰bug ä¸Šä¼ æˆåŠŸæ—¶åŠ¨ä½œæŒ‰é’®æ²¡æœ‰éšè—ï¼›åç«¯å‡ºç°é”™è¯¯ä¸Šä¼ å¤±è´¥æ—¶èƒŒæ™¯è‰²æ²¡å˜çº¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// props
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// emits
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">emits</span> <span class="o">=</span> <span class="nx">defineEmits</span><span class="p">([</span><span class="s1">&#39;uploadSuccess&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">drivePath</span> <span class="o">=</span> <span class="kr">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VITE_APP_DRIVE_API</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">initOptions</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">target</span><span class="o">:</span> <span class="nx">drivePath</span> <span class="o">+</span> <span class="s2">&#34;/file/breakpoint-upload&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">chunkSize</span><span class="o">:</span> <span class="s1">&#39;5242880&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">forceChunkSize</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">fileParameterName</span><span class="o">:</span> <span class="s1">&#39;file&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">maxChunkRetries</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// æ˜¯å¦å¼€å¯æœåŠ¡å™¨åˆ†ç‰‡æ ¡éªŒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">testChunks</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// æœåŠ¡å™¨åˆ†ç‰‡æ ¡éªŒå‡½æ•°ï¼Œç§’ä¼ åŠæ–­ç‚¹ç»­ä¼ åŸºç¡€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">checkChunkUploadedByResponse</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">chunk</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">skip</span> <span class="o">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// console.log(&#34;checkChunkUploadedByResponse chunk:&#34;, chunk);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// console.log(&#34;checkChunkUploadedByResponse message:&#34;, message);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">let</span> <span class="nx">objMessage</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// console.log(&#34;objMessage:&#34;, objMessage);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">objMessage</span><span class="p">.</span><span class="nx">code</span> <span class="o">===</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">objMessage</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">skipUpload</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">skip</span> <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">objMessage</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">missChunks</span> <span class="o">==</span> <span class="kc">null</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">          <span class="nx">skip</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">skip</span> <span class="o">=</span> <span class="p">(</span><span class="nx">objMessage</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">missChunks</span> <span class="o">||</span> <span class="p">[]).</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">offset</span><span class="p">.</span><span class="nx">toString</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// console.log(&#34;skip: &#34; + chunk.offset + &#34; &#34; + skip);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">skip</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nx">query</span><span class="o">:</span> <span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">chunk</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// console.log(&#34;query:&#34;, file);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="p">...</span><span class="nx">file</span><span class="p">.</span><span class="nx">params</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">customStatus</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">fileStatusText</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">success</span><span class="o">:</span> <span class="s1">&#39;ä¸Šä¼ æˆåŠŸ&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;ä¸Šä¼ å¤±è´¥&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">uploading</span><span class="o">:</span> <span class="s1">&#39;ä¸Šä¼ ä¸­&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">paused</span><span class="o">:</span> <span class="s1">&#39;å·²æš‚åœ&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">waiting</span><span class="o">:</span> <span class="s1">&#39;ç­‰å¾…ä¸Šä¼ &#39;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// const uploaderRef = ref()
</span></span></span><span class="line"><span class="cl"><span class="c1">// const uploader = computed(() =&gt; uploaderRef.value?.uploader)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kr">async</span> <span class="kd">function</span> <span class="nx">onFileAdded</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²ç»ç™»å½•äº†ï¼Œç™»å½•æ‰å¯ä»¥æ·»åŠ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">await</span> <span class="nx">checkAuth</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// æš‚åœæ–‡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// é€‰æ‹©æ–‡ä»¶åæš‚åœæ–‡ä»¶ä¸Šä¼ ï¼Œä¸Šä¼ æ—¶æ‰‹åŠ¨å¯åŠ¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">file</span><span class="p">.</span><span class="nx">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// console.log(&#34;onFileAdded file: &#34;, file);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// panelShow.value = true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// trigger(&#39;fileAdded&#39;)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// å°†é¢å¤–çš„å‚æ•°èµ‹å€¼åˆ°æ¯ä¸ªæ–‡ä»¶ä¸Šï¼Œä»¥ä¸åŒæ–‡ä»¶ä½¿ç”¨ä¸åŒparamsçš„éœ€æ±‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// file.params = customParams.value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// è®¡ç®—MD5
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">const</span> <span class="nx">md5</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">computeMD5</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="nx">startUpload</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">md5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">computeMD5</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// æ–‡ä»¶çŠ¶æ€è®¾ä¸º&#34;è®¡ç®—MD5&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">statusSet</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="s1">&#39;md5&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// è®¡ç®—MD5æ—¶éšè—&#34;å¼€å§‹&#34;æŒ‰é’®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">nextTick</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// document.querySelector(`.file_${file.id} .uploader-file-resume`).style.display = &#39;none&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="sb">`.file_</span><span class="si">${</span><span class="nx">file</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb"> .uploader-file-actions`</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// å¼€å§‹è®¡ç®—MD5
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">generateMD5</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">onProgress</span><span class="p">(</span><span class="nx">currentChunk</span><span class="p">,</span> <span class="nx">chunks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å®æ—¶å±•ç¤ºMD5çš„è®¡ç®—è¿›åº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">nextTick</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="kr">const</span> <span class="nx">md5ProgressText</span> <span class="o">=</span> <span class="s1">&#39;æ ¡éªŒMD5 &#39;</span> <span class="o">+</span> <span class="p">((</span><span class="nx">currentChunk</span> <span class="o">/</span> <span class="nx">chunks</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span>
</span></span><span class="line"><span class="cl">          <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="sb">`.custom-status-</span><span class="si">${</span><span class="nx">file</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">).</span><span class="nx">innerText</span> <span class="o">=</span> <span class="nx">md5ProgressText</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nx">onSuccess</span><span class="p">(</span><span class="nx">md5</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">statusRemove</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">resolve</span><span class="p">(</span><span class="nx">md5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nx">onError</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">error</span><span class="p">(</span><span class="sb">`æ–‡ä»¶</span><span class="si">${</span><span class="nx">file</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">è¯»å–å‡ºé”™ï¼Œè¯·æ£€æŸ¥è¯¥æ–‡ä»¶`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">file</span><span class="p">.</span><span class="nx">cancel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nx">statusRemove</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">reject</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// md5è®¡ç®—å®Œæ¯•ï¼Œå¼€å§‹ä¸Šä¼ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">function</span> <span class="nx">startUpload</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">md5</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">file</span><span class="p">.</span><span class="nx">uniqueIdentifier</span> <span class="o">=</span> <span class="nx">md5</span>
</span></span><span class="line"><span class="cl">  <span class="nx">file</span><span class="p">.</span><span class="nx">resume</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">onFileProgress</span><span class="p">(</span><span class="nx">rootFile</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="sb">`ä¸Šä¼ ä¸­ </span><span class="si">${</span><span class="nx">file</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">ï¼Œchunkï¼š</span><span class="si">${</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">startByte</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="si">}</span><span class="sb"> ~ </span><span class="si">${</span>
</span></span><span class="line"><span class="cl">      <span class="nx">chunk</span><span class="p">.</span><span class="nx">endByte</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span>
</span></span><span class="line"><span class="cl">    <span class="si">}</span><span class="sb">`</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">onFileError</span> <span class="o">=</span> <span class="p">(</span><span class="nx">rootFile</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">chunk</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// console.log(&#39;error&#39;, file)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">error</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">error</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ElNotification</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;é”™è¯¯&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">message</span><span class="o">:</span> <span class="nx">msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">duration</span><span class="o">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">onFileSuccess</span> <span class="o">=</span> <span class="p">(</span><span class="nx">rootFile</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">chunk</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// console.log(&#34;ä¸Šä¼ æˆåŠŸ&#34;)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// console.log(&#34;rootFile&#34;,rootFile)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// fileçš„relativePathæ˜¯æ–‡ä»¶å¤¹çš„ç›¸å¯¹è·¯å¾„(å¦‚æœä¸Šä¼ çš„æ˜¯æ–‡ä»¶å¤¹çš„è¯)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// console.log(&#34;file&#34;,file)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// console.log(&#34;response&#34;,JSON.parse(response))
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// console.log(&#34;chunk&#34;,chunk)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// addFileToDrive(file.name, file.uniqueIdentifier, file.size).then(() =&gt; {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//   proxy.$modal.msgSuccess(&#34;æ–‡ä»¶ä¸Šä¼ æˆåŠŸ&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// })
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">// æœåŠ¡ç«¯è‡ªå®šä¹‰çš„é”™è¯¯ï¼ˆå³httpçŠ¶æ€ç ä¸º200ï¼Œä½†æ˜¯æ˜¯é”™è¯¯çš„æƒ…å†µï¼‰ï¼Œè¿™ç§é”™è¯¯æ˜¯Uploaderæ— æ³•æ‹¦æˆªçš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">let</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;onFileSuccess res:&#34;</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span> <span class="o">!==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">error</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ–‡ä»¶çŠ¶æ€è®¾ä¸ºâ€œå¤±è´¥â€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">statusSet</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="s1">&#39;failed&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">emits</span><span class="p">(</span><span class="s2">&#34;uploadSuccess&#34;</span><span class="p">,</span> <span class="nx">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * æ–°å¢çš„è‡ªå®šä¹‰çš„çŠ¶æ€: &#39;md5&#39;ã€&#39;merging&#39;ã€&#39;transcoding&#39;ã€&#39;failed&#39;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param id
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param status
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">statusSet</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">statusMap</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">md5</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;æ ¡éªŒMD5&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">bgc</span><span class="o">:</span> <span class="s1">&#39;#fff&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">failed</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;ä¸Šä¼ å¤±è´¥&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">bgc</span><span class="o">:</span> <span class="s1">&#39;#e2eeff&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">customStatus</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">status</span>
</span></span><span class="line"><span class="cl">  <span class="nx">nextTick</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">statusTag</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;span&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">statusTag</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="sb">`custom-status-</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb"> custom-status`</span>
</span></span><span class="line"><span class="cl">    <span class="nx">statusTag</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="nx">statusMap</span><span class="p">[</span><span class="nx">status</span><span class="p">].</span><span class="nx">text</span>
</span></span><span class="line"><span class="cl">    <span class="nx">statusTag</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundColor</span> <span class="o">=</span> <span class="nx">statusMap</span><span class="p">[</span><span class="nx">status</span><span class="p">].</span><span class="nx">bgc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// custom-status æ ·å¼ä¸ç”Ÿæ•ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç”±äº styleè„šæœ¬ è®¾ç½®äº† scopedï¼Œæ·±å±‚çš„æ ·å¼ä¿®æ”¹ä¸äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// é€šè¿‡ç»™å½“å‰ç»„ä»¶è®¾ç½®ä¸€ä¸ªidï¼Œåœ¨è¯¥idä¸‹è®¾ç½®æ ·å¼ï¼Œå°±å¯ä»¥ä¿è¯æ ·å¼ä¸å…¨å±€æ±¡æŸ“
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// statusTag.style.position = &#39;absolute&#39;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// statusTag.style.top = &#39;0&#39;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// statusTag.style.left = &#39;0&#39;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// statusTag.style.right = &#39;0&#39;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// statusTag.style.bottom = &#39;0&#39;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// statusTag.style.zIndex = &#39;1&#39;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">statusWrap</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="sb">`.file_</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb"> .uploader-file-status`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">statusWrap</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">statusTag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">statusRemove</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">customStatus</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">nextTick</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">statusTag</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="sb">`.custom-status-</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="sb">`.file_</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb"> .uploader-file-actions`</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;block&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">statusTag</span><span class="p">.</span><span class="nx">remove</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong><code>md5.js</code></strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">SparkMD5</span> <span class="nx">from</span> <span class="s1">&#39;spark-md5&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * åˆ†æ®µè®¡ç®—MD5
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param file {File}
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param options {Object} - onProgress | onSuccess | onError
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">generateMD5</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">fileReader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">time</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">blobSlice</span> <span class="o">=</span> <span class="nx">File</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span> <span class="o">||</span> <span class="nx">File</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">mozSlice</span> <span class="o">||</span> <span class="nx">File</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">webkitSlice</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">chunkSize</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1000</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">chunks</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">size</span> <span class="o">/</span> <span class="nx">chunkSize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">currentChunk</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">spark</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SparkMD5</span><span class="p">.</span><span class="nx">ArrayBuffer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">loadNext</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">currentChunk</span> <span class="o">*</span> <span class="nx">chunkSize</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">start</span> <span class="o">+</span> <span class="nx">chunkSize</span> <span class="o">&gt;=</span> <span class="nx">file</span><span class="p">.</span><span class="nx">size</span> <span class="o">?</span> <span class="nx">file</span><span class="p">.</span><span class="nx">size</span> <span class="o">:</span> <span class="nx">start</span> <span class="o">+</span> <span class="nx">chunkSize</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">fileReader</span><span class="p">.</span><span class="nx">readAsArrayBuffer</span><span class="p">(</span><span class="nx">blobSlice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">file</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">loadNext</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">fileReader</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">spark</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">currentChunk</span> <span class="o">&lt;</span> <span class="nx">chunks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">currentChunk</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">      <span class="nx">loadNext</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">onProgress</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">onProgress</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">options</span><span class="p">.</span><span class="nx">onProgress</span><span class="p">(</span><span class="nx">currentChunk</span><span class="p">,</span> <span class="nx">chunks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">let</span> <span class="nx">md5</span> <span class="o">=</span> <span class="nx">spark</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// md5è®¡ç®—å®Œæ¯•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">onSuccess</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">onSuccess</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">options</span><span class="p">.</span><span class="nx">onSuccess</span><span class="p">(</span><span class="nx">md5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="sb">`MD5è®¡ç®—å®Œæ¯•ï¼š</span><span class="si">${</span><span class="nx">file</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb"> \nMD5ï¼š</span><span class="si">${</span><span class="nx">md5</span><span class="si">}</span><span class="sb"> \nåˆ†ç‰‡ï¼š</span><span class="si">${</span><span class="nx">chunks</span><span class="si">}</span><span class="sb"> å¤§å°:</span><span class="si">${</span><span class="nx">file</span><span class="p">.</span><span class="nx">size</span><span class="si">}</span><span class="sb"> ç”¨æ—¶ï¼š</span><span class="si">${</span>
</span></span><span class="line"><span class="cl">          <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">-</span> <span class="nx">time</span>
</span></span><span class="line"><span class="cl">        <span class="si">}</span><span class="sb"> ms`</span>
</span></span><span class="line"><span class="cl">      <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">fileReader</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;MD5è®¡ç®—å¤±è´¥&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">onError</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">onError</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">options</span><span class="p">.</span><span class="nx">onError</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>

  </div>

  <footer class="post-footer">
    
<nav class="paginav">
  <a class="prev" href="https://chance7bin.github.io/posts/design/redis%E5%92%8Cmysql%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7%E5%AE%9E%E7%8E%B0/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>rediså’Œmysqlç¼“å­˜ä¸€è‡´æ€§å®ç°</span>
  </a>
  <a class="next" href="https://chance7bin.github.io/posts/design/%E9%98%B2%E9%87%8D%E5%A4%8D%E6%8F%90%E4%BA%A4/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>é˜²é‡å¤æäº¤</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://chance7bin.github.io/">Binb&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerHTML = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
